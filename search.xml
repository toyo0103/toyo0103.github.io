<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>[Android] Use Post To Call API</title>
    <url>/2015/06/09/Android-Use-Post-To-Call-API/</url>
    <content><![CDATA[<p>開發Android時,如何用Post的方式 Call API來取得值</p>
<ul>
<li><p>首先 ```csharp<br>String UrlLocation = 你的API位置; //API位置</p>
<pre><code>      String PostData = 要傳遞的資料(字串); //EX: ID=Toyo&amp;Name=Steven

          HttpURLConnection conn = null;
      StringBuilder sb = new StringBuilder();
      try
      &#123;
          URL Url = new URL(UrlLocation);
          conn = (HttpURLConnection)Url.openConnection();
          conn.setRequestMethod(&quot;POST&quot;); //要呼意的方式 Get Or Post
          conn.setDoInput(true);
          conn.setDoOutput(true);
          conn.connect();
          //開始傳輸資料過去給API
          OutputStream Output = conn.getOutputStream();
          BufferedWriter writer = new BufferedWriter(
                  new OutputStreamWriter(Output, &quot;UTF-8&quot;));
          writer.write(PostData);
          writer.flush();
          writer.close();
          Output.close();
          //讀取API回傳的值
          BufferedReader br = new BufferedReader(new InputStreamReader(
                  conn.getInputStream(),&quot;utf-8&quot;));
  
              String line;
          while ((line=br.readLine())!=null)
          &#123;
              sb.append(line);
          &#125;
      &#125;
      catch(Exception ex)
      &#123;
          Log.e(&quot;API_Post&quot;,ex.getMessage());
      &#125;
      finally
      &#123;
          if (conn != null)
              conn.disconnect();
      &#125;
  
          return sb.toString();
</code></pre>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   目前測試的結果是,如果不把呼叫API用執行緒AsyncTask的方式處理,在conn.connect()這邊會跳出Http...InMainThread的Exception,原因是Andorid預設呼叫外部處理5秒沒有回應就會跳Exception,所以預設不管這支API反應速度快不快,他都要你把上面那段做成切執行緒的方式處理,當然網路上還是有舊的方式可以用,但既然這是官方目前推薦的做法就照做吧 &#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;這邊有三個參數</span><br><span class="line">&#x2F;&#x2F;第一個參數String : 呼叫這個方法時要帶入的參數型態,這邊就是可以帶入String,</span><br><span class="line">&#x2F;&#x2F;第二個參數Void : 處理時會回報狀態跟進度,這邊寫Void表示不回傳目前處理狀態</span><br><span class="line">&#x2F;&#x2F;第三個參數String : 處理完成時回傳的值</span><br><span class="line">private class Post extends AsyncTask&lt;String,Void,String&gt;</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;事件處理順序onPreExecute , doInBackground ,onPostExecute</span><br><span class="line">        @Override</span><br><span class="line">        protected void onPreExecute() &#123;</span><br><span class="line">            super.onPreExecute();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line">        protected String doInBackground(String ... params) &#123;</span><br><span class="line">            &#x2F;&#x2F;改寫這邊,呼叫方法時可以傳進多個String,所以這邊改抓params</span><br><span class="line">            String UrlLocation &#x3D; params[0]; &#x2F;&#x2F;API位置</span><br><span class="line">            String PostData &#x3D; params[1]; &#x2F;&#x2F;要傳資料</span><br><span class="line"></span><br><span class="line">                HttpURLConnection conn &#x3D; null;</span><br><span class="line">            StringBuilder sb &#x3D; new StringBuilder();</span><br><span class="line">            try</span><br><span class="line">            &#123;</span><br><span class="line">                URL Url &#x3D; new URL(UrlLocation);</span><br><span class="line">                conn &#x3D; (HttpURLConnection)Url.openConnection();</span><br><span class="line">                conn.setRequestMethod(&quot;POST&quot;); &#x2F;&#x2F;要呼意的方式 Get Or Post</span><br><span class="line">                conn.setDoInput(true);</span><br><span class="line">                conn.setDoOutput(true);</span><br><span class="line">                conn.connect();</span><br><span class="line">                &#x2F;&#x2F;開始傳輸資料過去給API</span><br><span class="line">                OutputStream Output &#x3D; conn.getOutputStream();</span><br><span class="line">                BufferedWriter writer &#x3D; new BufferedWriter(</span><br><span class="line">                        new OutputStreamWriter(Output, &quot;UTF-8&quot;));</span><br><span class="line">                writer.write(PostData);</span><br><span class="line">                writer.flush();</span><br><span class="line">                writer.close();</span><br><span class="line">                Output.close();</span><br><span class="line"></span><br><span class="line">                    &#x2F;&#x2F;讀取API回傳的值</span><br><span class="line">                BufferedReader br &#x3D; new BufferedReader(new InputStreamReader(</span><br><span class="line">                        conn.getInputStream(),&quot;utf-8&quot;));</span><br><span class="line"></span><br><span class="line">                    String line;</span><br><span class="line">                while ((line&#x3D;br.readLine())!&#x3D;null)</span><br><span class="line">                &#123;</span><br><span class="line">                    sb.append(line);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            catch(Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                Log.e(&quot;API_Post&quot;,ex.getMessage());</span><br><span class="line">            &#125;</span><br><span class="line">            finally</span><br><span class="line">            &#123;</span><br><span class="line">                if (conn !&#x3D; null)</span><br><span class="line">                    conn.disconnect();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                return sb.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">           @Override</span><br><span class="line">        protected void onPostExecute(String Result) &#123;</span><br><span class="line">            super.onPostExecute(Result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>  最後,因為在Debug模式AsyncTask並不會進入,所以要在doInBackground的事件裡面加上這行,但因為非Debug模式下這行會造成Android沒有回應, 所以記得在部署時把這行拿掉！！ ```csharp<br>android.os.Debug.waitForDebugger();</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   全部完成後,呼叫方式如下 &#96;&#96;&#96;csharp</span><br><span class="line">String Url &#x3D; &quot;http:&#x2F;&#x2F;www.api.com.tw&quot;;</span><br><span class="line">String PostData &#x3D; &quot;id&#x3D;toyo&amp;name&#x3D;steven&quot;;</span><br><span class="line">String Response &#x3D; new Post().execute(Url,PostData).get();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>AutoMapper Generic 對應</title>
    <url>/2018/01/15/AutoMapper-Generic-%E5%B0%8D%E6%87%89/</url>
    <content><![CDATA[<p>此篇文章用的AutoMapper版本 : 6.2.2 <a href="https://github.com/AutoMapper/AutoMapper">&lt;套件連結&gt;</a></p>
<p>被同事問到AutoMapper有沒有辦法做泛型的對應，問了一下才發現其他人原來也沒嘗試過這樣的作法，所以來筆記一下供之後參考。</p>
<p>首先對應的Class如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Source</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">int</span> Page1 &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">   <span class="keyword">public</span> T Value &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Destination</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">int</span> Page &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">   <span class="keyword">public</span> T Value &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>希望能將Source&lt;T&gt;對應到Destination&lt;T&gt;，而這邊的泛型T有兩組分別如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">string</span> Name &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Test1</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">string</span> NickName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>同事原本寫的Mapper Configuration對應如下 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> config = <span class="keyword">new</span> MapperConfiguration(cfg =&gt;</span><br><span class="line"> &#123;</span><br><span class="line">  cfg.CreateMap&lt;Source&lt;Test&gt;, Destination&lt;Test1&gt;&gt;()</span><br><span class="line">     .ForMember(d =&gt; d.Page, o =&gt; o.MapFrom(s =&gt; s.Page1))</span><br><span class="line">     .ForMember(d =&gt; d.Value, o =&gt; o.MapFrom(s =&gt; s.Value));</span><br><span class="line"></span><br><span class="line">  cfg.CreateMap&lt;Test, Test1&gt;()</span><br><span class="line">  .ForMember(d =&gt; d.NickName, o =&gt; o.MapFrom(s =&gt; s.name));</span><br><span class="line"> &#125;);</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> mapper = config.CreateMapper();</span><br><span class="line"> Source&lt;Test&gt; Source = <span class="keyword">new</span> Source&lt;Test&gt; </span><br><span class="line"> &#123;</span><br><span class="line">  Page = <span class="number">1</span>,</span><br><span class="line">  Value = <span class="keyword">new</span> Test </span><br><span class="line">  &#123;</span><br><span class="line">   name = <span class="string">&quot;hi&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"> Destination&lt;Test1&gt; Result  = mapper.Map&lt;Source&lt;Test&gt;, Destination&lt;Test1&gt;&gt;(Source);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這樣寫對應會過，但是變成泛型的T有多種可能時，要寫多組的Source與Destination對應，喪失了AutoMapper的重用性 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">cfg.CreateMap&lt;Source&lt;NewClass2&gt;, Destination&lt;NewClass2&gt;&gt;()</span><br><span class="line">     .ForMember(d =&gt; d.Page, o =&gt; o.MapFrom(s =&gt; s.Page))</span><br><span class="line">     .ForMember(d =&gt; d.Value, o =&gt; o.MapFrom(s =&gt; s.Value));</span><br><span class="line"></span><br><span class="line">    cfg.CreateMap&lt;Source&lt;NewClass3&gt;, Destination&lt;NewClass4&gt;&gt;()</span><br><span class="line">     .ForMember(d =&gt; d.Page, o =&gt; o.MapFrom(s =&gt; s.Page))</span><br><span class="line">     .ForMember(d =&gt; d.Value, o =&gt; o.MapFrom(s =&gt; s.Value));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//............一直往下增加</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>能不能讓Source與Destination設定一次就好，之後只要多寫Generic的Type對應即可，其實AutoMapper是有提供的，方式如下 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">cfg.CreateMap(<span class="keyword">typeof</span>(Source&lt;&gt;), <span class="keyword">typeof</span>(Destination&lt;&gt;))</span><br><span class="line">   .ForMember(<span class="string">&quot;Page&quot;</span>,o =&gt; o.MapFrom(<span class="string">&quot;Page1&quot;</span>))</span><br><span class="line">   .ForMember(<span class="string">&quot;Value&quot;</span>,o =&gt; o.MapFrom(<span class="string">&quot;Value&quot;</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之後只要針對泛型的Class補充即可，Source<t>對應到Destination<t>就已經設定完了，以上供參考</t></t></p>
]]></content>
      <tags>
        <tag>AutoMapper</tag>
      </tags>
  </entry>
  <entry>
    <title>AutoMapper與Json.NET JObject對應問題</title>
    <url>/2015/12/08/AutoMapper%E8%88%87Json-NET-JObject%E5%B0%8D%E6%87%89%E5%95%8F%E9%A1%8C/</url>
    <content><![CDATA[<p>使用套件:<br>Json.NET 7.0.1 :<a href="https://www.nuget.org/packages/Newtonsoft.Json/7.0.1">&nbsp;https://www.nuget.org/packages/Newtonsoft.Json/7.0.1</a><br>AutoMapper 4.04 :&nbsp;<a href="https://www.nuget.org/packages/AutoMapper/4.0.4">https://www.nuget.org/packages/AutoMapper/4.0.4</a></p>
<p>今天碰到一個問題，就是有個API回傳值的欄位是不固定無法掌握的，所以只好在轉型成強型別時以object當做該屬性的類別，但JsonConvert碰到類別為Object的東西就會轉成JObject ,而AutoMapper對應JObject會炸掉。以下是簡單時間的範例Code</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> Mapper.CreateMap&lt;source, destination&gt;()</span><br><span class="line"> .ForMember(d =&gt; d.d_name, o =&gt; o.MapFrom(s =&gt; s.name))</span><br><span class="line"> .ForMember(d =&gt; d.d_obj, o =&gt; o.MapFrom(s =&gt; s.obj));</span><br><span class="line"></span><br><span class="line"> source test = <span class="keyword">new</span> source </span><br><span class="line"> &#123;</span><br><span class="line">  name = <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  obj = <span class="keyword">new</span> &#123;code = <span class="number">100</span>&#125;,</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> result = Mapper.Map&lt;destination&gt;(test);</span><br><span class="line"> result.Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">source</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">object</span> obj &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">destination</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> d_name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">object</span> d_obj &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Source與Destination都有個property為object的類別屬性，在Main()裡面也想好兩個類別的對應關係，並且先準備好Source 然後透過AutoMapper轉出Result,在以上的範例執行正確沒問題<br><a href="http://3.bp.blogspot.com/-C1ypPTW6LWE/VmaV1B7yBfI/AAAAAAAAHqc/M-ACZeUD5IU/s1600/1.png"><img src="http://3.bp.blogspot.com/-C1ypPTW6LWE/VmaV1B7yBfI/AAAAAAAAHqc/M-ACZeUD5IU/s640/1.png"></a></p>
<p>換個寫法</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> Mapper.CreateMap&lt;source, destination&gt;()</span><br><span class="line"> .ForMember(d =&gt; d.d_name, o =&gt; o.MapFrom(s =&gt; s.name))</span><br><span class="line"> .ForMember(d =&gt; d.d_obj, o =&gt; o.MapFrom(s =&gt; s.obj));</span><br><span class="line"></span><br><span class="line"> source test = JsonConvert.DeserializeObject&lt;source&gt;(<span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;test\&quot;,\&quot;obj\&quot; : &#123;\&quot;code\&quot;:100&#125;&#125;&quot;</span>);</span><br><span class="line"> <span class="keyword">var</span> result = Mapper.Map&lt;destination&gt;(test);</span><br><span class="line"> result.Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">source</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">object</span> obj &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">destination</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> d_name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">object</span> d_obj &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>差別只在於原本Source改成透過Json.Net由字串轉回來而已，這時候只要執行到AutoMapper那一行就會爆炸，錯誤訊息如下</p>
<div class="note info">
            <p>AutoMapperMappingException: </p><p>Mapping types:<br>JObject -&gt; JObject<br>Newtonsoft.Json.Linq.JObject -&gt; Newtonsoft.Json.Linq.JObject</p><p>Destination path:<br>destination.d_obj.d_obj</p><p>Source value:<br>{<br>  “code”: 100<br>}</p>
          </div>


<p>JsonConvert碰到目標為Object型別的欄位，會轉成JObject塞進去，AutoMapper用它來對應，<br>所以如果要解決這個問題需要做一些處理</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//將Mapper改成如下</span></span><br><span class="line"> Mapper.CreateMap&lt;source, destination&gt;()</span><br><span class="line"> .ForMember(d =&gt; d.d_name, o =&gt; o.MapFrom(s =&gt; s.name))</span><br><span class="line"> .ForMember(d =&gt; d.d_obj, o =&gt; o.ResolveUsing(s =&gt;</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">if</span> (s.obj <span class="keyword">is</span> JObject)</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="keyword">var</span> temp = s.obj <span class="keyword">as</span> JObject;</span><br><span class="line">   <span class="keyword">return</span> temp.ToObject&lt;Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> s.obj;</span><br><span class="line"> &#125;));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這樣就可以正確地取出了<br><a href="http://2.bp.blogspot.com/-pT-gamin7D4/VmaX7zqy8ZI/AAAAAAAAHqo/shVBh49fMgQ/s1600/1.png"><img src="http://2.bp.blogspot.com/-pT-gamin7D4/VmaX7zqy8ZI/AAAAAAAAHqo/shVBh49fMgQ/s640/1.png"></a></p>
]]></content>
      <tags>
        <tag>AutoMapper</tag>
        <tag>JSON</tag>
      </tags>
  </entry>
  <entry>
    <title>Async Await DeadLock問題</title>
    <url>/2016/01/20/Async-Await-DeadLock%E5%95%8F%E9%A1%8C/</url>
    <content><![CDATA[<p>之前寫了一個簡單上傳圖片的功能，碰到用await跟async非同執行的問題，本來在本機Visual Studio偵錯執行Run都好好的，但是放到線上後就永遠得不到回應TimeOut</p>
<p>隱隱約約記得之前黑大寫過類似的文章，當時看過沒啥特別感覺，翻回來看後在實際操作後終於弄懂了(果然寫程式很多地方一知半解會GG的)，關於Async、Await這些推薦可以看這兩篇文章</p>
<p><a href="http://huan-lin.blogspot.com/2016/01/async-and-await.html">Huan-Lin 學習筆記-async 與 await</a><br><a href="http://blog.darkthread.net/post-2015-08-06-await-task-block-deadlock.aspx">黑暗執行緒-&nbsp;await與Task.Result/Task.Wait()的Deadlock問題</a></p>
<p>兩位前輩大大已經寫的很完整詳盡了，在這邊就不獻醜了，只簡單提供個範例給有興趣的人玩玩</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DeadLockController</span> : <span class="title">ApiController</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        [<span class="meta">Route(<span class="meta-string">&quot;api/DeadLock/Index&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> HttpResponseMessage <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Task&lt;<span class="built_in">int</span>&gt; mytask = Go();</span><br><span class="line">            mytask.Wait();</span><br><span class="line">            <span class="keyword">return</span> Request.CreateResponse(mytask.Result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        [<span class="meta">Route(<span class="meta-string">&quot;api/DeadLock&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> HttpResponseMessage <span class="title">DeadLock</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = Go().Result;</span><br><span class="line">            <span class="keyword">return</span> Request.CreateResponse(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        [<span class="meta">Route(<span class="meta-string">&quot;api/DeadLock/NoDeadLock&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="title">NoDeadLock</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> Go();</span><br><span class="line">            <span class="keyword">return</span> Request.CreateResponse(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task&lt;<span class="built_in">int</span>&gt; <span class="title">Go</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="built_in">int</span> res = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">await</span> Task.Run(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//假裝執行某個耗時程序後取得結果</span></span><br><span class="line">                Task.Delay(<span class="number">1000</span>);</span><br><span class="line">                res = <span class="number">32767</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這邊只有NoDeadLock那個Action的寫法才不會DeadLock,其餘兩個永遠都不會得到回應，原因簡單的說就是在<span style="color: red;">Web中</span>**(特別強調在Web中，因為Console並不會)**，.Result 與 Wait()的方法都會鎖定目前的Thread等待結果回應再繼續執行，而上面的範例GO()這個Method在Web中會記住是哪個Thread來呼叫他的，以便他執行完後回應該Thread結果繼續執行。</p>
<p>這時候就會發生DeadLock了，因為外面用Wait() or .Result鎖住當前Thread，GO()這個Method又在等待他被釋放好跟他回應結果，互相等待也就DeadLock了。</p>
<p>前面兩篇文章很久以前就看過了，只是當時沒有特別放在心上，直到被這個簡單到只有5行Code的東西困擾了3~4天，才終於想到有這件事情，現在不懂沒關係，等到被鎖一次就懂了(吶喊!!)</p>
]]></content>
      <tags>
        <tag>Async</tag>
        <tag>MVC</tag>
        <tag>WebAPI</tag>
      </tags>
  </entry>
  <entry>
    <title>AutoMapper運用</title>
    <url>/2015/10/23/AutoMapper%E9%81%8B%E7%94%A8/</url>
    <content><![CDATA[<p>寫網站常常會遇到從ViewModel對應到應用程式的DTO，或是DB的物件問題，以前自己的做法都是</p>
<div>
</div>```csharp
public bool Login(LoginViewModel model)
{
   Account account = new Account()
   {
      Account = model.Account,
      Password = model.Password
   }
   var Result = _AccountService.Loign(account );
   return Result;
}

<p>public class LoginViewModel<br>{<br>  public string Account{get;set;}<br>  public string Password{get;set;}<br>}</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">等到內部運作完畢的時候可能又要把對應的DTO處理成ViewModel在拋回頁面，這種反覆一直寫的動作其實真的很煩人，直到最近同事介紹了[AutoMapper](https:&#x2F;&#x2F;www.nuget.org&#x2F;packages&#x2F;AutoMapper&#x2F;)給我們之後，整個流程得到了大幅度的改善。</span><br><span class="line"></span><br><span class="line">*   AutoMapper的基本運用</span><br><span class="line"></span><br><span class="line">    當兩個物件的屬性都一樣時，AutoMapper會自動去對應並且轉出</span><br><span class="line">[![](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-j6G1kaI6BXw&#x2F;VimtMro_B9I&#x2F;AAAAAAAAHgY&#x2F;qZYVfNriOm0&#x2F;s1600&#x2F;1.png)](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-j6G1kaI6BXw&#x2F;VimtMro_B9I&#x2F;AAAAAAAAHgY&#x2F;qZYVfNriOm0&#x2F;s1600&#x2F;1.png)</span><br><span class="line"></span><br><span class="line">    如果兩個物件的屬性對應略有不同，也可以加上規則</span><br><span class="line"></span><br><span class="line">    [![](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-n04XweFHx5w&#x2F;VimuRLyJtGI&#x2F;AAAAAAAAHgg&#x2F;H0pNXYnW11w&#x2F;s1600&#x2F;1.png)](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-n04XweFHx5w&#x2F;VimuRLyJtGI&#x2F;AAAAAAAAHgg&#x2F;H0pNXYnW11w&#x2F;s1600&#x2F;1.png)</span><br><span class="line">*   如果兩的類別對應到同一個物件的情況</span><br><span class="line">    &#96;&#96;&#96;csharp</span><br><span class="line">void Main()</span><br><span class="line">&#123;</span><br><span class="line"> AccountViewModel model &#x3D; new AccountViewModel() &#123;</span><br><span class="line">  Account &#x3D; &quot;toyo&quot;,</span><br><span class="line">  Password &#x3D; &quot;pwd&quot;,</span><br><span class="line">  City &#x3D; &quot;Taipei&quot;,</span><br><span class="line">  District &#x3D; &quot;大安&quot;</span><br><span class="line"> &#125;;</span><br><span class="line"> var Group &#x3D; new Group() &#123;</span><br><span class="line">  ID &#x3D; 1,</span><br><span class="line">  Name &#x3D; &quot;客戶群組&quot;</span><br><span class="line"> &#125;;</span><br><span class="line"> Mapper.CreateMap&lt;AccountViewModel,AccountDTO&gt;()</span><br><span class="line">  .ForMember(d&#x3D;&gt; d.Address , o&#x3D;&gt;o.MapFrom(s&#x3D;&gt;string.Concat(s.City,s.District))); var account &#x3D; Mapper.Map&lt;AccountDTO&gt;(model);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;這邊用上面已經轉好的account,來接續Mapper</span><br><span class="line"> Mapper.CreateMap&lt;Group, AccountDTO&gt;()</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.Account, o &#x3D;&gt; o.Ignore())</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.Password, o &#x3D;&gt; o.Ignore())</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.Address, o &#x3D;&gt; o.Ignore())</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.GroupName, o &#x3D;&gt; o.MapFrom(s&#x3D;&gt;s.Name));</span><br><span class="line">    &#x2F;&#x2F;注意</span><br><span class="line"> account &#x3D; Mapper.Map&lt;Group,AccountDTO&gt;(Group,account);</span><br><span class="line"></span><br><span class="line">     account.Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public class AccountViewModel</span><br><span class="line">&#123;</span><br><span class="line"> public string Account &#123; get; set; &#125;</span><br><span class="line"> public string Password &#123; get; set; &#125;</span><br><span class="line"> public string City &#123; get; set; &#125;</span><br><span class="line"> public string District &#123;get;set;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public class AccountDTO</span><br><span class="line">&#123;</span><br><span class="line"> public string Account &#123; get; set; &#125;</span><br><span class="line"> public string Password &#123; get; set; &#125;</span><br><span class="line"> public string Address &#123; get; set; &#125;</span><br><span class="line"> public string GroupName &#123;get;set;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public class Group&#123;</span><br><span class="line"> public int ID &#123; get; set; &#125;</span><br><span class="line"> public string Name &#123;get;set;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>結果<br><a href="http://3.bp.blogspot.com/--ouuEtVfvJg/Vimw5twfysI/AAAAAAAAHgs/yC4URuCen0Y/s1600/1.png"><img src="http://3.bp.blogspot.com/--ouuEtVfvJg/Vimw5twfysI/AAAAAAAAHgs/yC4URuCen0Y/s1600/1.png"></a><div></p>
</div><div>
</div><div>最後,在MVC的網站裡面使用AutoMapper可以在把所有規則都先寫在ProFile裡面，然後在Global一次註冊，之後在程式裡面用到就不用每次再寫CreateMap的部分</div><div>
</div>**Profile : **
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ControllerMappingProfile</span> : <span class="title">Profile</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> ProfileName</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">get</span></span><br><span class="line">  &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;ControllerMappingProfile&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span> &#123;</span><br><span class="line">  Mapper.CreateMap&lt;AccountViewModel, AccountDTO&gt;()</span><br><span class="line">   .ForMember(d =&gt; d.Address, o =&gt; o.MapFrom(s =&gt; <span class="built_in">string</span>.Concat(s.City, s.District)));</span><br><span class="line"></span><br><span class="line">  Mapper.CreateMap&lt;Group, AccountDTO&gt;()</span><br><span class="line">      .ForMember(d =&gt; d.Account, o =&gt; o.Ignore())</span><br><span class="line">      .ForMember(d =&gt; d.Password, o =&gt; o.Ignore())</span><br><span class="line">      .ForMember(d =&gt; d.Address, o =&gt; o.Ignore())</span><br><span class="line">      .ForMember(d =&gt; d.GroupName, o =&gt; o.MapFrom(s =&gt; s.Name));</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>**AutoMapperConfig :  **</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AutoMapperConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Mapper.Initialize(x =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                x.AddProfile&lt;ControllerMappingProfile&gt;();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>最後在Global Application_Start註冊即可 ```csharp<br>protected void Application_Start()<br>{<br>   AutoMapperConfig.Configure();<br>}</p>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>AutoMapper</tag>
        <tag>MVC</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>AutoMapper運用 (二)</title>
    <url>/2015/10/23/AutoMapper%E9%81%8B%E7%94%A8-%E4%BA%8C/</url>
    <content><![CDATA[<p>如果是複雜Class要Mapper時 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Category</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> List&lt;product&gt;  products &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> qantity &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Category要Mapping到CategoryViewModel</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CategoryViewModel</span> </span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">int</span> id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> List&lt;Book&gt;  books &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Book</span> </span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> title &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">int</span> number&#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有兩種做法,結果都會是一樣的</p>
<ol>
<li><p>```csharp<br>Category category = new Category()<br>{<br>id = 1,<br>products = new List<Product>()<br>{<br>new Product()<br>{<br> id = 1,<br> name = “西遊戲”,<br> qantity =10,<br>},<br>new Product()<br>{<br> id = 2,<br> name = “三國志”,<br> qantity =30,<br>},<br>new Product()<br>{<br> id = 3,<br> name = “鹿鼎記”,<br> qantity =50,<br>}<br>}<br>};</p>
<p>  Mapper.CreateMap&lt;Category, CategoryViewModel&gt;()<br>.ForMember(d =&gt; d.id, o =&gt; o.MapFrom(s =&gt; s.id))<br>.ForMember(d =&gt; d.books, o =&gt; o.MapFrom(s =&gt; s.products));</p>
<p>  Mapper.CreateMap&lt;Product, Book&gt;()<br>.ForMember(d =&gt; d.title, o =&gt; o.MapFrom(s =&gt; s.name))<br>.ForMember(d =&gt; d.number, o =&gt; o.MapFrom(s =&gt; s.qantity));</p>
</li>
</ol>
<p> var viewModel = Mapper.Map<CategoryViewModel>(category);<br> viewModel.Dump();</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">2.  &#96;&#96;&#96;csharp</span><br><span class="line">void Main()</span><br><span class="line">&#123;</span><br><span class="line">   Category category &#x3D; new Category()</span><br><span class="line">   &#123;</span><br><span class="line">     id &#x3D; 1,</span><br><span class="line">     products &#x3D; new List&lt;Product&gt;()</span><br><span class="line">     &#123;</span><br><span class="line">       new Product()</span><br><span class="line">       &#123;</span><br><span class="line">         id &#x3D; 1,</span><br><span class="line">         name &#x3D; &quot;西遊戲&quot;,</span><br><span class="line">         qantity &#x3D;10,</span><br><span class="line">       &#125;,</span><br><span class="line">       new Product()</span><br><span class="line">       &#123;</span><br><span class="line">         id &#x3D; 2,</span><br><span class="line">         name &#x3D; &quot;三國志&quot;,</span><br><span class="line">         qantity &#x3D;30,</span><br><span class="line">       &#125;,</span><br><span class="line">       new Product()</span><br><span class="line">       &#123;</span><br><span class="line">         id &#x3D; 3,</span><br><span class="line">         name &#x3D; &quot;鹿鼎記&quot;,</span><br><span class="line">         qantity &#x3D;50,</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line">     Mapper.CreateMap&lt;Category, CategoryViewModel&gt;()</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.id, o &#x3D;&gt; o.MapFrom(s &#x3D;&gt; s.id))</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.books, o &#x3D;&gt; o.ResolveUsing&lt;BookResolve&gt;().FromMember(s &#x3D;&gt; s.products));</span><br><span class="line"></span><br><span class="line">     var viewModel &#x3D; Mapper.Map&lt;CategoryViewModel&gt;(category);</span><br><span class="line"> viewModel.Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public class BookResolve : ValueResolver&lt;IList&lt;Product&gt;, IList&lt;Book&gt;&gt;&#123;</span><br><span class="line"> protected override IList&lt;Book&gt; ResolveCore(IList&lt;Product&gt; source) &#123;</span><br><span class="line">    List&lt;Book&gt; books &#x3D; new List&lt;Book&gt;();</span><br><span class="line">    foreach (var item in source)</span><br><span class="line">    &#123;</span><br><span class="line">      var book &#x3D; new Book()      &#123;</span><br><span class="line">        number &#x3D; item.qantity,</span><br><span class="line">        title &#x3D; item.name</span><br><span class="line">      &#125;;</span><br><span class="line">      books.Add(book);</span><br><span class="line">    &#125;</span><br><span class="line">    return books;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>AutoMapper</tag>
        <tag>MVC</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>Cache</title>
    <url>/2013/05/15/Cache/</url>
    <content><![CDATA[<p>今天在研究Cache，意外發現好多觀念上的問題<br>有些東西還沒時間驗證跟消化，先筆記起來之後回來好好看一下</p>
<p><a href="http://blog.miniasp.com/post/2008/01/14/Correct-using-Cache-in-ASPNET.aspx">保哥 正確的使用 ASP.NET 的 Cache 物件</a><br><a href="http://stackoverflow.com/questions/343899/how-to-cache-data-in-a-mvc-application">How to cache data in a MVC application</a><br><a href="http://maidot.blogspot.tw/2011/10/aspnet-mvc-cache.html">[ASP.NET MVC] 快取( Cache ) 的機制</a><br><a href="http://wiki.dabutek.com/WeakReference.ashx">.NET記憶體管理之弱式參考(Weak Reference)</a><br><a href="http://blog.stevensanderson.com/2008/10/15/partial-output-caching-in-aspnet-mvc/">Partial Output Caching in ASP.NET MVC</a></p>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>Entity Framework問題筆記</title>
    <url>/2013/05/01/Entity-Framework%E5%95%8F%E9%A1%8C%E7%AD%86%E8%A8%98/</url>
    <content><![CDATA[<p>目前使用的是MVC4 + Entity Framework </p>
<p>**<span style="color: red;">Q:</span>**無法更新 EntitySet ‘xxxx’，因為它有 DefiningQuery，但是在 <modificationfunctionmapping> 項目中沒有 <insertfunction> 項目來支援目前的作業。<br>**<span style="color: red;">A：</span>**這是因為 Table 沒有 PK 的關係，所以 EF 就認定這是唯讀的 Table ，在 EDMX 的 Model 中的 Table 的欄位，加上 pk 後就正常了 </p>
<p>**<span style="color: red;">Q:</span>**在設計資料庫時明明有指定欄位的預設值，可是每次透過 EF 新增資料時，該欄位的值卻是 null？<br>**<span style="color: red;">A:</span>**這是因為 DB 該欄位有 Default Value 而且又不允許 null，在 Visual Studio 中開啟 .edmx 檔案，在模型編輯器中點選 entity 的屬性，然後到屬性視窗中設定其 Default Value 屬性。參考下圖： </p>
<p><a href="http://1.bp.blogspot.com/-TJvtcnfcdUU/UYDGF1mXiGI/AAAAAAAAC6M/TAGlBEJAgm8/s1600/11.png"><img src="http://1.bp.blogspot.com/-TJvtcnfcdUU/UYDGF1mXiGI/AAAAAAAAC6M/TAGlBEJAgm8/s1600/11.png"></a></insertfunction></modificationfunctionmapping><br>參考自:<br><a href="http://www.dotblogs.com.tw/franma/archive/2010/12/20/20263.aspx">Entity Framework 4 的錯誤訊息排除</a><br><a href="http://huan-lin.blogspot.tw/2012/12/entity-framework-column-default-value.html">Entity Framework 欄位預設值相關問題</a></p>
]]></content>
      <tags>
        <tag>Entity Framework</tag>
      </tags>
  </entry>
  <entry>
    <title>[Config] 幫自訂的Config新增Release與Debug版本</title>
    <url>/2016/07/06/Config-%E5%B9%AB%E8%87%AA%E8%A8%82%E7%9A%84Config%E6%96%B0%E5%A2%9ERelease%E8%88%87Debug%E7%89%88%E6%9C%AC/</url>
    <content><![CDATA[<p><span style="font-family: Verdana, sans-serif;">一般開發的時候通常會有測試機、正式機、或是Release前的機器…等，而在發佈到每台機器都要去做調整Config確實是很惱人的事情，感覺一個分神可能就會把測試機的連線貼到正式機之類的，這可能就是一場大災難。</span><br><span style="font-family: Verdana, sans-serif;"><br></span><span style="font-family: Verdana, sans-serif;"><br></span><span style="font-family: Verdana, sans-serif;">還好Visual Studio很貼心的為WebConfig分出了Release版本跟Debug版本，並依據發佈時你所選擇的組態檔，去做對應的修改。(註:如果需要更多版本，請到<strong>建置</strong>&nbsp;&gt;&nbsp;<strong>組態管理員</strong>去新增)。</span></p>
<div><span style="font-family: Verdana, sans-serif;">
</span></div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[<span style="font-family: Verdana, sans-serif;">![](https://1.bp.blogspot.com/-bTABzkFPg84/V3yBI-o1a3I/AAAAAAAAHwE/Acz2x_EWkJMhQ6HTDpAVi3SuhLeuPiVCACLcB/s320/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</span>](https://1.bp.blogspot.com/-bTABzkFPg84/V3yBI-o1a3I/AAAAAAAAHwE/Acz2x_EWkJMhQ6HTDpAVi3SuhLeuPiVCACLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: small; text-align: start;"><span style="font-family: Verdana, sans-serif;">Release版本跟Debug版本</span></span></td></tr></tbody></table><span style="font-family: Verdana, sans-serif;">
</span><span style="font-family: Verdana, sans-serif;">
</span><span style="font-family: Verdana, sans-serif;">之前有寫篇文章[【擴充WebConfig】](http://toyo0103.blogspot.tw/2013/09/webconfigwebconfig.html)有提到如何在專案中加掛Config檔案，讓設定檔能做簡單的歸類整理。</span>
<span style="font-family: Verdana, sans-serif;">
</span><span style="font-family: Verdana, sans-serif;">原本以為Visual Studio應該會有相關的功能，可以對這類自訂的Config分割出對應版本，結果東找西找都找不到方法去做對應，原來VS似乎沒有提供這個功能(?)</span>
<span style="font-family: Verdana, sans-serif;">還好在網路上找到了解決的套件跟方法</span>
<span style="font-family: Verdana, sans-serif;">[How to add config transformations for a custom config file in Visual Studio?](http://stackoverflow.com/questions/34735132/how-to-add-config-transformations-for-a-custom-config-file-in-visual-studio)</span>

<p>簡單說就是先去下載VS擴充套件(註:目前似乎只支援到VS 2013)<br><a href="https://visualstudiogallery.msdn.microsoft.com/69023d00-a4f9-4a34-a6cd-7e854ba318b5">SlowCheetah - XML Transforms</a></p>
<p>安裝完後，用VS 2013開啟專案，並且對著想要分割版本的Config檔案按右鍵，選擇Add Transfom即可</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-rH4cnE-93Gc/V3yDHDPxl2I/AAAAAAAAHwQ/RtNpbTiBOKYsVad-Vjb_McHswPnPJy_pwCLcB/s320/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://4.bp.blogspot.com/-rH4cnE-93Gc/V3yDHDPxl2I/AAAAAAAAHwQ/RtNpbTiBOKYsVad-Vjb_McHswPnPJy_pwCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p>搞定!!!! 之後再來寫篇如何透過Release Config檔在發佈時置換屬性值好了~</p>
]]></content>
      <tags>
        <tag>Config</tag>
        <tag>webconfig</tag>
      </tags>
  </entry>
  <entry>
    <title>Entity Framwork 使用 SQL的PWDCOMPARE函數</title>
    <url>/2013/04/21/Entity-Framwork-%E4%BD%BF%E7%94%A8-SQL%E7%9A%84PWDCOMPARE%E5%87%BD%E6%95%B8/</url>
    <content><![CDATA[<p>要使用SQL的PWDCOMPARE 函數，必須先將邏輯寫進StoreProcedure或是SQL function裡面，這裡以StoreProcedure為例  </p>
<ul>
<li>  先建立StoreProcedure在裡面使用PWDCOMPARE函數比對密碼是否正確，成功傳回1，失敗傳回0</li>
</ul>
<pre class="brush :sql">create procedure sp_CheckLoginPassword
 @Account varchar(50),
 @Password varchar(150)
as
 declare @validate int
 set @validate = (
 select PWDCOMPARE(@Password,tcuser.Password)
 from tcuser
 where tcuser.Account = @Account) select isnull(@validate,0)
</pre>*   建立Entity Framwork，將剛剛寫的StoreProcedure更新進來
<p><a href="http://1.bp.blogspot.com/-NaMkPj2oZy0/UXOgFaUGlHI/AAAAAAAACf8/hjUy03-bD-M/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png"><img src="http://1.bp.blogspot.com/-NaMkPj2oZy0/UXOgFaUGlHI/AAAAAAAACf8/hjUy03-bD-M/s320/%E6%9C%AA%E5%91%BD%E5%90%8D.png"></a></p>
<ul>
<li>透過Entity Framwork建立出來的物件呼叫該方法就大功告成了!! <pre class='brush:csharp'><br>public bool CheckPassword()<br>{<br>//傳回0表示驗證失敗; 1表示成功<br>NTIEntities db = new NTIEntities();<br>bool isValidate = db.sp_CheckLoginPassword(this.Account, this.Password).First() == 1 ? true : false;<br>return isValidate;<br>}<br></pre></li>
<li>驗證方法成功後呼叫FormsAuthentication.RedirectFromLoginPage(),告訴網站該使用者已經成功登入 ```csharp<br>if (Acclogin.CheckPassword())<br>{  FormsAuthentication.RedirectFromLoginPage(Acclogin.Account, false);<br>return Redirect(returnUrl);<br>}</li>
</ul>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>MVC</tag>
        <tag>Entity Framework</tag>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Git 語法筆記</title>
    <url>/2013/04/28/Git-%E8%AA%9E%E6%B3%95%E7%AD%86%E8%A8%98/</url>
    <content><![CDATA[<p>將狀態還原到當時的commit ```csharp<br>git reset “編碼”</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">將判斷現在source code的狀態 &#96;&#96;&#96;csharp</span><br><span class="line">git status</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>將改變過的source code全部add進去 ```csharp<br>git add .</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Commit &#96;&#96;&#96;csharp</span><br><span class="line">git commit -m &quot;名稱&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>push ```csharp<br>git push origin master</p>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>Forms Authentication in MVC</title>
    <url>/2013/04/21/Forms-Authentication-in-MVC/</url>
    <content><![CDATA[<p>今天練習在MVC4中使用Forms Authentication的驗證機制來控制登入與否的狀態，記錄一下筆記  </p>
<ul>
<li>首先打開MVC的web.config找到authentication的標籤將登入頁面註冊一下 ```csharp<authentication mode="Forms">
    <forms loginUrl="~/BackStage/Login" timeout="2880" />
</authentication></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">只要在沒有登入的情況下瀏覽需要權限的頁面就會被導到&#x2F;BackStage&#x2F;Login，要求其登入*   接下來設定哪些action需要權限才能觀看，在MVC4中的設定方式如下</span><br><span class="line">        *   第一種：直接在要action上面加上[Authorize]，表示該action匿名的方式無法存取</span><br><span class="line">       &#96;&#96;&#96;csharp</span><br><span class="line">public class ExhibitionController : Controller</span><br><span class="line">       &#123;</span><br><span class="line">         &#x2F;&#x2F;</span><br><span class="line">         &#x2F;&#x2F; GET: &#x2F;Exhibition&#x2F;</span><br><span class="line">         [Authorize]</span><br><span class="line">         public ActionResult Index()</span><br><span class="line">         &#123;</span><br><span class="line">           return View();</span><br><span class="line">         &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br></pre></td></tr></table></figure>
<ul>
<li>第二種：在Controller加上[Authorize]，表示所有這個controller底下的action皆需要驗證通過的狀態下才能讀取，可以在action加上 [AllowAnonymous]讓該action不用驗證              <pre class="brush : csharp"><br>[Authorize]//預設這個controller都要驗證過後才能讀取<br>public class ExhibitionController : Controller<br>{<br>  [AllowAnonymous]//這個action無需驗證，所有人皆能直接讀取<br>  public ActionResult Index()<br>  {<pre><code>  return View();
</code></pre>
  }<br>  public ActionResult about()<br>  {<pre><code>  return View();
</code></pre>
  }<br>}<pre><code> &lt;/pre&gt;
</code></pre>
</li>
<li>驗證成功後呼叫FormsAuthentication.RedirectFromLoginPage()，告訴網站該使用者已經通過驗證。 ```csharp<br>if (Acclogin.CheckPassword())<br>{ FormsAuthentication.RedirectFromLoginPage(Acclogin.Account, false);<br>return Redirect(returnUrl);<br>}</li>
</ul>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>GridView 加入空白行</title>
    <url>/2013/07/11/GridView-%E5%8A%A0%E5%85%A5%E7%A9%BA%E7%99%BD%E8%A1%8C/</url>
    <content><![CDATA[<ul>
<li>Function如下 ```vb<br>‘’’ <summary><br>‘’’’’’ </summary><br>‘’’ <param name="gv">要新增空白行的GridView</param><br>‘’’ <param name="count">要加入幾行</param><br>‘’’ <remarks></remarks><br>Public Shared Sub GridView_AddEmptyRow(gv As GridView, count As Integer)<br>  Dim dt As DataTable = New DataTable()<br>  Dim dr As DataRow<br>  For i = 0 To gv.Columns.Count - 1 Step 1<pre><code>  dt.Columns.Add(New DataColumn(gv.Columns(i).HeaderText, System.Type.GetType(&quot;System.String&quot;)))
</code></pre>
  Next<br>  For i = 1 To count Step 1<pre><code>  dr = dt.NewRow()
  For x = 0 To gv.Columns.Count - 1 Step 1
      dr(gv.Columns(x).HeaderText) = String.Empty
  Next
  dt.Rows.Add(dr)
</code></pre>
  Next<br>  gv.DataSource = dt<br>  gv.DataBind()<br>End Sub</li>
</ul>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>ASP</tag>
        <tag>GridView</tag>
      </tags>
  </entry>
  <entry>
    <title>[Linq]動態組合Linq條件</title>
    <url>/2016/01/11/Linq-%E5%8B%95%E6%85%8B%E7%B5%84%E5%90%88Linq%E6%A2%9D%E4%BB%B6/</url>
    <content><![CDATA[<p>以前寫Linq的時候常常碰到一個問題,就是判斷一個條件是否達成來決定Linq的Where條件該如何組合,<br>例如:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="built_in">bool</span> Flag = <span class="literal">true</span>;</span><br><span class="line"> List&lt;DealDataForGov&gt; SourceData = <span class="keyword">new</span> List&lt;DealDataForGov&gt;</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">new</span> DealDataForGov</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;台北市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;a1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2015</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">new</span> DealDataForGov</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;高雄市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;a1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2016</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">new</span> DealDataForGov</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;台中市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;c1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2014</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (Flag)</span><br><span class="line"> &#123;</span><br><span class="line">  SourceData.Where((x) =&gt; x.HouseKind == <span class="string">&quot;a1&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> </span><br><span class="line"> &#123;</span><br><span class="line">  <span class="comment">//因為某個條件,新增新的搜尋條件</span></span><br><span class="line">  SourceData.Where((x) =&gt; x.HouseKind ==<span class="string">&quot;a1&quot;</span> &amp;&amp; x.Year &gt;= <span class="number">2015</span> );</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DealDataForGov</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> Address &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> HouseKind &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">int</span> Year &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>條件少還算好寫，一旦條件落落長的時候就會貼的到處都是，不僅彈性降低也讓維護增加困難度，還好在黑大那邊看到LINQKIT這個好東西<a href="http://blog.darkthread.net/post-2015-10-23-linqkit.aspx">黑暗執行緒-組裝動態LINQ條件的利器－LINQKit</a></p>
<p>以下簡短介紹一下這個<a href="https://www.nuget.org/packages/LinqKit/">LINQKit</a>的套件，有了他之後感覺Code都活過來了XD<br>範例:</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> List&lt;TargetModel&gt; SourceData = <span class="keyword">new</span> List&lt;TargetModel&gt;</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">new</span> TargetModel</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;台北市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;a1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2015</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">new</span> TargetModel</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;高雄市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;a1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2016</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">new</span> TargetModel</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;台中市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;c1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2014</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> expression = GetWhereExpression();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//SourceData.Where((x) =&gt; x.HouseKind == &quot;a1&quot;);</span></span><br><span class="line"> <span class="keyword">var</span> e1 = SourceData.Where(expression.Compile());</span><br><span class="line"> e1.Dump();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//SourceData.Where((x) =&gt; x.HouseKind ==&quot;a1&quot; &amp;&amp; x.Year &gt; 2015 );</span></span><br><span class="line"> <span class="keyword">var</span> e2 = SourceData.Where(expression.And(x =&gt; x.Year &gt; <span class="number">2015</span>).Compile());</span><br><span class="line"> e2.Dump();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//SourceData.Where((x) =&gt; x.HouseKind ==&quot;a1&quot; || x.Year &gt;=2014 );</span></span><br><span class="line"> <span class="keyword">var</span> e3 = SourceData.Where(expression.Or(x =&gt; x.Year &gt;= <span class="number">2014</span>).Compile());</span><br><span class="line"> e3.Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Expression&lt;Func&lt;TargetModel, <span class="built_in">bool</span>&gt;&gt; GetWhereExpression()</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">var</span> pred = PredicateBuilder.True&lt;TargetModel&gt;();</span><br><span class="line">  pred = pred.And(x=&gt; x.HouseKind ==<span class="string">&quot;a1&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> pred;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TargetModel</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> Address &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> HouseKind &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">int</span> Year &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面有三個範例分別是替代掉註解的寫法,如果有碰到很多條件會動態產生的結果,用LinqKit可以大幅度省掉很多Code以及維護上的複雜度。算是非常好用的小物，推薦給大家</p>
]]></content>
      <tags>
        <tag>LINQ</tag>
      </tags>
  </entry>
  <entry>
    <title>【Docker】Build Image</title>
    <url>/2019/04/22/Docker_build/</url>
    <content><![CDATA[<p><img src="/images/20190422/0.png" alt="/images/20190422/0.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>剛開始使用 Docker 的時候，我常常都是使用別人已經包好的 Image，但難免會有不符使用需要客製的時候，又或是將公司的某些服務做成 Docker Image ，再從多台機器上 Pull Docker Image  直接執行，所以 Docker Build 幾乎是玩 Docker 必學的技巧了  </p>
<p>從 Docker Hub 尋找適合的 Image 來使用</p>
<p><img src="/images/20190422/1.png" alt="/images/20190422/1.png"></p>
<p>前陣子將公司一些服務包成 Docker Image 並部署執行</p>
<p><img src="/images/20190422/2.png" alt="/images/20190422/2.png"></p>
<br>

<h1 id="製作第一個-Docker-Image"><a href="#製作第一個-Docker-Image" class="headerlink" title="製作第一個 Docker Image"></a>製作第一個 Docker Image</h1><p>下面的範例會透過一個簡單的範例來解說包 Docker Image 的過程，希望最後的成果是，我們透過執行自製的 Docker Image 就跑起來一個 ASP.Net 的網站</p>
<br>

<h2 id="開新專案"><a href="#開新專案" class="headerlink" title="開新專案"></a>開新專案</h2><p><img src="/images/20190422/3.png" alt="/images/20190422/1.png"></p>
<p><img src="/images/20190422/4.png" alt="/images/20190422/1.png"></p>
<p>直接用 VS 執行起來就是一個最原始的 MVC 網站</p>
<p><img src="/images/20190422/5.png" alt="/images/20190422/1.png"></p>
<br>

<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>Dockerfile 是 Build Docker Image 的根本，這個檔案會告訴 Docker 該把什麼東西放進 Image ? 步驟是什麼 ? 怎麼啟動 ?</p>
<br>

<p>先新增一個 Docker File 到剛剛的專案中</p>
<p><img src="/images/20190422/6.png" alt="/images/20190422/6.png"></p>
<p>調整屬性</p>
<p><img src="/images/20190422/7.png" alt="/images/20190422/7.png"></p>
<p>這樣如果發行這個專案，dockerfile 就會一起過去</p>
<p><img src="/images/20190422/8.png" alt="/images/20190422/8.png"></p>
<p><img src="/images/20190422/9.png" alt="/images/20190422/9.png"></p>
<br>

<p><strong>Dockerfile 內容</strong></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">mcr.microsoft.com/dotnet/framework/aspnet:latest</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">.</span> <span class="string">/inetpub/wwwroot</span></span><br></pre></td></tr></table></figure>

<p><code>From</code> : 表示你這個 Image 是以哪一個當作 Base，以這次的案例為例，我們選擇微軟官方提供的 mcr.microsoft.com/dotnet/framework/aspnet Image 作為 base，因為它已經幫我們安裝好 IIS 、.net Framework，這樣我們只要專注在我們開發的程式即可。</p>
<p><code>COPY</code> : dockerfile 所屬資料夾所有的內容複製到 container 裡面的 <code>c:/inetpub/wwwroot</code>，也就是 IIS 的預設目錄</p>
<br>

<h2 id="Docker-build"><a href="#Docker-build" class="headerlink" title="Docker build"></a>Docker build</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker build -t &lt;ImageName&gt;:&lt;Tag&gt; &lt;Dockerfile Path&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker build -t my_first_docker_image:latest -t my_first_docker_image:1.0.0 .</span></span><br></pre></td></tr></table></figure>

<p>docker build 時我為這個 Image 下了兩個 tag，分別為 latest、1.0.0</p>
<p><img src="/images/20190422/10.png" alt="/images/20190422/10.png"></p>
<br>

<h2 id="Docker-Run"><a href="#Docker-Run" class="headerlink" title="Docker Run"></a>Docker Run</h2><p>執行剛剛我們自建的 Image，並且將本機的 9999 port mapping 到 container 內的 80 port</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -d -p 9999:80 my_first_docker_image:latest</span></span><br></pre></td></tr></table></figure>

<p>這樣就可以看到網站啦</p>
<p><img src="/images/20190422/11.png" alt="/images/20190422/11.png"></p>
<br>

<h1 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h1><p>這邊只是小小演示如何 Build 一個最簡單的 docker image，其實 Dockerfile 還有很多可以發揮的地方，如果有需要，可以參考以下官方文件</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://docs.docker.com/engine/reference/commandline/build/">Docker build</a></p><p><a href="https://docs.microsoft.com/zh-tw/aspnet/mvc/overview/deployment/docker-aspnetmvc">將 ASP.NET MVC 應用程式遷移到 Windows 容器</a></p>
          </div>]]></content>
      <tags>
        <tag>microservice</tag>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>MissingMethodException</title>
    <url>/2018/11/14/MissingMethodException/</url>
    <content><![CDATA[<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>寫單元測試的時候編譯都沒問題，但在執行時一直報錯 <strong>System.MissingMethodException</strong> 的錯誤，查了一下發現跟 <code>System.Net.Http</code> 有關</p>
<div class="note info">
            <p>System.MissingMethodException with message</p><p>“Method not found: ‘System.Web.Http.Results.ResponseMessageResult</p><p>System.Web.Http.ApiController.ResponseMessage(System.Net.Http.HttpResponseMessage)”</p>
          </div>



<p>檢查測試專案與受測專案的 <code>System.Net.Http</code> Nuget套件皆為同一個版本</p>
<p><img src="/images/20181114/1.png" alt="/images/20181114/1.png"></p>
<p>但意外發現兩個專案的 <code>System.Net.Http</code> 參考卻為不同位置</p>
<p><img src="/images/20181114/2.png" alt="/images/20181114/2.png"></p>
<p><img src="/images/20181114/3.png" alt="/images/20181114/3.png"></p>
<p>照理來說應該都要參考到專案內的 packages 底下才對，檢查 <code>.csproj</code> 裡面的 Reference 並沒有寫錯</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">&quot;System.Net.Http, Version=4.1.1.1, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a, processorArchitecture=MSIL&quot;</span>&gt;</span> 		  </span><br><span class="line"><span class="tag">&lt;<span class="name">HintPath</span>&gt;</span>..\..\packages\System.Net.Http.4.3.2\lib\net46\System.Net.Http.dll<span class="tag">&lt;/<span class="name">HintPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Reference</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>在網路上也搜尋到相關文章討論似乎是 Visual Studio Bug 導致</p>
<p><img src="/images/20181114/4.png" alt="/images/20181114/4.png"></p>
<p>這位仁兄也碰到一樣問題</p>
<ol>
<li><p>他開啟了一個新專案</p>
</li>
<li><p>Nuget 安裝 System.Net.Http v4.3.3 </p>
</li>
<li><p>建置時 System.Net.Http 參考都還是來自於 Package 資料夾底下</p>
</li>
<li><p>Nuget 安裝 System.Collections.Immutable v1.4.0 </p>
</li>
<li><p>建置時 System.Net.Http 參考就跑到 C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\MSBuild\Microsoft\Microsoft.NET.Build.Extensions\net461\lib\System.Net.Http.dll 底下</p>
</li>
</ol>
<div class="note info">
            <p>討論串</p><p><a href="https://github.com/dotnet/corefx/issues/25773">System.Net.Http v4.2.0.0 being copied/loaded from MSBuild tooling</a></p>
          </div>



<h1 id="解決方法"><a href="#解決方法" class="headerlink" title="解決方法"></a>解決方法</h1><p>檢查 Microsoft.NET.Build.Extensions 資料夾底下的 dll 版本為 <code>4.2.0.0</code> ，而 Nuget  System.Net.Http 4.3.2 的 dll 版本則為 <code>4.1.1.1</code> ，這也是間接導致發生此錯誤的原因。</p>
<p>但 Reference HintPath也沒寫錯，VS 裡面也沒辦法調整 dll 位置 ， 最後索性直接刪除 Microsoft.NET.Build.Extensions 資料夾底下的 System.Net.Http ，重新建置後 dll 就重新指向 Package了，此問題得到解決</p>
<p>世界又再一次恢復了和平，!@#$%</p>
<h1 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a>參考文章</h1><ol>
<li><a href="https://stackoverflow.com/questions/46451247/missing-method-in-system-web-http-apicontroller-get-request">MIssing method in System.Web.Http.ApiController.get_Request()</a></li>
<li><a href="https://github.com/dotnet/corefx/issues/22781">System.Net.Http package 4.3.2 - redirect to 4.2.0.0, assembly loading failure</a></li>
</ol>
]]></content>
      <tags>
        <tag>神奇事件</tag>
      </tags>
  </entry>
  <entry>
    <title>LinqToSql ExcuteQuery回傳Binary的問題</title>
    <url>/2015/10/22/LinqToSql-ExcuteQuery%E5%9B%9E%E5%82%B3Binary%E7%9A%84%E5%95%8F%E9%A1%8C/</url>
    <content><![CDATA[<p>最近發現用LinqToSQL的物件模型,使用ExecuteQuery&lt;Binary&gt;的方式執行SQL會回傳<br><span style="color: #666666;">型別’System.Data.Linq.Binary’ 必須宣告預設(無參數)建構涵式,才能在對應時加以建構,</span><br>的問題</p>
<p>實際案例如下:</p>
<ul>
<li><p>先在DB裡建立一個Function ```sql<br>create function [dbo].[fb_CreatePWD]<br>(<br>@Param1 varchar(150)<br>)<br>RETURNS varbinary (150)<br>AS<br>BEGIN<br>DECLARE @ResultVar varbinary(150)<br>select @ResultVar = pwdencrypt(@Param1)</p>
<pre><code>RETURN @ResultVar
</code></pre>
<p>END</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#96;&#96;&#96;sql</span><br><span class="line">&lt;&#x2F;pre&gt;</span><br><span class="line">*   接著在MSSMS上測試是可以正常的[![](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-9so5HU0Hkr0&#x2F;Vih51QjzYZI&#x2F;AAAAAAAAHe8&#x2F;mIYlcdaDToA&#x2F;s1600&#x2F;1.png)](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-9so5HU0Hkr0&#x2F;Vih51QjzYZI&#x2F;AAAAAAAAHe8&#x2F;mIYlcdaDToA&#x2F;s1600&#x2F;1.png)</span><br><span class="line"></span><br><span class="line">*   然後移到LinqToSql的DataContext試試看&#96;&#96;&#96;csharp</span><br><span class="line">var result &#x3D; this.ExecuteQuery&lt;binary&gt;(&quot;select dbo.fn_CreatePWD(&#123;0&#125;)&quot;,&quot;ok&quot;).FirstOrDefault();</span><br><span class="line">&lt;&#x2F;binary&gt;</span><br></pre></td></tr></table></figure>
<p>得到以下錯誤訊息<br>型別 ‘System.Data.Linq.Binary’ 必須宣告預設 (無參數) 建構函式，才能在對應時加以建構<div></p>
</div>

<ul>
<li>  網路上找到有人說用byte[]接可以,所以立馬做一下測試 ```csharp</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;pre class&#x3D;&quot;brush:csharp&quot;&gt;var result &#x3D; this.ExecuteQuery&lt;binary&gt;(&quot;select dbo.fn_CreatePWD(&#123;0&#125;)&quot;,&quot;ok&quot;).FirstOrDefault();</span><br><span class="line">&lt;&#x2F;binary&gt;</span><br></pre></td></tr></table></figure>
<p>結果一樣GG, 型別 ‘System.Byte[]’ 必須宣告預設 (無參數) 建構函式，才能在對應時加以建構。</p>
<p>接著改用Entity Framework 6.0來試試看*   一樣不行<a href="http://3.bp.blogspot.com/-HheTlW-N0t8/Vih8Tpj_LNI/AAAAAAAAHfY/hTgin_0PdxM/s1600/1-1.png"><img src="http://3.bp.blogspot.com/-HheTlW-N0t8/Vih8Tpj_LNI/AAAAAAAAHfY/hTgin_0PdxM/s640/1-1.png"></a></p>
<ul>
<li>  換成Byte[]就可以了！！！<br><a href="http://1.bp.blogspot.com/-0HTZnzzgbo4/Vih9H9jaa4I/AAAAAAAAHfg/UwPi5Fpb8ms/s1600/1.png"><img src="http://1.bp.blogspot.com/-0HTZnzzgbo4/Vih9H9jaa4I/AAAAAAAAHfg/UwPi5Fpb8ms/s1600/1.png"></a><br>所以還是趕快放棄LinqToSql這個被放棄掉的產品,投入Entity Framwork的懷抱吧XD</li>
</ul>
<p>*<br>這邊特別備註一下,如果今天是直接用物件模型將function拉進來,並且直接對xxxDataContext.fn_CreatePWD()操作是可以運作沒問題.</p>
<p>但因為我今天的狀況是在Repository Pattern的情況下,並不會真的對實體做操作,而是全部都對基底類別DataContext做執行,所以沒有這個Method可以使用</p>
<p>我想以上狀況應該是LinqToSql的Bug吧!!網路上也查了滿久的資料,好像沒有人對這塊有比較好的處理方式,如果有再補充上來～</p>
]]></content>
      <tags>
        <tag>C#</tag>
        <tag>Entity Framework</tag>
        <tag>LINQ TO SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】Task WaitAll</title>
    <url>/2018/12/03/Task_WaitAll/</url>
    <content><![CDATA[<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>假設有一項任務，執行時會做三件事情，而這三件事情彼此並沒有相依關係，傳統程式寫法通常都是 1  &gt;  2  &gt; 3 依序呼叫下去做，但這樣有一個問題就是，假設 1 這個任務要執行特別久，那 2、3 都得等 1 做完才能執行到，整體來說效率並沒有最佳化。</p>
<p><img src="/images/20181203/1.png" alt="/images/20181203/1.png"></p>
<p>跑一次需要 2.012 秒完成，如果需要重複 10 次 、100 次，那所需時間會相當可觀。 </p>
<h1 id="非同步版本"><a href="#非同步版本" class="headerlink" title="非同步版本"></a>非同步版本</h1><p>改成非同步版本後，它執行順序就不會被第一步給拖累，三個工作是併行處理</p>
<p><img src="/images/20181203/2.png" alt="/images/20181203/2.png"></p>
<p>但這會有一個問題，如果程式是 Run 在 Console Application 中，因為沒有等待非同步的程式都執行完，就已經跑到 Done ，而導致 Console Application 被關掉，其相應的 Process 也會被停掉，導致有些工作沒有執行完，所以必須要確保所有程式都執行完才關閉的機制在。</p>
<p><img src="/images/20181203/3.png" alt="/images/20181203/3.png"></p>
<h1 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a>參考文章</h1><ol>
<li><a href="https://docs.microsoft.com/zh-tw/dotnet/standard/parallel-programming/task-based-asynchronous-programming">MSDN : 以工作為基礎的非同步程式設計</a></li>
</ol>
]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>VM上網設定</title>
    <url>/2012/10/17/VM%E4%B8%8A%E7%B6%B2%E8%A8%AD%E5%AE%9A/</url>
    <content><![CDATA[<p>連結有詳細介紹!! &nbsp; 終於可以安心在VM裡面開發SharePoint了</p>
<p><a href="http://tw.myblog.yahoo.com/jw!ozeuU_mGAx1rvd0bKga8nQ--/article?mid=434&amp;l=f&amp;fid=25">Windows7中的VMWare網路設定 </a><br><strong>以下是摘錄</strong></p>
<ul>
<li>首先開啟網路共用中心 &gt; 變更介面卡設定 &gt; 找到VMnet1然後記住它的名稱<br><a href="http://3.bp.blogspot.com/-4rwOPHWCWeA/UXiZ97dgMtI/AAAAAAAACkk/55cCcvmWE08/s1600/11.png"><img src="http://3.bp.blogspot.com/-4rwOPHWCWeA/UXiZ97dgMtI/AAAAAAAACkk/55cCcvmWE08/s1600/11.png"></a></li>
<li>  找到目前的連線(此圖為無線網路連線)&gt; 右鍵點選內容 &gt; 切到”共用”頁籤&gt; 然後把共用都打勾並選擇剛剛那個VM的連線與他共享<br><a href="http://2.bp.blogspot.com/-2obanFUgJrw/UXibp8XUfnI/AAAAAAAACk0/QIMQcO2zGQo/s1600/11.png"><img src="http://2.bp.blogspot.com/-2obanFUgJrw/UXibp8XUfnI/AAAAAAAACk0/QIMQcO2zGQo/s1600/11.png"></a></li>
<li>  接著點選VMnet1右鍵 &gt; 內容 &gt; TCP/IPV4 &gt;設定如下<br><a href="http://2.bp.blogspot.com/-QVdsPKPrP6M/UXieOWafJ1I/AAAAAAAAClA/vy_D7FK1m8s/s1600/11.png"><img src="http://2.bp.blogspot.com/-QVdsPKPrP6M/UXieOWafJ1I/AAAAAAAAClA/vy_D7FK1m8s/s1600/11.png"></a></li>
<li>  執行 VMWare 及虛擬系統，例如：Windows XP，開啟虛擬系統的「網蔎連線」，在「區域網路」上按滑鼠右鍵，選擇「內容」<br><a href="http://2.bp.blogspot.com/-KPtz27OW_ho/UXifEuXbtBI/AAAAAAAAClM/wjXQloJ00eo/s1600/UZidjL7joI6_8oXzaY6oCA.jpg"><img src="http://2.bp.blogspot.com/-KPtz27OW_ho/UXifEuXbtBI/AAAAAAAAClM/wjXQloJ00eo/s1600/UZidjL7joI6_8oXzaY6oCA.jpg"></a></li>
<li>  最後在 VMWare 的「VM \ setting」中將「Hardware \ Ethenet」設定為「Host-Only」<br><a href="http://2.bp.blogspot.com/-FFmWeEuVggY/UXifTCLSDUI/AAAAAAAAClU/dDLLKl5RPMY/s1600/MZxveFdaHiBXh4q6vZyrRQ.jpg"><img src="http://2.bp.blogspot.com/-FFmWeEuVggY/UXifTCLSDUI/AAAAAAAAClU/dDLLKl5RPMY/s1600/MZxveFdaHiBXh4q6vZyrRQ.jpg"></a></li>
</ul>
]]></content>
      <tags>
        <tag>VM</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL NOT  EXISTS</title>
    <url>/2013/05/28/SQL-NOT-EXISTS/</url>
    <content><![CDATA[<p><a href="http://frankiestudy.blogspot.tw/2012/01/sql-not-exists.html">參考</a><br><a href="http://msdn.microsoft.com/en-us/library/bb399769.aspx">MSDN</a><br>結論就是，如果單一欄位要篩選掉就用Not IN ```sql<br>select *<br>from [order]<br>where 序號 not in<br>(<br> select 訂單編號 from orderDetail<br>)</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">如果多個欄位要同時符合才篩選掉，就用Not Exists &#96;&#96;&#96;sql</span><br><span class="line">select *</span><br><span class="line">from [order] a</span><br><span class="line">where not exists</span><br><span class="line">(</span><br><span class="line"> select 訂單編號 from orderDetail b </span><br><span class="line"> where b.訂單編號 &#x3D; a.序號 and b.購買日期 &#x3D; (a.民國年+1911) </span><br><span class="line">)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[SQL] 2008 R2 繁體中文版安裝問題</title>
    <url>/2015/03/07/SQL-2008-R2-%E7%B9%81%E9%AB%94%E4%B8%AD%E6%96%87%E7%89%88%E5%AE%89%E8%A3%9D%E5%95%8F%E9%A1%8C/</url>
    <content><![CDATA[<p>如果你作業系統是從英文版安裝與語系版本成為中文版的話,安裝SQL繁體中文版應該會遇到不明的錯誤而停止,上網找了一下資料發現這篇:<br><a href="http://www.dotblogs.com.tw/hunterpo/archive/2010/07/14/16555.aspx">解決 Windows 7 線上更新語言包後安裝 SQL Server 2008 R2 繁體中文版失敗的問題</a></p>
<p>原因是從英文版透過語系包轉成的中文版的作業系統,他是香港繁體中文版,在安裝SQL時預設會去抓3076_ZHH_LP這個資料夾,但繁體中文版的SQL Server的資料夾為1028_CHT_LP。</p>
<p>所以解決方法就是,把全部的光碟內容複製下來,並且將1028_CHT_LP複製一份並且改名為3076_ZHH_LP,用這個資料夾安裝就可以順利完成了</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://1.bp.blogspot.com/-ygIcfJtBNic/VPp9GMAHE0I/AAAAAAAAEgk/oi6kUT_rkfc/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png)](http://1.bp.blogspot.com/-ygIcfJtBNic/VPp9GMAHE0I/AAAAAAAAEgk/oi6kUT_rkfc/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png)</div>]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[Xamarin] Xamarin的奇幻旅程</title>
    <url>/2014/11/13/Xamarin-Xamarin%E7%9A%84%E5%A5%87%E5%B9%BB%E6%97%85%E7%A8%8B/</url>
    <content><![CDATA[<p>最近因為公司需要,開始學習如何用Xamarin開發 IOS,雖然主打用C#開發APP,但無論生命週期跟呼叫的function跟傳統的windows forms或ASP MVC都有相當大的差異性,有很大的一段GAP要跨過就是.</p>
<div>
</div><div>這邊紀錄一下我開發**<u>IOS</u>**時遇到的問題跟心得</div><div>

<ul>
<li><p>  AppDelegate,程式的進入點</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">FinishedLaunching</span>(<span class="params">UIApplication app, NSDictionary options</span>)</span>&#123;    <span class="comment">// 指定APP符合螢幕大小</span></span><br><span class="line">    UIWindow window = <span class="keyword">new</span> UIWindow(UIScreen.MainScreen.Bounds);</span><br><span class="line">    <span class="comment">// 指定APP Root的View,這邊Config.MainStoryboard是我為了避免每次重複一直寫一樣的code</span></span><br><span class="line">    <span class="comment">// 所以把抓取Storyboard的程式碼整合到config,原本應該是UIStoryboard.FromName (&quot;MainStoryboard&quot;, null)</span></span><br><span class="line">    window.RootViewController = Config.MainStoryboard.InstantiateInitialViewController () <span class="keyword">as</span> UIViewController;    <span class="comment">// make  the window visible    window.MakeKeyAndVisible();    return true;&#125;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>  Storyboard,編輯流程的地方,只要把對應的Controller抓進來並且命名,Xamarin Studio會將Class檔案自動建好<br><a href="https://3.bp.blogspot.com/-9PJn6c-W3Ts/VGRjog6fhGI/AAAAAAAAETU/InI72_5d1ic/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-11-13%2B%E4%B8%8B%E5%8D%883.49.30.png"><img src="//3.bp.blogspot.com/-9PJn6c-W3Ts/VGRjog6fhGI/AAAAAAAAETU/InI72_5d1ic/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-11-13+%E4%B8%8B%E5%8D%883.49.30.png"></a></p>
</li>
<li><p>  取得Storyboard裡面的ViewController方法</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">UIStoryboard.FromName (<span class="string">&quot;MainStoryboard&quot;</span>, <span class="literal">null</span>).InstantiateViewController (viewcontroller_name) <span class="keyword">as</span> UIViewController;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>IOS頁面間的流程靠的是對NavigationController的操作,以下是針對NavigationController的一些設定<br><a href="https://1.bp.blogspot.com/-TxRs6fClcdY/VGRmyvmVu2I/AAAAAAAAETo/Tfxc_A_wIbI/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-11-13%2B%E4%B8%8B%E5%8D%884.07.08.png"><img src="//1.bp.blogspot.com/-TxRs6fClcdY/VGRmyvmVu2I/AAAAAAAAETo/Tfxc_A_wIbI/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-11-13+%E4%B8%8B%E5%8D%884.07.08.png"></a>```csharp<br>public override void ViewDidLoad ()<br>{<br> //edit control in viewdidload   //NavigationBar的背景色<br> NavigationController.NavigationBar.BarTintColor = new UIColor(0.58f,0.761f,0.231f,1f);</p>
<pre><code> //字的顏色
</code></pre>
<p> NavigationController.NavigationBar.TitleTextAttributes = new UIStringAttributes (){ ForegroundColor = UIColor.White };   //NavigationBar Button的顏色<br> NavigationController.NavigationBar.TintColor = UIColor.White;   //設定NavigationBar的右邊按鈕為何<br> UIBarButtonItem barOptionIcon = new UIBarButtonItem (UIImage.FromBundle (“icon-options”),   UIBarButtonItemStyle.Plain,<br> (sender, args) =&gt;   {      // button clicked      NavigationController.PushViewController(Config.GetStoryboardViewController(“OptionViewController”),true);   });<br> NavigationController.NavigationBar.TopItem.SetRightBarButtonItem (barOptionIcon,true); //OptionIcon<br>}</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   IOS抓取對應圖片的方式</span><br><span class="line">[![](&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-yKVU6385RPk&#x2F;VGRo5f3lZII&#x2F;AAAAAAAAET0&#x2F;Kz-_aQWVyLA&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-11-13%2B%E4%B8%8B%E5%8D%884.15.59.png)](https:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-yKVU6385RPk&#x2F;VGRo5f3lZII&#x2F;AAAAAAAAET0&#x2F;Kz-_aQWVyLA&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-11-13%2B%E4%B8%8B%E5%8D%884.15.59.png)&#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;FromBundle的方式IOS會自動對應不同的裝置抓取預備好給他的圖</span><br><span class="line">&#x2F;&#x2F;圖片檔名命名方式&#x2F;&#x2F;[imageName]~iphone.png</span><br><span class="line">&#x2F;&#x2F;[imageName]~ipad.png</span><br><span class="line">&#x2F;&#x2F;[imageName]@2~ipad.png for retina顯示器</span><br><span class="line">UIImage.FromBundle (&quot;icon-options&quot;);</span><br><span class="line">&#x2F;&#x2F;FromFile不管任何解析度都是用這張來顯示,所以用前者的方式較佳</span><br><span class="line">UIImage.FromFile (&quot;icon-options.png&quot;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>TableViewController的製作方式<br><a href="https://3.bp.blogspot.com/-nNrQN2hVNpo/VGRpYjLlK6I/AAAAAAAAET8/y5EArWC4Fc8/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2014-11-13%2B%E4%B8%8B%E5%8D%884.17.57.png"><img src="//3.bp.blogspot.com/-nNrQN2hVNpo/VGRpYjLlK6I/AAAAAAAAET8/y5EArWC4Fc8/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7+2014-11-13+%E4%B8%8B%E5%8D%884.17.57.png"></a>```csharp<br>//製作TableSource的Class<br>public class TableSource : UITableViewSource<br>{<br> string cellIdentifier = “OptionsTableCell”;<br> public List<tablecell> TABLE_ITEMS{ get; set;} //每列資料   public event EventHandler<tablerowselectedeventargs> Cell_RowSelected;//給外層cell click事件</p>
<pre><code> public TableSource ()
</code></pre>
<p> {</p>
<pre><code>TABLE_ITEMS = new List&lt;tablecell&gt; ();
</code></pre>
<p> }</p>
<pre><code> public override nint RowsInSection (UITableView tableview, nint section)
</code></pre>
<p> {</p>
<pre><code>return TABLE_ITEMS.Count;
</code></pre>
<p> }</p>
<pre><code> public override UITableViewCell GetCell (UITableView tableView, Foundation.NSIndexPath indexPath)
</code></pre>
<p> {</p>
<pre><code>UITableViewCell cell = tableView.DequeueReusableCell (cellIdentifier);

    //if there are no cells to reuse , cerate a new one
if (cell == null) cell = new UITableViewCell (UITableViewCellStyle.Default, cellIdentifier);

    cell.TextLabel.Text = TABLE_ITEMS [indexPath.Row].TITLE;
cell.TextLabel.Font = UIFont.SystemFontOfSize(15f);
cell.TextLabel.TextColor = new UIColor (0.453f, 0.453f, 0.453f, 1);
cell.ImageView.Image = UIImage.FromBundle (TABLE_ITEMS[indexPath.Row].IMAGE); //cell front Image
cell.Accessory = UITableViewCellAccessory.DisclosureIndicator;
return cell;
</code></pre>
<p>  }</p>
<pre><code>  public override void RowSelected (UITableView tableView, Foundation.NSIndexPath indexPath)
</code></pre>
<p>  {<br>//把值拋到OptionViewController的Cell_RowSelected的事件<br>if (Cell_RowSelected != null)         Cell_RowSelected(this,new TableRowSelectedEventArgs(){ indexPath = indexPath});<br>tableView.DeselectRow (indexPath, true); //cancel select row style<br>  }<br>}<br></tablecell></tablerowselectedeventargs></tablecell></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;製作TableSource的Class</span><br><span class="line">public class TableSource : UITableViewSource</span><br><span class="line">&#123;</span><br><span class="line">   string cellIdentifier &#x3D; &quot;OptionsTableCell&quot;;</span><br><span class="line">   public List&lt;tablecell&gt; TABLE_ITEMS&#123; get; set;&#125; &#x2F;&#x2F;每列資料   public event EventHandler&lt;tablerowselectedeventargs&gt; Cell_RowSelected;&#x2F;&#x2F;給外層cell click事件</span><br><span class="line"></span><br><span class="line">       public TableSource ()</span><br><span class="line">   &#123;</span><br><span class="line">      TABLE_ITEMS &#x3D; new List&lt;tablecell&gt; ();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">       public override nint RowsInSection (UITableView tableview, nint section)</span><br><span class="line">   &#123;</span><br><span class="line">      return TABLE_ITEMS.Count;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">       public override UITableViewCell GetCell (UITableView tableView, Foundation.NSIndexPath indexPath)</span><br><span class="line">   &#123;</span><br><span class="line">      UITableViewCell cell &#x3D; tableView.DequeueReusableCell (cellIdentifier);</span><br><span class="line"></span><br><span class="line">          &#x2F;&#x2F;if there are no cells to reuse , cerate a new one</span><br><span class="line">      if (cell &#x3D;&#x3D; null) cell &#x3D; new UITableViewCell (UITableViewCellStyle.Default, cellIdentifier);</span><br><span class="line"></span><br><span class="line">          cell.TextLabel.Text &#x3D; TABLE_ITEMS [indexPath.Row].TITLE;</span><br><span class="line">      cell.TextLabel.Font &#x3D; UIFont.SystemFontOfSize(15f);</span><br><span class="line">      cell.TextLabel.TextColor &#x3D; new UIColor (0.453f, 0.453f, 0.453f, 1);</span><br><span class="line">      cell.ImageView.Image &#x3D; UIImage.FromBundle (TABLE_ITEMS[indexPath.Row].IMAGE); &#x2F;&#x2F;cell front Image</span><br><span class="line">      cell.Accessory &#x3D; UITableViewCellAccessory.DisclosureIndicator;</span><br><span class="line">      return cell;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        public override void RowSelected (UITableView tableView, Foundation.NSIndexPath indexPath)</span><br><span class="line">    &#123;</span><br><span class="line"> &#x2F;&#x2F;把值拋到OptionViewController的Cell_RowSelected的事件</span><br><span class="line"> if (Cell_RowSelected !&#x3D; null)         Cell_RowSelected(this,new TableRowSelectedEventArgs()&#123; indexPath &#x3D; indexPath&#125;);</span><br><span class="line"> tableView.DeselectRow (indexPath, true); &#x2F;&#x2F;cancel select row style</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Table Cell Classpublic class TableCell&#123;   public string TITLE &#123; get; set; &#125; //標題   public string IMAGE &#123; get; set;&#125; //圖片   public TableCell () &#123; &#125;</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">TableCell</span> (<span class="params"><span class="built_in">string</span> title , <span class="built_in">string</span> image</span>)</span>   &#123;      TITLE = title; IMAGE = image;   &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>然後在ViewController這麼做  ```csharp<br>public OptionViewController (IntPtr handle) : base (handle){   _tableview = SetTable ();   this.Add (_tableview); //把Table加進去View裡面}/// <summary>/// Set Table Data/// </summary>/// <returns>The table.</returns>private UITableView SetTable(){   UITableView tv = new UITableView (View.Bounds);   TableSource _source = new TableSource ();   List<tablecell> celllist = new List<tablecell> ();   //將options的menu選項加進table cell裡面   foreach (Options item in Enum.GetValues(typeof(Options)))   {      string[] descript = Tools.GetEnumDescription (item).Split(new String[]{“;”},      StringSplitOptions.RemoveEmptyEntries);</p>
<pre><code>    celllist.Add(new TableCell (descript[0], descript[1]));//標題;圖片    &#125;    _source.TABLE_ITEMS = celllist; tv.Source = _source;    //cell click觸發的事件    _source.Cell_RowSelected += (object sender, TableRowSelectedEventArgs e) =&amp;gt;    &#123;       switch ((Options)e.indexPath.Row)       &#123;          case Options.BuildAge:NavigationController.PushViewController(Config.GetStoryboardViewController(&quot;Options_BuildAgeViewController&quot;),true);       break;       &#125;
</code></pre>
<p>   };     return tv;}</p>
</li>
</ul>
<p>```</p>
</div>]]></content>
      <tags>
        <tag>Xamarin</tag>
      </tags>
  </entry>
  <entry>
    <title>【AWS】EC2 can&#39;t access metadata service</title>
    <url>/2019/04/30/aws_windows_ec2_cant_access_metadata/</url>
    <content><![CDATA[<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>EC2 上的 windows VM 突然無法存取相對應的 AWS 服務，而這些權限原本都是透過 IAM Role 賦予的，之前文章有提過 AWS 機器是如何透過 IAM Role 得知自己有哪些權限</p>
<div class="note info">
            <p><a href="/2019/02/19/windows_contianer_iamrole_/">Windows IAM Role 問題</a></p>
          </div>

<p>在該機器呼叫 metadata service 會回應錯誤</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl 169.254.169.254</span></span><br></pre></td></tr></table></figure>

<p>詢問對 AWS 比較熟的一些同事，聽說在 windows server 2012 版本之後，更換 Instance Type 重新開機時會發生</p>
<br>

<h1 id="解決方法"><a href="#解決方法" class="headerlink" title="解決方法"></a>解決方法</h1><p>執行 C:\ProgramData\Amazon\EC2-Windows\Launch\Scripts\InitializeInstance.ps1 ，它會重新 Binding 一些相關設定，執行完後就好了</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://stackoverflow.com/questions/45095261/aws-ec2-windows-10-cant-access-metadata">[Stackoverflow] AWS EC2 Windows 10 can’t access metadata</a></p>
          </div>]]></content>
      <tags>
        <tag>aws</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】 關於 Async 的三兩事</title>
    <url>/2020/09/19/about_async/</url>
    <content><![CDATA[<p>說來真的好久沒有寫文章了，除了工作很忙之外，目前碰到的問題也通常不是一兩篇文章可以交代的清，所以也就更新部落格的時間也就間隔越來越長了。</p>
<p>這次主要是想把最近針對 Async 的一些測試研究記錄下來，那我們就開始吧 ！</p>
<h1 id="Async-是什麼？"><a href="#Async-是什麼？" class="headerlink" title="# Async 是什麼？"></a># Async 是什麼？</h1><p>Async 在 C# 語言中用來支援非同步處理的一種語法，而它的使用往往搭配 Await 一起使用，先來看看一段簡單的程式碼</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;1. Hi I&#x27;m Async Demo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拿到非同步的任務</span></span><br><span class="line">    <span class="keyword">var</span> task = DoAsync();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//繼續執行</span></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;2. Hello World!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//等待非同步任務執行完成</span></span><br><span class="line">    <span class="keyword">await</span> task;</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;4. End!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">DoAsync</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="comment">//碰到 await 時，會將控制項回傳給呼叫端，並且等待非同步的方法執行完成</span></span><br><span class="line">    <span class="keyword">await</span> Task.Run(()=&gt; </span><br><span class="line">                   &#123;</span><br><span class="line">                     Thread.Sleep(TimeSpan.FromSeconds(<span class="number">5</span>));</span><br><span class="line">                     Console.WriteLine(<span class="string">$&quot;3. Async method Done&quot;</span>);</span><br><span class="line">                   &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這段程式碼執行後可以看到以下結果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">1. Hi I&#39;m Async Demo</span><br><span class="line">2. Hello World!</span><br><span class="line">3. Async method Done</span><br><span class="line">4. End!</span><br></pre></td></tr></table></figure>



<h2 id="觀察執行緒的切換"><a href="#觀察執行緒的切換" class="headerlink" title="觀察執行緒的切換"></a>觀察執行緒的切換</h2><p>接著加上執行緒 Id 看看，讓我們更清楚執行緒之間是如何切換的</p>
<p><img src="/images/20200919/1.png" alt="/images/20200919/1.png"></p>
<p>執行結果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[1] 1. Hi I&#39;m Async Demo</span><br><span class="line">[1] 2. Hello World!</span><br><span class="line">[4] 3. Async method Done</span><br><span class="line">[4] 4. End!</span><br></pre></td></tr></table></figure>



<p><strong>執行流程</strong></p>
<ul>
<li><p><strong>執行緒_1</strong> 在 11 行印出了 <code>[1] 1. Hi I&#39;m Async Demo</code></p>
</li>
<li><p><strong>執行緒_1</strong> 在 14 行進入了 DoAsync 的方法中</p>
</li>
<li><p><strong>執行緒_1</strong> 在 27 行碰到 Task.Run 開啟了非同步執行的方法，並因為 await 跳出了這個 DoAsync() </p>
</li>
<li><p><strong>執行緒_1</strong> 在 16 行碰到印出了 <code>[1] 2. Hello World!</code></p>
</li>
<li><p><strong>執行緒_1</strong> 在 19 行碰到 await task ，開始等待 task 執行完成，<strong>執行緒_1</strong> 釋放回到 Thread Pool</p>
</li>
<li><p><strong>執行緒_4</strong> 在非同步方法的第 30 行 印出了 <code>[4] 3. Async method Done</code> ，並通知 await task 執行完成</p>
</li>
<li><p>TaskScheduler（通常，這會是以執行緒集區為目標的預設工作排程器）依據最有效率的判斷，讓 <strong>執行緒_4</strong> 往下執行未完的部分</p>
</li>
<li><p><strong>執行緒_4</strong> 接手繼續將 await 之後還沒做完的工作執行完成，意即 21 行，印出 <code>[4] 4. End!</code></p>
</li>
</ul>
<h2 id="稍微修改一下程式…"><a href="#稍微修改一下程式…" class="headerlink" title="稍微修改一下程式…"></a>稍微修改一下程式…</h2><figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;[<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>] 1. Hi I&#x27;m Async Demo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//強制將非同步方法改成同步</span></span><br><span class="line">    DoAsync().Wait();</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;[<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>] 2. Hello World!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;[<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>] 4. End!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">DoAsync</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="comment">//碰到 await 時，會將控制項回傳給呼叫端，並且等待非同步的方法執行完成</span></span><br><span class="line">    <span class="keyword">await</span> Task.Run(()=&gt; </span><br><span class="line">                   &#123;</span><br><span class="line">                     Thread.Sleep(TimeSpan.FromSeconds(<span class="number">5</span>));</span><br><span class="line">                     Console.WriteLine(<span class="string">$&quot;[<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>] 3. Async method Done&quot;</span>);</span><br><span class="line">                   &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>執行結果</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[1] 1. Hi I&#39;m Async Demo</span><br><span class="line">[4] 3. Async method Done</span><br><span class="line">[1] 2. Hello World!</span><br><span class="line">[1] 4. End!</span><br></pre></td></tr></table></figure>

<p>這邊可以看到 <strong>執行緒_1</strong> 在執行到 await Task.Run(()=&gt; …) 時跳出，但因為我們下了 Wait()，所以強迫 <strong>執行緒_1</strong> 進行同步的等待。</p>
<p><strong>執行緒_4</strong> 印完 <code>[4] 3. Async method Done</code> 後，通知 <strong>執行緒_1</strong> 繼續往下進行，所以看到 <strong>執行緒_1</strong>  接著將剩下的程式跑完</p>
<h2 id="差別在哪？"><a href="#差別在哪？" class="headerlink" title="差別在哪？"></a>差別在哪？</h2><p>當呼叫非同步執行方法時，如果一路都是用 await 並不會造成任何執行緒被封鎖，換言之該執行緒還可以在別的地方繼續服務，一旦呼叫了 <strong>Result</strong> 或 <strong>Wait()</strong> 這類的強制同步方法，則該執行緒會被封鎖，並等待到非同步方法執行完成後才繼續完成尚未完成的後續工作，這會嚴重消耗執行緒的使用效率。</p>
<p>我曾經對一個 Web API 專案進行壓測，在資源給得非常有限的情境下 (約 0.5 core cpu)，<code>await 搭配 Task.Run()</code> 跟 <code>Result 搭配 Task.Run</code> ，兩個 RPS 測起來差了快一倍之多，在資源極度有限下，執行緒的使用效率將大大影響整體服務的效率。</p>
<h1 id="SynchronizationContext"><a href="#SynchronizationContext" class="headerlink" title="# SynchronizationContext"></a># SynchronizationContext</h1><p>SynchronizationContext 是用來記錄當前執行緒環境的類別，在 ASP.NET、WPF、WinForm 都有類似的類別只是名字可能有些差異，其最主要的目的都是在非同步方法中要能調用 UI 執行緒來更新介面之類的操作，而 SynchronizationContext 就紀錄著 UI 執行緒。</p>
<h2 id="Deadlock"><a href="#Deadlock" class="headerlink" title="Deadlock"></a>Deadlock</h2><p>過去寫 ASP.NET 的時候曾經踩過一次  SynchronizationContext 的雷，在 ASP.NET 中如果如果呼叫 <code>SynchronizationContext.Currnt</code> 會發現並不為 Null，且型別是 <code>AspNetSynchronizationContext</code> ，當我們用上述的 <code>Result / Wait() 搭配 await</code> 將會導致 Deadlock。</p>
<p>原因是程式碰到 await 時會先判斷 SynchronizationContext.Currnt 是否為 Null，如果是則會在 Task 結束時呼叫 TaskScheduler （通常為 Thread Pool）來安排後續工作。反之，如果 SynchronizationContext.Currnt 不為 Null 時，就會透過 SynchronizationContext.Currnt 來繼續後續的動作。</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="comment">//碰到 await 時，記住了 SynchronizationContext.Currnt</span></span><br><span class="line"><span class="keyword">await</span> Task.Run(()=&gt; </span><br><span class="line">               &#123;</span><br><span class="line">                 Thread.Sleep(TimeSpan.FromSeconds(<span class="number">5</span>));</span><br><span class="line">                 Console.WriteLine(<span class="string">$&quot;[<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>] 3. Async method Done&quot;</span>);</span><br><span class="line">               &#125;);</span><br></pre></td></tr></table></figure>

<p>而 .Result / Wait() 的方法會封鎖住 SynchronizationContext.Currnt，造成兩邊互等的情況發生，產生了 Deadlock</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line">DoAsync().Wait(); <span class="comment">//封鎖 SynchronizationContext.Currnt 的物件等待 Task 完成</span></span><br></pre></td></tr></table></figure>

<p>而這只會發生在 SynchronizationContext.Currnt 不為 Null 的系統中，像是前述提到的 ASP.NET、WPF、WinForm，在 Console Application 並不會發生。</p>
<h2 id="解決方法-ConfigureAwait-false"><a href="#解決方法-ConfigureAwait-false" class="headerlink" title="解決方法 ConfigureAwait(false)"></a>解決方法 ConfigureAwait(false)</h2><p>如果要避免上述所提到的 Deadlock ，可以在呼叫非同步方法時加上 ConfigureAwait(false)，這樣非同工作完成時就會透過另一條執行緒繼續完成後續工作</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> Task.Run(()=&gt; </span><br><span class="line">          &#123;</span><br><span class="line">              ....</span><br><span class="line">          &#125;).ConfigureAwait(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>



<h2 id="在-ASP-Net-Core-的時代…"><a href="#在-ASP-Net-Core-的時代…" class="headerlink" title="在 ASP.Net Core 的時代…"></a>在 ASP.Net Core 的時代…</h2><p>在 ASP.Net core 呼叫 SynchronizationContext.Current 現在只會得到 Null ，換言之剛剛發生 deadlock 的情境已經不會發生，所以過往在非同步的地方常常要用 ConfigureAwait(false) 可以不用寫了，不過如果你是寫元件或 SDK 類的，並無法預測會被使用在怎樣的環境的話，建議還是都加上會比較保險。</p>
<h1 id="Best-Practice"><a href="#Best-Practice" class="headerlink" title="# Best Practice"></a># Best Practice</h1><p>在使用 Async / await 等非同步技巧時，最好的方式還是都盡量使用非阻斷式的寫法 await ，避免使用 Result / Wait() ，即使你已經是寫 ASP.Net core 不會發生 Deadlock 的情況，阻斷式的寫法對於執行緒的使用效率來說還是會有影響的。</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://docs.microsoft.com/zh-tw/dotnet/standard/asynchronous-programming-patterns/consuming-the-task-based-asynchronous-pattern">使用以工作為基礎的非同步模式</a></p><p><a href="https://blog.stephencleary.com/2017/03/aspnetcore-synchronization-context.html">ASP.NET Core SynchronizationContext</a></p><p><a href="https://devblogs.microsoft.com/dotnet/configureawait-faq/">ConfigureAwait FAQ</a></p><p><a href="https://www.huanlintalk.com/2016/01/asyc-deadlock-in-aspbet.html">.NET 程式鎖死與 SynchronizationContext</a></p><p><a href="https://www.cnblogs.com/lzxianren/p/SynchronizationContext.html">搞懂 SynchronizationContext（第一部分)</a></p>
          </div>]]></content>
      <tags>
        <tag>Async</tag>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>AsyncLocal and ThreadLocal</title>
    <url>/2020/01/22/aynclocal_threadlocal/</url>
    <content><![CDATA[<h1 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h1><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">ThreadLocal</span>&lt;<span class="title">string</span>&gt; LocalString</span> = <span class="keyword">new</span> ThreadLocal&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LocalString.Value = <span class="string">&quot;Value 1&quot;</span>;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【A】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> t1 = AsyncMethod();</span><br><span class="line"></span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【D】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">await</span> t1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">AsyncMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【B】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	LocalString.Value = <span class="string">&quot;Value 3&quot;</span>;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【C】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">await</span> Task.Delay(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【E】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//【A】 Thread: 14, ExcutionContext: 37151951 ,value: Value 1</span></span><br><span class="line"><span class="comment">//【B】 Thread: 14, ExcutionContext: 51676517 ,value: Value 1</span></span><br><span class="line"><span class="comment">//【C】 Thread: 14, ExcutionContext: 51676517 ,value: Value 3</span></span><br><span class="line"><span class="comment">//【D】 Thread: 14, ExcutionContext: 37151951 ,value: Value 3</span></span><br><span class="line"><span class="comment">//【E】 Thread: 16, ExcutionContext: 46128400 ,value: </span></span><br></pre></td></tr></table></figure>

<p>ThreadLocal 非常容易理解, 每個 Thread 之間彼此是隔離的, 即便 ExcutionContext 不同, 但只要是同一個 Thread 都會是共用的。</p>
<p>所以可以看到 await 之後, 因為不同 Thread 執行剩下的 Code , ThreadLocal 的值就變成預設的空值</p>
<br>

<h1 id="AsyncLocal"><a href="#AsyncLocal" class="headerlink" title="AsyncLocal"></a>AsyncLocal</h1><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">AsyncLocal</span>&lt;<span class="title">string</span>&gt; LocalString</span> = <span class="keyword">new</span> AsyncLocal&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LocalString.Value = <span class="string">&quot;Value 1&quot;</span>;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【A】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> t1 = AsyncMethod();</span><br><span class="line"></span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【D】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">await</span> t1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">AsyncMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【B】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	LocalString.Value = <span class="string">&quot;Value 3&quot;</span>;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【C】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">await</span> Task.Delay(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【E】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//【A】 Thread: 14, ExcutionContext: 5705933 ,value: Value 1</span></span><br><span class="line"><span class="comment">//【B】 Thread: 14, ExcutionContext: 12517624 ,value: Value 1</span></span><br><span class="line"><span class="comment">//【C】 Thread: 14, ExcutionContext: 12517624 ,value: Value 3</span></span><br><span class="line"><span class="comment">//【D】 Thread: 14, ExcutionContext: 5705933 ,value: Value 1</span></span><br><span class="line"><span class="comment">//【E】 Thread: 8, ExcutionContext: 35765882 ,value: Value 3</span></span><br></pre></td></tr></table></figure>

<p>AsyncLocal 會在每次需要切出 ExcutionContext 時複製一份給新的 ExcutionContext , 所以每個 ExcutionContext間的 AsyncLocal 都是獨立的，但同時可達跨 Thread , ExcutionContext 往下傳遞的特性。</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://www.cnblogs.com/zkweb/p/7747162.html">AsyncLocal的运作机制和陷阱</a></p><p><a href="https://www.cnblogs.com/tcjiaan/p/5007737.html">【.NET深呼吸】基於異步上下文的本地變量（AsyncLocal）</a></p><p><a href="https://docs.microsoft.com/zh-tw/dotnet/api/system.threading.executioncontext?view=netframework-4.8">ExecutionContext 類別</a></p>
          </div>]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>將程式編譯成 x86、x64、Any CPU差別在哪</title>
    <url>/2019/02/12/anycpu_x86_x64/</url>
    <content><![CDATA[<p>相信用過 Visual Studio 的應該都注意過編譯時可以選擇 Any CPU、x86、x64 (x86、x64 需要編輯組態檔才會看的到)</p>
<p><img src="/images/20190212/1.png" alt="/images/20190212/1.png"></p>
<p>這次踩到問題是，明明程式用 Any CPU 來編譯，但在 64 bit OS 上卻會用 32 bit  Process 來執行</p>
<p><img src="/images/20190212/2.png" alt="/images/20190212/2.png"></p>
<p>原來是因為專案建置的屬性勾到了 <code>建議使用32位元</code>的選項導致</p>
<p><img src="/images/20190212/3.png" alt="/images/20190212/3.png"></p>
<p>解決的同時也引起了對於編譯成 x86、x64、Any CPU 有什麼差別的好奇心，找了文章後整理如下</p>
<br>

<h1 id="差異"><a href="#差異" class="headerlink" title="差異"></a>差異</h1><br>

<h2 id="在-32-bit-OS-上執行"><a href="#在-32-bit-OS-上執行" class="headerlink" title="在 32 bit OS 上執行"></a>在 32 bit OS 上執行</h2><p><strong>Any CPU</strong> : 會用 32 bit Process 來執行，可以載入 Any CPU 和 x86 方式編譯的組件，但如果載入 x64 編譯的組件將會引發 BadImageFormatException </p>
<p><strong>Any CPU (勾選建議使用32位元)</strong> : 運作方式同上</p>
<p><strong>x86</strong> : 運作方式同上</p>
<p><strong>x64</strong> : 引發 BadImageFormatException</p>
<br>

<h2 id="在-64-bit-OS-上執行"><a href="#在-64-bit-OS-上執行" class="headerlink" title="在 64 bit OS 上執行"></a>在 64 bit OS 上執行</h2><p><strong>Any CPU</strong> : 會用 64 bit Process 來執行，可以載入 Any CPU 和 x64 方式編譯的組件，但如果載入 x86 編譯的組件將會引發 BadImageFormatException</p>
<p><strong>Any CPU (勾選建議使用32位元)</strong> : 會用 32 bit Process 來執行，可以載入 Any CPU 和 <code>x86</code> 方式編譯的組件，但如果載入 x64 編譯的組件將會引發 BadImageFormatException</p>
<p><strong>x86</strong> : 運作方式同 <strong>Any CPU (勾選建議使用32位元)</strong></p>
<p><strong>x64</strong> : 運作方式同 <strong>Any CPU</strong>  </p>
<br>

<h2 id="Machine-Config"><a href="#Machine-Config" class="headerlink" title="Machine Config"></a>Machine Config</h2><p>依據執行的 Process 位元決定</p>
<p>32 bit Process 吃的 Machine Config 位置 : C:\Windows\Microsoft.NET\ <code>Framework</code> \v4.0.30319\Config</p>
<p>64 bit Process 吃的 Machine Config 位置 : C:\Windows\Microsoft.NET\ <code>Framework64</code> \v4.0.30319\Config</p>
<br>

<h1 id="怎麼查是用哪種方式編譯的"><a href="#怎麼查是用哪種方式編譯的" class="headerlink" title="怎麼查是用哪種方式編譯的?"></a>怎麼查是用哪種方式編譯的?</h1><p>可以透過 <code>CorFlags.exe</code> 的工具來查詢，該程式放在 <code>C:\Program Files (x86)\Microsoft SDKs\Windows\v8.1A\bin\NETFX 4.5.1 Tools</code> 路徑底下，設定為環境變數後就可以用 command 來檢視 PE </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ corflags yourPE.exe</span><br></pre></td></tr></table></figure>

<div class="note info">
            <p>PE : Process Executables (EXEs and DLLs)</p>
          </div>

<p><img src="/images/20190212/4.png" alt="/images/20190212/4.png"></p>
<p>意義如下</p>
<p><img src="/images/20190212/5.png" alt="/images/20190212/5.png"></p>
<p>(圖片節錄至 : <a href="https://stackoverflow.com/questions/18608785/how-to-interpret-the-corflags-flags/23614024#23614024">https://stackoverflow.com/questions/18608785/how-to-interpret-the-corflags-flags/23614024#23614024</a>)</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://blog.darkthread.net/blog/corflags/">【茶包射手日記】檢查.NET程式平台目標(Platform Target)</a></p><p><a href="https://www.codeproject.com/Articles/1160645/Dealing-with-bit-bit-and-Any-CPU-Compilation-Optio">Dealing with 32-bit, 64-bit and Any CPU Compilation Options in .NET</a></p><p><a href="https://stackoverflow.com/questions/18608785/how-to-interpret-the-corflags-flags">How to interpret the CorFlags flags?</a></p>
          </div>]]></content>
      <tags>
        <tag>.Net</tag>
      </tags>
  </entry>
  <entry>
    <title>[讀書心得][領域驅動設計與 .Net Core] Chapter1: 為什麼需要領域驅動設計</title>
    <url>/2022/05/23/book_hands_on_ddd_with_dotnet/</url>
    <content><![CDATA[<p><img src="/images/20220523/cover.jpg" alt="/images/20220523/cover.jpg"><br>圖片來源: <a href="https://www.tenlong.com.tw/products/9789864348602">https://www.tenlong.com.tw/products/9789864348602</a></p>
<p>第一章講述了軟體發展史中，為了解決軟體開發上的困境許多方法被發明了出來，而雖然每個方法都宣稱能有效解決（或部分解決）專案上的問題，但經過統計，成功的專案始終不超過 22%。而 DDD 也是為了解決軟體開發時所碰到的困境所被提出來的一種方法。</p>
<p>軟體通常是為了解決某些問題而被研發的，所以當<code>錯誤的理解問題</code>就很容易導致失敗，人類在解決問題上有著豐富的經驗，所以當人類看到問題時，通常會有一些<code>直覺的解決方案</code>浮出腦中（快思慢想也有提到這點），這可能源自於你的經驗或是過往學經歷，而這<code>直覺的好點子</code>很高的可能是錯誤的方向，而人往往又會傾向於找盡各種方法試圖說服自己<code>剛剛的好點子</code>是正確的，即便在實作的過程中隱約察覺到不對勁了…</p>
<div class="note info">
            <p>個人經驗中有察覺到這個現象，常常誤以為自己一開始的想法是正確的，所以即便過程中發現問題也會用各種變形方法試圖將問題套入其中，而這往往會將問題變得更複雜。</p><p>我曾經跟專案成員討論目前框架使用上的困境，而我發現大部分人會傾向在框架中設計各種 Config 、環境變數切換來滿足所謂的特殊情境，而沒有去思考框架設計是否瞄準錯了問題。又或是為了解決部署環境問題，直接聯想到 Container 解決方案，結果為了管理 Container 所以引入更複雜的 k8s 做為編排的工具，也許本質想解決的問題沒這麼複雜，卻在解決的過程中意外的把問題變得更複雜。</p>
          </div>

<h2 id="避免無知"><a href="#避免無知" class="headerlink" title="避免無知"></a>避免無知</h2><p>書本中將無知分類成五個層級</p>
<ul>
<li>缺少無知(lack of ignorance) : 表示你擁有大部分的知識，知道「該做什麼」、「怎麼做」</li>
<li>缺乏知識(lack of knowledge) : 你意識到自己的無知，所以你獲取更多知識來填補知識的落差</li>
<li>缺乏意識(lack of awareness) : 「不知道自己不知道」，連意識到無知都沒有，例如拿到規格就覺得自己知道要解決的問題是什麼了，而忽略了其實自己根本不知道本質問題是什麼狀況，人往往會做出錯誤決策都屬這層</li>
<li>缺乏流程(lack of process) : 你不知道你自己不知道是什麼，也無管道能弄清楚</li>
<li>元無知(meta igonorance) : 連無知的五個層次都不知道 </li>
</ul>
<p>DDD 之父 Eric Evans 對於「提前設計」提出了見解 : 我們在專案的初期會進行提前設計的動作，而此時恰好也是我們擁有「最少知識」並且是最無知的時期。在專案開始時幾乎沒有知識的情況下，就對軟體的設計和架構做出大多數的「重要決策」，這不會是個好的做法。</p>
<div class="note info">
            <p>個人覺得這跟敏捷中提到的小增量多迭代道理是一樣的，我們很難在專案初期就了解問題的全貌，所以小步前進，並且因應碰到的問題即時快速的調整，才能讓我們越來越貼近真實情況的樣貌，也可以降低在專案初期的過度設計，導致架構一直調整的窘境。</p>
          </div>

<p>隨著現代專案要處理的問題越來越複雜（可能是質或是量的複雜度），有效的處理<code>領域知識</code>、<code>減少無知</code>，準確將問題分類，避免實現目標路途中的認知偏誤，DDD 就是想要解決這些問題所被提出的。</p>
]]></content>
      <categories>
        <category>領域驅動設計與.Net Core</category>
      </categories>
      <tags>
        <tag>DDD</tag>
        <tag>讀書心得</tag>
        <tag>領域驅動設計與 .Net Core</tag>
      </tags>
  </entry>
  <entry>
    <title>[讀書心得][領域驅動設計與 .Net Core] Chapter2: 語言與情境</title>
    <url>/2022/05/25/book_hands_on_ddd_with_dotnet_ch2/</url>
    <content><![CDATA[<h2 id="建立共同語言"><a href="#建立共同語言" class="headerlink" title="建立共同語言"></a>建立共同語言</h2><p>這章主是在講述語言的重要性，而語言又如何直接間接的影響到系統的成敗。這邊的語言並非指程式語言，而是指在相同情境下大家所共同理解的語言，就用 <code>User</code> 這個詞來舉例，在不同情境下就可能代表著不同意義</p>
<ul>
<li>對購物網站而言 : User 可能代表的是逛商城的<em>消費者</em></li>
<li>對商城平台而言 : User 可能代表是<em>進駐的廠商</em></li>
<li>對商城後台而言 : User 可能代表的是<em>進駐廠商的員工</em></li>
</ul>
<p>一個 User 在各個情境下代表著不同意義，想關注的事情也不盡相同，當我們沒有情境為背景下，單單用 User 做為溝通可能會陷入雞同鴨講的狀況，這就是情境之於語言為何重要的地方。</p>
<div class="note info">
            <p>過去開會時發現一個現象，時常開發單位與需求單位在溝通時，彼此對於同一個東西用的詞是完全不同的，當需求單位在描述事情時，較新進或對 Domain 不熟的開發人員可能會弄不清楚對方在說什麼，這時候就需要熟的人在旁邊補充「他指的是系統裡的 xxx」，而會產生這樣的差距，常常是因為開發人員將他們的工作視為”將需求翻譯成程式語言”，所以程式內的語言可能自成一格，並與現實用語脫鉤，而這類的情況一多，當不同背景的人共同溝通時就會需要彼此一直翻譯，翻譯的狀況越多，中間遺失掉的”知識”可能就越多，大家應該都有看過翻譯很爛的書的經驗吧…</p>
          </div>

<p>所以書中建議為不同背景的人找尋共同用語相當重要，這可以減少溝通時因為翻譯而導致的落差，書中舉了一個很真實的案例：當使用者在廣告系統中發佈 (publish) 廣告時，為了避免帶有惡意或不適當的內容，會讓該廣告進入審核的流程 ….，而當這個需求轉化為程式語言後可能會變成</p>
<ul>
<li>當使用者按下 publish 按鈕時，將廣告狀態更新為 Published，並且發出<code>廣告狀態已變更(AdStatusUpdated)</code>的事件</li>
<li>審核系統收到 <code>廣告狀態已變更(AdStatusUpdated)</code> 事件時將廣告撈出來排入審核流程</li>
</ul>
<p>看出這中間有多大的落差了嗎？我們在系統中不用 <code>廣告已被發佈(AdPublished)</code>，取而代之的是<code>廣告狀態已變更（AdStatusUpdated）</code>，發佈的動作轉化成狀態的變更，需求在這大量轉化為系統程式碼的過程中，很有可能原始的意圖早已消失，而這可能正是關鍵知識遺失的過程。</p>
<h2 id="精準需求的迷失"><a href="#精準需求的迷失" class="headerlink" title="精準需求的迷失"></a>精準需求的迷失</h2><p>每當我們交付功能給客戶，面對客戶的不滿意時，常常歸因於<code>需求描述的失準</code>，開發團隊內會互相抱怨、指責，開發者埋怨開需求的人規格亂寫，開需求的人埋怨開發者搞不清楚也不問，導致開發出來的系統與最終想解決的問題有一大段落差，所以團隊可能會開始找更厲害的 PO 或 PM，開始要求規格書的格式，試圖用鉅細彌遺厚厚一本的規格書來彌補與真實之間的落差。</p>
<p>而事實真的是這樣嗎？很多時候開發人員是沒有機會直接面對需求單位或業務人員的，所以當這些需求單位透過與系統分析師描述後，再透過<code>系統分析師的理解</code>轉化成規格書，這中間可能就已經遺失了一部分真實。</p>
<div class="note info">
            <p>很多時候會議內所謂的共識，是你以為你的共識，我以為我的共識，實際上彼此認知的事情根本不是一回事，等雙方都告一段落後回來一對才發現跟當時說的不一樣，但彼此都覺得自己是照當時的決議實作的啊，所以問題可能不是雙方背信，而是彼此認知根本不在同一個點上。</p>
          </div>

<p>書中提到可以嘗試在溝通中，用視覺化的方式彌平彼此認知的落差，而我自己的經驗也發現，大量的文字描述常常聽者很難聚焦，當開始把各個會議中談到的東西視覺化，輔助上依賴關係與線性流程，有助於幫助與會人員更能聚焦在同一個點上。<br><img src="/images/20220525/1.jpg" alt="/images/20220525/1.jpg"><br>圖片來源: 領域驅動設計與 .Net Core 書中 p.26</p>
<h2 id="透過新的術語發現新的情境"><a href="#透過新的術語發現新的情境" class="headerlink" title="透過新的術語發現新的情境"></a>透過新的術語發現新的情境</h2><p>最前面提到在不同情境下，User 可能代表的意義完全不同，當我們在討論過程中可能會脫口而出<code>前台的消費者</code>、<code>平台的廠商</code>、<code>後台的管理者</code>…等等，而當這些用語的不同時，其實也幫助了我們發現了<code>新的情境</code>，針對這些新出現的情境建立對應的模型是需要的，對比於前面只用 <code>使用者(User)</code>來描述，後者更精準也更貼近真實，這也可以避免開發者寫出近乎於上帝類別的 User 來。 </p>
<p>雖然短短一小篇，但發現要把讀完的東西用自己的話再說一次真的還有一段差距啊</p>
]]></content>
      <categories>
        <category>領域驅動設計與.Net Core</category>
      </categories>
      <tags>
        <tag>DDD</tag>
        <tag>讀書心得</tag>
        <tag>領域驅動設計與 .Net Core</tag>
      </tags>
  </entry>
  <entry>
    <title>什麼是BOM(Byte-order mark)?</title>
    <url>/2018/08/23/byte_order_mark/</url>
    <content><![CDATA[<p>最近開發了一支收集資訊然後將資料轉成Json檔案給其它單位讀取，但收到對口單位回報Json格式不正確。但我將檔案內容貼到線上的Json解析網站，或是自己肉眼判斷都覺得格式沒問題，所以執行了一次對方的解析程式，錯誤訊息如下。</p>
<p>在字串0的位置有錯誤</p>
<p><img src="/images/20180823/1.png" alt="/images/20180823/1.png"></p>
<p>打開我提供的檔案，字串0也就是最前面感覺很正常…</p>
<p><img src="/images/20180823/2.png" alt="/images/20180823/2.png"></p>
<p>接著我將這段錯誤訊息貼Notepad++，轉成Hex碼來看看究竟是藏了什麼東西</p>
<p><img src="/images/20180823/3.png" alt="/images/20180823/3.png"></p>
<h1 id="什麼是BOM"><a href="#什麼是BOM" class="headerlink" title="#什麼是BOM"></a>#什麼是BOM</h1><p>把<strong>ef bb bf</strong>拿去Google最後查到了<a href="https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%85%83%E7%B5%84%E9%A0%86%E5%BA%8F%E8%A8%98%E8%99%9F">Wiki-位元組順序記號</a></p>
<div class="note info">
            <p>節錄Wiki</p><p><strong>位元組順序記號</strong>（英語：byte-order mark，<strong>BOM</strong>）是位於碼點<code>U+FEFF</code>的<a href="https://zh.wikipedia.org/wiki/%E7%B5%B1%E4%B8%80%E7%A2%BC">統一碼</a>字元的名稱。當以<a href="https://zh.wikipedia.org/wiki/UTF-16">UTF-16</a>或<a href="https://zh.wikipedia.org/wiki/UTF-32">UTF-32</a>來將<a href="https://zh.wikipedia.org/wiki/UCS">UCS</a>/統一碼字元所組成的字串編碼時，這個字元被用來標示其<a href="https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82%E5%BA%8F">位元組序</a>。它常被用來當做標示檔案是以<a href="https://zh.wikipedia.org/wiki/UTF-8">UTF-8</a>、<a href="https://zh.wikipedia.org/wiki/UTF-16">UTF-16</a>或<a href="https://zh.wikipedia.org/wiki/UTF-32">UTF-32</a>編碼的記號。 </p>
          </div>



<h1 id="解法"><a href="#解法" class="headerlink" title="#解法"></a>#解法</h1><p>而會塞入位元組序是因為在寫檔案時這樣指定編碼</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> (StreamWriter file = <span class="keyword">new</span> StreamWriter(</span><br><span class="line">    					<span class="keyword">new</span> FileStream(path,FileMode.OpenOrCreate,FileAccess.Write),</span><br><span class="line">                        Encoding.UTF8))</span><br><span class="line">&#123;</span><br><span class="line">	.....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>只要將寫改改成 <strong>new UTF8Encoding(false)</strong> 即可</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> (StreamWriter file = <span class="keyword">new</span> StreamWriter(</span><br><span class="line">                         <span class="keyword">new</span> FileStream(path, FileMode.OpenOrCreate, FileAccess.Write),</span><br><span class="line">                         <span class="keyword">new</span> UTF8Encoding(<span class="literal">false</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>其它</tag>
      </tags>
  </entry>
  <entry>
    <title>弱雞 Tech Lead 初體驗</title>
    <url>/2022/05/20/become_a_tech_lead/</url>
    <content><![CDATA[<p>近期很後悔自己中斷了寫部落格的習慣，為了重新養成這個習慣，所以有了這開春第一篇文章（都快夏天了老闆～），而既然是開春第一篇，想說就來寫些較軟性的題目好了（絕對不是我技術都沒長進的關係啦…），所以今天就來聊聊近期與團隊共患難的事情好了。</p>
<p>可能老闆知道我今年犯太歲的關係，不能讓我太好過，所以年初就派我去擔任一個 5 人小團隊的 tech lead，一開始本來懷抱著 “大家都很優秀，我應該只要去幫大家打打雜就好”的心態加入，殊不知考驗才剛剛開始。</p>
<p>這個團隊負責的是一個架構與開發框架性質的專案，亦即它的設計未來可能會直接影響 N 個團隊的開發習慣與 N 個服務掛在上面的行為，所以它的難度不低，加上初期時程壓力、人力吃緊的情況下，體質並不是很好，例如：</p>
<ul>
<li>專案幾乎沒有測試，上線常常發生改 A 壞 B 的情況</li>
<li>文件非常多，但跟實際系統運作邏輯有不小的落差</li>
<li>系統在還不穩固的情況下已經釋出 SDK 給團隊使用，加大改版向下相容的挑戰</li>
<li>Release 純手工，過程中需要人工介入調整許多地方，不熟的人看文件還要花半天以上才能搞定</li>
<li>框架本身的目標與使用該框架的服務需求間的拉扯，導致初期就有高度客製化的狀況，增加了後續入住這個框架得複雜度</li>
<li>資料庫版控管理不佳，每次更版幾乎都要倒資料，間接也讓服務開不出 API，因為實時的資料異動會導致資料遺失</li>
</ul>
<p>基於上述原因，團隊士氣其實並不高，因為即便是看似簡單的功能上線都如履薄冰，加上該專案是受到重視的專案（被定位為乘載公司未來性的框架），人員陸續補進來，團隊的壓力也隨之增加，因為人力往往與產值掛鉤，給予對應的人力沒有對應的產值是無法被接受的。</p>
<p>所以初期我花最多時間思考的不是怎麼滿足需求，反而是該如何穩住系統跟增加開發成員的信心，在軟體業也快 10 年了，新需求與改需求是不會有停止的一天，每個跟你談的需求都會很急很趕，不急不趕才是新聞，所以與其追著需求跑，我更在思考的是</p>
<ol>
<li>該如何穩住這個系統 ? 讓開發人員有信心，讓新進人員能在最短時間成為戰力</li>
<li>這個框架到底想解決的本質問題是什麼？ 如果它沒有守住那條線，這個框架基本上也沒有存在的價值</li>
</ol>
<p>所以我跟主管談了一個方案，農曆年前約三週時間需求我一律不收也不處理，一切請他幫我緩到農曆年後再說，對內開始跟團隊成員著手處理以下問題</p>
<ol>
<li>重建系統核心<br>我開始與團隊成員梳理目前系統運作的脈絡，對我來說系統要在不斷變動的環境下發展，不外乎讓你的程式碼能好好說明系統在做什麼，如果連幾個類別物件間的互動關係都說不清楚寫不好，又該如何期待這成千上萬行的程式碼堆疊出來系統會有一套清晰的邏輯在運作。又如何期待新進工程師能在眾多的文件中自己理出系統邏輯，縱然文件全然正確，理解文件後對應到程式碼的運作，這中間還有一段很長的路要走。所以我很喜歡 Uncle Bob 說的『世界上最好的文件應該是你的程式碼。』<br>這個觀念剛好也契合 DDD 中所強調的，把你的專注力先放在解決核心問題上，把問題之外的資料庫、 Schema、 軟體分層、作業系統先切開，先用最簡單的類別與物件來展示你要解決的業務邏輯，當這些都說得通、運作得當，剩下的都是支撐這個核心的基礎建設而已。</li>
</ol>
<ol start="2">
<li>建立單元測試<br>我與團隊成員立下的第一個約定就是 “MR 只要沒有單元測試一律退回”，我認為確保寫出來的程式運作邏輯的正確性是身為工程師的基本素養，Code Review 應該是讓大家討論與互相學習的場域，並試著透過多人 Review 從不同角度尋找盲點，防止重大舞弊、效能、資安…等問題，不要期待 Reviewer 能用肉眼幫你找出所有漏洞，如果寫單元測試都無法保證系統百分之百正確了，更何況不寫。<br>寫單元測試好處真的很多，除了能用最低成本快速驗證你的想法與程式碼之外，它也在保護你的團隊成員，當專案龐大到一個程度，團隊內成員對於 Code 與各個需求掌握度也都會有落差，所以當未來需求變動時，它能幫忙把關是否哪邊因為變動而出錯了。</li>
</ol>
<ol start="3">
<li>重新梳理開發流程與 CI/CD<br>與團隊成員討論了之前的分支策略後利弊後，我們開始改成 trunk-based 的跑法，試著降低大家解衝突的時間，並逼大家思考持續整合回 Master 的相容性問題，同時也開始投入資源建立 CI/CD ，讓一些明確與重複的流程自動化，降低部署的時間與負擔。穩固快速的部署流程不單單只是減少時間的浪費，往往也能增加團隊成員的信心，你會有信心即便真的最後出錯了，我們都有機會在很短的時間內迭代修復或退版，就像打籃球時有個超強中鋒幫你搶籃板一樣，各個投三分都跟 Curry 一樣有信心 (最近都在看 NBA 季後賽啦)。</li>
</ol>
<p>經過一番奮戰後，我們終於在總共花了 4 週多的時間，將原本幾乎開不出 API 的系統，陸續釋出 20多支的 API 上線，並且交付批次工具幫助協作單位整合資料，解決了之前常常需要手動進資料庫塞資料與髒資料橫行的問題，也終於終於得到了團隊成員的第一次肯定（淚）。 </p>
<p>但人生往往不會這麼簡單，你懂的 …</p>
<p>待續 … </p>
]]></content>
      <categories>
        <category>工程師的那些事</category>
      </categories>
      <tags>
        <tag>工程師的那些事</tag>
      </tags>
  </entry>
  <entry>
    <title>透過容器建置專案</title>
    <url>/2020/02/17/docker_ci_build/</url>
    <content><![CDATA[<p><img src="/images/20200217/0.jpg" alt="希望學會這個技巧後，以後大家弄CI/CD環境都能海闊天空"></p>
<p>(圖片出處 : <a href="http://ezvivi2.com/article/200483.asp">http://ezvivi2.com/article/200483.asp</a>)</p>
<p>有在處理 CI/CD 的人應該都碰到過維護建置環境的問題，舉例來說，當今天開發 C# 專案可能有 dotnet framework、dotnet core、有些人開發前端會需要 npm …等等，CI 機器就需要裝一堆為了建置佈署的軟體，如果開發人員變多，建置排隊久候，可能就會將環境升級為 Master、Slave 架構，但又面臨了多台 Slave 如何快速增長(通常只有上班時間才會同時這麼多人在建置，所以動態增長 CI 機器有其必要)，如何維護多台 Slave 環境，有時候遇到需要的套件版本打架的時候，處理起來真的是會抓狂。</p>
<h1 id="透過容器來建置專案"><a href="#透過容器來建置專案" class="headerlink" title="透過容器來建置專案"></a>透過容器來建置專案</h1><p>其實綜觀上述的問題可以發現，每個專案建置所需要的東西可能不盡相同，為了讓 CI 機器能夠滿足所有建置的條件往往會把環境搞得過於複雜，這時候容器就是一個非常好的選擇，它滿足了每次建置環境都是<strong>獨立</strong>、<strong>隔離</strong>的條件且方便佈署。</p>
<p>一旦使用容器來做為建置的媒介，需要長一台新的 CI 機器時，只要將機器開起來並安裝完 docker 就搞定了(甚至 AWS 都有做好的現成 AMI 連自己安裝都省了)，不再需要寫一狗票的腳本來安裝機器。</p>
<h1 id="實例"><a href="#實例" class="headerlink" title="實例"></a>實例</h1><p>以下是我一個專案建置時的 dockerfile，沒幾行的 script 就快速講一下，因為我這個專案裡面同時有 dotnet framework 與 dotnet core ，所以找個微軟官方提供的  <code>mcr.microsoft.com/dotnet/framework/sdk:4.8</code>, 裡面已經安裝了下列套件。 <a href="https://hub.docker.com/_/microsoft-dotnet-framework-sdk/">Docker Hub 連結</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">.NET Framework Runtime</span><br><span class="line">Visual Studio Build Tools</span><br><span class="line">Visual Studio Test Agent</span><br><span class="line">NuGet CLI</span><br><span class="line">.NET Framework Targeting Packs</span><br><span class="line">ASP.NET Web Targets</span><br></pre></td></tr></table></figure>

<p>我用這個 base image 開了 workspace 資料夾並把 source code 複製進去後，接著就是大家熟悉的 nuget restore 、 dotnet build、 dotnet publish 在容器的環境內建置專案。</p>
<p>第二段是起另一個 base image <code>windows servercore 2019</code>，將剛剛建置好的 artifact 放到指定的資料夾，最後這一包會建置成 image 並推到公司的 Artifact management 上，其它人只要拉下這個 image 就可以執行了。</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">mcr.microsoft.com/dotnet/framework/sdk:4.8</span> <span class="string">AS</span> <span class="string">build-env</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">c:/workspace</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">.</span> <span class="string">./</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">nuget</span> <span class="string">restore</span> <span class="string">src\nmqv3.sln</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">dotnet</span> <span class="string">restore</span> <span class="string">--configfile</span> <span class="string">src\.nuget\NuGet.Config</span> <span class="string">src\my_project.sln</span></span><br><span class="line"></span><br><span class="line"><span class="string">run</span> <span class="string">dotnet</span> <span class="string">build</span> <span class="string">-c</span> <span class="string">release</span> <span class="string">src\my_project.sln</span> </span><br><span class="line"><span class="string">run</span> <span class="string">dotnet</span> <span class="string">publish</span> <span class="string">-c</span> <span class="string">Release</span> <span class="string">-r</span> <span class="string">win-x64</span> <span class="string">--self-contained</span> <span class="literal">true</span> <span class="string">src\Router\Router.csproj</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">FROM</span> <span class="string">mcr.microsoft.com/windows/servercore:ltsc2019</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">c:/worker</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=build-env</span> <span class="string">c:/workspace/src/Worker/bin/release/</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">c:/router</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=build-env</span> <span class="string">c:/workspace/src/Router/bin/Release/netcoreapp3.0/win-x64/publish/</span> <span class="string">.</span></span><br></pre></td></tr></table></figure>

<p>從建置到最後要交付的 container image 一氣呵成，全部都濃縮在一份 dockerfile 裡面，這份 dockerfile 會跟著專案內，只要任何一台機器可以執行 docker container 就可以建置佈署這個專案，是不是方便許多 XD</p>
]]></content>
      <tags>
        <tag>Docker</tag>
        <tag>CI/CD</tag>
      </tags>
  </entry>
  <entry>
    <title>【Docker】偵錯技巧</title>
    <url>/2019/02/22/docker_debug_skill/</url>
    <content><![CDATA[<p><img src="/images/20190221/02/1.jpg" alt="/images/20190221/02/1.jpg"></p>
<p>學習 Docker 最先碰到的困擾應該都是<code>究竟該如何偵錯</code> ，畢竟 Docker Run Container 如果沒有下一些指令，通常都是執行完就砍掉，什麼都沒留下，不像在本機可以透過開發的 IDE、Log … 等手段來 Debug，所以這邊就寫下一些我較常使用的偵錯方式</p>
<br>

<h1 id="Run"><a href="#Run" class="headerlink" title="Run"></a>Run</h1><p>如果 Build Docker Image 時就有指定 CMD 或是 ENTRYPOINT，那 Container Run 起來後跑完就關掉了，這時候可以透過 Run 的最後一個參數來覆蓋過原本的 CMD 指令。 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it mcr.microsoft.com/windows/nanoserver:1809 cmd.exe</span><br></pre></td></tr></table></figure>

<p>這邊的 cmd.exe 就是要覆蓋 Build Image 所指定的指令，讓你可以進入 Container 的 terminal 中執行你想做的指令</p>
<div class="note info">
            <p><a href="https://medium.freecodecamp.org/docker-entrypoint-cmd-dockerfile-best-practices-abc591c30e21">Docker ENTRYPOINT &amp; CMD: Dockerfile best practices</a></p>
          </div>

<br>

<h1 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h1><p>因為 Container 每次執行都是全新的，所以導致 Log 不易保留，但我們可以 Volume 的方式將 Host Folder 與 Container 內的 Log Folder Mount ，這樣就可以將 Container 內的 Log File 寫出來，達到持久化的效果。</p>
<p><img src="/images/20190221/02/2.png" alt="/images/20190221/02/2.png"></p>
<p>(圖片來源 : <a href="https://docs.docker.com/storage/volumes/">Docker Docs</a> )</p>
<p>接著用簡單的範例來展示一下 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it mcr.microsoft.com/windows/nanoserver:1809 cmd.exe</span><br></pre></td></tr></table></figure>

<p>進到 Container 後，隨便寫個檔案</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir <span class="built_in">log</span></span><br><span class="line">$ <span class="built_in">cd</span> <span class="built_in">log</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hi&quot;</span> &gt;&gt; test.txt</span><br><span class="line">$ dir</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190221/02/3.png" alt="/images/20190221/02/3.png"></p>
<p>可以看到在 Container 內的確長出了 C:\log 資料夾，並且裡面有個 test.txt 的檔案，檔案裡面寫著 “hi”。但這時候你在 host 機器應該找不到對應的檔案，因為 Container 是彼此獨立且隔離的。</p>
<p>這時候離開 Container 再重啟一次，會發現剛剛 log 的 Folder 已經消失，因為這個 Container 是全新的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ docker run -it mcr.microsoft.com/windows/nanoserver:1809 cmd.exe</span><br><span class="line">$ dir</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190221/02/4.png" alt="/images/20190221/02/4.png"></p>
<br >

<p><a href="https://docs.docker.com/storage/volumes/">Volume</a> 使用方式</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">docker run -v HostFolderPath:ContainerFolderPath </span><br></pre></td></tr></table></figure>

<p>加上 Volume 參數再重新執行一次剛剛的步驟</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it -v c:\files:c:\<span class="built_in">log</span> mcr.microsoft.com/windows/nanoserver:1809 cmd.exe</span><br></pre></td></tr></table></figure>

<p>將 Host 機器的 <code>c:\files</code> Folder Mount 到 Container 內的 <code>c:\log</code> 資料夾，所以在 Container 內新增檔案寫 Log 也會同時寫出來</p>
<p><img src="/images/20190221/02/5.png" alt="/images/20190221/02/5.png"></p>
<p>這邊應該會注意到，因為 Volume 了 Container 內原本不存在的 log 資料夾，所以一進去的時候它就長出來了，並不需要特別另外建立。</p>
<br>

<h1 id="EXEC"><a href="#EXEC" class="headerlink" title="EXEC"></a>EXEC</h1><p>有時候 Container 內執行的是常駐程式，它可能會持續執行直到任務完成，如果又沒有將 Log 寫出來的必要，其實很難知道它目前的狀況為何，這時候 <a href="https://docs.docker.com/engine/reference/commandline/exec/">EXEC</a> 就派上用場了，它可以讓你進入一個正在執行中的 Container 中。</p>
<p>一樣用個簡單的範例來演練一下</p>
<p>先 Run 一個 Container 起來，並且一樣寫一個 log 下來</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it mcr.microsoft.com/windows/nanoserver:1809 cmd.exe</span><br><span class="line">$ mkdir <span class="built_in">log</span></span><br><span class="line">$ <span class="built_in">cd</span> <span class="built_in">log</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hi&quot;</span> &gt;&gt; test.txt</span><br><span class="line">$ dir</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190221/02/6.png" alt="/images/20190221/02/6.png"></p>
<p>這時候開另一個 terminal，先查詢剛剛的 Container ID</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190221/02/7.png" alt="/images/20190221/02/7.png"></p>
<p>透過 EXEC 指定要執行哪個 Container</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it d24e6db4de85 cmd.exe</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190221/02/8.png" alt="/images/20190221/02/8.png"></p>
<p>可以看到一進去就已經有剛剛我們寫下的 test.txt，表示這是同一個 Container，或是可以透過 hostname 來做驗證，可以得到相同的 ID</p>
<p><img src="/images/20190221/02/9.png" alt="/images/20190221/02/9.png"></p>
]]></content>
      <tags>
        <tag>Docker</tag>
        <tag>windows container</tag>
      </tags>
  </entry>
  <entry>
    <title>Jenkins,GitHub自動化部署Hexo</title>
    <url>/2019/03/01/centos_jenkins_hexo/</url>
    <content><![CDATA[<p><img src="/images/20190301/0.png" alt="/images/20190301/0.png"></p>
<p>這個部落格是用 <a href="https://hexo.io/zh-tw/index.html">hexo</a> 來製作的，優點是可以用 Markdown 寫法，且很多套件支援,讓我這個美感小白痴也可以輕鬆弄出富有質感的部落格(自己說)。</p>
<p>但也因為這樣,每次寫完文章都需要下 command 來編譯部落格、發佈到 Github ，讓我覺得不夠自動化</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexo g</span> </span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo deploy</span></span><br></pre></td></tr></table></figure>

<p>剛好最近在玩 AWS ，就想說來弄一台 t2.small Centos 機器來做 CI 機器好了</p>
<p><img src="/images/20190301/1.png" alt="/images/20190301/1.png"></p>
<br>

<h1 id="AWS-EC2"><a href="#AWS-EC2" class="headerlink" title="AWS EC2"></a>AWS EC2</h1><br>

<h2 id="Launch-Instance"><a href="#Launch-Instance" class="headerlink" title="Launch Instance"></a>Launch Instance</h2><p>AMI ： CentOS 7 </p>
<p><img src="/images/20190301/2.png" alt="/images/20190301/2.png"></p>
<p>Type ： t2.small </p>
<p><img src="/images/20190301/3.png" alt="/images/20190301/3.png"></p>
<p>原本用 t2.micro ，但經過測試在 Jenkins 執行 Job 的時候常常因為記憶體不足就當掉了，改 t2.small 後穩定許多</p>
<p>因為我之前已經有其他台 EC2 ，所以這邊我選擇用已經產過的 ssh key 來當作連線這台機器的 Key</p>
<p><img src="/images/20190301/4.png" alt="/images/20190301/4.png"> </p>
<br>

<h2 id="Security-Group"><a href="#Security-Group" class="headerlink" title="Security Group"></a>Security Group</h2><p>SSH 連線需要開 22 Port，先確認一下 Security Group 有開啟</p>
<p><img src="/images/20190301/5.png" alt="/images/20190301/5.png"> </p>
<p>用剛剛產出的 pem 檔連線到機器</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh -i ~/.ssh/&#123;yourSSH.pem&#125; centos@&#123;yourEc2IP&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果登入成功應該會看到這樣</p>
<p><img src="/images/20190301/6.png" alt="/images/20190301/6.png"> </p>
<p>如果遇到 Permission denied ，你需要先調整剛剛下載下來的 pem 檔的權限</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> chmod 400 yourSSH.pem</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@<br>@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @<br>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@<br>Permissions 0644 for ‘amazonec2.pem’ are too open.<br>It is recommended that your private key files are NOT accessible by others.<br>This private key will be ignored.<br>bad permissions: ignore key: amazonec2.pem<br>Permission denied (publickey).</p>
</blockquote>
<div class="note info">
            <p>參考文章</p><p><a href="https://stackoverflow.com/questions/8193768/trying-to-ssh-into-an-amazon-ec2-instance-permission-error">Trying to SSH into an Amazon Ec2 instance - permission error</a></p><p><a href="http://linux.vbird.org/linux_basic/0210filepermission.php#chmod">鳥哥的 Linux 私房菜</a></p>
          </div>

<br>

<h1 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h1><br>

<h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><div class="note info">
            <p>參考文章</p><p><a href="https://linuxize.com/post/how-to-install-jenkins-on-centos-7/#adjust-the-firewall">How To Install Jenkins on CentOS 7</a></p>
          </div>

<blockquote>
<p>基本上我完全是按照上面的文章教學一步一步完成的，在 Linux 還不是很熟的情況下，這邊只記下流水帳，詳細建議參考上述文章。</p>
</blockquote>
<ol>
<li><p>Install the OpenJDK 8 package</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install java-1.8.0-openjdk-devel</span></span><br></pre></td></tr></table></figure></li>
<li><p>Import the GPG key </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --silent --location http://pkg.jenkins-ci.org/redhat-stable/jenkins.repo | sudo tee /etc/yum.repos.d/jenkins.repo</span></span><br></pre></td></tr></table></figure></li>
<li><p>Add the Jenkins repository to your system</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.key</span></span><br></pre></td></tr></table></figure></li>
<li><p>Install Jenkins</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install jenkins</span></span><br></pre></td></tr></table></figure></li>
<li><p>Start the Jenkins service</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl start jenkins</span></span><br></pre></td></tr></table></figure></li>
<li><p>Check Jenkins Status</p>
</li>
</ol>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> systemctl status jenkins</span></span><br></pre></td></tr></table></figure>

<p>  <img src="/images/20190301/7.png" alt="/images/20190301/7.png"></p>
<ol start="7">
<li><p>Enable the Jenkins service to start on system boot</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl <span class="built_in">enable</span> jenkins</span></span><br></pre></td></tr></table></figure></li>
</ol>
<br>

<h2 id="設定"><a href="#設定" class="headerlink" title="設定"></a>設定</h2><p>這時候透過瀏覽器連線 Jenkins，應該會得到 Timeout 的回應</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">網址：http:&#x2F;&#x2F;yourEc2PublicIP:8080</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190301/8.png" alt="/images/20190301/8.png"></p>
<p>原因是機器的 Security Group 並沒有開放 80 Port 可以連進來，所以需要設定一下</p>
<p><img src="/images/20190301/9.png" alt="/images/20190301/9.png"></p>
<p>再次連線應該就可以看到設定畫面了</p>
<p><img src="/images/20190301/10.png" alt="/images/20190301/10.png"></p>
<br>

<p>第一次設定需要透過機器取得密碼</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo cat /var/lib/jenkins/secrets/initialAdminPassword</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/20190301/11.png" alt="/images/20190301/11.png"></p>
<p>將這段密碼貼上去後就可以進入下一步</p>
<p><img src="/images/20190301/12.png" alt="/images/20190301/12.png"></p>
<p>選擇 Install Suggested plugins</p>
<p><img src="/images/20190301/13.png" alt="/images/20190301/13.png"></p>
<p>設定 Admin User</p>
<p><img src="/images/20190301/14.png" alt="/images/20190301/14.png"></p>
<p><img src="/images/20190301/15.png" alt="/images/20190301/15.png"></p>
<h1 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h1><br>

<h2 id="安裝-Nodejs-、-NPM"><a href="#安裝-Nodejs-、-NPM" class="headerlink" title="安裝 Nodejs 、 NPM"></a>安裝 Nodejs 、 NPM</h2><p>為了能在 Jenkins Build Hexo ，必須先安裝好 NodeJs 並安裝 Hexo</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://linuxize.com/post/how-to-install-node-js-on-centos-7/">How to install Node.js and npm on CentOS 7</a></p>
          </div>

<blockquote>
<p>這邊一樣只節錄流水帳，詳細說明建議參考原文</p>
</blockquote>
<ol>
<li><p>Add NodeSource yum repository</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -sL https://rpm.nodesource.com/setup_10.x | sudo bash -</span></span><br></pre></td></tr></table></figure></li>
<li><p>Install NodeJs and NPM</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install nodejs</span></span><br></pre></td></tr></table></figure></li>
<li><p>Check</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node --version</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm --version</span></span><br></pre></td></tr></table></figure></li>
</ol>
<br>

<h2 id="Install-Git"><a href="#Install-Git" class="headerlink" title="Install Git"></a>Install Git</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git --version</span></span><br></pre></td></tr></table></figure>

<br>

<h2 id="Build-Hexo"><a href="#Build-Hexo" class="headerlink" title="Build Hexo"></a>Build Hexo</h2><p>因為我原本就已經有 Hexo Blog Repository，所以我該先讓 Jenkins 機器能夠從 pull blog source</p>
<ol>
<li><p>建立 ssh key</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh-keygen</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/20190301/16.png" alt="/images/20190301/16.png"></p>
</li>
<li><p>Add this ssh public key to github </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat ~/.ssh/id_rsa.pub</span></span><br></pre></td></tr></table></figure>

<p>將這整段 Public Key 加到 Github </p>
<p><img src="/images/20190301/17.png" alt="/images/20190301/17.png"></p>
<p><img src="/images/20190301/18.png" alt="/images/20190301/18.png"></p>
</li>
<li><p>Install Hexo</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo npm install hexo-cli -g</span></span><br></pre></td></tr></table></figure></li>
<li><p>Test git clone and hexo build</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> git@github.com:yourRepository/yourRepository.github.io.source.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> yourRepository</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo g</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo server</span></span><br></pre></td></tr></table></figure>

<p>如果到這邊都正常，基本上 Jenkins 機器已經有能力幫你 Build Hexo了</p>
</li>
</ol>
<br>

<h1 id="Create-Jenkins-Job"><a href="#Create-Jenkins-Job" class="headerlink" title="Create Jenkins Job"></a>Create Jenkins Job</h1><ol>
<li><p>新增作業</p>
<p><img src="/images/20190301/19.png" alt="/images/20190301/19.png"></p>
</li>
<li><p>原始碼管理</p>
<p><img src="/images/20190301/20.png" alt="/images/20190301/20.png"></p>
</li>
<li><p>設置 Credentials（點選 Add &gt; Jenkins） </p>
<p>將 Private Key 貼進去</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat ~/.ssh/id_rsa</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/20190301/21.png" alt="/images/20190301/21.png"></p>
<p>連線就正常了</p>
<p><img src="/images/20190301/22.png" alt="/images/20190301/22.png"></p>
</li>
<li><p>建置觸發程序</p>
<p><img src="/images/20190301/23.png" alt="/images/20190301/23.png"></p>
</li>
<li><p>建置</p>
<p><img src="/images/20190301/24.png" alt="/images/20190301/24.png"></p>
</li>
</ol>
<br>

<h1 id="Github-Webhook"><a href="#Github-Webhook" class="headerlink" title="Github Webhook"></a>Github Webhook</h1><p>這邊是要設定，當 Github 發現 Repository 被更新時，主動打個 Request 觸發剛剛建立好的 Jenkins</p>
<ol>
<li><p>先進到 Your Repository &gt; Settings &gt; Webhooks</p>
<p><img src="/images/20190301/25.png" alt="/images/20190301/25.png"></p>
</li>
<li><p>Add Webhooks</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">http:&#x2F;&#x2F;yourEc2PublicIP:8080&#x2F;github-webhook&#x2F;</span><br></pre></td></tr></table></figure>

<p>請特別注意！！ github-webhook/ 後面這個斜線一定要，不然會 302 錯誤</p>
<p><img src="/images/20190301/26.png" alt="/images/20190301/26.png"></p>
</li>
</ol>
<h1 id="錯誤排除"><a href="#錯誤排除" class="headerlink" title="錯誤排除"></a>錯誤排除</h1><p>看似一切美好又順利的把 Webhooks 接了起來，但觸發 Jenkins 後發現以下錯誤</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">INFO  Deploying: git</span><br><span class="line">Permission denied (publickey).</span><br><span class="line">fatal: Could not read from remote repository.</span><br></pre></td></tr></table></figure>

<p>為什麼 ？ 剛剛不是遠端登進去都試過跟 Git 之前的操作沒問題嗎？</p>
<p>原來是因為剛剛的 SSH Key 是建立在 centos 這個登入帳號底下，Jenkins 是透過自己的帳號權限在執行，所以我們必須將剛剛的SSH Key 搬過去給你，並賦予它權限</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cp ~/.ssh/id_rsa.pub /var/lib/jenkins/.ssh/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp ~/.ssh/id_rsa /var/lib/jenkins/.ssh/</span></span><br></pre></td></tr></table></figure>

<p>移過去後還需要將檔案擁有者改成 Jenkins，或是你可以針對 Jenkins 這跟帳號設定檔案權限，我這邊選擇直接把擁有者改成 Jenkins</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo chown jenkins /var/lib/jenkins/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo chown jenkins /var/lib/jenkins/.ssh/id_rsa</span></span><br></pre></td></tr></table></figure>

<p>確認權限都正確就大功告成啦！！</p>
<p><img src="/images/20190301/27.png" alt="/images/20190301/27.png"></p>
<br>

<p>現在你看到的這篇，就是透過 Jenkins 自動建置部署上來的</p>
<br>



<div class="note info">
            <p>參考文章</p><p><a href="https://www.mkshell.com/using-github-and-jenkins-deploy-hexo/">[小题大做] Github + Jenkins 实现自动化部署 hexo 博客静态文件</a></p>
          </div>]]></content>
      <tags>
        <tag>centos</tag>
        <tag>jenkins</tag>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>【Docker】Docker for Windows 和 Docker on Windows Server 一樣嗎?</title>
    <url>/2019/02/21/dockerforwindows_vs_dockeronwindowserver/</url>
    <content><![CDATA[<p><img src="/images/20190221/0.png" alt="/images/20190221/0.png"></p>
<p>一開始以為 Docker For Windows 跟 Windows Containers on Windows Server 是一樣的東西，結果在建置 CI 機器時碰到一些問題才發現原來是不同東西啊</p>
<br>

<h1 id="Docker-for-Windows"><a href="#Docker-for-Windows" class="headerlink" title="Docker for Windows"></a>Docker for Windows</h1><p>Docker for Windows 底層是透過 Hyper-V 來乘載 Docker Engine，也因為需要多一層 Hyper-V  ，所以執行效率比之後出的 Docker on Windows Server 直接原生 Docker Engine 效率來說差了一截，但也因為有 Hyper-V 的協助下，可切換成能執行 Linux Container 的模式。</p>
<p><img src="/images/20190221/1.png" alt="/images/20190221/1.png"></p>
<p> Windows 10 Professional 版本就可以安裝 ( 因為Professional 版本才有 Hyper-V )</p>
<p><img src="/images/20190221/2.png" alt="/images/20190221/2.png"></p>
<p>圖片來源 : <a href="https://docs.microsoft.com/zh-tw/virtualization/windowscontainers/deploy-containers/linux-containers">Microsoft</a></p>
<div class="note info">
            <p><a href="https://docs.microsoft.com/zh-tw/virtualization/windowscontainers/quick-start/quick-start-windows-10">Windows 10 上的 Windows 容器</a></p><p><a href="https://docs.docker.com/docker-for-windows/">Get started with Docker for Windows</a></p><p><a href="https://docs.microsoft.com/zh-tw/virtualization/windowscontainers/deploy-containers/linux-containers">Windows 上的 Linux 容器</a></p>
          </div>



<br>

<h1 id="Windows-Containers-on-Windows-Server"><a href="#Windows-Containers-on-Windows-Server" class="headerlink" title="Windows Containers on Windows Server"></a>Windows Containers on Windows Server</h1><div class="note info">
            <p><a href="https://docs.docker.com/install/windows/docker-ee/">Install Docker Engine - Enterprise on Windows Servers</a></p>
          </div>

<p>Windows Server 2016 或更新的版本才可使用，直接在 OS 上執行 Docker Engine，所以效能比需要 Hyper-V 的 Docker for Windows 好上一大截，如果要跑 Linux 類的 Container 也可以透過 <code>--isolation=hyperv</code> 的方式，不過有個限制是這個方法不能在 VM 中用，也就是說如果你今天是用雲端的 Windows Server，本身已經是在 VM 裡面了，就無法在裡面執行 <code>isolation</code>。</p>
<p><img src="/images/20190221/3.png" alt="/images/20190221/3.png"></p>
<p>圖片來源 : <a href="https://blogs.msdn.microsoft.com/msgulfcommunity/2015/06/20/what-is-windows-server-containers-and-hyper-v-containers/">MSDN</a></p>
<p>目前因為公司內部很多既有專案都是用 .Net Framework 開發的，所以轉移到 Container 也是選擇用 Windows Containers on Windows Server，畢竟如果是 Production Service，效能還是非常重要的一個考量</p>
<br>

<div class="note info">
            <p>參考文章</p><p><a href="https://columns.chicken-house.net/2016/09/05/windows-container-faq/#q3-windows-container-%E8%83%BD%E5%9F%B7%E8%A1%8C%E7%8F%BE%E6%9C%89%E7%9A%84-docker-container-image-%E5%97%8E">Windows Container FAQ - 官網沒有說的事</a></p><p><a href="https://blog.vizuri.com/docker-for-windows-vs.-docker-on-windows-server">Docker FOR Windows vs. Docker ON Windows Server - vizuri</a></p>
          </div>

]]></content>
      <tags>
        <tag>Docker</tag>
        <tag>windows container</tag>
      </tags>
  </entry>
  <entry>
    <title>【.Net Core】dotnet tool</title>
    <url>/2019/05/30/dotnet_tool/</url>
    <content><![CDATA[<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p><img src="/images/20190530/0.png" alt="/images/20190530/0.png"></p>
<p>最近在公司開發一支稱為 Linter 的小程式，負責檢查 Bitbucket  PR 的異動內容，看看是否有符合公司規範 ，例如 : 加了 Config 後是否有確實在對應環境補上相關設定，盡量避免這種編譯檢查不出來但上線才壞掉的情況。</p>
<p>原本預想的架構圖如上圖，使用者發了 PR ，透過 Webhook 觸發 Jenkins Master ，由 Master 安排一台機器去執行檢查。</p>
<p>但面臨一個問題是，當 Linter 這支程式要更版時變得很麻煩，因為每台 Jenkins 都必須要更新這支程式，原本也有想說不如把 Linter 獨立一台機器寫成類似像 API 的服務好了，但未來勢必面臨太多 PR 導致瓶頸，之後在導入 ELB 加多台機器 …. 想著想著就覺得太麻煩了。</p>
<p>之後同事建議可以包成 dotnet tool 的工具，Linter 要更新時只是發佈新版 Nuget ，而不是去佈署每台 Jenkins Slave，而  Jenkins Slave 每次要執行檢查 PR 時，先檢查自己套件是否為最新版的再往下執行。</p>
<p><img src="/images/20190530/1.png" alt="/images/20190530/1.png"></p>
<p>整個流程瞬間變得簡單乾淨許多，所以就動手開始將這套程式包成 dotnet tool</p>
<br>

<h1 id="製作-dotnet-tool"><a href="#製作-dotnet-tool" class="headerlink" title="製作 dotnet tool"></a>製作 dotnet tool</h1><p>首先將要包成 dotnet tool 的專案檔 csproj 加上 PackAsTool 設定  </p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">&quot;Microsoft.NET.Sdk&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OutputType</span>&gt;</span>Exe<span class="tag">&lt;/<span class="name">OutputType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>netcoreapp2.1<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AssemblyName</span>&gt;</span>Linter<span class="tag">&lt;/<span class="name">AssemblyName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">RootNamespace</span>&gt;</span>Linter<span class="tag">&lt;/<span class="name">RootNamespace</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">PackAsTool</span>&gt;</span>true<span class="tag">&lt;/<span class="name">PackAsTool</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Version</span>&gt;</span>1.0.1<span class="tag">&lt;/<span class="name">Version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>將執行檔打包成 nupkg</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dotnet pack -c release -o nupkg -p:PackageVersion=1.0.0 src\Linter.csproj</span></span><br></pre></td></tr></table></figure>

<p>推上 Nuget Server</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nuget.exe push src\nupkg\Linter.1.0.0.nupkg &lt;Nuget Key&gt; -<span class="built_in">source</span> &lt;Nuget Server&gt;</span></span><br></pre></td></tr></table></figure>



<br>

<h1 id="執行-dotnet-tool"><a href="#執行-dotnet-tool" class="headerlink" title="執行 dotnet tool"></a>執行 dotnet tool</h1><p>Install</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dotnet tool install --add-source &lt;Nuget Server&gt; -g Linter</span></span><br></pre></td></tr></table></figure>

<p>Update</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dotnet tool update -g --no-cache Linter</span></span><br></pre></td></tr></table></figure>

<p>接著就看你原本怎麼封裝 Cli ，直接執行即可</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> Linter check -n .......</span></span><br></pre></td></tr></table></figure>



<h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>第一次使用 dotnet tool 有驚豔到，以前都只會傻傻的用 console application ，每次都覺得部屬超麻煩，以後透過 dotnet tool 真的是方便多了 </p>
<div class="note info">
            <p><a href="https://blog.miniasp.com/post/2018/04/19/DotNet-Core-2-1-Global-Tools">保哥 - 體驗 .NET Core 2.1 全新的全域工具安裝與使用 (.NET Core Global Tools)</a></p><p><a href="https://docs.microsoft.com/zh-tw/dotnet/core/tools/global-tools-how-to-create">使用 .NET Core CLI 建立 .NET Core 通用工具</a></p>
          </div>

]]></content>
      <tags>
        <tag>dotnet core</tag>
      </tags>
  </entry>
  <entry>
    <title>淺談 CQRS</title>
    <url>/2021/08/15/intro_cqrs/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前專案就使用過 CQRS 做為系統的架構來開發，但一直覺得自己『知其然，而不知其所以然』，剛好最近出了一本<a href="https://www.tenlong.com.tw/products/9789864347926">CQRS 命令查詢職責分離模式</a> 所以就買回來把他讀完了，趁記憶還很清晰時趕快做一下筆記，以下的內容參雜了許多自己的見解，歡迎大家一起討論</p>
<h1 id="什麼是-CQRS"><a href="#什麼是-CQRS" class="headerlink" title="什麼是 CQRS"></a>什麼是 CQRS</h1><p>CQRS 全名為 Command Query Responsibility Segregation ，意即<strong>命令</strong>與<strong>查詢</strong>分離的設計模式，而</p>
<ul>
<li>Command : 會對系統狀態或資料做出異動的行為</li>
<li>Query : 單純取得資料不會對系統狀態造成異動的行為</li>
</ul>
<p>以傳統 CRUD 類比的話，CUD = Command，R = Query</p>
<h1 id="為什麼需要-CQRS"><a href="#為什麼需要-CQRS" class="headerlink" title="為什麼需要 CQRS"></a>為什麼需要 CQRS</h1><h2 id="降低複雜度"><a href="#降低複雜度" class="headerlink" title="降低複雜度"></a>降低複雜度</h2><p>我自己接觸過的大部分系統，大多都是以維護資料做為出發點來設計的系統，例如專案內一定會有所謂的 Repository Layer ： 一個提供各種 API 並能對資料做 CRUD 的封裝層。<br>系統本來就是一系列對資料維護的過程，這樣做有錯嗎？ 只要商業情境不要太複雜的話，大部分都沒什麼問題，但如果系統規模越做越大，商業情境越來越複雜，如果只是用 CRUD 的思維來設計系統，往往會讓複雜度越疊越高，甚至到不可收拾的地步。<br>舉個例子，你應該看過這樣的 API</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">MemberDto member</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> memberEntity = MemberRepository.Get(member.Id);</span><br><span class="line">    <span class="keyword">if</span>(memberEntity == <span class="literal">null</span>) </span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullReferenceException(<span class="string">&quot;Member not found.&quot;</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(member.Name)) </span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(member.Name));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(DateTime.TryParse(member.Birthday, <span class="keyword">out</span> <span class="keyword">var</span> birthday) == <span class="literal">false</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="keyword">nameof</span>(member.Birthday));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//bla bla bla ....</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(member.Password)) </span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(member.Password));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set Entity ...</span></span><br><span class="line"></span><br><span class="line">    memberEntity.Password = member.Password;</span><br><span class="line"></span><br><span class="line">    MemberRepository.Update(memberEntity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這個 API 可能包含了對 Member 資料的各種邏輯驗證，而呼叫這個 API 的你可能只是為了完成密碼變更而已，這份 Code 硬要說沒什麼大問題，但也體現了從 CRUD 角度設計出的 API 可能隨著商業邏輯的日益複雜，複雜度可能會成長到非常可怕的地步，而這也是 CQRS 中想避免的事情。</p>
<h2 id="Command-會這樣做"><a href="#Command-會這樣做" class="headerlink" title="Command 會這樣做"></a>Command 會這樣做</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Handle</span>(<span class="params">ResetPasswordCommand command</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> member = MemberRepository.Get(command.Id);</span><br><span class="line">    <span class="keyword">if</span>(memberEntity == <span class="literal">null</span>) </span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullReferenceException(<span class="string">&quot;Member not found.&quot;</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">//領域模型知道 ResetPassowrd 的相關驗證與知識</span></span><br><span class="line">    member.ResetPassword(command.Password);</span><br><span class="line"></span><br><span class="line">    MemberRepository.Update(member);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-貼近現實世界的用語"><a href="#1-貼近現實世界的用語" class="headerlink" title="1. 貼近現實世界的用語"></a>1. 貼近現實世界的用語</h3><p>PO 會對我們說需要<code>會員註冊</code>的功能，而不會說需要<code>新增會員</code>的功能，而通常<code>更換密碼</code>與<code>忘記密碼</code>會是完全不一樣的流程，用 <code>UpdatePassword</code> 很難精準說明這裡面做了什麼，你可能需要翻程式碼看流程，才能說出這個方法內包含了哪些商業情境，而這正是 Command 想避免的。</p>
<h3 id="2-貼近商業邏輯"><a href="#2-貼近商業邏輯" class="headerlink" title="2. 貼近商業邏輯"></a>2. 貼近商業邏輯</h3><p>一個 Command 只做一件事情，而 Command 所執行的流程跟邏輯應符合真實流程與情境</p>
<h3 id="3-Command-內盡量不要再串其他-Command"><a href="#3-Command-內盡量不要再串其他-Command" class="headerlink" title="3. Command 內盡量不要再串其他 Command"></a>3. Command 內盡量不要再串其他 Command</h3><p>Command 通常會對應觸發系統 Event，當 Command 串 Command 時，後續的連鎖反應容易失控，盡量讓 Command 就是獨立完成一個商業邏輯。</p>
<p>也許看到這邊會覺得這好像有點 DDD 的影子，定義領域模型並封裝領域知識，外部透過 Command 觸發領域模型做事，就我目前的認識，的確 DDD 通常會採用 CQRS 的設計模式來實作，但 CQRS 卻不一定要實作 DDD，不過 DDD 我還是初學者就不獻醜了。</p>
<h2 id="提升效能"><a href="#提升效能" class="headerlink" title="提升效能"></a>提升效能</h2><p>系統都希望提供各種角度的搜尋來滿足分析與功能需求，而這會加重資料庫的運算資源短缺問題，通常下一步就會開始將資料庫做<code>讀寫分離</code>的拆解，但最終逃離不了 Table Schema 需要同一套的束縛，而這個束縛在運算或是資料到達某個量級時就很難再往上提升了。</p>
<p>搜尋、寫入最佳化是個兩難的問題，搜尋要快通常要對 Index 設計下一些功夫，而偏偏 Index 越多寫入越慢，又或是 Table Schema 適度的反正規化對搜尋較為友善，但偏偏這會讓寫入資料維護時變得異常麻煩；反過來看，寫入要快需要盡量只寫入該寫入或該更新的資料，而正規化反而是有利於寫入的情境。當讀寫都對同一個 DB 或是同一張 Table 時這兩邊的平衡往往會讓 RD 抓狂，而 CQRS 正是能解決的問題的很好解決方案。<br><img src="/images/20210815/cqrs.png" alt="/images/20210815/cqrs.png"><br>CQRS 允許 Command 與 Query 可以是 Table 等級的隔離也可以是資料庫的實體隔離，更提供針對 Command 與 Query 各自選用最佳方案的資料庫，例如：Command 選用 RDB 而 Query 選擇 NoSQL 甚至是 Elasticsearch 這種重量級搜尋服務來滿足，兩邊資料則透過 Event Sync 的方式來同步。<br>通常系統寫入與查詢的量也是不成比例的，一般系統大部分都在應付各種查詢，而寫入可能只有讀取不到 10 分之 1 的量，CQRS 是有辦法單獨對 Query DB 做橫向擴充，而這在傳統系統架構上是很難做到的一點。</p>
<h1 id="既然這麼好，我是否該每個系統都這樣設計"><a href="#既然這麼好，我是否該每個系統都這樣設計" class="headerlink" title="既然這麼好，我是否該每個系統都這樣設計"></a>既然這麼好，我是否該每個系統都這樣設計</h1><p>有優點就有缺點，而 CQRS 的缺點是對於開發的難度提升了不止一個檔次，等等！上面不是說為了簡化才選擇 CQRS，這邊又說開發變困難，筆者態度前後不一啦（怒噴兩萬字）</p>
<p>先冷靜聽我說，CQRS 是想讓你的程式碼符合商業情境，並盡量符合 Single responsibility principle，這是 Code Level 的簡化，但架構卻變得更為複雜，第一你得面對兩邊資料庫的選擇問題，就算退一步說，我系統量不大，選擇同一座資料庫切 Table 可以吧，但 Command 與 Query 就是會有同步時間差，資料只能做到<strong>最終一致性</strong>，而你準備好面對這樣的改變了嗎？你應該不會想要採用 CQRS ，但抄寫兩張 Table 卻用同步的作法，這樣用單張 Table 採用 CRUD 的方式還更快一些。</p>
<p>當你的開始對 Command / Query 各自選用最佳的資料庫解決方案時，Event Sync 抄寫資料的實作想好解決方案了嗎？中間是透過 Queue 實作 Pub / Sub 同步嗎？ 資料同步延遲的 SLO 定好了嗎？ Consumer 同步速度跟不上寫入發過來的 Event 時，橫向擴充的機制是否想好了？</p>
<p>當開始要面對最終一致性時，不單單只是系統層面的調整，有時甚至從需求到 RD 觀念都是需要做些改變，現實世界最終一致性例子比比皆是，但在過去的大單體時代強一致性才是顯學，如今系統需要乘載的量體已經不可同日而語，除非有革命性的物理突破，不然我們都要開始習慣這個改變</p>
<div class="note info">
            <p>延伸閱讀<br><a href="https://www.enterpriseintegrationpatterns.com/ramblings/18_starbucks.html">Starbucks Does Not Use Two-Phase Commit</a></p>
          </div>

<p>講這麼多，那到底怎樣才需要用到 CQRS 實作系統？ 我的建議是如果這個系統<strong>流量</strong>或<strong>資料量</strong>預期成長不大，或需求不太會隨著商業情境一直改變的，例如後台系統，這種真的套個 Template 用 CRUD 簡單搞定就好，引入 CQRS 只會增加複雜度且不會有多大效益的，反之如果這個系統預期未來會持續成長，商業需求也會一直調整，那我會建議可以考慮引入 CQRS，但在前期可以選擇單一資料庫切 Table 的方式就好，等到真的量開始起來時再開始 Migration 都還來得及。</p>
]]></content>
      <tags>
        <tag>CQRS</tag>
      </tags>
  </entry>
  <entry>
    <title>dotnet core 3 container 無法連線 MSSQL 2016</title>
    <url>/2020/12/01/dotnet_core_3_container_ms_sql_2016/</url>
    <content><![CDATA[<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>最近踩到 dotnet core 3 contaienr  + ms sql 2016 的問題，問題的現象是，程式只要跑到建 sql connection 那行就會 hang 在那邊，沒有 timeout 也沒有 Exception … 追查之下後發現，原來 MS SQL 2016 如果沒有調整更新，預設 TLS 好像只支援 1.0、1.1 (待確認)，而我用的 base image : <code>mcr.microsoft.com/dotnet/core/runtime:3.1</code> 的 TLS 設定要求最低版本是 1.2，這也就引發了上述的狀況</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cat /etc/ssl/openssl.cnf</span> </span><br><span class="line">[system_default_sect]</span><br><span class="line">MinProtocol = TLSv1.2</span><br><span class="line">CipherString = DEFAULT@SECLEVEL=2</span><br></pre></td></tr></table></figure>



<h1 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h1><p>一般來說，基於安全性會建議至少停用 TLS 1.0 並支援 1.2 才是比較好的做法，但如果你跟我一樣只是在測試，那可以採用以下比較 workaround 的做法，在 dockerfile 加上以下幾行來調整 container tls 最低支援版本</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="string">RUN</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&#x27;s/DEFAULT@SECLEVEL=2/DEFAULT@SECLEVEL=1/g&#x27;</span> <span class="string">/etc/ssl/openssl.cnf</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&#x27;s/MinProtocol = TLSv1.2/MinProtocol = TLSv1/g&#x27;</span> <span class="string">/etc/ssl/openssl.cnf</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&#x27;s/DEFAULT@SECLEVEL=2/DEFAULT@SECLEVEL=1/g&#x27;</span> <span class="string">/usr/lib/ssl/openssl.cnf</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&#x27;s/MinProtocol = TLSv1.2/MinProtocol = TLSv1/g&#x27;</span> <span class="string">/usr/lib/ssl/openssl.cnf</span></span><br></pre></td></tr></table></figure>

<p>這樣重新啟動也就會正常了</p>
 <div class="note info">
            <p>參考文章</p><p><a href="https://github.com/dotnet/SqlClient/issues/222">.NET Core 3.0 Docker Container Won’t Connect to SQL Server</a></p>
          </div>

]]></content>
      <tags>
        <tag>Docker</tag>
        <tag>dotnet core</tag>
      </tags>
  </entry>
  <entry>
    <title>HttpClient doesn&#39;t change cookie value per request</title>
    <url>/2022/08/08/http_client_does_not_change_cookie_value_per_request/</url>
    <content><![CDATA[<p>Recently I found that the HttpClient doesn’t change cookie value per request, and it will cache the value for 2 minutes after the first request which have set the cookie value sent.</p>
<h1 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h1><ul>
<li>dotnet 5</li>
<li>runtime image: mcr.microsoft.com/dotnet/aspnet:5.0</li>
</ul>
<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>I use typed client in our project and use HttpRequestMessage to set the cookie “user.token” in every request.</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyHttpClient</span> : <span class="title">IMyHttpClient</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> HttpClient _httpClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyHttpClient</span>(<span class="params">HttpClient httpClient</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>._httpClient = httpClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">CallAPI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> request = <span class="keyword">new</span> HttpRequestMessage(HttpMethod.Post, <span class="string">&quot;/the/api&quot;</span>);</span><br><span class="line">        <span class="comment">// set request content</span></span><br><span class="line">        request.Content = <span class="keyword">new</span> StringContent(<span class="string">&quot;mydata&quot;</span>, Encoding.UTF8, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        <span class="comment">// set cookie here</span></span><br><span class="line">        request.Headers.Add(<span class="string">&quot;Cookie&quot;</span>, <span class="string">$&quot;user.token=<span class="subst">&#123;token&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> response = <span class="keyword">await</span> _httpClient.SendAsync(request);</span><br><span class="line">        response.EnsureSuccessStatusCode();</span><br><span class="line">        <span class="keyword">var</span> res = <span class="keyword">await</span> response.Content.ReadAsStringAsync();</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Register MyHttpClient to the Denpency Injection provider.</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line">services.AddHttpClient&lt;IMyHttpClient, MyHttpClient&gt;(config =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    config.BaseAddress = <span class="keyword">new</span> Uri(<span class="string">&quot;https://my.server.com&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>When I use <code>CallAPI()</code> of MyHttpClient, I found the cookie doesn’t change value per request, and it will cache value for 2 minutes.</p>
<h1 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h1><p>HttpClient is just a container of <code>HttpClientHandler</code>. If you trace the source code on <a href="https://github.com/dotnet/extensions/blob/v3.1.8/src/HttpClientFactory/Http/src/DefaultHttpClientFactory.cs">Github</a> you will see the code</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> HttpClient <span class="title">CreateClient</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(name));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> handler = CreateHandler(name);</span><br><span class="line">    <span class="keyword">var</span> client = <span class="keyword">new</span> HttpClient(handler, disposeHandler: <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> options = _optionsMonitor.Get(name);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; options.HttpClientActions.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        options.HttpClientActions[i](client);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> client;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpMessageHandler <span class="title">CreateHandler</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(name));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> entry = _activeHandlers.GetOrAdd(name, _entryFactory).Value;</span><br><span class="line"></span><br><span class="line">    StartHandlerEntryTimer(entry);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entry.Handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When you are asking for HttpClient, HttpClientFactory will generate a HttpClient instance everytime and try to get HttpMessageHandler from the pool. Why HttpClientFactory maintains HttpMessageHandler pool for us? Because creating TCP connections are extremely expensive, so we should reuse it as we can as possible.</p>
<p>So multiple HttpClients will possibly use same HttpMessageHandler. HttpMessageHandler has Property named CookieContainer. It will store cookie value when you first time to set the value. So it will cause different requests using same cookie value until HttpMessageHandler expired.</p>
<h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>There is a way to stop HttpMessageHandler using CookieContainer.</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line">services.AddHttpClient&lt;IPortalShellClient, PortalShellHttpClient&gt;(config =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    config.BaseAddress = <span class="keyword">new</span> Uri(clientConfig.PortalSiteEndpoint);</span><br><span class="line">&#125;)</span><br><span class="line">.ConfigurePrimaryHttpMessageHandler(() =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Tell HttpMessageHandler to stop using CookieContainer</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HttpClientHandler &#123; UseCookies = <span class="literal">false</span> &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Then you can set cookie value per request now.</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><p><a href="https://stackoverflow.com/questions/65227400/do-pooled-httpclient-instances-keep-the-cookiecontainer">Do pooled HttpClient instances keep the CookieContainer?</a></p>
</li>
<li><p><a href="https://github.com/microsoft/referencesource/blob/master/System/net/System/Net/Http/HttpClientHandler.cs">HttpClientHandler.cs</a></p>
</li>
</ul>
]]></content>
      <tags>
        <tag>dotnet core</tag>
      </tags>
  </entry>
  <entry>
    <title>NATS Streaming 調查報告書</title>
    <url>/2019/08/19/nats_streaming/</url>
    <content><![CDATA[<p><img src="/images/20190819/0.jpg" alt="/images/20190819/0.jpg"></p>
<p>最近因為任務關係對 NATS Streaming 做了一些研究跟 POC，這邊把一些研究到的NATS Streaming 特性記錄下來</p>
<h1 id="什麼是-NATS"><a href="#什麼是-NATS" class="headerlink" title="什麼是 NATS"></a>什麼是 NATS</h1><p><a href="https://nats.io/">NATS</a> 是一種 Queue , 它效能比一般的 Queue 好上許多，號稱 Sender / Reciever 每秒可高達 20 萬筆 Message，這是非常驚人的數字。</p>
<p><img src="/images/20190819/1.png" alt="/images/20190819/1.png"></p>
<p>（來源：<a href="https://bravenewgeek.com/dissecting-message-queues/%EF%BC%89">https://bravenewgeek.com/dissecting-message-queues/）</a></p>
<p>可以看到 RabbitMQ 在它旁邊矮了一大截….</p>
<br>

<p>NATS 支援 Subscribe 模式，Subscriber 訂閱需要的 subject，當 NATS 收到 Message 時就會同時派發給所有訂閱者。</p>
<p><img src="/images/20190819/2.png" alt="/images/20190819/2.png"></p>
<p>（來源：<a href="https://nats-io.github.io/docs/developer/concepts/pubsub.html%EF%BC%89">https://nats-io.github.io/docs/developer/concepts/pubsub.html）</a></p>
<br>

<p>NATS 也支援 Queu Group，NATS 會對同一個 Queue Group 的所有 Subscriber 分配訂閱的 Message，而不會重複</p>
<p><img src="/images/20190819/3.png" alt="/images/20190819/3.png"></p>
<p>（來源：<a href="https://nats-io.github.io/docs/developer/concepts/queue.html%EF%BC%89">https://nats-io.github.io/docs/developer/concepts/queue.html）</a></p>
<p>不過這些都不算太特別，畢竟 RabbitMQ 一樣能做到相同的功能，最特別的是 NATS Streaming</p>
<br>

<h1 id="什麼是-NATS-Streaming"><a href="#什麼是-NATS-Streaming" class="headerlink" title="什麼是 NATS Streaming"></a>什麼是 NATS Streaming</h1><p>NATS Streaming 是附加在 NATS 之上的加值功能，他可以永久的保留所有的 Message，並且支援 Cursor（指標）功能，你可以任意的讓 Subscriber 回到特定的點 <strong>重播</strong> 所有的 Message。</p>
<p>這一點相當有用，試想一下，如果今天我們將所有交易的過程都透過 NATS Streaming 記錄下來，假設資料庫或記錄的地方損毀，我們只要重新 Replay 所有 Message，即能重建最後的結果。這也是 <a href="https://microservices.io/patterns/data/event-sourcing.html">Event Sourcing</a> 中最重要的的一環。</p>
<p>為了達成 Event Sourcing 這個設計模式的目標，演練了一些特定的情境</p>
<ol>
<li>為了達成 HA 及加快處理速度的需求，需要多個 Subscriber 同時訂閱相同 Subject，並且彼此不會做到重複的 Message。</li>
<li>演練災難還原，Subscriber 必須能回朔到過去的的定時間點，重新 Replay 所有歷程</li>
</ol>
<br>

<h2 id="1-Queue-Group"><a href="#1-Queue-Group" class="headerlink" title="1. Queue Group"></a>1. Queue Group</h2><p>其實第一項相對於容易，只要用 Queue Group 即可輕鬆達成，只要每個 Subscriber 給定同一組 Queue Group Name 即可。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> options = StanOptions.GetDefaultOptions();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subOptions = StanSubscriptionOptions.GetDefaultOptions();</span><br><span class="line">subOptions.MaxInflight = <span class="number">1</span>; <span class="comment">// MaxInflight</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cf = <span class="keyword">new</span> StanConnectionFactory();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c = cf.CreateConnection(<span class="string">&quot;test-cluster&quot;</span>, clientId, options);</span><br><span class="line"><span class="keyword">var</span> s = c.Subscribe(<span class="string">&quot;foo&quot;</span>, queueGroup, subOptions, (obj, args) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">                ......</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//等待接收關機訊號</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//關閉連線</span></span><br><span class="line">s.Close(); </span><br><span class="line">c.Close();</span><br><span class="line">c.Dispose();</span><br></pre></td></tr></table></figure>

<p>這邊需要特別注意 <strong>MaxInflight</strong> 這個參數，為了效率 NATS  預設會一次派給 Subscriber 1000 則Message（預設值有點忘記），好讓 Subscriber 不需要每做完一筆才透過網路要下一筆 Message，但這也讓我測出一個問題，當預收的訊息太多並且 Subscriber 根本來不及消化掉，這時候 NATS 會判定該則訊息 timeout，轉而派給同群別的Subscriber 來處理，這時候可能會發生兩個 Subscriber 執行到同一筆 Message 的狀況，所以請估算好 MaxInflight 的值，避免抓一堆做不完重派的狀況發生。</p>
<p>當最後一個 <strong>Subscriber</strong> 離線後，Queue Group 即會被刪除</p>
<br>

<h2 id="2-Durable-Name"><a href="#2-Durable-Name" class="headerlink" title="2. Durable Name"></a>2. Durable Name</h2><p>前面有提到 NATS Streaming 支援 Cursor 的功能，當 Subscriber 都離線時，如果有給它 Durable Name，他會記得上次你執行到哪一筆，當下次 Subscriber 重新連上時會從那個點繼續往下派發</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> subOptions = StanSubscriptionOptions.GetDefaultOptions();</span><br><span class="line">subOptions.DurableName = _appSetting.DURABLENAME;</span><br></pre></td></tr></table></figure>

<br>

<h2 id="3-StartAt"><a href="#3-StartAt" class="headerlink" title="3. StartAt"></a>3. StartAt</h2><p>接著來實作災難還原的步驟，首先如何讓特定的 Queue Group 退到特定的點，呈上，同時多個 Subscriber 與 Durable Name 都還是要能符合。</p>
<p>SDK 其實有提供 <strong>StartAt()</strong> 的 API</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Receive messages starting at a specific sequence number</span></span><br><span class="line"><span class="keyword">var</span> subOptions = StanSubscriptionOptions.GetDefaultOptions();</span><br><span class="line">subOptions.StartAt(<span class="number">22</span>);</span><br></pre></td></tr></table></figure>

<p>不過這邊需特別注意，同一個 Queue Group 只有在第一個 Subscriber 進來時（也就建立這個 Queue Group 的時候）<strong>StartAt 才會生效</strong>，之後進來的 Subscriber 帶這個值都會被直接忽略掉。</p>
<p>這邊問題就來了，當我們帶了 Queue Group ＋ Durable Name，即便所有的 Subscriber 都離線了，NATS 還是會貼心的幫你記錄最後執行到的地方，所以之後進來的 Subscriber 也都不可能是第一個了，換言之這樣的狀況是無法重新設定指標的。</p>
<p>所以如果要刪除  Queue Group ＋ Durable Name 的 Queue Group 唯一的方法只有讓所有的 Subscriber 退訂閱</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 取消訂閱 刪除該Group</span></span><br><span class="line">s.Unsubscribe();</span><br></pre></td></tr></table></figure>

<p>這邊跟上面的範例程式不一樣，上面的是用 **Close()**，這樣並不會讓 Subscriber 退訂閱，只會是離線而已，唯有用 <strong>Unsubscribe()</strong> 將 Subscriber 全部退訂閱後，有 Durable Name 的 Queue Group 才會被刪除掉。</p>
<p>另外 NATS SDK 並沒有提供查詢 Queue Group 所有 Subscriber 的 Client ID，依據官方的說法，這份清單應該是使用者需要自己維護的，在上面這個案例上，就會需要將所有 <strong>Subscriber</strong> 用相同 Client ID 連上線後退訂閱。</p>
<br>

<h2 id="4-ManualAcks"><a href="#4-ManualAcks" class="headerlink" title="4. ManualAcks"></a>4. ManualAcks</h2><p>用上述的方法成功刪除 Queue Group 後，下一步就是重新讓第一個 <strong>Subscriber</strong> 去建立 Queue Group 並指定 <strong>StartAt</strong> ，不過這邊有點麻煩的地方是，<strong>Subscriber</strong> 一連線後馬上就會開始拋 Message 過來，這時後如果你是希望災難還原與重新執行 Replay 分開做時就會很困擾。</p>
<p>預設 StanSubscriptionOptions 是收到 Message 後自動就幫你 Ack 回報 NATS 你收到了在處理了，NATS 也就會繼續往下把下一筆分配給別人，但我只是想指定位子不想要處理 Message 呢？</p>
<p>這時候就要透過設定將 Ack 改成手動回報</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> subOptions = StanSubscriptionOptions.GetDefaultOptions();</span><br><span class="line">subOptions.ManualAcks = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s = c.Subscribe(<span class="string">&quot;foo&quot;</span>, queueGroup, subOptions, (obj, args) =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                      args.Message.Ack();</span><br><span class="line">                    &#125;);</span><br></pre></td></tr></table></figure>

<p>這樣只要不呼叫 **Ack()**，就等於不處理這筆 Message 了，當 Subscriber 離線或是 Message timeout，NATS 就會重新分派給其他 Subscriber 處理了，這樣也間接達到重建 Queue Group 與指定 Cursor 的目標。</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://nats-io.github.io/docs/">NATS Document</a></p><p><a href="https://github.com/nats-io/stan.net">The official NATS .NET C# Streaming Client</a></p>
          </div>]]></content>
      <tags>
        <tag>microservice</tag>
        <tag>NATS</tag>
      </tags>
  </entry>
  <entry>
    <title>【Docker】透過 Jenkins 重新部屬遠端機器 Container</title>
    <url>/2019/04/30/jenkins_update_remote_docker_container/</url>
    <content><![CDATA[<p><img src="/images/20190430/0.jpg" alt="/images/20190430/0.jpg"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>公司慢慢在導入 Docker 等相關 Container 技術，但因為剛起步所以很多 CI/CD 流程都還在優化建構中，前幾天為了能讓 Jenkins 順利重新部屬新版 Container 搞得焦頭爛額，乾脆把這些過程記錄下來</p>
<br>

<h2 id="部屬流程"><a href="#部屬流程" class="headerlink" title="部屬流程"></a>部屬流程</h2><p><img src="/images/20190430/1.png" alt="/images/20190430/1.png"></p>
<p>這個服務是由三個 Component 來組成，分開維護開發，換句話說如果有任何一個組件更新，整個服務都需要更新並重新部屬，目前的流程是各個 Component 更新後都會觸發 CD 流程將完成品打包放到 S3。</p>
<p>而我這次做得線就是 Docker Image 那條，當有任何 Component 更新了都會觸發，我會將 S3 的各個 Component 最新版抓下來後整理，接著再打包一版 Build Docker Image 會需要的原料放到 S3。</p>
<p>接著 Jenkins 接手將 Docker Image Artifact 抓下來開始 build =&gt; push =&gt; 換掉遠端機器正在跑的 Container。</p>
<br>

<h1 id="設定權限"><a href="#設定權限" class="headerlink" title="設定權限"></a>設定權限</h1><p> 所以第一步是釐清 Jenkins 所使用的 user 是否有執行 docker 相關指令的權限，後面都簡稱這位使用者為 <code>ciuser</code>。</p>
<p>因為 docker 為 service 等級的服務，預設是 admin 才能使用相關指令，所以理所當然地馬上卡關</p>
<p><img src="/images/20190430/2.png" alt="/images/20190430/2.png"></p>
<p>要讓使用者有執行 docker 相關指令的權限有兩種方法</p>
<ol>
<li>賦予該 User Admin 的權限</li>
<li>開一個群組，並設定 docker daemon ，賦予該群組權限</li>
</ol>
<p>顯然 (1) 不太可能(雖然最簡單)，所以這邊採取 (2) 的方法</p>
<p>*** Windows 上右鍵 &gt; Computer Management**</p>
<p><img src="/images/20190430/3.png" alt="/images/20190430/3.png"></p>
<p>*** Local Users and Groups &gt;&gt; Groups **</p>
<p><img src="/images/20190430/4.png" alt="/images/20190430/4.png"></p>
<p>*** New Group &gt;&gt; 建立一個群組 &gt;&gt; 將 ciuser 加進去**</p>
<p><img src="/images/20190430/5.png" alt="/images/20190430/5.png"></p>
<p>*** 到 C:\ProgramData\docker\config 修改 daemon.json 檔案**(如果沒有這個檔案，請自己建一個)</p>
<p>將剛剛的群組加進去</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;group&quot;</span>: <span class="string">&quot;docker-users&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>*** 重新啟動 docker service ** (這邊需要 admin 權限)</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Powershell</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">Restart-Service</span> docker</span><br></pre></td></tr></table></figure>

<p>做到這邊你在用 <code>ciuser</code> 下 docker command 應該就可以動了</p>
<p><img src="/images/20190430/6.png" alt="/images/20190430/6.png"></p>
<p>PS. 如果還不行，請先登出 <code>ciuser</code> 再登入，因為將使用者加入一個群組或賦予權限，重登才會生效</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-docker/configure-docker-daemon">Docker Engine on Windows</a></p>
          </div>



<p>到這邊應該已經打通 <code>ciuser</code> 可以執行 docker command 的權限了，接著在 Jenkins 設定 build 、 push Image的流程測試會發現依然錯誤</p>
<div class="note info">
            <p>error during connect: Get http://%2F%2F.%2Fpipe%2Fdocker_engine/v1.40/containers/json: open //./pipe/docker_engine: The system cannot find the file specified. In the default daemon configuration on Windows, the docker client must be run elevated to connect. This error may also indicate that the docker daemon is not running.</p>
          </div>

<p>但同樣的指令不透過 Jenkins 執行，而是用遠端登入直接執行會過，這個問題想了很久還是搞不懂為什麼，明明使用的 User 相同 …</p>
<p>但找到了一篇文章也提到相同的事情並提供了解決方案，主要是需要調整 docker_engine ACL 設定，但因為過程太麻煩，作者很貼心的還提供了小套件可以使用</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Powershell</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">Install-Module</span> <span class="literal">-Name</span> dockeraccesshelper</span><br><span class="line"><span class="variable">$</span> <span class="built_in">Import-Module</span> dockeraccesshelper</span><br><span class="line"><span class="variable">$</span> <span class="built_in">Add-AccountToDockerAccess</span> <span class="string">&quot;ciuser&quot;</span></span><br></pre></td></tr></table></figure>

<p>再次執行 Jenkins 就真的成功了</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://www.axians-infoma.com/techblog/allow-access-to-the-docker-engine-without-admin-rights-on-windows/">Allow access to the Docker Engine without admin rights on Windows</a></p>
          </div>

<br>

<h1 id="設定-Jenkins"><a href="#設定-Jenkins" class="headerlink" title="設定 Jenkins"></a>設定 Jenkins</h1><p>Build Image 、 Push Image 這些流程就直接省略了，重點是最後一步怎麼觸發遠端機器更新 Container 。</p>
<p>Docker Compose 提供 <code>--host</code> ，讓你可以操作遠端機器的 Container</p>
<p><img src="/images/20190430/7.png" alt="/images/20190430/7.png"></p>
<p>但前提是你必須先去該機器開啟 2376 port 的防火牆，還有設定 docker daemon config，跟上面那段一樣檔案，只是上次設定的是 jenkins 機器，這次是跑 Container 的機器</p>
<p>路徑 :  C:\ProgramData\docker\config\daemon.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;hosts&quot;</span>: [<span class="string">&quot;tcp://0.0.0.0:2376&quot;</span>, <span class="string">&quot;npipe://&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>都開好後回頭在 Jenkins 的流程中埋下最後一段</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker-compose -H machineIp:2376 pull</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker-compose -H machineIp:2376 up -d</span></span><br></pre></td></tr></table></figure>

<br>

<h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>雖然只是短短的一篇，但是整個設定的過程其實卡很久，尤其是 windows 的權限不是很熟常常會把自己搞得很亂，但為了團隊能接手維運，這些過程又勢必有人需要去踩過一次，以前都覺得 DevOps 的 Dev 才是主力(自己大部分經歷也都是待在開發團隊)，對於維運一直都沒有很深入去了解並感受他們的痛。</p>
<p>但當角色從 Developer 漸漸轉成 Infra ，不同的角度去看這些事情有了完全不同的感受，<code>維運</code>真的才是整個軟體生命週期佔最大的部分，一套系統你可能開發個 1 ~ 3 年，但產品的維運可能是數十年，怎麼讓一套機制落地，讓人為介入越少越好，要考慮的面向真的比過去單純開發差非常多，果然還有得學阿。</p>
]]></content>
      <tags>
        <tag>microservice</tag>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>initialize RabbitMQ container&#39;s Queue and Exchange</title>
    <url>/2020/06/06/rabbitmq_container_initial_queue/</url>
    <content><![CDATA[<p>為了測試方便常常會在本機起 RabbitMQ Container，但隨著系統的演進初始化 RabbitMQ 變得越來越複雜，例如：每次都要先設定 8 組 Queue，Exchange binding …等等</p>
<p>工程師的美德就是懶，所以開始找辦法是不是可以讓 RabbitMQ Container 起來時就自己設定好呢？</p>
<h2 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h2><p>RabbitMQ 有提供設定檔來初始化，分別為放在</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#x2F;etc&#x2F;rabbitmq&#x2F;rabbitmq.config</span><br><span class="line">&#x2F;etc&#x2F;rabbitmq&#x2F;definitions.json </span><br></pre></td></tr></table></figure>

<p>而這兩個檔案裡面可以設定 VirtualHost、Authorization、Exchange、Queue</p>
<p><strong>rabbitmq.config</strong><br>這邊特別提醒一下，內容最後面那個小點不是打錯喔，是規定就是要有的!</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    rabbit,</span><br><span class="line">    [</span><br><span class="line">      &#123; loopback_users, [] &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    rabbitmq_management,</span><br><span class="line">    [</span><br><span class="line">      &#123; load_definitions, &quot;&#x2F;etc&#x2F;rabbitmq&#x2F;definitions.json&quot; &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">].</span><br></pre></td></tr></table></figure>



<p><strong>definitions.json</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;rabbit_version&quot;: &quot;3.8&quot;,</span><br><span class="line">  &quot;users&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;guest&quot;,</span><br><span class="line">      &quot;password&quot;: &quot;guest&quot;,</span><br><span class="line">      &quot;tags&quot;: &quot;administrator&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;vhosts&quot;: [</span><br><span class="line">    &#123; &quot;name&quot;: &quot;&#x2F;&quot; &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;permissions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;user&quot;: &quot;guest&quot;,</span><br><span class="line">      &quot;vhost&quot;: &quot;&#x2F;&quot;,</span><br><span class="line">      &quot;configure&quot;: &quot;.*&quot;,</span><br><span class="line">      &quot;write&quot;: &quot;.*&quot;,</span><br><span class="line">      &quot;read&quot;: &quot;.*&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;parameters&quot;: [],</span><br><span class="line">  &quot;policies&quot;: [],</span><br><span class="line">  &quot;exchanges&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;nmq&quot;,</span><br><span class="line">      &quot;vhost&quot;: &quot;&#x2F;&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;direct&quot;,</span><br><span class="line">      &quot;durable&quot;: true,</span><br><span class="line">      &quot;auto_delete&quot;: false,</span><br><span class="line">      &quot;internal&quot;: false,</span><br><span class="line">      &quot;arguments&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;queues&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;command&quot;,</span><br><span class="line">      &quot;vhost&quot;: &quot;&#x2F;&quot;,</span><br><span class="line">      &quot;durable&quot;: true,</span><br><span class="line">      &quot;auto_delete&quot;: false,</span><br><span class="line">      &quot;arguments&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;bindings&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;source&quot;: &quot;nmq&quot;,</span><br><span class="line">      &quot;vhost&quot;: &quot;&#x2F;&quot;,</span><br><span class="line">      &quot;destination&quot;: &quot;command&quot;,</span><br><span class="line">      &quot;destination_type&quot;: &quot;queue&quot;,</span><br><span class="line">      &quot;routing_key&quot;: &quot;command&quot;,</span><br><span class="line">      &quot;arguments&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h2><p>在啟動 rabbitmq container 的時候將這兩個檔案透過 volume 的方式丟進去，這樣就可以達成目的了</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it \</span></span><br><span class="line"><span class="bash">	-v /etc/so/rabbitmq.config:/etc/rabbitmq/rabbitmq.config:ro \ </span></span><br><span class="line">	-v /etc/so/definitions.json:/etc/rabbitmq/definitions.json:ro rabbitmq:3.8-management</span><br></pre></td></tr></table></figure>



<h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h2><p>如過你不幸 (?) 的跟我一樣是使用 windows container，volume 這個選擇不屬於你，因為 windows container 只能將整個資料夾 volume 進去，並不能指定單一檔案，所以如果將整個資料夾放進去，需要額外將一些本該在 <code>/etc/rabbitmq</code> 底下的檔案也都 copy 出來，才不會跑起來的時候少東少西的，但這個方法總覺得有點麻煩，所以我採用自己 build image 的方案</p>
<p><strong>dockerfile</strong></p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">rabbitmq:3.8-management</span></span><br><span class="line"></span><br><span class="line"><span class="string">ADD</span> <span class="string">rabbitmq.config</span> <span class="string">/etc/rabbitmq/</span></span><br><span class="line"><span class="string">ADD</span> <span class="string">definitions.json</span> <span class="string">/etc/rabbitmq/</span></span><br></pre></td></tr></table></figure>

<p>透過 build image 的過程中將檔案放進去，之後起起來也都不用在下 volume 指令，也算是簡單不少</p>
<div class="note info">
            <p><a href="https://stackoverflow.com/questions/30747469/how-to-add-initial-users-when-starting-a-rabbitmq-docker-container"><a href="https://stackoverflow.com/questions/30747469/how-to-add-initial-users-when-starting-a-rabbitmq-docker-container">How to add initial users when starting a RabbitMQ Docker container?</a></a></p><p><a href="https://devops.datenkollektiv.de/creating-a-custom-rabbitmq-container-with-preconfigured-queues.html">Creating a custom RabbitMQ container with preconfigured queues</a></p>
          </div>

]]></content>
      <tags>
        <tag>Docker</tag>
        <tag>RabbitMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>擷取封包練習</title>
    <url>/2021/04/29/packet_capture/</url>
    <content><![CDATA[<p>最近接到一個任務，需要協助團隊重現幾個 DB 連線時的錯誤，例如: connection pool 超過上限爆掉、connection timeout 等等，而其中一個錯誤 Pre-Login handshack 最難重現</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">System.Data.SqlClient.SqlException (0x80131904): Connection Timeout Expired.  The timeout period elapsed while attempting to consume the pre-login handshake acknowledgement.  This could be because the </span><br><span class="line">pre-login handshake failed or the server was unable to respond back in time.  The duration spent while attempting to connect to this server was - [Pre-Login] initialization=2846; handshake=6765; </span><br></pre></td></tr></table></figure>
<p>這個錯誤推測是在與 SQL Server 連線時 three-way handshake 沒有收到回應導致的失敗，可能屬於網路不穩掉封包問題導致，但問題怎麼證明?</p>
<h1 id="Wireshark"><a href="#Wireshark" class="headerlink" title="Wireshark"></a>Wireshark</h1><p>首先得先確認與 SQL Server 連線時到底傳了哪些封包出去，可以透過 <a href="https://www.wireshark.org/">wireshark</a> 側錄封包的功能來達成</p>
<h2 id="1-設定-Capture"><a href="#1-設定-Capture" class="headerlink" title="1. 設定 Capture"></a>1. 設定 Capture</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">dst host xxx.xxx.xxx.xxx &amp;&amp; port 1433</span><br></pre></td></tr></table></figure>
<p><img src="/images/20210429/1.png" alt="/images/20210429/1.png"></p>
<h2 id="2-嘗試對-SQL-做一次連線並觀察封包"><a href="#2-嘗試對-SQL-做一次連線並觀察封包" class="headerlink" title="2. 嘗試對 SQL 做一次連線並觀察封包"></a>2. 嘗試對 SQL 做一次連線並觀察封包</h2><p><img src="/images/20210429/2.png" alt="/images/20210429/2.png"><br>可以發現 Pre-login handshake 應該會有三次封包傳輸</p>
<h1 id="Packet-Loss"><a href="#Packet-Loss" class="headerlink" title="Packet Loss"></a>Packet Loss</h1><p>接著得想辦法重現封包丟失的狀況下，是否會引發相同的 Exception，因為不知道怎麼精準的特定封包攔下來 (如果有人會的話也歡迎留言教學一下)，所以這邊透過 <a href="https://github.com/jagt/clumsy">Clumsy</a> 這個套件來輔助達成</p>
<h2 id="1-指定目的地的封包多少比例被攔截下來"><a href="#1-指定目的地的封包多少比例被攔截下來" class="headerlink" title="1. 指定目的地的封包多少比例被攔截下來"></a>1. 指定目的地的封包多少比例被攔截下來</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">outbound and ip.DstAddr = xxx.xxx.xxx.xxx</span><br></pre></td></tr></table></figure>
<p><img src="/images/20210429/3.png" alt="/images/20210429/3.png"></p>
<h2 id="2-增加連線-handshake-的機率"><a href="#2-增加連線-handshake-的機率" class="headerlink" title="2. 增加連線 handshake 的機率"></a>2. 增加連線 handshake 的機率</h2><p>因為無法精準攔截封包，所以採取短時間快速重複連線來增加封包被攔截的碰撞機率，所以我將 Connection Pool 關閉，並且開多執行序只做最簡單的連線與關閉連線，果然很快就碰到 handshake 的封包被攔掉的狀況</p>
<p><img src="/images/20210429/4.png" alt="/images/20210429/4.png"></p>
<p>而最後也證實了只要連線時網路不穩定導致掉封包等狀況時，底層是會引發上述錯誤的狀況</p>
]]></content>
      <tags>
        <tag>wireshark</tag>
        <tag>clumsy</tag>
      </tags>
  </entry>
  <entry>
    <title>powershell筆記</title>
    <url>/2020/02/26/powershell_note/</url>
    <content><![CDATA[<p><img src="/images/20200226/0.jpg" alt="/images/20200226/0.jpg"></p>
<p>(圖片出處: <a href="https://sploot.tw/2018/06/powershell-suite-windows-attack-tookit/">https://sploot.tw/2018/06/powershell-suite-windows-attack-tookit/</a>)</p>
<p>powershell 苦手如我，最近有越來越多的需求要從頭到尾自建 CI/CD 與自動化佈署流程，每次寫都要查一次覺得很煩(越老越金魚腦)，決定把常常用到的筆記方便查找</p>
<h1 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#列出所有的環境變數</span></span><br><span class="line"><span class="variable">$gci</span> env:* | <span class="built_in">Sort-Object</span> name</span><br><span class="line"></span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">Name                           Value</span><br><span class="line">----                           -----</span><br><span class="line">ALLUSERSPROFILE                C:\ProgramData</span><br><span class="line">APPDATA                        C:\Users\Steven Tsai\AppData\Roaming</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#設定環境變數</span></span><br><span class="line"><span class="variable">$env:test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$env:test</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#result</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>



<h1 id="Variable"><a href="#Variable" class="headerlink" title="Variable"></a>Variable</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$test</span></span><br><span class="line"><span class="comment">#result</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>



<h1 id="If-…-Else"><a href="#If-…-Else" class="headerlink" title="If … Else"></a>If … Else</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$if</span>(<span class="variable">$test</span> <span class="operator">-eq</span> <span class="string">&quot;123&quot;</span>) &#123;<span class="built_in">echo</span> <span class="string">&quot;yes&quot;</span>&#125; <span class="keyword">else</span> &#123;<span class="built_in">echo</span> <span class="string">&quot;no&quot;</span>&#125;</span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">yes</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#把判斷的結果存到變數中</span></span><br><span class="line"><span class="variable">$test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$result</span>=<span class="keyword">if</span>(<span class="variable">$test</span> <span class="operator">-eq</span> <span class="string">&quot;123&quot;</span>) &#123;<span class="built_in">echo</span> <span class="string">&quot;yes&quot;</span>&#125; <span class="keyword">else</span> &#123;<span class="built_in">echo</span> <span class="string">&quot;no&quot;</span>&#125;</span><br><span class="line"><span class="variable">$result</span></span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">yes</span><br></pre></td></tr></table></figure>



<h1 id="Split"><a href="#Split" class="headerlink" title="Split"></a>Split</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$test</span>=<span class="string">&quot;a,b,c&quot;</span></span><br><span class="line"><span class="variable">$test</span>.Split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$test</span>=<span class="string">&quot;a,b,c&quot;</span></span><br><span class="line"><span class="variable">$test</span>.Split(<span class="string">&quot;,&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">a</span><br></pre></td></tr></table></figure>



<h1 id="Invoke-WebRequest"><a href="#Invoke-WebRequest" class="headerlink" title="Invoke-WebRequest"></a>Invoke-WebRequest</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#需要帳密上傳檔案</span></span><br><span class="line"><span class="variable">$PASSWORD</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="literal">-String</span> <span class="string">&quot;your_password&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="variable">$CREDENTIAL</span> = <span class="built_in">New-Object</span> <span class="literal">-TypeName</span> <span class="string">&quot;System.Management.Automation.PSCredential&quot;</span> <span class="literal">-ArgumentList</span> <span class="string">&quot;your_account&quot;</span>, <span class="variable">$PASSWORD</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Invoke</span><span class="literal">-WebRequest</span> <span class="literal">-Method</span> PUT <span class="literal">-Uri</span> https://server/file.zip <span class="literal">-UseBasicParsing</span> <span class="literal">-Credential</span> <span class="variable">$CREDENTIAL</span> <span class="literal">-Infile</span> <span class="string">&quot;.\file.zip&quot;</span></span><br></pre></td></tr></table></figure>



<h1 id="Remove-Item"><a href="#Remove-Item" class="headerlink" title="Remove-Item"></a>Remove-Item</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#force強制刪除</span></span><br><span class="line"><span class="variable">$Remove</span><span class="literal">-Item</span> .\file.zip <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>



<h1 id="New-Item"><a href="#New-Item" class="headerlink" title="New-Item"></a>New-Item</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#建立 logs 資料夾</span></span><br><span class="line"><span class="variable">$New</span><span class="literal">-Item</span> <span class="literal">-ItemType</span> directory <span class="literal">-Path</span> C:\logs</span><br><span class="line"></span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">目錄: C:\</span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">d-----      <span class="number">2020</span>/<span class="number">2</span>/<span class="number">26</span>  上午 <span class="number">12</span>:<span class="number">28</span>                test</span><br></pre></td></tr></table></figure>



<h1 id="Copy-Item"><a href="#Copy-Item" class="headerlink" title="Copy-Item"></a>Copy-Item</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$Copy</span><span class="literal">-Item</span> c:\source_folder C:\target_folder\ <span class="literal">-Recurse</span></span><br></pre></td></tr></table></figure>



<h1 id="Out-File"><a href="#Out-File" class="headerlink" title="Out-File"></a>Out-File</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#將文字寫成檔案</span></span><br><span class="line"><span class="variable">$test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$test</span> | <span class="built_in">Out-File</span> <span class="string">&quot;C:\log.txt&quot;</span> <span class="literal">-Encoding</span> utf8 <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>



<h1 id="Write-file-without-BOM"><a href="#Write-file-without-BOM" class="headerlink" title="Write file without BOM"></a>Write file without BOM</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$</span>[<span class="type">System.IO.File</span>]::WriteAllLines(<span class="string">&quot;C:\log.txt&quot;</span>, <span class="variable">$test</span>) </span><br></pre></td></tr></table></figure>



<h1 id="Start-Transcript"><a href="#Start-Transcript" class="headerlink" title="Start-Transcript"></a>Start-Transcript</h1><p>通常腳本會在長機器的時候自動執行，這時候並不會有人工介入，如果發生錯誤就很需要事後追查 Log ，但一段腳本可能上百上千行，到底錯在哪很難找，這時候就可以透過以下方法把執行的過程跟 output 都儲存下來</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$Start</span><span class="literal">-Transcript</span> <span class="literal">-Path</span> <span class="string">&quot;c:\logs.txt&quot;</span> <span class="literal">-Append</span></span><br><span class="line"><span class="variable">$New</span><span class="literal">-Item</span> <span class="literal">-Type</span> Directory C:\TestData2\ <span class="literal">-Force</span></span><br><span class="line"><span class="variable">$Stop</span><span class="literal">-Transcript</span></span><br></pre></td></tr></table></figure>

<p>執行結束後打開 logs.txt 就可以看到以下輸出</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">**********************</span><br><span class="line">Windows PowerShell 轉譯開始</span><br><span class="line">**********************</span><br><span class="line">已啟動轉譯，輸出檔為 c:\logs.txt</span><br><span class="line">PS C:\Users\Steven Tsai&gt; New-Item -Type Directory C:\TestData2\ -Force</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    目錄: C:\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">d-----      2020&#x2F;2&#x2F;26  上午 12:40                TestData2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PS C:\Users\Steven Tsai&gt; Stop-Transcript</span><br><span class="line">**********************</span><br><span class="line">Windows PowerShell 轉譯結束</span><br><span class="line">結束時間: 20200226004058</span><br><span class="line">**********************</span><br></pre></td></tr></table></figure>



<h1 id="Set-Global-Enviroment"><a href="#Set-Global-Enviroment" class="headerlink" title="Set Global Enviroment"></a>Set Global Enviroment</h1><p>這是用在自動化安裝一些套件，例如 : Git , consul 後需要設定全域的環境變數，才能讓之後的指令能夠認得 consul –version 這類指令。</p>
<p>如果手動安裝，就是去把環境變數中 Path 加上 consul.exe 的位置，以下範例是抓出 Path 本來的設定值，並在尾段補上新的路徑設定</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$oldpath</span> = (<span class="built_in">Get-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;Registry::HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\Environment&#x27;</span> <span class="literal">-Name</span> PATH).path</span><br><span class="line"></span><br><span class="line"><span class="variable">$newpath</span> = <span class="string">&quot;<span class="variable">$</span>&#123;oldpath&#125;;C:\consul\&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Set</span><span class="literal">-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;Registry::HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\Environment&#x27;</span> <span class="literal">-Name</span> PATH <span class="literal">-Value</span> <span class="variable">$newPath</span></span><br></pre></td></tr></table></figure>



<h1 id="Start-Service"><a href="#Start-Service" class="headerlink" title="Start-Service"></a>Start-Service</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$Start</span><span class="literal">-Service</span> your_service_name</span><br></pre></td></tr></table></figure>



<h1 id="register-task-scheduler"><a href="#register-task-scheduler" class="headerlink" title="register task scheduler"></a>register task scheduler</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#要執行的動作</span></span><br><span class="line"><span class="variable">$action</span>= (<span class="built_in">New-ScheduledTaskAction</span> <span class="literal">-Execute</span> <span class="string">&quot;powershell.exe&quot;</span> <span class="literal">-Argument</span> <span class="string">&quot;-ExecutionPolicy bypass C:\start.ps1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#執行權限</span></span><br><span class="line"><span class="variable">$ProvisionPrincipal</span> = <span class="built_in">New-ScheduledTaskPrincipal</span> <span class="literal">-UserId</span> <span class="string">&quot;NT AUTHORITY\SYSTEM&quot;</span> <span class="literal">-RunLevel</span> Highest <span class="literal">-LogonType</span> S4U</span><br><span class="line"></span><br><span class="line"><span class="comment">#觸發的時機</span></span><br><span class="line"><span class="variable">$ProvisionTrigger</span> = <span class="built_in">New-ScheduledTaskTrigger</span> <span class="literal">-AtStartup</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#註冊 task Schedule </span></span><br><span class="line"><span class="variable">$Register</span><span class="literal">-ScheduledTask</span> <span class="literal">-TaskName</span> <span class="string">&quot;StartConsul&quot;</span> <span class="literal">-TaskPath</span> <span class="string">&quot;\&quot;</span> <span class="literal">-Action</span> <span class="variable">$action</span> <span class="literal">-Trigger</span> <span class="variable">$ProvisionTrigger</span> <span class="literal">-Principal</span> <span class="variable">$ProvisionPrincipal</span> </span><br></pre></td></tr></table></figure>



<h1 id="Create-User"><a href="#Create-User" class="headerlink" title="Create User"></a>Create User</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment">#設定 User 密碼</span></span><br><span class="line"><span class="variable">$Secure_String_Pwd</span>=<span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;user_password&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#建立User</span></span><br><span class="line"><span class="variable">$New</span><span class="literal">-LocalUser</span> <span class="string">&quot;teamuser&quot;</span> <span class="literal">-Password</span> <span class="variable">$Secure_String_Pwd</span> <span class="literal">-FullName</span> <span class="string">&quot;Arch team user&quot;</span> <span class="literal">-Description</span> <span class="string">&quot;for arch team&quot;</span> <span class="literal">-PasswordNeverExpires</span>:<span class="variable">$true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#將此 User 加入 Administrators</span></span><br><span class="line"><span class="variable">$Add</span><span class="literal">-LocalGroupMember</span> <span class="literal">-Group</span> <span class="string">&quot;Administrators&quot;</span> <span class="literal">-Member</span> <span class="string">&quot;teamuser&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#建立一個全新的 Group</span></span><br><span class="line"><span class="variable">$New</span><span class="literal">-LocalGroup</span> <span class="literal">-Name</span> <span class="string">&quot;docker-users&quot;</span></span><br><span class="line"><span class="comment">#將此 User 加進去</span></span><br><span class="line"><span class="variable">$Add</span><span class="literal">-LocalGroupMember</span> <span class="literal">-Group</span> <span class="string">&quot;docker-users&quot;</span> <span class="literal">-Member</span> <span class="string">&quot;archteamuser&quot;</span></span><br></pre></td></tr></table></figure>



<h1 id="Expand-Archive"><a href="#Expand-Archive" class="headerlink" title="Expand-Archive"></a>Expand-Archive</h1><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$curl</span> https://source_file.zip <span class="literal">-o</span> c:\targe_file.zip</span><br><span class="line"></span><br><span class="line"><span class="variable">$Expand</span><span class="literal">-Archive</span> c:\targe_file.zip c:\file <span class="literal">-force</span></span><br></pre></td></tr></table></figure>

]]></content>
      <tags>
        <tag>CI/CD</tag>
        <tag>powershell</tag>
      </tags>
  </entry>
  <entry>
    <title>微服務的戰場</title>
    <url>/2019/03/21/microservice_battlefield/</url>
    <content><![CDATA[<p><img src="/images/20190321/0.jpg" alt="/images/20190321/0.jpg"></p>
<p>整理一下最近在學習的 Road map，大致上圍繞著微服務</p>
<ul>
<li><p>微服務</p>
<ul>
<li><p>什麼是微服務</p>
</li>
<li><p>微服務的好幫手</p>
<ul>
<li>Container<ul>
<li><a href="/2019/02/21/dockerforwindows_vs_dockeronwindowserver/">Docker for Windows 和 Docker on Windows Server 一樣嗎?</a></li>
<li><a href="/2019/04/22/Docker_build/">Docker Build Image</a></li>
<li>Docker Compose</li>
<li><a href="/2019/02/22/docker_debug_skill/">偵錯技巧</a></li>
<li><a href="/2019/02/20/windows_container_dnsserver/">Widows Container DNS Server 問題</a></li>
<li><a href="/2019/02/19/windows_contianer_iamrole_/">Widows Container IAM Role 問題</a></li>
<li><a href="/2019/03/23/windows_container_smb_/">Windosw Container SMB </a></li>
</ul>
</li>
<li>Queue<ul>
<li>RabbitMQ</li>
<li><a href="/2019/08/19/nats_streaming/">NATS</a></li>
</ul>
</li>
<li>Self Hosting<ul>
<li>Owin</li>
</ul>
</li>
<li>Graceful Shutdown</li>
<li><a href="/2019/11/09/service_discovery/">Service Discovery</a></li>
</ul>
</li>
<li><p>部署</p>
<ul>
<li>K8S</li>
<li>docker swarm</li>
<li><a href="/2019/04/30/jenkins_update_remote_docker_container/">透過 Jenkins 重新部屬遠端機器 Container</a></li>
</ul>
</li>
</ul>
</li>
</ul>
]]></content>
      <tags>
        <tag>microservice</tag>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Service Discovery</title>
    <url>/2019/11/09/service_discovery/</url>
    <content><![CDATA[<p><img src="/images/20191109/0.png" alt="/images/20191109/0.png"></p>
<p>( <a href="https://www.codeprimers.com/service-discovery-in-microservice-architecture/">https://www.codeprimers.com/service-discovery-in-microservice-architecture/</a> )</p>
<br>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>傳統上一組服務通常都會搭配 DNS + Load balance + serivce cluster, 服務要呼叫時也都是直接打 Domain 讓 Load balance 去導流。</p>
<p>不過這也面臨了管理 Domain 與服務間的複雜度, 例如服務要加一台新的機器需要去設定 Load balance 才有辦法服務(當然也是可以搭配一些 cloud autoscaling 機制來簡化流程); Client 在呼叫 Service 時通常需要真的打打看才有辦法知道服務是否還正常, 無法事先知道服務狀態再決定是否要呼叫。</p>
<p>近年微服務與容器化運用的盛行, 上述方式就顯得有點卡卡的，如果你的服務在 k8s 內那可能還好, 大部分它都幫忙處理掉了, 但如果像我們公司一樣, 很多服務雖然容器化但還無法進到 k8s 內, container 可以在短時間內 scale 成數倍來因應大流量, 但卡在這些服務需要去 load balance 註冊才有辦法讓流量導進來,  那顯然就有點做半套的感覺， Service Discovery 的應用就成為了重要的課題</p>
<br>

<h1 id="什麼是-Service-Discovery"><a href="#什麼是-Service-Discovery" class="headerlink" title="什麼是 Service Discovery"></a>什麼是 Service Discovery</h1><p>翻譯成中文就是服務發現(廢話…)，顧名思義就是呼叫端在需要時先透過搜尋來找到對應的服務，而要達成這點需要一些配合才能達成。</p>
<p>首先第一步, 當某個服務起來時應該主動向提供 service discovery 註冊自己是什麼服務? 位置在哪? 是否已經可以開始服務了? </p>
<p><img src="/images/20191109/1.gif" alt="/images/20191109/1.gif"></p>
<p>註冊時會搭配著 Health check 的機制, 告訴 service discovery 如何檢核這個節點是否健康的</p>
<p><img src="/images/20191109/2.png" alt="/images/20191109/2.png"></p>
<p>Client 在要叫用 service 時, 先透過 service name 詢問有哪些節點可用, 而 service discovery 也能準確地回應有哪些目前還是健康的節點可供呼叫 </p>
<p><img src="/images/20191109/3.png" alt="/images/20191109/3.png"></p>
<p>當節點損壞時, 以 container 的案例, 會直接換掉不健康的 container 重長一組, 而這又會回到圖一註冊的流程。</p>
<p>更細緻一點的作法還有對 service discovery 回應的列表做快取，例如快取 1 秒，當服務自己要被收掉時, 做好 graceful shutdown 先把自己從服務列表中 deregister , 並且等待 3 秒後才關機，避免快取到的 Client 打來你剛好停止服務。</p>
<p>或是對服務加上 Tag ，當特定用戶或 VIP 連進來時可以透過搜尋特定機器去執行</p>
<p><img src="/images/20191109/4.png" alt="/images/20191109/4.png"></p>
<br>

<h1 id="面臨的問題"><a href="#面臨的問題" class="headerlink" title="面臨的問題"></a>面臨的問題</h1><p>但並不是所有事情都是如此美好, 公司目前導入這些機制雖然可以大幅簡化管理內部服務 domain 這類的問題, 但對於 load balance，即選取適合的節點這點上還有一些問題要克服，例如傳統 ELB 這類的服務都會依據每個節點的回應速度來判斷接下來導流的分配，但 service discovery 因為 request 並不會經過它，所以相關 latancy 也無從監控與觀察, 所以 load balance 這題必須額外拉出來做相對應的監控機制。</p>
<p>再來當服務橫跨 vm 跟 k8s 時情境就變得更複雜，不過這些題目等到之後有明確的方向再做整理好了，久違的文章雖然都沒寫到 code，但還是把一些觀念記錄下來。相關的實作等之後有空再補吧 (逃)</p>
]]></content>
      <tags>
        <tag>microservice</tag>
        <tag>service discovery</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift]  CoreData (1) 建立CoreData</title>
    <url>/2015/03/13/swift-CoreData-1-%E5%BB%BA%E7%AB%8BCoreData/</url>
    <content><![CDATA[<p>CoreData是是一種以物件導向方式讓開發者與跟資料庫互動的框架,好處是你不需要懂SQL也能對SQLite做操作</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-cLEXYUQDTJA/VQJMODzIHuI/AAAAAAAAEjg/uDb2WQBOTmA/s1600/S__23961604.jpg)](http://1.bp.blogspot.com/-cLEXYUQDTJA/VQJMODzIHuI/AAAAAAAAEjg/uDb2WQBOTmA/s1600/S__23961604.jpg)[
](http://1.bp.blogspot.com/-cLEXYUQDTJA/VQJMODzIHuI/AAAAAAAAEjg/uDb2WQBOTmA/s1600/S__23961604.jpg)</div><div style="clear: both;"></div>

<ul>
<li><p>  接著來筆記如何實作CoreData,首先先建立一個專案並把Use Core Data勾選起來<br><a href="http://4.bp.blogspot.com/-owBGxoBedgU/VQJObPRud4I/AAAAAAAAEjs/UKixdyBIA_0/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-13%2B%E4%B8%8A%E5%8D%8810.37.24.png"><img src="https://4.bp.blogspot.com/-owBGxoBedgU/VQJObPRud4I/AAAAAAAAEjs/UKixdyBIA_0/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-13%2B%E4%B8%8A%E5%8D%8810.37.24.png"></a></p>
</li>
<li><p>接著打開AppDelegate最下面可以看到多了一大堆程式碼 ```js<br>// MARK: - Core Data stack</p>
<pre><code>  lazy var applicationDocumentsDirectory: NSURL = &#123;
  // The directory the application uses to store the Core Data store file. This code uses a directory named &quot;tw.com.xxx.Coredata&quot; in the application&#39;s documents Application Support directory.
  let urls = NSFileManager.defaultManager().URLsForDirectory(.DocumentDirectory, inDomains: .UserDomainMask)
  return urls[urls.count-1] as NSURL
</code></pre>
<p>  }()</p>
<pre><code>  lazy var managedObjectModel: NSManagedObjectModel = &#123;
  // The managed object model for the application. This property is not optional. It is a fatal error for the application not to be able to find and load its model.
  let modelURL = NSBundle.mainBundle().URLForResource(&quot;Coredata&quot;, withExtension: &quot;momd&quot;)!
  return NSManagedObjectModel(contentsOfURL: modelURL)!
</code></pre>
<p>  }()</p>
<pre><code>  lazy var persistentStoreCoordinator: NSPersistentStoreCoordinator? = &#123;
  // The persistent store coordinator for the application. This implementation creates and return a coordinator, having added the store for the application to it. This property is optional since there are legitimate error conditions that could cause the creation of the store to fail.
  // Create the coordinator and store
  var coordinator: NSPersistentStoreCoordinator? = NSPersistentStoreCoordinator(managedObjectModel: self.managedObjectModel)
  let url = self.applicationDocumentsDirectory.URLByAppendingPathComponent(&quot;Coredata.sqlite&quot;)
  var error: NSError? = nil
  var failureReason = &quot;There was an error creating or loading the application&#39;s saved data.&quot;
  if coordinator!.addPersistentStoreWithType(NSSQLiteStoreType, configuration: nil, URL: url, options: nil, error: &amp;error) == nil &#123;
      coordinator = nil
      // Report any error we got.
      let dict = NSMutableDictionary()
      dict[NSLocalizedDescriptionKey] = &quot;Failed to initialize the application&#39;s saved data&quot;
      dict[NSLocalizedFailureReasonErrorKey] = failureReason
      dict[NSUnderlyingErrorKey] = error
      error = NSError(domain: &quot;YOUR_ERROR_DOMAIN&quot;, code: 9999, userInfo: dict)
      // Replace this with code to handle the error appropriately.
      // abort() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.
      NSLog(&quot;Unresolved error \(error), \(error!.userInfo)&quot;)
      abort()
  &#125;
  return coordinator
</code></pre>
<p>  }()</p>
<pre><code>  lazy var managedObjectContext: NSManagedObjectContext? = &#123;
  // Returns the managed object context for the application (which is already bound to the persistent store coordinator for the application.) This property is optional since there are legitimate error conditions that could cause the creation of the context to fail.
  let coordinator = self.persistentStoreCoordinator
  if coordinator == nil &#123;
      return nil
  &#125;
  var managedObjectContext = NSManagedObjectContext()
  managedObjectContext.persistentStoreCoordinator = coordinator
  return managedObjectContext
</code></pre>
<p>  }()</p>
<pre><code>  // MARK: - Core Data Saving support

  func saveContext () &#123;
  if let moc = self.managedObjectContext &#123;
      var error: NSError? = nil
      if moc.hasChanges &amp;&amp; !moc.save(&amp;error) &#123;
          // Replace this implementation with code to handle the error appropriately.
          // abort() causes the application to generate a crash log and terminate. You should not use this function in a shipping application, although it may be useful during development.
          NSLog(&quot;Unresolved error \(error), \(error!.userInfo)&quot;)
          abort()
      &#125;
  &#125;
</code></pre>
<p>  }</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   接著建立物件託管模型</span><br><span class="line">[![](https:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-KK3Tu_Vazbk&#x2F;VQJTyV8AxfI&#x2F;AAAAAAAAEj8&#x2F;YqCpExRBFF0&#x2F;s400&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-13%2B%E4%B8%8A%E5%8D%8811.02.54.png)](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-KK3Tu_Vazbk&#x2F;VQJTyV8AxfI&#x2F;AAAAAAAAEj8&#x2F;YqCpExRBFF0&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-13%2B%E4%B8%8A%E5%8D%8811.02.54.png)</span><br><span class="line">*   接著建立Entities</span><br><span class="line">[![](https:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-D2JtYHHTBxI&#x2F;VQJUguKuVhI&#x2F;AAAAAAAAEkE&#x2F;2vxmi1ktG4U&#x2F;s400&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-13%2B%E4%B8%8A%E5%8D%8811.07.18.png)](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-D2JtYHHTBxI&#x2F;VQJUguKuVhI&#x2F;AAAAAAAAEkE&#x2F;2vxmi1ktG4U&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-13%2B%E4%B8%8A%E5%8D%8811.07.18.png)</span><br><span class="line">＊**&lt;span style&#x3D;&quot;color: blue;&quot;&gt;圖片需要用Binary Data來儲存 &lt;&#x2F;span&gt;**</span><br><span class="line">*   接著建立Class來對應Entity &#96;&#96;&#96;js</span><br><span class="line">import Foundation</span><br><span class="line">import CoreData</span><br><span class="line">class Friend:NSManagedObject  &#123;</span><br><span class="line">    @NSManaged var name:String!</span><br><span class="line">    @NSManaged var tel:NSNumber!</span><br><span class="line">    @NSManaged var picture:NSData!</span><br><span class="line">    @NSManaged var marry:NSNumber!</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><span style="color: blue;">＊對應Entity中的Boolean, Integer, Float and Double attributes,都是用NSNumber</span></p>
<ul>
<li>  接著設定Entity與Class的對應關係,如圖：<br><a href="http://4.bp.blogspot.com/-A0tdcw2Qows/VQJY1R04ztI/AAAAAAAAEkQ/EyxFjlRa7YY/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-13%2B%E4%B8%8A%E5%8D%8811.25.50.png"><img src="https://4.bp.blogspot.com/-A0tdcw2Qows/VQJY1R04ztI/AAAAAAAAEkQ/EyxFjlRa7YY/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-13%2B%E4%B8%8A%E5%8D%8811.25.50.png"></a><br>這樣託管物件的建立就已經完成了,下一篇介紹如何叫用</li>
</ul>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>【SQL】Output</title>
    <url>/2019/05/07/sql_output/</url>
    <content><![CDATA[<p><img src="/images/20190507/0.jpg" alt="/images/20190507/0.jpg"></p>
<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>DBA 反應偵測到有個 Update Query 很頻繁，且通常緊接著 Update 後都會再進 Select 把剛剛 Update 的資料拉走，資料量太大時頻率太高導致 SQL 效能瓶頸，建議調整成 Update 後直接把剛剛異動的資料拉走，而不是拆兩段查詢。</p>
<h1 id="解決方案"><a href="#解決方案" class="headerlink" title="解決方案"></a>解決方案</h1><p>當 SQL Server 執行 Update 時會 Lock 相關要異動的資料，並把異動前後的資料放入 Log 中，如果希望能在一次 Query 中就把資料 Update 並把影響到的資料回傳，可以透過 <code>Ouput </code> 這個子句來達成</p>
<div class="note info">
            <p>Ouput 可用於以下情境</p><p>Delete</p><p>Insert</p><p>Update</p><p>Merge</p>
          </div>

<p>我們有一張表，紀載著每個人的名稱與學期分數</p>
<p><img src="/images/20190507/1.png" alt="/images/20190507/1.png"></p>
<p>老師大發慈悲想把低於 60 分的人都改成 60 分及格，這時候語法可以這樣下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@UpdateLog</span> <span class="keyword">table</span>(</span><br><span class="line">	Id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">	Name nvarchar(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">	OriScore <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">	NewScore <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">UPDATE dbo.[<span class="keyword">User</span>]</span><br><span class="line"><span class="keyword">SET</span> Score <span class="operator">=</span> <span class="number">60</span></span><br><span class="line">OUTPUT INSERTED.Id,</span><br><span class="line">	   INSERTED.Name,</span><br><span class="line">	   DELETED.Score,</span><br><span class="line">	   INSERTED.Score</span><br><span class="line"><span class="keyword">INTO</span> <span class="variable">@UpdateLog</span></span><br><span class="line"><span class="keyword">WHERE</span> Score <span class="operator">&lt;</span> <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="variable">@UpdateLog</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/20190507/2.png" alt="/images/20190507/2.png"></p>
<div class="note info">
            <p>參考資料</p><p><a href="https://docs.microsoft.com/zh-tw/sql/t-sql/queries/output-clause-transact-sql?view=sql-server-2017">Microsoft - OUTPUT 子句 (Transact-SQL)</a></p><p><a href="https://www.essentialsql.com/sql-update-statement/">Use SQL UPDATE to Query and Modify Data</a></p>
          </div>

]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift]  CoreData (2) 新增,刪除CoreData資料</title>
    <url>/2015/03/13/swift-CoreData-2-%E6%96%B0%E5%A2%9E-%E5%88%AA%E9%99%A4CoreData%E8%B3%87%E6%96%99/</url>
    <content><![CDATA[<p>這邊做個簡單的介面,讓TableView的資料來自資料庫,並能把資料存到資料庫裡面<br><a href="http://1.bp.blogspot.com/-Uz3JfDAuaic/VQKFrHxDa-I/AAAAAAAAEkg/2DXXn3_CA6o/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-13%2B%E4%B8%8B%E5%8D%882.35.33.png"><img src="http://1.bp.blogspot.com/-Uz3JfDAuaic/VQKFrHxDa-I/AAAAAAAAEkg/2DXXn3_CA6o/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-13%2B%E4%B8%8B%E5%8D%882.35.33.png"></a> </p>
<ul>
<li><p>首先先把TableView的資料來源設定成來自資料庫,完整程式碼如下,這樣就已經把Table的datasource friends來源改成SQLite了 ```swift<br>import UIKit<br>import CoreData<br>class ViewController: UIViewController , UITableViewDelegate , UITableViewDataSource, NSFetchedResultsControllerDelegate{<br>  @IBOutlet weak var tableview: UITableView!<br>  var friends : [Friend] = []<br>  var fetchRequestController:NSFetchedResultsController!<br>  override func viewDidLoad() {</p>
<pre><code>  super.viewDidLoad()
  //讀取Friend的Entity
  var fetchRequest = NSFetchRequest(entityName: &quot;Friend&quot;)
  //排序方式用name這個欄位
  let sortDescriptor = NSSortDescriptor(key: &quot;name&quot;, ascending: true)
  fetchRequest.sortDescriptors = [sortDescriptor]
  if let managedObjectContext = (UIApplication.sharedApplication().delegate as AppDelegate).managedObjectContext&#123;
      fetchRequestController = NSFetchedResultsController(fetchRequest: fetchRequest, managedObjectContext: managedObjectContext, sectionNameKeyPath: nil, cacheName: nil)
      //delegate設定為自己時,當新增修改刪除SQLite的資料時會呼叫以下事件
      //controllerWillChangeContent()
      //controller(_:didChangeObject:atIndexPath:forChangeType:newIndexPath:)
      //controllerDidChangeContent(_:)
      fetchRequestController.delegate = self
      var e:NSError?
      var result = fetchRequestController.performFetch(&amp;e)
      friends = fetchRequestController.fetchedObjects as [Friend]
      if result != true&#123;
           println(e?.localizedDescription)
      &#125;
  &#125;
</code></pre>
<p>  }</p>
<pre><code>  override func didReceiveMemoryWarning() &#123;
  super.didReceiveMemoryWarning()
  // Dispose of any resources that can be recreated.
</code></pre>
<p>  }</p>
<pre><code>  func tableView(tableView: UITableView, cellForRowAtIndexPath indexPath: NSIndexPath) -&gt; UITableViewCell &#123;
  let identifier = &quot;cell&quot;
  var cell = tableView.dequeueReusableCellWithIdentifier(identifier) as customCell
  cell.nameLabel.text = friends[indexPath.row].name
  cell.telLabel.text = friends[indexPath.row].tel.stringValue
  cell.picImageView.image = UIImage(data: friends[indexPath.row].picture)
  cell.marryLabel.text = friends[indexPath.row].marry.boolValue ? &quot;YES&quot; : &quot;NO&quot;
  return cell
</code></pre>
<p>  }</p>
<pre><code>  func tableView(tableView: UITableView, numberOfRowsInSection section: Int) -&gt; Int &#123;
  return friends.count
</code></pre>
<p>  }<br>}</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   接著寫按下save後的事件將檔案能寫到資料庫中,在這之前先處理Yes and no的按鈕和載入圖片按鈕</span><br><span class="line">Yes and No按鈕 &#96;&#96;&#96;swift</span><br><span class="line">@IBOutlet weak var YesButton: UIButton!</span><br><span class="line">    @IBOutlet weak var NoButton: UIButton!</span><br><span class="line"></span><br><span class="line">        @IBAction func MarryButtonClick(sender: AnyObject) &#123;</span><br><span class="line">        YesButton.backgroundColor &#x3D; (sender as UIButton &#x3D;&#x3D; YesButton) ? UIColor.redColor() : UIColor.lightGrayColor()</span><br><span class="line">        NoButton.backgroundColor &#x3D; (sender as UIButton &#x3D;&#x3D; NoButton) ? UIColor.redColor() : UIColor.lightGrayColor()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>實作載入圖片的按鈕,需要讓viewController實作UIImagePickerControllerDelegate和UINavigationControllerDelegate</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span>: <span class="title">UIViewController</span> , <span class="title">UITableViewDelegate</span> , <span class="title">UITableViewDataSource</span>, <span class="title">NSFetchedResultsControllerDelegate</span> , <span class="title">UIImagePickerControllerDelegate</span>,<span class="title">UINavigationControllerDelegate</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>selectPicture的按鈕 ```swift<br>@IBAction func SelectPictureClick(sender: AnyObject) {<br>        let imagePicker = UIImagePickerController()<br>        imagePicker.allowsEditing = false<br>        imagePicker.sourceType = UIImagePickerControllerSourceType.PhotoLibrary<br>        imagePicker.delegate = self<br>        //顯示挑選圖片的視窗<br>        self.presentViewController(imagePicker, animated: true, completion: nil)<br>    }<br>    func imagePickerController(picker: UIImagePickerController, didFinishPickingMediaWithInfo info: [NSObject : AnyObject]) {<br>        PicImageView.image = info[UIImagePickerControllerOriginalImage] as? UIImage<br>        PicImageView.contentMode = UIViewContentMode.ScaleAspectFill<br>        PicImageView.clipsToBounds = true<br>        //關閉挑選圖片的視窗<br>        dismissViewControllerAnimated(true, completion: nil)<br>    }</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">接著執行看看應該結果[![](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-2NW3TefbDxE&#x2F;VQK1HNE_8rI&#x2F;AAAAAAAAEkw&#x2F;l2v6Div6BYA&#x2F;s400&#x2F;test.gif)](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-2NW3TefbDxE&#x2F;VQK1HNE_8rI&#x2F;AAAAAAAAEkw&#x2F;l2v6Div6BYA&#x2F;s1600&#x2F;test.gif)</span><br><span class="line">*   接著把Save按鈕按下後存到SQLite的事件寫好 &#96;&#96;&#96;swift</span><br><span class="line">@IBAction func SaveClick(sender: AnyObject) &#123;</span><br><span class="line">        if let manageObjectContext &#x3D; (UIApplication.sharedApplication().delegate as AppDelegate).managedObjectContext&#123;</span><br><span class="line">            var friend &#x3D; NSEntityDescription.insertNewObjectForEntityForName(&quot;Friend&quot;, inManagedObjectContext: manageObjectContext) as Friend</span><br><span class="line">            friend.name &#x3D; NameTextField.text</span><br><span class="line">            friend.tel &#x3D; TelTextField.text.toInt()</span><br><span class="line">            friend.marry &#x3D; (YesButton.backgroundColor &#x3D;&#x3D; UIColor.redColor()) ? true : false</span><br><span class="line">            friend.picture &#x3D; UIImagePNGRepresentation(PicImageView.image)</span><br><span class="line">            var e:NSError?</span><br><span class="line">            if manageObjectContext.save(&amp;e) !&#x3D; true&#123;</span><br><span class="line">                println(&quot;error: \(e?.localizedDescription)&quot;)</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接著執行看看會發現按了儲存按鈕後雖然存進資料庫了,但沒有讓TableView馬上連動顯示,必須重新開APP才會顯示在table上*   還記得之前有繼承NSFetchedResultsControllerDelegate嗎?這時候派上用場了,補上幾個事件讓他可以跟TableView連動吧 ```swift<br>//資料庫準備更新了<br>    func controllerWillChangeContent(controller: NSFetchedResultsController) {<br>        tableview.beginUpdates()<br>    }<br>    func controller(controller: NSFetchedResultsController, didChangeObject anObject: AnyObject, atIndexPath indexPath: NSIndexPath?, forChangeType type: NSFetchedResultsChangeType, newIndexPath: NSIndexPath?) {<br>        switch type{<br>        case .Insert:<br>            tableview.insertRowsAtIndexPaths([newIndexPath!], withRowAnimation: UITableViewRowAnimation.Fade)<br>        case .Delete:<br>            tableview.deleteRowsAtIndexPaths([indexPath!], withRowAnimation: UITableViewRowAnimation.Fade)<br>        case .Update:<br>            tableview.reloadRowsAtIndexPaths([indexPath!], withRowAnimation: UITableViewRowAnimation.Fade)<br>        default:<br>            tableview.reloadData()<br>        }<br>        friends = controller.fetchedObjects as [Friend]<br>    }<br>    func controllerDidChangeContent(controller: NSFetchedResultsController) {<br>        tableview.endUpdates()<br>    }</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">接著再執行看看應該就可以看到他會馬上顯示了*   最後來個刪除吧！！這邊只舉例刪除該如何做,就不加到例子當中了 &#96;&#96;&#96;swift</span><br><span class="line">if let manageObjectContext &#x3D; (UIApplication.sharedApplication().delegate as AppDelegate).managedObjectContext&#123;</span><br><span class="line">            &#x2F;&#x2F;簡單說就是挑出那個想刪除的物件</span><br><span class="line">            var friendToDelete &#x3D; self.fetchRequestController.objectAtIndexPath(NSIndexPath(index: 0)) as Friend</span><br><span class="line">            &#x2F;&#x2F;呼叫刪除方法把它丟進去</span><br><span class="line">            manageObjectContext.deleteObject(friendToDelete)</span><br><span class="line">            var e:NSError?</span><br><span class="line">            &#x2F;&#x2F;儲存</span><br><span class="line">            if manageObjectContext.save(&amp;e) !&#x3D; true&#123;</span><br><span class="line">                println(&quot;error: \(e?.localizedDescription)&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<ul>
<li><p>基本上有操作過.NET Entity物件的話,這邊的概念幾乎都雷同,最後補上完整的程式碼 ```swift<br>import UIKit<br>import CoreData<br>class ViewController: UIViewController , UITableViewDelegate , UITableViewDataSource, UINavigationControllerDelegate ,NSFetchedResultsControllerDelegate , UIImagePickerControllerDelegate{<br>  @IBOutlet weak var tableview: UITableView!<br>  var friends : [Friend] = []<br>  var fetchRequestController:NSFetchedResultsController!<br>  @IBOutlet weak var NameTextField: UITextField!<br>  @IBOutlet weak var TelTextField: UITextField!<br>  @IBOutlet weak var PicImageView: UIImageView!<br>  @IBOutlet weak var YesButton: UIButton!<br>  @IBOutlet weak var NoButton: UIButton!<br>  override func viewDidLoad() {</p>
<pre><code>  super.viewDidLoad()
  //讀取Friend的Entity
  var fetchRequest = NSFetchRequest(entityName: &quot;Friend&quot;)
  //排序方式用name這個欄位
  let sortDescriptor = NSSortDescriptor(key: &quot;name&quot;, ascending: true)
  fetchRequest.sortDescriptors = [sortDescriptor]
  if let managedObjectContext = (UIApplication.sharedApplication().delegate as AppDelegate).managedObjectContext&#123;
      fetchRequestController = NSFetchedResultsController(fetchRequest: fetchRequest, managedObjectContext: managedObjectContext, sectionNameKeyPath: nil, cacheName: nil)
      //delegate設定為自己時,當新增修改刪除SQLite的資料時會呼叫以下事件
      //controllerWillChangeContent()
      //controller(_:didChangeObject:atIndexPath:forChangeType:newIndexPath:)
      //controllerDidChangeContent(_:)
      fetchRequestController.delegate = self
      var e:NSError?
      var result = fetchRequestController.performFetch(&amp;e)
      friends = fetchRequestController.fetchedObjects as [Friend]
      if result != true&#123;
           println(e?.localizedDescription)
      &#125;
  &#125;
</code></pre>
<p>  }</p>
<pre><code>  override func didReceiveMemoryWarning() &#123;
  super.didReceiveMemoryWarning()
  // Dispose of any resources that can be recreated.
</code></pre>
<p>  }</p>
<pre><code>  func tableView(tableView: UITableView, cellForRowAtIndexPath indexPath: NSIndexPath) -&gt; UITableViewCell &#123;
  let identifier = &quot;cell&quot;
  var cell = tableView.dequeueReusableCellWithIdentifier(identifier) as customCell
  cell.nameLabel.text = friends[indexPath.row].name
  cell.telLabel.text = friends[indexPath.row].tel.stringValue
  cell.picImageView.image = UIImage(data: friends[indexPath.row].picture)
  cell.marryLabel.text = friends[indexPath.row].marry.boolValue ? &quot;YES&quot; : &quot;NO&quot;
  return cell
</code></pre>
<p>  }</p>
<pre><code>  func tableView(tableView: UITableView, numberOfRowsInSection section: Int) -&gt; Int &#123;
  return friends.count
</code></pre>
<p>  }<br>  @IBAction func MarryButtonClick(sender: AnyObject) {</p>
<pre><code>  YesButton.backgroundColor = (sender as UIButton == YesButton) ? UIColor.redColor() : UIColor.lightGrayColor()
  NoButton.backgroundColor = (sender as UIButton == NoButton) ? UIColor.redColor() : UIColor.lightGrayColor()
</code></pre>
<p>  }<br>  @IBAction func SelectPictureClick(sender: AnyObject) {</p>
<pre><code>  let imagePicker = UIImagePickerController()
  imagePicker.allowsEditing = false
  imagePicker.sourceType = UIImagePickerControllerSourceType.PhotoLibrary
  imagePicker.delegate = self
  //顯示挑選圖片的視窗
  self.presentViewController(imagePicker, animated: true, completion: nil)
</code></pre>
<p>  }<br>  func imagePickerController(picker: UIImagePickerController, didFinishPickingMediaWithInfo info: [NSObject : AnyObject]) {</p>
<pre><code>  PicImageView.image = info[UIImagePickerControllerOriginalImage] as? UIImage
  PicImageView.contentMode = UIViewContentMode.ScaleAspectFill
  PicImageView.clipsToBounds = true
  //關閉挑選圖片的視窗
  dismissViewControllerAnimated(true, completion: nil)
</code></pre>
<p>  }<br>  @IBAction func SaveClick(sender: AnyObject) {</p>
<pre><code>  if let manageObjectContext = (UIApplication.sharedApplication().delegate as AppDelegate).managedObjectContext&#123;
      var friend = NSEntityDescription.insertNewObjectForEntityForName(&quot;Friend&quot;, inManagedObjectContext: manageObjectContext) as Friend
      friend.name = NameTextField.text
      friend.tel = TelTextField.text.toInt()
      friend.marry = (YesButton.backgroundColor == UIColor.redColor()) ? true : false
      friend.picture = UIImagePNGRepresentation(PicImageView.image)
      var e:NSError?
      if manageObjectContext.save(&amp;e) != true&#123;
          println(&quot;error: \(e?.localizedDescription)&quot;)
          return
      &#125;
  &#125;
</code></pre>
<p>  }<br>  //資料庫準備更新了<br>  func controllerWillChangeContent(controller: NSFetchedResultsController) {</p>
<pre><code>  tableview.beginUpdates()
</code></pre>
<p>  }<br>  func controller(controller: NSFetchedResultsController, didChangeObject anObject: AnyObject, atIndexPath indexPath: NSIndexPath?, forChangeType type: NSFetchedResultsChangeType, newIndexPath: NSIndexPath?) {</p>
<pre><code>  switch type&#123;
  case .Insert:
      tableview.insertRowsAtIndexPaths([newIndexPath!], withRowAnimation: UITableViewRowAnimation.Fade)
  case .Delete:
      tableview.deleteRowsAtIndexPaths([indexPath!], withRowAnimation: UITableViewRowAnimation.Fade)
  case .Update:
      tableview.reloadRowsAtIndexPaths([indexPath!], withRowAnimation: UITableViewRowAnimation.Fade)
  default:
      tableview.reloadData()
  &#125;
  friends = controller.fetchedObjects as [Friend]
</code></pre>
<p>  }<br>  func controllerDidChangeContent(controller: NSFetchedResultsController) {</p>
<pre><code>  tableview.endUpdates()
</code></pre>
<p>  }<br>}</p>
</li>
</ul>
<pre><code>
</code></pre>
]]></content>
  </entry>
  <entry>
    <title>[swift] IOS地圖運用 (1) 取得目前座標位置</title>
    <url>/2015/03/03/swift-IOS%E5%9C%B0%E5%9C%96%E9%81%8B%E7%94%A8-1-%E5%8F%96%E5%BE%97%E7%9B%AE%E5%89%8D%E5%BA%A7%E6%A8%99%E4%BD%8D%E7%BD%AE/</url>
    <content><![CDATA[<p>地圖資訊是手機很大量運用的資訊之一,接下來是來整理關於目前學到的MapKit View地圖的運用</p>
<ul>
<li><p>  首先先拉一個新的ViewController,並將MapKit View拉近去<br><a href="http://1.bp.blogspot.com/-E-lEkbuEGuw/VPUcOLnXUCI/AAAAAAAAEak/lUCmZ1i9-RA/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8810.27.49.png"><img src="http://1.bp.blogspot.com/-E-lEkbuEGuw/VPUcOLnXUCI/AAAAAAAAEak/lUCmZ1i9-RA/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8810.27.49.png"></a></p>
</li>
<li><p>接著在ViewController建立參數與MapKit View做對應,這邊需要注意的地方是用Map元件需要<strong>import MapKit</strong>```swift<br>import UIKit<br>import MapKit<br>class MapViewController: UIViewController {</p>
<pre><code>  @IBOutlet weak var uimap: MKMapView!//地圖元件
</code></pre>
<p>  override func viewDidLoad() {</p>
<pre><code>  super.viewDidLoad()
</code></pre>
<p>  }</p>
<pre><code>  override func didReceiveMemoryWarning() &#123;
  super.didReceiveMemoryWarning()
  // Dispose of any resources that can be recreated.
</code></pre>
<p>  }<br>}</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   取得座標資訊是由一個叫要做CLLocationManager來控制的,又IOS8取得座標資訊必須先取得使用者的授權才可以,所以必須到Info.plist新增NSLocationAlwaysUsageDescription或NSLocationWhenInUseUsageDescription兩種鍵值,而前者表示不管ＡＰＰ在前景或背景執行都會持續取得座標資訊,而後者只有在需要時才會去取座標定位資訊,而這兩個鍵值分別對應到CLLocationManager的requestAlwaysAuthorization和requestWhenInUseAuthorization,這邊的範例已NSLocationWhenInUseUsageDescription為例 &#96;&#96;&#96;swift</span><br><span class="line">import UIKit</span><br><span class="line">import CoreLocation</span><br><span class="line">import MapKit</span><br><span class="line">class MapViewController: UIViewController,CLLocationManagerDelegate &#123;</span><br><span class="line"></span><br><span class="line">        @IBOutlet weak var uimap: MKMapView!&#x2F;&#x2F;地圖元件</span><br><span class="line">    var location : CLLocationManager!; &#x2F;&#x2F;座標管理元件</span><br><span class="line">    override func viewDidLoad() &#123;</span><br><span class="line">        super.viewDidLoad();</span><br><span class="line"></span><br><span class="line">            location &#x3D; CLLocationManager();</span><br><span class="line">        location.delegate &#x3D; self;</span><br><span class="line">        &#x2F;&#x2F;詢問使用者是否同意給APP定位功能</span><br><span class="line">        location.requestWhenInUseAuthorization();</span><br><span class="line">        &#x2F;&#x2F;開始接收目前位置資訊</span><br><span class="line">        location.startUpdatingLocation();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        override func viewDidDisappear(animated: Bool) &#123;</span><br><span class="line">        &#x2F;&#x2F;因為ＧＰＳ功能很耗電,所以被敬執行時關閉定位功能</span><br><span class="line">        location.stopUpdatingLocation();</span><br><span class="line">    &#125;</span><br><span class="line">    func locationManager(manager: CLLocationManager!, didUpdateLocations locations: [AnyObject]!) &#123;</span><br><span class="line">        &#x2F;&#x2F;取得目前的座標位置</span><br><span class="line">        let c &#x3D; locations[0] as CLLocation;</span><br><span class="line">        &#x2F;&#x2F;c.coordinate.latitude 目前緯度</span><br><span class="line">        &#x2F;&#x2F;c.coordinate.longitude 目前經度</span><br><span class="line">        let nowLocation &#x3D; CLLocationCoordinate2D(latitude: c.coordinate.latitude, longitude: c.coordinate.longitude);</span><br><span class="line">        &#x2F;&#x2F;將map中心點定在目前所在的位置</span><br><span class="line">        &#x2F;&#x2F;span是地圖zoom in, zoom out的級距</span><br><span class="line">        let _span:MKCoordinateSpan &#x3D; MKCoordinateSpan(latitudeDelta: 0.0005, longitudeDelta: 0.0005);</span><br><span class="line">        self.uimap.setRegion(MKCoordinateRegion(center: nowLocation, span: _span), animated: true);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接著別忘了去Info.plist新增NSLocationWhenInUsageDescription</p>
<pre><code>[![](http://2.bp.blogspot.com/-FwRtS6qlxv0/VPUmFe5sNwI/AAAAAAAAEbI/ZBcSw4FmZKY/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8811.09.07.png)](http://2.bp.blogspot.com/-FwRtS6qlxv0/VPUmFe5sNwI/AAAAAAAAEbI/ZBcSw4FmZKY/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8811.09.07.png)
</code></pre>
<ul>
<li><p>接著執行看看！！</p>
<p>  詢問是否授權取得座標資訊<br><a href="http://4.bp.blogspot.com/-83KznhU8x60/VPUmGa8My2I/AAAAAAAAEbQ/KcQPz9Qjhrk/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8811.08.28.png"><img src="http://4.bp.blogspot.com/-83KznhU8x60/VPUmGa8My2I/AAAAAAAAEbQ/KcQPz9Qjhrk/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8811.08.28.png"></a><br>地圖中心點移到你目前的位置摟~<a href="http://3.bp.blogspot.com/-QvR128Ffqwk/VPUmImiWVqI/AAAAAAAAEbY/JihYA7S-IiI/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8811.08.40.png"><img src="http://3.bp.blogspot.com/-QvR128Ffqwk/VPUmImiWVqI/AAAAAAAAEbY/JihYA7S-IiI/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8811.08.40.png"></a></p>
</li>
<li><p>順帶一提,如果需要把使用者的位置座標顯示出來,在mapkit view設定檔將User Location打勾即可！！<a href="http://3.bp.blogspot.com/-k22IlXdhDv4/VPUnkb4FXnI/AAAAAAAAEbk/0zrmSaQchns/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8811.15.45.png"><img src="http://3.bp.blogspot.com/-k22IlXdhDv4/VPUnkb4FXnI/AAAAAAAAEbk/0zrmSaQchns/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8811.15.45.png"></a></p>
<p>  <a href="http://4.bp.blogspot.com/-pgo8PxqY7R8/VPUn0drmU1I/AAAAAAAAEbs/3WRtslmNJTM/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8811.17.10.png"><img src="http://4.bp.blogspot.com/-pgo8PxqY7R8/VPUn0drmU1I/AAAAAAAAEbs/3WRtslmNJTM/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8A%E5%8D%8811.17.10.png"></a></p>
</li>
<li><p>  如果你有實際run過這段程式應該會發現你滑動map時,它會一直彈回你目前所在的位置,原因是我們沒有指定移動多少距離才會更新座標位置,所以didUpdateLocations會一直被呼叫,也就一直被彈回你的所在位置摟,告訴app移動多少距離再更新座標資訊即可 ```swift<br>location.distanceFilter = CLLocationDistance(10); //表示移動10公尺再更新座標資訊</p>
</li>
</ul>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] Extension</title>
    <url>/2015/03/09/swift-Extension/</url>
    <content><![CDATA[<p>Swift這個語法常常會遇到參數型態間的轉換,寫慣了C#,常常遇到什麼參數轉換就會想要.toString() .toInt()阿之類的,偏偏Swift沒有這些function不打緊,還每種型態的變數互轉常常方式不一樣….搞得我每次遇到都要查一下到底這次又該用哪個function來轉換好,最後索性就把這些整理起來做成Extension,以後就跟C#一樣to啥to啥的就好.</p>
<ul>
<li>  那接下來就來介紹怎麼擴充Swift的function語法</li>
<li>extension是關鍵字,擴充String類別型態的function ```swift<br>extension String{<br>  func toDoublue() -&gt; Double{<pre><code>  return (self as NSString).doubleValue;
</code></pre>
  }<br>}</li>
</ul>
<p>```</p>
<ul>
<li>  結果<br><a href="http://2.bp.blogspot.com/-ScO8IMg64Mc/VPz-IPzpfGI/AAAAAAAAEg8/PUHhR5dzQrc/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-09%2B%E4%B8%8A%E5%8D%889.57.22.png"><img src="http://2.bp.blogspot.com/-ScO8IMg64Mc/VPz-IPzpfGI/AAAAAAAAEg8/PUHhR5dzQrc/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-09%2B%E4%B8%8A%E5%8D%889.57.22.png"></a></li>
</ul>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] IOS地圖運用 (2) 在地圖釘上大頭針</title>
    <url>/2015/03/03/swift-IOS%E5%9C%B0%E5%9C%96%E9%81%8B%E7%94%A8-2-%E5%9C%A8%E5%9C%B0%E5%9C%96%E9%87%98%E4%B8%8A%E5%A4%A7%E9%A0%AD%E9%87%9D/</url>
    <content><![CDATA[<p>承上一篇的Code我們繼續往下延伸,如何在地圖釘上大頭針呢?<br>首先我們把mapkit view的user location選項關閉,改成自己放上去的大頭針試試看</p>
<ul>
<li><p>把程式修改如下,這邊主要著重在<strong>addPointAnnotation</strong>這個function ```swift<br>import UIKit<br>import CoreLocation<br>import MapKit<br>class MapViewController: UIViewController,CLLocationManagerDelegate {</p>
<pre><code>  @IBOutlet weak var uimap: MKMapView!//地圖元件
</code></pre>
<p>  var location : CLLocationManager!; //座標管理元件<br>  override func viewDidLoad() {</p>
<pre><code>  super.viewDidLoad();

      location = CLLocationManager();
  location.delegate = self;
  //詢問使用者是否同意給APP定位功能
  location.requestWhenInUseAuthorization();
  //開始接收目前位置資訊
  location.startUpdatingLocation();
  location.distanceFilter = CLLocationDistance(10); //表示移動10公尺再更新座標資訊
</code></pre>
<p>  }</p>
<pre><code>  override func viewDidDisappear(animated: Bool) &#123;
  //因為ＧＰＳ功能很耗電,所以被敬執行時關閉定位功能
  location.stopUpdatingLocation();
</code></pre>
<p>  }<br>  func locationManager(manager: CLLocationManager!, didUpdateLocations locations: [AnyObject]!) {</p>
<pre><code>  //取得目前的座標位置
  let c = locations[0] as CLLocation;
  let nowLocation = CLLocationCoordinate2D(latitude: c.coordinate.latitude, longitude: c.coordinate.longitude);
  //將map中心點定在目前所在的位置
  //span是地圖zoom in, zoom out的級距
  let _span:MKCoordinateSpan = MKCoordinateSpan(latitudeDelta: 0.0005, longitudeDelta: 0.0005);
  self.uimap.setRegion(MKCoordinateRegion(center: nowLocation, span: _span), animated: true);
  //加入座標
  addPointAnnotation(c.coordinate.latitude, longitude: c.coordinate.longitude);
</code></pre>
<p>  }<br>  //新增座標<br>  private func addPointAnnotation(latitude:CLLocationDegrees , longitude:CLLocationDegrees){</p>
<pre><code>  //大頭針
  var point:MKPointAnnotation = MKPointAnnotation();
  //設定大頭針的座標位置
  point.coordinate = CLLocationCoordinate2D(latitude: latitude, longitude: longitude);
  point.title = &quot;I&#39;m here&quot;;
  point.subtitle = &quot;緯度：\(latitude) 經度:\(longitude)&quot;;
  uimap.addAnnotation(point);
</code></pre>
<p>  }<br>}</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">執行看看成果,點擊大頭貼可以看到剛剛設定的title與subtitle</span><br><span class="line">[![](http:&#x2F;&#x2F;2.bp.blogspot.com&#x2F;-sBszQR-gCvw&#x2F;VPVRTFVx06I&#x2F;AAAAAAAAEb8&#x2F;wR8k2LQSLvI&#x2F;s400&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%882.14.19.png)](http:&#x2F;&#x2F;2.bp.blogspot.com&#x2F;-sBszQR-gCvw&#x2F;VPVRTFVx06I&#x2F;AAAAAAAAEb8&#x2F;wR8k2LQSLvI&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%882.14.19.png)</span><br><span class="line">*   那如果想將大頭針變色呢?</span><br><span class="line">首先先將view controller繼承MKMapViewDelegate,並將mapview kit delegate指定為自己這個veiew controller &#96;&#96;&#96;swift</span><br><span class="line">uimap.delegate &#x3D; self;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>接著override mapview的viewForAnnotation事件 ```swift<br>func mapView(mapView: MKMapView!, viewForAnnotation annotation: MKAnnotation!) -&gt; MKAnnotationView! {<br> var pointView : MKPinAnnotationView? = mapView.dequeueReusableAnnotationViewWithIdentifier(“CustomerPoint”) as?MKPinAnnotationView;<br> if(pointView == nil){<pre><code>pointView = MKPinAnnotationView(annotation: annotation, reuseIdentifier: &quot;CustomerPoint&quot;);
//因為已經改寫了Annotation View,所以要將canShowCallout改成true,否則點擊大頭針不會跑出來我們剛剛指定的title跟subtitle
pointView?.canShowCallout = true;
</code></pre>
 }<br> pointView!.pinColor = MKPinAnnotationColor.Green;<br> return pointView;<br>}</li>
</ul>
<p>```</p>
<ul>
<li>  結果如下<br><a href="http://3.bp.blogspot.com/-o61FEuAowEI/VPVXMMc1FdI/AAAAAAAAEcM/wuAceakTI7w/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%882.39.25.png"><img src="http://3.bp.blogspot.com/-o61FEuAowEI/VPVXMMc1FdI/AAAAAAAAEcM/wuAceakTI7w/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%882.39.25.png"></a></li>
<li>  這邊應該看出來整個Annotation的顯示方式都可以透過viewForAnnotation這個事件來改寫,所以下一篇就來介紹如何客製化Annotation的View</li>
</ul>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] IOS地圖運用 (3) 客製Annotation View</title>
    <url>/2015/03/03/swift-IOS%E5%9C%B0%E5%9C%96%E9%81%8B%E7%94%A8-3-%E5%AE%A2%E8%A3%BDAnnotation-View/</url>
    <content><![CDATA[<p>繼續接續上一篇,我們來把大頭針改成自己想要的樣子吧,已這張圖為例<br><a href="http://3.bp.blogspot.com/-4mt5Vk9Y36A/VPVgIcev6II/AAAAAAAAEcc/DaA8w4qoIvs/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%883.17.25.png"><img src="http://3.bp.blogspot.com/-4mt5Vk9Y36A/VPVgIcev6II/AAAAAAAAEcc/DaA8w4qoIvs/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%883.17.25.png"></a></p>
<ul>
<li><p>從上面那張圖可以看出來需要畫一個長方形,長方形裡面有一個title與圓形Icon,還需要一個倒三角形把它組回去,所以先來把這些元素準備一下吧<br>首先先建立一個Class繼承MKAnnotationView ```swift<br>import Foundation<br>import MapKit<br>public class MyAnnotation : MKAnnotationView  {<br>  var rectangoView:UIView!; //長方形<br>  var lblTitle:UILabel!;//Title<br>  var lblIcon:UILabel!;//圓形icon<br>  var circleView:UIView!; //原型view<br>  var triangle:UIView!; //三角形<br>  public override init(annotation: MKAnnotation!, reuseIdentifier: String!) {</p>
<pre><code>  super.init(annotation: annotation, reuseIdentifier: reuseIdentifier);
</code></pre>
<p>  }</p>
<pre><code>  public required init(coder aDecoder: NSCoder) &#123;
  super.init(coder: aDecoder);
</code></pre>
<p>  }<br>}</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   接著把每個圖形間的關係組合起來,例如圓形跟title都在大大的長方形裡面,所以先將他們add到rectangoView裡面 &#96;&#96;&#96;swift</span><br><span class="line">import Foundation</span><br><span class="line">import MapKit</span><br><span class="line">public class MyAnnotation : MKAnnotationView  &#123;</span><br><span class="line">    var rectangoView:UIView!; &#x2F;&#x2F;長方形</span><br><span class="line">    var lblTitle:UILabel!;&#x2F;&#x2F;Title</span><br><span class="line">    var lblIcon:UILabel!;&#x2F;&#x2F;圓形icon</span><br><span class="line">    var circleView:UIView!; &#x2F;&#x2F;原型view</span><br><span class="line">    var triangle:UIView!; &#x2F;&#x2F;三角形</span><br><span class="line">    var DrawView:UIView!;&#x2F;&#x2F;整個客製座標的畫布</span><br><span class="line">    public override init!(annotation: MKAnnotation!, reuseIdentifier: String!) &#123;</span><br><span class="line">        super.init(annotation: annotation, reuseIdentifier: reuseIdentifier);</span><br><span class="line">        &#x2F;&#x2F;先把每個圖層間的關係建立好,例如圓形跟title都在大大的長方形裡面,所以先add進去</span><br><span class="line">        lblTitle &#x3D; UILabel();</span><br><span class="line">        lblIcon &#x3D; UILabel();</span><br><span class="line">        rectangoView &#x3D; UIView();</span><br><span class="line">        circleView &#x3D; UIView();</span><br><span class="line"></span><br><span class="line">            circleView.addSubview(lblIcon);</span><br><span class="line">        rectangoView.addSubview(lblTitle)</span><br><span class="line">        rectangoView.addSubview(circleView);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;畫出三角形遮罩</span><br><span class="line">        &#x2F;&#x2F;原理：將遮罩蓋到長方形上面,他會將不再這個框框範圍內的都過濾掉,就可以跑出三角形了</span><br><span class="line">        let path:UIBezierPath &#x3D; UIBezierPath ();</span><br><span class="line">        path.moveToPoint(CGPoint(x: 0, y: 0));</span><br><span class="line">        path.addLineToPoint(CGPoint(x: 10, y: 10));</span><br><span class="line">        path.addLineToPoint(CGPoint(x: 20, y: 0));</span><br><span class="line">        path.addLineToPoint(CGPoint(x: 0, y: 0));</span><br><span class="line"></span><br><span class="line">            let masklayer:CAShapeLayer &#x3D; CAShapeLayer ();&#x2F;&#x2F;遮罩</span><br><span class="line">        masklayer.path &#x3D; path.CGPath;</span><br><span class="line">        &#x2F;&#x2F;遮罩遮出三角型</span><br><span class="line">        triangle &#x3D; UIView(frame: CGRect(x: 22, y: 28, width: 20, height: 20));</span><br><span class="line">        triangle.layer.mask &#x3D; masklayer;</span><br><span class="line">        DrawView &#x3D; UIView();</span><br><span class="line">        DrawView.addSubview(rectangoView);</span><br><span class="line">        DrawView.addSubview(triangle);</span><br><span class="line">        self.addSubview(DrawView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        public required init(coder aDecoder: NSCoder) &#123;</span><br><span class="line">        super.init(coder: aDecoder);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>接著在MyAnnotation寫一個function來詳細畫這個View的內容 ```swift<br>public func DrawCustomerView() {<pre><code>  //Title
  lblTitle.text = &quot;5200萬&quot;;
  lblTitle.textColor = UIColor.whiteColor();
  lblTitle.font = UIFont.systemFontOfSize(12);
  lblTitle.sizeToFit();
  //大大的長方形
  rectangoView.frame = CGRect(x: 0, y: 0, width: lblTitle.frame.width + 30, height: 28);//整體
  rectangoView.backgroundColor =  UIColor(red: 0.208, green:0.596 , blue: 0.859, alpha: 1);
  rectangoView.layer.cornerRadius = 3;//設定圓角
  //“icon”圓型小字
  lblIcon.font = UIFont.systemFontOfSize(11);
  lblIcon.font = UIFont.boldSystemFontOfSize(14);
  lblIcon.text = &quot;成&quot;;
  lblIcon.textColor = rectangoView.backgroundColor;
  lblIcon.sizeToFit();
  lblIcon.center = CGPoint (x: 10, y: 10);
  //圓形
  circleView.frame = CGRect(x: 2, y: 4, width: 20, height: 20);//圓形標籤
  circleView.backgroundColor = UIColor.whiteColor();
  circleView.layer.cornerRadius = 10;
  circleView.alpha = 1;
  //畫三角形
  triangle.backgroundColor =  UIColor(red: 0.208, green:0.596 , blue: 0.859, alpha: 1);
  //rectangoView.Transform 旋轉
  DrawView.frame = CGRect(x: 0, y: 0, width:triangle.frame.width,height: 48);
</code></pre>
  }</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   接下來修改view controller的viewForAnnotation事件如下 &#96;&#96;&#96;swift</span><br><span class="line">func mapView(mapView: MKMapView!, viewForAnnotation annotation: MKAnnotation!) -&gt; MKAnnotationView! &#123;</span><br><span class="line">        var ann : MyAnnotation? &#x3D; mapView.dequeueReusableAnnotationViewWithIdentifier(&quot;CustomerPoint&quot;) as? MyAnnotation;</span><br><span class="line">        if(ann &#x3D;&#x3D; nil)&#123;</span><br><span class="line">            ann &#x3D; MyAnnotation(annotation: annotation, reuseIdentifier: &quot;CustomerPoint&quot;);</span><br><span class="line">            ann?.canShowCallout &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">        ann?.DrawCustomerView();</span><br><span class="line">        ann?.annotation &#x3D; annotation;</span><br><span class="line">        return ann;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>立馬執行看看,你會發現發生錯誤在MyAnnotation class,而且錯誤訊息寫得不清不楚的,這是第一個地雷,雖然繼承MKAnnotationView沒有要求一定要實作init(frame: CGRect),但不做會壞掉喔,那到底幹麻不列為required阿！！！所以乖乖補上到MyAnnotation就正常摟 ```swift<br>override init(frame: CGRect) {<pre><code>  super.init(frame: frame);
</code></pre>
  }</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   這時候會發現畫面長這樣...</span><br><span class="line">[![](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-OGPbgnJnyH0&#x2F;VPVpfcMNstI&#x2F;AAAAAAAAEcs&#x2F;NGAf74G1IoU&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%883.57.37.png)](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-OGPbgnJnyH0&#x2F;VPVpfcMNstI&#x2F;AAAAAAAAEcs&#x2F;NGAf74G1IoU&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%883.57.37.png)</span><br><span class="line">請在DrawCustomerView這個地方補上下面這段code,讓文字位移後執行看看會變得正常多了 &#96;&#96;&#96;swift</span><br><span class="line">lblTitle.frame.origin.x &#x3D; 24;&#x2F;&#x2F;中心位移</span><br><span class="line">lblTitle.frame.origin.y &#x3D; 7;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>  接下來我們測試一下這個畫出來的點是否跟插大頭針指的位置相同,結果…..歪掉了<br><a href="http://4.bp.blogspot.com/-1SWxrDjmc4c/VPVr5NKYmcI/AAAAAAAAEc4/VFG_Zo4MqHE/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%884.07.30.png"><img src="http://4.bp.blogspot.com/-1SWxrDjmc4c/VPVr5NKYmcI/AAAAAAAAEc4/VFG_Zo4MqHE/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%884.07.30.png"></a></li>
<li>但我們可以看出來他是在針頭的地方開始畫,所以來做點加工吧,在DrawCustomerView()最後面加上下面的code讓整個View位移來符合需求 ```swift<br>self.frame = CGRect(x: 0, y: 0, width: rectangoView.frame.width, height: rectangoView.frame.height);<pre><code>  self.centerOffset = CGPoint(x: 0, y: -21);
</code></pre>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">我們再看看...</span><br><span class="line">[![](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-mPNj85zu_a8&#x2F;VPVsk5Xv-9I&#x2F;AAAAAAAAEdA&#x2F;faM54vpHC28&#x2F;s400&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%884.10.45.png)](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-mPNj85zu_a8&#x2F;VPVsk5Xv-9I&#x2F;AAAAAAAAEdA&#x2F;faM54vpHC28&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%884.10.45.png)</span><br><span class="line">*   看起來一切正常了,把一些測試的程式碼拿掉後完整如下</span><br><span class="line">view controller &#96;&#96;&#96;swift</span><br><span class="line">import UIKit</span><br><span class="line">import CoreLocation</span><br><span class="line">import MapKit</span><br><span class="line">class MapViewController: UIViewController,CLLocationManagerDelegate , MKMapViewDelegate&#123;</span><br><span class="line"></span><br><span class="line">        @IBOutlet weak var uimap: MKMapView!&#x2F;&#x2F;地圖元件</span><br><span class="line">    var location : CLLocationManager!; &#x2F;&#x2F;座標管理元件</span><br><span class="line">    override func viewDidLoad() &#123;</span><br><span class="line">        super.viewDidLoad();</span><br><span class="line"></span><br><span class="line">            location &#x3D; CLLocationManager();</span><br><span class="line">        location.delegate &#x3D; self;</span><br><span class="line">        &#x2F;&#x2F;詢問使用者是否同意給APP定位功能</span><br><span class="line">        location.requestWhenInUseAuthorization();</span><br><span class="line">        &#x2F;&#x2F;開始接收目前位置資訊</span><br><span class="line">        location.startUpdatingLocation();</span><br><span class="line">        location.distanceFilter &#x3D; CLLocationDistance(10); &#x2F;&#x2F;表示移動10公尺再更新座標資訊</span><br><span class="line">        uimap.delegate &#x3D; self;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        override func viewDidDisappear(animated: Bool) &#123;</span><br><span class="line">        &#x2F;&#x2F;因為ＧＰＳ功能很耗電,所以被敬執行時關閉定位功能</span><br><span class="line">        location.stopUpdatingLocation();</span><br><span class="line">    &#125;</span><br><span class="line">    func locationManager(manager: CLLocationManager!, didUpdateLocations locations: [AnyObject]!) &#123;</span><br><span class="line">        &#x2F;&#x2F;取得目前的座標位置</span><br><span class="line">        let c &#x3D; locations[0] as CLLocation;</span><br><span class="line">        let nowLocation &#x3D; CLLocationCoordinate2D(latitude: c.coordinate.latitude, longitude: c.coordinate.longitude);</span><br><span class="line">        &#x2F;&#x2F;將map中心點定在目前所在的位置</span><br><span class="line">        &#x2F;&#x2F;span是地圖zoom in, zoom out的級距</span><br><span class="line">        let _span:MKCoordinateSpan &#x3D; MKCoordinateSpan(latitudeDelta: 0.0005, longitudeDelta: 0.0005);</span><br><span class="line">        self.uimap.setRegion(MKCoordinateRegion(center: nowLocation, span: _span), animated: true);</span><br><span class="line">        &#x2F;&#x2F;加入座標</span><br><span class="line">        addPointAnnotation(c.coordinate.latitude, longitude: c.coordinate.longitude);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;新增座標</span><br><span class="line">    private func addPointAnnotation(latitude:CLLocationDegrees , longitude:CLLocationDegrees)&#123;</span><br><span class="line">        &#x2F;&#x2F;大頭針</span><br><span class="line">        var point:MKPointAnnotation &#x3D; MKPointAnnotation();</span><br><span class="line">        &#x2F;&#x2F;設定大頭針的座標位置</span><br><span class="line">        point.coordinate &#x3D; CLLocationCoordinate2D(latitude: latitude, longitude: longitude);</span><br><span class="line">        uimap.addAnnotation(point);</span><br><span class="line">    &#125;</span><br><span class="line">    func mapView(mapView: MKMapView!, viewForAnnotation annotation: MKAnnotation!) -&gt; MKAnnotationView! &#123;</span><br><span class="line">        var ann : MyAnnotation? &#x3D; mapView.dequeueReusableAnnotationViewWithIdentifier(&quot;CustomerPoint&quot;) as? MyAnnotation;</span><br><span class="line">        if(ann &#x3D;&#x3D; nil)&#123;</span><br><span class="line">            ann &#x3D; MyAnnotation(annotation: annotation, reuseIdentifier: &quot;CustomerPoint&quot;);</span><br><span class="line">            ann?.canShowCallout &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">        ann?.DrawCustomerView();</span><br><span class="line">        ann?.annotation &#x3D; annotation;</span><br><span class="line">        return ann;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>MyAnnotation Class完整如下</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> Foundation</span><br><span class="line"><span class="keyword">import</span> MapKit</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAnnotation</span> : <span class="title">MKAnnotationView</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> rectangoView:<span class="type">UIView</span>!; <span class="comment">//長方形</span></span><br><span class="line">    <span class="keyword">var</span> lblTitle:<span class="type">UILabel</span>!;<span class="comment">//Title</span></span><br><span class="line">    <span class="keyword">var</span> lblIcon:<span class="type">UILabel</span>!;<span class="comment">//圓形icon</span></span><br><span class="line">    <span class="keyword">var</span> circleView:<span class="type">UIView</span>!; <span class="comment">//原型view</span></span><br><span class="line">    <span class="keyword">var</span> triangle:<span class="type">UIView</span>!; <span class="comment">//三角形</span></span><br><span class="line">    <span class="keyword">var</span> <span class="type">DrawView</span>:<span class="type">UIView</span>!;<span class="comment">//整個客製座標的畫布</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">init</span>(<span class="params">annotation</span>: <span class="type">MKAnnotation</span>!, <span class="params">reuseIdentifier</span>: <span class="type">String</span>!)</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(annotation: annotation, reuseIdentifier: reuseIdentifier);</span><br><span class="line">        <span class="comment">//先把每個圖層間的關係建立好,例如圓形跟title都在大大的長方形裡面,所以先add進去</span></span><br><span class="line">        lblTitle <span class="operator">=</span> <span class="type">UILabel</span>();</span><br><span class="line">        lblIcon <span class="operator">=</span> <span class="type">UILabel</span>();</span><br><span class="line">        rectangoView <span class="operator">=</span> <span class="type">UIView</span>();</span><br><span class="line">        circleView <span class="operator">=</span> <span class="type">UIView</span>();</span><br><span class="line"></span><br><span class="line">            circleView.addSubview(lblIcon);</span><br><span class="line">        rectangoView.addSubview(lblTitle)</span><br><span class="line">        rectangoView.addSubview(circleView);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//畫出三角形遮罩</span></span><br><span class="line">        <span class="comment">//原理：將遮罩蓋到長方形上面,他會將不再這個框框範圍內的都過濾掉,就可以跑出三角形了</span></span><br><span class="line">        <span class="keyword">let</span> path:<span class="type">UIBezierPath</span> <span class="operator">=</span> <span class="type">UIBezierPath</span> ();</span><br><span class="line">        path.moveToPoint(<span class="type">CGPoint</span>(x: <span class="number">0</span>, y: <span class="number">0</span>));</span><br><span class="line">        path.addLineToPoint(<span class="type">CGPoint</span>(x: <span class="number">10</span>, y: <span class="number">10</span>));</span><br><span class="line">        path.addLineToPoint(<span class="type">CGPoint</span>(x: <span class="number">20</span>, y: <span class="number">0</span>));</span><br><span class="line">        path.addLineToPoint(<span class="type">CGPoint</span>(x: <span class="number">0</span>, y: <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">let</span> masklayer:<span class="type">CAShapeLayer</span> <span class="operator">=</span> <span class="type">CAShapeLayer</span> ();<span class="comment">//遮罩</span></span><br><span class="line">        masklayer.path <span class="operator">=</span> path.<span class="type">CGPath</span>;</span><br><span class="line">        <span class="comment">//遮罩遮出三角型</span></span><br><span class="line">        triangle <span class="operator">=</span> <span class="type">UIView</span>(frame: <span class="type">CGRect</span>(x: <span class="number">22</span>, y: <span class="number">28</span>, width: <span class="number">20</span>, height: <span class="number">20</span>));</span><br><span class="line">        triangle.layer.mask <span class="operator">=</span> masklayer;</span><br><span class="line">        <span class="type">DrawView</span> <span class="operator">=</span> <span class="type">UIView</span>();</span><br><span class="line">        <span class="type">DrawView</span>.addSubview(rectangoView);</span><br><span class="line">        <span class="type">DrawView</span>.addSubview(triangle);</span><br><span class="line">        <span class="keyword">self</span>.addSubview(<span class="type">DrawView</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">required</span>  <span class="function"><span class="keyword">init</span>(<span class="params">coder</span> <span class="params">aDecoder</span>: <span class="type">NSCoder</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(coder: aDecoder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">init</span>(<span class="params">frame</span>: <span class="type">CGRect</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.<span class="keyword">init</span>(frame: frame);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">func</span> <span class="title">DrawCustomerView</span>()</span> &#123;</span><br><span class="line">        <span class="comment">//Title</span></span><br><span class="line">        lblTitle.text <span class="operator">=</span> <span class="string">&quot;5200萬&quot;</span>;</span><br><span class="line">        lblTitle.textColor <span class="operator">=</span> <span class="type">UIColor</span>.whiteColor();</span><br><span class="line">        lblTitle.font <span class="operator">=</span> <span class="type">UIFont</span>.systemFontOfSize(<span class="number">12</span>);</span><br><span class="line">        lblTitle.frame.origin.x <span class="operator">=</span> <span class="number">24</span>;<span class="comment">//中心位移</span></span><br><span class="line">        lblTitle.frame.origin.y <span class="operator">=</span> <span class="number">7</span>;</span><br><span class="line">        lblTitle.sizeToFit();</span><br><span class="line">        <span class="comment">//大大的長方形</span></span><br><span class="line">        rectangoView.frame <span class="operator">=</span> <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: lblTitle.frame.width <span class="operator">+</span> <span class="number">30</span>, height: <span class="number">28</span>);<span class="comment">//整體</span></span><br><span class="line">        rectangoView.backgroundColor <span class="operator">=</span>  <span class="type">UIColor</span>(red: <span class="number">0.208</span>, green:<span class="number">0.596</span> , blue: <span class="number">0.859</span>, alpha: <span class="number">1</span>);</span><br><span class="line">        rectangoView.layer.cornerRadius <span class="operator">=</span> <span class="number">3</span>;<span class="comment">//設定圓角</span></span><br><span class="line">        <span class="comment">//“icon”圓型小字</span></span><br><span class="line">        lblIcon.font <span class="operator">=</span> <span class="type">UIFont</span>.systemFontOfSize(<span class="number">11</span>);</span><br><span class="line">        lblIcon.font <span class="operator">=</span> <span class="type">UIFont</span>.boldSystemFontOfSize(<span class="number">14</span>);</span><br><span class="line">        lblIcon.text <span class="operator">=</span> <span class="string">&quot;成&quot;</span>;</span><br><span class="line">        lblIcon.textColor <span class="operator">=</span> rectangoView.backgroundColor;</span><br><span class="line">        lblIcon.sizeToFit();</span><br><span class="line">        lblIcon.center <span class="operator">=</span> <span class="type">CGPoint</span> (x: <span class="number">10</span>, y: <span class="number">10</span>);</span><br><span class="line">        <span class="comment">//圓形</span></span><br><span class="line">        circleView.frame <span class="operator">=</span> <span class="type">CGRect</span>(x: <span class="number">2</span>, y: <span class="number">4</span>, width: <span class="number">20</span>, height: <span class="number">20</span>);<span class="comment">//圓形標籤</span></span><br><span class="line">        circleView.backgroundColor <span class="operator">=</span> <span class="type">UIColor</span>.whiteColor();</span><br><span class="line">        circleView.layer.cornerRadius <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        circleView.alpha <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//畫三角形</span></span><br><span class="line">        triangle.backgroundColor <span class="operator">=</span>  <span class="type">UIColor</span>(red: <span class="number">0.208</span>, green:<span class="number">0.596</span> , blue: <span class="number">0.859</span>, alpha: <span class="number">1</span>);</span><br><span class="line">        <span class="comment">//rectangoView.Transform 旋轉</span></span><br><span class="line">        <span class="type">DrawView</span>.frame <span class="operator">=</span> <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width:triangle.frame.width,height: <span class="number">48</span>);</span><br><span class="line">        <span class="keyword">self</span>.frame <span class="operator">=</span> <span class="type">CGRect</span>(x: <span class="number">0</span>, y: <span class="number">0</span>, width: rectangoView.frame.width, height: rectangoView.frame.height);</span><br><span class="line">        <span class="keyword">self</span>.centerOffset <span class="operator">=</span> <span class="type">CGPoint</span>(x: <span class="number">0</span>, y: <span class="operator">-</span><span class="number">21</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift]Navigation Controller  (2) 傳遞參數</title>
    <url>/2015/03/03/swift-Navigation-Controller-2-%E5%82%B3%E9%81%9E%E5%8F%83%E6%95%B8/</url>
    <content><![CDATA[<p>如果要在換頁時讓PageA傳遞數值給PageB,並且在PageB顯示傳遞的參數時作法如下</p>
<ul>
<li>先在PageB的Controller新增一個Label,我們將用它來顯示PageA究竟傳了什麼過來```swift<br>import UIKit<br>class Page_B_ViewController: UIViewController {<br>  @IBOutlet weak var lblValue: UILabel!  //顯示傳遞數值的Label<br>  var fromA_Value:String!;//儲存Page_A傳遞過來的數值<br>  override func viewDidLoad() {<pre><code>  super.viewDidLoad();
  lblValue.text = fromA_Value;
</code></pre>
  }<br>}</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   接著在PageA Controller新增**prepareForSegue**事件 &#96;&#96;&#96;swift</span><br><span class="line">import UIKit</span><br><span class="line">class Page_A_ViewController: UIViewController &#123;</span><br><span class="line"></span><br><span class="line">        override func viewDidLoad() &#123;</span><br><span class="line">        super.viewDidLoad()</span><br><span class="line">        &#x2F;&#x2F;NavBar</span><br><span class="line">        self.navigationController?.navigationBar.barTintColor &#x3D; UIColor(red: 0.58, green: 0.761, blue: 0.231, alpha: 1)</span><br><span class="line">        let titleDic : NSDictionary &#x3D; [NSForegroundColorAttributeName : UIColor.whiteColor()]; &#x2F;&#x2F;字的顏色</span><br><span class="line">        self.navigationController?.navigationBar.titleTextAttributes &#x3D; titleDic;</span><br><span class="line">        self.navigationController?.navigationBar.tintColor &#x3D; UIColor.whiteColor() &#x2F;&#x2F;按鈕的顏色</span><br><span class="line">        let barOptionIcon : UIBarButtonItem &#x3D; UIBarButtonItem(image: UIImage(named: &quot;icon-options&quot;), style: UIBarButtonItemStyle.Plain, target: self, action: &quot;PushToOptionController:&quot;);</span><br><span class="line">        self.navigationController?.navigationBar.topItem?.setRightBarButtonItem(barOptionIcon, animated: true) ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">        override func didReceiveMemoryWarning() &#123;</span><br><span class="line">        super.didReceiveMemoryWarning()</span><br><span class="line">        &#x2F;&#x2F; Dispose of any resources that can be recreated.</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;右上角Button按下時觸發的事件</span><br><span class="line">    func PushToOptionController(sender: UIBarButtonItem) &#123;</span><br><span class="line">        self.performSegueWithIdentifier(&quot;toPageB&quot;, sender: self);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;準備跳轉頁面的設定</span><br><span class="line">    override func prepareForSegue(segue: UIStoryboardSegue, sender: AnyObject?) &#123;</span><br><span class="line">        if(segue.identifier &#x3D;&#x3D; &quot;toPageB&quot;)&#123;</span><br><span class="line">            var page_b:Page_B_ViewController? &#x3D; segue.destinationViewController as? Page_B_ViewController</span><br><span class="line">            if(page_b !&#x3D; nil)&#123;</span><br><span class="line">                page_b?.fromA_Value &#x3D; &quot;來自Ａ的數值&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>  完成!!!<br><a href="http://2.bp.blogspot.com/-s0lUoWMEDbc/VPUU1BIWAsI/AAAAAAAAEaU/i8iqxSCNW_w/s1600/image.gif"><img src="http://2.bp.blogspot.com/-s0lUoWMEDbc/VPUU1BIWAsI/AAAAAAAAEaU/i8iqxSCNW_w/s400/image.gif"></a></li>
</ul>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift]  IOS地圖運用 (6) 透過CLGeocoder轉換經緯度與地址</title>
    <url>/2015/03/12/swift-IOS%E5%9C%B0%E5%9C%96%E9%81%8B%E7%94%A8-6-%E9%80%8F%E9%81%8ECLGeocoder%E8%BD%89%E6%8F%9B%E7%B6%93%E7%B7%AF%E5%BA%A6%E8%88%87%E5%9C%B0%E5%9D%80/</url>
    <content><![CDATA[<p>IOS提供CLGeocoder將地址轉成經緯度,或是把經緯度轉換成地址,詳細語法如下 </p>
<ul>
<li>  記得先Import MapKit</li>
<li>地址轉經緯度(geocodeAddressString) ```swift<br>let geoCoder = CLGeocoder()<br>geoCoder.geocodeAddressString(“這邊帶入地址”, completionHandler: {<br> (placemarks:[AnyObject]!,error:NSError!) -&gt; Void in<br> if error != nil{<pre><code>println(error)
return
</code></pre>
 }<br> if placemarks != nil &amp;&amp; placemarks.count &gt; 0{<pre><code>let placemark = placemarks[0] as CLPlacemark
//placemark.location.coordinate 取得經緯度的參數   &#125;
</code></pre>
})</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   經緯度轉地址的方法 &#96;&#96;&#96;swift</span><br><span class="line">let geoCoder &#x3D; CLGeocoder()</span><br><span class="line">geoCoder.reverseGeocodeLocation(CLLocation(latitude: 25.024839 , longitude: 121.549170), completionHandler: &#123;</span><br><span class="line">   (placemarks:[AnyObject]!,error:NSError!) -&gt; Void in</span><br><span class="line">   if error !&#x3D; nil&#123;</span><br><span class="line">      println(error)</span><br><span class="line">      return</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">       &#x2F;&#x2F;name         街道地址</span><br><span class="line">   &#x2F;&#x2F;country      國家</span><br><span class="line">   &#x2F;&#x2F;province     省</span><br><span class="line">   &#x2F;&#x2F;locality     市</span><br><span class="line">   &#x2F;&#x2F;sublocality  縣.區</span><br><span class="line">   &#x2F;&#x2F;route        街道、路</span><br><span class="line">   &#x2F;&#x2F;streetNumber 門牌號碼</span><br><span class="line">   &#x2F;&#x2F;postalCode   郵遞區號</span><br><span class="line">   if placemarks !&#x3D; nil &amp;&amp; placemarks.count &gt; 0&#123;</span><br><span class="line">      let placemark &#x3D; placemarks[0] as CLPlacemark</span><br><span class="line">      &#x2F;&#x2F;這邊拼湊轉回來的地址</span><br><span class="line">      &#x2F;&#x2F;placemark.name</span><br><span class="line">   &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] IOS地圖運用 (5) 計算點與點之間的距離</title>
    <url>/2015/03/03/swift-IOS%E5%9C%B0%E5%9C%96%E9%81%8B%E7%94%A8-5-%E8%A8%88%E7%AE%97%E9%BB%9E%E8%88%87%E9%BB%9E%E4%B9%8B%E9%96%93%E7%9A%84%E8%B7%9D%E9%9B%A2/</url>
    <content><![CDATA[<p>網路上有找到Google的計算公式,把它翻譯成Swift的語法後如下,回傳單位為**公里 **</p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">func</span> <span class="title">GetDistance_Google</span>(<span class="params">pointA</span>:<span class="type">CLLocationCoordinate2D</span> , <span class="params">pointB</span>:<span class="type">CLLocationCoordinate2D</span>)</span> -&gt; <span class="type">Double</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">let</span> <span class="type">EARTH_RADIUS</span>:<span class="type">Double</span> <span class="operator">=</span> <span class="number">6378.137</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">let</span> radlng1:<span class="type">Double</span> <span class="operator">=</span> pointA.longitude <span class="operator">*</span> <span class="type">M_PI</span> <span class="operator">/</span> <span class="number">180.0</span>;</span><br><span class="line">   <span class="keyword">let</span> radlng2:<span class="type">Double</span> <span class="operator">=</span> pointB.longitude <span class="operator">*</span> <span class="type">M_PI</span> <span class="operator">/</span> <span class="number">180.0</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">let</span> a:<span class="type">Double</span> <span class="operator">=</span> radlng1 <span class="operator">-</span> radlng2;</span><br><span class="line">   <span class="keyword">let</span> b:<span class="type">Double</span> <span class="operator">=</span> (pointA.latitude <span class="operator">-</span> pointB.latitude) <span class="operator">*</span> <span class="type">M_PI</span> <span class="operator">/</span> <span class="number">180</span>;</span><br><span class="line">   <span class="keyword">var</span> s:<span class="type">Double</span> <span class="operator">=</span> <span class="number">2</span> <span class="operator">*</span> asin(sqrt(pow(sin(a<span class="operator">/</span><span class="number">2</span>), <span class="number">2</span>) <span class="operator">+</span> cos(radlng1) <span class="operator">*</span> cos(radlng2) <span class="operator">*</span> pow(sin(b<span class="operator">/</span><span class="number">2</span>), <span class="number">2</span>)));</span><br><span class="line"></span><br><span class="line">   s <span class="operator">=</span> s <span class="operator">*</span> <span class="type">EARTH_RADIUS</span>;</span><br><span class="line">   s <span class="operator">=</span> (round(s <span class="operator">*</span> <span class="number">10000</span>) <span class="operator">/</span> <span class="number">10000</span>);</span><br><span class="line">   <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift]Navigation Controller (1) 畫面切換</title>
    <url>/2015/03/02/swift-Navigation-Controller-1-%E7%95%AB%E9%9D%A2%E5%88%87%E6%8F%9B/</url>
    <content><![CDATA[<ul>
<li><p>  先拉一個Navigation Controller到StoryBoard,並將起始指標指向它<br><a href="http://2.bp.blogspot.com/-fA8zFXoGMn0/VPQxsX0y6hI/AAAAAAAAEY0/H95akka6mBU/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%885.44.46.png"><img src="http://2.bp.blogspot.com/-fA8zFXoGMn0/VPQxsX0y6hI/AAAAAAAAEY0/H95akka6mBU/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%885.44.46.png"></a></p>
</li>
<li><p>  接著拉個ViewA並且設定他為root view並且執行看看<a href="http://4.bp.blogspot.com/-K4yeFlMFoh8/VPQ2RXPJkEI/AAAAAAAAEZo/KuZ33YI1kGg/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%886.05.57.png"><img src="http://4.bp.blogspot.com/-K4yeFlMFoh8/VPQ2RXPJkEI/AAAAAAAAEZo/KuZ33YI1kGg/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%886.05.57.png"></a><br><a href="http://2.bp.blogspot.com/-xXMjStRghEU/VPQ0-TggsYI/AAAAAAAAEZY/SN_q-5qelSU/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%886.00.08.png"><img src="http://2.bp.blogspot.com/-xXMjStRghEU/VPQ0-TggsYI/AAAAAAAAEZY/SN_q-5qelSU/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%886.00.08.png"></a><br>執行結果首頁就是剛剛指定root view的那一頁了<br><a href="http://4.bp.blogspot.com/-_qbQ9rm9jL8/VPQ1DhTqoJI/AAAAAAAAEZg/RACPJIajA6c/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%886.00.21.png"><img src="http://4.bp.blogspot.com/-_qbQ9rm9jL8/VPQ1DhTqoJI/AAAAAAAAEZg/RACPJIajA6c/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%886.00.21.png"></a></p>
</li>
<li><p>接著在拉第二個ViewB,並將ViewA與ViewB做Push的關聯<br><a href="http://1.bp.blogspot.com/-rCM22lv7ttI/VPQ5KGX6icI/AAAAAAAAEZ0/4w9YGq6810o/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%886.18.23.png"><img src="http://1.bp.blogspot.com/-rCM22lv7ttI/VPQ5KGX6icI/AAAAAAAAEZ0/4w9YGq6810o/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%886.18.23.png"></a></p>
<p>  接著設定這個push segue的identifier<br><a href="http://3.bp.blogspot.com/-euQwt-_kxAU/VPQ7MEAWfUI/AAAAAAAAEaA/slK1nAB8tXQ/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%886.27.16.png"><img src="http://3.bp.blogspot.com/-euQwt-_kxAU/VPQ7MEAWfUI/AAAAAAAAEaA/slK1nAB8tXQ/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%886.27.16.png"></a></p>
</li>
<li><p>在ViewA做已下修改 ```swift<br>import UIKit<br>class Page_A_ViewController: UIViewController {</p>
<p>   override func viewDidLoad() {<br> super.viewDidLoad()<br> //NavBar<br> self.navigationController?.navigationBar.barTintColor = UIColor(red: 0.58, green: 0.761, blue: 0.231, alpha: 1)<br> let titleDic : NSDictionary = [NSForegroundColorAttributeName : UIColor.whiteColor()]; //字的顏色<br> self.navigationController?.navigationBar.titleTextAttributes = titleDic;<br> self.navigationController?.navigationBar.tintColor = UIColor.whiteColor() //按鈕的顏色<br> //設定右上角的按鈕let barOptionIcon : UIBarButtonItem = UIBarButtonItem(image: UIImage(named: “icon-options”), style: UIBarButtonItemStyle.Plain, target: self, action: “PushToOptionController:”);<br> self.navigationController?.navigationBar.topItem?.setRightBarButtonItem(barOptionIcon, animated: true) ;<br>}</p>
<p>   //右上角Button按下時觸發的事件<br>func PushToOptionController(sender: UIBarButtonItem) {<br>  self.performSegueWithIdentifier(“toPageB”, sender: self);<br>}</p>
<p>  }</p>
</li>
</ul>
<p>```</p>
<ul>
<li>  完成後試試看,點擊右上角的按鈕即可跳到第二頁了！！</li>
</ul>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] NetWork (2) 非同步方式取得API資訊</title>
    <url>/2015/03/04/swift-NetWork-2-%E9%9D%9E%E5%90%8C%E6%AD%A5%E6%96%B9%E5%BC%8F%E5%8F%96%E5%BE%97API%E8%B3%87%E8%A8%8A/</url>
    <content><![CDATA[<p>為了避免撈取API資料太久而讓整個APP卡住,所以建議撈取API資料時都另外開出一個queue來非同步執行 ```swift<br>var url:NSURL = NSURL(string: “<a href="http://xxx.com.tw/api/getdata&quot;">http://xxx.com.tw/api/getdata&quot;</a>)!;<br>let request:NSMutableURLRequest = NSMutableURLRequest(URL: url, cachePolicy: NSURLRequestCachePolicy.ReloadIgnoringLocalCacheData, timeoutInterval: 10);<br>request.HTTPMethod = “POST”;<br>request.HTTPBody = “yourdata”.dataUsingEncoding(NSUTF8StringEncoding);</p>
<p>//新增一個queue來執行API,避免API撈取資料太久把整個APP卡住<br>let queue :NSOperationQueue = NSOperationQueue();<br>//非同步方式取得資料<br>NSURLConnection.sendAsynchronousRequest(request, queue: queue, completionHandler:{ (response: NSURLResponse!, data: NSData!, error: NSError!) -&gt; Void in<br>   var err:String? = error?.description;<br>   if(data != nil  &amp;&amp; error == nil)<br>   {<br>      let responseString = NSString(data: data, encoding: NSUTF8StringEncoding);<br>      println(“responseString = (responseString)”);<br>   }<br>});</p>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] NetWork (1) 以Get 和 Post方式傳送資料</title>
    <url>/2015/03/04/swift-NetWork-1-%E4%BB%A5Get-%E5%92%8C-Post%E6%96%B9%E5%BC%8F%E5%82%B3%E9%80%81%E8%B3%87%E6%96%99/</url>
    <content><![CDATA[<p>用Post方式傳遞資料 </p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> url:<span class="type">NSURL</span> <span class="operator">=</span> <span class="type">NSURL</span>(string: <span class="string">&quot;http://xxx.com.tw/api/postdata&quot;</span>)<span class="operator">!</span>;</span><br><span class="line">        <span class="keyword">let</span> request:<span class="type">NSMutableURLRequest</span> <span class="operator">=</span> <span class="type">NSMutableURLRequest</span>(URL: url, cachePolicy: <span class="type">NSURLRequestCachePolicy</span>.<span class="type">ReloadIgnoringLocalCacheData</span>, timeoutInterval: <span class="number">10</span>);</span><br><span class="line">        request.<span class="type">HTTPMethod</span> <span class="operator">=</span> <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">        request.<span class="type">HTTPBody</span> <span class="operator">=</span> <span class="string">&quot;yourPostData&quot;</span>.dataUsingEncoding(<span class="type">NSUTF8StringEncoding</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> task <span class="operator">=</span> <span class="type">NSURLSession</span>.sharedSession().dataTaskWithRequest(request) &#123;</span><br><span class="line">            data, response, error <span class="keyword">in</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> error <span class="operator">!=</span> <span class="literal">nil</span> &#123;</span><br><span class="line">                println(<span class="string">&quot;error=<span class="subst">\(error)</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            println(<span class="string">&quot;response = <span class="subst">\(response)</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">//將收到的資料轉成字串print出來看看</span></span><br><span class="line">            <span class="keyword">let</span> responseString <span class="operator">=</span> <span class="type">NSString</span>(data: data, encoding: <span class="type">NSUTF8StringEncoding</span>)</span><br><span class="line">            println(<span class="string">&quot;responseString = <span class="subst">\(responseString)</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        task.resume();</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>用Get方式傳遞資料 ```swift<br>var url:NSURL = NSURL(string: “<a href="http://xxx.com.tw/api/getdata?id=5008&amp;id=5009&quot;">http://xxx.com.tw/api/getdata?id=5008&amp;id=5009&quot;</a>)!;<br>let request:NSURLRequest = NSURLRequest(URL: url, cachePolicy: NSURLRequestCachePolicy.ReloadIgnoringLocalCacheData, timeoutInterval: 10);</p>
<p>let task = NSURLSession.sharedSession().dataTaskWithRequest(request) { data, response, error in<br>   if error != nil {<br>      println(“error=(error)”)<br>      return<br>   }</p>
<p>   println(“response = (response)”)</p>
<p>   let responseString = NSString(data: data, encoding: NSUTF8StringEncoding)<br>   println(“responseString = (responseString)”)<br>}<br>task.resume();</p>
<p>```</p>
<p>這邊整理一下從網路上找的NSURLRequestCachePolicy相關資訊,轉載自：<a href="http://mypaper.pchome.com.tw/reantoilpc/post/1322520632">iOS?存?存</a></p>
<ul>
<li>  <span style="color: blue;">ReloadIgnoringCacheData</span>：忽略Cache數據,直接從原始網址下載。</li>
<li>  <span style="color: blue;">ReloadRevalidatingCacheData</span>：驗證本地的數據和遠端數據是否相同，如果不同則下?遠端?據，否?使用本地數據。*   <span style="color: blue;">ReturnCacheDataDontLoad</span>：只使用cache?據，如果不存在cache，請求失敗；用於?有建立網路連接離線模式；*   <span style="color: blue;">ReturnCacheDataElseLoad：</span>&nbsp;只有在cache中不存在data時才從原始地址下?。*   <span style="color: blue;">UseProtocolCachePolicy</span>： NSURLRequest默認的cache policy，使用Protocol協議定義。*   <span style="color: blue;">ReloadIgnoringLocalAndRemoteCacheData</span>：忽略本地和遠端的緩存數據，直接從原始地址下?，與ReloadIgnoringCacheData類似。</li>
</ul>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] NetWork (3) 判斷手機是否有網路連線可用</title>
    <url>/2015/03/05/swift-NetWork-3-%E5%88%A4%E6%96%B7%E6%89%8B%E6%A9%9F%E6%98%AF%E5%90%A6%E6%9C%89%E7%B6%B2%E8%B7%AF%E9%80%A3%E7%B7%9A%E5%8F%AF%E7%94%A8/</url>
    <content><![CDATA[<p>主要參考兩篇文章做修改:<br><a href="http://yishenghsu.blogspot.tw/2014/08/detect-internet-status-programmatically.html">Detect Internet status programmatically using Swift and Object-C language</a><br><a href="https://cg2010studio.wordpress.com/2014/03/25/ios-%E5%8D%B3%E6%99%82%E5%88%A4%E6%96%B7%E7%B6%B2%E8%B7%AF%E9%80%A3%E7%B7%9A%E7%8B%80%E6%85%8B-detect-network-status-on-real-time/">[iOS] 即時判斷網路連線狀態 (Detect Network Status on Real-Time)</a></p>
<ul>
<li>  Apple已經用Objective-C寫了判斷網路的套件給大家使用,所以接下來會解說如何用Swift專案載入Objective-C套件</li>
<li>  先到這邊下載<a href="https://developer.apple.com/library/ios/samplecode/Reachability/Introduction/Intro.html">Reachability</a><br><a href="http://4.bp.blogspot.com/-ARSnk1PlmsA/VPfKweUAqBI/AAAAAAAAEek/VmW9EFmlEdI/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.16.58.png"><img src="http://4.bp.blogspot.com/-ARSnk1PlmsA/VPfKweUAqBI/AAAAAAAAEek/VmW9EFmlEdI/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.16.58.png"></a></li>
<li>  接著把Reachability專案中的Reachability.m和Reachability.h抓到專案中<br><a href="http://2.bp.blogspot.com/-tOe02e1PHi8/VPfMqYara3I/AAAAAAAAEew/8lk8Vhb0Ycw/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.24.31.png"><img src="http://2.bp.blogspot.com/-tOe02e1PHi8/VPfMqYara3I/AAAAAAAAEew/8lk8Vhb0Ycw/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.24.31.png"></a></li>
<li>  在專案中新增Header檔<br><a href="http://3.bp.blogspot.com/-bT6x-uOyL18/VPfM_oRXMjI/AAAAAAAAEe4/tohKrlWN6Wc/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.26.24.png"><img src="http://3.bp.blogspot.com/-bT6x-uOyL18/VPfM_oRXMjI/AAAAAAAAEe4/tohKrlWN6Wc/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.26.24.png"></a><br><a href="http://4.bp.blogspot.com/-WFeWY0XO3bg/VPfO2ffoduI/AAAAAAAAEfU/j1womd0gVtY/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.33.49.png"><img src="http://4.bp.blogspot.com/-WFeWY0XO3bg/VPfO2ffoduI/AAAAAAAAEfU/j1womd0gVtY/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.33.49.png"></a></li>
<li>  打開Header檔,把Reachability.h掛進去,這樣以後專案中引用Reachability裡面的class都不再Import了<br><a href="http://3.bp.blogspot.com/-3dpVy1QW-_E/VPfNsxflCYI/AAAAAAAAEfA/aHDQvazuqfs/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.29.30.png"><img src="http://3.bp.blogspot.com/-3dpVy1QW-_E/VPfNsxflCYI/AAAAAAAAEfA/aHDQvazuqfs/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.29.30.png"></a></li>
<li>  把Header檔加到專案的Build Setting中<br><a href="http://4.bp.blogspot.com/-9Hr8yXPHenQ/VPfOYYogTeI/AAAAAAAAEfM/rowTL9RSiCI/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.31.48.png"><img src="http://4.bp.blogspot.com/-9Hr8yXPHenQ/VPfOYYogTeI/AAAAAAAAEfM/rowTL9RSiCI/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.31.48.png"></a></li>
<li>  打開Reachability.m找到(void)dealloc改成 ```swift</li>
</ul>
<ul>
<li>(void)dealloc<br>{<br>  [self stopNotifier];<br>  if (_reachabilityRef != NULL)<br>  {<br>CFRelease(_reachabilityRef);<br>  }<br>  [super dealloc];<br>}</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   到專案中的Build Phases,把Reachability.m加上-fno-objc-arc [![](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-iCs_Qc3MS_g&#x2F;VPfP4egfeoI&#x2F;AAAAAAAAEfg&#x2F;loz5m7jQjpU&#x2F;s400&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.38.54.png)](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-iCs_Qc3MS_g&#x2F;VPfP4egfeoI&#x2F;AAAAAAAAEfg&#x2F;loz5m7jQjpU&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.38.54.png)</span><br><span class="line">*   以上就全部掛載完成了,接著來看看這個套件如何使用,並讓它告知我們網路狀態</span><br><span class="line">打開view controller,新增一個監測網路的變數,並且在viewDidLoad寫下 &#96;&#96;&#96;swift</span><br><span class="line">var internetReachability:Reachability!; &#x2F;&#x2F;網路狀態監控</span><br><span class="line">    override func viewDidLoad() &#123;</span><br><span class="line">        super.viewDidLoad()</span><br><span class="line">        &#x2F;&#x2F;在通知中心註冊事件,當網路狀態有變動的時候會觸發</span><br><span class="line">        NSNotificationCenter.defaultCenter().addObserverForName(kReachabilityChangedNotification, object: nil, queue: NSOperationQueue.mainQueue()) &#123; (NSNotification) -&gt; Void in</span><br><span class="line">            let networksStatus: NetworkStatus &#x3D; self.internetReachability.currentReachabilityStatus()</span><br><span class="line">            var status: String!</span><br><span class="line">            if networksStatus.value &#x3D;&#x3D; 0 &#123;</span><br><span class="line">                status &#x3D; &quot;Disconnection&quot;</span><br><span class="line">            &#125; else if networksStatus.value &#x3D;&#x3D; 1 &#123;</span><br><span class="line">                status &#x3D; &quot;Connection&quot;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                status &#x3D; &quot;Connection&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            UIAlertView(title: &quot;網路狀態&quot;, message: status, delegate: nil, cancelButtonTitle: &quot;OK&quot;).show();</span><br><span class="line">        &#125;</span><br><span class="line">        self.internetReachability &#x3D; Reachability.reachabilityForInternetConnection();</span><br><span class="line">        &#x2F;&#x2F;開始監控狀況</span><br><span class="line">        self.internetReachability.startNotifier()</span><br><span class="line">   &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>在Mac上面執行看看,測試方法就是把mac的wifi連線給關閉,就會看到App跳出提示訊息了<br><a href="http://4.bp.blogspot.com/-UXJAaO-c6dk/VPfVoHMIjHI/AAAAAAAAEfw/U_lcuavEFlM/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.59.07.png"><img src="http://4.bp.blogspot.com/-UXJAaO-c6dk/VPfVoHMIjHI/AAAAAAAAEfw/U_lcuavEFlM/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8A%E5%8D%8811.59.07.png"></a></p>
<ul>
<li>接下來把viewDidLoad改成如下,這段是告訴你目前使用的網路是什麼?Wifi or 3G之類的 ```swift<br>override func viewDidLoad() {<pre><code>  super.viewDidLoad()
  let statusReach: Reachability = Reachability.reachabilityForInternetConnection()
  let networksStatus: NetworkStatus = statusReach.currentReachabilityStatus()
  var status: String!
  if networksStatus.value == 0 &#123;
      status = &quot;NoReachable&quot;
  &#125; else if networksStatus.value == 1 &#123;
      status = &quot;ReachableViaWiFi&quot;
  &#125; else &#123;
      status = &quot;ReachableViaWWAN&quot;
  &#125;
  UIAlertView(title: &quot;網路狀態&quot;, message: status, delegate: nil, cancelButtonTitle: &quot;OK&quot;).show();
</code></pre>
  }</li>
</ul>
<p>```<br>執行看看<br><a href="http://2.bp.blogspot.com/-CvlIif9Hk94/VPfvJxCKWfI/AAAAAAAAEgA/KRl1SzUlcXo/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8B%E5%8D%881.52.19.png"><img src="http://2.bp.blogspot.com/-CvlIif9Hk94/VPfvJxCKWfI/AAAAAAAAEgA/KRl1SzUlcXo/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8B%E5%8D%881.52.19.png"></a></p>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift]使用Storyboard的情況下,設定App的第一頁</title>
    <url>/2015/03/02/swift-%E4%BD%BF%E7%94%A8Storyboard%E7%9A%84%E6%83%85%E6%B3%81%E4%B8%8B-%E8%A8%AD%E5%AE%9AApp%E7%9A%84%E7%AC%AC%E4%B8%80%E9%A0%81/</url>
    <content><![CDATA[<ul>
<li><p>方法一:打開Storyboard移動起始指標,指到的Controller預設就會用那個ViewController為起始頁面<br><a href="http://3.bp.blogspot.com/-fc1xkF4wE-w/VPQn4-h-_cI/AAAAAAAAEYY/Ez9nyZzajF8/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%885.04.14.png"><img src="http://3.bp.blogspot.com/-fc1xkF4wE-w/VPQn4-h-_cI/AAAAAAAAEYY/Ez9nyZzajF8/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%885.04.14.png"></a><li>方法二:<br>先對在Storyboard的Controller設定Storyboard ID<br><a href="http://2.bp.blogspot.com/-VSNrg7jwyqs/VPQp1XB-Q4I/AAAAAAAAEYk/_1bxDXnnMHM/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%885.11.54.png"><img src="http://2.bp.blogspot.com/-VSNrg7jwyqs/VPQp1XB-Q4I/AAAAAAAAEYk/_1bxDXnnMHM/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%885.11.54.png"></a></p>
<p>  然後找到AppDelegate.swift檔案改寫didFinishLaunchingWithOptions ```swift<br>func application(application: UIApplication, didFinishLaunchingWithOptions launchOptions: [NSObject: AnyObject]?) -&gt; Bool {  let storyboard = UIStoryboard(name:”Main” , bundle: nil);<br>self.window? = UIWindow(frame: UIScreen.mainScreen().bounds);<br>//指定Storyboard ID<br>self.window?.rootViewController = storyboard.instantiateViewControllerWithIdentifier(“testa”) as?   UIViewController;<br>self.window?.makeKeyAndVisible();<br>return true<br>}</p>
</li>
</ul>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] NetWork (4) 解析Json</title>
    <url>/2015/03/05/swift-NetWork-4-%E8%A7%A3%E6%9E%90Json/</url>
    <content><![CDATA[<ul>
<li>先做一個json檔案來模擬接到時怎麼解析 ```csharp<br>{<br>“組織名稱”:”普攏拱團隊”,<br>“組織成員”:[<br>  {“姓名”:”科科人”,”年齡”:11},<br>  {“姓名”:”可可狗”,”年齡”:120}<br>]<br>}</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   在viewDidLoad加上,測試看看！！ &#96;&#96;&#96;swift</span><br><span class="line">&#x2F;&#x2F;將檔案讀出來</span><br><span class="line">        let path &#x3D; NSBundle.mainBundle().pathForResource(&quot;json&quot;, ofType: &quot;txt&quot;);</span><br><span class="line">        var data:NSData &#x3D; NSData(contentsOfFile: path!)!;</span><br><span class="line">        &#x2F;&#x2F;解析Json</span><br><span class="line">        var jsonobj &#x3D; NSJSONSerialization.JSONObjectWithData(data, options: NSJSONReadingOptions.MutableContainers, error: nil) as NSDictionary;</span><br><span class="line">        println(jsonobj[&quot;組織名稱&quot;] as String);</span><br><span class="line">        println(&quot;組織成員&quot;);</span><br><span class="line">        var arr &#x3D; jsonobj[&quot;組織成員&quot;] as NSArray;</span><br><span class="line">        for i in (0...arr.count - 1)&#123;</span><br><span class="line">            let mdic &#x3D; arr[i] as NSDictionary;</span><br><span class="line">            println(mdic[&quot;姓名&quot;] as String);</span><br><span class="line">            println(mdic[&quot;年齡&quot;] as Int);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p><a href="http://3.bp.blogspot.com/-QRs1yWks6qY/VPgZj3HwGJI/AAAAAAAAEgQ/IXGY0PKyPps/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8B%E5%8D%884.53.19.png"><img src="http://3.bp.blogspot.com/-QRs1yWks6qY/VPgZj3HwGJI/AAAAAAAAEgQ/IXGY0PKyPps/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-05%2B%E4%B8%8B%E5%8D%884.53.19.png"></a></p>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] String To MD5</title>
    <url>/2015/03/09/swift-String-To-MD5/</url>
    <content><![CDATA[<ul>
<li>  我將這個Function寫在extension裡面,首先Swift要能用MD5的function必須先建立header檔並掛上(header檔如何建立請看<a href="http://toyo0103.blogspot.tw/2015/03/swift-network-3.html">這篇</a>) ```swift<br>#import &lt;CommonCrypto/CommonCrypto.h&gt;</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   然後 &#96;&#96;&#96;swift</span><br><span class="line">func md5() -&gt; String! &#123;</span><br><span class="line">        let str &#x3D; self.cStringUsingEncoding(NSUTF8StringEncoding)</span><br><span class="line">        let strLen &#x3D; CUnsignedInt(self.lengthOfBytesUsingEncoding(NSUTF8StringEncoding))</span><br><span class="line">        let digestLen &#x3D; Int(CC_MD5_DIGEST_LENGTH)</span><br><span class="line">        let result &#x3D; UnsafeMutablePointer&lt;CUnsignedChar&gt;.alloc(digestLen)</span><br><span class="line">        CC_MD5(str!, strLen, result)</span><br><span class="line">        var hash &#x3D; NSMutableString()</span><br><span class="line">        for i in 0..&lt;digestLen &#123;</span><br><span class="line">            hash.appendFormat(&quot;%02x&quot;, result[i])</span><br><span class="line">        &#125;</span><br><span class="line">        result.destroy()</span><br><span class="line">        return String(format: hash)&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] UIAlertController</title>
    <url>/2015/03/09/swift-UIAlertController/</url>
    <content><![CDATA[<ul>
<li><p>APP常常有一種狀況是當使用者按下某個選項時,從下面滑出更多的選項讓它做進一步動作,例如在iphone的照片點選垃圾桶時</p>
<p>  <a href="http://2.bp.blogspot.com/-3nruP8qpby4/VP1MZiLDRrI/AAAAAAAAEhQ/AjByBZQXUfs/s1600/IMG_2020.PNG"><img src="http://2.bp.blogspot.com/-3nruP8qpby4/VP1MZiLDRrI/AAAAAAAAEhQ/AjByBZQXUfs/s400/IMG_2020.PNG"></a></p>
</li>
<li><p>在IOS 8中多了一個UIAlertController的類別來取代UIAlerView,實際作法如下<br>首先將程式碼加到viewDidAppear,否則無法顯示效果,原因請看IOS生命週期的說明<a href="http://stablekernel.com/blog/uiviewcontroller-best-practices-viewwillappear-or-viewdidload/">點我 </a>```swift<br>override func viewDidAppear(animated: Bool) {</p>
<pre><code>  //建立UIAlertController
  let quetion = UIAlertController(title: nil, message: &quot;What Do u want?&quot;, preferredStyle: .ActionSheet);
  //新增選項
  let callaction = UIAlertAction(title: &quot;call xxx&quot;, style: .Default , handler:nil);
  //把選項加到UIAlertController
  quetion.addAction(callaction);
  //Show
  self.presentViewController(quetion, animated: true, completion: nil);
</code></pre>
<p>  }</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">執行看到的結果如下圖</span><br><span class="line">[![](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-FSopEARqG_0&#x2F;VP1Oau8suBI&#x2F;AAAAAAAAEhc&#x2F;v6cpxkt6bWc&#x2F;s400&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-09%2B%E4%B8%8B%E5%8D%883.39.39.png)](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-FSopEARqG_0&#x2F;VP1Oau8suBI&#x2F;AAAAAAAAEhc&#x2F;v6cpxkt6bWc&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-09%2B%E4%B8%8B%E5%8D%883.39.39.png)</span><br><span class="line">*   如果將ActionSheet改成Alert,則結果 &#96;&#96;&#96;swift</span><br><span class="line">let quetion &#x3D; UIAlertController(title: nil, message: &quot;What Do u want?&quot;, preferredStyle: .Alert);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a href="http://2.bp.blogspot.com/-Tn1snLcsaxI/VP1PGsV8gtI/AAAAAAAAEhk/r84kalhfkHw/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-09%2B%E4%B8%8B%E5%8D%883.43.05.png"><img src="http://2.bp.blogspot.com/-Tn1snLcsaxI/VP1PGsV8gtI/AAAAAAAAEhk/r84kalhfkHw/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-09%2B%E4%B8%8B%E5%8D%883.43.05.png"></a></p>
<ul>
<li>如果更進階一些,在選擇選項後有些回應時<br>我們拉一個label到ViewController裡面來,並且在按下call xxx選項時,把label的字樣給改變 ```swift<br>class AlertViewController: UIViewController {<br>  @IBOutlet weak var showaction: UILabel!<br>  override func viewDidLoad() {<pre><code>  super.viewDidLoad();
</code></pre>
  }<br>  override func viewDidAppear(animated: Bool) {<pre><code>  let quetion = UIAlertController(title: nil, message: &quot;What Do u want?&quot;, preferredStyle: .Alert);
  let callaction = UIAlertAction(title: &quot;call xxx&quot;,style: .Default, handler:&#123;
      (action:UIAlertAction!) -&gt; Void in
      self.showaction.text = &quot;Do call xxx&quot;;
  &#125;);
  quetion.addAction(callaction);
  self.presentViewController(quetion, animated: true, completion: nil);
</code></pre>
  }<br>}</li>
</ul>
<p>```<br>執行看看吧！！</p>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] 製作IOS Table (2)客製化cell</title>
    <url>/2015/03/02/swift-%E8%A3%BD%E4%BD%9CIOS-Table-2-%E5%AE%A2%E8%A3%BD%E5%8C%96cell/</url>
    <content><![CDATA[<p>基於上一篇的基礎語法可以做出簡單的table,但果要客製化每個cell的樣式呢？<br>已storyboard為例</p>
<ul>
<li><p>  在storyboard拉cell並且佈置成自己要的樣子<br><a href="http://1.bp.blogspot.com/-D1RF78mHUrw/VPP9UCe9csI/AAAAAAAAEWI/mSp4Legr0P0/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%882.03.37.png"><img src="http://1.bp.blogspot.com/-D1RF78mHUrw/VPP9UCe9csI/AAAAAAAAEWI/mSp4Legr0P0/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%882.03.37.png"></a></p>
</li>
<li><p>建立相對應的cell Class ```swift<br>import Foundation<br>import UiKit<br>public class CustomerCell:UITableViewCell{<br> override init(style: UITableViewCellStyle, reuseIdentifier: String?) {</p>
<pre><code>super.init(style: style, reuseIdentifier: reuseIdentifier);
</code></pre>
<p> }</p>
<pre><code> //繼承UITableViewCell一定要override的function
</code></pre>
<p> public required init(coder aDecoder: NSCoder) {</p>
<pre><code>super.init(coder: aDecoder);
</code></pre>
<p> }<br>}</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   在storyboard指定該cell的class為CustomerCell,並且設定Identifier [![](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-ccc0-6L5vYk&#x2F;VPQCFF6QKwI&#x2F;AAAAAAAAEWY&#x2F;sOW8wxdPRSc&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%882.19.52.png)](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-ccc0-6L5vYk&#x2F;VPQCFF6QKwI&#x2F;AAAAAAAAEWY&#x2F;sOW8wxdPRSc&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%882.19.52.png)</span><br><span class="line">[![](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-ZcUAw2yn9OU&#x2F;VPQCnODddHI&#x2F;AAAAAAAAEWg&#x2F;Xs5EhzwGDsI&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%882.25.39.png)](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-ZcUAw2yn9OU&#x2F;VPQCnODddHI&#x2F;AAAAAAAAEWg&#x2F;Xs5EhzwGDsI&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%882.25.39.png)</span><br><span class="line">*   把對應的控制項建立起關聯 &#96;&#96;&#96;swift</span><br><span class="line">import Foundation</span><br><span class="line">import UiKit</span><br><span class="line">public class CustomerCell:UITableViewCell&#123;</span><br><span class="line">   @IBOutlet weak var lblTitle: UILabel! &#x2F;&#x2F;title的label</span><br><span class="line">   @IBOutlet weak var imgIcon: UIImageView! &#x2F;&#x2F;icon的小圖片</span><br><span class="line"></span><br><span class="line">       override init(style: UITableViewCellStyle, reuseIdentifier: String?) &#123;</span><br><span class="line">      super.init(style: style, reuseIdentifier: reuseIdentifier);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">       public required init(coder aDecoder: NSCoder) &#123;</span><br><span class="line">      super.init(coder: aDecoder);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>改寫cellForRowAtIndexPath這個事件 ```swift<br>//每個row顯示的內容<br>func tableView(tableView: UITableView, cellForRowAtIndexPath indexPath: NSIndexPath) -&gt; UITableViewCell {<br> let identifier = “Customer_Cell”;<br> var cell:CustomerCell? = uitable.dequeueReusableCellWithIdentifier(identifier) as? CustomerCell;<br> if(cell == nil){<pre><code>cell = CustomerCell(style: UITableViewCellStyle.Default, reuseIdentifier: identifier);
</code></pre>
 }<br> //indexPath.row 可以知道目前是要製作第幾列的view<br> cell?.lblTitle?.text = data[indexPath.row];<br> //依據是第幾個row決定icon的圖片<br> switch indexPath.row{<pre><code>case 0:
   cell?.imgIcon.image = UIImage(named: &quot;icon-factory&quot;);
   break;
case 1:
   cell?.imgIcon.image = UIImage(named: &quot;icon-location&quot;);
   break;
case 2:
   cell?.imgIcon.image = UIImage(named: &quot;icon-money&quot;);
   break;
default:
   break;
</code></pre>
 }<br> return cell!;<br>}</li>
</ul>
<p>```</p>
<ul>
<li>  最後呈現的結果<br><a href="http://3.bp.blogspot.com/-t0_TZ9_hrcU/VPQHkG_i85I/AAAAAAAAEWw/o-z3XWYYzAY/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%882.47.23.png"><img src="http://3.bp.blogspot.com/-t0_TZ9_hrcU/VPQHkG_i85I/AAAAAAAAEWw/o-z3XWYYzAY/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%882.47.23.png"></a></li>
</ul>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] 將圖片做出霧化效果</title>
    <url>/2015/03/11/swift-%E5%B0%87%E5%9C%96%E7%89%87%E5%81%9A%E5%87%BA%E9%9C%A7%E5%8C%96%E6%95%88%E6%9E%9C/</url>
    <content><![CDATA[<p>以下範例是參考做成的筆記:<a href="http://www.books.com.tw/products/0010661108">養成iOS8 App程式設計實力的25堂課：最新Swift開發教學</a></p>
<ul>
<li>  IOS8有提供將圖片霧化的效果,如果我們將一張圖片擺進都不調整的情況下看到的結果如下<br><a href="http://4.bp.blogspot.com/-ELOEk0kal00/VP-zHXMlSfI/AAAAAAAAEiY/D7KPBndpUuw/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-11%2B%E4%B8%8A%E5%8D%8811.13.13.png"><img src="http://4.bp.blogspot.com/-ELOEk0kal00/VP-zHXMlSfI/AAAAAAAAEiY/D7KPBndpUuw/s320/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-11%2B%E4%B8%8A%E5%8D%8811.13.13.png"></a></li>
<li>  <div style="clear:both"></div>如果我們想把它變成這樣呢?
[![](http://4.bp.blogspot.com/-qGCntfEZsMQ/VP-ziaQFhLI/AAAAAAAAEig/GI3S3yTBTK0/s320/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-11%2B%E4%B8%8A%E5%8D%8811.16.07.png)](http://4.bp.blogspot.com/-qGCntfEZsMQ/VP-ziaQFhLI/AAAAAAAAEig/GI3S3yTBTK0/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-11%2B%E4%B8%8A%E5%8D%8811.16.07.png)[![](http://1.bp.blogspot.com/-inhOmUeMfVU/VP-ztGG_pxI/AAAAAAAAEio/djWTqz97y0I/s320/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-11%2B%E4%B8%8A%E5%8D%8811.16.51.png)](http://1.bp.blogspot.com/-inhOmUeMfVU/VP-ztGG_pxI/AAAAAAAAEio/djWTqz97y0I/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-11%2B%E4%B8%8A%E5%8D%8811.16.51.png)[![](http://3.bp.blogspot.com/-NJzO9xqbdbg/VP-z3nspMII/AAAAAAAAEiw/Ud6fxww0IgI/s320/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-11%2B%E4%B8%8A%E5%8D%8811.17.30.png)](http://3.bp.blogspot.com/-NJzO9xqbdbg/VP-z3nspMII/AAAAAAAAEiw/Ud6fxww0IgI/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-11%2B%E4%B8%8A%E5%8D%8811.17.30.png)</li>
<li><div style="clear:both"></div>程式碼撰寫如下: ```swift
@IBOutlet weak var backgroundImageView: UIImageView!//背景圖    override func viewDidLoad() {
      super.viewDidLoad()
      //.Dark等於圖1
      //.ExtraLight等於圖2
      //.Light等於圖3
      var blurEffect = UIBlurEffect(style: UIBlurEffectStyle.Light)
      var blurEffectView = UIVisualEffectView(effect: blurEffect)
      blurEffectView.frame = view.bounds
      backgroundImageView.addSubview(blurEffectView)
  }</li>
</ul>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] 用Plist製作設定檔</title>
    <url>/2015/03/04/swift-%E7%94%A8Plist%E8%A3%BD%E4%BD%9C%E8%A8%AD%E5%AE%9A%E6%AA%94/</url>
    <content><![CDATA[<p>很多APP都會有一些各人化設定檔,方便下次打開APP可以依照個人的喜好設定做出最適合的調整,接下來就實作如何將個人的設定檔存起來並在下次打開APP時Show出來</p>
<div>

<ul>
<li>  首先先拉一個畫面,輸入框,確定按鈕,呈現文字的按鈕,我們的目標是在輸入框輸入的文字會被系統儲存起來,在下次App重開時依然顯示最後設定的文字<br><a href="http://3.bp.blogspot.com/-wUh10dBlcgQ/VPWED2LwhlI/AAAAAAAAEdo/21KMM7HV0wY/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%885.48.44.png"><img src="http://3.bp.blogspot.com/-wUh10dBlcgQ/VPWED2LwhlI/AAAAAAAAEdo/21KMM7HV0wY/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%885.48.44.png"></a></li>
<li>基本的code如下,只要在輸入框填好後按下確定按鈕就可以更改文字了,但你只要重開APP他就又會回到最原本Button的文字 ```swift<br>import UIKit<br>class plistViewController: UIViewController {<br>  @IBOutlet weak var txtbox: UITextField! //輸入文字框<br>  @IBOutlet weak var btnShowText: UIButton! //show文字的button<br>  @IBOutlet weak var btnSetting: UIButton! //確定按鈕<br>  override func viewDidLoad() {<pre><code>  super.viewDidLoad();
</code></pre>
  }<br>  @IBAction func btnSetting_click(sender: AnyObject) {<pre><code>  //將輸入的文字設定給btnShowText
  btnShowText.setTitle(txtbox.text, forState: UIControlState.Normal);
</code></pre>
  }<br>}</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">[![](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-9CI9oydHno0&#x2F;VPWJqOmri8I&#x2F;AAAAAAAAEd4&#x2F;dbIiK5hekEI&#x2F;s400&#x2F;image.gif)](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-9CI9oydHno0&#x2F;VPWJqOmri8I&#x2F;AAAAAAAAEd4&#x2F;dbIiK5hekEI&#x2F;s1600&#x2F;image.gif)</span><br><span class="line">*   所以我們至少應該先把按鈕的文字改成抓Plist檔的來源,然後按下確定按鈕時將文字先存到plist檔中,但這邊有個觀念需要先釐清,**&lt;span style&#x3D;&quot;color: red;&quot;&gt;基本上IOS APP是SandBox模式&lt;&#x2F;span&gt;**,所以只有特定資料夾內的檔案是可以寫入的,所以在這之前我們必須先新建一個Setting.plist檔案專門放設定值（建議不要用原本預設的info.plist,因為之後會移動這個檔案位置）,然後在APP開啟時檢查這個檔案是否在可讀寫的資料夾之中了,如果沒有則複製一份過去,步驟如下</span><br><span class="line"></span><br><span class="line">    先在Setting.plist新增儲存按鈕文字的欄位</span><br><span class="line">[![](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-OC9a4bKFHCA&#x2F;VPWKf_BN2oI&#x2F;AAAAAAAAEeA&#x2F;L_A21cnwvR4&#x2F;s400&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%886.17.54.png)](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-OC9a4bKFHCA&#x2F;VPWKf_BN2oI&#x2F;AAAAAAAAEeA&#x2F;L_A21cnwvR4&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%886.17.54.png)</span><br><span class="line"></span><br><span class="line">    接著在AppDelegate.swift的didFinishLaunchingWithOptions寫下 &#96;&#96;&#96;swift</span><br><span class="line">func application(application: UIApplication, didFinishLaunchingWithOptions launchOptions: [NSObject: AnyObject]?) -&gt; Bool &#123;</span><br><span class="line">        &#x2F;&#x2F; Override point for customization after application launch.</span><br><span class="line">        &#x2F;&#x2F;Setting Plist因為要可以讀寫,所以要移到Documents的folder底下</span><br><span class="line">        let path:String &#x3D; NSBundle.mainBundle().pathForResource(&quot;Setting&quot;, ofType: &quot;plist&quot;)!;</span><br><span class="line">        let destinationPath &#x3D; String(format: &quot;%@&#x2F;Documents&#x2F;Setting.plist&quot;, arguments:[NSHomeDirectory()]);</span><br><span class="line">        var fm: NSFileManager &#x3D; NSFileManager();</span><br><span class="line">        if (!fm.fileExistsAtPath(destinationPath))</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;如果在documents資料夾底下找不到該檔案,則複製一份過去</span><br><span class="line">            fm.copyItemAtPath(path, toPath: destinationPath, error: nil);</span><br><span class="line">        &#125;</span><br><span class="line">        return true</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>接下來將輸入的文字改存到plist中,然後按鈕文字的來源改成Setting.plist,全部程式碼如下 ```swift<br>import UIKit<br>class plistViewController: UIViewController {<br>    @IBOutlet weak var txtbox: UITextField! //輸入文字框<br>    @IBOutlet weak var btnShowText: UIButton! //show文字的button<br>    @IBOutlet weak var btnSetting: UIButton! //確定按鈕<br>    override func viewDidLoad() {<br>        super.viewDidLoad();<br>        loadBtnText();<br>    }<br>    private func loadBtnText(){<br>        //button預設的字由Setting plist來<br>        btnShowText.setTitle(getSettingValue(), forState: UIControlState.Normal);<br>    }<br>    @IBAction func btnSetting_click(sender: AnyObject) {<br>        //將輸入的文字設定給btnShowText<br>        //btnShowText.setTitle(txtbox.text, forState: UIControlState.Normal);<br>        //修改成將輸入的文字存到Setting.plist後,在由那邊load給button<br>        Set_SettingPlist_Value(txtbox.text);<br>        loadBtnText();<br>    }<br>    //取得Setting.plist裡btnText欄位得值<br>    private func getSettingValue() -&gt; String{<br>        var value:String!;<br>        //取得document folder底下的Setting.plist路徑<br>        let SettingPath = String(format: “%@/Documents/Setting.plist”, arguments:[NSHomeDirectory()]);<br>        var dic:NSMutableDictionary? = NSMutableDictionary(contentsOfFile: SettingPath);<br>        //欄位名稱<br>        if (dic?.objectForKey(“btnText”) != nil){<br>            value = dic!.objectForKey(“btnText”) as String;<br>        }<br>        return value;<br>    }<br>    //把值存到Setting.plist裡面<br>    private func Set_SettingPlist_Value(value:String){<br>        let SettingPath = String(format: “%@/Documents/Setting.plist”, arguments:[NSHomeDirectory()]);<br>        var dic:NSMutableDictionary = NSMutableDictionary(contentsOfFile: SettingPath)!;<br>        if (dic.objectForKey(“btnText”) != nil) {<br>            dic.setValue(value, forKey: “btnText”);<br>            //true表示IOS會先將資料寫入一個輔助檔案中,然後再將這個檔案改為最後真正的目的地,避免出現錯誤<br>            dic.writeToFile(SettingPath, atomically: true);<br>        }<br>    }<br>}</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   接下來再試試看程式,你會發現即便把APP關掉,下次進來時button的文字會被記錄下來！！</span><br><span class="line">但這邊必須特別注意一點,隨著App的開發可能會對plist有刪減,重新部署到模擬器上時要記得先把舊的APP刪掉,讓Xode幫你重新安裝,原因是我們在AppDelegate.swift的didFinishLaunchingWithOptions寫了 &#96;&#96;&#96;swift</span><br><span class="line">if (!fm.fileExistsAtPath(destinationPath))</span><br><span class="line">&#123;</span><br><span class="line">   &#x2F;&#x2F;如果在documents資料夾底下找不到該檔案,則複製一份過去</span><br><span class="line">   fm.copyItemAtPath(path, toPath: destinationPath, error: nil);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>也就是說複製過一次後,之後的欄位有增減都無法改到Documents資料夾底下的那份plist了,所以只能刪除重裝！！</div></p>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] 製作IOS Table (1)基本的Tabel語法</title>
    <url>/2015/03/02/swift-%E8%A3%BD%E4%BD%9CIOS-Table-1-%E5%9F%BA%E6%9C%AC%E7%9A%84Tabel%E8%AA%9E%E6%B3%95/</url>
    <content><![CDATA[<p>首先必須讓Controller符合UITableViewDelegate , UITableViewDataSource的規範,並將table元件的delegate與datasource指定為自己這個controller </p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OptionViewController</span>: <span class="title">UIViewController</span> , <span class="title">UITableViewDelegate</span> , <span class="title">UITableViewDataSource</span> </span>&#123;</span><br><span class="line">   <span class="keyword">@IBOutlet</span> <span class="keyword">weak</span> <span class="keyword">var</span> <span class="type">UIOptionTable</span>: <span class="type">UITableView</span>!</span><br><span class="line">   <span class="keyword">var</span> data : [<span class="type">String</span>]<span class="operator">!</span>; <span class="comment">//資料來源</span></span><br><span class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span>()</span> &#123;</span><br><span class="line">      <span class="keyword">super</span>.viewDidLoad();</span><br><span class="line">      <span class="keyword">self</span>.<span class="type">UIOptionTable</span>.delegate <span class="operator">=</span> <span class="keyword">self</span>;</span><br><span class="line">      <span class="keyword">self</span>.<span class="type">UIOptionTable</span>.dataSource <span class="operator">=</span> <span class="keyword">self</span>;</span><br><span class="line"></span><br><span class="line">      data <span class="operator">=</span> [];</span><br><span class="line">      data.append(<span class="string">&quot;便當&quot;</span>);</span><br><span class="line">      data.append(<span class="string">&quot;雞腿便當&quot;</span>);</span><br><span class="line">      data.append(<span class="string">&quot;排骨便當&quot;</span>); </span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>再來override幾個主要的事件 </p>
<figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"><span class="comment">//這個table包含幾個section</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">numberOfSectionsInTableView</span>(<span class="params">tableView</span>: <span class="type">UITableView</span>!)</span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//每個section有幾個row</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span>(<span class="params">tableView</span>: <span class="type">UITableView</span>, <span class="params">numberOfRowsInSection</span> <span class="params">section</span>: <span class="type">Int</span>)</span> -&gt; <span class="type">Int</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> data.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//每個row顯示的內容</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">tableView</span>(<span class="params">tableView</span>: <span class="type">UITableView</span>, <span class="params">cellForRowAtIndexPath</span> <span class="params">indexPath</span>: <span class="type">NSIndexPath</span>)</span> -&gt; <span class="type">UITableViewCell</span> &#123;</span><br><span class="line">   <span class="keyword">let</span> identifier <span class="operator">=</span> <span class="string">&quot;cellid&quot;</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> cell:<span class="type">UITableViewCell</span>? <span class="operator">=</span> uitable.dequeueReusableCellWithIdentifier(identifier) <span class="keyword">as?</span> <span class="type">UITableViewCell</span>;</span><br><span class="line">   <span class="keyword">if</span>(cell <span class="operator">==</span> <span class="literal">nil</span>)&#123;</span><br><span class="line">      cell <span class="operator">=</span> <span class="type">UITableViewCell</span>(style: <span class="type">UITableViewCellStyle</span>.<span class="type">Default</span>, reuseIdentifier: identifier);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//indexPath.row 可以知道目前是要製作第幾列的view</span></span><br><span class="line">   cell<span class="operator">?</span>.textLabel<span class="operator">?</span>.text <span class="operator">=</span> data[indexPath.row];</span><br><span class="line">   <span class="keyword">return</span> cell<span class="operator">!</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>結果～<br><a href="http://4.bp.blogspot.com/-qqtvEEeaF4I/VPP6qLF7NzI/AAAAAAAAEV0/XVhTAJY0v2M/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%881.52.17.png"><img src="http://4.bp.blogspot.com/-qqtvEEeaF4I/VPP6qLF7NzI/AAAAAAAAEV0/XVhTAJY0v2M/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%881.52.17.png"></a></p>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] 製作動畫</title>
    <url>/2015/03/11/swift-%E8%A3%BD%E4%BD%9C%E5%8B%95%E7%95%AB/</url>
    <content><![CDATA[<p>目標結果如圖<br><a href="http://4.bp.blogspot.com/-fKXQDTPrOC8/VQALsuP92ZI/AAAAAAAAEjA/RTTpI5_XcNo/s1600/test.gif"><img src="http://4.bp.blogspot.com/-fKXQDTPrOC8/VQALsuP92ZI/AAAAAAAAEjA/RTTpI5_XcNo/s400/test.gif"></a> </p>
<ul>
<li>  首先先把最後所有按鈕要放的位置擺好<a href="http://2.bp.blogspot.com/-dYH-zlfMbWQ/VQAMMcsEqkI/AAAAAAAAEjI/lr2ibFIk0ho/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-11%2B%E4%B8%8B%E5%8D%885.33.36.png"><img src="http://2.bp.blogspot.com/-dYH-zlfMbWQ/VQAMMcsEqkI/AAAAAAAAEjI/lr2ibFIk0ho/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-11%2B%E4%B8%8B%E5%8D%885.33.36.png"></a></li>
<li>把每個按鈕跟ViewController做對應 ```swift<br>@IBOutlet weak var backgroundImageView: UIImageView!<br>  @IBOutlet weak var fbButton: UIButton!<br>  @IBOutlet weak var twitterButton: UIButton!<br>  @IBOutlet weak var messageButton: UIButton!<br>  @IBOutlet weak var mailButton: UIButton!</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   接著用CGAffineTransformMakeTranslation的方式將所有按鈕移到動畫的起始位置,</span><br><span class="line">這邊解釋一下程式中那些數字怎麼決定的,CGAffineTransformMakeTranslation需要給定x y值,如果(0, -300)表示x軸不動,Y軸比原本你在StoryBoard放的位置還要**&lt;span style&#x3D;&quot;color: red;&quot;&gt;往上&lt;&#x2F;span&gt;**移300個點的位置,反之(0, 300)則表示比原本擺放的位置**&lt;span style&#x3D;&quot;color: red;&quot;&gt;往下&lt;&#x2F;span&gt;**移動300點 &#96;&#96;&#96;swift</span><br><span class="line">override func viewDidLoad() &#123;</span><br><span class="line">        super.viewDidLoad()</span><br><span class="line">        self.fbButton.transform &#x3D; CGAffineTransformMakeTranslation(0, -300)</span><br><span class="line">        self.messageButton.transform &#x3D; CGAffineTransformMakeTranslation(0, -364)</span><br><span class="line">        self.mailButton.transform &#x3D; CGAffineTransformMakeTranslation(0, 300)</span><br><span class="line">        self.twitterButton.transform &#x3D; CGAffineTransformMakeTranslation(0, 364)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>接著大家測試一下程式,應該會發現東西的確是跑出螢幕了,接著在viewDidAppear補上以下程式碼就大功告成了！！ ```swift<br>override func viewDidAppear(animated: Bool) {</p>
<pre><code>  super.viewDidAppear(animated)

      //動畫,分成兩個區塊是因為有快有慢,差別在於delay多久再發動,usingSpringWithDamping是彈跳的反作用力,越小越劇烈
  UIView.animateWithDuration(0.9, delay: 0, usingSpringWithDamping: 0.5, initialSpringVelocity: 0.5, options: nil, animations: &#123;
      //跑回原來的點
      let translate = CGAffineTransformMakeTranslation(0, 0)
      self.messageButton.transform = translate
      self.twitterButton.transform = translate
  &#125;, completion: nil)
  UIView.animateWithDuration(0.9, delay: 0.1, usingSpringWithDamping: 0.5, initialSpringVelocity: 0.5, options: nil, animations: &#123;
      let translate = CGAffineTransformMakeTranslation(0, 0)
      self.fbButton.transform = translate
      self.mailButton.transform = translate
  &#125;, completion: nil)
</code></pre>
<p>  }</p>
</li>
</ul>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] 製作IOS Table (5) UITableViewRowAction</title>
    <url>/2015/03/10/swift-%E8%A3%BD%E4%BD%9CIOS-Table-5-UITableViewRowAction/</url>
    <content><![CDATA[<p>開始之前想推薦這本書:<a href="http://www.books.com.tw/products/0010661108">養成iOS8 App程式設計實力的25堂課：最新Swift開發教學</a>,只能說看了對於初學者的我來說受益良多,而且對於IOS很多觀念也更加清楚了</p>
<ul>
<li>  這邊要實作的功能如下圖<br><a href="http://2.bp.blogspot.com/-G5AuWE3jWkc/VP6PU-K4I5I/AAAAAAAAEh4/toN1sTUBTeA/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-10%2B%E4%B8%8B%E5%8D%882.29.02.png"><img src="http://2.bp.blogspot.com/-G5AuWE3jWkc/VP6PU-K4I5I/AAAAAAAAEh4/toN1sTUBTeA/s320/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-10%2B%E4%B8%8B%E5%8D%882.29.02.png"></a></li>
<li>  IOS8的TableView當中,有個可以往左滑可以選擇更多動作的功能,Apple官方有提供相對應的事件可以實作它</li>
<li>  首先先Override TableView commitEditingStyle這個事件,什麼都先不要做就執行看看 ```swift<br>func tableView(tableView: UITableView, commitEditingStyle editingStyle: UITableViewCellEditingStyle, forRowAtIndexPath indexPath: NSIndexPath) {<br>}</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">立馬預設的Delete按鈕就跑出來了</span><br><span class="line">[![](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-maAldiH9hOE&#x2F;VP6RASa2iQI&#x2F;AAAAAAAAEiE&#x2F;3px4PGz4sWU&#x2F;s400&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-10%2B%E4%B8%8B%E5%8D%882.36.30.png)](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-maAldiH9hOE&#x2F;VP6RASa2iQI&#x2F;AAAAAAAAEiE&#x2F;3px4PGz4sWU&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-10%2B%E4%B8%8B%E5%8D%882.36.30.png)</span><br><span class="line">*   接著補上以下code,再實際執行看看就可以發現該列可以刪除了 &#96;&#96;&#96;swift</span><br><span class="line">func tableView(tableView: UITableView, commitEditingStyle editingStyle: UITableViewCellEditingStyle, forRowAtIndexPath indexPath: NSIndexPath) &#123;</span><br><span class="line">        if editingStyle &#x3D;&#x3D; UITableViewCellEditingStyle.Delete&#123;</span><br><span class="line">            &#x2F;&#x2F;將TableView的DataSource刪除</span><br><span class="line">            self.restaurantArray.removeAtIndex(indexPath.row)</span><br><span class="line">            &#x2F;&#x2F;將TableView該列刪除</span><br><span class="line">            tableView.deleteRowsAtIndexPaths([indexPath], withRowAnimation: UITableViewRowAnimation.Fade)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>但如果要客製更多按鈕呢？接下來改寫 editActionsForRowAtIndexPath這個事件,但需要特別注意的是如果我們新增了editActionsForRowAtIndexPath這個事件,則IOS就不會預設幫我們增加Delete的按鈕,所以Delete的按鈕也得自己做瞜～</p>
<p>  先把commitEditingStyle恢復成空值,只讓IOS知道我們要左滑出現功能列就好 ```swift<br>func tableView(tableView: UITableView, commitEditingStyle editingStyle: UITableViewCellEditingStyle, forRowAtIndexPath indexPath: NSIndexPath) {</p>
<pre><code>//把剛剛寫的都刪光光
</code></pre>
<p> }</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">接著改寫editActionsForRowAtIndexPath &#96;&#96;&#96;swift</span><br><span class="line">func tableView(tableView: UITableView, editActionsForRowAtIndexPath indexPath: NSIndexPath) -&gt; [AnyObject]? &#123;</span><br><span class="line">        var shareAction &#x3D; UITableViewRowAction(style: UITableViewRowActionStyle.Default, title: &quot;Share&quot;, handler: nil)</span><br><span class="line">        &#x2F;&#x2F;delete按鈕自己做        var deleteAction &#x3D; UITableViewRowAction(style: UITableViewRowActionStyle.Default, title: &quot;Delete&quot;, handler: &#123;</span><br><span class="line">            (action:UITableViewRowAction! , indexPath:NSIndexPath!) -&gt; Void in</span><br><span class="line">            self.restaurantArray.removeAtIndex(indexPath.row)</span><br><span class="line">            self.restaurantTable.deleteRowsAtIndexPaths([indexPath], withRowAnimation: UITableViewRowAnimation.Fade)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">            return [deleteAction,shareAction]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>執行看看就可以看到多出了一過按鈕了,如果想改變按鈕的顏色可以這樣寫 ```swift<br>shareAction.backgroundColor = UIColor(red: 255/255, green: 166/255, blue: 51/255, alpha: 1)</p>
<p>```</p>
<ul>
<li>  最後就可以得出圖1的結果啦!!!!</li>
</ul>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] 製作IOS Table (3)點擊時展開cell</title>
    <url>/2015/03/02/swift-%E8%A3%BD%E4%BD%9CIOS-Table-3-%E9%BB%9E%E6%93%8A%E6%99%82%E5%B1%95%E9%96%8Bcell/</url>
    <content><![CDATA[<p>常常看到一些APP可以點擊TableCell時會動態展開看到更多的內容<br>製作方式如下 </p>
<ul>
<li>  在Storyboard將cell的高度調整後,把要顯示的更多資料擺進去,此例子是多了兩顆按鈕 <a href="http://2.bp.blogspot.com/-CwqQyzRq7yk/VPQKNbHa4iI/AAAAAAAAEW8/Ci7nqGxKF1I/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%882.56.35.png"><img src="http://2.bp.blogspot.com/-CwqQyzRq7yk/VPQKNbHa4iI/AAAAAAAAEW8/Ci7nqGxKF1I/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%882.56.35.png"></a></li>
<li>  <span style="color: red;">[重要]</span>記得要將tablecell的Clip Subviews打勾,這樣才能呈現擇疊的效果,如果沒打勾隱藏起來的按鈕都會跑出來並且蓋到其他cell上面<br><a href="http://2.bp.blogspot.com/-pT8srgBPCuk/VPQS-rhAmYI/AAAAAAAAEXM/Oo91l9nvB14/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%883.33.38.png"><img src="http://2.bp.blogspot.com/-pT8srgBPCuk/VPQS-rhAmYI/AAAAAAAAEXM/Oo91l9nvB14/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%883.33.38.png"></a></li>
<li>新增一個CellsValue Class ```swift<br>import Foundation<br>public class CellsValue{<br> var title:String!;//標題<br> var expand:Bool = false;//cell是否展開,預設為false<br> init(){}<br>}</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   將controller改寫如下</span><br><span class="line">&#96;&#96;&#96;swift</span><br><span class="line">import UIKit</span><br><span class="line">class ViewController: UIViewController , UITableViewDelegate , UITableViewDataSource&#123;</span><br><span class="line">   @IBOutlet weak var uitable: UITableView!</span><br><span class="line">   var data : [CellsValue]!;</span><br><span class="line">   override func viewDidLoad() &#123;</span><br><span class="line">      super.viewDidLoad()</span><br><span class="line">      uitable.dataSource &#x3D; self;</span><br><span class="line">      uitable.delegate &#x3D; self;</span><br><span class="line">      data &#x3D; [];</span><br><span class="line">      var c &#x3D; CellsValue();</span><br><span class="line">      c.title &#x3D; &quot;便當&quot;;</span><br><span class="line">      data.append(c);</span><br><span class="line">      c &#x3D; CellsValue();</span><br><span class="line">      c.title &#x3D; &quot;雞腿便當&quot;;</span><br><span class="line">      data.append(c);</span><br><span class="line">      c &#x3D; CellsValue();</span><br><span class="line">      c.title &#x3D; &quot;排骨便當&quot;;</span><br><span class="line">      data.append(c);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">      &#x2F;&#x2F;這個table包含幾個section</span><br><span class="line">  func numberOfSectionsInTableView(tableView: UITableView!) -&gt; Int &#123;</span><br><span class="line">     return 1</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F;每個section有幾個row</span><br><span class="line">  func tableView(tableView: UITableView, numberOfRowsInSection section: Int) -&gt; Int &#123;</span><br><span class="line">     return data.count;</span><br><span class="line">  &#125;</span><br><span class="line">  &#x2F;&#x2F;每個row顯示的內容</span><br><span class="line">  func tableView(tableView: UITableView, cellForRowAtIndexPath indexPath: NSIndexPath) -&gt; UITableViewCell &#123;</span><br><span class="line">     let identifier &#x3D; &quot;Customer_Cell&quot;;</span><br><span class="line">     var cell:CustomerCell? &#x3D; uitable.dequeueReusableCellWithIdentifier(identifier) as? CustomerCell;</span><br><span class="line">     if(cell &#x3D;&#x3D; nil)&#123;</span><br><span class="line">        cell &#x3D; CustomerCell(style: UITableViewCellStyle.Default, reuseIdentifier: identifier);</span><br><span class="line">     &#125;</span><br><span class="line">     &#x2F;&#x2F;indexPath.row 可以知道目前是要製作第幾列的view</span><br><span class="line">     cell?.lblTitle?.text &#x3D; data[indexPath.row].title;</span><br><span class="line">     &#x2F;&#x2F;依據是第幾個row決定icon的圖片</span><br><span class="line">     switch indexPath.row&#123;</span><br><span class="line">        case 0:</span><br><span class="line">           cell?.imgIcon.image &#x3D; UIImage(named: &quot;icon-factory&quot;);</span><br><span class="line">           break;</span><br><span class="line">        case 1:</span><br><span class="line">           cell?.imgIcon.image &#x3D; UIImage(named: &quot;icon-location&quot;);</span><br><span class="line">           break;</span><br><span class="line">        case 2:</span><br><span class="line">           cell?.imgIcon.image &#x3D; UIImage(named: &quot;icon-money&quot;);</span><br><span class="line">           break;</span><br><span class="line">        default:</span><br><span class="line">           break;</span><br><span class="line">     &#125;</span><br><span class="line">        return cell!;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>override cell高度的事件heightForRowAtIndexPath ```swift<br>//每個cell的height<br>func tableView(tableView: UITableView, heightForRowAtIndexPath indexPath: NSIndexPath) -&gt; CGFloat {<br>   let cellValue = data[indexPath.row];<br>   //如果cell是展開的話,回傳高度為120<br>   if(cellValue.expand){<br>      return 120;<br>   }<br>   else{<br>      //否則回傳44<br>      return 44;<br>   }<br>}</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   override didSelectRowAtIndexPath事件 &#96;&#96;&#96;swift</span><br><span class="line">&#x2F;&#x2F;cell被選擇的狀況</span><br><span class="line">func tableView(tableView: UITableView, didSelectRowAtIndexPath indexPath: NSIndexPath) &#123;</span><br><span class="line">   data[indexPath.row].expand &#x3D; !data[indexPath.row].expand; &#x2F;&#x2F;將目前狀態相反後存回去</span><br><span class="line">   var cell &#x3D; tableView.cellForRowAtIndexPath(indexPath) as? CustomerCell;</span><br><span class="line">   if(cell !&#x3D; nil)&#123;</span><br><span class="line">      &#x2F;&#x2F;為了讓cell展開或閉合的效果能呈現,所以要呼叫reloadRowsAtIndexPaths讓cell重繪</span><br><span class="line">      uitable.reloadRowsAtIndexPaths([indexPath], withRowAnimation: UITableViewRowAnimation.Automatic)</span><br><span class="line">      &#x2F;&#x2F;不要讓cell有選擇起來的反黑的效果,用這這個語法可以取消選擇</span><br><span class="line">      uitable.deselectRowAtIndexPath(indexPath, animated: false);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>  大功告成,點擊後會展開跟收合的Cell就完成了<br><a href="http://1.bp.blogspot.com/-UsuiKXeY0X0/VPQVLpbKwlI/AAAAAAAAEXY/S2HfG1K_Db4/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%883.45.34.png"><img src="http://1.bp.blogspot.com/-UsuiKXeY0X0/VPQVLpbKwlI/AAAAAAAAEXY/S2HfG1K_Db4/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%883.45.34.png"></a></li>
</ul>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] 製作IOS Table (4)利用xib客製Tabel Cell</title>
    <url>/2015/03/02/swift-%E8%A3%BD%E4%BD%9CIOS-Table-4-%E5%88%A9%E7%94%A8xib%E5%AE%A2%E8%A3%BDTabel-Cell/</url>
    <content><![CDATA[<p>前幾篇是透過StoryBoard來建立客製的cell view<br>這篇則是要寫如何透過xib來完成cell view</p>
<ul>
<li><p>一樣先建立一個對應的Class ```swift<br>import Uikit<br>public class XibCell : UITableViewCell{<br> @IBOutlet weak var lblTitle: UILabel! //title的label<br> @IBOutlet weak var imgIcon: UIImageView! //icon的小圖片</p>
<pre><code> public override init()&#123;
super.init();
</code></pre>
<p> }<br> public required init(coder aDecoder: NSCoder) {</p>
<pre><code>super.init(coder: aDecoder);
</code></pre>
<p> }<br>}</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   建立一個.xib的View</span><br><span class="line">[![](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-i547UQ5vRNc&#x2F;VPQbuDo0_LI&#x2F;AAAAAAAAEXo&#x2F;zna_SQsYioA&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%884.12.47.png)](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-i547UQ5vRNc&#x2F;VPQbuDo0_LI&#x2F;AAAAAAAAEXo&#x2F;zna_SQsYioA&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%884.12.47.png)</span><br><span class="line">*   指定xib的class為XibCell</span><br><span class="line">[![](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-CkRdJKdxYcs&#x2F;VPQcWDhQ8rI&#x2F;AAAAAAAAEXw&#x2F;e334Wa4ZKFc&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%884.14.39.png)](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-CkRdJKdxYcs&#x2F;VPQcWDhQ8rI&#x2F;AAAAAAAAEXw&#x2F;e334Wa4ZKFc&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%884.14.39.png)</span><br><span class="line">*   把UI的關聯拉起來</span><br><span class="line">[![](http:&#x2F;&#x2F;2.bp.blogspot.com&#x2F;-qDluWRV2fRc&#x2F;VPQeGTJOPfI&#x2F;AAAAAAAAEX8&#x2F;Cna7u8bnTWc&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%884.23.35.png)](http:&#x2F;&#x2F;2.bp.blogspot.com&#x2F;-qDluWRV2fRc&#x2F;VPQeGTJOPfI&#x2F;AAAAAAAAEX8&#x2F;Cna7u8bnTWc&#x2F;s1600&#x2F;%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%884.23.35.png)</span><br><span class="line">*   controller的寫法大同小異,但請注意cellForRowAtIndexPath的寫法改變 &#96;&#96;&#96;swift</span><br><span class="line">import UIKit</span><br><span class="line">class xibTableViewController: UIViewController ,UITableViewDelegate , UITableViewDataSource&#123;</span><br><span class="line">   @IBOutlet weak var uitable: UITableView!</span><br><span class="line">   var data :[String]!; &#x2F;&#x2F;資料來源</span><br><span class="line">   override func viewDidLoad() &#123;</span><br><span class="line">   super.viewDidLoad();</span><br><span class="line">      data &#x3D; [];</span><br><span class="line">      data.append(&quot;籃球&quot;);</span><br><span class="line">      data.append(&quot;棒球&quot;);</span><br><span class="line">      data.append(&quot;足球&quot;);</span><br><span class="line">      uitable.delegate &#x3D; self;</span><br><span class="line">      uitable.dataSource &#x3D; self;</span><br><span class="line">   &#125;</span><br><span class="line">   &#x2F;&#x2F;這個table包含幾個section</span><br><span class="line">   func numberOfSectionsInTableView(tableView: UITableView!) -&gt; Int &#123;</span><br><span class="line">      return 1</span><br><span class="line">   &#125;</span><br><span class="line">   &#x2F;&#x2F;每個section有幾個row</span><br><span class="line">   func tableView(tableView: UITableView, numberOfRowsInSection section: Int) -&gt; Int &#123;</span><br><span class="line">      return data.count;</span><br><span class="line">   &#125;</span><br><span class="line">   &#x2F;&#x2F;每個row顯示的內容</span><br><span class="line">   func tableView(tableView: UITableView, cellForRowAtIndexPath indexPath: NSIndexPath) -&gt; UITableViewCell &#123;</span><br><span class="line">      let identifier &#x3D; &quot;cellid&quot;;</span><br><span class="line">      var cell : XibCell? &#x3D; self.uitable.dequeueReusableCellWithIdentifier(identifier) as? XibCell;</span><br><span class="line">      if cell &#x3D;&#x3D; nil&#123;</span><br><span class="line">         &#x2F;&#x2F;載入xib當作cell view</span><br><span class="line">         uitable.registerNib(UINib(nibName: &quot;xibcell&quot;, bundle: nil), forCellReuseIdentifier: identifier);</span><br><span class="line">         cell &#x3D;  self.uitable.dequeueReusableCellWithIdentifier(identifier) as? XibCell;</span><br><span class="line">      &#125;</span><br><span class="line">      &#x2F;&#x2F;indexPath.row 可以知道目前是要製作第幾列的view</span><br><span class="line">      cell?.lblTitle?.text &#x3D; data[indexPath.row];</span><br><span class="line">      cell?.imgIcon.image &#x3D; UIImage(named: &quot;icon-factory&quot;);</span><br><span class="line">      return cell!;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>最後呈現結果<br><a href="http://1.bp.blogspot.com/-wwckeTM90jU/VPQhlTYBXjI/AAAAAAAAEYI/zGIaok2jCHM/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%884.38.21.png"><img src="http://1.bp.blogspot.com/-wwckeTM90jU/VPQhlTYBXjI/AAAAAAAAEYI/zGIaok2jCHM/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-02%2B%E4%B8%8B%E5%8D%884.38.21.png"></a></p>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>【Docker】Widows Container IAM Role 問題</title>
    <url>/2019/02/19/windows_contianer_iamrole_/</url>
    <content><![CDATA[<p><img src="/images/20190219/0.png" alt="/images/20190219/0.png"></p>
<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>通常在使用 EC2 的建議上都是希望將機器掛上 IAM Role 的權限，在機器上面執行相關 AWS 資源時就可以透過該角色的權限來執行，避免將 Access Toke 、Secret Key 寫到程式中去跑。</p>
<p>但如果將程式包到 Container 裡面去執行時卻發現，Linux Container 可以吃到 Host 的 IAM Role 權限，而 Windows Container 卻不行，為何 ?</p>
<br>

<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>原來 AWS 之所以能夠讓機器能知道執行權限為何是否過一個叫 Metadata Service 的服務來達成 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl 169.254.169.254</span><br></pre></td></tr></table></figure>

<p>當在 EC2 上執行該指令應該能看到基本的回應</p>
<p><img src="/images/20190219/1.png" alt="/images/20190219/1.png"></p>
<p>連線到 <code>http://169.254.169.254/latest/meta-data/</code> 也可以看到一些對應的 Metadata 設定，而這個 Metadata Service IP 很巧的在 Azure 上也一模一樣 XD</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html">Instance Metadata and User Data</a></p><p><a href="https://docs.microsoft.com/zh-tw/azure/virtual-machines/windows/instance-metadata-service">Azure 執行個體中繼資料服務</a></p>
          </div>

<br>

<p>所以要能夠透過 IAM Role 的權限來執行 AWS 相關資源，169.254.169.254 就勢必要能通，接著將 Windows Container Run起來並執行相同指令會發現得到 Timeout 的回應</p>
<p><img src="/images/20190219/2.png" alt="/images/20190219/2.png"></p>
<br>

<p>Windows Container 預設是走 <a href="https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2">NAT</a> 的網路模式，如果你在 Host 與 Windows Container 內列出 Routing Table IPv4 的資料會發現，169.254.169.254 Gateway 是走同一條</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ route <span class="built_in">print</span> -4</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/3.png" alt="/images/20190219/3.png"></p>
<p>這也是導致 Container 內得不到回應的原因</p>
<p><img src="/images/20190219/11.png" alt="/images/20190219/11.png"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ipconfig /all</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/4.png" alt="/images/20190219/4.png"></p>
<p>應該透過 NAT Router default gateway 才出的去</p>
<p><img src="/images/20190219/12.png" alt="/images/20190219/12.png"></p>
<br>

<h1 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h1><p>先看看預設 Container 用的網路是如何設定的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker network ls</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/5.png" alt="/images/20190219/5.png"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker network inspect nat</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/6.png" alt="/images/20190219/6.png"></p>
<p>可以看到紅框處並沒有指定 Default Gateway，所以每次執行 Container 時都是動態分配 Subnet 與 Default Gateway，這樣讓我們設定上會有困難</p>
<br>

<h2 id="自建一組網路給-Container-使用"><a href="#自建一組網路給-Container-使用" class="headerlink" title="自建一組網路給 Container 使用"></a>自建一組網路給 Container 使用</h2><p>可以透過 <a href="https://docs.docker.com/engine/reference/commandline/network_create/">Docker network create</a> 來預先建立一組規範好的網路，並讓 Container 起起來的時候指定吃這組設定</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker network create --driver nat --gateway 172.17.0.1 --subnet 172.17.0.0/20 mynetwork</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/7.png" alt="/images/20190219/7.png"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it --rm --network mynetwork mycontainer:latest</span><br></pre></td></tr></table></figure>



<p>檢視 Container 起來後網路設定狀況，可以看到 Default Gateway 已經被定下來了</p>
<p><img src="/images/20190219/8.png" alt="/images/20190219/8.png"></p>
<p>接著執行 </p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ route -p add 169.254.169.254 172.17.0.1</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/9.png" alt="/images/20190219/9.png"></p>
<p><img src="/images/20190219/10.png" alt="/images/20190219/10.png"></p>
<p>至於 route add 怎麼在 Container 起起來時自動執行那就是另一個課題了，這邊不討論</p>
<h2 id="Docker-compose-動態建網路給-Container-使用"><a href="#Docker-compose-動態建網路給-Container-使用" class="headerlink" title="Docker compose 動態建網路給 Container 使用"></a>Docker compose 動態建網路給 Container 使用</h2><p>第二種方法是透過 Docker compose 執行時動態建立一組網路來使用，方法大同小異，只是透過 Docker Compose 來設定而已</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2.1&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mycontainer:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mycontainer:latest</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mynetwork</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">mynetwork:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">nat</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span><span class="string">/20</span></span><br><span class="line">          <span class="attr">gateway:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">      </span><br></pre></td></tr></table></figure>



<h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>最近跟著架構師還有一群很厲害的同事做新的專案，發現自己對於 Infra 與網路的知識真的相當不足，所以在Docker 一些設定與建置上常常卡的亂七八糟，也趁著這個機會把以前一堆已經還老師的知識又惡補了一翻，希望能越來越順利 </p>
<div class="note info">
            <p>參考文章</p><p><a href="https://www.speedoflightmedia.com/blog/aws-iam-roles-windows-containers/">AWSS IAM Roles in Windows Containers</a></p><p><a href="https://zh.wikipedia.org/wiki/%E4%BF%9D%E7%95%99IP%E5%9C%B0%E5%9D%80">wiki - 保留IP位址</a></p>
          </div>

]]></content>
      <tags>
        <tag>Docker</tag>
        <tag>aws</tag>
        <tag>windows container</tag>
      </tags>
  </entry>
  <entry>
    <title>【Docker】Widows Container DNS Server 問題</title>
    <url>/2019/02/20/windows_container_dnsserver/</url>
    <content><![CDATA[<p><img src="/images/20190220/0.png" alt="/images/20190220/0.png"></p>
<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>Windows Container 執行起來的時候，DNS Server 預設會吃 Host 的設定，但第一組會擺 Default Gateway 的 IP</p>
<p><img src="/images/20190220/1.png" alt="/images/20190220/1.png"></p>
<p>但會碰到當在解析  IP 時，只會走第一組 Name Server 去問，如果問不到並不會問第二組，導致解析失敗</p>
<p><img src="/images/20190220/2.png" alt="/images/20190220/2.png"></p>
<p>(需明確指定 Name Server 才能查的到)</p>
<p>聽說這也是 Windows Container 才會碰到的問題，用 Linux 的同事們表示黑人問號 ???</p>
<br>

<h1 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h1><p>DotNet 人有 DotNet 人的玩法，果然找到有人有相同的問題</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://github.com/docker/for-win/issues/397">the –dns option is not working with windows container</a></p>
          </div>

<p>解法就是當 Container 執行起來的時候，用 Powershell 去改 DNS Server 設定 ….</p>
<p>恩 …. 就改吧</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ powershell  Set-DnsClientServerAddress -InterfaceAlias vEthernet* -ServerAddresses 10.2.x.x,10.2.x.x</span><br></pre></td></tr></table></figure>

<p>執行完後重新查詢網路設定會看到 DNS Server 第一組已經不是 Default Gateway</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ipconfig /all</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190220/4.png" alt="/images/20190220/4.png"></p>
<p>這時候在重新查一次 IP ，不用特別指定 Name Server 就正確了</p>
<p><img src="/images/20190220/3.png" alt="/images/20190220/3.png"></p>
<h1 id="同場加映"><a href="#同場加映" class="headerlink" title="同場加映"></a>同場加映</h1><p>這邊特別介紹 <a href="https://docs.docker.com/v17.09/engine/userguide/networking/default_network/configure-dns/">dns_search</a> 這個 docker 參數</p>
<p><img src="/images/20190220/5.png" alt="/images/20190220/5.png"></p>
<p>因為公司測試機都有加入 AD 群組，所以伺服器別名即便不寫全名還是可以查的到，但在 Container 內就不是這麼回事了，必須寫完整的全名不可，原本以為要改 Config ，請大家都寫完整，還好同事提醒有這個參數可以使用。</p>
<p>只要在 Docker Run 時或是 Docker Compose 設定加上 Domain Name，這樣 Container 找不到時就會加上 Domain Name 在完整搜尋一次</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">dns_search:</span> <span class="string">your.domain</span></span><br></pre></td></tr></table></figure>



<p>這參數又拯救了 IT 狗的一天…</p>
]]></content>
      <tags>
        <tag>Docker</tag>
        <tag>windows container</tag>
      </tags>
  </entry>
  <entry>
    <title>ThreadPool</title>
    <url>/2019/08/01/threadpool/</url>
    <content><![CDATA[<div class="note info">
            <p>GitHub SourceCode : <a href="https://github.com/toyo0103/ThreadPoolDemo">連結</a></p>
          </div>

<p>自從加入精神時光屋團隊後，對於一些平行處理、多執行序等程式掌控力就越來越要求。為了不要當拖油瓶，這次練習的是 ThreadPoll，從這個練習可以更精準掌握 Thread 控制技巧。</p>
<br>

<h1 id="目標"><a href="#目標" class="headerlink" title="目標"></a>目標</h1><p>建立 Thread 其實是需要成本的，所以頻繁的建立 Thread 砍掉 Thread 相當耗效能，另一方面，如果等到有 Task 才開始建立 Thread 可能會導致第一個 Task 回應速度過慢。例如 : IIS 底層就有 ThreadPool ，為了因應 Request 進來時能更快速的回應，但又不能為了一昧追求速度不管資源的有效運用，所以ThreadPool 應該有增長跟最低維持幾條的上下限。</p>
<p>依據上面描述定義以下目標</p>
<ol>
<li>自製 ThreadPool</li>
<li>依據 Task 量決定 Thread 的數量，Task 過多會加開 Thread 處理，反之會減少</li>
<li>ThreadPool 可以設定 Thread 數量上下限 </li>
</ol>
<br>

<h1 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h1><p>希望呼叫的方式如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 建立自己的 ThreadPool ，設定 Thread 至少保持 3 條，上限不超過 10 條 </span></span><br><span class="line">        MyThreadPool myTreadPool = <span class="keyword">new</span> MyThreadPool(<span class="number">3</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一值塞任務進去,不管任務執行完了沒</span></span><br><span class="line">        <span class="comment">// 所以 ThreadPool 應該要能接住 Task 讓它們排隊消耗 </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            myTreadPool.Enqueue(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.ReadKey();</span><br><span class="line">        <span class="comment">// 等待執行結束</span></span><br><span class="line">        myTreadPool.WaitFinished();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p><strong>MyThreadPool</strong> </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyThreadPool</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingCollection&lt;<span class="built_in">int</span>&gt; _jobQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _minThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _maxThread;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThreadPool</span>(<span class="params"><span class="built_in">int</span> minThread,<span class="built_in">int</span> maxThread</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>._minThread = minThread;</span><br><span class="line">        <span class="keyword">this</span>._maxThread = maxThread;</span><br><span class="line">        <span class="comment">// 最多只能放 100 個 Task</span></span><br><span class="line">        <span class="keyword">this</span>._jobQueue = <span class="keyword">new</span> BlockingCollection&lt;<span class="built_in">int</span>&gt;(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WaitFinished</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enqueue</span>(<span class="params"><span class="built_in">int</span> i</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _jobQueue.TryAdd(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>實作 ThreadPool 保有最少的 Thread</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyThreadPool</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingCollection&lt;<span class="built_in">int</span>&gt; _jobQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _minThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _maxThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _currentThreadCount;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;Thread&gt; _threads;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThreadPool</span>(<span class="params"><span class="built_in">int</span> minThread,<span class="built_in">int</span> maxThread</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>._minThread = minThread;</span><br><span class="line">        <span class="keyword">this</span>._maxThread = maxThread;</span><br><span class="line">        <span class="keyword">this</span>._jobQueue = <span class="keyword">new</span> BlockingCollection&lt;<span class="built_in">int</span>&gt;(<span class="number">100</span>);</span><br><span class="line">        <span class="keyword">this</span>._currentThreadCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>._threads = <span class="keyword">new</span> List&lt;Thread&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; minThread; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.CreateThread();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateThread</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">int</span> id = Interlocked.Increment(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">        <span class="keyword">if</span> (id &gt; _maxThread)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 可開的 Thread 到達極限, 無法加開</span></span><br><span class="line">            Interlocked.Decrement(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(ThreadBody);</span><br><span class="line">        thread.Name = <span class="string">$&quot;Thread-<span class="subst">&#123;id&#125;</span>&quot;</span>;</span><br><span class="line">        thread.Start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>._threads.Add(thread);</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Thread count : <span class="subst">&#123;<span class="keyword">this</span>._currentThreadCount&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ThreadBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>實作 TheadBody </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ThreadBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> name = Thread.CurrentThread.Name;</span><br><span class="line">    Console.WriteLine(name + <span class="string">&quot; starts&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有 Task 還沒有塞完就一直搶來處理</span></span><br><span class="line">    <span class="keyword">while</span> (!<span class="keyword">this</span>._jobQueue.IsCompleted)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> task = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(_jobQueue.TryTake(<span class="keyword">out</span> task, <span class="number">100</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 模擬 Task 要執行的時間, 0.1 ~ 0.5秒不等</span></span><br><span class="line">            Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">            <span class="built_in">int</span> excuteTime = <span class="number">0</span>;</span><br><span class="line">            excuteTime = rnd.Next(<span class="number">100</span>, <span class="number">500</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;name&#125;</span> do task_<span class="subst">&#123;task&#125;</span> spend <span class="subst">&#123;excuteTime&#125;</span> ms&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            Thread.Sleep(excuteTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(name + <span class="string">&quot; are closed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這邊會有一個問題, 如果塞 Task 的速度不定, 可能時快時慢, 如果中間間隔過長會導致 Thread 一直拿不到 Task 來工作卻又停不下來, 持續空轉 , 所以必須加一個機制讓它等待, 並在必要時刻喚醒</p>
<br>

<p><strong>ManualResetEvent</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> ManualResetEvent _mre;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyThreadPool</span>(<span class="params"><span class="built_in">int</span> minThread,<span class="built_in">int</span> maxThread</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">this</span>._mre = <span class="keyword">new</span> ManualResetEvent(<span class="literal">false</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ThreadBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> name = Thread.CurrentThread.Name;</span><br><span class="line">    Console.WriteLine(name + <span class="string">&quot; starts&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有 Task 還沒有塞完就一直搶來處理</span></span><br><span class="line">    <span class="keyword">while</span> (!<span class="keyword">this</span>._jobQueue.IsCompleted)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> task = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(_jobQueue.TryTake(<span class="keyword">out</span> task, <span class="number">100</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">            <span class="built_in">int</span> excuteTime = <span class="number">0</span>;</span><br><span class="line">            excuteTime = rnd.Next(<span class="number">100</span>, <span class="number">500</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;name&#125;</span> do task_<span class="subst">&#123;task&#125;</span> spend <span class="subst">&#123;excuteTime&#125;</span> ms&quot;</span>);</span><br><span class="line">            Thread.Sleep(excuteTime);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		_mre.WaitOne();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>MSDN : <a href="https://docs.microsoft.com/zh-tw/dotnet/api/system.threading.manualresetevent?view=netframework-4.8">ManualResetEvent Class</a> </p>
<p>ManualResetEvent 就像是個手動的紅綠燈, 可以將 Thread Block 在 WaitOne 這行, 直到呼叫 ManualResetEvent.Set()將燈號切成綠燈, 全部的 Thread 才會往下繼續執行。</p>
<p>與之相對的是 <a href="https://docs.microsoft.com/zh-tw/dotnet/api/system.threading.autoresetevent?view=netframework-4.8">AutoResetEvent Class</a> , 差別只在於 ManualResetEvent 呼叫 Set (綠燈), Reset (紅燈)。而 AutoResetEvent 呼叫 Set 每次只會隨機放一條 Thread , 不像 ManualRestEvent 是全部放</p>
<br>

<p><strong>Enqueue</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enqueue</span>(<span class="params"><span class="built_in">int</span> i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 表示容量滿了</span></span><br><span class="line">    <span class="keyword">while</span> (_jobQueue.TryAdd(i) == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Queue Length 過長, 需加開 Thread</span></span><br><span class="line">        <span class="keyword">this</span>.CreateThread();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 切成綠燈, 放掉所有 Thread 開始搶工作做</span></span><br><span class="line">	_mre.Set();</span><br><span class="line">    <span class="comment">// 切成紅燈, 如果有 Tread 搶不到事情來做又會被 Block 在 _mre.WaitOne(); 那行</span></span><br><span class="line">    _mre.Reset();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p><strong>實作動態伸縮 Thread 數量</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ThreadBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   ...</span><br><span class="line">       </span><br><span class="line"><span class="keyword">while</span> (!<span class="keyword">this</span>._jobQueue.IsCompleted)</span><br><span class="line">   &#123;</span><br><span class="line">        <span class="keyword">if</span> (_mre.WaitOne(<span class="number">5000</span>) == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 進到這邊表示 Thread 並不是因為_mre.Set()被喚醒, 而是5秒 timeout</span></span><br><span class="line">            <span class="comment">// 嘗試回收 Thread</span></span><br><span class="line">            <span class="keyword">if</span> (Interlocked.Decrement(<span class="keyword">ref</span> _currentThreadCount) &lt; _minThread)</span><br><span class="line">            &#123;</span><br><span class="line">                Interlocked.Increment(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Thread count : <span class="subst">&#123;<span class="keyword">this</span>._currentThreadCount&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   Console.WriteLine(name + <span class="string">&quot; are closed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p><strong>WaitFinished</strong></p>
<p>這個方法如果被呼叫時, 應該將所有 Thread 都喚醒, 並且等待每個 Thread 都執行完畢</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WaitFinished</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._jobQueue.CompleteAdding();</span><br><span class="line">    _mre.Set();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> t <span class="keyword">in</span> _threads)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            t.Join();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>**完整版的 Code **</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 建立自己的 ThreadPool ，設定 Thread 至少保持 3 條，上限不超過 10 條 </span></span><br><span class="line">        MyThreadPool myTreadPool = <span class="keyword">new</span> MyThreadPool(<span class="number">3</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一值塞任務進去,不管任務執行完了沒</span></span><br><span class="line">        <span class="comment">// 所以 ThreadPool 應該要能接住 Task 讓它們排隊消耗 </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            myTreadPool.Enqueue(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.ReadKey();</span><br><span class="line">        <span class="comment">// 等待執行結束</span></span><br><span class="line">        myTreadPool.WaitFinished();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyThreadPool</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingCollection&lt;<span class="built_in">int</span>&gt; _jobQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _minThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _maxThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _currentThreadCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ManualResetEvent _mre;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Thread&gt; _threads;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThreadPool</span>(<span class="params"><span class="built_in">int</span> minThread,<span class="built_in">int</span> maxThread</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>._minThread = minThread;</span><br><span class="line">        <span class="keyword">this</span>._maxThread = maxThread;</span><br><span class="line">        <span class="comment">// 最多只能放 100 個 Task</span></span><br><span class="line">        <span class="keyword">this</span>._jobQueue = <span class="keyword">new</span> BlockingCollection&lt;<span class="built_in">int</span>&gt;(<span class="number">100</span>);</span><br><span class="line">        <span class="keyword">this</span>._currentThreadCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>._mre = <span class="keyword">new</span> ManualResetEvent(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">this</span>._threads = <span class="keyword">new</span> List&lt;Thread&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; minThread; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.CreateThread();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateThread</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">int</span> id = Interlocked.Increment(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">        <span class="keyword">if</span> (id &gt; _maxThread)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 可開的 Thread 到達極限, 無法加開</span></span><br><span class="line">            Interlocked.Decrement(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(ThreadBody);</span><br><span class="line">        thread.Name = <span class="string">$&quot;Thread-<span class="subst">&#123;id&#125;</span>&quot;</span>;</span><br><span class="line">        thread.Start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>._threads.Add(thread);</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Thread count : <span class="subst">&#123;<span class="keyword">this</span>._currentThreadCount&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WaitFinished</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>._jobQueue.CompleteAdding();</span><br><span class="line">        _mre.Set();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> t <span class="keyword">in</span> _threads)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (t != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                t.Join();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enqueue</span>(<span class="params"><span class="built_in">int</span> i</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _mre.Set();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 表示容量滿了</span></span><br><span class="line">        <span class="keyword">while</span> (_jobQueue.TryAdd(i) == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Queue Length 過長, 需加開 Thread</span></span><br><span class="line">            <span class="keyword">this</span>.CreateThread();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _mre.Reset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ThreadBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">string</span> name = Thread.CurrentThread.Name;</span><br><span class="line">        Console.WriteLine(name + <span class="string">&quot; starts&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果有 Task 還沒有塞完就一直搶來處理</span></span><br><span class="line">        <span class="keyword">while</span> (!<span class="keyword">this</span>._jobQueue.IsCompleted)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> task = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>(_jobQueue.TryTake(<span class="keyword">out</span> task, <span class="number">100</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">                <span class="built_in">int</span> excuteTime = <span class="number">0</span>;</span><br><span class="line">                excuteTime = rnd.Next(<span class="number">100</span>, <span class="number">500</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;name&#125;</span> do task_<span class="subst">&#123;task&#125;</span> spend <span class="subst">&#123;excuteTime&#125;</span> ms&quot;</span>);</span><br><span class="line">                Thread.Sleep(excuteTime);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_mre.WaitOne(<span class="number">5000</span>) == <span class="literal">false</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 此條 Thread 5秒都沒有工作, 嘗試收掉</span></span><br><span class="line">                <span class="keyword">if</span> (Interlocked.Decrement(<span class="keyword">ref</span> _currentThreadCount) &lt; _minThread)</span><br><span class="line">                &#123;</span><br><span class="line">                    Interlocked.Increment(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;Thread count : <span class="subst">&#123;<span class="keyword">this</span>._currentThreadCount&#125;</span>&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(name + <span class="string">&quot; are closed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="執行結果"><a href="#執行結果" class="headerlink" title="執行結果"></a>執行結果</h1><p>執行中應該可以看到 Task 消化不夠快而加開 Thread </p>
<p><img src="/images/20190801/1.png" alt="/images/20190801/1.png"></p>
<p>最後因為程式在等待 ReadKey(), 如果超過 5 秒不按會看到 Thread 收掉的訊息</p>
<p> <img src="/images/20190801/2.png" alt="/images/20190801/2.png"></p>
<p>按下任意鍵,就會全部收掉並關閉程式</p>
]]></content>
      <tags>
        <tag>LeetCode</tag>
        <tag>精神時光屋</tag>
      </tags>
  </entry>
  <entry>
    <title>【Docker】Widows Container SMB</title>
    <url>/2019/03/23/windows_container_smb_/</url>
    <content><![CDATA[<p><img src="/images/20190323/0.png" alt="/images/20190323/0.png"></p>
<p>之前在將公司某支程式移植到 Windows Container 時碰到一個問題，該程式會透過<a href="https://zh.wikipedia.org/wiki/%E4%BC%BA%E6%9C%8D%E5%99%A8%E8%A8%8A%E6%81%AF%E5%8D%80%E5%A1%8A">網路磁碟 (SMB)</a> Eamil Template 來套版並寄出，但將網路磁碟透過 Volume 的方式 Mount 到 Container 卻抓不到檔案，查了一下才知道原來需要用 SmbGlobalMapping 掛載的網路磁碟才行</p>
<div class="note info">
            <p><a href="https://docs.microsoft.com/zh-tw/virtualization/windowscontainers/manage-containers/container-storage">Windows Server 容器儲存體</a></p>
          </div>

<p>以下這段是先將要用到的網路磁碟透過 New-SmbGlobalMapping 指令掛成 T: </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="variable">$User</span>=<span class="string">&quot;yourUSerAccount&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="variable">$PWD</span> = ConvertTo-SecureString -String <span class="string">&quot;yourPassword&quot;</span> -AsPlainText -Force</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="variable">$Credential</span> = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList <span class="variable">$User</span>, <span class="variable">$PWD</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> New-SmbGlobalMapping -LocalPath T: -RemotePath \\my-company-Filer\Files -Credential <span class="variable">$Credential</span></span></span><br></pre></td></tr></table></figure>

<p>然後在透過 Volume 即可</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it -v T:\:C:\Files myContainer</span></span><br></pre></td></tr></table></figure>

<br >

<div class="note danger">
            <p>不過還要特別注意的是，在 Windows Server (版本 1709)，SMB 全域對應不支援 DFS、DFSN、DFSR 共用。</p>
          </div>

<p>所以如果是 <a href="https://zh.wikipedia.org/wiki/%E5%88%86%E6%95%A3%E5%BC%8F%E6%AA%94%E6%A1%88%E7%B3%BB%E7%B5%B1_(Microsoft)">DFS</a> 那就只好先強制指到某一台，期待哪一天 Windows Container 可以支援了</p>
]]></content>
      <tags>
        <tag>Docker</tag>
        <tag>windows container</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】Yield Return (二)</title>
    <url>/2019/03/15/yield_return_2/</url>
    <content><![CDATA[<p><img src="/images/20190315/0.jpg" alt="/images/20190315/0.jpg"></p>
<p>最近經過大師的指導後，對於 Yield Return 又或是迭代器有更深的感受，先來看一段以前常常會寫的程式</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> users = GetUser(idList);</span><br><span class="line">	<span class="comment">//過濾黑名單</span></span><br><span class="line">	<span class="keyword">var</span> notInBlackList = users.Where(x=&gt; !x.InBlackList);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//往下做其他邏輯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">GetUser</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; ids</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//透過 ID 取得會員的詳細資料</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 Id 一次有一百萬筆，為了避免擊沉 Database 做了分批查詢也是很合理的</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> users = GetUser(idList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//過濾黑名單</span></span><br><span class="line">	<span class="keyword">var</span> notInBlackList = users.Where(x=&gt; !x.InBlackList);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//往下做其他邏輯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">GetUser</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; ids</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;User&gt;();</span><br><span class="line">	<span class="comment">// 每批搜尋 1000筆</span></span><br><span class="line">	<span class="keyword">var</span> batchCount = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//計算出搜尋次數後分批查詢</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; 搜尋次數; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		Result.AddRange(</span><br><span class="line">			UserRepository.Get(ids.Skip(i * batchCount).Take(batchCount)));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>當然也可以從呼叫端分批處理</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 每批搜尋 1000筆</span></span><br><span class="line">	<span class="keyword">var</span> batchCount = <span class="number">1000</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; 搜尋次數; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">var</span> users = GetUser(idList);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//過濾黑名單</span></span><br><span class="line">		<span class="keyword">var</span> notInBlackList = users.Where(x=&gt; !x.InBlackList);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//往下做其他邏輯</span></span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">GetUser</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; ids</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//透過 ID 取得會員的詳細資料</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要再更複雜一些，要依據使用者的設定濾掉一些人，最終要將處理過程都填回 DB ，以便追蹤那些人是因為那些條件被過濾掉的 (不然被客戶抱怨沒收到通知，不知道往哪找)，這時候程式就會變成這樣….</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 每批搜尋 1000筆</span></span><br><span class="line">	<span class="keyword">var</span> batchCount = <span class="number">1000</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">var</span> temp = <span class="keyword">new</span> List&lt;User&gt;()</span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; 搜尋次數; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">var</span> users = GetUser(idList);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> notInBlackList = users.Where(x=&gt; !x.InBlackList);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> wantToReceiveThisMessage = notInBlackList.Where(x =&gt; x.BlockMessageType != ThisMessageType);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//統計誰在黑名單被過濾掉</span></span><br><span class="line">		<span class="comment">//統計誰不想收到這種類型的 DB</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//可能批次更新是 5000 筆最有效率</span></span><br><span class="line">		temp.Add(InBlackList);</span><br><span class="line">		temp.Add(DontWantToReceiveThisMessage);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (temp.Count &gt; <span class="number">5000</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Insert Log</span></span><br><span class="line">			LogRepository.Add(temp);</span><br><span class="line">			temp.Clear();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">GetUser</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; ids</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//透過 ID 取得會員的詳細資料</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>條件可以無限增長上去，程式也會變得越來越複雜，當然這時候可以採取一些物件導向的設計將功能職責拆開，不過這不是這篇的重點所以跳過。</p>
<h1 id="更符合語意的寫法"><a href="#更符合語意的寫法" class="headerlink" title="更符合語意的寫法"></a>更符合語意的寫法</h1><p>如果有用過 <a href="https://fluentassertions.com/">FluentAssertion</a>、<a href="https://nsubstitute.github.io/">Nsubstitute</a> 等套件，應該會發現它 API 設計得非常好讀好懂</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">customer.Active.Should().BeTrue(because, becauseArgs);</span><br><span class="line"></span><br><span class="line">theObject.Should().NotBeSameAs(otherObject);</span><br></pre></td></tr></table></figure>

<p>讓程式不再是一段一段的，而是一看程式就能理解這邊在做什麼，而且也因為如此讓每個方法的職責更清楚單一，所以我們可以將上述的程式改成</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//從使用端傳來一大批 Ids List</span></span><br><span class="line">	Ids.GetUser().NotInBlackList().WantToReceiveThisMessage(ThisMessageType).Record();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;User&gt; <span class="title">GetUser</span>(<span class="params"><span class="keyword">this</span> IEnumerable&lt;<span class="built_in">int</span>&gt; ids</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> temp = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="keyword">var</span> id <span class="keyword">in</span> ids)</span><br><span class="line">	&#123;</span><br><span class="line">		temp.Add(id);</span><br><span class="line">		<span class="comment">// 假設每 1000 筆是有最好的搜尋效率</span></span><br><span class="line">		<span class="keyword">if</span> (temp.Count == <span class="number">1000</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">foreach</span> (<span class="keyword">var</span> user <span class="keyword">in</span> UserRepository.Get(temp))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">yield</span> <span class="keyword">return</span> user;</span><br><span class="line">			&#125;</span><br><span class="line">			temp.Clear();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (temp.Count &gt; <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="keyword">var</span> user <span class="keyword">in</span> UserRepository.Get(temp))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">yield</span> <span class="keyword">return</span> user;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;User&gt; <span class="title">NotInBlackList</span>(<span class="params"><span class="keyword">this</span> IEnumerable&lt;User&gt; users</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="keyword">var</span> user <span class="keyword">in</span> users)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (user.InBlackList == <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">yield</span> <span class="keyword">return</span> user;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;User&gt; <span class="title">NotInBlackList</span>(<span class="params"><span class="keyword">this</span> IEnumerable&lt;User&gt; users, MessageType type</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="keyword">var</span> user <span class="keyword">in</span> users)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (user.BlockMessageType != type)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">yield</span> <span class="keyword">return</span> user;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;User&gt; <span class="title">Record</span>(<span class="params"><span class="keyword">this</span> IEnumerable&lt;User&gt; users</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> temp = <span class="keyword">new</span> List&lt;User&gt;();</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="keyword">var</span> user <span class="keyword">in</span> users)</span><br><span class="line">	&#123;</span><br><span class="line">		temp.Add(user);</span><br><span class="line">		<span class="keyword">if</span> (temp.Count == <span class="number">5000</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Insert Log</span></span><br><span class="line">			LogRepository.Add(temp);</span><br><span class="line">			temp.Clear();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">yield</span> <span class="keyword">return</span> user;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (temp.Count &gt; <span class="number">5000</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		LogRepository.Add(temp);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>如果還需要紀錄每個過程的分別過濾的狀態，只需要在方法開個統計的物件參數，在每筆過程中做紀錄即可，不只讓整個程式可讀性更高、內聚更強，之後如果不想要紀錄或不想要過濾黑名單，也可以很快的調整完成</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Ids.GetUser().WantToReceiveThisMessage(ThisMessageType);</span><br></pre></td></tr></table></figure>]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【.NET】防止XSS攻擊</title>
    <url>/2014/06/03/%E3%80%90-NET%E3%80%91%E9%98%B2%E6%AD%A2XSS%E6%94%BB%E6%93%8A/</url>
    <content><![CDATA[<p>一直都有聽過XSS攻擊的原理跟方式，但都沒有好好認真研究過，剛好最近看到一個小遊戲在這邊推薦給大家:<br><a href="https://xss-game.appspot.com/level1">瞭解XSS攻擊的小遊戲</a></p>
<p>查了一下.NET防止XSS攻擊的有效方法，剛好保哥有寫過相關的文章<br><a href="http://blog.miniasp.com/post/2009/09/26/Recommand-Microsoft-Anti-XSS-Library-V31.aspx">保哥-推薦使用 Microsoft Anti-Cross Site Scripting Library v3.1</a><br>裡面介紹的非常詳細，這邊就不再多做贅述了。</p>
<p>唯一需要特別注意的地方是Anti-XSS Library在4.2版的時候將GetSafeHtml 、GetSafeHtmlFragment移到了新的DLL了。所以如果依照文章去下載這個DLL會發現沒有這兩個方法可用，請改用Nuget搜尋HtmlSanitizationLibrary</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://4.bp.blogspot.com/-El2JuoTjn70/U42JPHwLqqI/AAAAAAAAEOM/z99tk-Wb_AI/s1600/1.png)](http://4.bp.blogspot.com/-El2JuoTjn70/U42JPHwLqqI/AAAAAAAAEOM/z99tk-Wb_AI/s1600/1.png)</div>

<p>使用方法也變成 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Sanitizer.GetSafeHtmlFragment(inputext);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>真是很好很強大阿!!!!</p>
]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【ASP】 動態新增GridView的 TemplateField欄位</title>
    <url>/2013/06/13/%E3%80%90ASP%E3%80%91-%E5%8B%95%E6%85%8B%E6%96%B0%E5%A2%9EGridView%E7%9A%84-TemplateField%E6%AC%84%E4%BD%8D/</url>
    <content><![CDATA[<p>因為某些搜尋條件的不同，造成要顯示的欄位可能也略有差異，一般可以透過多個GridView隱藏來隱藏去的方法，或是動態將某些Column隱藏起來，今天試的方法是在搜尋完後DataBind之前先將GridView的欄位換成自己想要的，新增一般<strong>BoundField</strong>沒什麼太特別的，但TemplateField就卡關了….參考很多資料後來做個筆記!!!</p>
<ul>
<li>先將該準備的類別與方法準備好<figure class="highlight vb"><table><tr><td class="code"><pre><span class="line"><span class="comment">&#x27;&#x27;&#x27; <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment">&#x27;&#x27;&#x27; 複製控制項</span></span><br><span class="line">    <span class="comment">&#x27;&#x27;&#x27; <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment">&#x27;&#x27;&#x27; <span class="doctag">&lt;param name=&quot;taget&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment">&#x27;&#x27;&#x27; <span class="doctag">&lt;param name=&quot;source&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment">&#x27;&#x27;&#x27; <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="comment">&#x27;&#x27;&#x27; <span class="doctag">&lt;remarks&gt;</span><span class="doctag">&lt;/remarks&gt;</span></span></span><br><span class="line">    <span class="keyword">Public</span> <span class="keyword">Shared</span> <span class="keyword">Function</span> Clone(<span class="keyword">ByVal</span> taget <span class="keyword">As</span> <span class="type">Object</span>, <span class="keyword">ByVal</span> source <span class="keyword">As</span> <span class="type">Object</span>) <span class="keyword">As</span> <span class="type">Object</span></span><br><span class="line">        <span class="keyword">For</span> <span class="keyword">Each</span> p <span class="keyword">As</span> System.Reflection.PropertyInfo <span class="keyword">In</span> source.<span class="built_in">GetType</span>().GetProperties()</span><br><span class="line">            <span class="keyword">If</span> p.CanRead <span class="built_in">AndAlso</span> p.CanWrite <span class="keyword">Then</span></span><br><span class="line">                p.SetValue(taget, p.GetValue(source, p.GetIndexParameters()), p.GetIndexParameters())</span><br><span class="line">            <span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">        <span class="keyword">Next</span></span><br><span class="line">        <span class="keyword">Return</span> taget</span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Function</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">&#x27;新增一個類別實作ITemplate介面，就會跑出InstantiateIn的方法</span></span><br><span class="line"><span class="keyword">Public</span> <span class="keyword">Class</span> gvTemplate</span><br><span class="line">        <span class="keyword">Implements</span> ITemplate</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Property</span> templateType <span class="keyword">As</span> DataControlRowType</span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Property</span> columnName <span class="keyword">As</span> <span class="type">String</span></span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Property</span> Control <span class="keyword">As</span> <span class="type">Object</span></span><br><span class="line">        <span class="keyword">Public</span> <span class="keyword">Sub</span> <span class="built_in">New</span>(type <span class="keyword">As</span> DataControlRowType, colname <span class="keyword">As</span> <span class="type">String</span>, ctrl <span class="keyword">As</span> <span class="type">Object</span>)</span><br><span class="line">            templateType = type</span><br><span class="line">            columnName = colname</span><br><span class="line">            Control = ctrl</span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">Public</span> <span class="keyword">Sub</span> InstantiateIn(container <span class="keyword">As</span> Control) <span class="keyword">Implements</span> ITemplate.InstantiateIn</span><br><span class="line">            <span class="keyword">Select</span> <span class="keyword">Case</span> templateType</span><br><span class="line">                <span class="keyword">Case</span> DataControlRowType.Header</span><br><span class="line">                    <span class="keyword">If</span> Control <span class="built_in">Is</span> <span class="literal">Nothing</span> <span class="keyword">Then</span></span><br><span class="line">                        <span class="comment">&#x27;如果沒有沒有控制項，則塞入粗體字</span></span><br><span class="line">                        <span class="keyword">Dim</span> lt <span class="keyword">As</span> Literal = <span class="built_in">New</span> Literal()</span><br><span class="line">                        lt.<span class="keyword">Text</span> = <span class="string">&quot;&lt;B&gt;&quot;</span> + columnName + <span class="string">&quot;&lt;/B&gt;&quot;</span></span><br><span class="line">                        container.Controls.Add(lt)</span><br><span class="line">                    <span class="keyword">ElseIf</span> <span class="built_in">TypeOf</span> Control <span class="built_in">Is</span> CheckBox <span class="keyword">Then</span></span><br><span class="line">                        <span class="comment">&#x27;否則塞入控制項</span></span><br><span class="line">                        container.Controls.Add(Control)</span><br><span class="line">                    <span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">                <span class="keyword">Case</span> DataControlRowType.DataRow</span><br><span class="line">                    <span class="keyword">Dim</span> obj <span class="keyword">As</span> <span class="type">Object</span></span><br><span class="line">                    <span class="keyword">If</span> <span class="built_in">Not</span> Control <span class="built_in">Is</span> <span class="literal">Nothing</span> <span class="keyword">Then</span></span><br><span class="line">                        <span class="keyword">Select</span> <span class="keyword">Case</span> Control.<span class="built_in">GetType</span>().Name</span><br><span class="line">                            <span class="keyword">Case</span> <span class="string">&quot;CheckBox&quot;</span></span><br><span class="line">                                obj = <span class="built_in">New</span> CheckBox()</span><br><span class="line">                                 </span><br><span class="line">                                <span class="comment">&#x27;如果有傳入WebControl的話，複製一個新的並把它加到DataRow中</span></span><br><span class="line">                                <span class="comment">&#x27;如果沒這麼做就直接將傳入的Control加入Container當中</span></span><br><span class="line">                                <span class="comment">&#x27;會變成只有最後一行有那個Control(Control為Reference型別)</span></span><br><span class="line">                                SysHelper.Clone(obj, Control)</span><br><span class="line">                        <span class="keyword">End</span> <span class="keyword">Select</span></span><br><span class="line">                        obj = SysHelper.Clone(obj, Control)</span><br><span class="line">                    <span class="keyword">Else</span></span><br><span class="line">                        obj = <span class="built_in">New</span> Label()</span><br><span class="line">                        <span class="keyword">AddHandler</span> CType(obj, Label).DataBinding, <span class="built_in">AddressOf</span> data_DataBinding</span><br><span class="line">                    <span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">                    container.Controls.Add(obj)</span><br><span class="line">            <span class="keyword">End</span> <span class="keyword">Select</span></span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">Private</span> <span class="keyword">Sub</span> data_DataBinding(sender <span class="keyword">As</span> <span class="type">Object</span>, e <span class="keyword">As</span> EventArgs)</span><br><span class="line">            <span class="keyword">Dim</span> lbl <span class="keyword">As</span> Label = CType(sender, Label)</span><br><span class="line">            <span class="keyword">Dim</span> row <span class="keyword">As</span> GridViewRow = CType(lbl.NamingContainer, GridViewRow)</span><br><span class="line">            lbl.<span class="keyword">Text</span> = DataBinder.Eval(row.DataItem, columnName).ToString()</span><br><span class="line">        <span class="keyword">End</span> <span class="keyword">Sub</span></span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Class</span></span><br></pre></td></tr></table></figure></li>
<li>使用方法如下<figure class="highlight vb"><table><tr><td class="code"><pre><span class="line"><span class="keyword">Private</span> <span class="keyword">Sub</span> setGridViewColumns(<span class="keyword">ByVal</span> mode <span class="keyword">As</span> GriviewMode)</span><br><span class="line">        gvSummons.Columns.Clear()</span><br><span class="line">        <span class="comment">&#x27;新增TemplateField的方法</span></span><br><span class="line">        <span class="keyword">Dim</span> TemplateField <span class="keyword">As</span> TemplateField = <span class="built_in">New</span> TemplateField()</span><br><span class="line">        TemplateField.ItemStyle.HorizontalAlign = HorizontalAlign.Center</span><br><span class="line">        <span class="keyword">Dim</span> cb <span class="keyword">As</span> CheckBox = <span class="built_in">New</span> CheckBox()</span><br><span class="line">        cb.ID = <span class="string">&quot;cbSelectAll&quot;</span></span><br><span class="line">        cb.<span class="keyword">Text</span> = <span class="string">&quot;註記&quot;</span></span><br><span class="line">        cb.CssClass = <span class="string">&quot;gvSummonsSelectAll&quot;</span></span><br><span class="line">        TemplateField.HeaderTemplate = <span class="built_in">New</span> SysHelper.gvTemplate(DataControlRowType.Header, <span class="string">&quot;&quot;</span>, cb)</span><br><span class="line"> </span><br><span class="line">        cb = <span class="built_in">New</span> CheckBox()</span><br><span class="line">        cb.ID = <span class="string">&quot;cbSelect&quot;</span></span><br><span class="line">        cb.CssClass = <span class="string">&quot;gvSummonsSelect&quot;</span></span><br><span class="line">        TemplateField.ItemTemplate = <span class="built_in">New</span> SysHelper.gvTemplate(DataControlRowType.DataRow, <span class="string">&quot;&quot;</span>, cb)        </span><br><span class="line">        gvSummons.Columns.Add(TemplateField)</span><br><span class="line"> </span><br><span class="line">               </span><br><span class="line">        <span class="comment">&#x27;新增BoundField的方法</span></span><br><span class="line">        <span class="keyword">Dim</span> BoundField <span class="keyword">As</span> BoundField = <span class="built_in">New</span> BoundField()</span><br><span class="line">        BoundField.DataField = <span class="string">&quot;voucherno&quot;</span></span><br><span class="line">        BoundField.HeaderText = <span class="string">&quot;傳票號碼&quot;</span></span><br><span class="line">        BoundField.ItemStyle.HorizontalAlign = HorizontalAlign.Center</span><br><span class="line">        gvSummons.Columns.Add(BoundField)</span><br><span class="line">    <span class="keyword">End</span> <span class="keyword">Sub</span></span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>ASP</tag>
        <tag>GridView</tag>
      </tags>
  </entry>
  <entry>
    <title>hnsCall failed in Win32 The object already exists</title>
    <url>/2020/02/26/windows_docker_hnscall_error/</url>
    <content><![CDATA[<p>windows server 2019 重開機後，自建 container nat networks 會消失。<br><a href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/container-networking/network-drivers-topologies">來源 : Windows container network drivers</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">NAT networks created on Windows Server 2019 (or above) are no longer persisted after reboot.</span><br></pre></td></tr></table></figure>

<p>所以我有寫一些重啟機器時檢查 network ，如果不存在就再建立一組並且啟動 docker，但時不時會碰到 <code>Error response from daemon: hnsCall failed in Win32: The object already exists. (0x1392)</code> 的錯誤。</p>
<p>但透過以下指令卻又都找不到已經存在的 network mapping</p>
<figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$</span> docker network <span class="built_in">ls</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">Get-NetNatStaticMapping</span></span><br></pre></td></tr></table></figure>

<p>直接下指令砍掉要建立的 network 名稱，會回傳這物件不存在，但你要建立又會說這物件已經存在的鬼擋牆狀況… 這應該是 windows container bug ，之前只要碰到這個問題都直接重長機器，而剛剛終於找到解法了 (灑花)</p>
<h2 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h2><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 先停掉 docker service</span></span><br><span class="line"><span class="variable">$Stop</span><span class="literal">-Service</span> docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停掉 hns </span></span><br><span class="line"><span class="variable">$Stop</span><span class="literal">-Service</span> hns</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重啟 docker service, 這會連帶的 hns 也會被啟動</span></span><br><span class="line"><span class="variable">$Start</span><span class="literal">-Service</span> docker</span><br></pre></td></tr></table></figure>

<p>這時候再重新跑 docker network create 就會過了，這問題卡了我很長一段時間，終於找到解法了</p>
<div class="note info">
            <p><a href="https://github.com/docker/for-win/issues/1384">Docker Network Create Fails: HNS failed with error : The object already exists. #1384</a></p>
          </div>

]]></content>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>【Autofac】生命週期</title>
    <url>/2018/07/12/%E3%80%90Autofac%E3%80%91%E7%94%9F%E5%91%BD%E9%80%B1%E6%9C%9F/</url>
    <content><![CDATA[<p>2019/08/21 補充 ： 將之前在公司分享的  Demo Code 整理並放到 <a href="https://github.com/toyo0103/AutofacLifetimeScopeDemo">Github</a>，有興趣的可以下載來試試看。 </p>
<h1 id="什麼是Autofac"><a href="#什麼是Autofac" class="headerlink" title="#什麼是Autofac"></a>#什麼是Autofac</h1><p>用來實作<strong>控制反轉</strong>(Inversion of Control, IoC)的套件,幫我們管理抽象與實體之間的對應關係, 除了Autofac之外還有Unity等其它套件可以實作,但概念都大同小異。</p>
<div class="note info">
            <p><a href="https://autofac.org/">Autofac官網</a></p>
          </div>

<h1 id="Autofac的生命週期有哪些"><a href="#Autofac的生命週期有哪些" class="headerlink" title="#Autofac的生命週期有哪些"></a>#Autofac的生命週期有哪些</h1><ul>
<li>InstancePerDependency</li>
<li>SingleInstance</li>
<li>InstancePerLifetimeScope</li>
<li>InstancePerRequest</li>
</ul>
<p>下面會一一解說跟實作測試,在這之前先準備一個WebAPI的專案,並且將Autofac與Autofac WebAPI2裝起來</p>
<p><img src="/images/20180712/1.jpg" alt="/images/20180712/1.jpg"></p>
<p>然後在App_Start資料夾新增AutofacConfig類別</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">AutofacConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IContainer Container &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BuildContainer</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> builder = <span class="keyword">new</span> ContainerBuilder();</span><br><span class="line"></span><br><span class="line">        Register(builder);</span><br><span class="line"></span><br><span class="line">        Container = builder.Build();</span><br><span class="line">        GlobalConfiguration.Configuration.DependencyResolver = <span class="keyword">new</span> AutofacWebApiDependencyResolver(Container);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Register</span>(<span class="params">ContainerBuilder builder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> assembly = <span class="keyword">typeof</span>(AutofacConfig).Assembly;</span><br><span class="line">        builder.RegisterApiControllers(assembly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>Global.asax</strong>加上這行</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Application_Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//Autofac Init</span></span><br><span class="line">    AutofacConfig.BuildContainer();</span><br><span class="line"></span><br><span class="line">    AreaRegistration.RegisterAllAreas();</span><br><span class="line">    GlobalConfiguration.Configure(WebApiConfig.Register);</span><br><span class="line">    FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters);</span><br><span class="line">    RouteConfig.RegisterRoutes(RouteTable.Routes);</span><br><span class="line">    BundleConfig.RegisterBundles(BundleTable.Bundles);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="InstancePerDependency"><a href="#InstancePerDependency" class="headerlink" title="InstancePerDependency"></a>InstancePerDependency</h2><div class="note info">
            <p>Also called ‘transient’ or ‘factory’ in other containers. Using per-dependency scope, <strong>a unique instance will be returned from each request for a service.</strong> </p>
          </div>

<p>每次呼叫都回傳一個新的實體,產生的Instance隨著呼叫者的生命週期消滅</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">LiftTimeModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> Count;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">private</span> <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">LiftTimeModel</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        Count++;</span><br><span class="line">        <span class="keyword">this</span>.ID = LiftTimeModel.Count;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>AutofacConfig</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">AutofacConfig</span></span><br><span class="line">&#123;</span><br><span class="line">	....省略....</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Register</span>(<span class="params">ContainerBuilder builder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> assembly = <span class="keyword">typeof</span>(AutofacConfig).Assembly;</span><br><span class="line">        builder.RegisterApiControllers(assembly);</span><br><span class="line"></span><br><span class="line">        builder.RegisterType&lt;LiftTimeModel&gt;().InstancePerDependency();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>TestController</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">ApiController</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> LifeTimeModel _lifeTimeModel;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">TestController</span>(<span class="params">LifeTimeModel lifeTimeModel</span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		<span class="keyword">this</span>._lifeTimeModel = lifeTimeModel;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GET api/&lt;controller&gt;</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">		sb.AppendLine(<span class="built_in">string</span>.Concat(<span class="string">&quot;PerDependencyModel ID :&quot;</span>, <span class="keyword">this</span>._lifeTimeModel.ID));</span><br><span class="line"></span><br><span class="line">    	<span class="keyword">return</span> sb.ToString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>呼叫/api/test會發現隨著呼叫的次數增加，LifeTimeModel ID 也會一直增加，因為每次Request呼叫開始都會產生新的TestController Instance，隨著Request結束TestController也會被消滅，依賴在它身上的LifeTimeModel也隨之產生與消滅。而每次產生新的LifeTimeModel Instance都會在建構子將static的Count加1，這是數字一直增加的緣故。</p>
<p>此外Autofac預設使用的生命週期即為InstancePerDependency，所以這兩行的意思是一樣的</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">builder.RegisterType&lt;LiftTimeModel&gt;().InstancePerDependency();</span><br><span class="line">builder.RegisterType&lt;LiftTimeModel&gt;();</span><br></pre></td></tr></table></figure>



<p><img src="/images/20180712/2.jpg" alt="InstancePerDependency圖解"></p>
<h2 id="SingleInstance"><a href="#SingleInstance" class="headerlink" title="SingleInstance"></a>SingleInstance</h2><div class="note info">
            <p>This is also known as ‘singleton.’ Using single instance scope, <strong>one instance is returned from all requests in the root and all nested scopes</strong>. </p>
          </div>

<p>不管呼叫幾次都只有產生一個Instance，以WebAPI為例只有當Application Shut down的時候會消滅</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">AutofacConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    ...省略....</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Register</span>(<span class="params">ContainerBuilder builder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> assembly = <span class="keyword">typeof</span>(AutofacConfig).Assembly;</span><br><span class="line">        builder.RegisterApiControllers(assembly);</span><br><span class="line">        <span class="comment">//改成SingleInstance</span></span><br><span class="line">        builder.RegisterType&lt;LifeTimeModel&gt;().SingleInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>會發現不管呼叫/api/test幾次ID永遠都是1,原因是LifeTimeModel只會產生一次</p>
<p><img src="/images/20180712/3.jpg" alt="SingleInstance圖解"></p>
<h2 id="InstancePerLifetimeScope"><a href="#InstancePerLifetimeScope" class="headerlink" title="InstancePerLifetimeScope"></a>InstancePerLifetimeScope</h2><div class="note info">
            <p>This scope applies to nested lifetimes. <strong>A component with per-lifetime scope will have at most a single instance per nested lifetime scope.</strong> </p>
          </div>

<p>這個非常容易跟InstancePerRequest搞混,簡單理解方式就是,每個Scope只會最多產生一個Instance。</p>
<p>所以在Root只會產生一個，在Autofac WebRequest只會產生一組</p>
<p><strong>新增TestPerLifetimeScopeModel做為觀察標的</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestPerLifetimeScopeModel</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> LifeTimeModel LifeTimeModel &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestPerLifetimeScopeModel</span>(<span class="params">LifeTimeModel lifeTimeModel</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>.LifeTimeModel = lifeTimeModel;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">AutofacConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    ...省略....</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Register</span>(<span class="params">ContainerBuilder builder</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> assembly = <span class="keyword">typeof</span>(AutofacConfig).Assembly;</span><br><span class="line">        builder.RegisterApiControllers(assembly);</span><br><span class="line">        </span><br><span class="line">        builder.RegisterType&lt;TestPerLifetimeScopeModel&gt;();</span><br><span class="line">         <span class="comment">//改成InstancePerLifetimeScope</span></span><br><span class="line">        builder.RegisterType&lt;LifeTimeModel&gt;().InstancePerLifetimeScope();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestController</span> : <span class="title">ApiController</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">private</span> LifeTimeModel _lifeTimeModel;</span><br><span class="line">    <span class="keyword">private</span> TestPerLifetimeScopeModel _testPerLifetimeScopeModel;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TestController</span>(<span class="params">LifeTimeModel lifeTimeModel, TestPerLifetimeScopeModel testPerLifetimeScopeModel</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    	<span class="keyword">this</span>._lifeTimeModel = lifeTimeModel;</span><br><span class="line">    	<span class="keyword">this</span>._testPerLifetimeScopeModel = testPerLifetimeScopeModel;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// GET api/&lt;controller&gt;</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    	StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    	sb.AppendLine(<span class="built_in">string</span>.Concat(<span class="string">&quot;PerDependencyModel ID :&quot;</span>, <span class="keyword">this</span>._lifeTimeModel.ID));</span><br><span class="line">        sb.AppendLine(<span class="built_in">string</span>.Concat(<span class="string">&quot;TestPerLifetimeScopeModel&#x27;s LifeTimeModel ID :&quot;</span>, <span class="keyword">this</span>._testPerLifetimeScopeModel.LifeTimeModel.ID));</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> sb.ToString();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>會發現兩個得到的ID都是相同的，原因是Autofac WebRequest Scope中，一次Request只會產生一組LifeTimeModel，所以ID都會一樣</p>
<p><img src="/images/20180712/4.jpg" alt="/images/20180712/4.jpg"></p>
<p><del>更進一步說，如果我們今天有使用WebAPI DelegatingHandler，因為Handler只會在Application起來時產生一次Instance，所以在這產生的LifeTimeModel也會變成Singleton</del>   *<strong>註1</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestHandler</span>: <span class="title">DelegatingHandler</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> Task&lt;HttpResponseMessage&gt; <span class="title">SendAsync</span>(<span class="params">HttpRequestMessage request, CancellationToken cancellationToken</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    	<span class="keyword">var</span> Model = AutofacConfig.Container.Resolve&lt;LifeTimeModel&gt;();</span><br><span class="line">    	<span class="keyword">var</span> TestID = Model.ID;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">base</span>.SendAsync(request, cancellationToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">WebApiConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Register</span>(<span class="params">HttpConfiguration config</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// Web API 設定和服務</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Web API 路由</span></span><br><span class="line">        config.MapHttpAttributeRoutes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 註冊Handler</span></span><br><span class="line">        config.MessageHandlers.Add(<span class="keyword">new</span> TestHandler());</span><br><span class="line"></span><br><span class="line">        config.Routes.MapHttpRoute(</span><br><span class="line">            name: <span class="string">&quot;DefaultApi&quot;</span>,</span><br><span class="line">            routeTemplate: <span class="string">&quot;api/&#123;controller&#125;/&#123;id&#125;&quot;</span>,</span><br><span class="line">            defaults: <span class="keyword">new</span> &#123; id = RouteParameter.Optional &#125;</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>會發現Handler裡面的ID永遠拿到的都是1，而API回傳的結果則會慢慢增加，兩邊是各自獨立的實體</p>
<p><img src="/images/20180712/6.jpg" alt="/images/20180712/6.jpg"></p>
<p><img src="/images/20180712/7.jpg" alt="/images/20180712/7.jpg"></p>
<p><img src="/images/20180712/5.jpg" alt="InstancePerLifetimeScope圖解"></p>
<div class="note danger">
            <p><strong>註1</strong></p><p>這邊觀念有錯誤，會Singleton的原因不在於DelegatingHandler的問題，而是因為使用AutofacConfig.Container來產生實體，Container是Root層級也是Singleton，請它產生LifeTimeModel (InstancePerLifetimeScope)，所以會變成Singleton。</p><p>交叉測試的方法是把這段 AutofacConfig.Container.Resolve<LifeTimeModel>()放到Controller的Action之中，產出來的實體也會是Singleton，所以癥結在AutofacConfig.Container而非DelegatingHandler或Controller Action的生命週期，特此更正</p>
          </div>



<h2 id="InstancePerRequest"><a href="#InstancePerRequest" class="headerlink" title="InstancePerRequest"></a>InstancePerRequest</h2><div class="note info">
            <p>Some application types naturally lend themselves to “request” type semantics, for example ASP.NET <a href="http://autofac.readthedocs.io/en/latest/integration/webforms.html">web forms</a> and <a href="http://autofac.readthedocs.io/en/latest/integration/mvc.html">MVC</a> applications. In these application types, it’s helpful to have the ability to have a sort of “singleton per request.” </p>
          </div>

<p>基本上跟InstancePerLifetimeScope認知是一致的，唯一差別是它無法Root Scope產生Instance，因為生命週期隨著Request產生與消滅，不會有Singleton的可能，所以如果改成InstancePerRequest，剛剛的TestHandler就會產生Exception。</p>
<p><img src="/images/20180712/8.jpg" alt="/images/20180712/8.jpg"></p>
<p><img src="/images/20180712/9.jpg" alt="/images/20180712/9.jpg"></p>
<p>Unity跟Autofac的生命週期一直都不是很好懂所以之前也踩了不少雷，筆記起來希望對大家能有幫助</p>
<div class="note info">
            <p><strong>補充</strong></p><p>產生在AutofacWebRequest Scope的實體，一定會在每次Request結束後被消滅</p>
          </div>



<div class="note info">
            <p><strong>參考文件</strong></p><p><a href="https://web.archive.org/web/20170111185216/http://decompile.it/blog/2014/03/13/webapi-autofac-lifetime-scopes/">WebAPI, Autofac, and Lifetime Scopes</a></p>
          </div>]]></content>
      <tags>
        <tag>AutoFac</tag>
      </tags>
  </entry>
  <entry>
    <title>【Azure】如何跨DB讀取資料</title>
    <url>/2017/11/09/%E3%80%90Azure%E3%80%91%E5%A6%82%E4%BD%95%E8%B7%A8DB%E8%AE%80%E5%8F%96%E8%B3%87%E6%96%99/</url>
    <content><![CDATA[<p>忙了一大段時間，突然發現好長時間沒更新部落格了，這段時間專案實在太忙了，慢慢的再把這些時間學到的東西慢慢筆記下來，今天就先從Azure開始吧!!</p>
<p>以前如果有跨DB存取或Join Table，通常都會請DBA開Link DB的方式來處理，但在Azure SQL上面就沒有這個選項了</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-LvGu3FglCEI/WgOxsaEfz7I/AAAAAAAAIP8/3xQmoM8lFCs4oIawixv-HHidz_NHEjRpQCEwYBhgL/s1600/1.png)](https://2.bp.blogspot.com/-LvGu3FglCEI/WgOxsaEfz7I/AAAAAAAAIP8/3xQmoM8lFCs4oIawixv-HHidz_NHEjRpQCEwYBhgL/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">跨DB讀取資料</td></tr></tbody></table>
但它推出了一個語法來達成這樣子的需求 External Data Source，假設我在**A資料庫**，想要Join **B資料庫**的**PromoEmail Table**取得行銷案的Email資料來做交叉分析，這時候我們可以這樣寫
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> MASTER KEY ENCRYPTION <span class="keyword">BY</span> PASSWORD <span class="operator">=</span> <span class="string">&#x27;This Account Password&#x27;</span>; </span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> DATABASE SCOPED CREDENTIAL AzureStorageCredential </span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">IDENTITY</span> <span class="operator">=</span> <span class="string">&#x27;This DataBase Login Account&#x27;</span>, </span><br><span class="line">SECRET <span class="operator">=</span> <span class="string">&#x27;This Account Password&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> DATA SOURCE RefPromoTableDataBase</span><br><span class="line"><span class="keyword">WITH</span>  </span><br><span class="line">(  </span><br><span class="line">    TYPE<span class="operator">=</span>RDBMS,  </span><br><span class="line">    LOCATION <span class="operator">=</span><span class="string">&#x27;Your Azure SQL Database Location&#x27;</span>,  </span><br><span class="line">    DATABASE_NAME <span class="operator">=</span> <span class="string">&#x27;B&#x27;</span>,  <span class="comment">--外連B資料庫</span></span><br><span class="line">    CREDENTIAL <span class="operator">=</span> AzureStorageCredential</span><br><span class="line">);  </span><br><span class="line"></span><br><span class="line"><span class="comment">--建立一個External Table</span></span><br><span class="line"><span class="comment">--這邊Schema就取決於你要從B Database的PromoEmail Table取得什麼欄位</span></span><br><span class="line"><span class="comment">--欄位名稱跟資料型態要相同</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> [dbo].[PromoEmail](  </span><br><span class="line">    [Email] [<span class="type">varchar</span>] (<span class="number">300</span>) <span class="keyword">Not</span> <span class="keyword">NULL</span>  </span><br><span class="line">)  </span><br><span class="line"><span class="keyword">WITH</span>  </span><br><span class="line">(  </span><br><span class="line">    DATA_SOURCE <span class="operator">=</span> RefPromoTableDataBase</span><br><span class="line">);    </span><br><span class="line"></span><br><span class="line"><span class="comment">--在A資料庫Join PromoEmail Table</span></span><br><span class="line"><span class="comment">--看看行銷案轉換成訂單的績效</span></span><br><span class="line"><span class="keyword">SELECT</span> email</span><br><span class="line"><span class="keyword">FROM</span> [<span class="keyword">Order</span>] o</span><br><span class="line"><span class="keyword">Join</span> PromoEmail pe <span class="keyword">on</span> o.UserEmail <span class="operator">=</span> pe.Email</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>當然最後做完後，要記得把這些資源都釋放掉</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">EXTERNAL</span> <span class="keyword">TABLE</span> PromoEmail</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">EXTERNAL</span> DATA SOURCE RefPromoTableDataBase</span><br><span class="line"><span class="keyword">DROP</span> DATABASE SCOPED CREDENTIAL AzureStorageCredential  </span><br><span class="line"><span class="keyword">DROP</span> MASTER KEY  </span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>參考資料<br><a href="http://www.c-sharpcorner.com/article/cross-database-queries-in-azure-sql/">Cross Database Queries In Azure SQL</a><br><a href="https://sqldusty.com/2017/05/30/setting-up-cross-database-queries-in-azure-sql-database/">SETTING UP CROSS DATABASE QUERIES IN AZURE SQL DATABASE</a></p>
]]></content>
      <tags>
        <tag>SQL</tag>
        <tag>Azure</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】GridView動態加入textbox</title>
    <url>/2013/01/31/%E3%80%90C-%E3%80%91GridView%E5%8B%95%E6%85%8B%E5%8A%A0%E5%85%A5textbox/</url>
    <content><![CDATA[<p>GridView原本產出的資料如下圖</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://2.bp.blogspot.com/-Spka-CC-RXA/UQne4vnVBtI/AAAAAAAAA1c/vq-CaRzXOyI/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png)](http://2.bp.blogspot.com/-Spka-CC-RXA/UQne4vnVBtI/AAAAAAAAA1c/vq-CaRzXOyI/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png)</div>
需求是將*號的部分變成TextBox且可輸入的字數要跟*號的個數相同，程式碼如下：

<p><span style="color: blue;">在GridView RowDataBound事件中</span><br><span style="color: blue;"><br></span></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">GridView_RowDataBound</span>(<span class="params"><span class="built_in">object</span> sender, GridViewRowEventArgs e</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">         <span class="keyword">if</span>(e.Row.RowType == DataControlRowType.DataRow)</span><br><span class="line">         &#123;</span><br><span class="line">              <span class="keyword">for</span>(<span class="built_in">int</span> i = <span class="number">0</span> ; i = &lt; e.Row.Cells.Count; i++)</span><br><span class="line">              &#123;</span><br><span class="line">                   <span class="keyword">if</span>(e.Row.Cells[i].Text.Contains(<span class="string">&quot;*&quot;</span>))</span><br><span class="line">                   &#123;</span><br><span class="line">                        <span class="built_in">int</span> count = e.Row.Cells[i].Text.Count(f =&gt; f== <span class="string">&#x27;*&#x27;</span>);</span><br><span class="line">                        <span class="built_in">int</span> firstIndex = e.Row.Cells[i].Text.IndexOf(<span class="string">&#x27;*&#x27;</span>);</span><br><span class="line"></span><br><span class="line">                        e.Row.Cells[i].Text = e.Row.Cells[i].Text.Replace(<span class="string">&quot;*&quot;</span>,<span class="string">&quot;&quot;</span>).Insert(firstIndex, <span class="string">&quot;&lt;input maxlength=&quot;</span>+ count +<span class="string">&quot; runat=&#x27;server&#x27; size=&#x27;5&#x27; type=&#x27;text&#x27; value=&#x27;&#x27; /&gt;&quot;</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">              &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol>
<li> 先算出*號的個數</li>
<li> 找到*號第一次出現的位置</li>
<li> 將*號全部Replace並在第一次出現的位置插入&lt;input type=’text’ /&gt;<div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;">
</div><div><span style="color: blue;">結果如下</span></div><div>[![](http://2.bp.blogspot.com/-e8AUIv9UIiU/UQnhfaf2eUI/AAAAAAAAA1w/cKFgnpj4UIE/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png)](http://2.bp.blogspot.com/-e8AUIv9UIiU/UQnhfaf2eUI/AAAAAAAAA1w/cKFgnpj4UIE/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png)</div></li>
</ol>
]]></content>
      <tags>
        <tag>C#</tag>
        <tag>ASP</tag>
        <tag>GridView</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】FormsAuthentication驗證模式</title>
    <url>/2013/09/01/%E3%80%90C-%E3%80%91FormsAuthentication%E9%A9%97%E8%AD%89%E6%A8%A1%E5%BC%8F/</url>
    <content><![CDATA[<p>研究了老半天終於搞懂了，來做一下簡單的筆記<br>從.NET 2.0開始就已經開始實行的Form驗證模式，今天拜讀了保哥的<a href="https://blog.miniasp.com/post/2008/02/20/Explain-Forms-Authentication-in-ASPNET-20.aspx">「概略解釋 Forms Authentication 的運作」</a>後測試的簡單心得</p>
<p>使用這個方法即表示驗證成功，這個驗證會記錄在電腦的cookie當中</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">FormsAuthentication.RedirectFromLoginPage(strUsername, <span class="literal">false</span>);</span><br></pre></td></tr></table></figure>
<p>但如果你想要關閉瀏覽器時就登出，你就得改用以下方式將cookie記錄在web browser當中</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//改發Ticket的方式</span></span><br><span class="line">FormsAuthenticationTicket ticket = <span class="keyword">new</span> FormsAuthenticationTicket(<span class="number">1</span>, username, DateTime.Now, DateTime.Now.AddMinutes(<span class="number">30</span>),<span class="literal">false</span>, userdata, FormsAuthentication.FormsCookiePath);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Encrypt the ticket.</span></span><br><span class="line"><span class="built_in">string</span> encTicket = FormsAuthentication.Encrypt(ticket);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Create the cookie.</span></span><br><span class="line">Response.Cookies.Add(<span class="keyword">new</span> HttpCookie(FormsAuthentication.FormsCookieName, encTicket));</span><br></pre></td></tr></table></figure>

<p>那如果又要實作，記住我xx天不用重新登入的功能呢?</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//除了剛剛發Ticket之外</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">bool</span>.Parse(remember))</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//如果打勾記住我的話</span></span><br><span class="line">  HttpCookie cookie = <span class="keyword">new</span> HttpCookie(<span class="string">&quot;rememberme&quot;</span>);</span><br><span class="line">  cookie.Value = SysHelper.enCrypt(account);</span><br><span class="line">  cookie.Expires = DateTime.Now.AddDays(<span class="number">3</span>);</span><br><span class="line">  Response.Cookies.Add(cookie);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這樣下次登入的時候只要判斷這個cookie存不存在就可以放行了!!</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//登入Login頁面時，先判斷Form驗證已經通過了嗎?</span></span><br><span class="line"><span class="keyword">if</span> (!User.Identity.IsAuthenticated)</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">//沒通過的話，判斷cookie存不存在。有的話表示此人上次登入時有勾記住我!!</span></span><br><span class="line">   <span class="keyword">if</span> ( Request.Cookies[<span class="string">&quot;backend&quot;</span>] != <span class="literal">null</span>)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="comment">//cookie如果過期的話會判斷為null，所以進得來表示cookie還沒過期，可以發Ticket給他</span></span><br><span class="line">      passTicket(SysHelper.deCrypt(Request.Cookies[<span class="string">&quot;rememberme&quot;</span>].Value), <span class="string">&quot;&quot;</span>);</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">return</span> Redirect(<span class="string">&quot;/backend&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">      <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>登出</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//呼叫這個方法就已經登出摟~</span></span><br><span class="line">FormsAuthentication.SignOut();</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> (Request.Cookies[<span class="string">&quot;backend&quot;</span>] != <span class="literal">null</span>)</span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">//如果cookie還沒過期，既然已經登出當然要把它重新設定為過期啦!!</span></span><br><span class="line">   HttpCookie myCookie = <span class="keyword">new</span> HttpCookie(<span class="string">&quot;backend&quot;</span>);</span><br><span class="line">   myCookie.Expires = DateTime.Now.AddDays(<span class="number">-1</span>d);</span><br><span class="line">   Response.Cookies.Add(myCookie);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> Redirect(<span class="string">&quot;/backend&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>最後不要搞混Response與Request了。我寫的時候沒注意到害我Debug超久的….(汗)</p>
]]></content>
      <tags>
        <tag>C#</tag>
        <tag>FormsAuthentication</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】GridView更改Pager的樣式</title>
    <url>/2013/01/08/%E3%80%90C-%E3%80%91GridView%E6%9B%B4%E6%94%B9Pager%E7%9A%84%E6%A8%A3%E5%BC%8F/</url>
    <content><![CDATA[<div class="separator" style="clear: both; text-align: left;">在GridView的Pager是用Table組成的，這裡是做個簡單的將 "..." 改成前五頁後五頁。</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: center;"></div><pre class="brush : csharp">
else if(e.Row.RowType == DataControlRowType.Pager)
        {
            //修改page ...的樣式
            TableRow pageTR = (TableRow)e.Row.Controls[0].Controls[0].Controls[0];
            for(int x = 0; x&lt; pageTR.Controls.Count; x++)
            {
                TableCell pageTD = (TableCell)pageTR.Controls[x];
                for(int y = 0 ; y&lt;pageTD.Controls.Count; y++)
                {
                    if(pageTD.Controls[y] is LinkButton)
                    {
                        LinkButton lb = (LinkButton)pageTD.Controls[y];
                        if(lb.Text == &quot;...&quot; &amp;&amp;  x == 1)
                        {
                            lb.Text = &quot;前5頁&quot;;
                        }
                        else if(lb.Text ==&quot;...&quot;)
                        {
                            lb.Text = &quot;後5頁&quot;;
                        }
                    }
                }
            }
        }
</pre>]]></content>
      <tags>
        <tag>C#</tag>
        <tag>ASP</tag>
        <tag>GridView</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】TreeView 的 CheckBox打勾後自動POST BACK</title>
    <url>/2012/12/27/%E3%80%90C-%E3%80%91TreeView-%E7%9A%84-CheckBox%E6%89%93%E5%8B%BE%E5%BE%8C%E8%87%AA%E5%8B%95POST-BACK/</url>
    <content><![CDATA[<p>ASP.NET中的TreeView有<span style="color: red; font-weight: bold;">ontreenodecheckchanged</span>的事件，但當你在TreeView上打勾時，卻不會觸發Post Back的效果</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://2.bp.blogspot.com/-hIBTtd4zrrQ/UNu4XQV-SvI/AAAAAAAAAd4/wxCJqnyVB8Q/s1600/111.png)](http://2.bp.blogspot.com/-hIBTtd4zrrQ/UNu4XQV-SvI/AAAAAAAAAd4/wxCJqnyVB8Q/s1600/111.png)</div>
<div class="separator" style="clear: both; text-align: center;"></div>
查了一下，原來.Net會記住你目前TreeView的狀態，當有任何東西造成Post Back的時候(例如按按鈕)，就會觸發<span style="color: red; font-weight: bold;">ontreenodecheckchanged</span>的事件

<p>所以如果想要CheckBox點擊時能即時的Post Back就要做一些小加工</p>
<ol>
<li> 先加一個按鈕，並請隱藏起來<br><a href="http://2.bp.blogspot.com/-3_qRRYC2YCw/UNuxhaRYEEI/AAAAAAAAAc0/wpMixmHLhJY/s1600/111.png"><img src="http://2.bp.blogspot.com/-3_qRRYC2YCw/UNuxhaRYEEI/AAAAAAAAAc0/wpMixmHLhJY/s1600/111.png"></a><br><span style="font-size: x-small;">這裡需要特別注意不能直接用<span style="background-color: white; color: red;">Visible</span>=”<span style="color: blue;">false</span>“將按鈕隱藏，否則ASP不會將這個按鈕真的Render出來。所以請用CSS的方式隱藏吧!!</span></li>
<li> 透過JavaScript的方式(這邊利用JQuery撰寫)，偵測當CheckBox被點擊時去觸發我們隱藏起來的Button，透過這個Button達到Post Back的效果<a href="http://2.bp.blogspot.com/-PFXYV2-ACZE/UNuy2PgIT2I/AAAAAAAAAdQ/egXUmtK-uDA/s1600/111.png"><img src="http://2.bp.blogspot.com/-PFXYV2-ACZE/UNuy2PgIT2I/AAAAAAAAAdQ/egXUmtK-uDA/s1600/111.png"></a></li>
</ol>
<p>這樣就會進到<span style="color: red; font-weight: bold;">ontreenodecheckchanged</span>的事件</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://2.bp.blogspot.com/-qkdq-K0tGW0/UNu0IfXO4qI/AAAAAAAAAdk/Gt2D8z_Ijyw/s1600/111.png)](http://2.bp.blogspot.com/-qkdq-K0tGW0/UNu0IfXO4qI/AAAAAAAAAdk/Gt2D8z_Ijyw/s1600/111.png)</div><div>
</div>]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】Server端透過POST資料到API</title>
    <url>/2013/10/09/%E3%80%90C-%E3%80%91Server%E7%AB%AF%E9%80%8F%E9%81%8EPOST%E8%B3%87%E6%96%99%E5%88%B0API/</url>
    <content><![CDATA[<p>之前POST資料都是在Client端無論是用JQuery的AJAX或是Form的方式，今天學會如何從Server端POST資料到指定的頁面，記錄一下程式碼</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Post資料到Web</span></span><br><span class="line">HttpWebRequest request = (HttpWebRequest)WebRequest.Create(WebURL);</span><br><span class="line">request.Method = <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">request.ContentType = <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//將要傳遞的資料PostData轉成Byte陣列並寫入request</span></span><br><span class="line"><span class="built_in">byte</span>[] byWordWriteroPost = encoding.GetBytes(PostData);</span><br><span class="line">request.ContentLength = byWordWriteroPost.Length;</span><br><span class="line">Stream stream = request.GetRequestStream();</span><br><span class="line">stream.Write(byWordWriteroPost, <span class="number">0</span>, byWordWriteroPost.Length);</span><br><span class="line">stream.Close();</span><br><span class="line"></span><br><span class="line"><span class="comment">//取得網頁結果</span></span><br><span class="line">HttpWebResponse response = (HttpWebResponse)request.GetResponse();</span><br><span class="line">StreamReader reader = <span class="keyword">new</span> StreamReader(response.GetResponseStream(), encoding);</span><br><span class="line"><span class="built_in">string</span> returnString = reader.ReadToEnd();</span><br><span class="line">response.Close();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】Yield Return與迭代器</title>
    <url>/2018/12/21/%E3%80%90C-%E3%80%91yield_retuen/</url>
    <content><![CDATA[<h1 id="什麼是-Yield"><a href="#什麼是-Yield" class="headerlink" title="什麼是 Yield"></a>什麼是 Yield</h1><p>Yield 就是 .Net 中用來實作 iterator(迭代器) 設計模式的語法糖，雖然很早就知道這東西，但一直都不太知道怎麼用，剛好最近同事在翻寫寄送大量信件的程式有用到就跟他請教了一下。</p>
<p><strong>以前的做法</strong></p>
<p>將收件人從 DB 撈出來後 ，依據每封信的 Template 去置換內容，再批次送去給寄信服務執行</p>
<p><strong>問題</strong></p>
<p>如果這批收件人很多，把整批的信件都置換完 Template 再送出，會導致系統吃掉大量的記憶。當然最簡單的解決方法就是用迴圈組完一筆就送出一次，但其實用 Yield Return 可以更優雅的解決這個問題</p>
<h1 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h1><p>同事提供了簡單的範例來理解這件事情</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> mail <span class="keyword">in</span> <span class="title">GetData</span>(<span class="params"></span>))</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		Console.WriteLine(<span class="string">$&quot;- Received: <span class="subst">&#123;mail.Title&#125;</span>&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> List&lt;Mail&gt; <span class="title">GetData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> mailList = <span class="keyword">new</span> List&lt;Mail&gt;();</span><br><span class="line">	<span class="built_in">int</span> buffer_size = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">4</span>;  <span class="comment">// 4MB</span></span><br><span class="line">	Random _rnd = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>; index &lt; <span class="number">1024</span>; index++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">var</span> _buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[buffer_size];</span><br><span class="line">		_rnd.NextBytes(_buffer);</span><br><span class="line"></span><br><span class="line">		mailList.Add(<span class="keyword">new</span> Mail()</span><br><span class="line">		&#123;</span><br><span class="line">			Title = <span class="string">$&quot;buffer[<span class="subst">&#123;index&#125;</span>], <span class="subst">&#123;buffer_size / <span class="number">1024</span> / <span class="number">1024</span>&#125;</span> MB&quot;</span>,</span><br><span class="line">			Buffer = _buffer,</span><br><span class="line">		&#125;);</span><br><span class="line">		Task.Delay(<span class="number">50</span>).Wait();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> mailList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mail</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">byte</span>[] Buffer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code> GetData()</code> 這是模擬處理信件的地方，每封信件假設 4MB (到底是寄啥…)，整批處理完後回傳 mailList </p>
<p>如果把這段 Code 放到 LINQPad 執行，會發現記憶體一直往上飆，因為會全部都做完放到 List 再回傳並寄信</p>
<p><img src="/images/20181221/1.gif" alt="/images/20181221/1.gif"></p>
<h2 id="Yield-Return-版本"><a href="#Yield-Return-版本" class="headerlink" title="Yield Return 版本"></a>Yield Return 版本</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> mail <span class="keyword">in</span> <span class="title">GetData</span>(<span class="params"></span>))</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		Console.WriteLine(<span class="string">$&quot;- Received: <span class="subst">&#123;mail.Title&#125;</span>&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> IEnumerable&lt;Mail&gt; <span class="title">GetData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">int</span> buffer_size = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">4</span>;  <span class="comment">// 4MB</span></span><br><span class="line">	Random _rnd = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>; index &lt; <span class="number">1024</span>; index++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">var</span> _buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[buffer_size];</span><br><span class="line">		_rnd.NextBytes(_buffer);</span><br><span class="line"></span><br><span class="line">	    <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">Mail</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			Title = <span class="string">$&quot;buffer[<span class="subst">&#123;index&#125;</span>], <span class="subst">&#123;buffer_size / <span class="number">1024</span> / <span class="number">1024</span>&#125;</span> MB&quot;</span>,</span><br><span class="line">			Buffer = _buffer,</span><br><span class="line">		&#125;;</span><br><span class="line">		Task.Delay(<span class="number">50</span>).Wait();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mail</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">byte</span>[] Buffer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>觀察記憶體會發現非常的平穩，因為逐筆處理完就被消滅掉了</p>
<p><img src="/images/20181221/2.gif" alt="/images/20181221/2.gif"></p>
<h1 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h1><p>至於如果不用語法糖 Yield 該如何實作迭代器，可參考安德魯的部落格裡面介紹非常詳細，希望這個方法以後可以更融會貫通的套在專案中使用</p>
<div class="note info">
            <p>參考文章</p><p><a href="https://columns.chicken-house.net/2008/09/18/c-yield-return-1-how-it-work/">安德魯的部落格 - [C#: yield return] #1. How It Work ?</a></p><p><a href="https://zh.wikipedia.org/wiki/%E8%BF%AD%E4%BB%A3%E5%99%A8">Wiki - 迭代器</a></p>
          </div>]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】取得dynamic的屬性</title>
    <url>/2013/11/20/%E3%80%90C-%E3%80%91%E5%8F%96%E5%BE%97dynamic%E7%9A%84%E5%B1%AC%E6%80%A7/</url>
    <content><![CDATA[<p>解析Json格式時取得dynamic型別的物件，但如果裡面的物件不是用陣列的方式回傳，而是像這樣<br><a href="http://2.bp.blogspot.com/-uxMwNj7wo9k/Uoxi5SKPf2I/AAAAAAAAEMQ/Urhtvp1rDag/s1600/1.png"><img src="http://2.bp.blogspot.com/-uxMwNj7wo9k/Uoxi5SKPf2I/AAAAAAAAEMQ/Urhtvp1rDag/s1600/1.png"></a><br>我們不會知道.links底下究竟會link0、link1、link2….到幾，所以需要一個方法去try這個屬性是否存在</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">object</span> <span class="title">GetDynamicMember</span>(<span class="params"><span class="built_in">object</span> obj, <span class="built_in">string</span> memberName</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">try</span></span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">var</span> binder = Binder.GetMember(CSharpBinderFlags.None, memberName, obj.GetType(),</span><br><span class="line">                  <span class="keyword">new</span>[] &#123; CSharpArgumentInfo.Create(CSharpArgumentInfoFlags.None, <span class="literal">null</span>) &#125;);</span><br><span class="line">     <span class="keyword">var</span> callsite = CallSite&lt;Func&lt;CallSite, <span class="built_in">object</span>, <span class="built_in">object</span>&gt;&gt;.Create(binder);</span><br><span class="line">     <span class="keyword">return</span> callsite.Target(callsite, obj);</span><br><span class="line"> &#125;</span><br><span class="line"> catch (Exception ex)</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"> &#125;           </span><br><span class="line">&#125;   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>透過這個方法，我們就可以試著將屬性丟進去看看有無回傳值了 ```csharp<br>int i = 0;<br>while (true)<br>{<br>   dynamic trylink = GetDynamicMember(jsondata.links, “link” + i);<br>   if (trylink != null)<br>   {<br>      _urlclickcount += Convert.ToInt32(trylink.clicks);<br>      i++;<br>   }<br>   else<br>      break;<br>}</p>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】如何在Server Side執行phantomjs對網頁進行快照</title>
    <url>/2013/12/07/%E3%80%90C-%E3%80%91%E5%A6%82%E4%BD%95%E5%9C%A8Server-Side%E5%9F%B7%E8%A1%8Cphantomjs%E5%B0%8D%E7%B6%B2%E9%A0%81%E9%80%B2%E8%A1%8C%E5%BF%AB%E7%85%A7/</url>
    <content><![CDATA[<p>phantomjs如何使用，詳細請參考<a href="http://blog.darkthread.net/post-2013-08-29-phantomjs.aspx">參考黑暗執行緒前輩的文章</a></p>
<p>首先寫了一支snapshot.js放到phantomjs的根目錄 </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">&#x27;webpage&#x27;</span>).create(),</span><br><span class="line">system = <span class="built_in">require</span>(<span class="string">&#x27;system&#x27;</span>),</span><br><span class="line">edmid,</span><br><span class="line">address;</span><br><span class="line"></span><br><span class="line">address = system.args[<span class="number">1</span>];</span><br><span class="line">edmid = system.args[<span class="number">2</span>];</span><br><span class="line">path = system.args[<span class="number">3</span>];</span><br><span class="line"></span><br><span class="line">page.open(address,<span class="function"><span class="keyword">function</span>(<span class="params">status</span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">  page.render(path + <span class="string">&#x27;/&#x27;</span> + edmid+<span class="string">&#x27;.png&#x27;</span>);</span><br><span class="line">         phantom.exit();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>這支JS需要傳遞三個參數，1.網址 2.圖片的名稱 3.拍好的圖片存的路徑<br>在cmd的執行方式如下 <a href="http://2.bp.blogspot.com/-JzNg1l0-ucc/VPO_j7wIZfI/AAAAAAAAEVk/4wOAYPCPFe0/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png"><img src="http://2.bp.blogspot.com/-JzNg1l0-ucc/VPO_j7wIZfI/AAAAAAAAEVk/4wOAYPCPFe0/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png"></a><br>這次的功能是要在網站上按下一個按鈕後就對特定的網頁進行快照，程式如下 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//phantomjs在伺服器上的根目錄資料夾</span></span><br><span class="line">                <span class="built_in">string</span> path = HostingEnvironment.MapPath(<span class="string">@&quot;~/phantomjs&quot;</span>);</span><br><span class="line">                <span class="comment">//因為拍照可能需要數秒的時間，避免網頁被hand住所以切出執行緒來進行。故抓MapPath的方式需要改成 HostingEnvironment.MapPath</span></span><br><span class="line">                <span class="comment">//這裡是我把拍好的圖片放到哪個資料夾的路徑</span></span><br><span class="line">                <span class="built_in">string</span> snapshotPath = HostingEnvironment.MapPath(<span class="string">&quot;~/phantomjs/snapshot&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//透過Process這個類別來對cmd操作</span></span><br><span class="line">                <span class="keyword">using</span> (System.Diagnostics.Process exep = <span class="keyword">new</span> System.Diagnostics.Process())</span><br><span class="line">                &#123;</span><br><span class="line">                    System.Diagnostics.Process p = <span class="keyword">new</span> System.Diagnostics.Process();</span><br><span class="line">                    p.StartInfo.FileName = <span class="string">@&quot;C:\Windows\System32\cmd.exe&quot;</span>;</span><br><span class="line">                    p.StartInfo.RedirectStandardOutput = <span class="literal">true</span>;</span><br><span class="line">                    p.StartInfo.RedirectStandardInput = <span class="literal">true</span>;</span><br><span class="line">                    p.StartInfo.UseShellExecute = <span class="literal">false</span>;</span><br><span class="line">                    p.Start();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//StandardInput的資訊流指定給StreamWriter ，這樣只要透過StreamWriter寫指令就等於對cmd下command了</span></span><br><span class="line">                    StreamWriter sw = p.StandardInput;</span><br><span class="line">                    sw.WriteLine(<span class="string">@&quot;cd\&quot;</span>);</span><br><span class="line">                    sw.WriteLine(<span class="built_in">string</span>.Format(<span class="string">@&quot;&#123;0&#125;:&quot;</span>, path.Substring(<span class="number">0</span>, <span class="number">1</span>)));</span><br><span class="line">                    sw.WriteLine(<span class="string">@&quot;cd &quot;</span> + path);</span><br><span class="line">                    sw.WriteLine(<span class="built_in">string</span>.Format(<span class="string">@&quot;phantomjs snapshot.js &#123;0&#125; &#123;1&#125; &#123;2&#125;&quot;</span>, 網址, 圖片名稱, snapshotPath ));</span><br><span class="line">                    sw.Close();</span><br><span class="line">                    p.WaitForExit();</span><br><span class="line">               &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>重點在於只要自己透過cmd操作過phantomjs.exe來拍照，依樣畫葫蘆的透過Process逐步的下指令就可以達成了!! </p>
<p>另外phantomjs是將要被拍照的DOM元件抓下來在進行組合拍照，有了這個特性你就可以對想拍照的網站進行一些修改。例如載入JQuery把某個區塊移除之類的 </p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Wait until the test condition is true or a timeout occurs. Useful for waiting</span></span><br><span class="line"><span class="comment"> * on a server response or for a ui change (fadeIn, etc.) to occur.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>testFx javascript condition that evaluates to a boolean,</span></span><br><span class="line"><span class="comment"> * it can be passed in as a string (e.g.: &quot;1 == 1&quot; or &quot;$(&#x27;#bar&#x27;).is(&#x27;:visible&#x27;)&quot; or</span></span><br><span class="line"><span class="comment"> * as a callback function.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>onReady what to do when testFx condition is fulfilled,</span></span><br><span class="line"><span class="comment"> * it can be passed in as a string (e.g.: &quot;1 == 1&quot; or &quot;$(&#x27;#bar&#x27;).is(&#x27;:visible&#x27;)&quot; or</span></span><br><span class="line"><span class="comment"> * as a callback function.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param </span>timeOutMillis the max amount of time to wait. If not specified, 3 sec is used.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waitFor</span>(<span class="params">testFx, onReady, timeOutMillis</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> maxtimeOutMillis = timeOutMillis ? timeOutMillis : <span class="number">3000</span>, <span class="comment">//&lt; Default Max Timout is 3s</span></span><br><span class="line">        start = <span class="keyword">new</span> <span class="built_in">Date</span>().getTime(),</span><br><span class="line">        condition = <span class="literal">false</span>,</span><br><span class="line">        interval = <span class="built_in">setInterval</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> ( (<span class="keyword">new</span> <span class="built_in">Date</span>().getTime() - start &lt; maxtimeOutMillis) &amp;&amp; !condition ) &#123;</span><br><span class="line">                <span class="comment">// If not time-out yet and condition not yet fulfilled</span></span><br><span class="line">                condition = (<span class="keyword">typeof</span>(testFx) === <span class="string">&quot;string&quot;</span> ? <span class="built_in">eval</span>(testFx) : testFx()); <span class="comment">//&lt; defensive code</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(!condition) &#123;</span><br><span class="line">                    <span class="comment">// If condition still not fulfilled (timeout but condition is &#x27;false&#x27;)</span></span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;&#x27;waitFor()&#x27; timeout&quot;</span>);</span><br><span class="line">                    phantom.exit(<span class="number">1</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Condition fulfilled (timeout and/or condition is &#x27;true&#x27;)</span></span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;&#x27;waitFor()&#x27; finished in &quot;</span> + (<span class="keyword">new</span> <span class="built_in">Date</span>().getTime() - start) + <span class="string">&quot;ms.&quot;</span>);</span><br><span class="line">                    <span class="keyword">typeof</span>(onReady) === <span class="string">&quot;string&quot;</span> ? <span class="built_in">eval</span>(onReady) : onReady(); <span class="comment">//&lt; Do what it&#x27;s supposed to do once the condition is fulfilled</span></span><br><span class="line">                    <span class="built_in">clearInterval</span>(interval); <span class="comment">//&lt; Stop this interval</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">250</span>); <span class="comment">//&lt; repeat check every 250ms</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> page = <span class="built_in">require</span>(<span class="string">&#x27;webpage&#x27;</span>).create(),</span><br><span class="line">system = <span class="built_in">require</span>(<span class="string">&#x27;system&#x27;</span>),</span><br><span class="line">edmid,</span><br><span class="line">address;</span><br><span class="line"></span><br><span class="line">edmid = system.args[<span class="number">1</span>];</span><br><span class="line">address = <span class="string">&#x27;http://xxx.com.tw/&#x27;</span>+ edmid;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Open Twitter on &#x27;sencha&#x27; profile and, onPageLoad, do...</span></span><br><span class="line">page.open(address, <span class="function"><span class="keyword">function</span> (<span class="params">status</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Check for page load success</span></span><br><span class="line">    <span class="keyword">if</span> (status !== <span class="string">&quot;success&quot;</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">&quot;Unable to access network&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Wait for &#x27;signin-dropdown&#x27; to be visible</span></span><br><span class="line">        waitFor(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="comment">// Check in the page if a specific element is now visible</span></span><br><span class="line">            <span class="keyword">return</span> page.evaluate(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> ($(<span class="string">&quot;body&quot;</span>).prop(<span class="string">&quot;class&quot;</span>) == <span class="string">&quot;allready&quot;</span> );</span><br><span class="line">  <span class="comment">//return $(&quot;#signin-dropdown&quot;).is(&quot;:visible&quot;);</span></span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">           <span class="built_in">console</span>.log(<span class="string">&quot;body allready now.&quot;</span>);</span><br><span class="line">           page.render(<span class="string">&#x27;D:\\test\\&#x27;</span>+edmid+<span class="string">&#x27;.png&#x27;</span>);</span><br><span class="line">           phantom.exit();</span><br><span class="line">        &#125;);        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
  </entry>
  <entry>
    <title>【C#】程式建立LocalDB(.mdf)與刪除</title>
    <url>/2017/01/23/%E3%80%90C-%E3%80%91%E7%A8%8B%E5%BC%8F%E5%BB%BA%E7%AB%8BLocalDB-mdf-%E8%88%87%E5%88%AA%E9%99%A4/</url>
    <content><![CDATA[<p>之前有寫如何對Repository層做單元測試<span style="background-color: white; font-family: inherit; font-style: inherit; font-weight: inherit;"><span style="border-color: initial; border-image: initial; border-style: initial; font-style: inherit; font-weight: inherit; outline-color: initial; outline-style: initial;"><a href="http://toyo0103.blogspot.tw/2016/07/unit-testrepository.html">【Unit Test】針對Repository做單元測試 (一)</a>，當時是直接建立LocalDB放在專案之中，測試的時候對它執行，但因為公司導入CICD流程，這些MDF會殘留在佈署的機器上，造成資源的浪費，所以同事教了新的方法，用程式直接建立LocalDB，等到測試完畢後直接砍掉的方法。</span></span></p>
<p>這邊記錄一下實作方法，以利之後查找</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> LocalDbMasterConnectionString =</span><br><span class="line">   <span class="string">@&quot;Data Source=(LocalDB)\MSSQLLocalDB;Initial Catalog=master;Integrated Security=True&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">string</span> TestConnectionString =</span><br><span class="line">   <span class="string">@&quot;Data Source=(LocalDB)\MSSQLLocalDB;Initial Catalog=&#123;0&#125;;Integrated Security=True;</span></span><br><span class="line"><span class="string">                 MultipleActiveResultSets=True;AttachDBFilename=&#123;1&#125;.mdf&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">string</span> DatabaseName &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.DatabaseName = <span class="string">&quot;TestCreateDB&quot;</span>;</span><br><span class="line"> CreateDB();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 建立DB</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">CreateDB</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="comment">//先看看有沒有相同的DB存在，如果有的話卸離並移除</span></span><br><span class="line"> <span class="keyword">this</span>.DetachDatabase();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> fileName = <span class="keyword">this</span>.CleanupDatabase();</span><br><span class="line"></span><br><span class="line"> <span class="keyword">using</span> (<span class="keyword">var</span> connection = <span class="keyword">new</span> SqlConnection(LocalDbMasterConnectionString))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">var</span> commandText = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">  <span class="comment">//Create DB的語法</span></span><br><span class="line">  commandText.AppendFormat(</span><br><span class="line">   <span class="string">&quot;CREATE DATABASE &#123;0&#125; ON (NAME = N&#x27;&#123;0&#125;&#x27;, FILENAME = &#x27;&#123;1&#125;.mdf&#x27;);&quot;</span>,</span><br><span class="line">   <span class="keyword">this</span>.DatabaseName,</span><br><span class="line">   fileName);</span><br><span class="line"></span><br><span class="line">  connection.Open();</span><br><span class="line">  <span class="keyword">var</span> cmd = connection.CreateCommand();</span><br><span class="line">  cmd.CommandText = commandText.ToString();</span><br><span class="line">  cmd.ExecuteNonQuery();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Detaches the database.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">DetachDatabase</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">using</span> (<span class="keyword">var</span> connection = <span class="keyword">new</span> SqlConnection(LocalDbMasterConnectionString))</span><br><span class="line"> &#123;</span><br><span class="line">  connection.Open();</span><br><span class="line">  <span class="keyword">var</span> cmd = connection.CreateCommand();</span><br><span class="line">  cmd.CommandText = <span class="built_in">string</span>.Format(<span class="string">&quot;exec sp_detach_db &#x27;&#123;0&#125;&#x27;&quot;</span>, <span class="keyword">this</span>.DatabaseName);</span><br><span class="line">  <span class="keyword">try</span></span><br><span class="line">  &#123;</span><br><span class="line">   cmd.ExecuteNonQuery();</span><br><span class="line">  &#125;</span><br><span class="line">  catch</span><br><span class="line">  &#123;</span><br><span class="line">   Console.WriteLine(<span class="string">&quot;Could not detach&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Cleanups the database.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>System.String.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">CleanupDatabase</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">var</span> fileName = <span class="built_in">string</span>.Concat(<span class="string">@&quot;G:\&quot;</span>,<span class="keyword">this</span>.DatabaseName);</span><br><span class="line"> <span class="keyword">try</span></span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">var</span> mdfPath = <span class="built_in">string</span>.Concat(fileName, <span class="string">&quot;.mdf&quot;</span>);</span><br><span class="line">  <span class="keyword">var</span> ldfPath = <span class="built_in">string</span>.Concat(fileName, <span class="string">&quot;_log.ldf&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> mdfExists = File.Exists(mdfPath);</span><br><span class="line">  <span class="keyword">var</span> ldfExists = File.Exists(ldfPath);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (mdfExists) File.Delete(mdfPath);</span><br><span class="line">  <span class="keyword">if</span> (ldfExists) File.Delete(ldfPath);</span><br><span class="line"> &#125;</span><br><span class="line"> catch</span><br><span class="line"> &#123;</span><br><span class="line">  Console.WriteLine(<span class="string">&quot;Could not delete the files (open in Visual Studio?)&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> fileName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最後就會在你寫的位置看到產生的DB了</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-zochbU5phtw/WIWuOeDVZ4I/AAAAAAAAID0/MwBAkQ4YEyQCLFLHbWnBaUiXVbtGrIseACLcB/s1600/1.png)](https://2.bp.blogspot.com/-zochbU5phtw/WIWuOeDVZ4I/AAAAAAAAID0/MwBAkQ4YEyQCLFLHbWnBaUiXVbtGrIseACLcB/s1600/1.png)</div>

<h3 id="刪除"><a href="#刪除" class="headerlink" title="刪除"></a>刪除</h3><p>首先要先在專案安裝Entity Framerok，並且補上以下的程式</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 使用 EntityFramework 的 Database 類別 Delete 方法，確認 LocalDB 存在後再移除.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DeleteLocalDb</span>(<span class="params"><span class="built_in">string</span> dbName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> connection = <span class="keyword">new</span> SqlConnection(</span><br><span class="line">                                        <span class="built_in">string</span>.Format(TestConnectionString,dbName, dbName)))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (Database.Exists(connection))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">try</span></span><br><span class="line">                    &#123;</span><br><span class="line">                        SqlConnection.ClearAllPools();</span><br><span class="line">                        Database.Delete(connection);</span><br><span class="line">                    &#125;</span><br><span class="line">                    catch (Exception)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">using</span> (SqlConnection masterConnection = <span class="keyword">new</span> SqlConnection(LocalDbMasterConnectionString))</span><br><span class="line">                        &#123;</span><br><span class="line">                            SqlCommand cmd = masterConnection.CreateCommand();</span><br><span class="line">                            cmd.CommandText = <span class="built_in">string</span>.Format(</span><br><span class="line">                                <span class="string">@&quot;ALTER DATABASE [&#123;0&#125;] SET SINGLE_USER WITH ROLLBACK IMMEDIATE;</span></span><br><span class="line"><span class="string">                                 DROP DATABASE [&#123;0&#125;];&quot;</span>, connection.Database);</span><br><span class="line"></span><br><span class="line">                            masterConnection.Open();</span><br><span class="line">                            cmd.ExecuteNonQuery();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>接著呼叫，就可以砍掉剛剛建立出來的MDF了 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> DatabaseName = <span class="string">&quot;TestCreateDB&quot;</span>;</span><br><span class="line">DeleteLocalDb(DatabaseName);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>但有一點必須特別注意，如果你今天的專案結構跟我一樣</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-x8WxDPWuFrM/WIW661-YM_I/AAAAAAAAIEQ/kV7NxAeClFw5DllZUb6QK2QuKw25ksTKwCLcB/s1600/1.png)](https://3.bp.blogspot.com/-x8WxDPWuFrM/WIW661-YM_I/AAAAAAAAIEQ/kV7NxAeClFw5DllZUb6QK2QuKw25ksTKwCLcB/s1600/1.png)</div>

<p>刪除DB的程式碼寫在ControlLocalDB的專案中，並且在這個專案有安裝Entity Framework，而ConsoleApplication1只是引用ControlLocalDB專案來執行，而沒有安裝Entity Framework，那這時候 </p>
<div class="note info">
            <p>Database.Exists(connection)</p>
          </div>
<p>會永遠回傳<strong>False</strong>，所以不會去砍掉DB，而且也不會引發Exception的錯誤，不知道算不算是EF的Bug，當時找超久的(崩潰)，所以還請特別注意這個地方，有用到這個方法的專案都要記得專EF</p>
<p>參考文章:<br>1.<a href="https://support.microsoft.com/zh-tw/help/307283/how-to-create-a-sql-server-database-programmatically-by-using-ado.net-and-visual-c-.net">HOW TO：使用 ADO.NET 與 Visual C# .NET 程式建立 SQL Server 資料庫</a><br>2.<a href="http://kevintsengtw.blogspot.tw/2016/10/repository-localdb-part2.html">Repository 測試使用 LocalDB - Part.2</a></p>
]]></content>
      <tags>
        <tag>C#</tag>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【CI/CD】1. 如何透過VSTS來達成CI的目標</title>
    <url>/2018/01/25/%E3%80%90CI-CD%E3%80%911-%E5%A6%82%E4%BD%95%E9%80%8F%E9%81%8EVSTS%E4%BE%86%E9%81%94%E6%88%90CI%E7%9A%84%E7%9B%AE%E6%A8%99/</url>
    <content><![CDATA[<p>以下是Wiki對於CI的解釋</p>
<div class="note info">
            <p>持續整合（英語：Continuous integration，縮寫CI）是一種軟體工程流程，是將所有軟體工程師對於軟體的工作副本持續整合到共用主線（mainline）的一種舉措。<br>該名稱最早由[1]葛來迪·布區（Grady Booch）在他的布區方法[2]中提出，不過他並沒有提到要每天整合數次。之後該舉措成為極限編程（extreme programming）的一部份時，其中建議每天應整合超過一次，甚至達到數十次。<br>[3]在測試驅動開發（TDD）的作法中，通常還會搭配自動單元測試。持續整合的提出主要是為解決軟體進行系統整合時面臨的各項問題，極限編程稱這些問題為整合地獄（integration hell）。</p>
          </div>

<p>而自己對CI的見解是，透過軟體版本控管機制，持續將每個分支每次修改進行整合，並且透過<strong>自動化</strong>的測試、佈署、執行報告來控管軟體品質。</p>
<div class="note info">
            <p>參考 : <a href="https://dotblogs.com.tw/hatelove/archive/2011/12/25/introducing-continuous-integration.aspx">[軟體工程]持續整合 (Continuous integration, CI) 簡介 - 91</a></p>
          </div>


<p>而這篇是要寫如何透過VSTS來達成此目標，跟整個設定的過程，先來整理要達成的目標項目。</p>
<p>希望<br>1.<strong>版控更新時，自動建置</strong><br>2.<strong>自動執行單元測試</strong><br>3.<strong>將建置好的檔案放到佈署資料夾(<strong>之後讓CD接手，做自動化佈署到正式機、測試機..等</strong>)</strong><br>4.<strong>回報上述執行結果</strong></p>
<h3 id="版控更新時，自動建置"><a href="#版控更新時，自動建置" class="headerlink" title="版控更新時，自動建置"></a>版控更新時，自動建置</h3><div>

<h4 id="1-到VSTS網站頁面，選擇Build-and-Release-nbsp-gt-nbsp-New"><a href="#1-到VSTS網站頁面，選擇Build-and-Release-nbsp-gt-nbsp-New" class="headerlink" title="1.到VSTS網站頁面，選擇Build and Release&nbsp; &gt;&nbsp; +New"></a>1.<span style="font-weight: normal;">到VSTS網站頁面，選擇</span><strong>Build and Release&nbsp; &gt;&nbsp; +New</strong></h4></div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-XS-Ogl-wsag/WmmPVNrH_bI/AAAAAAAAIV8/cjl3VdVp6gsL11fiftfSCIcec9EsE_gGgCLcBGAs/s640/1.png)](https://3.bp.blogspot.com/-XS-Ogl-wsag/WmmPVNrH_bI/AAAAAAAAIV8/cjl3VdVp6gsL11fiftfSCIcec9EsE_gGgCLcBGAs/s1600/1.png)</div><div>**
**</div><div>
</div><div>

<h4 id="2-選擇Empty-process"><a href="#2-選擇Empty-process" class="headerlink" title="2.選擇Empty process"></a>2.<span style="font-weight: normal;">選擇</span><strong>Empty process</strong></h4></div>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-qw_0GPoI3i4/WmmPmH3ClGI/AAAAAAAAIWA/pMV4k7v1uZQlucvGW5U0dy_Mu2MjwCVdQCLcBGAs/s400/1.png)](https://4.bp.blogspot.com/-qw_0GPoI3i4/WmmPmH3ClGI/AAAAAAAAIWA/pMV4k7v1uZQlucvGW5U0dy_Mu2MjwCVdQCLcBGAs/s1600/1.png)</div>

<p>Process Agent queue設定</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-nv9FB-OKBu8/WmmiC6TnyPI/AAAAAAAAIYs/unfIYRSe9wgUs1490wBHMKwp9_bOsAC_QCLcBGAs/s640/1.png)](https://4.bp.blogspot.com/-nv9FB-OKBu8/WmmiC6TnyPI/AAAAAAAAIYs/unfIYRSe9wgUs1490wBHMKwp9_bOsAC_QCLcBGAs/s1600/1.png)</div>

<h4 id="3-加入Nuget-restore-Task，因為我們專案都有用Nuget，所以需要在建置之前先還原Nuget，設定如下"><a href="#3-加入Nuget-restore-Task，因為我們專案都有用Nuget，所以需要在建置之前先還原Nuget，設定如下" class="headerlink" title="3.加入Nuget restore Task，因為我們專案都有用Nuget，所以需要在建置之前先還原Nuget，設定如下"></a>3.<span style="font-weight: normal;">加入</span><strong>Nuget restore Task</strong>，<span style="font-weight: normal;">因為我們專案都有用Nuget，所以需要在建置之前先還原Nuget，設定如下</span></h4><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-hFBqYKbzhfI/WmmUkjd318I/AAAAAAAAIWc/VnQOMKDfOWUFlsdbTwtgOzDsuEo1HyDWwCLcBGAs/s640/1.png)](https://1.bp.blogspot.com/-hFBqYKbzhfI/WmmUkjd318I/AAAAAAAAIWc/VnQOMKDfOWUFlsdbTwtgOzDsuEo1HyDWwCLcBGAs/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-8bU6NhV_axk/WmmSF6nLdzI/AAAAAAAAIWQ/xR8dyhcgSP8e9s4c5pukjKhgmiqKKmyYwCLcBGAs/s640/1.png)](https://1.bp.blogspot.com/-8bU6NhV_axk/WmmSF6nLdzI/AAAAAAAAIWQ/xR8dyhcgSP8e9s4c5pukjKhgmiqKKmyYwCLcBGAs/s1600/1.png)</div>
這邊Feed to use 我選擇Feeds in my Nuget.config，原因是公司專案有用自己開發的Nuget套件，而那些Nuget放的位置就需要自訂的Config讓建置機器知道，否則抓不到那些套件，待會建置就會錯誤，如果專案沒有用內部Nuget Server的套件，就選第一個即可。

<div class="note info">
            <p>通常如果我們有用私人的Nuget套件，一定會在VS設定套件來源，而這個設定檔就會放在底下這個位置<br>%appdata%\NuGet\NuGet.Config<br>把檔案放進版控中，就可以讓VSTS選的到了</p>
          </div>


<h4 id="4-加入Build-Solution-Task"><a href="#4-加入Build-Solution-Task" class="headerlink" title="4.加入Build Solution Task"></a>4.<span style="font-weight: normal;">加入</span><strong>Build Solution Task</strong></h4><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-P83wkuHiW_Q/WmmU9NttxhI/AAAAAAAAIWg/eKcneONO0H0amRUTTrN0KmMSpKnIHFaCgCLcBGAs/s400/1.png)](https://4.bp.blogspot.com/-P83wkuHiW_Q/WmmU9NttxhI/AAAAAAAAIWg/eKcneONO0H0amRUTTrN0KmMSpKnIHFaCgCLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-VpXPU2_Rkb8/WmmVvzSQSBI/AAAAAAAAIWs/Mpu-mZu4gqEzXQBfEqurgLBwRxTc2fp_ACLcBGAs/s640/1.png)](https://1.bp.blogspot.com/-VpXPU2_Rkb8/WmmVvzSQSBI/AAAAAAAAIWs/Mpu-mZu4gqEzXQBfEqurgLBwRxTc2fp_ACLcBGAs/s1600/1.png)</div>**
***這邊MSBuild Arguments裡面的PublishProfile=CICD，意思是說我們要用的發行檔名稱，而名稱就做CICD，所以等等我們會回VisualStudio建立一個名叫CICD的發行檔

<p>*Configuration，是說我要用Debug的組態檔來建置，如果你不知道組態檔是什麼，請看</p>
<div class="note info">
            <p>參考 : <a href="http://kevintsengtw.blogspot.tw/2014/08/webconfig.html">發佈網站時依據組態設定的不同而轉換 Web.Config   -  MRKT</a></p>
          </div>


<h4 id="5-建立CICD發行檔"><a href="#5-建立CICD發行檔" class="headerlink" title="5.建立CICD發行檔"></a>5.建立CICD發行檔</h4><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-fXHi2n6VZFM/WmmYCGCjFAI/AAAAAAAAIW4/5zbkFrA19Fon58CJBVLTEUJR3Chqz50iQCLcBGAs/s400/1.png)](https://4.bp.blogspot.com/-fXHi2n6VZFM/WmmYCGCjFAI/AAAAAAAAIW4/5zbkFrA19Fon58CJBVLTEUJR3Chqz50iQCLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-l1gb4UnmpmM/WmmYYZTNDxI/AAAAAAAAIW8/0HjBNGwjRNMIErNyx8lrVf4Hy7TZ88x9ACLcBGAs/s400/1.png)](https://1.bp.blogspot.com/-l1gb4UnmpmM/WmmYYZTNDxI/AAAAAAAAIW8/0HjBNGwjRNMIErNyx8lrVf4Hy7TZ88x9ACLcBGAs/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-32aEvFZCe6g/WmmZW11jZ0I/AAAAAAAAIXI/2Ei-9zh3KhQx06veBMtbWEa7H4tc3idvgCLcBGAs/s400/1.png)](https://1.bp.blogspot.com/-32aEvFZCe6g/WmmZW11jZ0I/AAAAAAAAIXI/2Ei-9zh3KhQx06veBMtbWEa7H4tc3idvgCLcBGAs/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-1RqfQqrD0C8/WmmZoZZViaI/AAAAAAAAIXM/34faHBlj3c4KF4xz7FwZnZmWayUpSodlwCLcBGAs/s320/1.png)](https://2.bp.blogspot.com/-1RqfQqrD0C8/WmmZoZZViaI/AAAAAAAAIXM/34faHBlj3c4KF4xz7FwZnZmWayUpSodlwCLcBGAs/s1600/1.png)</div>
你可以先用VS發行看看，應該會在專案的Root資料夾底下長出一個Publish的資料夾，底下內容如下
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-PzHy8-PeILA/WmmaFi-990I/AAAAAAAAIXU/lms69Y9-8BcER7sAvGlMt2x38tEUFQcagCLcBGAs/s640/1.png)](https://1.bp.blogspot.com/-PzHy8-PeILA/WmmaFi-990I/AAAAAAAAIXU/lms69Y9-8BcER7sAvGlMt2x38tEUFQcagCLcBGAs/s1600/1.png)</div>之後WebDeply就靠這些檔案了。 回到VSTS繼續設定

<h4 id="6-加入Visual-Studio-Test-Task"><a href="#6-加入Visual-Studio-Test-Task" class="headerlink" title="6.加入Visual Studio Test Task"></a>6.<span style="font-weight: normal;">加入</span>Visual Studio Test Task</h4><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-QBXq7Esdoro/WmmarbzFXlI/AAAAAAAAIXc/yTYh8E4y8Uwq1NX4NTjHjxUJFoxvAJKvACLcBGAs/s400/1.png)](https://4.bp.blogspot.com/-QBXq7Esdoro/WmmarbzFXlI/AAAAAAAAIXc/yTYh8E4y8Uwq1NX4NTjHjxUJFoxvAJKvACLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-Ik2JJshPoNw/WmmbErAetqI/AAAAAAAAIXg/iBT1z4W5SfUMPIwsR6Cgk8O5FC2Ox-KjwCLcBGAs/s400/1.png)](https://4.bp.blogspot.com/-Ik2JJshPoNw/WmmbErAetqI/AAAAAAAAIXg/iBT1z4W5SfUMPIwsR6Cgk8O5FC2Ox-KjwCLcBGAs/s1600/1.png)</div><div>
</div><div>紅框處是告訴這個Task，如何找到你的單元測試Dll來執行，如果你建立單元測試專案都是用預設的方式，那單元測試的專案名稱應該都會是 xxxTest，所以建置出來的Dll也會是xxxTest.dll，符合紅框預設尋找的條件，所以不用調整</div><div>
</div><div>
</div><div>

<h4 id="7-加入Copy-Files-Task"><a href="#7-加入Copy-Files-Task" class="headerlink" title="7.加入Copy Files Task"></a>7.<span style="font-weight: 400;">加入</span>Copy Files Task</h4></div><div>目的是如果前面幾個Task都通過執行到這邊，表示建置沒有問題，且單元測試全部通過，所發行出來的檔案，加下來要把這些檔案複製出來，準備移到成品資料夾</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-Tr8vDR0SmDU/WmmciCbYKwI/AAAAAAAAIXw/5i0cUOgtWDQLXiCveVshcpqSZa1ZQscNACLcBGAs/s400/1.png)](https://3.bp.blogspot.com/-Tr8vDR0SmDU/WmmciCbYKwI/AAAAAAAAIXw/5i0cUOgtWDQLXiCveVshcpqSZa1ZQscNACLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-kmgOU-k_3jY/Wmmc_n-HXlI/AAAAAAAAIX0/0P0WAy6oXRUmGStC-upMnLfFPWck3ydFACLcBGAs/s640/1.png)](https://3.bp.blogspot.com/-kmgOU-k_3jY/Wmmc_n-HXlI/AAAAAAAAIX0/0P0WAy6oXRUmGStC-upMnLfFPWck3ydFACLcBGAs/s1600/1.png)</div><div>
</div><div>黑框遮掉的部分就跟之前一樣是專案名稱，我的專案名稱是XXX.Application，所以那個區段請自行置換。</div><div>
</div><div>另外還記得Publish這個資料夾嗎?這就是我們剛剛在Visual Studio設定在CICD發行檔的建置發行檔存放的位置，套上預設VSTS建置專案的資料夾變數位置，就變成這行的值了</div><div>
</div><div class="note info">
            <p>參考 : <a href="https://docs.microsoft.com/en-us/vsts/build-release/concepts/definitions/build/variables?tabs=batch">VSTS Build variables</a> </p>
          </div>


<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="8-將成品資料夾內容丟到Drop資料夾"><a href="#8-將成品資料夾內容丟到Drop資料夾" class="headerlink" title="8.將成品資料夾內容丟到Drop資料夾"></a>8.將成品資料夾內容丟到Drop資料夾</h4><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-88XzfFqDwog/WmmeuQ9zKzI/AAAAAAAAIYE/oIV5xH2wEgADVD-jNi-boqu6ZySliBYnwCLcBGAs/s400/1.png)](https://3.bp.blogspot.com/-88XzfFqDwog/WmmeuQ9zKzI/AAAAAAAAIYE/oIV5xH2wEgADVD-jNi-boqu6ZySliBYnwCLcBGAs/s1600/1.png)</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-RJHr9xJXX60/Wmme3l784sI/AAAAAAAAIYI/Az3zsxDNF38IududQuL3s8zkk7WEDpGmQCLcBGAs/s640/1.png)](https://2.bp.blogspot.com/-RJHr9xJXX60/Wmme3l784sI/AAAAAAAAIYI/Az3zsxDNF38IududQuL3s8zkk7WEDpGmQCLcBGAs/s1600/1.png)</div><div>
</div><div>
</div><div>
</div><div>到這邊CI的任務大致完成，已經能將專案自動建置、單元測試、將成品打包準備佈署到Server，接下來如何將這成品佈署到Server就是CD的議題了，留待之後在說。</div><div>
</div><div>
</div><div>這邊還有最重要的一點，既然是持續整合，那這些任務如何自動化的持續整合，如果每次版控有異動都還要人來操作這些任務，那就失去了持續整合的意義。</div><div>
</div>

<h3 id="將CI任務加上Trigger條件"><a href="#將CI任務加上Trigger條件" class="headerlink" title="將CI任務加上Trigger條件"></a>將CI任務加上Trigger條件</h3><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-mpvJaiE8Apc/WmmgTg2yIJI/AAAAAAAAIYY/7FH7zn14ovMWFtsIKCMYhFcW4k4Hm3SSACLcBGAs/s640/1.png)](https://4.bp.blogspot.com/-mpvJaiE8Apc/WmmgTg2yIJI/AAAAAAAAIYY/7FH7zn14ovMWFtsIKCMYhFcW4k4Hm3SSACLcBGAs/s1600/1.png)</div><div>這邊設定意思是說，當這個專案的Develop分支有新的Commit進來時，剛剛設定的那些任務就會被自動化的執行。</div><div>
</div><div>而每次執行的結果如下</div><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-22JmmaFCkjs/Wmmg5b-NLhI/AAAAAAAAIYg/H9clp3fIeF0NQsHTs96xEr3uSkvnExEfwCLcBGAs/s400/1.png)](https://4.bp.blogspot.com/-22JmmaFCkjs/Wmmg5b-NLhI/AAAAAAAAIYg/H9clp3fIeF0NQsHTs96xEr3uSkvnExEfwCLcBGAs/s1600/1.png)</div><div>
</div><div>點擊每一次進去可以看到執行的狀況，或是以及錯誤的Log</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-GNDMtKmEkwg/WmmhlqGuDTI/AAAAAAAAIYo/7tgSawThmfQw6sYKRu9B9k2TkyHwXBG2ACLcBGAs/s640/1.png)](https://3.bp.blogspot.com/-GNDMtKmEkwg/WmmhlqGuDTI/AAAAAAAAIYo/7tgSawThmfQw6sYKRu9B9k2TkyHwXBG2ACLcBGAs/s1600/1.png)</div><div>
</div><div>
</div><div>
</div><div>
</div><div>也可以手動排Queue，讓他立即依據現在最新版本或是特定版本去執行</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-EJjqIGXvgro/Wmmik_1pz3I/AAAAAAAAIY4/8QLNaTEmJrMhAK871kW4yf_YLSyUlMQ5QCLcBGAs/s640/1.png)](https://1.bp.blogspot.com/-EJjqIGXvgro/Wmmik_1pz3I/AAAAAAAAIY4/8QLNaTEmJrMhAK871kW4yf_YLSyUlMQ5QCLcBGAs/s1600/1.png)</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-X-V_2Mj63Cs/Wmmi0um07kI/AAAAAAAAIY8/hEtz4yx2s94wJppHAoL2eT6jR0a9DIzgACLcBGAs/s400/1.png)](https://3.bp.blogspot.com/-X-V_2Mj63Cs/Wmmi0um07kI/AAAAAAAAIY8/hEtz4yx2s94wJppHAoL2eT6jR0a9DIzgACLcBGAs/s1600/1.png)</div><div>
</div><div>
</div><div>
</div><div>Commit可以填入Git的Commit ID，如果不填就會用最新版執行建置。</div><div>
</div><div>
</div><div>
下一篇預計接著寫CD的部分，如何接著將以上建置完的檔案分別佈署到Azure AppService以及VM機器上。

<p>參考文章</p>
<p><a href="https://docs.microsoft.com/en-us/vsts/build-release/actions/ci-cd-part-1">Create your first build and release | Microsoft Docs</a></p>
<p><a href="http://kevintsengtw.blogspot.tw/2014/08/webconfig.html">發佈網站時依據組態設定的不同而轉換 Web.Config&nbsp; &nbsp;-&nbsp; MRKT</a></p>
<p><a href="https://dotblogs.com.tw/hatelove/archive/2011/12/25/introducing-continuous-integration.aspx">[軟體工程]持續整合 (Continuous integration, CI) 簡介 - 91</a></div></p>
]]></content>
      <categories>
        <category>VSTS建置CI-CD</category>
      </categories>
      <tags>
        <tag>CI/CD</tag>
        <tag>VSTS</tag>
      </tags>
  </entry>
  <entry>
    <title>【C#】透過C#加密</title>
    <url>/2013/05/01/%E3%80%90C-%E3%80%91%E9%80%8F%E9%81%8EC-%E5%8A%A0%E5%AF%86/</url>
    <content><![CDATA[<p>strKey與strIV是用來加密的參數，可以替換任何字元<span style="color: red;">但一定要8個字</span></p>
<pre class="brush: csharp"> //加密動作
private static string strKey = "toyo1234";  
private static string strIV = "lovecode";

/// &lt;summary&gt;字串編碼&lt;/summary&gt;
/// &lt;param name="strSource"&gt;原始字串&lt;/param&gt;
/// &lt;returns&gt;編碼後的結果字串&lt;/returns&gt;
public static string enCrypt(string strSource)
{
   MemoryStream ms = new MemoryStream();
   DESCryptoServiceProvider key = new DESCryptoServiceProvider();  
   CryptoStream encStream = new CryptoStream(ms, key.CreateEncryptor(Encoding.Default.GetBytes(strKey),     Encoding.Default.GetBytes(strIV)), CryptoStreamMode.Write);
   StreamWriter sw = new StreamWriter(encStream);
   sw.WriteLine(strSource);
   sw.Close();
   encStream.Close();
   byte[] buffer = ms.ToArray();         
   ms.Close();
   return Convert.ToBase64String(buffer);   
}

/// &lt;summary&gt;字串解碼&lt;/summary&gt;
/// &lt;param name="strSource"&gt;加密過的字串&lt;/param&gt;
/// &lt;returns&gt;解碼後的結果字串&lt;/returns&gt;
public static string deCrypt(string strSource)
{
    MemoryStream ms = new MemoryStream(Convert.FromBase64String(strSource));
    DESCryptoServiceProvider key = new DESCryptoServiceProvider();
    CryptoStream encStream = new CryptoStream(ms, key.CreateDecryptor(Encoding.Default.GetBytes(strKey), Encoding.Default.GetBytes(strIV)), CryptoStreamMode.Read);
    StreamReader sr = new StreamReader(encStream);
    string val = sr.ReadLine();
    sr.Close();
    encStream.Close();
    ms.Close();

    return val;
}

</pre>]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【CI/CD】2. 透過VSTS自動佈署程式到Azure AppService</title>
    <url>/2018/01/26/%E3%80%90CI-CD%E3%80%912-%E9%80%8F%E9%81%8EVSTS%E8%87%AA%E5%8B%95%E4%BD%88%E7%BD%B2%E7%A8%8B%E5%BC%8F%E5%88%B0Azure-AppService/</url>
    <content><![CDATA[<div class="note info">
            <p>接續前篇 : <a href="http://toyo0103.blogspot.tw/2018/01/cicd1-vstsci.html">【CI/CD】1. 如何透過VSTS來達成CI的目標</a></p>
          </div>

<p>這邊的目標是當CI完成時，自動將程式佈署到Azure AppService，也就是所謂的CD部分</p>
<div class="note info">
            <p>持續部署(Continuous Deployment)<br>大部分的持續整合系統允許在建置完成後自動執行程式碼。因此能夠寫一段程式碼來布署應用程式至任何人都可以觀察的測試伺服器。在持續性整合未來的思考發展成像持續性布署邁進。<br>持續性布署將要求直接將軟體布署至測試環境中，這通常需要額外的自動化機制來防止程式缺陷。</p>
          </div>

<p><span style="background-color: white; color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: 15px;">希望</span><br><span style="background-color: white; color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: 15px;">1.</span><strong>CI部分執行完畢後，將程式自動佈署到機器</strong><br><span style="background-color: white; color: #777777; font-family: &quot;roboto slab&quot; , sans-serif;"><span style="font-size: 15px;">2.</span><strong>依據不同的CI Task，決定佈署到哪些機器</strong><span style="font-size: x-small;"> (測試機 or 多台正式機…等)</span></span><br><span style="background-color: white; color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: 15px;">3.</span>**人員核准 **<span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif;"><span style="font-size: x-small;">(正式機通常需要一定權限核准才能執行佈署)</span></span><br><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;"><br></span><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;"><br></span><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;"><br></span></p>
<h4 id="1-先進到VSTS的Release-gt-Create-release-Definitions"><a href="#1-先進到VSTS的Release-gt-Create-release-Definitions" class="headerlink" title="1.先進到VSTS的Release &gt; Create release Definitions"></a><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">1.<span style="font-weight: normal;">先進到VSTS的</span>Release &gt; Create release Definitions</span></h4><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-j4SKGxGUXWc/WmqJEJctL1I/AAAAAAAAIZY/-CHGLoBOXJY8d9VtIaz-35vVkgPS9FuCgCLcBGAs/s640/1.png)](https://4.bp.blogspot.com/-j4SKGxGUXWc/WmqJEJctL1I/AAAAAAAAIZY/-CHGLoBOXJY8d9VtIaz-35vVkgPS9FuCgCLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">
</span></div><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">
</span></div>

<h4 id="2-選擇Empty-Process"><a href="#2-選擇Empty-Process" class="headerlink" title="2.選擇Empty Process"></a><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">2.<span style="font-weight: normal;">選擇</span>Empty Process</span></h4><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-yx2eYYmHSqg/WmqJXg1LlmI/AAAAAAAAIZc/8SxeXNTgDkEk7xDragehBih3J8u9hOfkwCLcBGAs/s400/1.png)](https://3.bp.blogspot.com/-yx2eYYmHSqg/WmqJXg1LlmI/AAAAAAAAIZc/8SxeXNTgDkEk7xDragehBih3J8u9hOfkwCLcBGAs/s1600/1.png)</div><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">
</span></div><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">
</span></div><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">
</span></div>

<h4 id="3-在Artifacts選擇佈署要用哪一組CI建置的成品"><a href="#3-在Artifacts選擇佈署要用哪一組CI建置的成品" class="headerlink" title="3.在Artifacts選擇佈署要用哪一組CI建置的成品"></a><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">3.<span style="font-weight: normal;">在</span></span><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">Artifacts<span style="font-weight: normal;">選擇佈署要用哪一組CI建置的成品</span></span></h4><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-lpW6Y2RApv4/WmqJ2ScPvCI/AAAAAAAAIZo/Hdz-H64BtY0GiD8xdEHt7ZezAOQQUKDCgCLcBGAs/s400/1.png)](https://4.bp.blogspot.com/-lpW6Y2RApv4/WmqJ2ScPvCI/AAAAAAAAIZo/Hdz-H64BtY0GiD8xdEHt7ZezAOQQUKDCgCLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-1yfWjZ26ZWk/WmqKTGiIrFI/AAAAAAAAIZw/Oq49HUpyphwVZ7FcV-xFVEpUfNB2UpT9gCLcBGAs/s400/1.png)](https://4.bp.blogspot.com/-1yfWjZ26ZWk/WmqKTGiIrFI/AAAAAAAAIZw/Oq49HUpyphwVZ7FcV-xFVEpUfNB2UpT9gCLcBGAs/s1600/1.png)</div><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;"><span style="font-weight: normal;">
</span></span></div><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;"><span style="font-weight: normal;">
</span></span></div><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;"><span style="font-weight: normal;">
</span></span></div>

<h4 id="4-設定Trigger條件"><a href="#4-設定Trigger條件" class="headerlink" title="4.設定Trigger條件"></a><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">4.<span style="font-weight: normal;">設定</span>Trigger<span style="font-weight: normal;">條件</span></span></h4><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">我們希望上一步驟選擇的CI Task建置完成後，自動觸發這個的CD流程，所以要加上Trigger條件</span>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-LFkrO0ACJ5w/WmqMbAIfg5I/AAAAAAAAIaM/jGU4bXy_CZo17kKHN4h_1IdZAeNkN37KgCLcBGAs/s400/1.png)](https://3.bp.blogspot.com/-LFkrO0ACJ5w/WmqMbAIfg5I/AAAAAAAAIaM/jGU4bXy_CZo17kKHN4h_1IdZAeNkN37KgCLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-xUgj-OM9P4Y/WmqMr611LmI/AAAAAAAAIaQ/nfdvmcsj_88OOwqq6OK32BNanBRvghZ6gCLcBGAs/s400/1.png)](https://4.bp.blogspot.com/-xUgj-OM9P4Y/WmqMr611LmI/AAAAAAAAIaQ/nfdvmcsj_88OOwqq6OK32BNanBRvghZ6gCLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div></div><div class="separator" style="clear: both; text-align: center;">
</div><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">
</span></div><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">
</span></div><div><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">
</span></div><div>

<h4 id="5-新增Enviroment-Task-gt-Azure-App-Service-Deploy"><a href="#5-新增Enviroment-Task-gt-Azure-App-Service-Deploy" class="headerlink" title="5.新增Enviroment Task &gt; Azure App Service Deploy"></a><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">5.<span style="font-weight: normal;">新增</span>Enviroment Task &gt; Azure App Service Deploy</span></h4></div><div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-iBKwQJIYa6Q/WmqM79F_lYI/AAAAAAAAIaY/gsTQ7EtWRywGnpyXXO42WAjG--EmzdfNACLcBGAs/s400/1.png)](https://2.bp.blogspot.com/-iBKwQJIYa6Q/WmqM79F_lYI/AAAAAAAAIaY/gsTQ7EtWRywGnpyXXO42WAjG--EmzdfNACLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-DwVyGiM89Us/WmqNTD0Dv3I/AAAAAAAAIag/QcKJhKXT1RQPC1rYn-E50OCxSaDBwFYegCLcBGAs/s400/1.png)](https://1.bp.blogspot.com/-DwVyGiM89Us/WmqNTD0Dv3I/AAAAAAAAIag/QcKJhKXT1RQPC1rYn-E50OCxSaDBwFYegCLcBGAs/s1600/1.png)</div>

<h4 id="6-設定相關參數"><a href="#6-設定相關參數" class="headerlink" title="6.設定相關參數"></a>6.<span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: x-small;">設定相關參數</span></h4><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-SdtrEkvtTsU/WmqW3HlYaJI/AAAAAAAAIa0/LewJi_YI2qsNJH7MMi5KQNJiVdOwSvF-gCLcBGAs/s1600/1.png)](https://3.bp.blogspot.com/-SdtrEkvtTsU/WmqW3HlYaJI/AAAAAAAAIa0/LewJi_YI2qsNJH7MMi5KQNJiVdOwSvF-gCLcBGAs/s1600/1.png)</div>**Azure subscription **: 選擇你訂閱的Azure服務，基本如果是同一個帳號，下拉選單就可以看到

<p><strong>Package or folder&nbsp;</strong>: 因為我們是採用WebDeploy的方式佈署，所以要輸入Pakage的路徑，紅色區塊請填你CI Task所設定的名稱，CI建置會放置在同名的資料夾底下，之後就是Drop底下建置出來的.zip檔</p>
<h3 id="人員核准"><a href="#人員核准" class="headerlink" title="人員核准"></a>人員核准</h3></div><div>依照上述步驟做完，基本上佈署流程大致上已經完成，但通常會有一些狀況是希望做佈署動作前能夠先透過人來審核，例如正式機佈署。 我們一定不希望隨便人簽入程式後，正式機的CD流程就自動觸發佈署去了。</div><div>
</div>

<h4 id="設定審核人員"><a href="#設定審核人員" class="headerlink" title="設定審核人員"></a>設定審核人員</h4><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-9Fe6kin7wkU/WmqYnG25onI/AAAAAAAAIbA/54Z9iUfEdmM2_U9JBtD2SoevurGaoIsbACLcBGAs/s400/1.png)](https://3.bp.blogspot.com/-9Fe6kin7wkU/WmqYnG25onI/AAAAAAAAIbA/54Z9iUfEdmM2_U9JBtD2SoevurGaoIsbACLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-ztGHArbq6VQ/WmqZCBvHSJI/AAAAAAAAIbE/sHDYhhNkmMI8LIkdzRjrGt__lGLvjb-ggCLcBGAs/s400/1.png)](https://2.bp.blogspot.com/-ztGHArbq6VQ/WmqZCBvHSJI/AAAAAAAAIbE/sHDYhhNkmMI8LIkdzRjrGt__lGLvjb-ggCLcBGAs/s1600/1.png)</div><div>**Any Order : **上面所選的人員每一個都要核准才會觸發</div><div>
</div><div>**In sequence :&nbsp;**上面所選的人員每一個都要**依序**核准才會觸發</div><div>
</div><div>**Any One Order&nbsp;****&nbsp;:&nbsp;**上面所選的人員**任何一人核准即可**</div><div>
</div><div>
</div><div>如果有卡核准的話，Release不會自動執行，而是看到這個畫面</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-tp3q8i0NZaM/WmqbBeT2hOI/AAAAAAAAIbc/B20xUeyN9YwlKHd7EYOqskqYywkF6SbCACLcBGAs/s400/1.png)](https://2.bp.blogspot.com/-tp3q8i0NZaM/WmqbBeT2hOI/AAAAAAAAIbc/B20xUeyN9YwlKHd7EYOqskqYywkF6SbCACLcBGAs/s1600/1.png)</div><div>點兩下進去後可以核准</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-KP6jYJbXaB4/WmqbqoYwdjI/AAAAAAAAIbo/ASJM3yKXy_8twOKj380r6aoKhzZI3em_QCLcBGAs/s400/1.png)](https://3.bp.blogspot.com/-KP6jYJbXaB4/WmqbqoYwdjI/AAAAAAAAIbo/ASJM3yKXy_8twOKj380r6aoKhzZI3em_QCLcBGAs/s1600/1.png)</div><div>
</div><div>
</div><div>
</div><div>
</div><div>
</div><div>

<h3 id="選擇特定版本佈署"><a href="#選擇特定版本佈署" class="headerlink" title="選擇特定版本佈署"></a>選擇特定版本佈署</h3></div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-Yj3LrhbV4OI/WmqcDGeKk8I/AAAAAAAAIbs/5zJArJ9S2JoeganmsxpN0oOLlnHb9mlpgCLcBGAs/s400/1.png)](https://3.bp.blogspot.com/-Yj3LrhbV4OI/WmqcDGeKk8I/AAAAAAAAIbs/5zJArJ9S2JoeganmsxpN0oOLlnHb9mlpgCLcBGAs/s1600/1.png)</div><div>
</div><div>
</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-SCDaX0YHudE/WmqcPmnMTZI/AAAAAAAAIb0/squNlawHwwgeW54wH2D4ku-wSVQLFrhdgCLcBGAs/s400/1.png)](https://2.bp.blogspot.com/-SCDaX0YHudE/WmqcPmnMTZI/AAAAAAAAIb0/squNlawHwwgeW54wH2D4ku-wSVQLFrhdgCLcBGAs/s1600/1.png)</div><div>
</div><div>
</div><div>
</div>

<h3 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h3><div>以上這邊，之後只要有人簽入程式，CI流程有設定Trigger的話就會自動觸發，CI流程沒問題，CD流程就會接著做，再依據有無卡審核做後續行為。</div><div>
</div><div>每次的執行狀況也都可以清楚看到狀況</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-2UvlMPIFHiA/WmqaGN8VLpI/AAAAAAAAIbQ/C1GftxgAeBIqRCPMuJCNQU39Bu32ILIvQCLcBGAs/s640/1.png)](https://1.bp.blogspot.com/-2UvlMPIFHiA/WmqaGN8VLpI/AAAAAAAAIbQ/C1GftxgAeBIqRCPMuJCNQU39Bu32ILIvQCLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-QXjIEo2-s1M/WmqaX4umkhI/AAAAAAAAIbU/Sg2soTofoawjOVzoZtEC98DLqtFGATFnQCLcBGAs/s640/1.png)](https://2.bp.blogspot.com/-QXjIEo2-s1M/WmqaX4umkhI/AAAAAAAAIbU/Sg2soTofoawjOVzoZtEC98DLqtFGATFnQCLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">
</div><div>下一篇來說如何透過VSTS來執行切換Slot，感覺還有好幾篇可以寫...</div>]]></content>
      <categories>
        <category>VSTS建置CI-CD</category>
      </categories>
      <tags>
        <tag>CI/CD</tag>
        <tag>Azure</tag>
        <tag>VSTS</tag>
      </tags>
  </entry>
  <entry>
    <title>【CI/CD】3. 透過VSTS 切換Azure AppService Slot</title>
    <url>/2018/01/26/%E3%80%90CI-CD%E3%80%913-%E9%80%8F%E9%81%8EVSTS-%E5%88%87%E6%8F%9BAzure-AppService-Slot/</url>
    <content><![CDATA[<div class="note info">
            <p>接續前篇 : <a href="https://toyo0103.blogspot.tw/2018/01/cicd2-vstsazure-appservice.html">【CI/CD】2. 透過VSTS自動佈署程式到Azure AppService</a></p>
          </div>

<p>一般為了服務的順暢，一般都會在正式機的Azure App Service開啟Slot服務</p>
<div class="note info">
            <p>參考 : <a href="https://docs.microsoft.com/zh-tw/azure/app-service/web-sites-staged-publishing">在 Azure App Service 中設定預備環境</a></p>
          </div>

<p>好讓服務更新時，能無痛更新且不會中斷Session。</p>
<p>而上一篇有提到如何更新Azure App Service，但如果在有開啟Slot的情形下，設定要做一些變更。</p>
<h4 id="首先先將設定從佈署正式機改成佈署到Slot"><a href="#首先先將設定從佈署正式機改成佈署到Slot" class="headerlink" title="首先先將設定從佈署正式機改成佈署到Slot"></a><span style="font-weight: normal;">首先先將設定從佈署</span>正式機<span style="font-weight: normal;">改成佈署到</span>Slot</h4><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-8u_M2pW8r6I/Wmq7HICh6mI/AAAAAAAAIcE/XVVdqTZH-houw6m7iXuRw1R1B-QYMuPHgCLcBGAs/s640/1.png)](https://3.bp.blogspot.com/-8u_M2pW8r6I/Wmq7HICh6mI/AAAAAAAAIcE/XVVdqTZH-houw6m7iXuRw1R1B-QYMuPHgCLcBGAs/s1600/1.png)</div><div>
</div><div>勾選Deploy to Slot後，會需要選擇**Resource group**與**Slot**，分別選擇好後存檔。</div><div>
</div><div>
</div>

<h3 id="新增一組切換Slot-的Enviroment"><a href="#新增一組切換Slot-的Enviroment" class="headerlink" title="新增一組切換Slot 的Enviroment"></a><span style="font-weight: normal;">新增一組切換</span>Slot <span style="font-weight: normal;">的</span>Enviroment</h3><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-sDn38p_Mnbw/Wmq8ETA_jDI/AAAAAAAAIcM/H_eI0hPhGIwW-a6rxAwMdWy7O7s5vlCAACLcBGAs/s1600/1.png)](https://4.bp.blogspot.com/-sDn38p_Mnbw/Wmq8ETA_jDI/AAAAAAAAIcM/H_eI0hPhGIwW-a6rxAwMdWy7O7s5vlCAACLcBGAs/s1600/1.png)</div><div>
</div><div>因為我們是希望佈署到Slot後，再決定要不要跟正式機進行交換，所以是按第一組環境的Add而不是Enviroments Add，兩個差異如下</div><div>
</div><div>**Enviroments Add : **同時觸發</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-MeAkdLz3Cr0/Wmq8tNg9y9I/AAAAAAAAIcY/OscSApLOq4U9Fg19E1Ck7ai5RQO6Yi5agCLcBGAs/s400/1.png)](https://3.bp.blogspot.com/-MeAkdLz3Cr0/Wmq8tNg9y9I/AAAAAAAAIcY/OscSApLOq4U9Fg19E1Ck7ai5RQO6Yi5agCLcBGAs/s1600/1.png)</div><div>**
**</div><div>**DeployToStage Add : **依序</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-rgl9IIrg7PM/Wmq9FwxUOPI/AAAAAAAAIcc/X4QXZY09ZqwBjKuO14TeLbQdhBY5ZkfCQCLcBGAs/s400/1.png)](https://3.bp.blogspot.com/-rgl9IIrg7PM/Wmq9FwxUOPI/AAAAAAAAIcc/X4QXZY09ZqwBjKuO14TeLbQdhBY5ZkfCQCLcBGAs/s1600/1.png)</div><div>
</div><div>

<h3 id=""><a href="#" class="headerlink" title=""></a><span style="font-weight: 400;"></h3></span>

<h3 id="設定Swap-Slot"><a href="#設定Swap-Slot" class="headerlink" title="設定Swap Slot"></a><span style="font-weight: 400;">設定</span>Swap Slot</h3></div>

<h4 id="新增Azure-App-Service-Manage"><a href="#新增Azure-App-Service-Manage" class="headerlink" title="新增Azure App Service Manage"></a>新增Azure App Service Manage</h4><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-cu8E1X0iFtc/Wmq9gXARCNI/AAAAAAAAIck/BhcwVvceOyUPJ_1rBx_57fn5zLIbbynDQCLcBGAs/s400/1.png)](https://4.bp.blogspot.com/-cu8E1X0iFtc/Wmq9gXARCNI/AAAAAAAAIck/BhcwVvceOyUPJ_1rBx_57fn5zLIbbynDQCLcBGAs/s1600/1.png)</div><div>
</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-rERunRQExFg/Wmq-YRBwp7I/AAAAAAAAIc0/MxgvqqNAZrIPKSGwPgHfBIEB3DHe7-qswCLcBGAs/s400/1.png)](https://2.bp.blogspot.com/-rERunRQExFg/Wmq-YRBwp7I/AAAAAAAAIc0/MxgvqqNAZrIPKSGwPgHfBIEB3DHe7-qswCLcBGAs/s1600/1.png)</div><div>
</div><div>跟前面的設定基本上都一樣，只要是Action的地方要選擇**Swap Slots**</div><div>**
**</div><div>**
**</div>

<h4 id="加上啟動切換Slot的條件"><a href="#加上啟動切換Slot的條件" class="headerlink" title="加上啟動切換Slot的條件"></a>加上啟動切換Slot的條件</h4><div>正式機加上上述設定後帶來了一些好處</div><div>
</div><div>1.上線時推程式會先進到Slot，先連到Slot測試確定沒問題</div><div>2.讓正式機跟Slot交換，線上服務感受不到中斷，但程式已經更新了</div><div>
</div><div>而我們為了安全起見，在切換Slot前會再加一到人工審核，當核准時才會進行切換</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-NPW1J_euv1g/Wmq_d5ZIgbI/AAAAAAAAIc8/fel0tpckNpY3G9U-Ce-l_7cux4hh69UrgCLcBGAs/s400/1.png)](https://3.bp.blogspot.com/-NPW1J_euv1g/Wmq_d5ZIgbI/AAAAAAAAIc8/fel0tpckNpY3G9U-Ce-l_7cux4hh69UrgCLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-MUxdoYfNdvI/WmrAesUzntI/AAAAAAAAIdI/rprzi_YpU2I3gU8Nf6WvND6lnqbP5f-TwCLcBGAs/s640/1.png)](https://2.bp.blogspot.com/-MUxdoYfNdvI/WmrAesUzntI/AAAAAAAAIdI/rprzi_YpU2I3gU8Nf6WvND6lnqbP5f-TwCLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div>
</div><div>
</div><div>這樣設定後，切換Slot就會需要審核</div><div>
</div><div>
</div><div>第一關審核是佈署到Slot</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-xPtLxwhLiEM/WmrA85Q54II/AAAAAAAAIdM/w5moJRIMBecavQfl60mVPKB6fhLedXgRgCLcBGAs/s400/1.png)](https://2.bp.blogspot.com/-xPtLxwhLiEM/WmrA85Q54II/AAAAAAAAIdM/w5moJRIMBecavQfl60mVPKB6fhLedXgRgCLcBGAs/s1600/1.png)</div><div>
</div><div>第二關審核是將正式機跟Slot切換</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-rZTHXtthOOk/WmrBvam9k3I/AAAAAAAAIdY/yuP69VL0ZlkFPnQ5CWUd8nTImmr4mWBdACLcBGAs/s400/1.png)](https://1.bp.blogspot.com/-rZTHXtthOOk/WmrBvam9k3I/AAAAAAAAIdY/yuP69VL0ZlkFPnQ5CWUd8nTImmr4mWBdACLcBGAs/s1600/1.png)</div><div>
</div><div>
</div><div>
</div><div>
</div><div>
</div><div>下一篇來寫如何在CD階段置換參數值</div>]]></content>
      <categories>
        <category>VSTS建置CI-CD</category>
      </categories>
      <tags>
        <tag>CI/CD</tag>
        <tag>Azure</tag>
        <tag>VSTS</tag>
      </tags>
  </entry>
  <entry>
    <title>【Entity Framework】The connection was not closed. The connection&#39;s current state is connecting</title>
    <url>/2018/07/24/%E3%80%90Entity%20Framework%E3%80%91The_connection_was_not_closed_The_connection_s_current_state_is_connecting/</url>
    <content><![CDATA[<h1 id="前情提要"><a href="#前情提要" class="headerlink" title="#前情提要"></a>#前情提要</h1><p>不定時、不定量、不特定API跳出**【System.InvalidOperationException】  - The connection was not closed. The connection’s current state is connecting.**錯誤，這個錯誤以前公司也遇到過，當時研判是Entity Framework與Unity套件生命週期的問題，當時專案不算太大又一直找不到確切解決方案，所以索性將Repository Layer整個用Dapper改寫讓問題得以解決了。</p>
<div class="note info">
            <p>當時的筆記</p><p><a href="https://toyo0103.github.io/2016/12/19/%E3%80%90EntityFramework%E3%80%91DBContext-Dispose%E8%88%87%E5%90%A6%EF%BC%8C%E8%88%87DB%E7%9A%84%E9%80%A3%E7%B7%9A%E6%95%B8%E6%98%AF%E5%90%A6%E6%9C%89%E9%97%9C%E4%BF%82/">【Entity Framework】DBContext Dispose與否，與DB的連線數是否有關係</a></p>
          </div>



<p>但這次退無可退，再次印證了一句話</p>
<blockquote class="blockquote-center">
            <i class="fa fa-quote-left"></i>
            <p>你不解決問題，問題就會解決你</p>

            <i class="fa fa-quote-right"></i>
          </blockquote>

<p>&nbsp; &nbsp;  </p>
<h1 id="分析"><a href="#分析" class="headerlink" title="#分析"></a>#分析</h1><p>透過Elmah的Log分析，發現共同點都壞在一支Token驗證的DelegatingHandler裡面，因為呼叫每支API都會經過這，可以解釋為何壞在不特定API。</p>
<p>而關鍵在其中的一行</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> Service = AutofacConfig.Container.Resolve&lt;ISupplierApiProfileService&gt;();</span><br><span class="line"><span class="keyword">var</span> Profile = Service.GetSupplierApiProfileByToken(token);</span><br></pre></td></tr></table></figure>

<p>透過Autofac Container取得ISupplierApiProfileService，猜測當時這樣撰寫是希望每次產生新的Service的實體來使用，在這之前先一下看一下整體的架構</p>
<p><img src="/images/20180724/1.gif" alt="/images/20180724/1.gif"></p>
<p>而每個實體分別Autofac註冊的生命週期為</p>
<p><img src="/images/20180724/2.jpg" alt="/images/20180724/2.jpg"></p>
<p>這導致了一個結果，因為Actofac Container為Singleton的實體，透過他Resolve出來的DBContext (<strong>InstancePerLifetimeScope</strong>)也會變成Singleton的生命週期。</p>
<p>而Entity Framework非Thread Safe的設計，所以如果不同Thread共用同一個DBContext時，如果前一個交易尚未完成，撞在一起時就會有機率產生這個錯誤</p>
<p><img src="/images/20180724/3.jpg" alt="/images/20180724/3.jpg"></p>
<div class="note info">
            <p>相關討論 </p><p><a href="https://github.com/aspnet/EntityFrameworkCore/issues/3887">https://github.com/aspnet/EntityFrameworkCore/issues/3887</a></p>
          </div>



<h1 id="解法"><a href="#解法" class="headerlink" title="#解法"></a>#解法</h1><p>而DBContext會設定為<strong>InstancePerLifetimeScope</strong>的生命週期是希望DBContext隨著每次Request產生與消滅(亦即每個Request只會產生一次DBContext實體)，如果後續應用Transaction才不會發生問題，但在DelegatingHandler這邊的應用情境卻導致了Singleton的情況。</p>
<h2 id="BeginLifetimeScope"><a href="#BeginLifetimeScope" class="headerlink" title="BeginLifetimeScope"></a>BeginLifetimeScope</h2><div class="note info">
            <p>官方文件 - <a href="https://autofaccn.readthedocs.io/en/latest/lifetime/working-with-scopes.html">Working with Lifetime Scopes</a></p>
          </div>

<p>Autofac提供給使用者產生一個動態的生命週期的方法，所有透過這個生命週期產生的實體會隨著它的消滅一併被Disposed掉，使用方式如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> scope = AutofacConfig.Container.BeginLifetimeScope())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> Service = scope.Resolve&lt;ISupplierApiProfileService&gt;();</span><br><span class="line">    <span class="keyword">var</span> Profile = Service.GetSupplierApiProfileByToken(token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>這樣可以確保在DelegatingHandler裡面產生的DBContext不會變成Singleton，也不用動到最基底DBContext <strong>InstancePerLifetimeScope</strong>的生命週期，確保了每次Request共用同一個DBContext。</p>
<p>上線後觀察Elmah，確認這個伴隨著我將近三年的問題終於徹底消滅了，可喜可賀 可喜可賀。</p>
]]></content>
      <tags>
        <tag>Entity Framework</tag>
        <tag>AutoFac</tag>
      </tags>
  </entry>
  <entry>
    <title>【FluentAssertions】如何驗證巢狀結構中，Double倍精準數</title>
    <url>/2016/08/05/%E3%80%90FluentAssertions%E3%80%91%E5%A6%82%E4%BD%95%E9%A9%97%E8%AD%89%E5%B7%A2%E7%8B%80%E7%B5%90%E6%A7%8B%E4%B8%AD%EF%BC%8CDouble%E5%80%8D%E7%B2%BE%E6%BA%96%E6%95%B8/</url>
    <content><![CDATA[<p>寫單元測試的時候常常會使用<a href="http://www.fluentassertions.com/">FluentAssertions</a>這個套件來做驗證，即便兩個巢狀結構的類別透過這個套件也能輕鬆解決比對問題。</p>
<p>但最近碰到當重狀結構裡面有Double這類的趨近值數值時，驗證會失敗，查了一下後找到解法，所以紀錄一下</p>
<p>原本UnitTest程式長這樣</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Test_DoubleAssert</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> stops = <span class="keyword">new</span> List&lt;BusStopAPIResult&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> BusStopAPIResult</span><br><span class="line">                &#123;</span><br><span class="line">                    StopName = <span class="keyword">new</span> NameAPIResult</span><br><span class="line">                    &#123;</span><br><span class="line">                        Zh_tw = <span class="string">&quot;吊橋頭&quot;</span>,</span><br><span class="line">                        En = <span class="string">&quot;deocioutao&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    StopUID = <span class="string">&quot;StopUID1&quot;</span>,</span><br><span class="line">                    StopPosition = <span class="keyword">new</span> BusStopAPIResult.Coordinate</span><br><span class="line">                    &#123;</span><br><span class="line">                        PositionLat = <span class="number">24.853690</span>,</span><br><span class="line">                        PositionLon = <span class="number">121.354917</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="keyword">new</span> BusStopAPIResult</span><br><span class="line">                &#123;</span><br><span class="line">                    StopName = <span class="keyword">new</span> NameAPIResult</span><br><span class="line">                    &#123;</span><br><span class="line">                        Zh_tw = <span class="string">&quot;吊橋頭&quot;</span>,</span><br><span class="line">                        En = <span class="string">&quot;deocioutao&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    StopUID = <span class="string">&quot;StopUID2&quot;</span>,</span><br><span class="line">                    StopPosition = <span class="keyword">new</span> BusStopAPIResult.Coordinate</span><br><span class="line">                    &#123;</span><br><span class="line">                        PositionLat = <span class="number">24.853632</span>,</span><br><span class="line">                        PositionLon = <span class="number">121.354874</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> expected = <span class="keyword">new</span> List&lt;BusStopClusterDTO&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> BusStopClusterDTO</span><br><span class="line">                &#123;</span><br><span class="line">                    Name = <span class="string">&quot;吊橋頭&quot;</span>,</span><br><span class="line">                    SourceID = <span class="string">&quot;StopUID1&quot;</span>,</span><br><span class="line">                    IDs = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt; &#123; <span class="string">&quot;StopUID1&quot;</span> , <span class="string">&quot;StopUID2&quot;</span> &#125;,</span><br><span class="line">                    Lat = <span class="number">24.853661</span>,</span><br><span class="line">                    Lng = <span class="number">121.3548955</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Program.ClusterSourceData(stops);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            actual.ShouldBeEquivalentTo(expected);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>執行結果如圖</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-LvpAUuEAqzk/V6P6OrTaInI/AAAAAAAAH3U/37TPKUzXfAI0KKdMpNDAJCpcvBrZXZH2gCLcB/s640/1.png)](https://2.bp.blogspot.com/-LvpAUuEAqzk/V6P6OrTaInI/AAAAAAAAH3U/37TPKUzXfAI0KKdMpNDAJCpcvBrZXZH2gCLcB/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-xi043e38HW0/V6P6m4ED9_I/AAAAAAAAH3Y/T29FHNHT7h4Y51M1RTmwb1dnZJm-wMLMQCLcB/s320/1.png)](https://2.bp.blogspot.com/-xi043e38HW0/V6P6m4ED9_I/AAAAAAAAH3Y/T29FHNHT7h4Y51M1RTmwb1dnZJm-wMLMQCLcB/s1600/1.png)</div>

<p>因為數值是經緯度，經過計算後不需要驗證精確到小數點這麼多位數，所以可以改用以下方法去驗證</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">actual.ShouldBeEquivalentTo(</span><br><span class="line">               expected,</span><br><span class="line">               <span class="comment">//當欄位型別為Double時，相差到0.000001之內都是OK的</span></span><br><span class="line">               option =&gt; option.Using&lt;<span class="built_in">double</span>&gt;(</span><br><span class="line">                           ctx =&gt; ctx.Subject.Should().BeApproximately(ctx.Expectation, <span class="number">0.000001</span>))</span><br><span class="line">                       .WhenTypeIs&lt;<span class="built_in">double</span>&gt;());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這樣驗證就會過關了!!</p>
]]></content>
      <tags>
        <tag>Unit Test</tag>
        <tag>FluentAssertions</tag>
      </tags>
  </entry>
  <entry>
    <title>【EntityFramework】DBContext Dispose與否，與DB的連線數是否有關係</title>
    <url>/2016/12/19/%E3%80%90EntityFramework%E3%80%91DBContext-Dispose%E8%88%87%E5%90%A6%EF%BC%8C%E8%88%87DB%E7%9A%84%E9%80%A3%E7%B7%9A%E6%95%B8%E6%98%AF%E5%90%A6%E6%9C%89%E9%97%9C%E4%BF%82/</url>
    <content><![CDATA[<p><strong>案情簡介:</strong></p>
<p>手邊有一個中大型專案，最近Web版上線後，時不時會收到資料庫連線異常相關錯誤，不定時不定量，沒有特定會掛在哪支API，完全沒有邏輯可以歸納。</p>
<p>該Database Layer的ORM使用Entity Framwork(後面簡稱 EF)做為與DB溝通的橋樑，DBContext採用Singleton的方式，每個Request進來，不管跟DB溝通幾次都只會建造一次Context實體，Request結束後Dispose掉。</p>
<p><strong>心中的想像:</strong><br>以前寫ADO.NET自己控制連線，都聽前輩說一定要自己Close連線，不然很可能會把連線的Pool占滿，所以寫EF時習慣也都會加上Using</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> (<span class="keyword">var</span> DbContext = <span class="keyword">new</span> NorthwindEntities())</span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">//Do Something</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而且自己覺得每次Dispose應該都會關閉該次連線，<span style="color: red;">註1</span><strike>每次New Context都會建立新的連線</strike>，一切井然有序好不快樂，直到這個短時間會有大量的Request湧進來的服務上線後，一切都變調，時不時就會接到使用單位來詢問API不定時中斷問題，想破頭還是找不到問題在哪….</p>
<p><strong>驗證:</strong><br>**<br>**從外天空找到行天宮，最後發現最可能的原因是出在EF底層的運作，根據許多篇國外的文章指出，EF是自己控制連線，並不會依照你Dispose或是New Instance就關閉跟建立新連線，所以我特地寫一個範例立馬來實驗一下</p>
<p>首先寫一個ADO.NET版本，並且刻意不要寫SqlConnection . Close()，觀察SQL Connection Pool的狀況</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  SqlConnection conn = <span class="keyword">new</span> SqlConnection(<span class="keyword">this</span>.Connection.ConnectionString);</span><br><span class="line">  conn.Open();</span><br><span class="line">  SqlCommand command = <span class="keyword">new</span> SqlCommand(<span class="string">&quot;select top 1 CustomerID from Customers&quot;</span>, conn);</span><br><span class="line">  <span class="keyword">var</span> Result = command.ExecuteScalar().ToString();</span><br><span class="line">  Result.Dump();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>資料庫那邊用以下語法查詢目前連線DB得使用者與狀態</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sys.sysprocesses <span class="keyword">where</span> status <span class="operator">=</span> <span class="string">&#x27;sleeping&#x27;</span> <span class="keyword">and</span> spid <span class="operator">&gt;</span> <span class="number">50</span> <span class="keyword">order</span> <span class="keyword">by</span> login_time <span class="keyword">desc</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>實驗結果發現Pool立馬從4個暴增到14個</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-oEdNrW43zrg/WFj8I-X22EI/AAAAAAAAICY/hGYoeCGf7F0wxC4D-pLB5-ILQmOBQ7ASgCLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://1.bp.blogspot.com/-oEdNrW43zrg/WFj8I-X22EI/AAAAAAAAICY/hGYoeCGf7F0wxC4D-pLB5-ILQmOBQ7ASgCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-4UVQhQQHP_I/WFj74WVDqsI/AAAAAAAAICU/N8MWSU17kiIm9CoqwaOoJYGorDof8BBHQCLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://3.bp.blogspot.com/-4UVQhQQHP_I/WFj74WVDqsI/AAAAAAAAICU/N8MWSU17kiIm9CoqwaOoJYGorDof8BBHQCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p>接著寫測是第二個版本，有呼叫Close()看看結果</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  SqlConnection conn = <span class="keyword">new</span> SqlConnection(<span class="keyword">this</span>.Connection.ConnectionString);</span><br><span class="line">  conn.Open();</span><br><span class="line">  SqlCommand command = <span class="keyword">new</span> SqlCommand(<span class="string">&quot;select top 1 CustomerID from Customers&quot;</span>, conn);</span><br><span class="line">  <span class="keyword">var</span> Result = command.ExecuteScalar().ToString();</span><br><span class="line">  Result.Dump();</span><br><span class="line">  conn.Close(); <span class="comment">//有呼叫Close</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>Pool裡面的閒置Connection數明顯下降，所以有沒有呼叫Close是有差別的，如果有Close的話，會有放掉Connection進而重用閒置的連線</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-n5iNtVFfa1A/WFj8v__0zPI/AAAAAAAAICg/pv_Yn0Yh3REK0G3quPsd2Q_TwuOOLmNqACLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://3.bp.blogspot.com/-n5iNtVFfa1A/WFj8v__0zPI/AAAAAAAAICg/pv_Yn0Yh3REK0G3quPsd2Q_TwuOOLmNqACLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p>接著來看看EF的版本，首先測試沒有呼叫Dispose()，且每次Create新的DBContext。(我是用LinqPad測試，所以建立DBContext的地方語法有點不一樣，但不影響結果)</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">var</span> context = <span class="keyword">new</span> TypedDataContext();</span><br><span class="line">  context.Customers.FirstOrDefault().CustomerID.Dump();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>結果看起來連線數也是會自己重用</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-9dcCNkudzVU/WFj-FcO1zEI/AAAAAAAAICw/u6OqldT3IboAR-5UjsFll0DK4bPdF0FwQCLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://1.bp.blogspot.com/-9dcCNkudzVU/WFj-FcO1zEI/AAAAAAAAICw/u6OqldT3IboAR-5UjsFll0DK4bPdF0FwQCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p>既然EF會自己控制連線，那是否用Using來Dispose與否也沒差，連線並不會無限制增加?<br>所以我把程式改成這樣再跑一次</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++)</span><br><span class="line"> &#123;</span><br><span class="line">    <span class="keyword">using</span> (<span class="keyword">var</span> context = <span class="keyword">new</span> TypedDataContext())</span><br><span class="line">    &#123;</span><br><span class="line">        context.Customers.FirstOrDefault().CustomerID.Dump();</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-ueHmNj18HlA/WFj-9VzgvXI/AAAAAAAAIC4/W9-U8j0R3IEaHodcAc1lSR3WkA34LstAgCLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://3.bp.blogspot.com/-ueHmNj18HlA/WFj-9VzgvXI/AAAAAAAAIC4/W9-U8j0R3IEaHodcAc1lSR3WkA34LstAgCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p>結果顯示，一模一樣的情況，所以EF的確有自己在控制網路連線這一環，與你Dispose無關，也驗證了這篇文章所說的「 <a href="http://blog.jongallant.com/2012/10/do-i-have-to-call-dispose-on-dbcontext.html">Do I always have to call Dispose() on my DbContext objects? Nope</a>」</p>
<p>**<br>**<strong>解決方案 :&nbsp;</strong></p>
<p>依照上面的時間結果觀察，EF的確有自己在控制連線狀態這件事情，而他什麼時候呼叫Close我並不知道，且還套用了Singleton Pattern，這樣交互影響下不確定是不是導致上述發生的結果，所以我把EF整個拿掉，整個Database Layer用Dapper翻寫，每次連線都自己控制，不再使用EF，上線後至今已經一個禮拜，不再出現任何資料庫連線錯誤。</p>
<p>雖然不敢保證中間推斷的是否百分之百正確，因為如果要更確定，應該要追到EF的底層Code來看他究竟是怎麼寫的，或許觀念大致相同，但是可能會跟我論述的有落差，但的確可以把問題收斂到是EF這個區塊的問題，因為改用Dapper就沒事了。</p>
<p>這個問題整整困擾了將近一年的時間，我想在徹底研究出EF該怎麼解決這個問題之前，大型服務我應該都會暫時放棄這條路了，雖然EF真的很方便阿!!!(吶喊~)</p>
<p><span style="color: red;">註1:</span><br>依照DB Connection Pool的概念，如果有呼叫SqlConnection Close的話，會將Connection釋放到Pool，等到下次有連線時，會優先檢查Pool是否有閒置的可以使用，沒有才會建立新的。<br>參考: <a href="https://msdn.microsoft.com/zh-tw/library/system.data.sqlclient.sqlconnection.close(v=vs.110).aspx">MSDN - SqlConnection.Close 方法 ()</a></p>
<h4 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a><strong>參考文章</strong></h4><div>1.&nbsp;[在 SQL Server 發現大量在 Sleeping 的連線](https://blogs.msdn.microsoft.com/jchiou/2012/12/10/sql-server-sleeping/)

</div>]]></content>
      <tags>
        <tag>Entity Framework</tag>
      </tags>
  </entry>
  <entry>
    <title>【JQuery】為動態新增的Elements綁定事件 -- jQuery .on()</title>
    <url>/2013/04/29/%E3%80%90JQuery%E3%80%91%E7%82%BA%E5%8B%95%E6%85%8B%E6%96%B0%E5%A2%9E%E7%9A%84Elements%E7%B6%81%E5%AE%9A%E4%BA%8B%E4%BB%B6-jQuery-on/</url>
    <content><![CDATA[<p>按下新增按鈕後，利用JQuery動態新增一個填寫欄位跟兩個按鈕</p>
<p><a href="http://2.bp.blogspot.com/-MkKh6MsfaM4/UX31TyroisI/AAAAAAAACqs/IFEjiWTny0s/s1600/1.png"><img src="http://2.bp.blogspot.com/-MkKh6MsfaM4/UX31TyroisI/AAAAAAAACqs/IFEjiWTny0s/s1600/1.png"></a><br>其中取消的按鈕ID為addCancel，我想替它增加click事件按下後彈跳一則簡短的訊息<br>原本的寫法如下：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$(<span class="string">&#x27;#addCancel&#x27;</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">   alert(<span class="string">&#x27;Click事件沒有問題&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>但Click事件始終沒有效果，原來動態新增的elements要綁定事件需要用**.on**的方式</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$(<span class="string">&#x27;body&#x27;</span>).on(<span class="string">&quot;click&quot;</span>, <span class="string">&#x27;#addCancel&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    alert(<span class="string">&#x27;用on綁定就沒有問題!!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a href="http://3.bp.blogspot.com/-ig6RzcQGtj4/UX30ttpbCII/AAAAAAAACqg/nWulStFehMg/s1600/1.png"><img src="http://3.bp.blogspot.com/-ig6RzcQGtj4/UX30ttpbCII/AAAAAAAACqg/nWulStFehMg/s1600/1.png"></a></p>
]]></content>
      <tags>
        <tag>JQuery</tag>
      </tags>
  </entry>
  <entry>
    <title>【CI/CD】4. 在佈署階段置換參數值，以Web.Config為例</title>
    <url>/2018/01/26/%E3%80%90CI-CD%E3%80%914-%E5%9C%A8%E4%BD%88%E7%BD%B2%E9%9A%8E%E6%AE%B5%E7%BD%AE%E6%8F%9B%E5%8F%83%E6%95%B8%E5%80%BC%EF%BC%8C%E4%BB%A5Web-Config%E7%82%BA%E4%BE%8B/</url>
    <content><![CDATA[<div class="note info">
            <p>接續前篇 : <a href="https://toyo0103.blogspot.tw/2018/01/cicd3-vsts-azure-appservice-slot.html">【CI/CD】3. 透過VSTS 切換Azure AppService Slot</a></p>
          </div>

<p>如果你的佈署狀況如下</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-uiFFGMOOPlQ/WmraN8BbjEI/AAAAAAAAIdo/xzVVbXd5NLkz4xpa1wI-gTNN048M5R7ngCLcBGAs/s640/1.png)](https://3.bp.blogspot.com/-uiFFGMOOPlQ/WmraN8BbjEI/AAAAAAAAIdo/xzVVbXd5NLkz4xpa1wI-gTNN048M5R7ngCLcBGAs/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">原諒我只繪畫醜圖....</td></tr></tbody></table>
有一次更版進到到Master Branch，而CI設定Trigger是Master更動時自動建置，CD接收到CI建置完成後執行佈署機器，而每台機器的Web.Config值都有差異，這時候該怎麼做?

<h1 id="XML-variable-substitution"><a href="#XML-variable-substitution" class="headerlink" title="#XML variable substitution"></a>#XML variable substitution</h1><p>Azure App Service Deploy有提供XML variable substitutuin可以選擇</p>
<div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-LN_4j9iX9As/WmrfdZWF3oI/AAAAAAAAId4/Tc9U1W24Lq45Ms0p9qhtBLNX2EJ8sKJ_QCLcBGAs/s640/1.png)](https://4.bp.blogspot.com/-LN_4j9iX9As/WmrfdZWF3oI/AAAAAAAAId4/Tc9U1W24Lq45Ms0p9qhtBLNX2EJ8sKJ_QCLcBGAs/s1600/1.png)</div>
<div class="note info">
            <p>依據註解中說明就是，當這個選項勾選時，他會自動去找專案中的所有.Config檔案，檔案中的appSettings，application Settings , connectionString區塊，如果有Key或Name與設定的變數相同時自動置換，且是發生在Config transforms之後</p>
          </div>


<p>什麼意思呢? 直接看範例，如果我們的Web.Config裡面長這樣</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-iEfgD967KZc/WmriR-qREbI/AAAAAAAAIeE/P_zG3I8Ah3EPMA4uADVKwh8LqCImdKpjACLcBGAs/s400/1.png)](https://1.bp.blogspot.com/-iEfgD967KZc/WmriR-qREbI/AAAAAAAAIeE/P_zG3I8Ah3EPMA4uADVKwh8LqCImdKpjACLcBGAs/s1600/1.png)</div>
那他就會在去比對appSettings、connectionString區塊，裡面的Name或是Key有對應到變數設定的話，Value值會自動被替換，而變數設定又在哪邊呢?

<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-bJ9GV3qzx1A/WmrjTH_HnSI/AAAAAAAAIeM/XMf0yAL-XBsfedMAXLy7jbkiS5RcfRViwCLcBGAs/s400/1.png)](https://2.bp.blogspot.com/-bJ9GV3qzx1A/WmrjTH_HnSI/AAAAAAAAIeM/XMf0yAL-XBsfedMAXLy7jbkiS5RcfRViwCLcBGAs/s1600/1.png)</div>

<p>以上面兩張圖來說，那他在WebDeploy到Azure App Service之前就會將我的<strong>StaticDomains、Domain</strong>的<strong>Value</strong>換掉，因為我們在變數檔案裡面有設定。</p>
<p>這樣我們就能透過建置多個環境的方式，在每個環境中設定好對應的變數值，只要執行一次CI流程，觸發多個CD流程，達到多台同時佈署的目的</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-Vn7jrg9S6zM/WmrkbLQL9JI/AAAAAAAAIeY/DSoCnAGpUUA_-3oKJhbPD6sj9bdNQ0DPQCLcBGAs/s400/1.png)](https://2.bp.blogspot.com/-Vn7jrg9S6zM/WmrkbLQL9JI/AAAAAAAAIeY/DSoCnAGpUUA_-3oKJhbPD6sj9bdNQ0DPQCLcBGAs/s1600/1.png)</div>

<h1 id="參數不在appSettings，application-Settings-connectionString區塊之中"><a href="#參數不在appSettings，application-Settings-connectionString區塊之中" class="headerlink" title="#參數不在appSettings，application Settings , connectionString區塊之中"></a>#參數不在appSettings，application Settings , connectionString區塊之中</h1><p>這邊特別注意，剛剛那種置換的值方法僅適用於上述區塊之中，換句話說，如果我們有環境設定變數，但他又不在這幾個區塊之中，該如何做?</p>
<h2 id="Parameter-xml"><a href="#Parameter-xml" class="headerlink" title="Parameter.xml"></a>Parameter.xml</h2><p>還好微軟有提供另一種方式能處理這個問題，就是透過Parameters.xml</p>
<h2 id="建立parameters-xml"><a href="#建立parameters-xml" class="headerlink" title="建立parameters.xml"></a>建立parameters.xml</h2><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-DIAJpQ2tUYk/WmrlsIo55sI/AAAAAAAAIeg/PCaPpM04JucMUYC8QFByvv4X3pPcRwjJgCLcBGAs/s320/1.png)](https://4.bp.blogspot.com/-DIAJpQ2tUYk/WmrlsIo55sI/AAAAAAAAIeg/PCaPpM04JucMUYC8QFByvv4X3pPcRwjJgCLcBGAs/s1600/1.png)</div><div>
</div>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parameters</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parameter</span> <span class="attr">name</span>=<span class="string">&quot;ExceptionlessAPIKey&quot;</span> <span class="attr">defaultValue</span>=<span class="string">&quot;#&#123;ExceptionlessAPIKey&#125;#&quot;</span> &gt;</span></span><br><span class="line">  &lt;parameterEntry</span><br><span class="line">      kind=&quot;XmlFile&quot;</span><br><span class="line">      scope=&quot;Web\.config&quot;</span><br><span class="line">      match=&quot;//exceptionless/@apiKey&quot; /&gt;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parameter</span> <span class="attr">name</span>=<span class="string">&quot;SessionConnectionString&quot;</span> <span class="attr">defaultValue</span>=<span class="string">&quot;#&#123;SessionConnectionString&#125;#&quot;</span> &gt;</span></span><br><span class="line">    &lt;parameterEntry</span><br><span class="line">      kind=&quot;XmlFile&quot;</span><br><span class="line">      scope=&quot;Web\.config&quot;</span><br><span class="line">      match=&quot;//configuration/system.web/sessionState/@sqlConnectionString&quot; /&gt;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parameters</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Name</strong> : 變數名稱<br><strong>Scope</strong> : 受影響的檔案為和，你可以設定整個專案底下全部的.Config也行<br><strong>Match</strong> : 在這些檔案底下如何尋找要被替換的值</p>
<div class="note info">
            <p>Example 1 :  Web.Config底下從根結點開始找起，找到一個叫做exceptionLess的Tag，然後把apiKey這個屬性換成我設定的值</p><p>Example 2 :  Web.Config底下從根結點開始找起，找到configuration底下的system.web底下的sessionState Tag，然後把sqlConnectionString這個屬性換成我設定的值</p>
          </div>

<p><strong>DefaultValue</strong> : 如果在佈署時沒有設定參數值時，預設給的Value</p>
<p>接著在VisualStudio按發行後應該會看到檔案長出<strong>SetParameters.xml</strong></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-s_s3aU7dr74/WmrsRb8ETdI/AAAAAAAAIew/WYlqsjbIk0oj7ow-GOqheH4FJY6QZAUHgCLcBGAs/s640/1.png)](https://3.bp.blogspot.com/-s_s3aU7dr74/WmrsRb8ETdI/AAAAAAAAIew/WYlqsjbIk0oj7ow-GOqheH4FJY6QZAUHgCLcBGAs/s1600/1.png)</div>

<p>打開來會看到</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-viIUyylwlDg/Wmr6qYwZv-I/AAAAAAAAIgE/C0ISadjZIigW7FQ6sMezcjZwYudaEaLrwCLcBGAs/s640/1.png)](https://1.bp.blogspot.com/-viIUyylwlDg/Wmr6qYwZv-I/AAAAAAAAIgE/C0ISadjZIigW7FQ6sMezcjZwYudaEaLrwCLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div>

<p>到這邊我們已經成功將Web.Config的指定位置挖成變數值，等等在CD階段，我們就是要想辦法把<strong>SetParameters.xml</strong>的Value值換掉</p>
<h2 id="回到CD設定介面"><a href="#回到CD設定介面" class="headerlink" title="回到CD設定介面"></a>回到CD設定介面</h2><p>告訴<strong>Azure App Service Deploy Task</strong>，你有<strong>SetParameters.xml</strong></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-NUpiKPxhPRY/Wmrtx-vh_HI/AAAAAAAAIfE/RRml5NRckGQ6S4uDWJJsfSHhX2H7CWEBgCLcBGAs/s640/1.png)](https://4.bp.blogspot.com/-NUpiKPxhPRY/Wmrtx-vh_HI/AAAAAAAAIfE/RRml5NRckGQ6S4uDWJJsfSHhX2H7CWEBgCLcBGAs/s1600/1.png)</div>

<h2 id="安裝Replace-Token-Task"><a href="#安裝Replace-Token-Task" class="headerlink" title="安裝Replace Token Task"></a>安裝Replace Token Task</h2><div>為了置換掉SetParameters.xml裡面的值，必須幫我們VSTS安裝套件</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-Kq1PpE97VYE/WmruR4NMthI/AAAAAAAAIfM/Vu2lwFOUsx4Npju7imY-kYBuW3Frt1exACLcBGAs/s400/1.png)](https://1.bp.blogspot.com/-Kq1PpE97VYE/WmruR4NMthI/AAAAAAAAIfM/Vu2lwFOUsx4Npju7imY-kYBuW3Frt1exACLcBGAs/s1600/1.png)</div><div>
</div><div>安裝連結 :&nbsp; [Replace Token MarketPlace&nbsp;](https://marketplace.visualstudio.com/items?itemName=qetza.replacetokens)</div>

<p>在<strong>Azure App Service Deploy</strong>之前加上<strong>Replace Token Task</strong></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-jDdk2Q7Mj7I/Wmru-f9N1fI/AAAAAAAAIfU/y2x-uJAWD8wQSwaij7_B6TyOS7T2RmMzQCLcBGAs/s640/1.png)](https://2.bp.blogspot.com/-jDdk2Q7Mj7I/Wmru-f9N1fI/AAAAAAAAIfU/y2x-uJAWD8wQSwaij7_B6TyOS7T2RmMzQCLcBGAs/s1600/1.png)</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-mTQYjeZIYho/WmrvSLWq_lI/AAAAAAAAIfY/hWpXjtyZkzMf40oTRqx4cfaWoSxvNQ5XgCLcBGAs/s640/1.png)](https://3.bp.blogspot.com/-mTQYjeZIYho/WmrvSLWq_lI/AAAAAAAAIfY/hWpXjtyZkzMf40oTRqx4cfaWoSxvNQ5XgCLcBGAs/s1600/1.png)</div><div>
</div>

<h2 id="設定"><a href="#設定" class="headerlink" title="設定"></a>設定</h2><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-j-77BDvLK7A/WmrxsFTAD8I/AAAAAAAAIfo/4PIBYR3ck7Uc0DSDfUcTbjs4bAA2CzM-ACLcBGAs/s640/1.png)](https://4.bp.blogspot.com/-j-77BDvLK7A/WmrxsFTAD8I/AAAAAAAAIfo/4PIBYR3ck7Uc0DSDfUcTbjs4bAA2CzM-ACLcBGAs/s1600/1.png)</div>
**Root Directory : **要替換的目標檔案Root資料夾位置
**Target files : **告訴它我們要找的檔案是誰，以這邊來說就是SetParameters.xml
**Token prefix、Token suffix : **比對什麼是它要幫我們置換的，而這邊就是#{xxxx}#包起來的就是參數

<p>這樣設定完之後，它就會在WebDeploy之前執行<strong>Replace Token Task</strong>，而這個Task會去找到SetParameters.xml，然後找到#{xxx}#符號的，然後用我們之前設定在<strong>Variables</strong>的參數置換掉</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-rvxpn3Nkvrw/WmrzQb7-SUI/AAAAAAAAIf0/fMBjj3gSnYwGvbR50p7UZcQQwvGUf5MNgCLcBGAs/s640/1.png)](https://2.bp.blogspot.com/-rvxpn3Nkvrw/WmrzQb7-SUI/AAAAAAAAIf0/fMBjj3gSnYwGvbR50p7UZcQQwvGUf5MNgCLcBGAs/s1600/1.png)</div><div>
</div>

<div class="note info">
            <p>**參考文章 **</p><p><a href="http://andrew.lansdowne.me/2016/12/15/using-environment-variables-for-configuration-with-vsts-build-and-release/">Using environment variables for configuration with VSTS build and release</a></p><p><a href="http://cobus.io/devops/2016/02/06/Parameterizing_Webconfig.html">Parameterizing Web.config</a></p><p><a href="https://blogs.iis.net/elliotth/web-deploy-xml-file-parameterization">Web Deploy XML File Parameterization</a></p><p><a href="http://jakeydocs.readthedocs.io/en/latest/publishing/vsts-continuous-deployment.html">Use VSTS to Build and Publish to an Azure Web App with Continuous Deployment</a></p><p><a href="http://blog.ehn.nu/2016/03/using-web-deploy-in-visual-studio-team-services-release-management/">Using Web Deploy in Visual Studio Team Services Release Management</a></p><p><a href="https://docs.microsoft.com/en-us/vsts/build-release/tasks/transforms-variable-substitution">File transforms and variable substitution reference</a></p>
          </div>]]></content>
      <categories>
        <category>VSTS建置CI-CD</category>
      </categories>
      <tags>
        <tag>CI/CD</tag>
        <tag>Azure</tag>
        <tag>VSTS</tag>
      </tags>
  </entry>
  <entry>
    <title>【FluentValidation】與MVC 5綁定Model Validation</title>
    <url>/2017/03/29/%E3%80%90FluentValidation%E3%80%91%E8%88%87MVC-5%E7%B6%81%E5%AE%9AModel-Validation/</url>
    <content><![CDATA[<p>MVC很早就提供Model Validation的驗證方式，只要在Parameter Class的Property加上限制</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Movie</span> &#123;</span><br><span class="line">    [<span class="meta">Required</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">DataType(DataType.Date)</span>]</span><br><span class="line">    <span class="keyword">public</span> DateTime ReleaseDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">Range(1, 100)</span>]</span><br><span class="line">    [<span class="meta">DataType(DataType.Currency)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">decimal</span> Price &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">StringLength(5)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Rating &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接著在Action之中使用ModelState.IsValid即可驗證參數是否符合規定</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">HttpPost</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Create</span>(<span class="params">Movie movie</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (ModelState.IsValid)</span><br><span class="line">    &#123;</span><br><span class="line">        db.Movies.Add(movie);</span><br><span class="line">        db.SaveChanges();</span><br><span class="line">        <span class="keyword">return</span> RedirectToAction(<span class="string">&quot;Index&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> View(movie);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>最近比較習慣使用FluentValidation，剛好它也在MVC5上設定一下，就可以用ModelState.IsValid來得知參數驗證是否成功，以下紀錄實作方法</p>
<p>1.首先在MVC專案中安裝FluentValidation.MVC5</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-OYlSu6hpFFQ/WNsigw1fSyI/AAAAAAAAIF4/pO02UtoeK5g1ipJT0T6Z6JLb_8a5PkjCwCLcB/s1600/1.png)](https://2.bp.blogspot.com/-OYlSu6hpFFQ/WNsigw1fSyI/AAAAAAAAIF4/pO02UtoeK5g1ipJT0T6Z6JLb_8a5PkjCwCLcB/s1600/1.png)</div>
2.接著在Global &nbsp;Application_Start加上
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">FluentValidationModelValidatorProvider.Configure();</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>3.準備一個要驗證的參數類別</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WantValidateParameter</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">string</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>4.跟前幾天提到的文章一樣，寫對應的驗證方法</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ParameterValidator</span> :<span class="title">AbstractValidator</span>&lt;<span class="title">WantValidateParameter</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">ParameterValidator</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>   &#123;</span><br><span class="line">      <span class="keyword">this</span>.RuleFor(x =&gt; x.ID)</span><br><span class="line">      .NotNull()</span><br><span class="line">      .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">      .WithMessage(<span class="string">&quot;ID不能為Null&quot;</span>)</span><br><span class="line">      .NotEmpty()</span><br><span class="line">      .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">      .WithMessage(<span class="string">&quot;ID不能為空字串&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.RuleFor(x =&gt; x.Name)</span><br><span class="line">      .NotNull()</span><br><span class="line">      .WithErrorCode(<span class="string">&quot;401&quot;</span>)</span><br><span class="line">      .WithMessage(<span class="string">&quot;Name不能為Null&quot;</span>)</span><br><span class="line">      .NotEmpty()</span><br><span class="line">      .WithErrorCode(<span class="string">&quot;401&quot;</span>)</span><br><span class="line">      .WithMessage(<span class="string">&quot;Name不能為空字串&quot;</span>)</span><br><span class="line">      .Length(<span class="number">4</span>, <span class="number">6</span>)</span><br><span class="line">      .WithErrorCode(<span class="string">&quot;401&quot;</span>)</span><br><span class="line">      .WithMessage(<span class="string">&quot;Name必須在4~6字之間&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5.接著在剛剛要驗證的參數類別上加上Attribute</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">Validator(typeof(ParameterValidator))</span>]</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">WantValidateParameter</span></span><br><span class="line"> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>6.在Action裡面就可以用ModelState.IsValid來得知參數是否驗證成功啦!!</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Test</span>(<span class="params">WantValidateParameter parameter</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="built_in">string</span> Result = <span class="built_in">string</span>.Empty;</span><br><span class="line">            <span class="keyword">if</span> (!ModelState.IsValid)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//取得錯誤的訊息</span></span><br><span class="line">                <span class="keyword">var</span> Error = ModelState.Values.SelectMany(x =&gt; x.Errors).FirstOrDefault();</span><br><span class="line">                Result = Error.ErrorMessage;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Result = <span class="string">&quot;驗證成功&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> View(model: Result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>參考文章 :<br><span style="background-color: white; color: #777777; font-family: &quot;roboto slab&quot; , sans-serif; font-size: 15px;">1.</span><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif;"><span style="font-size: 15px;"><a href="https://github.com/JeremySkinner/FluentValidation/wiki/h.-MVC">https://github.com/JeremySkinner/FluentValidation/wiki/h.-MVC</a></span></span><br><span style="color: #777777; font-family: &quot;roboto slab&quot; , sans-serif;">2.<a href="https://docs.microsoft.com/en-us/aspnet/mvc/overview/older-versions/getting-started-with-aspnet-mvc4/adding-validation-to-the-model">MSDN :&nbsp;Adding Validation to the Model</a></span></p>
]]></content>
      <tags>
        <tag>FluentValidation</tag>
      </tags>
  </entry>
  <entry>
    <title>【IIS】405  不允許用來存取此網頁的HTTP 指令動詞</title>
    <url>/2016/11/28/%E3%80%90IIS%E3%80%91405-%E4%B8%8D%E5%85%81%E8%A8%B1%E7%94%A8%E4%BE%86%E5%AD%98%E5%8F%96%E6%AD%A4%E7%B6%B2%E9%A0%81%E7%9A%84HTTP-%E6%8C%87%E4%BB%A4%E5%8B%95%E8%A9%9E/</url>
    <content><![CDATA[<p>上線WebAPI專案的時候，發現只要用非Get與Post的動詞呼叫API，就會得到這個405的錯誤，最後上網找了一下資料跟請教同事，紀錄一下狀況。</p>
<p>首先如果IIS的的WebDAV功能有被啟動，那這些Http動詞就會被擋掉。但我同時也懷疑是安裝WebDeploy會開啟這個功能(<span style="color: red;">目前</span><span style="color: red;">沒有證實</span>)，會這樣懷疑是因為這個服務之前是沒問題的，但當天安裝了WebDeploy要建置CI環境時，這服務相關動詞就掛了。<br>但當天安裝WebDeploy的多台機器中，有些裝完也沒啟動WebDAV，現在不知道到底是需要特定環境或設定會開啟這個功能，還是一開始安裝IIS就勾選啟動了這功能，總之要小心就是了</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-HKu_UbhGZWg/WDubNA_FOUI/AAAAAAAAIBw/he7Kx_8_nh8GaCzrFKOzUgIn2zOeodTTwCLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://4.bp.blogspot.com/-HKu_UbhGZWg/WDubNA_FOUI/AAAAAAAAIBw/he7Kx_8_nh8GaCzrFKOzUgIn2zOeodTTwCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p>如果發現WebDAV被啟動，同時發生405錯誤時，在該網站的WebConfig加上以下區段來解決。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">system.webServer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">      ......</span><br><span class="line">      <span class="tag">&lt;<span class="name">remove</span> <span class="attr">name</span>=<span class="string">&quot;WebDAVModule&quot;</span>/&gt;</span></span><br><span class="line">      ......</span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">handlers</span>&gt;</span></span><br><span class="line">      .......</span><br><span class="line">      <span class="tag">&lt;<span class="name">remove</span> <span class="attr">name</span>=<span class="string">&quot;WebDAV&quot;</span> /&gt;</span></span><br><span class="line">      .......</span><br><span class="line">    <span class="tag">&lt;/<span class="name">handlers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">system.webServer</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>WebAPI</tag>
        <tag>IIS</tag>
      </tags>
  </entry>
  <entry>
    <title>【FluentValidation】繼承父類別的驗證</title>
    <url>/2016/11/25/%E3%80%90FluentValidation%E3%80%91%E7%B9%BC%E6%89%BF%E7%88%B6%E9%A1%9E%E5%88%A5%E7%9A%84%E9%A9%97%E8%AD%89/</url>
    <content><![CDATA[<p>很多時候我們的類別會繼承同一個父類別，而父類別的欄位可能都驗證的規則都一致，一直重寫會覺得很煩 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Parent</span> </span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> Name &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChildA</span> :<span class="title">Parent</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> ChildACustomProperty &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChildB</span> : <span class="title">Parent</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> ChildBCustomProperty &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這邊有兩個類別分別為ChildA和 ChildB，它們都繼承Parent這個類別，這時候 Parent的Name規則就是不能為空值跟Null，但真正會傳進來使用的是ChildA 與ChildB這兩個子類別，難道只能將驗證Name的欄位兩邊都寫嗎??</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChildAValidators</span> : <span class="title">AbstractValidator</span>&lt;<span class="title">ChildA</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ChildAValidators</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span> &#123;</span><br><span class="line">  <span class="comment">// Name</span></span><br><span class="line">  <span class="keyword">this</span>.RuleFor(x =&gt; x.Name)</span><br><span class="line">   .NotEmpty()</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;Name 不能為空值&quot;</span>)</span><br><span class="line">   .NotNull()</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;Name 不能為Null&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ChildACustomProperty</span></span><br><span class="line">  <span class="keyword">this</span>.RuleFor(x =&gt; x.ChildACustomProperty)</span><br><span class="line">   .Length(<span class="number">1</span>,<span class="number">6</span>)</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;ChildACustomProperty 必須介於1~6個字之間&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChildBValidators</span> : <span class="title">AbstractValidator</span>&lt;<span class="title">ChildB</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ChildBValidators</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span> &#123;</span><br><span class="line">  <span class="comment">// Name</span></span><br><span class="line">  <span class="keyword">this</span>.RuleFor(x =&gt; x.Name)</span><br><span class="line">   .NotEmpty()</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;Name 不能為空值&quot;</span>)</span><br><span class="line">   .NotNull()</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;Name 不能為Null&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ChildACustomProperty</span></span><br><span class="line">  <span class="keyword">this</span>.RuleFor(x =&gt; x.ChildBCustomProperty)</span><br><span class="line">   .Length(<span class="number">1</span>, <span class="number">12</span>)</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;ChildBCustomProperty 必須介於1~12個字之間&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣對程式設計來說不是很好，如果哪天Name的限制改變，所有繼承Parent的驗證都要翻出來改，其實FluentValidation也可以寫成繼承的方式，可以改成下面的方法</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChildAValidators</span> : <span class="title">ParentValidators</span>&lt;<span class="title">ChildA</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ChildAValidators</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span> &#123;</span><br><span class="line">  <span class="comment">// ChildACustomProperty</span></span><br><span class="line">  <span class="keyword">this</span>.RuleFor(x =&gt; x.ChildACustomProperty)</span><br><span class="line">   .Length(<span class="number">1</span>,<span class="number">6</span>)</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;ChildACustomProperty 必須介於1~6個字之間&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChildBValidators</span> : <span class="title">ParentValidators</span>&lt;<span class="title">ChildB</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ChildBValidators</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span> &#123;</span><br><span class="line">  <span class="comment">// ChildACustomProperty</span></span><br><span class="line">  <span class="keyword">this</span>.RuleFor(x =&gt; x.ChildBCustomProperty)</span><br><span class="line">   .Length(<span class="number">1</span>, <span class="number">12</span>)</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;ChildBCustomProperty 必須介於1~12個字之間&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ParentValidators</span>&lt;<span class="title">T</span>&gt; : <span class="title">AbstractValidator</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">  <span class="keyword">where</span> <span class="title">T</span> : <span class="title">Parent</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">ParentValidators</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span> &#123;</span><br><span class="line">  <span class="comment">// Name</span></span><br><span class="line">  <span class="keyword">this</span>.RuleFor(x =&gt; x.Name)</span><br><span class="line">   .NotEmpty()</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;Name 不能為空值&quot;</span>)</span><br><span class="line">   .NotNull()</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;400&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;Name 不能為Null&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣就可以讓程式乾淨許多，也讓它符合物件導向的設計!!!</p>
]]></content>
      <tags>
        <tag>FluentValidation</tag>
      </tags>
  </entry>
  <entry>
    <title>【JavaScript】判斷檔案是否存在</title>
    <url>/2012/10/19/%E3%80%90JavaScript%E3%80%91%E5%88%A4%E6%96%B7%E6%AA%94%E6%A1%88%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8/</url>
    <content><![CDATA[<p>最近用IE判斷某檔案是否存在，路徑分別有以下兩種情況<br><span style="color: red;">相對路徑</span> : %appdata%\Microsoft\Windows\Start Menu\Programs\Accessories\Notepad.lnk<br><span style="color: red;">絕對路徑</span> :&nbsp;C:\xxx\xxxx\Microsoft\Windows\Start Menu\Programs\Accessories\Notepad.lnk</p>
<p>原本只是單純使用<span style="color: red;">ActiveXObject(‘Scripting.FileSystemObject’)</span>的<span style="color: red;">FileExists</span>來判斷該檔案是否存在</p>
<p>在絕對路徑下都很OK，但這個function無法判斷相對路徑，所以必須先做一個轉換為絕對路徑的動作<br>var objShell =<span style="color: red;"> new ActiveXObject(“Wscript.Shell”);&nbsp;</span></p>
<p>objShell.ExpandEnvironmentStrings(“%appdata%\Microsoft\Windows\StartMenu\Programs\Accessories\Notepad.lnk”);</p>
<p>再丟給<span style="color: red;">FileExists</span>來判斷檔案是否存在，即大功告成。</p>
<p><strong>全部code</strong></p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> objnav = navigator;</span><br><span class="line"><span class="keyword">var</span> OsVersion = objnav.appVersion;</span><br><span class="line"><span class="keyword">var</span> fso = <span class="keyword">new</span> ActiveXObject(<span class="string">&#x27;Scripting.FileSystemObject&#x27;</span>);</span><br><span class="line"><span class="keyword">var</span> objShell = <span class="keyword">new</span> ActiveXObject(<span class="string">&quot;Wscript.Shell&quot;</span>);</span><br><span class="line"></span><br><span class="line">strfolderpath = objShell.ExpandEnvironmentStrings(<span class="string">&quot;%appdata%\\Microsoft\\Windows\\StartMenu\\Programs\\Accessories\\Notepad.lnk&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (fso.FileExists(strfolderpath))&#123;</span><br><span class="line">   alert(<span class="string">&#x27;絕對路徑有&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">   alert(<span class="string">&#x27;絕對路徑沒有&#x27;</span>);   </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>【JavaScript】showModalDialog運用</title>
    <url>/2012/10/16/%E3%80%90JavaScript%E3%80%91showModalDialog%E9%81%8B%E7%94%A8/</url>
    <content><![CDATA[<p>最近公司專案有使用到IE的showModalDialog，所以做一下筆記!!</p>
<p>叫用方式：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">openWindow</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">   <span class="keyword">var</span> Feature = <span class="string">&#x27;dialogWidth:850px;dialogHeight:600px;status:0;help:0;&#x27;</span>;</span><br><span class="line">   <span class="keyword">var</span> showModalObj = <span class="built_in">window</span>.showModalDialog(url, <span class="built_in">window</span>, Feature)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>各項參數請參考MSDN文件:<a href="http://msdn.microsoft.com/en-us/library/ie/ms536759(v=vs.85).aspx">參數設定</a></p>
<p>我的是寫個function,如要使用時將url傳進來。其中第二個參數<span style="color: red;">window</span>是將這這個視窗傳遞給開啟的showModalDialog，之後方便showModalDialog叫用母視窗的function或是變數。</p>
<p>例如我在母視窗有個alertMe的function</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function">function <span class="title">alertMe</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">   alert(<span class="string">&#x27;我是母視窗的一個function&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我只要在showModalDialog視窗中使用&nbsp;<span style="color: red;">window.dialogArguments.alertMe(); </span>，就可以直接到母視窗的function。</p>
<p>另外showModalDialog無論是postback或是location到別的網址都會開啟新視窗，所以在&lt;head&gt;裡面加上 </p>
<pre class="brush: html">&lt;head&gt;
   &lt;base target="_self" &gt;
&lt;/head&gt;
</pre>這樣目標就會是showModalDialog自己。

<p>為了解決showModalDialog因為Cache的關係只有第一個會PostBack的問題，請加入以下的code在page_load事件，讓每次開啟modal dialog都會PostBack</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!Page.IsPostBack) </span><br><span class="line">&#123;</span><br><span class="line">   <span class="comment">//為了解決showModalDialog常常會讀到舊頁面的問題</span></span><br><span class="line">   Page.Response.Expires = <span class="number">-1</span>;</span><br><span class="line">   Page.Response.AddHeader(<span class="string">&quot;Pragma&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">   Page.Response.AddHeader(<span class="string">&quot;cache-control&quot;</span>,<span class="string">&quot;no-store&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或是在Head裡面加上 ```html</p>
<meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="expires" content="-1"> 
    <meta http-equiv="cache-control" content="no-store">

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">**showModalDialog回傳True或false給母頁面的方法**</span><br><span class="line">showModalDialog頁面寫以下Javascript </span><br><span class="line">&#96;&#96;&#96;js</span><br><span class="line">window.returnValue &#x3D; false;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>母頁面寫以下Javascript </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">window</span>.showModalDialog(url, <span class="built_in">window</span>, set))</span><br><span class="line">&#123;</span><br><span class="line">   alert(<span class="string">&#x27;true&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line">   alert(<span class="string">&#x27;false&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><strong>showModalDialog回傳值的方式</strong><br>showModalDialog頁面寫以下Javascript： </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GoReturnValue</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   <span class="comment">//宣告一個Object</span></span><br><span class="line">   <span class="keyword">var</span> ReturnObj = <span class="keyword">new</span> <span class="built_in">Object</span>();</span><br><span class="line">   <span class="comment">//給這個Object屬性值</span></span><br><span class="line">   ReturnObj.codeValue = <span class="string">&quot;i&#x27;am return value&quot;</span>;</span><br><span class="line">   <span class="comment">//將這個Object回傳</span></span><br><span class="line">   <span class="built_in">window</span>.returnValue = ReturnObj;</span><br><span class="line">   <span class="built_in">window</span>.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>母頁面取值方式：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> returnObj = <span class="built_in">window</span>.showModalDialog(url, <span class="built_in">window</span>, Feature);</span><br><span class="line"><span class="comment">//取得這個Object的屬性值，在這邊應該會得到&quot;i&#x27;am return value&quot;</span></span><br><span class="line">alert(returnObj .codeValue);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>C#</tag>
        <tag>ASP</tag>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>【JQuery】透過$.fn.Extend自製Alert Function</title>
    <url>/2013/05/13/%E3%80%90JQuery%E3%80%91%E9%80%8F%E9%81%8E-fn-Extend%E8%87%AA%E8%A3%BDAlert-Function/</url>
    <content><![CDATA[<p>Google Drive新增修刪除後顯示訊息的方式，是在畫面上方跑出訊息一段時候後自動消失。<br>今天就來實作一下這個功能~</p>
<p>首先請先去下載<a href="http://getbootstrap.com/2.3.2/">bootstrap</a>，這裡面有個alert的class個人覺得滿漂亮的，所以就拿這個來改吧!!<br><img src="https://1.bp.blogspot.com/-aLkVe7wa0Cw/UZrmC7mMNJI/AAAAAAAADgA/k7d8QvVQ8VA/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png" alt="https://1.bp.blogspot.com/-aLkVe7wa0Cw/UZrmC7mMNJI/AAAAAAAADgA/k7d8QvVQ8VA/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png"></p>
<ul>
<li>首先正確的載入<a href="http://getbootstrap.com/2.3.2/">bootstrap</a>的CSS跟JavaScript</li>
<li>寫一個自製的JavaScript，其中$.fn.extend是JQuery的擴充function<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/// &lt;reference path=&quot;../jquery-1.9.1.min.js&quot; /&gt;</span></span><br><span class="line"> </span><br><span class="line">$.fn.extend(&#123;</span><br><span class="line">    alert: <span class="function"><span class="keyword">function</span> (<span class="params">msg</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> parentElement = $(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">var</span> alertElement = $(<span class="string">&#x27;&lt;div class=&quot;alert&quot;&gt;&#x27;</span>+</span><br><span class="line">                                <span class="string">&#x27;&lt;button type=&quot;button&quot; class=&quot;close&quot; data-dismiss=&quot;alert&quot;&gt;&amp;times;&lt;/button&gt;&#x27;</span>+</span><br><span class="line">                                <span class="string">&#x27;&lt;span class=&quot;text-center&quot;&gt;&#x27;</span> + msg + <span class="string">&#x27;&lt;/span&gt;&#x27;</span> +</span><br><span class="line">                            <span class="string">&#x27;&lt;/div&gt;&#x27;</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//先加到容器內才能算長度</span></span><br><span class="line">        alertElement.appendTo(parentElement);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//alert區塊的寬度</span></span><br><span class="line">        <span class="keyword">var</span> alertWidth = alertElement.width();</span><br><span class="line">        <span class="comment">//容器的寬度</span></span><br><span class="line">        <span class="keyword">var</span> targetWidth = parentElement.width();</span><br><span class="line">        <span class="keyword">var</span> position = parentElement.position();</span><br><span class="line">        <span class="keyword">var</span> _left = position.left + (targetWidth / <span class="number">2</span>) - (alertWidth / <span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line">        alertElement.css(&#123; <span class="attr">top</span>: position.top, <span class="attr">left</span>: _left &#125;).fadeIn(<span class="number">500</span>);</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//時間到就清除掉</span></span><br><span class="line">        <span class="keyword">var</span> timer = <span class="built_in">setTimeout</span>(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; alertElement.fadeOut(); <span class="built_in">clearTimeout</span>(timer); &#125;, <span class="number">5000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure></li>
<li>改一些bootstrap的CSS，通常我會將這段另外寫在自己的css檔案裡面，盡量避免直接改動官方的任何檔案<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* alert訊息 */</span></span><br><span class="line">.alert</span><br><span class="line">&#123;   </span><br><span class="line">    width:300px;</span><br><span class="line">    z-index:<span class="number">3</span>;</span><br><span class="line">    display:none;</span><br><span class="line">    color:#0300FA;</span><br><span class="line">    position:absolute;</span><br><span class="line">    margin:0px;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">.alert&gt;span</span><br><span class="line">&#123;</span><br><span class="line">    display:inline-block;</span><br><span class="line">    width:270px;</span><br><span class="line">    word-<span class="keyword">break</span>:<span class="keyword">break</span>-all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>之後呼叫這樣寫<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//在這邊$(&#x27;#BackStageBody&#x27;)為要出現訊息方塊的區域，剛剛擴充的function會自動計算其寬高，並把訊息顯示在正確的位置</span></span><br><span class="line">$(<span class="string">&#x27;#BackStageBody&#x27;</span>).alert(<span class="string">&#x27;新增成功&#x27;</span>)</span><br></pre></td></tr></table></figure></li>
<li>效果如下<br><img src="https://1.bp.blogspot.com/-4cGHu7f6cOM/UZrsAuCBNFI/AAAAAAAADgQ/0rOQOMCfDSw/s1600/XZxZx.gif" alt="https://1.bp.blogspot.com/-4cGHu7f6cOM/UZrsAuCBNFI/AAAAAAAADgQ/0rOQOMCfDSw/s1600/XZxZx.gif"></li>
</ul>
]]></content>
      <tags>
        <tag>JQuery</tag>
      </tags>
  </entry>
  <entry>
    <title>【JavaScript】網址傳遞中文參數亂碼解決問題</title>
    <url>/2013/06/10/%E3%80%90JavaScript%E3%80%91%E7%B6%B2%E5%9D%80%E5%82%B3%E9%81%9E%E4%B8%AD%E6%96%87%E5%8F%83%E6%95%B8%E4%BA%82%E7%A2%BC%E8%A7%A3%E6%B1%BA%E5%95%8F%E9%A1%8C/</url>
    <content><![CDATA[<p><a href="http://blog.longwin.com.tw/2010/01/javascript-encodeuri-component-utf-8-2010/">參考</a></p>
<p>今天網址列傳遞參數時，透過Request.QueryString轉回來時變成亂碼。參考該部落格的解法後做個小筆記避免自己忘記 </p>
<ul>
<li>  如果是用JavaScript串網址的話，用encodeURI()這個方法 ```javascript<br>var Feature = ‘dialogWidth:500px;dialogHeight:200px;status:0;help:0;’;<br>var Url = ‘wFrmAccount_Insert.aspx?src=’ + src + ‘&amp;bancode=’ + bancode + ‘&amp;ym=’ + ym + ‘&amp;type=’ + type;<br>//將網址先編譯過後再傳遞<br>window.showModalDialog(encodeURI(Url), window, Feature</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   如果是在ServerSide串網址，則用以下方法 &#96;&#96;&#96;csharp</span><br><span class="line">Response.Redirect(&quot;WebForm2.aspx?id&#x3D;&quot; + Server.UrlEncode(&quot;中文&quot;))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ASP</tag>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>【JQuery】製作Sortable下拉時ScrollBar也會跟著捲動</title>
    <url>/2013/06/12/%E3%80%90JQuery%E3%80%91%E8%A3%BD%E4%BD%9CSortable%E4%B8%8B%E6%8B%89%E6%99%82ScrollBar%E4%B9%9F%E6%9C%83%E8%B7%9F%E8%91%97%E6%8D%B2%E5%8B%95/</url>
    <content><![CDATA[<p><a href="http://jqueryui.com/sortable/#default">JQuery Sortable套件</a></p>
<p>這個常常被我用來設定排序的套件，但有個缺點就是它在拉動時父容器不會跟著滾動ScrollBar，所以自己稍做修改了一下(包含上下按鈕的功能)</p>
<ul>
<li>  先看一下成果 <a href="http://3.bp.blogspot.com/-ylhcGHApU6M/UbhPgADcDOI/AAAAAAAADrc/yPhSeZDoLJg/s1600/z7QsfA1371033050.gif"><img src="http://3.bp.blogspot.com/-ylhcGHApU6M/UbhPgADcDOI/AAAAAAAADrc/yPhSeZDoLJg/s1600/z7QsfA1371033050.gif"></a></li>
<li>HTML ```html<ul id="sortable">
              <li class="ui-state-default" data-sort="a">1</li>
              <li class="ui-state-default" data-sort="b">2</li>
              <li class="ui-state-default">3</li>
              <li class="ui-state-default">4</li>
              <li class="ui-state-default">5</li>
              <li class="ui-state-default">6</li>
              <li class="ui-state-default">7</li>
              <li class="ui-state-default">8</li>
              <li class="ui-state-default">9</li>
              <li class="ui-state-default">10</li>
              <li class="ui-state-default">11</li>
              <li class="ui-state-default">12</li>
              <li class="ui-state-default">13</li>
              <li class="ui-state-default">14</li>
              <li class="ui-state-default">15</li>
              <li class="ui-state-default">16</li>
              <li class="ui-state-default">17</li>
              <li class="ui-state-default">18</li>
              <li class="ui-state-default">19</li>
              <li class="ui-state-default">20</li>
              <li class="ui-state-default">21</li>
       </ul>
       <div id="sortbtn">
              <input type="button" value="▲" id="btnUp" class="btn btn-info" />
              <input type="button" value="▼" id="btnDown" class="btn btn-info"/>
       </div></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   CSS &#96;&#96;&#96;css</span><br><span class="line">#sortable &#123; list-style-type: none; margin: 0; padding: 0; width: 150px; &#125;</span><br><span class="line">#sortable li &#123; margin: 0 5px 5px 5px; padding: 5px; font-size: 1.2em; height: 1.5em; &#125;</span><br><span class="line">html&gt;body #sortable li &#123; height: 1.5em; line-height: 1.2em; &#125;</span><br><span class="line">.ui-state-highlight &#123; height: 1.5em; line-height: 1.2em; &#125;</span><br><span class="line"></span><br><span class="line">    #sortable</span><br><span class="line">&#123;</span><br><span class="line">    border:1px dotted gray;</span><br><span class="line">    overflow:auto;</span><br><span class="line">    height:500px;</span><br><span class="line">    display:inline-block;</span><br><span class="line">    width:130px;</span><br><span class="line">&#125;</span><br><span class="line">#sortbtn</span><br><span class="line">&#123;</span><br><span class="line">    display:inline-block;</span><br><span class="line">    width:30px;</span><br><span class="line">    vertical-align:top;</span><br><span class="line">    position:relative;</span><br><span class="line">    top:180px;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><p>JavaScript ```javascript<br>$(function () {<br>  var is_dragging = false;<br>  $(‘#sortable’).disableSelection().sortable({</p>
<pre><code>  placeholder: &quot;ui-state-highlight&quot;,
  axis: &#39;y&#39;,
  start: function (event, ui) &#123; is_dragging = true; itemSelect(ui.item); &#125;,
  stop: function (event, ui) &#123; is_dragging = false;&#125;
</code></pre>
<p>  }).mousemove(function (e) {</p>
<pre><code>  if (is_dragging) &#123;
      $(&#39;#sortable&#39;).scrollTop(function (i, v) &#123;
          var h = $(&#39;#sortable&#39;).height();
          var y = e.clientY - h / 2;
          return v + y * 0.05;
      &#125;);
  &#125;
</code></pre>
<p>  });</p>
<pre><code>  //=== 點擊Item時
</code></pre>
<p>  $(‘#sortable &gt; li’).click(function (event) {</p>
<pre><code>  itemSelect(this);
</code></pre>
<p>  });</p>
<pre><code>  ////=== 上下按鈕
</code></pre>
<p>  $(‘#btnUp,#btnDown’).click(function () {</p>
<pre><code>  var Container_height = $(&#39;#sortable&#39;).height();
  var position_top = $(&#39;#sortable&#39;).position().top;

      if (lastSelect != null) &#123;
      if ($(this).prop(&#39;id&#39;) == &quot;btnUp&quot;) &#123;
          lastSelect.prev().before(lastSelect);
          //卷軸向上滾動
          $(&#39;#sortable&#39;).scrollTop(function (i, v) &#123;
              if (lastSelect.position().top &lt;= position_top + Container_height / 2) &#123;
                  return v - lastSelect.height();
              &#125;
          &#125;);
      &#125;
      else &#123;
          lastSelect.next().after(lastSelect);
          //卷軸向下滾動
          $(&#39;#sortable&#39;).scrollTop(function (i, v) &#123;
              if (lastSelect.position().top &gt;= position_top + Container_height / 2) &#123;
                  return v + lastSelect.height();
              &#125;
          &#125;);
      &#125;
  &#125;
</code></pre>
<p>  });<br>});</p>
</li>
</ul>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>JQuery</tag>
      </tags>
  </entry>
  <entry>
    <title>【JavaScript】驗證上傳的附檔名</title>
    <url>/2013/07/14/%E3%80%90JavaScript%E3%80%91%E9%A9%97%E8%AD%89%E4%B8%8A%E5%82%B3%E7%9A%84%E9%99%84%E6%AA%94%E5%90%8D/</url>
    <content><![CDATA[<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$(<span class="string">&#x27;input[type=&quot;file&quot;]&#x27;</span>).on(<span class="string">&#x27;change&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> file = $(<span class="built_in">this</span>).val();</span><br><span class="line">    <span class="keyword">if</span> (!file.match(<span class="regexp">/^([0-9a-zA-Z_\-~ :\\])+(.jpg|.JPG|.jpeg|.JPEG|.bmp|.BMP|.gif|.GIF|.png|.PNG)$/</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        alert(<span class="string">&#x27;只允許上傳圖檔&#x27;</span>);</span><br><span class="line">        <span class="keyword">var</span> control = $(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">//如果上傳的檔案格式不符合，將該Control換成新的</span></span><br><span class="line">        control.replaceWith(control = control.clone(<span class="literal">true</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>JQuery</tag>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>【LINQ TO SQL】解決SubmitChanges時與資料庫衝突的問題</title>
    <url>/2013/09/06/%E3%80%90LINQ-TO-SQL%E3%80%91%E8%A7%A3%E6%B1%BASubmitChanges%E6%99%82%E8%88%87%E8%B3%87%E6%96%99%E5%BA%AB%E8%A1%9D%E7%AA%81%E7%9A%84%E5%95%8F%E9%A1%8C/</url>
    <content><![CDATA[<ul>
<li><p>  一樣參考保哥的<a href="http://blog.miniasp.com/post/2008/05/24/Resolve-LINQ-to-SQL-Change-Conflict-Exception.aspx">解決 LINQ to SQL 資料庫更新衝突的情形</a>與公司前輩的Source Code</p>
</li>
<li><p><strong>發生原因：</strong>有可能我們在跟DB取得某個欄位時得到A這個值，但當我們改動這個值並嘗試更新回DB時，可能DB早就被其他使用者改成B了。DBContext SubmitChanges會去比對這個欄位最初值是否與DB目前的值一致避免Dirty Data的問題，但當上述情況發生時則會擲出Exception。各種處理方式如下:```csharp<br>try<br>{<br> _dbContext.SubmitChanges(System.Data.Linq.ConflictMode.ContinueOnConflict);<br>}<br>catch (System.Data.Linq.ChangeConflictException ex)<br>{<br> foreach (System.Data.Linq.ObjectChangeConflict occ in _dbContext.ChangeConflicts)<br> {</p>
<pre><code>// 採用資料庫的查詢出來的值，目前物件的值將會被資料庫最新查到的複寫
//occ.Resolve(System.Data.Linq.RefreshMode.OverwriteCurrentValues);

    // 採用目前物件中的值，並更新資料庫中的版本
//occ.Resolve(System.Data.Linq.RefreshMode.KeepCurrentValues);

    // 僅更新此物件中變更的欄位，僅將變更的欄位寫入資料庫（或稱為合併更新）
occ.Resolve(System.Data.Linq.RefreshMode.KeepChanges);
</code></pre>
<p>  }<br>  // 注意：解決完衝突之後要記得重新再 SubmitChanges() 一次，否則一樣不會更新資料庫<br>  _dbContext.SubmitChanges();<br>}</p>
</li>
</ul>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>LINQ TO SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【LeetCode】Add Two Numbers</title>
    <url>/2018/06/05/%E3%80%90LeetCode%E3%80%91Add%20Two%20Numbers/</url>
    <content><![CDATA[<p>有感於自己是個廢物工程師，開了LeetCode帳號好幾個月一題都還沒刷，所以決定寫一系列紀錄自己刷LeetCode的過程跟解題方法，希望幾年後回頭能看見自己的進步，廢話不多說直接進入題目。</p>
<h1 id="題目"><a href="#題目" class="headerlink" title="#題目"></a>#題目</h1><p>You are given two <strong>non-empty</strong> linked lists representing two non-negative integers. The digits are stored in <strong>reverse order</strong> and each of their nodes contain a single digit. Add the two numbers and return it as a linked list.</p>
<p>You may assume the two numbers do not contain any leading zero, except the number 0 itself.</p>
<p><strong>Example</strong> </p>
<div class="note info">
            <p>Input: (2 -&gt; 4 -&gt; 3) + (5 -&gt; 6 -&gt; 4)<br>Output: 7 -&gt; 0 -&gt; 8<br>Explanation: 342 + 465 = 807</p>
          </div>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * public class ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     public int val;</span></span><br><span class="line"><span class="comment"> *     public ListNode next;</span></span><br><span class="line"><span class="comment"> *     public ListNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Solution</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">AddTwoNumbers</span>(<span class="params">ListNode l1, ListNode l2</span>)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="解題"><a href="#解題" class="headerlink" title="#解題"></a>#解題</h1><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Solution</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> ListNode <span class="title">AddTwoNumbers</span>(<span class="params">ListNode l1, ListNode l2</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           ListNode Result = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">           ListNode CN1 = l1;</span><br><span class="line">           ListNode CN2 = l2;</span><br><span class="line"></span><br><span class="line">           ListNode RCN = Result;</span><br><span class="line">           <span class="built_in">bool</span> Flag = <span class="literal">true</span>;</span><br><span class="line">           <span class="keyword">while</span> (Flag)</span><br><span class="line">           &#123;</span><br><span class="line">               <span class="keyword">var</span> Sum = RCN.val +  GetNodeValue(CN1) + GetNodeValue(CN2);</span><br><span class="line"></span><br><span class="line">               RCN.val = Sum % <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (Sum &gt; <span class="number">9</span>)</span><br><span class="line">                   RCN.next = <span class="keyword">new</span> ListNode(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">               CN1 = CN1 == <span class="literal">null</span> ? <span class="literal">null</span> : CN1.next;</span><br><span class="line">               CN2 = CN2 == <span class="literal">null</span> ? <span class="literal">null</span> : CN2.next;</span><br><span class="line">               </span><br><span class="line"></span><br><span class="line">               Flag = (CN1 != <span class="literal">null</span> || CN2 != <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (Flag &amp;&amp; RCN.next == <span class="literal">null</span>)</span><br><span class="line">                   RCN.next = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">               RCN = RCN.next;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">return</span> Result;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">GetNodeValue</span>(<span class="params">ListNode node</span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           <span class="keyword">return</span> node == <span class="literal">null</span> ?  <span class="number">0</span> : node.val;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h2 id="Unit-Testing"><a href="#Unit-Testing" class="headerlink" title="Unit Testing"></a>Unit Testing</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestClass</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">SolutionTests</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">TestMethod</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> AddTwoNumbersTest_輸入L1為<span class="number">342</span>_L2為<span class="number">456</span>_應得到<span class="number">807</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//arrange</span></span><br><span class="line">        <span class="keyword">var</span> l1 = <span class="keyword">new</span> ListNode(<span class="number">2</span>);</span><br><span class="line">        l1.next = <span class="keyword">new</span> ListNode(<span class="number">4</span>);</span><br><span class="line">        l1.next.next = <span class="keyword">new</span> ListNode(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> l2 = <span class="keyword">new</span> ListNode(<span class="number">5</span>);</span><br><span class="line">        l2.next = <span class="keyword">new</span> ListNode(<span class="number">6</span>);</span><br><span class="line">        l2.next.next = <span class="keyword">new</span> ListNode(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> expected = <span class="keyword">new</span> ListNode(<span class="number">7</span>);</span><br><span class="line">        expected.next = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        expected.next.next = <span class="keyword">new</span> ListNode(<span class="number">8</span>);</span><br><span class="line">        <span class="comment">//act</span></span><br><span class="line">        <span class="keyword">var</span> actual = sut.AddTwoNumbers(l1,l2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//assert</span></span><br><span class="line">        actual.Should().BeEquivalentTo(expected);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">TestMethod</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> AddTwoNumbersTest_輸入L1為<span class="number">42</span>_L2為<span class="number">708</span>_應得到<span class="number">750</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//arrange</span></span><br><span class="line">        <span class="keyword">var</span> l1 = <span class="keyword">new</span> ListNode(<span class="number">2</span>);</span><br><span class="line">        l1.next = <span class="keyword">new</span> ListNode(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> l2 = <span class="keyword">new</span> ListNode(<span class="number">8</span>);</span><br><span class="line">        l2.next = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        l2.next.next = <span class="keyword">new</span> ListNode(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> expected = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        expected.next = <span class="keyword">new</span> ListNode(<span class="number">5</span>);</span><br><span class="line">        expected.next.next = <span class="keyword">new</span> ListNode(<span class="number">7</span>);</span><br><span class="line">        <span class="comment">//act</span></span><br><span class="line">        <span class="keyword">var</span> actual = sut.AddTwoNumbers(l1, l2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//assert</span></span><br><span class="line">        actual.Should().BeEquivalentTo(expected);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">TestMethod</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> AddTwoNumbersTest_輸入L1為<span class="number">1</span>_L2為<span class="number">99</span>_應得到<span class="number">100</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//arrange</span></span><br><span class="line">        <span class="keyword">var</span> l1 = <span class="keyword">new</span> ListNode(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> l2 = <span class="keyword">new</span> ListNode(<span class="number">9</span>);</span><br><span class="line">        l2.next = <span class="keyword">new</span> ListNode(<span class="number">9</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> expected = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        expected.next = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">        expected.next.next = <span class="keyword">new</span> ListNode(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">//act</span></span><br><span class="line">        <span class="keyword">var</span> actual = sut.AddTwoNumbers(l1, l2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//assert</span></span><br><span class="line">        actual.Should().BeEquivalentTo(expected);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="分析結果"><a href="#分析結果" class="headerlink" title="#分析結果"></a>#分析結果</h1><p>雖然過了但是效率不佳，執行完LeetCode全部的測試總共花費 <strong>176 ms</strong>只贏過38.84%的提交範例，所以試試看優化它</p>
<p><img src="/images/20180615/leetcode/1.jpg" alt="/images/20180615/leetcode/1.jpg"></p>
<h2 id="移除三元運算子"><a href="#移除三元運算子" class="headerlink" title="移除三元運算子"></a>移除三元運算子</h2><p>基本上三元運算子比較耗效能，所以優先改進它</p>
<p><strong>原本</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">GetNodeValue</span>(<span class="params">ListNode node</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> node == <span class="literal">null</span> ?  <span class="number">0</span> : node.val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>修改後</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">GetNodeValue</span>(<span class="params">ListNode node</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> node.val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<p><strong>原本</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">CN1 = CN1 == <span class="literal">null</span> ? <span class="literal">null</span> : CN1.next;</span><br><span class="line">CN2 = CN2 == <span class="literal">null</span> ? <span class="literal">null</span> : CN2.next;</span><br></pre></td></tr></table></figure>



<p><strong>修改後</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (Node1Cursor != <span class="literal">null</span>)</span><br><span class="line">    Node1Cursor = Node1Cursor.next;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (Node2Cursor != <span class="literal">null</span>)</span><br><span class="line">    Node2Cursor = Node2Cursor.next;</span><br></pre></td></tr></table></figure>



<p><strong>測試結果</strong></p>
<p><img src="/images/20180615/leetcode/2.jpg" alt="/images/20180615/leetcode/2.jpg"></p>
<p>簡直是三元運算子定生死….</p>
<h2 id="優化可讀性"><a href="#優化可讀性" class="headerlink" title="優化可讀性"></a>優化可讀性</h2><blockquote class="blockquote-center">
            <i class="fa fa-quote-left"></i>
            <p>乾淨的程式碼，閱讀起來應該像是幾何證明般</p>
<p>Uncle Bob</p>

            <i class="fa fa-quote-right"></i>
          </blockquote>

<p>所以試著讓變數命名更貼近意義一點</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Solution</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">AddTwoNumbers</span>(<span class="params">ListNode l1, ListNode l2</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ListNode Result = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        ListNode Node1Cursor = l1;</span><br><span class="line">        ListNode Node2Cursor = l2;</span><br><span class="line"></span><br><span class="line">        ListNode Head = Result;</span><br><span class="line">        <span class="built_in">bool</span> NeedNextRun = <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">while</span> (NeedNextRun)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> Sum = Head.val + GetNodeValue(Node1Cursor) + GetNodeValue(Node2Cursor);</span><br><span class="line"></span><br><span class="line">            Head.val = Sum % <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Sum &gt; <span class="number">9</span>)</span><br><span class="line">                Head.next = <span class="keyword">new</span> ListNode(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Node1Cursor != <span class="literal">null</span>)</span><br><span class="line">                Node1Cursor = Node1Cursor.next;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (Node2Cursor != <span class="literal">null</span>)</span><br><span class="line">                Node2Cursor = Node2Cursor.next;</span><br><span class="line"></span><br><span class="line">            NeedNextRun = (Node1Cursor != <span class="literal">null</span> || Node2Cursor != <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (NeedNextRun &amp;&amp; Head.next == <span class="literal">null</span>)</span><br><span class="line">                Head.next = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            Head = Head.next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">GetNodeValue</span>(<span class="params">ListNode node</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> node.val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>也因為有寫單元測試的關係，上述的調整過程中都沒讓程式壞掉，最後希望藉由這樣的練習能讓自己TDD與重構的技巧再更純熟一些</p>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>【LeetCode】Count The Repetitions</title>
    <url>/2018/06/13/%E3%80%90LeetCode%E3%80%91Count%20The%20Repetitions/</url>
    <content><![CDATA[<h1 id="題目"><a href="#題目" class="headerlink" title="#題目"></a>#題目</h1><p>Define <code>S = [s,n]</code> as the string S which consists of n connected strings s. For example, <code>[&quot;abc&quot;, 3]</code> =”abcabcabc”.</p>
<p>On the other hand, we define that string s1 can be obtained from string s2 if we can remove some characters from s2 such that it becomes s1. For example, “abc” can be obtained from “abdbec” based on our definition, but it can not be obtained from “acbbe”.</p>
<p>You are given two non-empty strings s1 and s2 (each at most 100 characters long) and two integers 0 ≤ n1 ≤ 106 and 1 ≤ n2 ≤ 106. Now consider the strings S1 and S2, where <code>S1=[s1,n1]</code> and <code>S2=[s2,n2]</code>. Find the maximum integer M such that <code>[S2,M]</code> can be obtained from <code>S1</code>.</p>
<p><strong>Example:</strong></p>
<div class="note info">
            <p>Input:<br>s1=”acb”, n1=4<br>s2=”ab”, n2=2</p><p>Return:<br>2</p>
          </div>



<h1 id="解題"><a href="#解題" class="headerlink" title="#解題"></a>#解題</h1><p><strong>如何判定S2會包含在S1的倍數之中</strong>，我採取的方法是將遍歷S1的每個字元，每當該字元與S2相同時，S2的指標往前一格。</p>
<div class="note info">
            <p>[a]cb<br>S1 : <strong>a</strong><br>[a]b<br>S2 : <strong>a</strong>  </p>
          </div>

<div class="note info">
            <p>a[c]b<br>S1 : c<br>a[b]<br>S2 : b</p>
          </div>

<div class="note info">
            <p>ac[b]<br>S1 : <strong>b</strong><br>a[b]<br>S2 : <strong>b</strong></p>
          </div>

<div class="note info">
            <p>[a]cb<br>S1 : <strong>a</strong><br>[a]b<br>S2 : <strong>a</strong></p>
          </div>

<p>以下省略….</p>
<p>直到S1 * N1的字元次數被跑完時，可以知道S2被重複了幾次，這時候將重複次數<strong>除以N2</strong>即為真正可重複的次數</p>
<h2 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetMaxRepetitionsTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> s1 = <span class="string">&quot;acb&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> n1 = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">var</span> s2 = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> n2 = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.GetMaxRepetitions(s1, n1, s2, n2);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">GetMaxRepetitions</span>(<span class="params"><span class="built_in">string</span> s1, <span class="built_in">int</span> n1, <span class="built_in">string</span> s2, <span class="built_in">int</span> n2</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> SlChars = s1.ToCharArray();</span><br><span class="line">    <span class="keyword">var</span> S2Chars = s2.ToCharArray();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> Repetitions = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> Cursor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; SlChars.Length * n1 ; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (SlChars[i % SlChars.Length] == S2Chars[Cursor])</span><br><span class="line">        &#123;</span><br><span class="line">            Cursor++; </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Cursor == S2Chars.Length)</span><br><span class="line">        &#123;</span><br><span class="line">            Repetitions++;</span><br><span class="line">            Cursor = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Repetitions / n2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetMaxRepetitionsTest_2</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> s1 = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> n1 = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">var</span> s2 = <span class="string">&quot;ab&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> n2 = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.GetMaxRepetitions(s1, n1, s2, n2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>單元測試直接通過</strong></p>
<h1 id="解析"><a href="#解析" class="headerlink" title="#解析"></a>#解析</h1><p>LeetCode回傳<strong>Time Limit Exceeded</strong>，表示這效率不能接受，所以來試試看優化它</p>
<p><img src="/images/20180611/1.jpg"></p>
<h2 id="優化"><a href="#優化" class="headerlink" title="優化"></a>優化</h2><p>想先把迴圈內計算餘數的地方拿掉，這個地方應該卡掉一堆效能</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (SlChars[i % SlChars.Length] == S2Chars[Cursor])</span><br></pre></td></tr></table></figure>

<p>改寫之後不再迴圈內計算餘數，讓每個變數的操作都盡量簡單化</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">GetMaxRepetitions</span>(<span class="params"><span class="built_in">string</span> s1, <span class="built_in">int</span> n1, <span class="built_in">string</span> s2, <span class="built_in">int</span> n2</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> SlChars = s1.ToCharArray();</span><br><span class="line">    <span class="keyword">var</span> S2Chars = s2.ToCharArray();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> Repetitions = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> S1Cursor = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> S2Cursor = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> Count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (Count &lt; n1)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (SlChars[S1Cursor] == S2Chars[S2Cursor])</span><br><span class="line">        &#123;</span><br><span class="line">            S2Cursor++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        S1Cursor++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (S2Cursor == S2Chars.Length)</span><br><span class="line">        &#123;</span><br><span class="line">            Repetitions++;</span><br><span class="line">            S2Cursor = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (S1Cursor == SlChars.Length)</span><br><span class="line">        &#123;</span><br><span class="line">            S1Cursor = <span class="number">0</span>;</span><br><span class="line">            Count++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Repetitions / n2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>結果LeetCode還是判定逾時,果然事情不是憨人我想的那麼簡單，暴力破解法行不通</p>
<p><img src="/images/20180611/3.jpg" alt="/images/20180611/3.jpg"></p>
<h2 id="尋找Loop-Pattern"><a href="#尋找Loop-Pattern" class="headerlink" title="尋找Loop Pattern"></a>尋找Loop Pattern</h2><p>在這邊決定改變作法，首先如果S1會重複表示有可能發生重複狀況的發生，例如</p>
<p>S1 = aabaabaab<br>n1 = 3</p>
<p>S2 = aba<br>n2 = 1</p>
<table>
<thead>
<tr>
<th>0</th>
<th></th>
<th></th>
<th></th>
<th>4</th>
<th></th>
<th></th>
<th>7</th>
<th></th>
<th></th>
<th>1</th>
<th></th>
<th></th>
<th>4</th>
<th></th>
<th></th>
<th>7</th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><strong>a</strong></td>
<td>a</td>
<td>b</td>
<td>a</td>
<td>a</td>
<td>b</td>
<td>a</td>
<td>a</td>
<td>b</td>
<td><strong>a</strong></td>
<td>a</td>
<td>b</td>
<td>a</td>
<td>a</td>
<td>b</td>
<td>a</td>
<td>a</td>
<td>b</td>
<td><strong>a</strong></td>
<td>…..</td>
</tr>
<tr>
<td><strong>a</strong></td>
<td></td>
<td>b</td>
<td>a</td>
<td><strong>a</strong></td>
<td>b</td>
<td>a</td>
<td><strong>a</strong></td>
<td>b</td>
<td>a</td>
<td><strong>a</strong></td>
<td>b</td>
<td>a</td>
<td><strong>a</strong></td>
<td>b</td>
<td>a</td>
<td><strong>a</strong></td>
<td>b</td>
<td>a</td>
<td>…..</td>
</tr>
</tbody></table>
<p>*第一列表示S2字首a比對到時，相對於各組S1的Index</p>
<p>*第二列 S1的排序組</p>
<p>*第三列 S2比對相符組</p>
<p>可以發現第一次重複的Index為4，所以繼續往下排就會一直重複的狀況發生，也藉著這個特性可以找出一個算法。</p>
<ul>
<li>第二次4在整個S1的排列組裡面Index為<strong>13</strong>，第一次4在整個排列組裡面Index也是<strong>4</strong></li>
<li>兩者之間總共可以包含3組S2</li>
<li>所以之後只要每加9個字元，就會多出3組S2</li>
</ul>
<p>依照此特性修改程式</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">GetMaxRepetitions</span>(<span class="params"><span class="built_in">string</span> s1, <span class="built_in">int</span> n1, <span class="built_in">string</span> s2, <span class="built_in">int</span> n2</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> S1Chars = s1.ToCharArray();</span><br><span class="line">    <span class="keyword">var</span> S2Chars = s2.ToCharArray();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> S2Cursor = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">int</span> Repetitions = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> LogFirstLetterMatchInS1Index = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, Tuple&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; S1Chars.Length * n1 ; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> S1Index = i % s1.Length;</span><br><span class="line">        <span class="keyword">if</span> (S1Chars[S1Index] == S2Chars[S2Cursor])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (S2Cursor == <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (LogFirstLetterMatchInS1Index.ContainsKey(S1Index))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//形成Loop了</span></span><br><span class="line">                    <span class="keyword">var</span> PreSameIndexValue = LogFirstLetterMatchInS1Index[S1Index];</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//Repetitions</span></span><br><span class="line">                    <span class="keyword">var</span> OneLoopS2Count = (Repetitions - PreSameIndexValue.Item2);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> OneLoopDistance = i - PreSameIndexValue.Item1;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">while</span> ((i + OneLoopDistance) &lt; S1Chars.Length * n1)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Repetitions += OneLoopS2Count;</span><br><span class="line"></span><br><span class="line">                        i += OneLoopDistance;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    LogFirstLetterMatchInS1Index.Add(S1Index,<span class="keyword">new</span> Tuple&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt;(i, Repetitions));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            S2Cursor++;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (S2Cursor == S2Chars.Length)</span><br><span class="line">        &#123;</span><br><span class="line">            Repetitions++;</span><br><span class="line"></span><br><span class="line">            S2Cursor = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Repetitions / n2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/20180611/4.jpg"></p>
<p>雖然終於通過LeetCode測驗，但成績依然不是很理想，不過一些大神的解法目前還沒完全了解，所以先用這個算法勉強過關，之後有懂更佳的方式再繼續優化。</p>
<p>這題寫了兩天且數次拿著計算紙在床上睡著後終於勉強想通，不愧是Hard等級的題目阿</p>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>【LeetCode】Find the Difference</title>
    <url>/2018/06/07/%E3%80%90LeetCode%E3%80%91Find%20the%20Difference/</url>
    <content><![CDATA[<h1 id="題目"><a href="#題目" class="headerlink" title="#題目"></a>#題目</h1><p>Given two strings s and t which consist of only lowercase letters.<br>String t is generated by random shuffling string s and then add one more letter at a random position.<br>Find the letter that was added in t.</p>
<p><strong>Example:</strong> </p>
<div class="note info">
            <p>Input:<br>s = “abcd”<br>t = “abcde”</p><p>Output:<br>e</p><p>Explanation:<br>‘e’ is the letter that was added.</p>
          </div>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Solution</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">char</span> <span class="title">FindTheDifference</span>(<span class="params"><span class="built_in">string</span> s, <span class="built_in">string</span> t</span>)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="解題"><a href="#解題" class="headerlink" title="#解題"></a>#解題</h1><h2 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> FindTheDifferenceTest_輸入S為abcd_輸入T為abcde()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="keyword">var</span> S = <span class="string">&quot;abcd&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> T = <span class="string">&quot;abcde&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">char</span> expected = <span class="string">&#x27;e&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.FindTheDifference(S, T);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">char</span> <span class="title">FindTheDifference</span>(<span class="params"><span class="built_in">string</span> s, <span class="built_in">string</span> t</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> originalString =  s.ToCharArray();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> addSomeSaltString = t.ToCharArray();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; addSomeSaltString.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> checkThisChar = addSomeSaltString[i];</span><br><span class="line">        <span class="keyword">if</span> (i &gt; originalString.Length <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> checkThisChar;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (originalString[i] != checkThisChar)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> checkThisChar;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="解析"><a href="#解析" class="headerlink" title="#解析"></a>#解析</h1><p><strong>LeetCode跑測試錯誤</strong></p>
<p><img src="/images/20180607/1.jpg"></p>
<h2 id="補上錯誤案例"><a href="#補上錯誤案例" class="headerlink" title="補上錯誤案例"></a>補上錯誤案例</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">FindTheDifferenceTest_LeetCode_Error1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="keyword">var</span> S = <span class="string">&quot;ymbgaraibkfmvocpizdydugvalagaivdbfsfbepeyccqfepzvtpyxtbadkhmwmoswrcxnargtlswqemafandgkmydtimuzvjwxvlfwlhvkrgcsithaqlcvrihrwqkpjdhgfgreqoxzfvhjzojhghfwbvpfzectwwhexthbsndovxejsntmjihchaotbgcysfdaojkjldprwyrnischrgmtvjcorypvopfmegizfkvudubnejzfqffvgdoxohuinkyygbdzmshvyqyhsozwvlhevfepdvafgkqpkmcsikfyxczcovrmwqxxbnhfzcjjcpgzjjfateajnnvlbwhyppdleahgaypxidkpwmfqwqyofwdqgxhjaxvyrzupfwesmxbjszolgwqvfiozofncbohduqgiswuiyddmwlwubetyaummenkdfptjczxemryuotrrymrfdxtrebpbjtpnuhsbnovhectpjhfhahbqrfbyxggobsweefcwxpqsspyssrmdhuelkkvyjxswjwofngpwfxvknkjviiavorwyfzlnktmfwxkvwkrwdcxjfzikdyswsuxegmhtnxjraqrdchaauazfhtklxsksbhwgjphgbasfnlwqwukprgvihntsyymdrfovaszjywuqygpvjtvlsvvqbvzsmgweiayhlubnbsitvfxawhfmfiatxvqrcwjshvovxknnxnyyfexqycrlyksderlqarqhkxyaqwlwoqcribumrqjtelhwdvaiysgjlvksrfvjlcaiwrirtkkxbwgicyhvakxgdjwnwmubkiazdjkfmotglclqndqjxethoutvjchjbkoasnnfbgrnycucfpeovruguzumgmgddqwjgdvaujhyqsqtoexmnfuluaqbxoofvotvfoiexbnprrxptchmlctzgqtkivsilwgwgvpidpvasurraqfkcmxhdapjrlrnkbklwkrvoaziznlpor&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> T = <span class="string">&quot;qhxepbshlrhoecdaodgpousbzfcqjxulatciapuftffahhlmxbufgjuxstfjvljybfxnenlacmjqoymvamphpxnolwijwcecgwbcjhgdybfffwoygikvoecdggplfohemfypxfsvdrseyhmvkoovxhdvoavsqqbrsqrkqhbtmgwaurgisloqjixfwfvwtszcxwktkwesaxsmhsvlitegrlzkvfqoiiwxbzskzoewbkxtphapavbyvhzvgrrfriddnsrftfowhdanvhjvurhljmpxvpddxmzfgwwpkjrfgqptrmumoemhfpojnxzwlrxkcafvbhlwrapubhveattfifsmiounhqusvhywnxhwrgamgnesxmzliyzisqrwvkiyderyotxhwspqrrkeczjysfujvovsfcfouykcqyjoobfdgnlswfzjmyucaxuaslzwfnetekymrwbvponiaojdqnbmboldvvitamntwnyaeppjaohwkrisrlrgwcjqqgxeqerjrbapfzurcwxhcwzugcgnirkkrxdthtbmdqgvqxilllrsbwjhwqszrjtzyetwubdrlyakzxcveufvhqugyawvkivwonvmrgnchkzdysngqdibhkyboyftxcvvjoggecjsajbuqkjjxfvynrjsnvtfvgpgveycxidhhfauvjovmnbqgoxsafknluyimkczykwdgvqwlvvgdmufxdypwnajkncoynqticfetcdafvtqszuwfmrdggifokwmkgzuxnhncmnsstffqpqbplypapctctfhqpihavligbrutxmmygiyaklqtakdidvnvrjfteazeqmbgklrgrorudayokxptswwkcircwuhcavhdparjfkjypkyxhbgwxbkvpvrtzjaetahmxevmkhdfyidhrdeejapfbafwmdqjqszwnwzgclitdhlnkaiyldwkwwzvhyorgbysyjbxsspnjdewjxbhpsvj&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">char</span> expected = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.FindTheDifference(S, T);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>顯然我的方向上完全錯誤，題目的意思是兩邊的每種字元個數應該會一樣，唯獨<strong>T</strong>會多插入一個隨機字元，找出那一個隨機字元，且與排序無關。</p>
<p>原本分別統計<strong>S</strong>與<strong>T</strong>包含的每個字元個數後，比較個數不一樣的即是多出來的(<del>程式就不寫了，這種暴力破解法大家都會</del>)，但總覺得哪裡不對，參考了LeetCode上面大大的答案後果然有更好的解法</p>
<p><strong>將S與T的每個字元用ASCII內碼對應的數字相加後，差即為多出來的數字</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">char</span> <span class="title">FindTheDifference</span>(<span class="params"><span class="built_in">string</span> s, <span class="built_in">string</span> t</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">int</span> sumS = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">char</span> c <span class="keyword">in</span> t)</span><br><span class="line">    &#123;</span><br><span class="line">        sumS += c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="built_in">char</span> c <span class="keyword">in</span> s)</span><br><span class="line">    &#123;</span><br><span class="line">        sumS -= c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">char</span>)(sumS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在這邊我學習到了</p>
<ul>
<li>String直接Foreach即是Char的型別(我一開始還在那拆解)</li>
<li>Char可以直接與Int相加，無須轉換</li>
</ul>
<h1 id="優化"><a href="#優化" class="headerlink" title="#優化"></a>#優化</h1><p>既然都知道T一定只比S多一個字元，那這樣雙迴圈其實也可以省略掉</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">char</span> <span class="title">FindTheDifference</span>(<span class="params"><span class="built_in">string</span> s, <span class="built_in">string</span> t</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//先加T的最後一個字元</span></span><br><span class="line">    <span class="built_in">int</span> sum = t[t.Length <span class="number">-1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; t.Length - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//T加總</span></span><br><span class="line">        sum += t[i];</span><br><span class="line">        <span class="comment">//扣掉S</span></span><br><span class="line">        sum -= s[i];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//相差的值</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">char</span>)(sum);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br></pre></td></tr></table></figure>



<h2 id="透過-運算子"><a href="#透過-運算子" class="headerlink" title="透過 ^= 運算子"></a>透過 <strong>^=</strong> 運算子</h2><p>這邊也看到另一種做法，是透過**^= ** (XOR)的運算</p>
<div class="note info">
            <p>Wiki</p><p>在數位邏輯中，邏輯算符互斥或閘（exclusive or）是對兩個運算元的一種邏輯分析類型，符號為XOR或EOR或⊕。與一般的邏輯或OR不同，當兩兩數值相同為否，而數值不同時為真。</p>
          </div>

<p><img src="/images/20180607/3.jpg"></p>
<p><strong>二進位舉例</strong></p>
<p>1111 ^  1111 =  0000</p>
<p>0000 ^  0000 =  0000</p>
<p>0101 ^  1101 =  1000</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line">a ^= <span class="number">5</span>;</span><br><span class="line"><span class="comment">//a:4</span></span><br><span class="line"></span><br><span class="line">a ^= <span class="number">5</span>;</span><br><span class="line"><span class="comment">//a:1</span></span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="number">1</span>;</span><br><span class="line">a ^= <span class="number">2</span>;</span><br><span class="line"><span class="comment">//a:3 </span></span><br><span class="line"></span><br><span class="line">a ^= <span class="number">2</span>;</span><br><span class="line"><span class="comment">//a:1</span></span><br></pre></td></tr></table></figure>



<p>所以碰到相同的數字會被返回來的特性下，可以將程式改成</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">char</span> <span class="title">FindTheDifference</span>(<span class="params"><span class="built_in">string</span> s, <span class="built_in">string</span> t</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//先加T的最後一個字元</span></span><br><span class="line">    <span class="built_in">int</span> sum = t[t.Length <span class="number">-1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; t.Length - <span class="number">1</span>; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        sum ^= t[i];</span><br><span class="line">        sum ^= s[i];</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">char</span>)(sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>這題雖然被標註為Easy，但果然一些基礎還是要多加強，否則對弱弱的我來說還是不Easy</p>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>【LeetCode】Fraction to Recurring Decimal</title>
    <url>/2018/06/27/%E3%80%90LeetCode%E3%80%91Fraction%20to%20Recurring%20Decimal/</url>
    <content><![CDATA[<h1 id="題目"><a href="#題目" class="headerlink" title="#題目"></a>#題目</h1><p>Given two integers representing the numerator and denominator of a fraction, return the fraction in string format.</p>
<p>If the fractional part is repeating, enclose the repeating part in parentheses.</p>
<p>Example 1:</p>
<div class="note info">
            <p>Input: numerator = 1, denominator = 2<br>Output: “0.5”</p>
          </div>

<p>Example 2:</p>
<div class="note info">
            <p>Input: numerator = 2, denominator = 1<br>Output: “2”</p>
          </div>

<p>Example 3:</p>
<div class="note info">
            <p>Input: numerator = 2, denominator = 3<br>Output: “0.(6)”</p>
          </div>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Solution</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">FractionToDecimal</span>(<span class="params"><span class="built_in">int</span> numerator, <span class="built_in">int</span> denominator</span>)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="解題"><a href="#解題" class="headerlink" title="#解題"></a>#解題</h1><h2 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> FractionToDecimalTest_輸入numerator_1_denominator_2()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="keyword">var</span> numerator = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> denominator = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="string">&quot;0.5&quot;</span>;</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.FractionToDecimal(numerator, denominator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">FractionToDecimal</span>(<span class="params"><span class="built_in">int</span> numerator, <span class="built_in">int</span> denominator</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">decimal</span> result = Convert.ToDecimal(numerator) / Convert.ToDecimal(denominator);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result.ToString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> FractionToDecimalTest_輸入numerator_2_denominator_1()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="keyword">var</span> numerator = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> denominator = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="string">&quot;2&quot;</span>;</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.FractionToDecimal(numerator, denominator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>直接通過測試</strong></p>
<h2 id="案例三"><a href="#案例三" class="headerlink" title="案例三"></a>案例三</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> FractionToDecimalTest_輸入numerator_2_denominator_3()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="keyword">var</span> numerator = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> denominator = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="string">&quot;0.(6)&quot;</span>;</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.FractionToDecimal(numerator, denominator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">FractionToDecimal</span>(<span class="params"><span class="built_in">int</span> numerator, <span class="built_in">int</span> denominator</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    sb.Append(numerator / denominator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//餘數</span></span><br><span class="line">    <span class="keyword">var</span> Remainder = (numerator % denominator);</span><br><span class="line">    <span class="keyword">if</span> (Remainder == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> sb.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sb.Append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> Map = <span class="keyword">new</span> Dictionary&lt;<span class="built_in">int</span>, <span class="built_in">int</span>&gt;();</span><br><span class="line">    Map.Add(Remainder, sb.Length);</span><br><span class="line">    <span class="keyword">while</span> (Remainder != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sb.Append((Remainder *<span class="number">10</span>) / denominator);</span><br><span class="line">        Remainder = (Remainder * <span class="number">10</span>) % denominator;</span><br><span class="line">        <span class="keyword">if</span> (Map.ContainsKey(Remainder))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> Index = Map[Remainder];</span><br><span class="line">            <span class="comment">//開始重複</span></span><br><span class="line">            sb.Insert(Index, <span class="string">&quot;(&quot;</span>);</span><br><span class="line">            sb.Append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map.Add(Remainder, sb.Length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sb.ToString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>關鍵在找出<strong>餘數相同時的那一刻</strong>，餘數開始重複代表規律產生了，因為餘數乘10等於下次的被除數，除數永遠不變的情況下將開始循環。</p>
<p>記錄下每次餘數當下字串的長度，當下次產生相同餘數，則從Dictionary取得上一次出現的位置補上括號即可</p>
<h1 id="解析"><a href="#解析" class="headerlink" title="#解析"></a>#解析</h1><h2 id="溢位問題"><a href="#溢位問題" class="headerlink" title="溢位問題"></a>溢位問題</h2><p>LeetCode測試錯誤</p>
<p><img src="/images/20180627/leetcode/1.jpg" alt="/images/20180627/leetcode/1.jpg"></p>
<p><img src="/images/20180627/leetcode/2.jpg" alt="/images/20180627/leetcode/2.jpg"></p>
<h3 id="補上案例"><a href="#補上案例" class="headerlink" title="補上案例"></a>補上案例</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> FractionToDecimalTest_輸入numerator_負<span class="number">2147483648</span>_denominator_負<span class="number">1</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="keyword">var</span> numerator = <span class="number">-2147483648</span>;</span><br><span class="line">    <span class="keyword">var</span> denominator = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="string">&quot;2147483648&quot;</span>;</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.FractionToDecimal(numerator, denominator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">FractionToDecimal</span>(<span class="params"><span class="built_in">int</span> numerator, <span class="built_in">int</span> denominator</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> _numerator = Convert.ToInt64(numerator);</span><br><span class="line">    <span class="keyword">var</span> _denominator = Convert.ToInt64(denominator);</span><br><span class="line">    sb.Append(_numerator / _denominator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//餘數</span></span><br><span class="line">    <span class="keyword">var</span> Remainder = (_numerator % _denominator);</span><br><span class="line">    <span class="keyword">if</span> (Remainder == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> sb.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sb.Append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> Map = <span class="keyword">new</span> Dictionary&lt;Int64, <span class="built_in">int</span>&gt;();</span><br><span class="line">    Map.Add(Remainder, sb.Length);</span><br><span class="line">    <span class="keyword">while</span> (Remainder != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sb.Append((Remainder *<span class="number">10</span>) / denominator);</span><br><span class="line">        Remainder = (Remainder * <span class="number">10</span>) % denominator;</span><br><span class="line">        <span class="keyword">if</span> (Map.ContainsKey(Remainder))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> Index = Map[Remainder];</span><br><span class="line">            <span class="comment">//開始重複</span></span><br><span class="line">            sb.Insert(Index, <span class="string">&quot;(&quot;</span>);</span><br><span class="line">            sb.Append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map.Add(Remainder, sb.Length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sb.ToString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="負數問題"><a href="#負數問題" class="headerlink" title="負數問題"></a>負數問題</h2><p><img src="/images/20180627/leetcode/3.jpg" alt="/images/20180627/leetcode/3.jpg"></p>
<h3 id="補上案例-1"><a href="#補上案例-1" class="headerlink" title="補上案例"></a>補上案例</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> FractionToDecimalTest_輸入numerator_負<span class="number">50</span>_denominator_8()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="keyword">var</span> numerator = <span class="number">-50</span>;</span><br><span class="line">    <span class="keyword">var</span> denominator = <span class="number">8</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> expected = <span class="string">&quot;-6.25&quot;</span>;</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.FractionToDecimal(numerator, denominator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果運算之中有正負號時，則可能組出來的字串為 -6.-2-5，顯然這不是我們要的，要將負號在最前面優先處理，接著後面的計算都用正數來處理</p>
<p>結果為<strong>負數</strong>，只有在兩個數為一正一負時，當兩正或兩負算出來的皆還是會正值，可以用^(XOR)來判別</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">FractionToDecimal</span>(<span class="params"><span class="built_in">int</span> numerator, <span class="built_in">int</span> denominator</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//考慮負數</span></span><br><span class="line">    sb.Append((numerator &gt;= <span class="number">0</span>) ^ (denominator &gt;= <span class="number">0</span>) ? <span class="string">&quot;-&quot;</span> : <span class="built_in">string</span>.Empty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只取正數</span></span><br><span class="line">    <span class="keyword">var</span> _numerator =Math.Abs(Convert.ToInt64(numerator));</span><br><span class="line">    <span class="keyword">var</span> _denominator = Math.Abs(Convert.ToInt64(denominator));</span><br><span class="line">    sb.Append(_numerator / _denominator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//餘數</span></span><br><span class="line">    <span class="keyword">var</span> Remainder = (_numerator % _denominator);</span><br><span class="line">    <span class="keyword">if</span> (Remainder == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> sb.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sb.Append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> Map = <span class="keyword">new</span> Dictionary&lt;Int64, <span class="built_in">int</span>&gt;();</span><br><span class="line">    Map.Add(Remainder, sb.Length);</span><br><span class="line">    <span class="keyword">while</span> (Remainder != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sb.Append((Remainder *<span class="number">10</span>) / _denominator);</span><br><span class="line">        Remainder = (Remainder * <span class="number">10</span>) % _denominator;</span><br><span class="line">        <span class="keyword">if</span> (Map.ContainsKey(Remainder))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> Index = Map[Remainder];</span><br><span class="line">            <span class="comment">//開始重複</span></span><br><span class="line">            sb.Insert(Index, <span class="string">&quot;(&quot;</span>);</span><br><span class="line">            sb.Append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map.Add(Remainder, sb.Length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sb.ToString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="被除數為0問題"><a href="#被除數為0問題" class="headerlink" title="被除數為0問題"></a>被除數為0問題</h2><p>當被除數為0時，回傳結果應為0且無關正負</p>
<p><img src="/images/20180627/leetcode/4.jpg"></p>
<h3 id="補上案例-2"><a href="#補上案例-2" class="headerlink" title="補上案例"></a>補上案例</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> FractionToDecimalTest_輸入numerator_0_denominator_負<span class="number">5</span>()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="keyword">var</span> numerator = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> denominator = <span class="number">-5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.FractionToDecimal(numerator, denominator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">FractionToDecimal</span>(<span class="params"><span class="built_in">int</span> numerator, <span class="built_in">int</span> denominator</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (numerator == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;0&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//考慮負數</span></span><br><span class="line">    sb.Append((numerator &gt;= <span class="number">0</span>) ^ (denominator &gt;= <span class="number">0</span>) ? <span class="string">&quot;-&quot;</span> : <span class="built_in">string</span>.Empty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//只取正數</span></span><br><span class="line">    <span class="keyword">var</span> _numerator =Math.Abs(Convert.ToInt64(numerator));</span><br><span class="line">    <span class="keyword">var</span> _denominator = Math.Abs(Convert.ToInt64(denominator));</span><br><span class="line">    sb.Append(_numerator / _denominator);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//餘數</span></span><br><span class="line">    <span class="keyword">var</span> Remainder = (_numerator % _denominator);</span><br><span class="line">    <span class="keyword">if</span> (Remainder == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> sb.ToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sb.Append(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> Map = <span class="keyword">new</span> Dictionary&lt;Int64, <span class="built_in">int</span>&gt;();</span><br><span class="line">    Map.Add(Remainder, sb.Length);</span><br><span class="line">    <span class="keyword">while</span> (Remainder != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        sb.Append((Remainder *<span class="number">10</span>) / _denominator);</span><br><span class="line">        Remainder = (Remainder * <span class="number">10</span>) % _denominator;</span><br><span class="line">        <span class="keyword">if</span> (Map.ContainsKey(Remainder))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> Index = Map[Remainder];</span><br><span class="line">            <span class="comment">//開始重複</span></span><br><span class="line">            sb.Insert(Index, <span class="string">&quot;(&quot;</span>);</span><br><span class="line">            sb.Append(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map.Add(Remainder, sb.Length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sb.ToString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="/images/20180627/leetcode/5.jpg" alt="/images/20180627/leetcode/5.jpg"></p>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>【LeetCode】Serialize and Deserialize BST</title>
    <url>/2018/06/09/%E3%80%90LeetCode%E3%80%91Serialize%20and%20Deserialize%20BST/</url>
    <content><![CDATA[<h1 id="題目"><a href="#題目" class="headerlink" title="#題目"></a>#題目</h1><p>Serialization is the process of converting a data structure or object into a sequence of bits so that it can be stored in a file or memory buffer, or transmitted across a network connection link to be reconstructed later in the same or another computer environment.</p>
<p>Design an algorithm to serialize and deserialize a <strong>binary search tree</strong>. There is no restriction on how your serialization/deserialization algorithm should work. You just need to ensure that a binary search tree can be serialized to a string and this string can be deserialized to the original tree structure.</p>
<p><strong>The encoded string should be as compact as possible.</strong></p>
<p><strong>Note:</strong> Do not use class member/global/static variables to store states. Your serialize and deserialize algorithms should be stateless.</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for a binary tree node.</span></span><br><span class="line"><span class="comment"> * public class TreeNode &#123;</span></span><br><span class="line"><span class="comment"> *     public int val;</span></span><br><span class="line"><span class="comment"> *     public TreeNode left;</span></span><br><span class="line"><span class="comment"> *     public TreeNode right;</span></span><br><span class="line"><span class="comment"> *     public TreeNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Codec</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Encodes a tree to a single string.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">serialize</span>(<span class="params">TreeNode root</span>)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decodes your encoded data to tree.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">deserialize</span>(<span class="params"><span class="built_in">string</span> data</span>)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Your Codec object will be instantiated and called as such:</span></span><br><span class="line"><span class="comment">// Codec codec = new Codec();</span></span><br><span class="line"><span class="comment">// codec.deserialize(codec.serialize(root));</span></span><br></pre></td></tr></table></figure>

<h1 id="解題"><a href="#解題" class="headerlink" title="#解題"></a>#解題</h1><h2 id="serialize"><a href="#serialize" class="headerlink" title="serialize"></a><strong>serialize</strong></h2><h3 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">serializeTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> node = <span class="keyword">new</span> TreeNode(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Codec();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="string">&quot;1!#!#!&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.serialize(node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Codec</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">serialize</span>(<span class="params">TreeNode root</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">string</span> res = root.val + <span class="string">&quot;!&quot;</span>;</span><br><span class="line">        res += serialize(root.left);</span><br><span class="line">        res += serialize(root.right);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decodes your encoded data to tree.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">deserialize</span>(<span class="params"><span class="built_in">string</span> data</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> serializeTest_傳入Null應回傳空字串()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Codec();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> expected = <span class="string">&quot;#!&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.serialize(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Codec</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">serialize</span>(<span class="params">TreeNode root</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;#!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> res = root.val + <span class="string">&quot;!&quot;</span>;</span><br><span class="line">        res += serialize(root.left);</span><br><span class="line">        res += serialize(root.right);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decodes your encoded data to tree.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">deserialize</span>(<span class="params"><span class="built_in">string</span> data</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例三"><a href="#案例三" class="headerlink" title="案例三"></a>案例三</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> serializeTest_有左邊子節點()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> node = <span class="keyword">new</span> TreeNode(<span class="number">1</span>);</span><br><span class="line">    node.left = <span class="keyword">new</span> TreeNode(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Codec();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="string">&quot;1!2!#!#!#!&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.serialize(node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>測試直接通過</strong></p>
<h3 id="案例四"><a href="#案例四" class="headerlink" title="案例四"></a>案例四</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> serializeTest_有右邊子節點()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> node = <span class="keyword">new</span> TreeNode(<span class="number">1</span>);</span><br><span class="line">    node.right = <span class="keyword">new</span> TreeNode(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Codec();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="string">@&quot;1!#!2!#!#!&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.serialize(node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>測試直接通過</strong></p>
<h3 id="案例五"><a href="#案例五" class="headerlink" title="案例五"></a>案例五</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> serializeTest_三層節點()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> node = <span class="keyword">new</span> TreeNode(<span class="number">1</span>);</span><br><span class="line">    node.left = <span class="keyword">new</span> TreeNode(<span class="number">2</span>);</span><br><span class="line">    node.right = <span class="keyword">new</span> TreeNode(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    node.left.left = <span class="keyword">new</span> TreeNode(<span class="number">4</span>);</span><br><span class="line">    node.right.right = <span class="keyword">new</span> TreeNode(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Codec();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="string">&quot;1!2!4!#!#!#!3!#!5!#!#!&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.serialize(node);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="圖解"><a href="#圖解" class="headerlink" title="圖解"></a>圖解</h3><p><img src="/images/20180609/1.gif" alt="/images/20180609/1.gif"></p>
<h2 id="deserialize"><a href="#deserialize" class="headerlink" title="deserialize"></a>deserialize</h2><h3 id="案例一-1"><a href="#案例一-1" class="headerlink" title="案例一"></a>案例一</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deserializeTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> nodeSerializeString = <span class="string">@&quot;1!#!#!&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Codec();</span><br><span class="line">           </span><br><span class="line">    <span class="keyword">var</span> expected = <span class="keyword">new</span> TreeNode(<span class="number">1</span>);</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.deserialize(nodeSerializeString);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Codec</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">serialize</span>(<span class="params">TreeNode root</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (root == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;#!&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">string</span> res = root.val + <span class="string">&quot;!&quot;</span>;</span><br><span class="line">        res += serialize(root.left);</span><br><span class="line">        res += serialize(root.right);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decodes your encoded data to tree.</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TreeNode <span class="title">deserialize</span>(<span class="params"><span class="built_in">string</span> data</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> nodeData = data.Split(<span class="keyword">new</span> <span class="built_in">string</span>[] &#123; <span class="string">&quot;!&quot;</span> &#125;, StringSplitOptions.RemoveEmptyEntries);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> queue = <span class="keyword">new</span> Queue&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> node <span class="keyword">in</span> nodeData)</span><br><span class="line">        &#123;</span><br><span class="line">            queue.Enqueue(node);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> RebuildNode(queue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> TreeNode <span class="title">RebuildNode</span>(<span class="params">Queue&lt;<span class="built_in">string</span>&gt; queue</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> Value = queue.Dequeue();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (Value == <span class="string">&quot;#&quot;</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        TreeNode node = <span class="keyword">new</span> TreeNode(<span class="built_in">int</span>.Parse(Value));</span><br><span class="line"></span><br><span class="line">        node.left = RebuildNode(queue);</span><br><span class="line">        node.right = RebuildNode(queue);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> node;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Queue</strong>類別為先進先出**(FIFO)<strong>，與</strong>Stack**後進先出(<strong>LIFO</strong>)使用方法相反</p>
<div class="note info">
            <p><a href="https://msdn.microsoft.com/zh-tw/library/system.collections.queue(v=vs.110).aspx">MSDN - Queue 類別</a></p>
          </div>



<h3 id="案例二-1"><a href="#案例二-1" class="headerlink" title="案例二"></a>案例二</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">deserializeTest_Null_Node</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> nodeSerializeString = <span class="string">&quot;#!&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Codec();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.deserialize(nodeSerializeString);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeNull();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>直接通過測試</strong></p>
<h3 id="案例三-1"><a href="#案例三-1" class="headerlink" title="案例三"></a>案例三</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> deserializeTest_有左邊子節點()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> nodeSerializeString = <span class="string">@&quot;1!4!#!#!#!&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Codec();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="keyword">new</span> TreeNode(<span class="number">1</span>);</span><br><span class="line">    expected.left = <span class="keyword">new</span> TreeNode(<span class="number">4</span>);</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.deserialize(nodeSerializeString);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>直接通過測試</strong></p>
<h3 id="案例四-1"><a href="#案例四-1" class="headerlink" title="案例四"></a>案例四</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> deserializeTest_有右邊子節點()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> nodeSerializeString = <span class="string">@&quot;1!#!2!#!#!&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Codec();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="keyword">new</span> TreeNode(<span class="number">1</span>);</span><br><span class="line">    expected.right = <span class="keyword">new</span> TreeNode(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.deserialize(nodeSerializeString);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>直接通過測試</strong></p>
<h3 id="案例五-1"><a href="#案例五-1" class="headerlink" title="案例五"></a>案例五</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> deserializeTest_三層節點()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> nodeSerializeString = <span class="string">@&quot;1!2!4!#!#!#!3!#!5!#!#!&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Codec();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="keyword">new</span> TreeNode(<span class="number">1</span>);</span><br><span class="line">    expected.left = <span class="keyword">new</span> TreeNode(<span class="number">2</span>);</span><br><span class="line">    expected.right = <span class="keyword">new</span> TreeNode(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    expected.left.left = <span class="keyword">new</span> TreeNode(<span class="number">4</span>);</span><br><span class="line">    expected.right.right = <span class="keyword">new</span> TreeNode(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.deserialize(nodeSerializeString);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>直接通過測試</strong></p>
<h1 id="解析"><a href="#解析" class="headerlink" title="#解析"></a>#解析</h1><p><img src="/images/20180609/2.jpg" alt="/images/20180609/2.jpg"></p>
<p>這題一樣是參考了別人的答案然後去理解，一開始搞得很複雜，想說回傳Json然後再去解析，忽略了二元樹遍歷規則，果然還要多練練才行。</p>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>【Linq】Multiple Column with OrderBy</title>
    <url>/2016/11/10/%E3%80%90Linq%E3%80%91Multiple-Column-with-OrderBy/</url>
    <content><![CDATA[<p>用Linq的好處是強型別，讓你在寫程式的時後不會因為Key錯字，但也有些衍伸的問題導致程式會寫得很醜，以前最常碰到的例子就是，當排序可能依據【多欄位】升降冪，程式就會又臭又長。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="comment">//要用來排序的欄位</span></span><br><span class="line"> OrderByColumnEnum OrderByColumn = OrderByColumnEnum.Pin;</span><br><span class="line"> <span class="comment">//排序的方法</span></span><br><span class="line"> OrderByEnum OrderBy = OrderByEnum.ASC;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//準備資料</span></span><br><span class="line"> <span class="keyword">var</span> BuildingList = <span class="keyword">new</span> List&lt;Building&gt;();</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  BuildingList.Add(<span class="keyword">new</span> Building </span><br><span class="line">  &#123;</span><br><span class="line">   Age = <span class="number">1</span> * (i+<span class="number">1</span>),</span><br><span class="line">   Pin = <span class="number">1</span> * (i+<span class="number">1</span>),</span><br><span class="line">   CaseDate = DateTime.Now.AddDays(i +<span class="number">1</span>)</span><br><span class="line">  &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//排序欄位</span></span><br><span class="line"> <span class="keyword">switch</span> (OrderByColumn)</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">case</span> OrderByColumnEnum.Pin:</span><br><span class="line">   <span class="keyword">switch</span> (OrderBy)</span><br><span class="line">   &#123;</span><br><span class="line">    <span class="keyword">case</span> OrderByEnum.ASC:</span><br><span class="line">     <span class="comment">//因為裡面用到的欄位不同,又是強型別,只能寫死...</span></span><br><span class="line">     BuildingList = BuildingList.OrderBy(x =&gt; x.Pin).ToList();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OrderByEnum.DESC:</span><br><span class="line">     BuildingList = BuildingList.OrderByDescending(x =&gt; x.Pin).ToList();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> OrderByColumnEnum.Age:</span><br><span class="line">   <span class="keyword">switch</span> (OrderBy)</span><br><span class="line">   &#123;</span><br><span class="line">    <span class="keyword">case</span> OrderByEnum.ASC:</span><br><span class="line">     BuildingList = BuildingList.OrderBy(x =&gt; x.Age).ToList();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OrderByEnum.DESC:</span><br><span class="line">     BuildingList = BuildingList.OrderByDescending(x =&gt;x.Age).ToList();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> OrderByColumnEnum.CaseDate:</span><br><span class="line">   <span class="keyword">switch</span> (OrderBy)</span><br><span class="line">   &#123;</span><br><span class="line">    <span class="keyword">case</span> OrderByEnum.ASC:</span><br><span class="line">     BuildingList = BuildingList.OrderBy(x =&gt; x.CaseDate).ToList();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> OrderByEnum.DESC:</span><br><span class="line">     BuildingList = BuildingList.OrderByDescending(x =&gt; x.CaseDate).ToList();</span><br><span class="line">     <span class="keyword">break</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line"> &#125;</span><br><span class="line"> BuildingList.Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Building</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">int</span> Pin &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">int</span> Age &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> DateTime CaseDate &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 排序欄位</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> OrderByColumnEnum</span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> 成交日期</span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"> CaseDate,</span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> 建坪</span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"> Pin,</span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> 屋齡</span></span><br><span class="line"> <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"> Age</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 排序方法</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> OrderByEnum</span><br><span class="line">&#123;</span><br><span class="line"> ASC = <span class="number">1</span>,</span><br><span class="line"> DESC = <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>因為每個欄位不同名稱,又有可能升降冪，所以寫的超級長，如果欄位達到5~6個時，幾乎已經無法維護，但其實只要搭配一點點反射可以把這段改得很漂亮的</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//要用來排序的欄位</span></span><br><span class="line"> OrderByColumnEnum OrderByColumn = OrderByColumnEnum.Pin;</span><br><span class="line"> <span class="comment">//排序的方法</span></span><br><span class="line"> OrderByEnum OrderBy = OrderByEnum.ASC;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//準備資料</span></span><br><span class="line"> <span class="keyword">var</span> BuildingList = <span class="keyword">new</span> List&lt;Building&gt;();</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  BuildingList.Add(<span class="keyword">new</span> Building </span><br><span class="line">  &#123;</span><br><span class="line">   Age = <span class="number">1</span> * (i+<span class="number">1</span>),</span><br><span class="line">   Pin = <span class="number">1</span> * (i+<span class="number">1</span>),</span><br><span class="line">   CaseDate = DateTime.Now.AddDays(i +<span class="number">1</span>)</span><br><span class="line">  &#125;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//排序欄位</span></span><br><span class="line"> <span class="keyword">var</span> param = OrderByColumnEnum.Pin.ToString();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//透過PropertyInfo操作</span></span><br><span class="line"> <span class="keyword">var</span> propertyInfo = <span class="keyword">typeof</span>(Building).GetProperty(param);</span><br><span class="line"> <span class="keyword">switch</span> (OrderBy)</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">case</span> OrderByEnum.ASC:</span><br><span class="line">   BuildingList = BuildingList.OrderBy(x =&gt; propertyInfo.GetValue(x, <span class="literal">null</span>)).ToList();</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> OrderByEnum.DESC:</span><br><span class="line">   BuildingList = BuildingList.OrderByDescending(x =&gt; propertyInfo.GetValue(x, <span class="literal">null</span>)).ToList();</span><br><span class="line">   <span class="keyword">break</span>;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> BuildingList.Dump();</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣程式是不是變得乾淨許多,但這邊要特別注意的是，因為我的Enum跟Building的屬性剛好都可以對應起來，如果我的Enum名稱與Building的屬性不能對應，那要另外寫對應方式，例如寫到擴充的Enum Attribute，或是用最簡單的Switch Case解決。</p>
]]></content>
      <tags>
        <tag>C#</tag>
        <tag>LINQ</tag>
      </tags>
  </entry>
  <entry>
    <title>【LeetCode】Poor Pigs</title>
    <url>/2018/06/19/%E3%80%90LeetCode%E3%80%91Poor%20Pigs/</url>
    <content><![CDATA[<h1 id="題目"><a href="#題目" class="headerlink" title="#題目"></a>#題目</h1><p>There are 1000 buckets, one and only one of them contains poison, the rest are filled with water. They all look the same. If a pig drinks that poison it will die within 15 minutes. What is the minimum amount of pigs you need to figure out which bucket contains the poison within one hour.</p>
<p>Answer this question, and write an algorithm for the follow-up general case.</p>
<p><strong>Follow-up:</strong></p>
<p>If there are n buckets and a pig drinking poison will die within m minutes, how many pigs (x) you need to figure out the “poison” bucket within p minutes? There is exact one bucket with poison.</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Solution</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">PoorPigs</span>(<span class="params"><span class="built_in">int</span> buckets, <span class="built_in">int</span> minutesToDie, <span class="built_in">int</span> minutesToTest</span>)</span> &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="解題"><a href="#解題" class="headerlink" title="#解題"></a>#解題</h1><p>喝下毒藥15分鐘毒發身亡，假設每15分鐘沒事就喝下一桶這樣循環，一隻豬一小時可喝下四桶水，假設中間喝到任一桶毒藥，則提前找到目標，如果沒有，則第五桶就會是毒藥。(全部五桶的狀況)</p>
<p>換句話說，假設2隻豬可以測試25桶水(二維)，依據豬隻毒發的時間可以知道哪桶水有毒</p>
<table>
<thead>
<tr>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
</tr>
</thead>
<tbody><tr>
<td>6</td>
<td>7</td>
<td>8</td>
<td>9</td>
<td>10</td>
</tr>
<tr>
<td>11</td>
<td>12</td>
<td>13</td>
<td>14</td>
<td>15</td>
</tr>
<tr>
<td>16</td>
<td>17</td>
<td>18</td>
<td>19</td>
<td>20</td>
</tr>
<tr>
<td>21</td>
<td>22</td>
<td>23</td>
<td>24</td>
<td>25</td>
</tr>
</tbody></table>
<p>豬隻A每次喝一行(1,2,3,4,5)，豬隻B每次喝一列(1,6,11,16,21)，一小時剛好可以測試25桶水，毒發時即可推測哪一桶水有毒了</p>
<p>所以公式為**(測試時間/毒發時間 + 1 ) ^  n  &gt;= 水桶數** ，求n的最小值</p>
<h2 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> PoorPigsTest_5桶水_1小時_毒發時間<span class="number">15</span>分鐘_最少需要<span class="number">1</span>隻豬來測試()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="keyword">var</span> bukets = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">var</span> minutesToDie = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">var</span> minutesToTest = <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.PoorPigs(bukets, minutesToDie, minutesToTest);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">PoorPigs</span>(<span class="params"><span class="built_in">int</span> buckets, <span class="built_in">int</span> minutesToDie, <span class="built_in">int</span> minutesToTest</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> OnePigCanTestBukets = (minutesToTest / minutesToDie) + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> Pigs = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">double</span> TotalCanTestBukets = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (TotalCanTestBukets &lt; buckets)</span><br><span class="line">    &#123;</span><br><span class="line">        Pigs++;</span><br><span class="line">        TotalCanTestBukets = Math.Pow(OnePigCanTestBukets, Pigs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Pigs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> PoorPigsTest_6桶水_1小時_毒發時間<span class="number">15</span>分鐘_最少需要<span class="number">2</span>隻豬來測試()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="keyword">var</span> bukets = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">var</span> minutesToDie = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">var</span> minutesToTest = <span class="number">60</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.PoorPigs(bukets, minutesToDie, minutesToTest);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>直接通過單元測試</strong></p>
<h1 id="解析"><a href="#解析" class="headerlink" title="#解析"></a>#解析</h1><p>LeetCode測試發生錯誤</p>
<p><img src="/images/20180619/1.jpg" alt="/images/20180619/1.jpg"></p>
<p><strong>補上案例</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> PoorPigsTest_1桶水_1分鐘測試時間_毒發時間<span class="number">1</span>分鐘_最少需要<span class="number">0</span>隻豬來測試()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="keyword">var</span> bukets = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> minutesToDie = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> minutesToTest = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> expected = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.PoorPigs(bukets, minutesToDie, minutesToTest);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().Be(expected);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一桶水根本不需要測試，所以修改一下Code</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">PoorPigs</span>(<span class="params"><span class="built_in">int</span> buckets, <span class="built_in">int</span> minutesToDie, <span class="built_in">int</span> minutesToTest</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> Pigs = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (buckets &lt;= <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> Pigs;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> OnePigCanTestBukets = (minutesToTest / minutesToDie) + <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">double</span> TotalCanTestBukets = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (TotalCanTestBukets &lt; buckets)</span><br><span class="line">    &#123;</span><br><span class="line">        Pigs++;</span><br><span class="line">        TotalCanTestBukets = Math.Pow(OnePigCanTestBukets, Pigs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Pigs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>過關</strong></p>
<p><img src="/images/20180619/2.jpg"></p>
<h2 id="心得"><a href="#心得" class="headerlink" title="心得"></a>心得</h2><p>一開始沒想清楚，想說算出一隻豬能測試幾桶後直接除即可，但這樣會發生一個狀況是剛好全部豬都活下來，那就會有一堆水桶還沒測試，參考了答案後想了一下才想通這是幾維的問題，只要讓這些豬喝下的水有交錯的可能，那有辦法推斷哪桶有毒。</p>
<p>另外Math.Pow的用法也是查了後才知道如何使用，雖然理解上不難，但也是很有收穫的一題</p>
<div class="note info">
            <p><a href="https://msdn.microsoft.com/zh-tw/library/system.math.pow(v=vs.110).aspx">MSDN - Math.Pow</a></p>
          </div>]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC】EditorTemplate (一)</title>
    <url>/2015/11/25/%E3%80%90MVC%E3%80%91EditorTemplate-%E4%B8%80/</url>
    <content><![CDATA[<p>Git範例檔下載位置 : <a href="https://github.com/toyo0103/Demo_EditTemplate_1">https://github.com/toyo0103/Demo_EditTemplate_1</a></p>
<p>MVC在View的部分要呈現資料，通常是用ViewModel的方式來傳遞。當碰到List或是Array這種重複多筆的情況時，常常就會用迴圈的方式去跑</p>
<p>例如:</p>
<p>假設有個類別CategoryViewModel</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CategoryViewModel</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> Guid id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> List&lt;product&gt; productList &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">product</span> </span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> Guid id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> name &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>在View上要呈現CategoryViewModel.productList就可能用跑回圈的方式去組成</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">@model CategoryViewModel</span><br><span class="line">@Html.TextBoxFor(x =&gt; x.id)</span><br><span class="line">@Html.TextBoxFor(x =&gt; x.name)</span><br><span class="line"><span class="comment">//ProductList</span></span><br><span class="line">@for(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Model.productList.Count; i++)</span><br><span class="line">&#123;</span><br><span class="line">    @Html.TextBoxFor(x =&gt; Model.productList[i].id)</span><br><span class="line">    @Html.TextBoxFor(x =&gt; Model.productList[i].name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣寫起View來有種又臭又長的感覺，所以可以使用MVC提供的EditorTemplate來解決，使用方法如下:</p>
<ul>
<li>  在Views &gt; Shared &gt; 新增一個EditorTemplates資料*<span style="color: red;">注意 </span>這邊資料夾名稱一定要對<div class="separator" style="clear: both; text-align: center;">[![](http://2.bp.blogspot.com/-rtO8iQJhVEE/VlUQCtIp2YI/AAAAAAAAHo8/kz86QML4Yn8/s1600/1.png)](http://2.bp.blogspot.com/-rtO8iQJhVEE/VlUQCtIp2YI/AAAAAAAAHo8/kz86QML4Yn8/s1600/1.png)</div></li>
<li>  接著在裡面新增一個<span style="color: red;">product</span>.cshtml，這邊一樣檔案名稱必須跟Class名稱相符才行</li>
<li>  然後開始編輯product.cshtml<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">@model  product</span><br><span class="line">@Html.TextBoxFor(x =&gt; x.id)</span><br><span class="line">@Html.TextBoxFor(x =&gt; x.name)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>  接著回到CategoryViewModel那邊迴圈的地方，把迴圈改成這一行即可 ```csharp<br>@Html.EditorFor(x=&gt;x.productList)</li>
</ul>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC】Client Side Validate in Partial View  with unobtrusive</title>
    <url>/2013/04/29/%E3%80%90MVC%E3%80%91Client-Side-Validate-in-Partial-View-with-unobtrusive/</url>
    <content><![CDATA[<p>MVC中很好用的一種驗證方式就是在model寫attribute </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">Required(ErrorMessage=<span class="meta-string">&quot;展覽名稱為必填&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">MaxLength(50)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> ExhibitionName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>接著在View中用HtmlHelp方式建立Textbox </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">@Html.TextBoxFor(m =&gt; m.ExhibitionName)</span><br><span class="line">@Html.ValidationMessageFor(m =&gt; m.ExhibitionName)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>MVC就會很貼心的把你的Client端驗證做好了。 </p>
<p>但今天遇到的問題是，用同樣的方法寫在Partial View裡面卻沒有用<br>狀況如下：<br>在_layout Page中一樣載入了必備的MVC4提供的Jquery驗證檔案</p>
<pre class="brush: html">&lt;script src="/Scripts/jquery.unobtrusive-ajax.js"&gt;&lt;/script&gt;
&lt;script src="/Scripts/jquery.validate.js"&gt;&lt;/script&gt;
&lt;script src="/Scripts/jquery.validate.unobtrusive.js"&gt;&lt;/script&gt;
</pre>網站頁面長成這樣
<div class="separator" style="clear: both; text-align: center;">[![](http://4.bp.blogspot.com/-WiQ8PRLsFG0/UX4vwwOgvvI/AAAAAAAACq8/ifNZBq9JUEs/s640/1.png)](http://4.bp.blogspot.com/-WiQ8PRLsFG0/UX4vwwOgvvI/AAAAAAAACq8/ifNZBq9JUEs/s1600/1.png)</div>當按下紅色框框內的功能列表，用Ajax的方式return Partial View放到藍色框框中。
[![](http://1.bp.blogspot.com/-h-0y5VY6FgE/UX4wNNMxGiI/AAAAAAAACrE/IzSGeMXQhQo/s640/1.png)](http://1.bp.blogspot.com/-h-0y5VY6FgE/UX4wNNMxGiI/AAAAAAAACrE/IzSGeMXQhQo/s1600/1.png)
但用Ajax載入的Partial View用上述的方式就不會自動驗證了，研判應該是動態產生的DOM元件沒有跟JQuery繫結到，這跟以前Asp.Net的UpdatePanel有異曲同工之妙。

<p>所以在Partial View中的Script block中加入這行 <span style="color: red;">註:#ajaxForm為Partial View中Form ID </span></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$(<span class="string">&#x27;body&#x27;</span>).on(<span class="string">&quot;click&quot;</span>, <span class="string">&#x27;.addNewExihition&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        $.validator.unobtrusive.parse(<span class="string">&#x27;.ajaxForm&#x27;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這樣JQuery的驗證就又重新繫結上了，讚!!</p>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【LeetCode】Permutations II</title>
    <url>/2018/06/06/%E3%80%90LeetCode%E3%80%91Permutations%20II/</url>
    <content><![CDATA[<p>這題寫超級久，應該是自己邏輯不好的緣故，想不出邏輯最後只好直接用TDD的撰寫方式慢慢將範圍縮小，才歸納出結果，看來我的邏輯真的要好好加強了</p>
<h1 id="題目"><a href="#題目" class="headerlink" title="#題目"></a>#題目</h1><p>Given a collection of numbers that might contain duplicates, return all possible unique permutations. </p>
<p><strong>Example</strong> </p>
<div class="note info">
            <p>Input: [1,1,2]<br>Output:<br>[<br>  [1,1,2],<br>  [1,2,1],<br>  [2,1,1]<br>]</p>
          </div>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Solution</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> IList&lt;IList&lt;<span class="built_in">int</span>&gt;&gt; PermuteUnique(<span class="built_in">int</span>[] nums) &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="解題"><a href="#解題" class="headerlink" title="#解題"></a>#解題</h1><h2 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> PermuteUniqueTest_輸入<span class="number">1</span>_1()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="built_in">int</span>[] input = <span class="keyword">new</span> <span class="built_in">int</span> []&#123; <span class="number">1</span>, <span class="number">1</span> &#125;;</span><br><span class="line">    <span class="keyword">var</span> expected = <span class="keyword">new</span> List&lt;List&lt;<span class="built_in">int</span>&gt;&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">1</span>,<span class="number">1</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line">            </span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.PermuteUnique(input);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Solution</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> IList&lt;IList&lt;<span class="built_in">int</span>&gt;&gt; PermuteUnique(<span class="built_in">int</span>[] nums)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;IList&lt;<span class="built_in">int</span>&gt;&gt;();</span><br><span class="line">        Result.Add(nums.ToList());</span><br><span class="line">        <span class="keyword">return</span> Result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> PermuteUniqueTest_輸入空Array()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="built_in">int</span>[] input = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> expected = <span class="keyword">new</span> List&lt;List&lt;<span class="built_in">int</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.PermuteUnique(input);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> IList&lt;IList&lt;<span class="built_in">int</span>&gt;&gt; PermuteUnique(<span class="built_in">int</span>[] nums)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;IList&lt;<span class="built_in">int</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nums.Length == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> Result;</span><br><span class="line"></span><br><span class="line">    Result.Add(nums.ToList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="案例三"><a href="#案例三" class="headerlink" title="案例三"></a>案例三</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> PermuteUniqueTest_輸入<span class="number">1</span>_2()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="built_in">int</span>[] input = <span class="keyword">new</span> <span class="built_in">int</span>[] &#123; <span class="number">1</span>, <span class="number">2</span> &#125;;</span><br><span class="line">    <span class="keyword">var</span> expected = <span class="keyword">new</span> List&lt;List&lt;<span class="built_in">int</span>&gt;&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">1</span>,<span class="number">2</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">2</span>,<span class="number">1</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.PermuteUnique(input);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> IList&lt;IList&lt;<span class="built_in">int</span>&gt;&gt; PermuteUnique(<span class="built_in">int</span>[] nums)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;IList&lt;<span class="built_in">int</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nums.Length == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> Result;</span><br><span class="line"></span><br><span class="line">    Result.Add(nums.ToList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; nums.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == nums.Length - <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nums[i] != nums[ i+<span class="number">1</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Swap</span></span><br><span class="line">            <span class="keyword">var</span> Temp = nums[i];</span><br><span class="line">            nums[i] = nums[i + <span class="number">1</span>];</span><br><span class="line">            nums[i + <span class="number">1</span>] = Temp;</span><br><span class="line"></span><br><span class="line">            Result.Add(nums.ToList());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="重構"><a href="#重構" class="headerlink" title="重構"></a>重構</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> IList&lt;IList&lt;<span class="built_in">int</span>&gt;&gt; PermuteUnique(<span class="built_in">int</span>[] nums)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;IList&lt;<span class="built_in">int</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nums.Length == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> Result;</span><br><span class="line"></span><br><span class="line">    Result.Add(nums.ToList());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; nums.Length; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == nums.Length - <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nums[i] != nums[ i+<span class="number">1</span>])</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//Swap</span></span><br><span class="line">            Swap(nums, i);</span><br><span class="line"></span><br><span class="line">            Result.Add(nums.ToList());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Swap</span>(<span class="params"><span class="built_in">int</span>[] nums, <span class="built_in">int</span> index</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> Temp = nums[index];</span><br><span class="line">    nums[index] = nums[index + <span class="number">1</span>];</span><br><span class="line">    nums[index + <span class="number">1</span>] = Temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="案例四"><a href="#案例四" class="headerlink" title="案例四"></a>案例四</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> PermuteUniqueTest_輸入<span class="number">1</span>_2_3()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="built_in">int</span>[] input = <span class="keyword">new</span> <span class="built_in">int</span>[] &#123; <span class="number">1</span>, <span class="number">2</span> , <span class="number">3</span>&#125;;</span><br><span class="line">    <span class="keyword">var</span> expected = <span class="keyword">new</span> List&lt;List&lt;<span class="built_in">int</span>&gt;&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">1</span>,<span class="number">3</span>,<span class="number">2</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">2</span>,<span class="number">1</span>,<span class="number">3</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">2</span>,<span class="number">3</span>,<span class="number">1</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">3</span>,<span class="number">1</span>,<span class="number">2</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>&#125;,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.PermuteUnique(input);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Solution</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> IList&lt;IList&lt;<span class="built_in">int</span>&gt;&gt; PermuteUnique(<span class="built_in">int</span>[] nums)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;IList&lt;<span class="built_in">int</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nums.Length == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line"></span><br><span class="line">        Result.Add(nums.ToList());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; nums.Length; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == nums.Length - <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> s = i + <span class="number">1</span> ; s &lt; nums.Length; s++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (nums[i] != nums[s])</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> SplitLeaft = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;(nums);</span><br><span class="line">                    Swap(SplitLeaft, i, s);</span><br><span class="line">                    Recursive(SplitLeaft, i + <span class="number">1</span>, Result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Recursive</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; nums, <span class="built_in">int</span> start, List&lt;IList&lt;<span class="built_in">int</span>&gt;&gt; result</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        result.Add(nums);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = start; i &lt; nums.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == nums.Count - <span class="number">1</span>)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (nums[start] != nums[i + <span class="number">1</span>])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> SplitLeaft = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;(nums);</span><br><span class="line">                Swap(SplitLeaft, start, i + <span class="number">1</span>);</span><br><span class="line">                Recursive(SplitLeaft, i + <span class="number">1</span>, result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Swap</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; nums, <span class="built_in">int</span> index1,<span class="built_in">int</span> index2</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> Temp = nums[index1];</span><br><span class="line">        nums[index1] = nums[index2];</span><br><span class="line">        nums[index2] = Temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="重構-1"><a href="#重構-1" class="headerlink" title="重構"></a>重構</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">partial</span> <span class="keyword">class</span> <span class="title">Solution</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> IList&lt;IList&lt;<span class="built_in">int</span>&gt;&gt; PermuteUnique(<span class="built_in">int</span>[] nums)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;IList&lt;<span class="built_in">int</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nums.Length == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line"></span><br><span class="line">        Recursive(<span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;(nums), <span class="number">0</span> , Result);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Recursive</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; nums, <span class="built_in">int</span> start, List&lt;IList&lt;<span class="built_in">int</span>&gt;&gt; result</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        result.Add(nums);</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = start; i &lt; nums.Count; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (i == nums.Count - <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = i + <span class="number">1</span>; j &lt; nums.Count; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (nums[i] != nums[j])</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> SplitLeaft = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;(nums);</span><br><span class="line">                    Swap(SplitLeaft, i, j);</span><br><span class="line">                    Recursive(SplitLeaft, i + <span class="number">1</span>, result);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Swap</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; nums, <span class="built_in">int</span> index1,<span class="built_in">int</span> index2</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">var</span> Temp = nums[index1];</span><br><span class="line">        nums[index1] = nums[index2];</span><br><span class="line">        nums[index2] = Temp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="案例五"><a href="#案例五" class="headerlink" title="案例五"></a>案例五</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> PermuteUniqueTest_輸入<span class="number">1</span>_1_2()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="built_in">int</span>[] input = <span class="keyword">new</span> <span class="built_in">int</span>[] &#123; <span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span> &#125;;</span><br><span class="line">    <span class="keyword">var</span> expected = <span class="keyword">new</span> List&lt;List&lt;<span class="built_in">int</span>&gt;&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.PermuteUnique(input);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>程式無需更動直接通過測試</strong></p>
<h1 id="分析結果"><a href="#分析結果" class="headerlink" title="#分析結果"></a>#分析結果</h1><p>LeetCode跑單元測試錯誤</p>
<p><img src="/images/20180606/1.jpg" alt="/images/20180606/1.jpg"></p>
<h2 id="補上錯誤案例"><a href="#補上錯誤案例" class="headerlink" title="補上錯誤案例"></a>補上錯誤案例</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> PermuteUniqueTest_輸入<span class="number">2</span>_2_1_1()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//arrange</span></span><br><span class="line">    <span class="keyword">var</span> sut = <span class="keyword">new</span> Solution();</span><br><span class="line">    <span class="built_in">int</span>[] input = <span class="keyword">new</span> <span class="built_in">int</span>[] &#123; <span class="number">2</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">1</span> &#125;;</span><br><span class="line">    <span class="keyword">var</span> expected = <span class="keyword">new</span> List&lt;List&lt;<span class="built_in">int</span>&gt;&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">1</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">2</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">2</span>,<span class="number">1</span>,<span class="number">2</span>,<span class="number">1</span>&#125;,</span><br><span class="line">        <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;&#123; <span class="number">2</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>&#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//act</span></span><br><span class="line">    <span class="keyword">var</span> actual = sut.PermuteUnique(input);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//assert</span></span><br><span class="line">    actual.Should().BeEquivalentTo(expected);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> IList&lt;IList&lt;<span class="built_in">int</span>&gt;&gt; PermuteUnique(<span class="built_in">int</span>[] nums)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;IList&lt;<span class="built_in">int</span>&gt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nums.Length == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> Result;</span><br><span class="line"></span><br><span class="line">    Recursive(<span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;(nums), <span class="number">0</span> , Result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Recursive</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; nums, <span class="built_in">int</span> start, List&lt;IList&lt;<span class="built_in">int</span>&gt;&gt; result</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    result.Add(nums);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = start; i &lt; nums.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        HashSet&lt;<span class="built_in">int</span>&gt; used = <span class="keyword">new</span> HashSet&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">        <span class="keyword">if</span> (i == nums.Count - <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> j = i + <span class="number">1</span>; j &lt; nums.Count; j++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (nums[i] != nums[j])</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (used.Contains(nums[j]))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    used.Add(nums[j]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> SplitLeaft = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;(nums);</span><br><span class="line">                Swap(SplitLeaft, i, j);</span><br><span class="line">                Recursive(SplitLeaft, i + <span class="number">1</span>, result);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Swap</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; nums, <span class="built_in">int</span> index1,<span class="built_in">int</span> index2</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> Temp = nums[index1];</span><br><span class="line">    nums[index1] = nums[index2];</span><br><span class="line">    nums[index2] = Temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這邊的原因是，同一個位置只需要跟相同的數字互換一次即可，因為遞迴會把後面的各種可能補上，否則會發生重複的排列組合</p>
<hr>
<p><strong>1,1,2,2</strong>,   <strong>index[0] 與後面所有後面的數相比</strong></p>
<ul>
<li><p><strong>1,1,2,2</strong>  (index[0] = 1與index[1] = 1相同，不做動作)</p>
</li>
<li><p><strong>2,1,1,2</strong>  (index[0] = 1與index[2] = 2不相同，互換並產生支線)</p>
<ul>
<li>2,1,1,2  (index[1] = 1與index[2] = 1相同，不做動作)</li>
<li><strong>2,2,1,1</strong>  (index[1] = 1與index[3] = 2不相同，互換並產生支線)<ul>
<li>2,2,1,1  (index[2] = 1與index[3] = 1相同，不做動作，支線遞迴結束)</li>
</ul>
</li>
<li><strong>2,1,2,1</strong>  (index[2] = 1與index[3] = 2不相同，互換並產生支線)</li>
</ul>
</li>
<li><p>1,1,1,2  (index[0] = 1與index[3] = 2不相同，但之前跟2互換過一次，所以不做動作)</p>
</li>
</ul>
<hr>
<p><strong>1,1,2,2</strong> , <strong>index[1] 與後面所有後面的數相比</strong></p>
<ul>
<li><strong>1,2,1,2</strong>  (index[1] = 1與index[2] = 2不相同，互換並產生支線)<ul>
<li><strong>1,2,2,1</strong>(index[2] = 1與index[3] = 2不相同，互換並產生支線)<ul>
<li>走到最末端，遞迴結束</li>
</ul>
</li>
</ul>
</li>
<li>1,1,2,2  (index[1] = 1與index[3] = 2不相同，但之前跟2互換過一次，所以不做動作)</li>
</ul>
<p><strong>這邊如果互換的話將導致重複的數列出現</strong></p>
<p>…….以下省略…..</p>
<p><img src="/images/20180606/2.jpg" alt="/images/20180606/2.jpg"></p>
]]></content>
      <categories>
        <category>LeetCode</category>
      </categories>
      <tags>
        <tag>LeetCode</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC】PartialView傳值導致ViewBag的值變為null</title>
    <url>/2013/08/26/%E3%80%90MVC%E3%80%91PartialView%E5%82%B3%E5%80%BC%E5%B0%8E%E8%87%B4ViewBag%E7%9A%84%E5%80%BC%E8%AE%8A%E7%82%BAnull/</url>
    <content><![CDATA[<ul>
<li>  如果在呼叫PartialView時用以下傳值方式 ```csharp<br>//透過第三個參數用ViewDataDictionary的方式傳遞參數，會導致之前存的ViewBag的值在PartialView裡面變成Null讀不到<br>@Html.Partial(“_at_article_endlink”, linklist,new ViewDataDictionary { { “linktitle”, Model.LINKTITLE } })</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   最後改良的方式變成在外面先存成ViewBag的值，接下來PartialView裡面就一切正常了 &#96;&#96;&#96;csharp</span><br><span class="line">@&#123;ViewBag.linktitle &#x3D; na.LINKTITLE;&#125;</span><br><span class="line">@Html.Partial(&quot;_at_article_endlink&quot;, linklist)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC】EditorTemplate (二) 動態新增欄位</title>
    <url>/2015/12/03/%E3%80%90MVC%E3%80%91EditorTemplate-%E4%BA%8C-%E5%8B%95%E6%85%8B%E6%96%B0%E5%A2%9E%E6%AC%84%E4%BD%8D/</url>
    <content><![CDATA[<p>此篇範例程式 :&nbsp;<a href="https://github.com/toyo0103/Demo_EditTemplate_1">下載</a>&nbsp; (此範例在DynamicController之中)</p>
<p>呈上一篇，<a href="http://toyo0103.blogspot.tw/2015/11/mvceditortemplate.html">EditorTemplate (一)</a>&nbsp;我們可以來看到產生的原始碼如下</p>
<p><a href="http://4.bp.blogspot.com/-d6YKMUo8KHw/Vl_i8moc4SI/AAAAAAAAHpY/3TmepPGrLM0/s1600/1.png"><img src="http://4.bp.blogspot.com/-d6YKMUo8KHw/Vl_i8moc4SI/AAAAAAAAHpY/3TmepPGrLM0/s640/1.png"></a></p>
<p>Name的部分是由 <strong>productList[<span style="color: red;">index</span>].屬性名</strong>組成，換句話說，如果今天要由前端動態新增一筆書籍資料，則必須按照這個規則編排下去，後端才能透過ViewModel的方式取得書籍資料</p>
<p><a href="http://2.bp.blogspot.com/-1JBalONSmnM/Vl_rHHO8ZtI/AAAAAAAAHpo/m25Vs9XyOQs/s1600/1.png"><img src="http://2.bp.blogspot.com/-1JBalONSmnM/Vl_rHHO8ZtI/AAAAAAAAHpo/m25Vs9XyOQs/s640/1.png"></a></p>
<p><a href="http://3.bp.blogspot.com/-dHvZHH7TzU8/Vl_sLZzIAbI/AAAAAAAAHp0/zbw9eAreaLY/s1600/1.png"><img src="http://3.bp.blogspot.com/-dHvZHH7TzU8/Vl_sLZzIAbI/AAAAAAAAHp0/zbw9eAreaLY/s640/1.png"></a></p>
<p>看起來一切美好圓滿，但如果今天的列表是可以新增之外，還要能動態刪除呢?<br>是不是我的[<span style="color: red;">index</span>]就要一直重新計算，不然送到後端就會不見了</p>
<div class="note info">
            <p>*如果今天有4個textbox但是name分別是<br>productList[0].id<br>productList[1].id<br>productList[2].id<br>productList[5].id<br>這樣後端只會拿到0~2的ID,不按照順序編排的就會消失</p>
          </div>

<p>還好.NET其實提供另外一種方式來繫結ViewModel</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;productList.Index&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0072b890-0e1a-4c93-a5a7-9cafe84b65f8&quot;</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">input</span>  <span class="attr">id</span>=<span class="string">&quot;productList_0072b890-0e1a-4c93-a5a7-9cafe84b65f8__id&quot;</span> <span class="attr">name</span>=<span class="string">&quot;productList[0072b890-0e1a-4c93-a5a7-9cafe84b65f8].id&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> &gt;</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣的話就可以不用管排序，自由的新增刪除List的項目，但EditorTemplate也需要改一改，不然EditTemplate產出的是[0]這種格是,但是前端產出的格是是[Guid],這樣會有問題。</p>
<p>所以EditTemplate改成用這個方法產出<br><strong><span style="color: #134f5c;">*</span></strong><span style="color: red;"><strong><span style="color: #134f5c;">以下程式碼轉載自:</span></strong><span style="color: red;"> &nbsp;</span></span><br>搞搞就懂 - 點部落 :<strong><span style="color: #38761d;"><a href="https://www.dotblogs.com.tw/wasichris/2014/11/15/147320">[ASP Net MVC] 如何綁定可動態新增或移除之資料集合(EditorTemplate)</a></span></strong></p>
<ul>
<li><p>新增一組HtmlHelper ```csharp<br>public static MvcHtmlString EditorForMany&lt;TModel, TValue&gt;(</p>
<pre><code>      this HtmlHelper&lt;TModel&gt; html,
      Expression&lt;Func&lt;TModel, IEnumerable&lt;TValue&gt;&gt;&gt; expression,
      string htmlFieldName = null) where TModel : class
  &#123;
      var items = expression.Compile()(html.ViewData.Model);
      var sb = new StringBuilder();
      var hasPrefix = false;

          if (String.IsNullOrEmpty(htmlFieldName))
      &#123;
          var prefix = html.ViewContext.ViewData.TemplateInfo.HtmlFieldPrefix;
          hasPrefix = !String.IsNullOrEmpty(prefix);
          htmlFieldName = (prefix.Length &gt; 0 ? (prefix + &quot;.&quot;) : String.Empty) + ExpressionHelper.GetExpressionText(expression);
      &#125;

          if (items != null)
      &#123;
          foreach (var item in items)
          &#123;
              var dummy = new &#123; Item = item &#125;;
              var guid = Guid.NewGuid().ToString();

                  var memberExp = Expression.MakeMemberAccess(Expression.Constant(dummy), dummy.GetType().GetProperty(&quot;Item&quot;));
              var singleItemExp = Expression.Lambda&lt;Func&lt;TModel, TValue&gt;&gt;(memberExp, expression.Parameters);

                  sb.Append(String.Format(@&quot;&lt;input type=&quot;&quot;hidden&quot;&quot; name=&quot;&quot;&#123;0&#125;.Index&quot;&quot; value=&quot;&quot;&#123;1&#125;&quot;&quot; /&gt;&quot;, htmlFieldName, guid));
              sb.Append(html.EditorFor(singleItemExp, null, String.Format(&quot;&#123;0&#125;[&#123;1&#125;]&quot;, hasPrefix ? ExpressionHelper.GetExpressionText(expression) : htmlFieldName, guid)));
          &#125;
      &#125;
      return new MvcHtmlString(sb.ToString());
  &#125;
</code></pre>
<p>  }</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   原本EditorFor改成自訂的EditorForMany &#96;&#96;&#96;html</span><br><span class="line">@Html.EditorFor(x &#x3D;&gt; x.productList)</span><br><span class="line">@Html.EditorForMany(x &#x3D;&gt; x.productList)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣產出來的格式就會是帶Guid的方式了，可以正常跟前端結合了<br><a href="http://4.bp.blogspot.com/-MWd6XGNYWKk/VmAD0shPP6I/AAAAAAAAHqE/0sgP3d0uidU/s1600/1.png"><img src="http://4.bp.blogspot.com/-MWd6XGNYWKk/VmAD0shPP6I/AAAAAAAAHqE/0sgP3d0uidU/s640/1.png"></a></p>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC】One View Two Models --  tuple or ViewModel</title>
    <url>/2013/04/29/%E3%80%90MVC%E3%80%91One-View-Two-Models-tuple-or-ViewModel/</url>
    <content><![CDATA[<p>如果有個View同時需要載入兩個model時可以使用tuple ```html<br>@model Tuple&lt;IEnumerable&lt;NTI.Models.ExhibitionList&gt;,NTI.Models.ExhibitionList&gt;</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">**Model**&#96;&#96;&#96;csharp</span><br><span class="line">public class ExhibitionList </span><br><span class="line">&#123;</span><br><span class="line">   [Required]</span><br><span class="line">   [MaxLength(50)]</span><br><span class="line">   public string ExhibitionName &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">   public DateTime CreateDate &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">   public DateTime EditDate &#123; get; set; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Controller</strong>```csharp<br>public ActionResult ExhibitionList()<br>{<br>   var tuple = new Tuple&lt;IEnumerable<ExhibitionList>, ExhibitionList&gt;(Repository.GetExhibitionList(), new ExhibitionList());<br>   return PartialView(tuple);<br>}</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">**View**&#96;&#96;&#96;html</span><br><span class="line">if (Model.Item1.Count() &#x3D;&#x3D; 0)</span><br><span class="line">&#123;</span><br><span class="line">   &lt;tr id&#x3D;&quot;noExhibition&quot;&gt;</span><br><span class="line">   &lt;td colspan&#x3D;&quot;4&quot;&gt;</span><br><span class="line">   &lt;span class&#x3D;&quot;text-left&quot;&gt;沒有建立任何展覽喔....&lt;&#x2F;span&gt;</span><br><span class="line">   &lt;&#x2F;td&gt;</span><br><span class="line">   &lt;&#x2F;tr&gt;     </span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">   foreach (var exhibitionItem in Model.Item1)</span><br><span class="line">   &#123;</span><br><span class="line">      &lt;tr&gt;</span><br><span class="line">      &lt;td&gt;1&lt;&#x2F;td&gt;</span><br><span class="line">      &lt;td&gt;@exhibitionItem.ExhibitionName&lt;&#x2F;td&gt;</span><br><span class="line">      &lt;td&gt;@exhibitionItem.CreateDate&lt;&#x2F;td&gt;</span><br><span class="line">      &lt;td&gt;@exhibitionItem.EditDate&lt;&#x2F;td&gt;</span><br><span class="line">      &lt;&#x2F;tr&gt;</span><br><span class="line">   &#125;</span><br><span class="line">   @Html.TextBoxFor(m &#x3D;&gt; Model.Item2.ExhibitionName)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在View中使用Model的方法為：<br><strong>Model.Item1</strong>代表載入的第一個Model<br><strong>Model.Item2</strong>代表載入的第二個Model</p>
<p>第二種方式就是建立一個ViewModel的方式<br><strong>Model</strong>```csharp<br>/// 展覽列表的ViewModel<br>public class ExhibitionListViewModel<br>{<br>  public IEnumerable<ExhibitionList> IEmumerable_ExhibitionList { get; set; }<br>  public ExhibitionList ExhibitionListModel { get; set; }<br>}</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">**View**&#96;&#96;&#96;csharp</span><br><span class="line">public ActionResult ExhibitionList() </span><br><span class="line">&#123;</span><br><span class="line">   ExhibitionListViewModel model &#x3D; new ExhibitionListViewModel();</span><br><span class="line">   model.IEmumerable_ExhibitionList &#x3D; Repository.GetExhibitionList();</span><br><span class="line">   model.ExhibitionListModel &#x3D; new ExhibitionList();</span><br><span class="line">   return PartialView(model);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>Controller</strong>```csharp<br>@Html.TextBoxFor(model =&gt; model.ExhibitionListModel.ExhibitionName)<br>@Html.ValidationMessageFor(model =&gt; model.ExhibitionListModel.ExhibitionName)</p>
<p>//and ….<br>if (Model.IEmumerable_ExhibitionList.Count() == 0)<br>{<br>  //do something<br>}</p>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC】MVC上傳圖片</title>
    <url>/2013/09/09/%E3%80%90MVC%E3%80%91MVC%E4%B8%8A%E5%82%B3%E5%9C%96%E7%89%87/</url>
    <content><![CDATA[<ol>
<li>View ```csharp<br>@using (Html.BeginForm(“edit”, “group”, FormMethod.Post, new { enctype = “multipart/form-data” }))<br>{<div class="form-group">
<label for="picturl">圖片</label>
<input type="file" id="picture" name="picture" />
</div>
}</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">2.  Controller，這邊特別注意&lt;span style&#x3D;&quot;color: blue;&quot;&gt;HttpPostedFileBase&lt;&#x2F;span&gt; picture的參數名稱要與View file的name相同 &#96;&#96;&#96;csharp</span><br><span class="line">public ActionResult AddExhibitionItem(string name, string sort,string stop ,HttpPostedFileBase picture)</span><br><span class="line">&#123;</span><br><span class="line">   string err&#x3D; string.Empty;</span><br><span class="line">   if (ExhibitionUtilFactory.AddItem(name, sort, stop, picture, ref err))</span><br><span class="line">   &#123;</span><br><span class="line">     return Content(&quot;&lt;script&gt;alert(&#39;新增成功&#39;);window.parent.closeDialog();&lt;&#x2F;script&gt;&quot;);</span><br><span class="line">   &#125;</span><br><span class="line">   else   &#123;</span><br><span class="line">      TempData[&quot;alert&quot;] &#x3D; err;</span><br><span class="line">      return View();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>如果是多檔上傳的話，View ```csharp<div class="form-group">
<label for="picturl">圖片</label>
<input type="file" id="picture1" name="picture" />
<input type="file" id="picture2" name="picture" />
<input type="file" id="picture3" name="picture" />
</div></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">4.  Controller &#96;&#96;&#96;csharp</span><br><span class="line">public ActionResult AddExhibitionItem(string name, string sort,string stop ,IEnumerable&lt;HttpPostedFileBase&gt; picture)</span><br><span class="line">&#123;</span><br><span class="line">   foreach (var file in picture)   &#123;</span><br><span class="line">     ............   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC】Router Constraint</title>
    <url>/2017/11/16/%E3%80%90MVC%E3%80%91Router-Constraint/</url>
    <content><![CDATA[<p>當今天有個網址的需求是 <a href="http://abcdefg.com/%E3%80%90%E4%BD%BF%E7%94%A8%E8%80%85%E6%9A%B1%E7%A8%B1%E3%80%91%EF%BC%8C%E4%BD%BF%E7%94%A8%E8%80%85%E6%9A%B1%E7%A8%B1%E5%B8%B6%E5%88%B0%E8%AA%B0%E7%9A%84%E5%B0%B1%E6%9C%83%E5%88%B0%E5%80%8B%E4%BA%BA%E9%A0%81%E7%B6%B2%E5%9D%80%EF%BC%8CEX">http://abcdefg.com/【使用者暱稱】，使用者暱稱帶到誰的就會到個人頁網址，EX</a> : <a href="http://abcdefg.com/toyo">http://abcdefg.com/toyo</a> 就連到Toyo個人頁面，<a href="http://abcdefg.com/steven%E5%B0%B1%E9%80%A3%E5%88%B0Steven%E5%80%8B%E4%BA%BA%E9%A0%81%EF%BC%8C%E9%82%A3%E6%88%91%E5%80%91Router%E5%8F%AF%E4%BB%A5%E5%AF%AB%E6%88%90">http://abcdefg.com/steven就連到Steven個人頁，那我們Router可以寫成</a></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="meta-string">&quot;~/toyo&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">Route(<span class="meta-string">&quot;~/steven&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Content</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這樣寫的確兩個網址都能連到了，但卻抓不到UserName所以不知道怎麼顯示個人頁，調整一下 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="meta-string">&quot;~/&#123;UserName&#125;&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Content</span>(<span class="params"><span class="built_in">string</span> userName</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   ViewBag.Name = userName;</span><br><span class="line">   <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>下個問題來了，Tom明明不是這邊的用戶，卻也會導到這個Action，導致後端抓不到對應資料顯示錯誤，能不能只有abcdefg.com/Toyo 跟 abcdefg.com/Steven 的時候才導來這，其他什麼阿貓阿狗，甚至是常用的Index、Home、Menu之類的不會跑錯。</p>
<p>這時候RouteConstraint就派上用場了</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserNameConstraint</span> : <span class="title">IRouteConstraint</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Match</span>(<span class="params">HttpContextBase httpContext, Route route, <span class="built_in">string</span> parameterName, RouteValueDictionary values, RouteDirection routeDirection</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (values.ContainsKey(parameterName))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> UserName = values[parameterName] <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> UserName.ToLower() == <span class="string">&quot;toyo&quot;</span> ||</span><br><span class="line">                   UserName.ToLower() == <span class="string">&quot;steven&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接著在RouteConfig註冊這組Constraint，讓RouteAttribute可以使用 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RouteConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RegisterRoutes</span>(<span class="params">RouteCollection routes</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        routes.IgnoreRoute(<span class="string">&quot;&#123;resource&#125;.axd/&#123;*pathInfo&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//註冊Router ConStraint</span></span><br><span class="line">        <span class="keyword">var</span> constraintsResolver = <span class="keyword">new</span> DefaultInlineConstraintResolver();</span><br><span class="line">        constraintsResolver.ConstraintMap.Add(<span class="string">&quot;MustUserName&quot;</span>, <span class="keyword">typeof</span>(UserNameConstraint));</span><br><span class="line">        routes.MapMvcAttributeRoutes(constraintsResolver);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>將RouteAttribute的UserName加上這個限制 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="meta-string">&quot;~/&#123;UserName:MustUserName&#125;&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">MyContent</span>(<span class="params"><span class="built_in">string</span> userName</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ViewBag.Name = userName;</span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>這樣只要UserName不是帶Toyo或是Steven的就都不會導到這個Action了。</p>
<p>其實RouteConstraint官方已經提供一下基礎的限制可以使用，例如一定要是Int，字串長度之類的方便用法，而且更重要的是在這案例之中，使用者名稱我們是寫死的，只要把那段改成抓外部來源，例如資料庫之類的，這樣就能後台使用者有新增時，Route的限制就自動更新了</p>
<p>延伸閱讀:<br><a href="https://blogs.msdn.microsoft.com/webdev/2013/10/17/attribute-routing-in-asp-net-mvc-5/">Attribute Routing in ASP.NET MVC 5</a><br> <a href="http://demo.tc/post/786">DemoShop :&nbsp;ASP.NET MVC Route 自訂限制條件（constraints）的技巧</a></p>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC】回傳Json格式，並用JQuery解讀</title>
    <url>/2013/05/07/%E3%80%90MVC%E3%80%91%E5%9B%9E%E5%82%B3Json%E6%A0%BC%E5%BC%8F%EF%BC%8C%E4%B8%A6%E7%94%A8JQuery%E8%A7%A3%E8%AE%80/</url>
    <content><![CDATA[<p>View中回傳Json格式的物件 ```csharp<br>var jsonObject = JsonConvert.SerializeObject(Repository.GetExhibitionList().OrderBy(o =&gt; o.CreateDate).ToArray());<br>return Json(jsonObject);</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">JQuery中解讀 &#96;&#96;&#96;javascript</span><br><span class="line">var List &#x3D; $.parseJSON(returnvalue);</span><br><span class="line"></span><br><span class="line">var tr &#x3D; [];</span><br><span class="line">&#x2F;&#x2F;轉換日期格式</span><br><span class="line">$.each(List, function (index, val) &#123;</span><br><span class="line"></span><br><span class="line">    tr.push(&#39;&lt;tr class&#x3D;&quot;exhibitionItem&quot;&gt;&#39; +</span><br><span class="line">            &#39;&lt;td&gt;&#39; + (index + 1) + &#39;&lt;&#x2F;td&gt;&#39; +</span><br><span class="line">            &#39;&lt;td&gt;&#39; + val.ExhibitionName + &#39;&lt;&#x2F;td&gt;&#39; +</span><br><span class="line">            &#39;&lt;td&gt;&#39; + val.CreateDate + &#39;&lt;&#x2F;td&gt;&#39; +</span><br><span class="line">            &#39;&lt;td&gt;&#39; + val.EditDate + &#39;&lt;&#x2F;td&gt;&#39; +</span><br><span class="line">           &#39;&lt;&#x2F;tr&gt;&#39;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>JSON</tag>
        <tag>MVC</tag>
        <tag>JQuery</tag>
      </tags>
  </entry>
  <entry>
    <title>[swift] IOS地圖運用 (4) 如何區分是User Location與Annotation</title>
    <url>/2015/03/03/swift-IOS%E5%9C%B0%E5%9C%96%E9%81%8B%E7%94%A8-4-%E5%A6%82%E4%BD%95%E5%8D%80%E5%88%86%E6%98%AFUser-Location%E8%88%87Annotation/</url>
    <content><![CDATA[<ul>
<li>  接著上一篇,如果這時候我們再把mapkit view的user location打開來試試看,結果會發現user location的點被吃掉了,原因是我們改寫了viewForAnnotation,所有的點都會變成我們客製座標的樣式<br><a href="http://4.bp.blogspot.com/-9qviobZt9JE/VPVvfQ0kraI/AAAAAAAAEdM/bYPxX4HccxE/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%884.23.15.png"><img src="http://4.bp.blogspot.com/-9qviobZt9JE/VPVvfQ0kraI/AAAAAAAAEdM/bYPxX4HccxE/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%884.23.15.png"></a></li>
<li>所以我們在viewForAnnotation補上判斷,讓user location不會被改變樣式 ```swift<br>func mapView(mapView: MKMapView!, viewForAnnotation annotation: MKAnnotation!) -&gt; MKAnnotationView! {<pre><code>  if(annotation is MKUserLocation)&#123;
      //return nil表示用預設值那個藍色發光圓形圖
      return nil;
  &#125;
  var ann : MyAnnotation? = mapView.dequeueReusableAnnotationViewWithIdentifier(&quot;CustomerPoint&quot;) as? MyAnnotation;
  if(ann == nil)&#123;
      ann = MyAnnotation(annotation: annotation, reuseIdentifier: &quot;CustomerPoint&quot;);
      ann?.canShowCallout = true;
  &#125;
  ann?.DrawCustomerView();
  ann?.annotation = annotation;
  return ann;
</code></pre>
}</li>
</ul>
<p>```<br>結果如下,user location又出來摟～<br><a href="http://2.bp.blogspot.com/-qYW44ZGAdl8/VPVxakiXQJI/AAAAAAAAEdY/tD0JfPFvwSM/s1600/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%884.31.11.png"><img src="http://2.bp.blogspot.com/-qYW44ZGAdl8/VPVxakiXQJI/AAAAAAAAEdY/tD0JfPFvwSM/s400/%E8%9E%A2%E5%B9%95%E5%BF%AB%E7%85%A7%2B2015-03-03%2B%E4%B8%8B%E5%8D%884.31.11.png"></a></p>
]]></content>
      <tags>
        <tag>ios</tag>
        <tag>swift</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC】呼叫ELMAH(艾爾瑪)</title>
    <url>/2013/09/10/%E3%80%90MVC%E3%80%91%E5%91%BC%E5%8F%ABELMAH-%E8%89%BE%E7%88%BE%E7%91%AA/</url>
    <content><![CDATA[<ol>
<li> 首先透過NuGet安裝以下四個套件<br><a href="http://4.bp.blogspot.com/-g5uyW8Gr3q4/Ui6x2FhNC5I/AAAAAAAAEGI/V3oY_1L3fRM/s1600/111.png"><img src="http://4.bp.blogspot.com/-g5uyW8Gr3q4/Ui6x2FhNC5I/AAAAAAAAEGI/V3oY_1L3fRM/s1600/111.png"></a></li>
<li>打開WebConfig可以找到以下設定 ```xml<add key="elmah.mvc.disableHandler" value="false" />
 <add key="elmah.mvc.disableHandleErrorFilter" value="false" />
 //是否需要權限才能閱讀這個Log，當然是True啦!!
 <add key="elmah.mvc.requiresAuthentication" value="true" />
 //是否停用原本預設調用Log的"網址/elmah"路徑
 <add key="elmah.mvc.IgnoreDefaultRoute" value="true" />
 //如果權限設定為true的話，何種role可以調用Log
 <add key="elmah.mvc.allowedRoles" value="*" />
 //那些登入者可以調用Log 多人時用逗號分開
 <add key="elmah.mvc.allowedUsers" value="admin" />
 //設定調用Elmah Log的MVC Route
 <add key="elmah.mvc.route" value="showme/elmah" /></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">3.  刪除掉WebConfig的以下區段，所有人都不法透過&quot;網址&#x2F;elmah.axd&quot;來讀取Log檔案(包含本機) &#96;&#96;&#96;xml</span><br><span class="line">&lt;location path&#x3D;&quot;elmah.axd&quot; inheritInChildApplications&#x3D;&quot;false&quot;&gt;</span><br><span class="line">...略...</span><br><span class="line">&lt;&#x2F;location&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="4">
<li> ELMAH還有很多不錯的功能，例如將錯誤Log寫到DB裡面去，或是主動寄信通知設定。但目前還用不上就先不研究了!!5.  實際上看到Log的紀錄 <a href="http://2.bp.blogspot.com/-iq0eilWQM3I/Ui62QPdQjdI/AAAAAAAAEGU/Z-En3V0VNcs/s1600/111.png"><img src="http://2.bp.blogspot.com/-iq0eilWQM3I/Ui62QPdQjdI/AAAAAAAAEGU/Z-En3V0VNcs/s1600/111.png"></a><br>按下Detail後的詳細資訊，說實在還滿棒的~ <a href="http://1.bp.blogspot.com/-GlAKlQ4QR-0/Ui62tKwlhbI/AAAAAAAAEGc/ha1udHCOTPQ/s1600/111.png"><img src="http://1.bp.blogspot.com/-GlAKlQ4QR-0/Ui62tKwlhbI/AAAAAAAAEGc/ha1udHCOTPQ/s1600/111.png"></a></li>
</ol>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC】多語系</title>
    <url>/2017/11/17/%E3%80%90MVC%E3%80%91%E5%A4%9A%E8%AA%9E%E7%B3%BB/</url>
    <content><![CDATA[<p>網站如果希望能提供多語系版本，且網址規則如下該如何實作?</p>
<p><a href="http://abcdefg.com/index">http://abcdefg.com/index</a>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;【預設繁體中文】<br><a href="http://abcdefg.com/zh-TW/index">http://abcdefg.com/zh-TW/index</a> 【繁體中文】<br><a href="http://abcdefg.com/zh-CN/index">http://abcdefg.com/zh-CN/index</a>&nbsp; 【簡體中文】<br><a href="http://abcdefg.com/en-US/index">http://abcdefg.com/en-US/index</a>&nbsp; 【英文】</p>
<p>先從Action開始，挖個Route參數來抓目前使用者希望的語系為何，並且設定Culture<br><span style="color: #999999;">(因為重點是多語系範例，所以就不考慮大小寫判斷那些，還請暫時忽略)</span></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="meta-string">&quot;~/index&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">Route(<span class="meta-string">&quot;~/&#123;culture&#125;/index&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>(<span class="params"><span class="built_in">string</span> culture</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (culture)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;zh-CN&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;en-US&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="literal">default</span>:</span><br><span class="line">            culture = <span class="string">&quot;zh-TW&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//設定多語系</span></span><br><span class="line">    CultureInfo ci = <span class="keyword">new</span> CultureInfo(culture);</span><br><span class="line">    Thread.CurrentThread.CurrentCulture = ci;</span><br><span class="line">    Thread.CurrentThread.CurrentUICulture = CultureInfo.CreateSpecificCulture(ci.Name);</span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>接著新增語系檔資料夾<strong>App_GlobalResource</strong><br><span style="font-weight: normal;">專案右鍵&nbsp; &gt;&nbsp; 加入&nbsp; &gt; 加入ASP.NET資料夾 &gt; App_GlobalResource</span></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-X0T0qbHbM4g/Wg5DB8tdjCI/AAAAAAAAIQc/OFuD0klzB4sOBimU6auOHx-nduJNgxSagCLcBGAs/s640/1.png)](https://1.bp.blogspot.com/-X0T0qbHbM4g/Wg5DB8tdjCI/AAAAAAAAIQc/OFuD0klzB4sOBimU6auOHx-nduJNgxSagCLcBGAs/s1600/1.png)</div>

<p><span style="font-weight: normal;">新增對應語系的設定檔</span><span style="font-weight: normal;">App_GlobalResources右鍵&nbsp; &gt;&nbsp; 加入&nbsp; &gt; 資源檔</span></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-yDb53fw_k78/Wg5Dp4kiDQI/AAAAAAAAIQk/7nBQ-vbv1PcOVvNkoS1H6QpdHvBZIIV-ACLcBGAs/s640/2.png)](https://2.bp.blogspot.com/-yDb53fw_k78/Wg5Dp4kiDQI/AAAAAAAAIQk/7nBQ-vbv1PcOVvNkoS1H6QpdHvBZIIV-ACLcBGAs/s1600/2.png)</div>**
****
**
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-7b1G9a0T0Ec/Wg5EFbj8FoI/AAAAAAAAIQo/xi6QYst8RssqaLd6fxDr9avHWL9XwtCdACLcBGAs/s1600/3.png)](https://2.bp.blogspot.com/-7b1G9a0T0Ec/Wg5EFbj8FoI/AAAAAAAAIQo/xi6QYst8RssqaLd6fxDr9avHWL9XwtCdACLcBGAs/s1600/3.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">這邊的資源檔名稱是固定的，不能任意更改</td></tr></tbody></table>**
**
在各個設定檔設定簡單文字，用來判別是否有正確切換語系
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-_tlyjSac5Mw/Wg5FEUE-MPI/AAAAAAAAIQ4/EqScZ5b_GUMrvQiG6EU5Pg2qyAKmzs8cgCLcBGAs/s640/1.png)](https://2.bp.blogspot.com/-_tlyjSac5Mw/Wg5FEUE-MPI/AAAAAAAAIQ4/EqScZ5b_GUMrvQiG6EU5Pg2qyAKmzs8cgCLcBGAs/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-SbOTT0V8vy0/Wg5FETAHr3I/AAAAAAAAIQ8/UIejGSO6TDYAihR8r5KtuUMIgV6ERa1ZQCLcBGAs/s640/2.png)](https://4.bp.blogspot.com/-SbOTT0V8vy0/Wg5FETAHr3I/AAAAAAAAIQ8/UIejGSO6TDYAihR8r5KtuUMIgV6ERa1ZQCLcBGAs/s1600/2.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-7JPMV22L3uc/Wg5FEd-t4dI/AAAAAAAAIQ0/0DFlVpoEqPk2LdRgl-dCU_htY2lLaasPQCLcBGAs/s640/3.png)](https://2.bp.blogspot.com/-7JPMV22L3uc/Wg5FEd-t4dI/AAAAAAAAIQ0/0DFlVpoEqPk2LdRgl-dCU_htY2lLaasPQCLcBGAs/s1600/3.png)</div>

<p>View上面就簡單做，只顯示出對應語系的CultureNow</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-rkJslBeNSY4/Wg5FaG31wvI/AAAAAAAAIRA/hi6OuzPU7Mw9fmD-tGoDFJ_Z-shVMCpTgCLcBGAs/s400/1.png)](https://1.bp.blogspot.com/-rkJslBeNSY4/Wg5FaG31wvI/AAAAAAAAIRA/hi6OuzPU7Mw9fmD-tGoDFJ_Z-shVMCpTgCLcBGAs/s1600/1.png)</div>

<p>測試</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-jdlM9kSYyjM/Wg5G94F9tWI/AAAAAAAAIRg/E66m5xlgo64zLs9IcyAenpJUZcdiwm_YQCLcBGAs/s640/Webp.net-gifmaker.gif)](https://2.bp.blogspot.com/-jdlM9kSYyjM/Wg5G94F9tWI/AAAAAAAAIRg/E66m5xlgo64zLs9IcyAenpJUZcdiwm_YQCLcBGAs/s1600/Webp.net-gifmaker.gif)</div>

<div class="separator" style="clear: both; text-align: center;">
</div>&nbsp;<span style="text-align: center;">好的做到這邊看起來沒什麼問題，但接下來的問題是，是否後續開發都要在每個Action加上這個RouteAttribute</span>
<span style="text-align: center;">
</span>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="meta-string">&quot;~/&#123;culture&#125;/index&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">Route(<span class="meta-string">&quot;~/&#123;culture&#125;/home&quot;</span>)</span>]</span><br><span class="line">[<span class="meta">Route(<span class="meta-string">&quot;~/&#123;culture&#125;/user&quot;</span>)</span>]</span><br><span class="line">......</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>且設定語系的段落勢必也要寫成ActionFilterAttribute，這樣其實增加了開發的困難之外，只要有人忘記加上，那新的頁面就會少了多語系功能。</p>
<p>工程師的美德就是懶，是否有辦法只做一次就讓全站Route都自動設定好呢? 這時候就要用到<a href="https://msdn.microsoft.com/en-us/library/system.web.mvc.routing.defaultdirectrouteprovider(v=vs.118).aspx">DefaultDirectRouteProvider&nbsp;</a>來解決這這個問題了</p>
<div class="note info">
            <p>DefaultDirectProvider能幫我們做什麼?</p><p>它能幫我們在註冊全站Route Template的時候做一些邏輯的加工，在這邊的案例應用上，<br>我們希望在註冊全站的Route的時候都自動幫我們在Template最前面加上{culture}<br>來達到做一次多語系設定即可</p>
          </div>

<p>讓我來實作看看，先新增一個CultureRouteProvider </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 多語系Route Provider</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;seealso cref=&quot;System.Web.Mvc.Routing.DefaultDirectRouteProvider&quot; /&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CultureRouteProvider</span>: <span class="title">DefaultDirectRouteProvider</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 取得所指定之動作描述元的一組路由 Factory。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;actionDescriptor&quot;&gt;</span>動作描述元。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 一組路由 Factory。</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> IReadOnlyList&lt;IDirectRouteFactory&gt; <span class="title">GetActionRouteFactories</span>(<span class="params">ActionDescriptor actionDescriptor</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            IReadOnlyList&lt;IDirectRouteFactory&gt; actionRouteFactories = <span class="keyword">base</span>.GetActionRouteFactories(actionDescriptor);</span><br><span class="line"></span><br><span class="line">            List&lt;IDirectRouteFactory&gt; actionDirectRouteFactories = <span class="keyword">new</span> List&lt;IDirectRouteFactory&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (IDirectRouteFactory routeFactory <span class="keyword">in</span> actionRouteFactories)</span><br><span class="line">            &#123;</span><br><span class="line">                RouteAttribute routeAttr = routeFactory <span class="keyword">as</span> RouteAttribute;</span><br><span class="line">                <span class="keyword">if</span> (routeAttr != <span class="literal">null</span> &amp;&amp; !<span class="built_in">string</span>.IsNullOrEmpty(routeAttr.Template))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">//每個Route Template原本的樣子</span></span><br><span class="line">                    <span class="comment">//已剛剛的Action為例，就是 &quot;~/index&quot;</span></span><br><span class="line">                    <span class="keyword">var</span> template = <span class="string">$&quot;<span class="subst">&#123;routeAttr.Template&#125;</span>&quot;</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">var</span> routeAttribute = <span class="keyword">new</span> RouteAttribute(template)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Order = routeAttr.Order,</span><br><span class="line">                        Name = routeAttr.Name</span><br><span class="line">                    &#125;;</span><br><span class="line">                    actionDirectRouteFactories.Add(routeAttribute);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//替每組Action都多加上一組&#123;culture&#125;/RouterTemplateLanguage的多語系RouteMap</span></span><br><span class="line">                    <span class="comment">//EX: &quot;~/index&quot; 多一組 &quot;~/&#123;culture&#125;/index&quot;</span></span><br><span class="line">                    <span class="keyword">var</span> includeLangTemplate = routeAttr.Template.Replace(<span class="string">&quot;~/&quot;</span>, <span class="built_in">string</span>.Format(<span class="string">@&quot;~/&#123;&#123;culture:regex(^(zh\-tw|en\-us|zh\-cn)$)&#125;&#125;/&quot;</span>));</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//註冊這組多語系的Route Template</span></span><br><span class="line">                    <span class="keyword">var</span> includeLangRouteAttribute = <span class="keyword">new</span> RouteAttribute(includeLangTemplate);</span><br><span class="line">                    includeLangRouteAttribute.Order = routeAttr.Order + <span class="number">1</span>;</span><br><span class="line">                    includeLangRouteAttribute.Name = routeAttr.Name;</span><br><span class="line"></span><br><span class="line">                    actionDirectRouteFactories.Add(includeLangRouteAttribute);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> actionDirectRouteFactories;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這邊需要特別注意一下，我在culture後面加上了RouteConstraint的正規表示法限制，目的是讓只有zh-tw ,&nbsp; en-us , zh-cn才會落入這個模板的範圍，如果沒有這段限制，就會變成萬用Route，有點像是{Controller}/{action}/{id}那般，所有網址都會跑到這邊，造成網址大亂!!!</p>
<p>接著將這組CultureRouteProvider在RouteConfig註冊使用</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RouteConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RegisterRoutes</span>(<span class="params">RouteCollection routes</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        routes.IgnoreRoute(<span class="string">&quot;&#123;resource&#125;.axd/&#123;*pathInfo&#125;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//註冊CultureRouteProvider</span></span><br><span class="line">        <span class="keyword">var</span> constraintsResolver = <span class="keyword">new</span> DefaultInlineConstraintResolver();</span><br><span class="line">        RouteTable.Routes.MapMvcAttributeRoutes(<span class="keyword">new</span> CultureRouteProvider());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然後將原本Action那組多語系RouteAttribute拿掉試試看</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//拿掉多語系RouteAttribute</span></span><br><span class="line">[<span class="meta">Route(<span class="meta-string">&quot;~/index&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>(<span class="params"><span class="built_in">string</span> culture</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (culture)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;zh-CN&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;en-US&quot;</span>:</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="literal">default</span>:</span><br><span class="line">            culture = <span class="string">&quot;zh-TW&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//設定多語系</span></span><br><span class="line">    CultureInfo ci = <span class="keyword">new</span> CultureInfo(culture);</span><br><span class="line">    Thread.CurrentThread.CurrentCulture = ci;</span><br><span class="line">    Thread.CurrentThread.CurrentUICulture = CultureInfo.CreateSpecificCulture(ci.Name);</span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>會發現多語系的功能依然存在，所以CultureRouteProvider有正確運作，自動的幫我們加上了多語系的Route Template。</p>
<p>接著是處理設定語系的段落，不應該讓設定語系的判斷落在每個Action裡面，所以將它獨立拉出來到自定義的CultureFilter中</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CultureFilter</span> : <span class="title">IAuthorizationFilter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;<span class="built_in">string</span>&gt; AllowCultures = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&quot;zh-cn&quot;</span>,<span class="string">&quot;zh-tw&quot;</span>,<span class="string">&quot;en-us&quot;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">OnAuthorization</span>(<span class="params">AuthorizationContext filterContext</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">string</span> culture = <span class="built_in">string</span>.Empty;</span><br><span class="line">        <span class="keyword">if</span> (filterContext.RequestContext.HttpContext.Request.Url.Segments.Count() &amp; gt; <span class="number">1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            culture = filterContext.RequestContext.HttpContext.Request.Url.Segments[<span class="number">1</span>].Replace(<span class="string">&quot;/&quot;</span>, <span class="built_in">string</span>.Empty);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(culture) ||</span><br><span class="line">            !AllowCultures.Any(x = &gt; x.ToLower() == culture.ToLower()))</span><br><span class="line">            &#123;</span><br><span class="line">            culture = <span class="string">&quot;zh-tw&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//設定多語系</span></span><br><span class="line">        CultureInfo ci = <span class="keyword">new</span> CultureInfo(culture);</span><br><span class="line">        Thread.CurrentThread.CurrentCulture = ci;</span><br><span class="line">        Thread.CurrentThread.CurrentUICulture = CultureInfo.CreateSpecificCulture(ci.Name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在FilterConfig註冊CultureFilter</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FilterConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RegisterGlobalFilters</span>(<span class="params">GlobalFilterCollection filters</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        filters.Add(<span class="keyword">new</span> HandleErrorAttribute());</span><br><span class="line">        <span class="comment">//多國語系</span></span><br><span class="line">        filters.Add(<span class="keyword">new</span> CultureFilter());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>將原本的Action所有判斷拿掉會發現多語系的功能還是一切正常</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">Route(<span class="meta-string">&quot;~/index&quot;</span>)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> View();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這樣就差不多大功告成，其實要優化的地方還很多，例如大小寫判斷，多語系應該拉成Enum方便擴充，Route Constraint應該跟隨著多語系的Enum去自動產生….等，因為這是獨立拉出來Demo的程式，就不搞得像Production Code一樣複雜了，知道自己注意一下就好XD</p>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC】擴充HtmlHelper</title>
    <url>/2013/05/08/%E3%80%90MVC%E3%80%91%E6%93%B4%E5%85%85HtmlHelper/</url>
    <content><![CDATA[<ul>
<li>  <strong>第一個範例，讓ActionLink可以放HTML標籤進去</strong></li>
<li>首先我先在專案中建立一個資料夾，並且在裡面新增一個類別檔案<pre><code> [![](http://2.bp.blogspot.com/-NBhxVa8AExI/UYoHecX2TrI/AAAAAAAADIE/G9Hvt_r7t_4/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png)](http://2.bp.blogspot.com/-NBhxVa8AExI/UYoHecX2TrI/AAAAAAAADIE/G9Hvt_r7t_4/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png)*   ```csharp
</code></pre>
//將命名空間改成System.Web.Mvc.Html，使用前不用修改~/Views/Web.config<br>namespace System.Web.Mvc.Html<br>{<br>  public static class MyHtmlHelperExtensions<br>  {<pre><code>  public static MvcHtmlString InsertHtmlTagActionLink(this AjaxHelper ajaxHelper,string linkText ,string actionName, string controllerName, AjaxOptions ajaxOptions)        &#123;
      var lnk = ajaxHelper.ActionLink(&quot;[replaceme]&quot;, actionName, controllerName, ajaxOptions);
      return MvcHtmlString.Create(lnk.ToString().Replace(&quot;[replaceme]&quot;, linkText));
  &#125;
</code></pre>
  }</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*   使用方式如下      &#96;&#96;&#96;csharp</span><br><span class="line">@Ajax.InsertHtmlTagActionLink(&quot;&lt;i class&#x3D;&#39;icon-file&#39;&gt;&lt;&#x2F;i&gt;&quot;+@childFunction.funname, action, controller, new AjaxOptions &#123; UpdateTargetId&#x3D;&quot;BackStageBody&quot; &#125;);</span><br><span class="line">     </span><br></pre></td></tr></table></figure>
<ul>
<li>  <strong>第二個範例，將TextBoxFor固定塞入一個data-content的html屬性，並將值給這個屬性</strong></li>
<li>```csharp<br>public static MvcHtmlString TextBoxFor_WithOriginData&lt;TModel, TProp&gt;(this HtmlHelper<TModel> htmlHelper, Expression&lt;Func&lt;TModel, TProp&gt;&gt; expression,object HtmlAttributes = null){<br>  //透過AnonymousObjectToHtmlAttributes將HtmlAttribute讀取出來<br>  var attrs = HtmlHelper.AnonymousObjectToHtmlAttributes(HtmlAttributes);<br>  //將expression的值抓出來放到data-content這個屬性中<br>  attrs.Add(“data-content”,ModelMetadata.FromLambdaExpression(expression, htmlHelper.ViewData).Model);<br>  var txtBoxFor = htmlHelper.TextBoxFor(expression, attrs);<br>  return MvcHtmlString.Create(txtBoxFor.ToString());<br>}</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">*   **第三個範例，加入Img這個Tag**</span><br><span class="line">*   &#96;&#96;&#96;csharp</span><br><span class="line">public static MvcHtmlString ImageFor_WithOriginData&lt;TModel, TProp&gt;(this HtmlHelper&lt;TModel&gt; htmlHelper, Expression&lt;Func&lt;TModel, TProp&gt;&gt; expression, object HtmlAttributes &#x3D; null)&#123;</span><br><span class="line">    string value &#x3D; ModelMetadata.FromLambdaExpression(expression, htmlHelper.ViewData).Model &#x3D;&#x3D; null ? &quot;&quot; : ModelMetadata.FromLambdaExpression(expression, htmlHelper.ViewData).Model.ToString();</span><br><span class="line">    &#x2F;&#x2F;屬性的值</span><br><span class="line">    string propname &#x3D; ModelMetadata.FromLambdaExpression(expression, htmlHelper.ViewData).PropertyName;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;透過AnonymousObjectToHtmlAttributes將HtmlAttribute讀取出來</span><br><span class="line">    var attrs &#x3D; HtmlHelper.AnonymousObjectToHtmlAttributes(HtmlAttributes);</span><br><span class="line">    attrs.Add(&quot;data-content&quot;, value);</span><br><span class="line">    attrs.Add(&quot;src&quot;, value);</span><br><span class="line">    attrs.Add(&quot;name&quot;, propname);</span><br><span class="line"></span><br><span class="line">        var img &#x3D; new TagBuilder(&quot;img&quot;);</span><br><span class="line">    img.MergeAttributes(attrs);</span><br><span class="line">    return MvcHtmlString.Create(img.ToString(TagRenderMode.SelfClosing));</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC教學】2. 什麼是MVC</title>
    <url>/2018/02/22/%E3%80%90MVC%E6%95%99%E5%AD%B8%E3%80%912-%E4%BB%80%E9%BA%BC%E6%98%AFMVC/</url>
    <content><![CDATA[<p>如果你本來跟我一樣是寫Dot Net Web的工程師,那你應該是從Web Form開始的,第一次接觸MVC時,應該心中都會浮現「什麼是MVC ?」 </p>
<p>其實<a href="https://zh.wikipedia.org/wiki/MVC">Wiki</a>已經解釋得很清楚了,就不重複贅述這些定義,有興趣可以自己看看,而我比較想提的是這跟原本開發Web Form,或是說你是寫別語言但沒使用MVC這個架構時的差別。 </p>
<p>還記得以前在接手前輩專案時,因為每個人開發習慣不盡相同,對於各種用途的類別可能都有一套自己的歸類方式,所以剛開始總是需要花大把時間在熟悉前輩定義的架構, 如果專案一多,常常切換專案時都會有一種混亂感。  </p>
<p>如果遇到是初心工程師,可能會有那種一個Function幾百行的,基本上要改個東西都要找很久之外,還很怕改錯,而這些不僅僅造成維護的成本增加之外,還讓接手別人專案時總是滿滿恨意！！ </p>
<p>而MVC這個架構就是在解決這個問題,他將系統分成三大部分 Model 、View、 Controller, 而這三大部分分別管理著 </p>
<p>Model : 資料的管理(例如與資料庫的溝通) , 演算法邏輯(商業邏輯) , 物件結構定義 </p>
<p>View : 呈現給使用者看、操作的介面 </p>
<div>Controller :  依據傳入的資料該怎麼運作、程式流程的控制、該回傳給使用者什麼資料等

</div><div>
</div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-ByxeEs_OPjo/Wo7SEU86Q2I/AAAAAAAAIkM/ILz4hUYI59gdspAfW_MxUekeTfa2ZaWCQCEwYBhgL/s640/2.jpg)](https://3.bp.blogspot.com/-ByxeEs_OPjo/Wo7SEU86Q2I/AAAAAAAAIkM/ILz4hUYI59gdspAfW_MxUekeTfa2ZaWCQCEwYBhgL/s1600/2.jpg)</td></tr><tr><td class="tr-caption" style="text-align: center;"><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-size: 12px; font-stretch: normal; line-height: normal;">出處 https://helloacm.com/model-view-controller-explained-in-c/</div></td></tr></tbody></table><div>
</div>

<h3 id="優點ㄧ-：-讓習慣代替配置"><a href="#優點ㄧ-：-讓習慣代替配置" class="headerlink" title="優點ㄧ ： 讓習慣代替配置"></a>優點ㄧ ： 讓習慣代替配置</h3><p><span style="font-weight: normal;">因為大家對於MVC有相同的認識,且Dot Net MVC更把這些定義落實到專案上,在不改動底層運作的情況下,屬於Controller的Class就該放到Controllers的資料夾、屬於頁面呈現的就放到Views資料夾,且預設也有一個Models的資料夾給你放Model,有了這些規範後,讓習慣來代替配置,你接手別人的MVC專案後, 所有人的開發方式基本上都會依照這個規範去落實,降低維護的成本。</span><br><span style="font-weight: normal;"><br></span></p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://4.bp.blogspot.com/-4aTMTqC7vZE/Wo7SSOsXq7I/AAAAAAAAIkY/aQAQWR1nxkATcDPTD2xx4nwxLUOqQYI-gCEwYBhgL/s400/1.png)](https://4.bp.blogspot.com/-4aTMTqC7vZE/Wo7SSOsXq7I/AAAAAAAAIkY/aQAQWR1nxkATcDPTD2xx4nwxLUOqQYI-gCEwYBhgL/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;"><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-size: 12px; font-stretch: normal; line-height: normal;">Dot Net MVC預設新建專案就會有這些資料夾</div></td></tr></tbody></table><div>
</div>

<h3 id="優點二-：-關注點分離"><a href="#優點二-：-關注點分離" class="headerlink" title="優點二 ： 關注點分離"></a>優點二 ： 關注點分離</h3><p>如果今天是在處理使用者操作介面,那就專心的套版,將Controller傳回來的資料看要怎麼擺放,又如果在處理資料流傳入的參數驗證,那就在Controller處理完,不用去管會不會影響到View的呈現, 如果是跟資料庫的溝通,就在Model裡將它實作好,不需擔心是否參數有空值或Null, 因為那些該是在Controller處理掉的。 </p>
<p>相較於以前的Web Form開發方式,因為UserControl介於頁面跟Code Behind的事件之間,常常耦合度太強,一改兩邊都會動到，需要較嚴謹的開發規範才能避免耦合問題,而且我記憶最深的就是UserControl間的生命週期,那個互相攪在一起要改還真要命… </p>
<div class="note info">
            <p>Web Form有其快速且便利性,以上並非說Dot Net MVC能完全取代Web Form,<br>更想表達的是,這是當我從開發Web Form兩年然後跳到MVC目前5年多，<br>它所帶給我的感受與改變,希望透過這些講述能更清楚MVC是否是你該投入資源學習的架構</p>
          </div>


<h3 id="優點三-：-前端更自由"><a href="#優點三-：-前端更自由" class="headerlink" title="優點三 ： 前端更自由"></a>優點三 ： 前端更自由</h3><p>在Dot Net MVC中,不再有User Control這類的元件存在,所以前端會更加的自由,無論是在JS或是CSS的運用上，再也不會有元件Render時幫你加上一堆多餘的Tag或是Class。</p>
<div class="note info">
            <p>目前經手過的一些專案,有些都已經徹底前後端分離,<br>後端只有負責處理好API或是ViewModel(傳給View的資料通常定義出來的Class都會叫ViewModel,這之後會再提到)，<br>吐一個空的頁面載入指定JS,剩下就讓前端去處理介面,彼此分工更精細,互相耦合的程度也降低許多。</p>
          </div>


<p>這篇花比較多篇幅在解說ＭVC是什麼,又Dot Net MVC在開發上能帶來什麼改變跟好處, 下一篇預計就要開始講Router 與 Controller之間的關係。</p>
]]></content>
      <categories>
        <category>學習MVC</category>
      </categories>
      <tags>
        <tag>MVC教學</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC教學】4. 為你的Route加一點限制</title>
    <url>/2018/04/05/%E3%80%90MVC%E6%95%99%E5%AD%B8%E3%80%914-%E7%82%BA%E4%BD%A0%E7%9A%84Route%E5%8A%A0%E4%B8%80%E9%BB%9E%E9%99%90%E5%88%B6/</url>
    <content><![CDATA[<p>上一篇寫了Route比對的邏輯，這次來點更進階的應用，讓我們幫Route比對加上一些些限制。</p>
<p>假設今天About的頁面，他是依據網址帶入的 ID取得對應的會員資料，回傳結果，而ID必定為<strong>數字，如果不是數字就不要進到程式碼，直接擋掉該如何做？</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//我們希望的網址，最後的ID一定要為數字</span></span><br><span class="line">/home/about/<span class="number">1</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>加上Constraints限制，而限制的方法用正規表示法來表達，以上述的只能為數字為例</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-DDzFIwOxsvQ/WsTtsAb1bgI/AAAAAAAAInA/pJdFwqPGRdIZ6LKQ-EgiXc2xem8FcQ4QACLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.22.03.png)](https://1.bp.blogspot.com/-DDzFIwOxsvQ/WsTtsAb1bgI/AAAAAAAAInA/pJdFwqPGRdIZ6LKQ-EgiXc2xem8FcQ4QACLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.22.03.png)</div>
constraints的部分，我們把ID限制在只能出現數字，（如果對於正規表示法不熟悉的話，推薦可以翻翻這本書，就算記不起來拿來當工具書也很實用&nbsp;[<span style="color: #454545; font-family: &quot;.PingFang TC&quot;;">處理大數據的必備美工刀</span><span style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal;"> - </span><span style="color: #454545; font-family: &quot;.PingFang TC&quot;;">全支援中文的正規表示法精解</span>](https://www.tenlong.com.tw/products/9789863759539)）

<p>接著執行網站試試看 /home/about/123</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-5v8kKEHK7oQ/WsTve5DgK7I/AAAAAAAAInM/qCpoatJcmjED_wL1aP5zPUEnHuiVDzA1QCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.29.45.png)](https://2.bp.blogspot.com/-5v8kKEHK7oQ/WsTve5DgK7I/AAAAAAAAInM/qCpoatJcmjED_wL1aP5zPUEnHuiVDzA1QCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.29.45.png)</div>
看起來沒問題，接著我們執行/home/about/Steven，這邊請記得把Default那組Route註解起來，如果還記得上篇Route比對方法的話，這組雖然會因為Steven不是數字而被About那組Route擋掉，但依然符合Default的萬用Route比對規則，而正確執行，為了測試請先註解掉Default那組。
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-97qSMhzIPOE/WsTwIiBOlMI/AAAAAAAAInU/Xb90Cy9gzJYsGtOuzXkPSL6bWfQszpr1ACLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.32.39.png)](https://3.bp.blogspot.com/-97qSMhzIPOE/WsTwIiBOlMI/AAAAAAAAInU/Xb90Cy9gzJYsGtOuzXkPSL6bWfQszpr1ACLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.32.39.png)</div>

<p>如我們預期的，因為Steven不是數字的原因而被擋掉了，Constraints算是一個可以把Route用得更靈活的技巧，雖然需要懂的正規表示法，但我覺得這兩項學習投資很划算，正規表示法到很多地方都很萬用。</p>
<h3 id="自訂更複雜的Constraints"><a href="#自訂更複雜的Constraints" class="headerlink" title="自訂更複雜的Constraints"></a>自訂更複雜的Constraints</h3><div>我們再來出個更刁的要求，假設你老闆就叫Steven，而且他不希望跟別人一樣，每個人都是打ID查資料顯示太一般，他偏偏要只有輸入Steven也要能進到About頁時該怎麼辦？</div><div>
</div><div>
</div><div>當然也可以用正規表示法硬做，但可能會讓Constraint寫得很醜難維護，所以這次改用實作IRouteConstraint的方式來完成這個需求</div><div>
</div><div>
</div><div>建立一個StevenBossConstraint的Class</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-lzkbxUNTjPs/WsTyHmO8DrI/AAAAAAAAInk/Z69_UKTgzw4Yiduel0QPOKVnIq9uNLP1ACLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.39.46.png)](https://1.bp.blogspot.com/-lzkbxUNTjPs/WsTyHmO8DrI/AAAAAAAAInk/Z69_UKTgzw4Yiduel0QPOKVnIq9uNLP1ACLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.39.46.png)</div><div>
</div>
實作以下內容
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-mCMOFMxoiQs/WsT0UDLnh5I/AAAAAAAAIn0/w7PzqK5RsyEabGIx9azbwzT2CZj6VlN6gCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.48.47.png)](https://3.bp.blogspot.com/-mCMOFMxoiQs/WsT0UDLnh5I/AAAAAAAAIn0/w7PzqK5RsyEabGIx9azbwzT2CZj6VlN6gCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.48.47.png)</div>

<p>將原本設定ID的Constrainte改成我們寫的StevenBossConstraint</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-SXNFt3bhpRE/WsT1HLb4yzI/AAAAAAAAIn8/x04sB1B-ymwBSfdvYbCOrn4EcNjTaoFAwCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.51.38.png)](https://3.bp.blogspot.com/-SXNFt3bhpRE/WsT1HLb4yzI/AAAAAAAAIn8/x04sB1B-ymwBSfdvYbCOrn4EcNjTaoFAwCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.51.38.png)</div>

<p>執行後就會發現，數字跟Steven都可以通過Route的檢查，但你打Tom或是Tim之類的其他非數字參數，都會被擋掉</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-QOP-fMjmh1M/WsT1zhvaGSI/AAAAAAAAIoM/8GxzEl2aKKY0V2sSKZEo9zXqNg2qI7KJQCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.56.40.png)](https://2.bp.blogspot.com/-QOP-fMjmh1M/WsT1zhvaGSI/AAAAAAAAIoM/8GxzEl2aKKY0V2sSKZEo9zXqNg2qI7KJQCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.56.40.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-dV8vMrVM9rQ/WsT1z2-D7uI/AAAAAAAAIoQ/TJAfdgiSc_cu36opnnSktdBx9eULS0tXwCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.56.29.png)](https://2.bp.blogspot.com/-dV8vMrVM9rQ/WsT1z2-D7uI/AAAAAAAAIoQ/TJAfdgiSc_cu36opnnSktdBx9eULS0tXwCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.56.29.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-rAGzQD3L_c8/WsT1zmOtcFI/AAAAAAAAIoI/O7utdb1IfIUkMAK013X5TQwoo-QOvQ-pACLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.56.47.png)](https://3.bp.blogspot.com/-rAGzQD3L_c8/WsT1zmOtcFI/AAAAAAAAIoI/O7utdb1IfIUkMAK013X5TQwoo-QOvQ-pACLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-04%2B%25E4%25B8%258B%25E5%258D%258811.56.47.png)</div>

<h4 id="透過小工具來幫助偵錯Route設定"><a href="#透過小工具來幫助偵錯Route設定" class="headerlink" title="透過小工具來幫助偵錯Route設定"></a>透過小工具來幫助偵錯Route設定</h4><div>可以透過Nuget來安裝Route Debugger工具，他們告訴我們目前網頁之所以能夠顯示，是因為走了哪一條Route規則，這在初期我對這些設定還不熟悉時幫助非常的大</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-OF3Lz23taZc/WsT2n5WMicI/AAAAAAAAIoc/yvgdxPJ_Dj84sOOWiZaf5KDe4m47nuFOQCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-05%2B%25E4%25B8%258A%25E5%258D%258812.00.15.png)](https://1.bp.blogspot.com/-OF3Lz23taZc/WsT2n5WMicI/AAAAAAAAIoc/yvgdxPJ_Dj84sOOWiZaf5KDe4m47nuFOQCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-05%2B%25E4%25B8%258A%25E5%258D%258812.00.15.png)</div><div>
</div><div>
</div><div>
</div><div>安裝這組套件</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-MY03_784a74/WsT5eh-6T7I/AAAAAAAAIoo/fgvoj60WvfARLWeyjMfRHi_9onyYPdCmACLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-05%2B%25E4%25B8%258A%25E5%258D%258812.10.10.png)](https://2.bp.blogspot.com/-MY03_784a74/WsT5eh-6T7I/AAAAAAAAIoo/fgvoj60WvfARLWeyjMfRHi_9onyYPdCmACLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-05%2B%25E4%25B8%258A%25E5%258D%258812.10.10.png)</div>

<p>接著重新執行網站就可在看到詳細解說</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-_GBLWNdFSoA/WsT51ZoPPkI/AAAAAAAAIos/A4wI4Ml7U9U1QjmMwGcIPe0LQCpVbra2QCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-05%2B%25E4%25B8%258A%25E5%258D%258812.13.24.png)](https://1.bp.blogspot.com/-_GBLWNdFSoA/WsT51ZoPPkI/AAAAAAAAIos/A4wI4Ml7U9U1QjmMwGcIPe0LQCpVbra2QCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-05%2B%25E4%25B8%258A%25E5%258D%258812.13.24.png)</div>

<p>相信剛開始要改Route的使用者來說，會是相當有幫助的工具喔！！</p>
]]></content>
      <categories>
        <category>學習MVC</category>
      </categories>
      <tags>
        <tag>MVC教學</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC教學】7.驗證參數-DataAnnotations</title>
    <url>/2018/06/05/%E3%80%90MVC%E6%95%99%E5%AD%B8%E3%80%917.%E9%A9%97%E8%AD%89%E5%8F%83%E6%95%B8-DataAnnotations%20/</url>
    <content><![CDATA[<div class="note info">
            <p>Demo範例 ：<a href="https://github.com/toyo0103/HelloDotNetMVC">Git位置</a></p>
          </div>

<h1 id="什麼是DataAnnotations"><a href="#什麼是DataAnnotations" class="headerlink" title="#什麼是DataAnnotations"></a>#什麼是DataAnnotations</h1><p>DataAnnotations是.Net Framework 3.5之後提供的一個命名空間，裡面包含了一些基本的驗證Attribute，同時也提供客製化的方法，希望開發人員能透過簡單的加上Attribute即達到驗證的效果。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserSignUpParameter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 帳號</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Required</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>  Account &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>







<h1 id="如何使用"><a href="#如何使用" class="headerlink" title="#如何使用"></a>#如何使用</h1><p>我們透過修改先前的範例，嘗試將<strong>UserSignUpParameter</strong>的驗證從FluentValidation改成用MVC預設提供的DataAnnotations來達成，從修改中學習他是如何運作的。</p>
<p><strong>重新審視一下需求</strong></p>
<div class="note info">
            <p><strong>帳號</strong></p><ul><li>必填</li><li>必須包含@</li></ul><p><strong>密碼</strong></p><ul><li>必填</li><li>不得小於6個字元</li></ul>
          </div>





<h2 id="RequiredAttribute"><a href="#RequiredAttribute" class="headerlink" title="RequiredAttribute"></a>RequiredAttribute</h2><p>RequiredAttribute為DataAnnotations預設提供的驗證方式，目標是驗證該欄位是否為Null或Empty</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// 摘要:</span></span><br><span class="line"><span class="comment">//     指定資料欄位值為必要。</span></span><br><span class="line">[<span class="meta">AttributeUsage(AttributeTargets.Property | AttributeTargets.Field | AttributeTargets.Parameter, AllowMultiple = false)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RequiredAttribute</span> : <span class="title">ValidationAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">    <span class="comment">// 摘要:</span></span><br><span class="line">    <span class="comment">//     初始化 System.ComponentModel.DataAnnotations.RequiredAttribute 類別的新執行個體。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RequiredAttribute</span>(<span class="params"></span>)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">    <span class="comment">// 摘要:</span></span><br><span class="line">    <span class="comment">//     取得或設定值，指出是否允許空字串。</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 傳回:</span></span><br><span class="line">    <span class="comment">//     true 如果允許空字串。否則， false。 預設值是 false。</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> AllowEmptyStrings &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">    <span class="comment">// 摘要:</span></span><br><span class="line">    <span class="comment">//     檢查必要的資料欄位的值不是空的。</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 參數:</span></span><br><span class="line">    <span class="comment">//   value:</span></span><br><span class="line">    <span class="comment">//     要驗證的資料欄位值。</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 傳回:</span></span><br><span class="line">    <span class="comment">//     true 如果驗證成功。否則， false。</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// 例外狀況:</span></span><br><span class="line">    <span class="comment">//   T:System.ComponentModel.DataAnnotations.ValidationException:</span></span><br><span class="line">    <span class="comment">//     資料欄位值為 null。</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsValid</span>(<span class="params"><span class="built_in">object</span> <span class="keyword">value</span></span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>從上述的程式碼可以看出它有提供<strong>AllowEmptyStrings</strong>的屬性可以設定，意義如同字面意思，可以<strong>EmptyString</strong>。</p>
<h3 id="AllowEmptyStrings"><a href="#AllowEmptyStrings" class="headerlink" title="AllowEmptyStrings"></a>AllowEmptyStrings</h3><p>我們先將Account掛上Required，並且指定屬性AllowEmptyStrings為True，執行看看</p>
<div class="note info">
            <p>繼承自Attribute的類別，在掛Attribute時可以省略後綴詞，所以可以看到程式碼只寫Required而不是RequiredAttribute</p>
          </div>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Parameter UserSignUp</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserSignUpParameter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 帳號</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Required(AllowEmptyStrings =true)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>  Account &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 密碼</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>當Account傳入為Null時</p>
<p><img src="/images/20180615/1.png" alt="/images/20180615/1.png"></p>
<p>ModelState.IsValidate為False，在Values.Errors底下可以找到錯誤訊息<strong>Account 欄位是必要項。</strong></p>
<p><img src="/images/20180615/2.png" alt="/images/20180615/2.png"></p>
<p>接著改傳入<strong>空格</strong></p>
<p><img src="/images/20180615/3.png" alt="/images/20180615/3.png"></p>
<p>通過驗證</p>
<p><img src="/images/20180615/4.png" alt="/images/20180615/4.png"></p>
<h3 id="ErrorMessage"><a href="#ErrorMessage" class="headerlink" title="ErrorMessage"></a>ErrorMessage</h3><p>如果想修改錯誤的回傳訊息時，可以透過ErrorMessage來處理</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 帳號</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Required(ErrorMessage = <span class="meta-string">&quot;帳號為必填欄位&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span>  Account &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>或是</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 帳號</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">Required(ErrorMessage = <span class="meta-string">&quot;&#123;0&#125;為必填欄位&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span>  Account &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>{0}的位置系統會自動帶入欄位名稱</p>
<p><img src="/images/20180615/5.png" alt="/images/20180615/5.png"></p>
<p>介紹完RequiredAttribute的基本用法後，目前程式碼如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Parameter UserSignUp</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserSignUpParameter</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 帳號</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Required(ErrorMessage = <span class="meta-string">&quot;&#123;0&#125;為必填欄位&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span>  Account &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 密碼.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    [<span class="meta">Required(ErrorMessage = <span class="meta-string">&quot;&#123;0&#125;為必填欄位&quot;</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="MinLengthAttribute"><a href="#MinLengthAttribute" class="headerlink" title="MinLengthAttribute"></a>MinLengthAttribute</h2><p>MinLengthAttribute是用來檢查屬性的最小字數，與MaxLengthAttribute為剛好相反的一組</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">    <span class="comment">// 摘要:</span></span><br><span class="line">    <span class="comment">//     指定屬性中所允許之陣列或字串資料的最大長度。</span></span><br><span class="line">    [<span class="meta">AttributeUsage(AttributeTargets.Property | AttributeTargets.Field | AttributeTargets.Parameter, AllowMultiple = false)</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MaxLengthAttribute</span> : <span class="title">ValidationAttribute</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 摘要:</span></span><br><span class="line">        <span class="comment">//     初始化 System.ComponentModel.DataAnnotations.MaxLengthAttribute 類別的新執行個體。</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MaxLengthAttribute</span>(<span class="params"></span>)</span>;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 摘要:</span></span><br><span class="line">        <span class="comment">//     初始化的新執行個體 System.ComponentModel.DataAnnotations.MaxLengthAttribute 類別根據 length</span></span><br><span class="line">        <span class="comment">//     參數。</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 參數:</span></span><br><span class="line">        <span class="comment">//   length:</span></span><br><span class="line">        <span class="comment">//     陣列或字串資料的最大容許長度。</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">MaxLengthAttribute</span>(<span class="params"><span class="built_in">int</span> length</span>)</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 摘要:</span></span><br><span class="line">        <span class="comment">//     取得陣列或字串資料所容許的最大長度。</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 傳回:</span></span><br><span class="line">        <span class="comment">//     陣列或字串資料的最大容許長度。</span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> Length &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 摘要:</span></span><br><span class="line">        <span class="comment">//     將格式套用到指定的錯誤訊息</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 參數:</span></span><br><span class="line">        <span class="comment">//   name:</span></span><br><span class="line">        <span class="comment">//     要包含在格式化字串中的名稱。</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 傳回:</span></span><br><span class="line">        <span class="comment">//     描述可接受之最大長度的當地語系化字串。</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">FormatErrorMessage</span>(<span class="params"><span class="built_in">string</span> name</span>)</span>;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 摘要:</span></span><br><span class="line">        <span class="comment">//     判斷指定的物件是否有效</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 參數:</span></span><br><span class="line">        <span class="comment">//   value:</span></span><br><span class="line">        <span class="comment">//     要驗證的物件。</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 傳回:</span></span><br><span class="line">        <span class="comment">//     如果此值為 null 或是小於或等於指定的最大長度，則為 true，否則為 false。</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// 例外狀況:</span></span><br><span class="line">        <span class="comment">//   T:System.InvalidOperationException:</span></span><br><span class="line">        <span class="comment">//     長度為零或小於 –1。</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsValid</span>(<span class="params"><span class="built_in">object</span> <span class="keyword">value</span></span>)</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>密碼<strong>最少應為6個字元</strong>設定方式，當然它同時也提供修改ErrorMessage的方法</p>
<p>{0}的位置系統會自動帶入欄位名稱</p>
<p>{1}的位置系統會帶入所設定的最小字元數字</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 密碼.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span>    </span></span><br><span class="line">[<span class="meta">MinLength(6, ErrorMessage = <span class="meta-string">&quot;&#123;0&#125;不得低於&#123;1&#125;個字元&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> Password &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/20180615/6.png" alt="/images/20180615/6.png"></p>
<p><img src="/images/20180615/7.png" alt="/images/20180615/7.png"></p>
<h2 id="RegularExpression"><a href="#RegularExpression" class="headerlink" title="RegularExpression"></a>RegularExpression</h2><p>Account還有一個需求是必須包含@字元，這時候可以透過預設提供的RegularExpression來達成需求</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line">   <span class="comment">// 摘要:</span></span><br><span class="line">   <span class="comment">//     指定 ASP.NET 動態資料的資料欄位值必須符合指定的規則運算式。</span></span><br><span class="line">   [<span class="meta">AttributeUsage(AttributeTargets.Property | AttributeTargets.Field | AttributeTargets.Parameter, AllowMultiple = false)</span>]</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RegularExpressionAttribute</span> : <span class="title">ValidationAttribute</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 摘要:</span></span><br><span class="line">       <span class="comment">//     初始化 System.ComponentModel.DataAnnotations.RegularExpressionAttribute 類別的新執行個體。</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 參數:</span></span><br><span class="line">       <span class="comment">//   pattern:</span></span><br><span class="line">       <span class="comment">//     用來驗證資料欄位值的規則運算式。</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 例外狀況:</span></span><br><span class="line">       <span class="comment">//   T:System.ArgumentNullException:</span></span><br><span class="line">       <span class="comment">//     pattern 為 null。</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">RegularExpressionAttribute</span>(<span class="params"><span class="built_in">string</span> pattern</span>)</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 摘要:</span></span><br><span class="line">       <span class="comment">//     取得規則運算式模式。</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 傳回:</span></span><br><span class="line">       <span class="comment">//     要比對模式。</span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">string</span> Pattern &#123; <span class="keyword">get</span>; &#125;</span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 摘要:</span></span><br><span class="line">       <span class="comment">//     取得或設定執行單一比對作業，直到作業逾時之前的時間 (以毫秒為單位)。</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 傳回:</span></span><br><span class="line">       <span class="comment">//     執行單一比對作業的時間 (以毫秒為單位)。</span></span><br><span class="line">       <span class="keyword">public</span> <span class="built_in">int</span> MatchTimeoutInMilliseconds &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 摘要:</span></span><br><span class="line">       <span class="comment">//     格式化要顯示在規則運算式驗證失敗時的錯誤訊息。</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 參數:</span></span><br><span class="line">       <span class="comment">//   name:</span></span><br><span class="line">       <span class="comment">//     造成驗證失敗的欄位名稱。</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 傳回:</span></span><br><span class="line">       <span class="comment">//     格式化的錯誤訊息。</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">FormatErrorMessage</span>(<span class="params"><span class="built_in">string</span> name</span>)</span>;</span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 摘要:</span></span><br><span class="line">       <span class="comment">//     會檢查使用者輸入的值是否符合規則運算式模式。</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 參數:</span></span><br><span class="line">       <span class="comment">//   value:</span></span><br><span class="line">       <span class="comment">//     要驗證的資料欄位值。</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 傳回:</span></span><br><span class="line">       <span class="comment">//     true 如果驗證成功。否則， false。</span></span><br><span class="line">       <span class="comment">//</span></span><br><span class="line">       <span class="comment">// 例外狀況:</span></span><br><span class="line">       <span class="comment">//   T:System.ComponentModel.DataAnnotations.ValidationException:</span></span><br><span class="line">       <span class="comment">//     資料欄位值不符合規則運算式模式。</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsValid</span>(<span class="params"><span class="built_in">object</span> <span class="keyword">value</span></span>)</span>;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>可以透過寫正規表示法的方式來驗證想驗證的屬性，一樣有ErrorMessage可供使用</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 帳號</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">[<span class="meta">RegularExpression(<span class="meta-string">&quot;[@]+&quot;</span>,ErrorMessage =<span class="meta-string">&quot;&#123;0&#125;必須包含@字元&quot;</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="built_in">string</span> Account &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/20180615/8.png" alt="/images/20180615/8.png"></p>
<p><img src="/images/20180615/9.png" alt="/images/20180615/9.png"></p>
<h2 id="其它Attribute"><a href="#其它Attribute" class="headerlink" title="其它Attribute"></a>其它Attribute</h2><p>DataAnnotations還有提供一些預設的Attribute可以使用，篇幅有限就不一一介紹，有興趣的可以參考以下文章</p>
<div class="note info">
            <p><a href="http://dotnetmentors.com/mvc/how-to-validate-mvc-model-using-dataannotation-attributes.aspx">How To Validate MVC Model Using DataAnnotation Attribute</a></p><p><a href="https://msdn.microsoft.com/zh-tw/library/system.componentmodel.dataannotations.validationattribute(v=vs.110).aspx">MSDN - ValidationAttribute 類別</a></p>
          </div>





<h1 id="客製"><a href="#客製" class="headerlink" title="#客製"></a>#客製</h1><p>如果碰到一個驗證需要在多個地方使用，且預設沒有提供的話，這時候就可以透過自製驗證Attribute來解決，我們以**字元需包含@**為例</p>
<h2 id="繼承ValidationAttribute"><a href="#繼承ValidationAttribute" class="headerlink" title="繼承ValidationAttribute"></a>繼承ValidationAttribute</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MouseCharactersAttribute</span>: <span class="title">ValidationAttribute</span></span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> Returns true if ... is valid.</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>要驗證之物件的值。<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;see langword=&quot;true&quot; /&gt;</span> 指定的值是否有效。否則， <span class="doctag">&lt;see langword=&quot;false&quot; /&gt;</span>。</span></span><br><span class="line">       <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsValid</span>(<span class="params"><span class="built_in">object</span> <span class="keyword">value</span></span>)</span></span><br><span class="line"><span class="function"></span>       &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">base</span>.IsValid(<span class="keyword">value</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<h2 id="Override-IsValid-Method"><a href="#Override-IsValid-Method" class="headerlink" title="Override IsValid Method"></a>Override IsValid Method</h2><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsValid</span>(<span class="params"><span class="built_in">object</span> <span class="keyword">value</span></span>)</span></span><br><span class="line"><span class="function"></span>   &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">value</span> == <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;   </span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> stringValue = <span class="keyword">value</span> <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> stringValue.Contains(<span class="string">&quot;@&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>將原本的<strong>RegularExpression</strong>改成我們客製的<strong>MouseCharacters</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> 帳號</span></span><br><span class="line">  <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">  [<span class="meta">MouseCharacters(ErrorMessage =<span class="meta-string">&quot;&#123;0&#125;必須包含@字元&quot;</span>)</span>]</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> Account &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br></pre></td></tr></table></figure>

<p>實測會發現結果是一樣的</p>
<p><img src="/images/20180615/10.png" alt="/images/20180615/10.png"></p>
<h1 id="比較FluentValidation"><a href="#比較FluentValidation" class="headerlink" title="#比較FluentValidation"></a>#比較FluentValidation</h1><p>DataAnnotations其實使用起來相當方便，且只要知道如何客製ValidationAttribute基本上大部分情境都能解決，加上套用Attribute的方式算是相當親民的寫法。</p>
<p>但我本身基於單一職責的原則下，還是喜歡將驗證邏輯等方法分離到不同的Class管理，而這也正是FluentValidation套件的特性，不過這是見仁見智，就像大部分Pattern一樣，永遠不會有最好的解法，只要能花最小的成本解決需求，同時盡量不犧牲維護及擴充性，那就稱得上是好方法了。</p>
]]></content>
      <categories>
        <category>學習MVC</category>
      </categories>
      <tags>
        <tag>MVC教學</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC教學】5.Controller簡介</title>
    <url>/2018/04/25/%E3%80%90MVC%E6%95%99%E5%AD%B8%E3%80%915.Controller%E7%B0%A1%E4%BB%8B/</url>
    <content><![CDATA[<div class="note info">
            <p>Demo範例 ： <a href="https://github.com/toyo0103/HelloDotNetMVC">Git位置</a></p>
          </div>

<p>前面幾篇解說了Route設定，讓我們的程式能順利找到對應的Controller來執行，那今天要來談談Controller幫我們做些什麼？<br>我們通常會在Controller這層就將使用者的參數<strong>驗證</strong>完畢，並且依據傳入的參數，找到對應的商業邏輯去執行，並且回傳結果給使用者知道，已註冊頁面作為實際應用來解說。</p>
<p><a href="https://4.bp.blogspot.com/-1s0A__te0ws/WuCCI7_4QvI/AAAAAAAAIq0/qwTcF7tfpGAajtSMNZ8FPKhw0q7ImxPrgCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.26.31.png"><img src="https://4.bp.blogspot.com/-1s0A__te0ws/WuCCI7_4QvI/AAAAAAAAIq0/qwTcF7tfpGAajtSMNZ8FPKhw0q7ImxPrgCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.26.31.png"></a></p>
<p>接著我們來實作上述的內容，但因為只是MVC初學，所以我們還不加入分層、資料庫溝通之類比較深的內容，只專注在Controller怎麼做。</p>
<p>&nbsp;</p>
<h1 id="建立Controller"><a href="#建立Controller" class="headerlink" title="建立Controller"></a>建立Controller</h1><p>&nbsp;<br>我們先建立一個UserController，專門處理User相關的服務跟邏輯</p>
<p><a href="https://2.bp.blogspot.com/-y9ZNRe-qPbw/WuCDIfd8kUI/AAAAAAAAIq8/KA_bBs97zp8l7YrYxSwSNRqS14cqyA9KwCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.30.36.png"><img src="https://2.bp.blogspot.com/-y9ZNRe-qPbw/WuCDIfd8kUI/AAAAAAAAIq8/KA_bBs97zp8l7YrYxSwSNRqS14cqyA9KwCLcBGAs/s320/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.30.36.png"></a></p>
<p>接著寫一個SignUp的Action，這邊有看到我們掛HttpGet的Attribute，只是指定呼叫動詞必須是Get的方式才會執行到這個Action</p>
<div class="note info">
            <p>如果不知道Http動詞的話可以參考 : <a href="https://developer.mozilla.org/zh-TW/docs/Web/HTTP/Methods">HTTP請求方法</a></p>
          </div>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-KA_M1a5AopU/WuCDeRZvUuI/AAAAAAAAIrI/C66BwZf0wvw7Z2PDngjof-IgAzSwUE3bwCEwYBhgL/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.32.27.png)](https://1.bp.blogspot.com/-KA_M1a5AopU/WuCDeRZvUuI/AAAAAAAAIrI/C66BwZf0wvw7Z2PDngjof-IgAzSwUE3bwCEwYBhgL/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.32.27.png)</div>

<p>&nbsp;</p>
<h1 id="建立View"><a href="#建立View" class="headerlink" title="建立View"></a>建立View</h1><p>&nbsp;<br>而這個Action沒有任何內容，只有回傳一個View而已，接著我們來實作出回傳的頁面，在這個Action中點擊右鍵 &gt; 新增檢視</p>
<p><a href="https://3.bp.blogspot.com/-qEISXaQUqlA/WuCFCh80daI/AAAAAAAAIrQ/k2MbagqBBpk_iw-y7YRUKoTOwjjeWnazwCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.37.38.png"><img src="https://3.bp.blogspot.com/-qEISXaQUqlA/WuCFCh80daI/AAAAAAAAIrQ/k2MbagqBBpk_iw-y7YRUKoTOwjjeWnazwCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.37.38.png"></a><br><a href="https://1.bp.blogspot.com/-x2w81z28D6c/WuCFRqP49VI/AAAAAAAAIrU/c--eosiD0rU7Y_7j1c1ZZY3-k7YUGbeIQCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.40.03.png"><img src="https://1.bp.blogspot.com/-x2w81z28D6c/WuCFRqP49VI/AAAAAAAAIrU/c--eosiD0rU7Y_7j1c1ZZY3-k7YUGbeIQCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.40.03.png"></a><br><a href="https://3.bp.blogspot.com/-RrarAQWIu6c/WuCFl5E-wvI/AAAAAAAAIrg/b6Lj5N-NGaU5dSZ3zM165O1zvvpzvA_gwCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.41.30.png"><img src="https://3.bp.blogspot.com/-RrarAQWIu6c/WuCFl5E-wvI/AAAAAAAAIrg/b6Lj5N-NGaU5dSZ3zM165O1zvvpzvA_gwCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.41.30.png"></a><br><a href="https://4.bp.blogspot.com/-j3xcFnMknHg/WuCF98nE2SI/AAAAAAAAIro/HOo9hoZwb6wAUQOJBcIRTqAeXTMSv8vXwCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.42.21.png"><img src="https://4.bp.blogspot.com/-j3xcFnMknHg/WuCF98nE2SI/AAAAAAAAIro/HOo9hoZwb6wAUQOJBcIRTqAeXTMSv8vXwCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%25889.42.21.png"></a></p>
<p>接著直接執行，應該就能看到我們剛剛做出來的SignUp頁面</p>
<p><a href="https://3.bp.blogspot.com/-SED-4nfjecw/WuCNG2uok7I/AAAAAAAAIr4/nOzZXjfM_FETp1KLNMU6-aLcf20L-IKCgCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.13.28.png"><img src="https://3.bp.blogspot.com/-SED-4nfjecw/WuCNG2uok7I/AAAAAAAAIr4/nOzZXjfM_FETp1KLNMU6-aLcf20L-IKCgCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.13.28.png"></a><br>而這邊網址是 /user/signup，我覺得不夠直覺，所以到RouteConfig改一下<br><a href="https://3.bp.blogspot.com/-Ci1v26GtXFs/WuCODEjjM2I/AAAAAAAAIsI/EzpX1P_LRGU278UAsSeZb6S4BBTo-FZOQCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.16.53.png"><img src="https://3.bp.blogspot.com/-Ci1v26GtXFs/WuCODEjjM2I/AAAAAAAAIsI/EzpX1P_LRGU278UAsSeZb6S4BBTo-FZOQCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.16.53.png"></a><br><a href="https://3.bp.blogspot.com/-mB5dxE3pyMQ/WuCOPhH0dhI/AAAAAAAAIsM/SZiLCNuxCWoI78quWen_W5o97Dy_4qUlACLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.18.20.png"><img src="https://3.bp.blogspot.com/-mB5dxE3pyMQ/WuCOPhH0dhI/AAAAAAAAIsM/SZiLCNuxCWoI78quWen_W5o97Dy_4qUlACLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.18.20.png"></a></p>
<p>接著把頁面簡單做起來</p>
<p><a href="https://2.bp.blogspot.com/-mBcGm-zF5Ac/WuCPANF6GMI/AAAAAAAAIsc/-GE55rw9U1Q2cnTS8lL8ou0jXsAecxLzgCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.21.21.png"><img src="https://2.bp.blogspot.com/-mBcGm-zF5Ac/WuCPANF6GMI/AAAAAAAAIsc/-GE55rw9U1Q2cnTS8lL8ou0jXsAecxLzgCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.21.21.png"></a><br><a href="https://4.bp.blogspot.com/-pBkzKrxXseo/WuCPK5DBR6I/AAAAAAAAIsg/hpxvNjOdxQAczfyTuTyNsAC4OnRP7jYfwCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.21.35.png"><img src="https://4.bp.blogspot.com/-pBkzKrxXseo/WuCPK5DBR6I/AAAAAAAAIsg/hpxvNjOdxQAczfyTuTyNsAC4OnRP7jYfwCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.21.35.png"></a><br>寫一個Action來接收傳過來的資料</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">HttpPost</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">SignUp</span>(<span class="params"><span class="built_in">string</span> account,<span class="built_in">string</span> password</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">bool</span> Result = <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//帳號密碼都不能為空值</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(account) &amp;amp;&amp;amp;</span><br><span class="line">        !<span class="built_in">string</span>.IsNullOrWhiteSpace(password))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//帳號必須要有@字元</span></span><br><span class="line">        <span class="comment">//密碼必須大於六個字元</span></span><br><span class="line">        <span class="keyword">if</span> (account.Contains(<span class="string">&quot;@&quot;</span>) &amp;amp;&amp;amp; password.Length &amp;gt; <span class="number">6</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//我們判斷是否有註冊過的帳號,因為還沒有連結資料庫</span></span><br><span class="line">            <span class="comment">//所以先假定steven@mymail.com被註冊過</span></span><br><span class="line">            <span class="keyword">if</span> (account != <span class="string">&quot;steven@mymail.com&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                TempData[<span class="string">&quot;Message&quot;</span>] = <span class="string">&quot;註冊成功!!&quot;</span>;</span><br><span class="line">                Result = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                TempData[<span class="string">&quot;Message&quot;</span>] = <span class="string">&quot;帳號已經存在&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            TempData[<span class="string">&quot;Message&quot;</span>] = <span class="string">&quot;帳號密碼不符合格式&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        TempData[<span class="string">&quot;Message&quot;</span>] = <span class="string">&quot;帳號密碼不能為空值&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (Result)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//註冊成功,導到首頁 </span></span><br><span class="line">        <span class="keyword">return</span> RedirectToAction(<span class="string">&quot;index&quot;</span>, <span class="string">&quot;home&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> RedirectToAction(<span class="string">&quot;signup&quot;</span>, <span class="string">&quot;user&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這邊注意到我們的Attribute就下了HttpPost，表示只有Post可以呼叫到這個Action，而我們在Form那邊也設定了方法用Post</p>
<p><a href="https://2.bp.blogspot.com/-H9l67uz1TCk/WuCUxsRdhXI/AAAAAAAAIs4/SvdmC3Fc8nkKSVrlqhA6zSGoLOwfsvVkQCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.45.44.png"><img src="https://2.bp.blogspot.com/-H9l67uz1TCk/WuCUxsRdhXI/AAAAAAAAIs4/SvdmC3Fc8nkKSVrlqhA6zSGoLOwfsvVkQCLcBGAs/s320/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.45.44.png"></a><br>接著你可能會注意到裡面有用到TempData，通常TempData是用來跨Action傳遞資料用的，底層其實是將資料存在Session之中，而且你只要取用過一次裡面的值就會被清掉。 而因為我們這個Action只是在處理註冊的相關邏輯，執行完後可以看到最後回傳的都是RedirectToAction，也就是導到我們指定的Action去回傳頁面，所以會跨兩個Action以上，存在TempData是個簡單的處理方式。</p>
<p>接著執行看看你會發現，好像一切有照著我們的邏輯在執行，但唯獨訊息不會顯示出來，因為我們雖然將TempData之中，卻沒有寫顯示訊息的那一段，通常這一段邏輯我們會放在共用的_Layout裡面。</p>
<p><a href="https://1.bp.blogspot.com/-ozg16dsOSrE/WuCd9w_QvKI/AAAAAAAAItw/vCUtqPBHZHwgPF4bVbw47tKhBfhEPIkNACLcBGAs/s1600/14.png"><img src="https://1.bp.blogspot.com/-ozg16dsOSrE/WuCd9w_QvKI/AAAAAAAAItw/vCUtqPBHZHwgPF4bVbw47tKhBfhEPIkNACLcBGAs/s400/14.png"></a></p>
<p><a href="https://2.bp.blogspot.com/-E1x50TUS8NQ/WuCXYxIgwPI/AAAAAAAAItI/aLOGjZ82wJ0Pjy-OxOBEdaa6kPXFmN9DQCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.57.06.png"><img src="https://2.bp.blogspot.com/-E1x50TUS8NQ/WuCXYxIgwPI/AAAAAAAAItI/aLOGjZ82wJ0Pjy-OxOBEdaa6kPXFmN9DQCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.57.06.png"></a><br>因為還沒解說View的關係，這邊就先照著寫，之後會解說到。再次執行就會發現訊息會正確S顯示出來了。</p>
<p><a href="https://1.bp.blogspot.com/-OFHFUMFcMwE/WuCX5I_64XI/AAAAAAAAItQ/FGMQUMK-RD4bq8lkfPJBI5aLPd_n2l2dgCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.59.20.png"><img src="https://1.bp.blogspot.com/-OFHFUMFcMwE/WuCX5I_64XI/AAAAAAAAItQ/FGMQUMK-RD4bq8lkfPJBI5aLPd_n2l2dgCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.59.20.png"></a><br><a href="https://2.bp.blogspot.com/-XWHUszO3mxw/WuCX9g656vI/AAAAAAAAItU/DyrM8bb1848t9nO4xT8Pn4OgFGzhEEw2gCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.59.36.png"><img src="https://2.bp.blogspot.com/-XWHUszO3mxw/WuCX9g656vI/AAAAAAAAItU/DyrM8bb1848t9nO4xT8Pn4OgFGzhEEw2gCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258810.59.36.png"></a></p>
<p>上述的Controller撰寫方式，就是通常我們在Controller做的工作，驗證參數 、 依據使用者輸入的值執行對應的邏輯 、最後回傳結果。但你應該也會發現，整個Action邏輯裡面光是驗證參數就佔了大半的篇幅，這往往會讓程式碼複雜度提高，閱讀變得困難，這部分我們會在下一篇講解該如何把這類的邏輯分隔出去，讓程式碼更好維護美觀一些。另外Action其實還可以回傳很多種結果，前面範例用到了</p>
<div class="note info">
            <p>View ： 回傳頁面<br>RedirectToAction ：回傳導頁結果</p>
          </div>

<p>底層還支援了一些回傳方式，靈活應用就可以達成大部分的功能了。詳細參考：&nbsp;<a href="https://msdn.microsoft.com/zh-tw/library/dd410269(v=vs.98).aspx">ＭＳＤＮ</a></p>
<p><a href="https://2.bp.blogspot.com/-68Q1RXjX860/WuCZYQn2b7I/AAAAAAAAItk/MkjLnK3AXeIj_LtiX_SUBJRJZUMpBzghwCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258811.05.55.png"><img src="https://2.bp.blogspot.com/-68Q1RXjX860/WuCZYQn2b7I/AAAAAAAAItk/MkjLnK3AXeIj_LtiX_SUBJRJZUMpBzghwCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-04-25%2B%25E4%25B8%258B%25E5%258D%258811.05.55.png"></a></p>
]]></content>
      <categories>
        <category>學習MVC</category>
      </categories>
      <tags>
        <tag>MVC教學</tag>
      </tags>
  </entry>
  <entry>
    <title>【RazorEngine】套寄信、罐頭訊息內容的好幫手</title>
    <url>/2018/01/17/%E3%80%90RazorEngine%E3%80%91%E5%A5%97%E5%AF%84%E4%BF%A1%E3%80%81%E7%BD%90%E9%A0%AD%E8%A8%8A%E6%81%AF%E5%85%A7%E5%AE%B9%E7%9A%84%E5%A5%BD%E5%B9%AB%E6%89%8B/</url>
    <content><![CDATA[<p>本篇使用套件 : <a href="https://github.com/Antaris/RazorEngine">RazorEngine</a>&nbsp; &nbsp;【<a href="https://antaris.github.io/RazorEngine/">官方文件&nbsp;</a>】</p>
<p>遙想當年巷口寶之林還開著時，我這鄉野村夫每每需要套Email寄信格式以及一些罐頭訊息時，總是串一堆字串，既醜又難維護</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">Test</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            sb.AppendLine(<span class="built_in">string</span>.Format(<span class="string">@&quot;Hello &#123;0&#125;, welcome to RazorEngine!&quot;</span>,name));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Content(sb.ToString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果碰到麻煩一點的，像是什麼狀況要套表頭，某某狀況又要移除Footer，那整個字串的邏輯東拼西湊，最後不執行根本難以看出結果會變成如何，往往就變成維護的黑洞跟死角<strike>誰接手誰倒楣</strike>。</p>
<p>自從我認識了RazorEngine這套件後，世界就變美好了，只要你會套.Net MVC的View，那基本上這個套件絕對是適合你的神兵利器，廢話不多說，我們先來將剛剛版本改成用RazorEngine處理</p>
<p>先去Nuget安裝套件</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-C5_gHPnJWEc/Wl64J_9mh5I/AAAAAAAAISA/GiHxPzZP9Qs9OyY_eVI4FrxHeD7MELXxQCLcBGAs/s400/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://3.bp.blogspot.com/-C5_gHPnJWEc/Wl64J_9mh5I/AAAAAAAAISA/GiHxPzZP9Qs9OyY_eVI4FrxHeD7MELXxQCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p>套上RazorEngine後，可以改成這樣 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">TestRazorEngine</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="built_in">string</span> template = <span class="string">&quot;Hello @Model.Name, welcome to RazorEngine!&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> Result = Engine.Razor.RunCompile(</span><br><span class="line">                            templateSource: template,</span><br><span class="line">                            name: <span class="string">&quot;HelloWorldTemplateKey&quot;</span>, </span><br><span class="line">                            modelType: <span class="literal">null</span>,</span><br><span class="line">                            model: <span class="keyword">new</span> &#123; Name = name &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Content(Result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這邊解說一下程式碼，RazorEnginr提供了幾種方法來產生編譯過的Template，分別是</p>
<p>**Run **: 依據帶入的Name去尋找Cache中是否有編譯過的Template，如果Cache沒有這個Name的模板，則會跳Exception</p>
<p>**Compile **: 將帶入的模板內容編譯，並存進Cache</p>
<p>**RunCompile **: 等於上面兩者個結合，先去Cache中找看看有無這個Name的模板，有則直接回傳，沒有則先編譯後存入Cache，並回傳</p>
<p>依據官方文件所提到的，Compile Template是很耗效能的，所以建議都要存入Cache，避免每次去Compile(預設行為就是如此，當然之後也會提到如何改寫)</p>
<p>有了初步的認識後，應該會發現目前的做法跟拼湊字串一樣，如果只是這樣也就失去了使用RazorEngine的意義了，所以下一步是將這個Template內容變成.cshtml，可以大大的增加可讀性跟維護姓</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-pfz4iweMebY/Wl68R2ISmxI/AAAAAAAAISM/aEjP8lgBlY0krsOinpRLB1Q88251KecqQCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://3.bp.blogspot.com/-pfz4iweMebY/Wl68R2ISmxI/AAAAAAAAISM/aEjP8lgBlY0krsOinpRLB1Q88251KecqQCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">新增_HelloWorld.cshtml Template</td></tr></tbody></table>將剛剛的字串貼進去，並且就像我們一般套版一樣，建立對應的ViewModel
<div class="separator" style="clear: both; text-align: center;">
</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-cEGoNuCIBPc/Wl68rMWc_6I/AAAAAAAAISQ/wECO1yhBn2My81LPW3lK9aKo9QfXMHnOACLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://2.bp.blogspot.com/-cEGoNuCIBPc/Wl68rMWc_6I/AAAAAAAAISQ/wECO1yhBn2My81LPW3lK9aKo9QfXMHnOACLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HellowWorldRazorModel</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>原本的程式碼改寫成如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">TestRazorEngine</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> Result =  Engine.Razor.RunCompile(</span><br><span class="line">                            <span class="string">&quot;_HelloWorld&quot;</span>, </span><br><span class="line">                            <span class="keyword">typeof</span>(HellowWorldRazorModel), </span><br><span class="line">                            <span class="keyword">new</span> HellowWorldRazorModel &#123; Name = name &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Content(Result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但執行之後就會出Exception，原因是”_HelloWorld”這個Template Name它不知道怎麼對應到哪個cshtml模板</p>
<div class="separator" style="clear: both; text-align: center;"></div><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-8LQ2IYJBnmI/Wl6-F94TFFI/AAAAAAAAISg/FuId2F7jKVYBpu3wOMLY1UPSkOY2P5E2QCLcBGAs/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://4.bp.blogspot.com/-8LQ2IYJBnmI/Wl6-F94TFFI/AAAAAAAAISg/FuId2F7jKVYBpu3wOMLY1UPSkOY2P5E2QCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p>所以我們要自己寫RazorEngine的ITemplateManager :&nbsp; <a href="http://antaris.github.io/RazorEngine/TemplateManager.html#ITemplateManager-and-ICachingProvider">官方文件參考</a></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyTemplateManager</span> : <span class="title">ITemplateManager</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> ITemplateSource <span class="title">Resolve</span>(<span class="params">ITemplateKey key</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Resolve your template here (ie read from disk)</span></span><br><span class="line">            <span class="comment">// if the same templates are often read from disk you propably want to do some caching here.</span></span><br><span class="line">            <span class="keyword">var</span> template = Tools.ChkCache(key.Name) <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(template))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> FilePath = <span class="built_in">string</span>.Format(<span class="string">&quot;~/Views/RazorTemplate/&#123;0&#125;.cshtml&quot;</span>, key.Name);</span><br><span class="line">                template = File.ReadAllText(HttpContext.Current.Server.MapPath(FilePath));</span><br><span class="line"></span><br><span class="line">                Tools.SaveToCache(key.Name, template, <span class="number">3600</span>, CacheType.Absolute, <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// Provide a non-null file to improve debugging</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> LoadedTemplateSource(template, <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ITemplateKey <span class="title">GetKey</span>(<span class="params"><span class="built_in">string</span> name, ResolveType resolveType, ITemplateKey context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// If you can have different templates with the same name depending on the </span></span><br><span class="line">            <span class="comment">// context or the resolveType you need your own implementation here!</span></span><br><span class="line">            <span class="comment">// Otherwise you can just use NameOnlyTemplateKey.</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> NameOnlyTemplateKey(name, resolveType, context);</span><br><span class="line">            <span class="comment">// template is specified by full path</span></span><br><span class="line">            <span class="comment">//return new FullPathTemplateKey(name, fullPath, resolveType, context);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">AddDynamic</span>(<span class="params">ITemplateKey key, ITemplateSource source</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// You can disable dynamic templates completely. </span></span><br><span class="line">            <span class="comment">// This just means all convenience methods (Compile and RunCompile) with</span></span><br><span class="line">            <span class="comment">// a TemplateSource will no longer work (they are not really needed anyway).</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException(<span class="string">&quot;dynamic templates are not supported!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這邊我只改寫Resolve這個方法，其他都沿用官方文件的範本，內容只要是依據帶入的Name去確認Cache是否已經有Template(<span style="font-size: x-small;">因為用公司的底層套件，所以確認Cache跟Save Cache可能跟一般認知的方法不同，請忽略或用.Net提供的Cache方法即可</span>)，如果沒有快取，則依據帶入的Name去對應的Folder位置讀取.cshtml並且Cache，然後透過RazorEngine提供的方法LoadedTemplateSource回傳TemplateSource。</p>
<p>這一段可以讓RazorEngine知道如何將Name對應到我們的cshtml，寫完客製的MyTemplateManager後接著是設定</p>
<p>Global.asax加上這段</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Application_Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            AreaRegistration.RegisterAllAreas();</span><br><span class="line">            FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters);</span><br><span class="line">            RouteConfig.RegisterRoutes(RouteTable.Routes);</span><br><span class="line">            BundleConfig.RegisterBundles(BundleTable.Bundles);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//RazorEngine Setting</span></span><br><span class="line">            <span class="keyword">var</span> config = <span class="keyword">new</span> TemplateServiceConfiguration();</span><br><span class="line">            config.TemplateManager = <span class="keyword">new</span> MyTemplateManager();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> service = RazorEngineService.Create(config);</span><br><span class="line">            Engine.Razor = service;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接著剛剛的程式就能執行了!! </p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-NWxWGypeAdo/Wl7AVFb9jRI/AAAAAAAAISs/24bA9qjOkTwoY1ca8SDc8_OXhuB3vI_2QCLcBGAs/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://3.bp.blogspot.com/-NWxWGypeAdo/Wl7AVFb9jRI/AAAAAAAAISs/24bA9qjOkTwoY1ca8SDc8_OXhuB3vI_2QCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>
RazorEngine也提供Layout的套版方法，可以在cshmtl上面設定對應的Layout，不用像先前提到的，拼字串拼得亂七八糟了
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-lOts6puSj9Q/Wl7BYAAbwJI/AAAAAAAAIS0/E05MfohLLpgG0Cp2x63uJ8i6ZL-ifJdagCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://3.bp.blogspot.com/-lOts6puSj9Q/Wl7BYAAbwJI/AAAAAAAAIS0/E05MfohLLpgG0Cp2x63uJ8i6ZL-ifJdagCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">新增_OurLayout.cshmtl</td></tr></tbody></table>

<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-e3Q9NSlCVuk/Wl7Bsff9odI/AAAAAAAAIS4/J0XN1F7PPW0rqsRmvA9yw5cGcTeAjJiawCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://3.bp.blogspot.com/-e3Q9NSlCVuk/Wl7Bsff9odI/AAAAAAAAIS4/J0XN1F7PPW0rqsRmvA9yw5cGcTeAjJiawCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">Layout的內容</td></tr></tbody></table>

<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-ugzdMhXnb3w/Wl7CFh0QMAI/AAAAAAAAITA/yxDlQmxK1f4X_4zjamWyCEJnoTUWgwfkgCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://3.bp.blogspot.com/-ugzdMhXnb3w/Wl7CFh0QMAI/AAAAAAAAITA/yxDlQmxK1f4X_4zjamWyCEJnoTUWgwfkgCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p>執行結果</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-t8lTrthvFXQ/Wl7CXvDYDMI/AAAAAAAAITE/k4aTtPG7zsIUmvUG4U5hvI7nyOpV6JzmACLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://1.bp.blogspot.com/-t8lTrthvFXQ/Wl7CXvDYDMI/AAAAAAAAITE/k4aTtPG7zsIUmvUG4U5hvI7nyOpV6JzmACLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p><strong>RazorEngine PartialView的用法</strong></p>
<p>在一般套版，我們可能會把共用的區塊挖成PartialView重複使用，但這邊的用法比較特別，須改用Include這個方法取代</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://4.bp.blogspot.com/-m5NwrfUZcMs/Wl7C11d-lnI/AAAAAAAAITM/AA-QS-UbaEgFXr8MUjx3olooVMgAEkLbwCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://4.bp.blogspot.com/-m5NwrfUZcMs/Wl7C11d-lnI/AAAAAAAAITM/AA-QS-UbaEgFXr8MUjx3olooVMgAEkLbwCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">新增PartialView</td></tr></tbody></table>

<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://1.bp.blogspot.com/-NvEYUWh1nkw/Wl7DBfTkNOI/AAAAAAAAITQ/SBSCU6uWL2ck3U7nncXsEo4q5mdRFboiQCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://1.bp.blogspot.com/-NvEYUWh1nkw/Wl7DBfTkNOI/AAAAAAAAITQ/SBSCU6uWL2ck3U7nncXsEo4q5mdRFboiQCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">PartialView的內容，而且也可以使用ViewBag傳遞參數</td></tr></tbody></table>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://1.bp.blogspot.com/-Ll9MHoSaYtM/Wl7Dk_WcOGI/AAAAAAAAITY/8CF1z0SXs2M21_tS3YCH5KrEY6WP6zAAgCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://1.bp.blogspot.com/-Ll9MHoSaYtM/Wl7Dk_WcOGI/AAAAAAAAITY/8CF1z0SXs2M21_tS3YCH5KrEY6WP6zAAgCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">改寫原本的_HelloWorld.cshtml，套入PartialView</td></tr></tbody></table>

<p>執行結果!!</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-osb6w9vTl8o/Wl7D2hzXn2I/AAAAAAAAITc/KpzyaZf08Fseqa10QxbEEaIdKAJDELv6gCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://3.bp.blogspot.com/-osb6w9vTl8o/Wl7D2hzXn2I/AAAAAAAAITc/KpzyaZf08Fseqa10QxbEEaIdKAJDELv6gCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p>希望對大家有幫助~</p>
]]></content>
      <tags>
        <tag>RazorEngine</tag>
      </tags>
  </entry>
  <entry>
    <title>【SQL】Group by and Top 1</title>
    <url>/2013/05/29/%E3%80%90SQL%E3%80%91Group-by-and-Top-1/</url>
    <content><![CDATA[<p>參考：<a href="http://www.dotblogs.com.tw/joysdw12/archive/2011/12/28/63596.aspx">[SQL] 於多筆重複資料中取得該重複群組中最新一筆資料</a></p>
<p>今天也遇到一個需求是將group by完後的資料挑出最新的一筆<br>模擬的原始資料大致如下<br><a href="http://1.bp.blogspot.com/-aelfyc7IvaY/UaXE0bMvmsI/AAAAAAAADmg/NyXn94jNZXQ/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png"><img src="http://1.bp.blogspot.com/-aelfyc7IvaY/UaXE0bMvmsI/AAAAAAAADmg/NyXn94jNZXQ/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png"></a></p>
<p>我希望抓出每個人在在每個地點所做的最後一件事情，寫法如下: </p>
<ul>
<li>先將每個人跟地點透過時間由大到小歸類          ```sql<br>select *  ,ROW_NUMBER() over(partition by location,who order by time Desc ) as row_index<pre><code>       from timeline
</code></pre>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">         [![](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-hbcc3sD90ek&#x2F;UaXGjjKL0UI&#x2F;AAAAAAAADmw&#x2F;jh2ks4iABqM&#x2F;s1600&#x2F;%E6%9C%AA%E5%91%BD%E5%90%8D.png)](http:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-hbcc3sD90ek&#x2F;UaXGjjKL0UI&#x2F;AAAAAAAADmw&#x2F;jh2ks4iABqM&#x2F;s1600&#x2F;%E6%9C%AA%E5%91%BD%E5%90%8D.png)*   然後        &#96;&#96;&#96;sql</span><br><span class="line">select *</span><br><span class="line">         from (</span><br><span class="line">              select *  ,ROW_NUMBER() over(partition by location,who order by time Desc ) as row_index</span><br><span class="line">              from timeline) as tempTable</span><br><span class="line">         where tempTable.row_index &#x3D; 1</span><br><span class="line">       </span><br></pre></td></tr></table></figure>
<pre><code>   [![](http://4.bp.blogspot.com/-E-Syl1jp57A/UaXHnZ_4jwI/AAAAAAAADm8/4cLCGkPmMag/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png)](http://4.bp.blogspot.com/-E-Syl1jp57A/UaXHnZ_4jwI/AAAAAAAADm8/4cLCGkPmMag/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png)*   結論就是早點回家，否則也只是在公司吃東西而已 XD
</code></pre>
]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【Regular Expression】分群與取代</title>
    <url>/2017/01/20/%E3%80%90Regular-Expression%E3%80%91%E5%88%86%E7%BE%A4%E8%88%87%E5%8F%96%E4%BB%A3/</url>
    <content><![CDATA[<p>在正規表示法中，可以將比對的資料做分群與命名，而在.Net中的語法是</p>
<div class="note info">
            <p>(?:&lt;群組名稱&gt;)</p>
          </div>

<p>應用方法如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">string</span> Date = <span class="string">&quot;2017/1/20&quot;</span>;</span><br><span class="line">Regex reg = <span class="keyword">new</span> Regex(<span class="string">@&quot;^(?&lt;Year&gt;\d&#123;4&#125;)/(?&lt;Month&gt;\d&#123;1,2&#125;)/(?&lt;Day&gt;\d&#123;1,2&#125;)&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> Match = reg.Match(Date);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Concat(<span class="string">&quot;年 :&quot;</span>, Match.Groups[<span class="string">&quot;Year&quot;</span>].Value));</span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Concat(<span class="string">&quot;月 :&quot;</span>,Match.Groups[<span class="string">&quot;Month&quot;</span>].Value));</span><br><span class="line">Console.WriteLine(<span class="built_in">string</span>.Concat(<span class="string">&quot;日 :&quot;</span>,Match.Groups[<span class="string">&quot;Day&quot;</span>].Value));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a href="https://2.bp.blogspot.com/-CiGMf3bSGws/WIFyaQRw3PI/AAAAAAAAIDk/gPerLAyakjoD8gzowmXLB08hPVCK5rIXQCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png"><img src="https://2.bp.blogspot.com/-CiGMf3bSGws/WIFyaQRw3PI/AAAAAAAAIDk/gPerLAyakjoD8gzowmXLB08hPVCK5rIXQCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png"></a></p>
<p>也可以用來做取代的用途</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">string</span> Date = <span class="string">&quot;2017/1/20&quot;</span>;</span><br><span class="line">Regex reg = <span class="keyword">new</span> Regex(<span class="string">@&quot;^(\d&#123;4&#125;)/(\d&#123;1,2&#125;)/(\d&#123;1,2&#125;)&quot;</span>);</span><br><span class="line"></span><br><span class="line">Console.WriteLine(reg.Replace(Date,<span class="string">@&quot;$1年$2月$3日&quot;</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-HQu1GmHFF_M/WIFzWkDPQQI/AAAAAAAAIDo/k5REjSoQ7fMeQBuCYZe7QRSQlXG0SXlFgCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://4.bp.blogspot.com/-HQu1GmHFF_M/WIFzWkDPQQI/AAAAAAAAIDo/k5REjSoQ7fMeQBuCYZe7QRSQlXG0SXlFgCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>

<p>括號()包起來的地方，正規表示法比對到時會把他當作一個群組，而其中Replace的地方寫著 <strong>$1</strong>代表第一個括號比對的東西放這邊，所以$1會變成2017，後面以此類推，就會變成<strong>2017年1月20日</strong>這種格式。</p>
<p>所以也可以改成這樣，變成國外表示年份的格式**$2-$3-$1**，就會變成 1-20-2017</p>
<p>以上筆記一下。</p>
]]></content>
      <tags>
        <tag>Regular Expression</tag>
      </tags>
  </entry>
  <entry>
    <title>【SQL】Group by and Top 1 (用Linq實做)</title>
    <url>/2016/06/04/%E3%80%90SQL%E3%80%91Group-by-and-Top-1-%E7%94%A8Linq%E5%AF%A6%E5%81%9A/</url>
    <content><![CDATA[<p><a href="http://toyo0103.blogspot.tw/2013/05/sqlgroup-by-and-top-1.html">【SQL】Group by and Top 1</a><br>之前有寫一篇是如何將資料歸類完後，取得各個分類第一筆的文章，歲月如梭竟然已經是2013年的文章了。</p>
<p>最近碰到相同的問題，卻需要用Linq來解決，研究了一下後來把他順便筆記下來，狀況全部呈第一篇文章的資料結構</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> WhatAreYouDoing = <span class="keyword">from</span> t <span class="keyword">in</span> <span class="keyword">this</span>.timeline</span><br><span class="line">        <span class="keyword">group</span> t <span class="keyword">by</span> <span class="keyword">new</span> &#123;t.location, t.who &#125;</span><br><span class="line">        <span class="keyword">into</span> Group</span><br><span class="line">        <span class="keyword">select</span> Group.OrderByDescending(x=&gt;x.time).Take(<span class="number">1</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣就能達到一樣的效果了(騙文章數來著?)</p>
]]></content>
      <tags>
        <tag>SQL</tag>
        <tag>LINQ</tag>
        <tag>LINQ TO SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【Regular Expression】正向環視、反向環視</title>
    <url>/2017/01/04/%E3%80%90Regular-Expression%E3%80%91%E6%AD%A3%E5%90%91%E7%92%B0%E8%A6%96%E3%80%81%E5%8F%8D%E5%90%91%E7%92%B0%E8%A6%96/</url>
    <content><![CDATA[<p>說正向環視、反向環視感覺有點文謅謅的而且很難懂，其實白話文就是，比對這個位置的左(<strong>反向環視</strong>)右邊(<strong>正向環視</strong>)是否符合你下的條件，舉個例子</p>
<p><span style="background-color: #f3f3f3;">**<br>**</span><span style="background-color: #f3f3f3;">**註: **以下案例可以透過 <a href="https://regex101.com/">https://regex101.com/</a> 做即時操作與測試</span></p>
<p>我想將下面中文的空格濾掉</p>
<div class="note info">
            <p>哈 摟 你 好 嗎 ? Hello how are you?</p>
          </div>

<p>變成這樣 </p>
<div class="note info">
            <p>哈摟你好嗎? Hello how are you?</p>
          </div>

<p>如果要透過正規表示法比對出空格其實很簡單，只要下<span style="background-color: #cccccc;">&nbsp;**\s **</span>即可，但如果這樣的話會變成這樣的結果。</p>
<div class="note info">
            <p>哈摟你好嗎?Hellohowareyou?</p>
          </div>

<p>因為所有的空格都被濾掉了，但其實英文跟英文單字之間的空格不能濾掉，這樣就變成無法理解的句子了，所以把我們的規則用中文表達就變成【<strong>我想濾掉空格，但該空格的左邊與右邊不能是英文字母</strong>】</p>
<p>這時候正向環視與反性環視就派上用場了</p>
<table><thead><tr><td>名稱</td><td>正規表示法</td><td>解釋</td></tr></thead><tbody><tr><td>正向環視</td><td>(?=)</td><td>這位置右邊要出現什麼</td></tr><tr><td>反向環視</td><td>(?&lt;=)</td><td>這位置左邊要出現什麼</td></tr><tr><td>正向環視否定</td><td>(?!)</td><td>這位置右邊不能出現什麼</td></tr><tr><td>反向環視否定</td><td>(?&lt;!)</td><td>這位置左邊不能出現什麼</td></tr></tbody></table>
所以剛剛的表達方法應該改成 **(?&lt;![a-zA-Z])\s****(?![a-zA-Z])**<span style="background-color: #cccccc; font-weight: bold;">&nbsp;</span><span style="background-color: white;">，其中</span>**(?&lt;![a-zA-Z])**<span style="background-color: white;">表示空格的左邊不能出現英文字母，</span>**(?![a-zA-Z])**<span style="background-color: #cccccc; font-weight: bold;">&nbsp;</span><span style="background-color: white;">表示空格右邊的不能出現英文字母，只有這樣的空格才符合我們要求的，把他過濾掉，結果就會變成我們要的結果了</span>
<span style="background-color: white;">
</span><span style="background-color: white;">
</span>
最後還有一個讀到的案例覺得也很實用，常常我們會需要在金錢上加上【，】來方便理解位數，例如
<div class="note info">
            <p>123,123,123</p>
          </div>

<p>所以當我們拿到123456時，該怎麼把逗號加上去? 用中文表達就是，<strong>【我希望這個位置的右邊如果有三個數字，就幫我加上逗號】</strong>，所以寫出了**(?=\d{3})**<span style="background-color: white;">，結果就變成了這樣</span><br><span style="background-color: white;"><br></span></p>
<div class="note info">
            <p>,1,2,3,456</p>
          </div>
<p>看起來怪怪的，但其實符合我們下的判斷式，因為1、2、3右邊都可以數到三個數字，所以補上逗號合理，更精確我們的描述成<strong>【我希望這個位置的右邊有三個數字為一組，且比對到右邊不是數字為止，幫我加上逗號】</strong>，判斷式變成這樣**(?=(\d{3})+(?!\d))<strong><span style="background-color: white;">，其中三個數字一組的表達式</span></strong>(\d{3})+<strong><span style="background-color: white;">，且比對到右邊不是數字為止</span></strong>(?!\d)**<span style="background-color: white;">，結果變成如下</span><br><span style="background-color: white;"><br></span></p>
<div class="note info">
            <p>,123,456</p>
          </div>
<p>的確三個數字一組的補上逗號，但是最一開頭那邊不應該有逗號，所以應該加上一串描述<strong>【且左邊要是數字時，才補上逗號】</strong>，所以最後結果就變成**(?=(\d{3})+(?!\d))(?&lt;=\d)**<span style="background-color: white;">，而且切出來也就會剛剛好的</span><br><span style="background-color: white;"><br></span></p>
<div class="note info">
            <p>123,456</p>
          </div>
]]></content>
      <tags>
        <tag>Regular Expression</tag>
      </tags>
  </entry>
  <entry>
    <title>【SQL】SQL的foreach，逐筆執行</title>
    <url>/2014/03/13/%E3%80%90SQL%E3%80%91SQL%E7%9A%84foreach%EF%BC%8C%E9%80%90%E7%AD%86%E5%9F%B7%E8%A1%8C/</url>
    <content><![CDATA[<p>需求:將Table_A的資料塞到Table_B，並把Table_B產生的ID編號回寫回Table_A的對應欄位 ```sql<br>– 宣告變數<br>DECLARE @para1 VARCHAR(50)<br>DECLARE @para2 uniqueidentifier<br>DECLARE @para3 VARCHAR(100)</p>
<p>– 宣告指標變數<br>DECLARE _cursor CURSOR FOR<br>SELECT s1,s2,s3 FROM Table_A where eiplstatus = 1</p>
<p>– 啟用指標變數<br>OPEN _cursor<br>– 以指標變數為基準點, 將取出的欄位值,依序塞給我們自訂的變數，亦即將每筆s1 =&gt; @para1、 s2 =&gt; @para2 、s3 =&gt; @para3<br>FETCH NEXT FROM _cursor INTO @para1,@para2,@para3</p>
<p>WHILE @@FETCH_STATUS = 0<br>BEGIN<br>    insert into Table_B(c1,c2,c3) values(@para1,@para2,@para3)<br>    SET @id = SCOPE_IDENTITY();</p>
<pre><code>update Table_A set id = @id where CURRENT of _cursor

-- 指標變數往下移動, 並將取出的欄位值, 設定給我們自訂的變數
FETCH NEXT FROM _cursor INTO @para1,@para2,@para3
</code></pre>
<p>END</p>
<p>– 關閉指標變數<br>CLOSE _cursor<br>– 釋放指標變數<br>DEALLOCATE _cursor</p>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【SQL】PIVOT 讓搜尋結果橫式表現</title>
    <url>/2016/03/08/%E3%80%90SQL%E3%80%91PIVOT-%E8%AE%93%E6%90%9C%E5%B0%8B%E7%B5%90%E6%9E%9C%E6%A9%AB%E5%BC%8F%E8%A1%A8%E7%8F%BE/</url>
    <content><![CDATA[<p>有時候SQL搜尋出來的資料是直式的，但偏偏PM們常常想看的卻是橫式報表，狀況模擬如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@Report</span> <span class="keyword">TABLE</span> (</span><br><span class="line">CompanyName <span class="type">varchar</span>(<span class="number">8</span>),</span><br><span class="line">[<span class="keyword">Year</span>] <span class="type">int</span>,</span><br><span class="line">[<span class="keyword">Month</span>] <span class="type">int</span>,</span><br><span class="line">Revenue <span class="type">int</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="variable">@Report</span> <span class="keyword">values</span>(<span class="string">&#x27;A公司&#x27;</span>,<span class="number">2016</span>,<span class="number">1</span>,<span class="number">100</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="variable">@Report</span> <span class="keyword">values</span>(<span class="string">&#x27;A公司&#x27;</span>,<span class="number">2016</span>,<span class="number">2</span>,<span class="number">100</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="variable">@Report</span> <span class="keyword">values</span>(<span class="string">&#x27;A公司&#x27;</span>,<span class="number">2016</span>,<span class="number">3</span>,<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="variable">@Report</span> <span class="keyword">values</span>(<span class="string">&#x27;B公司&#x27;</span>,<span class="number">2016</span>,<span class="number">1</span>,<span class="number">200</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="variable">@Report</span> <span class="keyword">values</span>(<span class="string">&#x27;B公司&#x27;</span>,<span class="number">2016</span>,<span class="number">2</span>,<span class="number">200</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="variable">@Report</span> <span class="keyword">values</span>(<span class="string">&#x27;B公司&#x27;</span>,<span class="number">2016</span>,<span class="number">3</span>,<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="variable">@Report</span> <span class="keyword">values</span>(<span class="string">&#x27;總公司&#x27;</span>,<span class="number">2016</span>,<span class="number">1</span>,<span class="number">300</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="variable">@Report</span> <span class="keyword">values</span>(<span class="string">&#x27;總公司&#x27;</span>,<span class="number">2016</span>,<span class="number">2</span>,<span class="number">300</span>)</span><br><span class="line"><span class="keyword">insert</span> <span class="variable">@Report</span> <span class="keyword">values</span>(<span class="string">&#x27;總公司&#x27;</span>,<span class="number">2016</span>,<span class="number">3</span>,<span class="number">300</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> <span class="variable">@Report</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-qirx6weBsrU/Vt4qvqqJUMI/AAAAAAAAHus/HnoX8Epl2xY/s320/1.png)](https://3.bp.blogspot.com/-qirx6weBsrU/Vt4qvqqJUMI/AAAAAAAAHus/HnoX8Epl2xY/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">這是資料在資料庫裡面的記錄方式</td></tr></tbody></table>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://4.bp.blogspot.com/-u18YG_Pkcro/Vt4rc9-XmnI/AAAAAAAAHuw/R12QCiukmio/s1600/1.png)](https://4.bp.blogspot.com/-u18YG_Pkcro/Vt4rc9-XmnI/AAAAAAAAHuw/R12QCiukmio/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">PM想看到的</td></tr></tbody></table>

<p>還好MS SQL 2005之後提供PIVOT來解決這種問題，實際SQL如下</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> </span><br><span class="line">[<span class="type">date</span>] <span class="keyword">as</span> <span class="string">&#x27;年/月份&#x27;</span>,</span><br><span class="line">[A公司] <span class="keyword">as</span> <span class="string">&#x27;A公司&#x27;</span> ,[B公司] <span class="keyword">as</span> <span class="string">&#x27;B公司&#x27;</span> ,([A公司] <span class="operator">+</span> [B公司] <span class="operator">+</span> [總公司]) <span class="keyword">as</span> <span class="string">&#x27;總公司&#x27;</span></span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line"> <span class="keyword">select</span></span><br><span class="line"> CompanyName,</span><br><span class="line"> <span class="built_in">cast</span>([<span class="keyword">Year</span>] <span class="keyword">as</span> <span class="type">char</span>(<span class="number">4</span>)) <span class="operator">+</span> <span class="string">&#x27;/&#x27;</span> <span class="operator">+</span> <span class="built_in">cast</span>([<span class="keyword">Month</span>] <span class="keyword">as</span> <span class="type">char</span>(<span class="number">2</span>)) <span class="keyword">as</span> [<span class="type">date</span>],</span><br><span class="line"> Revenue</span><br><span class="line"> <span class="keyword">from</span> <span class="variable">@Report</span></span><br><span class="line"> <span class="keyword">group</span> <span class="keyword">by</span> CompanyName,[<span class="keyword">Year</span>],[<span class="keyword">Month</span>],Revenue</span><br><span class="line">) <span class="keyword">as</span> TempReportTable</span><br><span class="line">PIVOT</span><br><span class="line">(</span><br><span class="line"> <span class="built_in">sum</span>(Revenue)</span><br><span class="line"> <span class="keyword">for</span> CompanyName <span class="keyword">in</span> ([A公司] ,[B公司] ,[總公司])</span><br><span class="line">)<span class="keyword">as</span> PivotTable</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-iPNlxbN3F60/Vt4vAwWbJbI/AAAAAAAAHu8/UEDA-UufY6M/s320/1.png)](https://3.bp.blogspot.com/-iPNlxbN3F60/Vt4vAwWbJbI/AAAAAAAAHu8/UEDA-UufY6M/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">算出結果</td></tr></tbody></table>]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【SharePoint 2013】開啟BreadCrumb</title>
    <url>/2013/05/20/%E3%80%90SharePoint-2013%E3%80%91%E9%96%8B%E5%95%9FBreadCrumb/</url>
    <content><![CDATA[<ul>
<li>  用Sharepoint Designer登入SharePoint網站</li>
<li>  編輯主板頁面</li>
<li>  找到GlobalBreadCrumbNavPopout</li>
<li>做以下修改<pre><code>  *   將div class=&quot;ms-breadcrumb-dropdownBox&quot;旁邊的display:none修改掉
</code></pre>
<ul>
<li>  將GlobalBreadCrumbNavPopout的Visible改為True</li>
<li>  ```html<div class="ms-breadcrumb-dropdownBox" style="display:inline;">
<SharePoint:AjaxDelta id="DeltaBreadcrumbDropdown" runat="server">
<SharePoint:PopoutMenu
Visible="true"
runat="server"
ID="GlobalBreadCrumbNavPopout"
IconUrl="/_layouts/15/images/spcommon.png?rev=23"
IconAlt="<%$Resources:wss,master_breadcrumbIconAlt%>"
ThemeKey="v15breadcrumb"
IconOffsetX="215"
IconOffsetY="120"
IconWidth="16"
IconHeight="16"
AnchorCss="ms-breadcrumb-anchor"
AnchorOpenCss="ms-breadcrumb-anchor-open"
MenuCss="ms-breadcrumb-menu ms-noList"></li>
</ul>
</li>
</ul>
<p>```</p>
<ul>
<li>  breadCrumb就出現了<br><a href="http://4.bp.blogspot.com/-NKa8p_r0erM/UZmIbzWmblI/AAAAAAAADb4/2QDnT1WcKWI/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png"><img src="http://4.bp.blogspot.com/-NKa8p_r0erM/UZmIbzWmblI/AAAAAAAADb4/2QDnT1WcKWI/s1600/%E6%9C%AA%E5%91%BD%E5%90%8D.png"></a></li>
</ul>
]]></content>
      <tags>
        <tag>SharePoint</tag>
      </tags>
  </entry>
  <entry>
    <title>【SQL】SQL 2008R2 開啟SA帳號</title>
    <url>/2013/09/03/%E3%80%90SQL%E3%80%91SQL-2008R2-%E9%96%8B%E5%95%9FSA%E5%B8%B3%E8%99%9F/</url>
    <content><![CDATA[<ul>
<li>  這個東西做了八百萬遍了還是常常忘記在哪設定，所以決定寫起來方必查詢(汗)*   首先，SQL Server上右鍵 &gt; 屬性 &gt; 安全性 &gt; 選擇SQL Server及Windows驗證模式<br><a href="http://3.bp.blogspot.com/-mE-e_m1GG5A/UiU_U4zbxFI/AAAAAAAAEFU/iKr_d0k9Bcs/s1600/1.png"><img src="http://3.bp.blogspot.com/-mE-e_m1GG5A/UiU_U4zbxFI/AAAAAAAAEFU/iKr_d0k9Bcs/s1600/1.png"></a><br><a href="http://1.bp.blogspot.com/-AP3hYPuC948/UiVAJIB5byI/AAAAAAAAEFc/bb-y_80CC30/s1600/1.png"><img src="http://1.bp.blogspot.com/-AP3hYPuC948/UiVAJIB5byI/AAAAAAAAEFc/bb-y_80CC30/s1600/1.png"></a></li>
<li>安全性 &gt; 登入 &gt; SA帳戶 &gt; 屬性<br><a href="http://3.bp.blogspot.com/-Jcp7Ew-tGO0/UiVAzjFHpuI/AAAAAAAAEFo/RkC9pLBz-lg/s1600/1.png"><img src="http://3.bp.blogspot.com/-Jcp7Ew-tGO0/UiVAzjFHpuI/AAAAAAAAEFo/RkC9pLBz-lg/s1600/1.png"></a><br>狀態 &gt; 登入 &gt; 啟用<br><a href="http://1.bp.blogspot.com/-9DV1cn7WvxU/UiVBdtlhuBI/AAAAAAAAEFw/vIwxIh0Fhqw/s1600/1.png"><img src="http://1.bp.blogspot.com/-9DV1cn7WvxU/UiVBdtlhuBI/AAAAAAAAEFw/vIwxIh0Fhqw/s1600/1.png"></a></li>
<li>  重新啟動SQL服務<br><a href="http://3.bp.blogspot.com/-o4plDe-GmWM/UiVByaHsp_I/AAAAAAAAEF4/MYqwyrFuSvI/s1600/1.png"><img src="http://3.bp.blogspot.com/-o4plDe-GmWM/UiVByaHsp_I/AAAAAAAAEF4/MYqwyrFuSvI/s1600/1.png"></a></li>
</ul>
]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【SQL】WAITFOR DELAY</title>
    <url>/2014/05/28/%E3%80%90SQL%E3%80%91WAITFOR-DELAY/</url>
    <content><![CDATA[<p>有時候大量資料批次匯入時，我們會用寫SQL語法的方式增加效率(LinqToSql會讓你慢到server timeout)，但常常發生SQL處理速度太快，造成datein的時間完全一樣，讓人分不清楚哪筆先哪筆後 這種先後順序在權限的處理上又異常的重要，畢竟權限通常都是拿最後一筆的時間再繼續往下疊加下去，如果分不出哪一筆應該是最後一筆可就慘了阿!!!</p>
<p>SQL表示:今天的我沒有極限</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://3.bp.blogspot.com/-yo13exV70Lw/U4VbOW1w9OI/AAAAAAAAEN8/hulc_I52GBk/s1600/1.png)](http://3.bp.blogspot.com/-yo13exV70Lw/U4VbOW1w9OI/AAAAAAAAEN8/hulc_I52GBk/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">所以要在每一筆寫入的時候告訴SQL Server說，"來，您辛苦了。休息個0.1秒再繼續吧!!"</div><div class="separator" style="clear: both; text-align: left;">這時候你就會需要WAITFOR DELAY語法了([MSDN解說](http://msdn.microsoft.com/zh-tw/library/ms187331.aspx))</div><div class="separator" style="clear: both; text-align: left;">
</div>```sql
--每insert一筆都呼叫一次
WAITFOR DELAY '00:00:00.010'

<p>```<br>打完收工</p>
]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【SQL】遞迴</title>
    <url>/2015/12/14/%E3%80%90SQL%E3%80%91%E9%81%9E%E8%BF%B4/</url>
    <content><![CDATA[<p>有張表格如下，Parent欄位代表他的父層的RegionID，所以裡面包含所有縣市、行政區、鄉里等資料，那要如何用SQL遞迴的方式把台北市用階層的方式表列出來呢?<br>台北市 &gt; 信義區、大安區、中正區…. &gt;&nbsp;港華里、老泉里…..</p>
<p><a href="http://4.bp.blogspot.com/-ezOt-MPBhp8/Vm4i1FAr5_I/AAAAAAAAHq8/GEW1WgWPjps/s1600/1.png"><img src="http://4.bp.blogspot.com/-ezOt-MPBhp8/Vm4i1FAr5_I/AAAAAAAAHq8/GEW1WgWPjps/s1600/1.png"></a></p>
<p>用CTE的寫法可以解決，把台北市當做茅點，然後Join自己即可達到遞迴的效果</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> 遞迴 <span class="keyword">as</span>(</span><br><span class="line"><span class="comment">------茅點 start-------</span></span><br><span class="line"><span class="keyword">SELECT</span> RegionID , Name</span><br><span class="line"><span class="keyword">FROM</span> Region a</span><br><span class="line"><span class="keyword">WHERE</span> RegionID <span class="operator">=</span> <span class="number">1</span> <span class="comment">--台北市</span></span><br><span class="line"><span class="comment">------茅點 end ---------</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> b.RegionID , b.name</span><br><span class="line"><span class="keyword">from</span> Region b</span><br><span class="line"><span class="keyword">join</span> 遞迴 <span class="keyword">on</span>  b.Parent <span class="operator">=</span> 遞迴.RegionID</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 遞迴</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>搜尋出來的結果<br><a href="http://4.bp.blogspot.com/-SGZfLH0gsGo/Vm4kfeQCk6I/AAAAAAAAHrI/M3N0VaRWT-8/s1600/1.png"><img src="http://4.bp.blogspot.com/-SGZfLH0gsGo/Vm4kfeQCk6I/AAAAAAAAHrI/M3N0VaRWT-8/s1600/1.png"></a></p>
]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【SharePoint】 取清單的值</title>
    <url>/2012/10/29/%E3%80%90SharePoint%E3%80%91-%E5%8F%96%E6%B8%85%E5%96%AE%E7%9A%84%E5%80%BC/</url>
    <content><![CDATA[<p>1.先開啟sharepoint site<br>2.開啟web<br>3.選擇清單<br>4.清單裡面item要撈出哪幾個欄位</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://4.bp.blogspot.com/-h3eeHiTjNpM/UI4oUiZsetI/AAAAAAAAANM/bOXEld8V_7E/s1600/1.png)](http://4.bp.blogspot.com/-h3eeHiTjNpM/UI4oUiZsetI/AAAAAAAAANM/bOXEld8V_7E/s1600/1.png)</div>

<p>=====================================================================</p>
<p>sharepoint在撈清單時，預設用使用者的權限去取得該清單的item</p>
<p>但有時候該清單需要更高的權限才能存取，這時候就要先做升權的動作，如紅框處</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://3.bp.blogspot.com/-cZafIYUsPtU/UKGvm9LbLjI/AAAAAAAAANg/Mc0HN0vuuLc/s1600/1.png)](http://3.bp.blogspot.com/-cZafIYUsPtU/UKGvm9LbLjI/AAAAAAAAANg/Mc0HN0vuuLc/s1600/1.png)</div>

<p>紫色框框處為清單的搜尋語法，但還在摸索中，先做個簡單的紀錄!!</p>
]]></content>
      <tags>
        <tag>C#</tag>
        <tag>SharePoint</tag>
      </tags>
  </entry>
  <entry>
    <title>【SharePoint】 佈署方式</title>
    <url>/2012/11/01/%E3%80%90SharePoint%E3%80%91-%E4%BD%88%E7%BD%B2%E6%96%B9%E5%BC%8F/</url>
    <content><![CDATA[<p><a href="http://www.dotblogs.com.tw/ching/archive/2011/01/30/21143.aspx">參考資料</a></p>
<p><strong>透過命令提示字元佈署</strong></p>
<ul>
<li>  stsadn 路徑       ```html<br>C:\Program Files\Common Files\Microsoft Shared\Web Server Extensions\14\BIN</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   部署</span><br><span class="line">        *   加入Solution               &#96;&#96;&#96;html</span><br><span class="line">stsadm -o addSolution –filename [xxxx.wsp]</span><br><span class="line">              </span><br></pre></td></tr></table></figure>

<pre><code>*   部署Solution               ```html
</code></pre>
<p>stsadm -o deploysolution –name [xxxx.wsp] -immediate –url [SiteURL] -allowGacDeployment</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   移除</span><br><span class="line">        *   解除Solution&#96;&#96;&#96;html</span><br><span class="line">stsadm -o retractsolution –name [xxxx.wsp] -immediate -url [SiteURL]</span><br></pre></td></tr></table></figure>

<pre><code>*   移除Solution```html
</code></pre>
<p>stsadm -o deletesolution –name [xxxx.wsp]</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   更新</span><br><span class="line">        *   如果Solution已經在網站上使用，就可以使用下面一句命令就可以更新，不用先執行上面先解除再移除然後再重新部署               &#96;&#96;&#96;html</span><br><span class="line">stsadm -o upgradesolution –name [xxxx.wsp] –filename [xxxx.wsp] -immediate -allowgacdeployment</span><br></pre></td></tr></table></figure>

<p><strong>透過SharePoint管理介面更新佈署</strong></p>
<ul>
<li><p>部署</p>
<pre><code>  *   加入Solution              ```html
</code></pre>
<p>Add-SPSolution C:\xxx.wsp</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">    *   安裝Solution              &#96;&#96;&#96;html</span><br><span class="line">Install-SPSolution -Identity xxx.wsp -WebApplication http:&#x2F;&#x2F;xxxx.com.tw -GACDeployment</span><br></pre></td></tr></table></figure></li>
<li><p>  更新          ```html<br>Update-SPSolution -Identity xxx.wsp -LiteralPath C:\xxx.wsp -GACDeployment</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   Restore          &#96;&#96;&#96;html</span><br><span class="line">restore-spsite -identity http:&#x2F;&#x2F;xxx.com.tw -path d:\xxx.bak -force</span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <tags>
        <tag>SharePoint</tag>
      </tags>
  </entry>
  <entry>
    <title>【SharePoint】在LayOut底下的資料夾寫入txt的Log檔</title>
    <url>/2012/11/13/%E3%80%90SharePoint%E3%80%91%E5%9C%A8LayOut%E5%BA%95%E4%B8%8B%E7%9A%84%E8%B3%87%E6%96%99%E5%A4%BE%E5%AF%AB%E5%85%A5txt%E7%9A%84Log%E6%AA%94/</url>
    <content><![CDATA[<p>我在佈署SharePoint專案時在LayOut資料夾底下放了一個Log的資料夾，打算在該資料夾寫txt的Log檔用，結構如下圖</p>
<p>首先要在Log資料夾裡下先隨便放個檔案，否則VS在佈署時發現該資料夾沒檔案就不會真的建那個該資料夾出來。<br><a href="http://3.bp.blogspot.com/-hEqdtk5YkfQ/UKG0Fg_QeUI/AAAAAAAAAN8/qW-7eYZAZUw/s1600/1.png"><img src="http://3.bp.blogspot.com/-hEqdtk5YkfQ/UKG0Fg_QeUI/AAAAAAAAAN8/qW-7eYZAZUw/s1600/1.png"></a></p>
<p>以下程式是抓到佈署完之後該資料夾的實體位置，並以一天一檔案的方式寫Log檔</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://3.bp.blogspot.com/-Gjb8chCZLdk/UKG1rVrrveI/AAAAAAAAAOE/5F6qYNcbPg4/s1600/1.png)](http://3.bp.blogspot.com/-Gjb8chCZLdk/UKG1rVrrveI/AAAAAAAAAOE/5F6qYNcbPg4/s1600/1.png)</div>]]></content>
      <tags>
        <tag>SharePoint</tag>
      </tags>
  </entry>
  <entry>
    <title>【SharePoint】ListItem附加檔案的URL</title>
    <url>/2012/11/13/%E3%80%90SharePoint%E3%80%91ListItem%E9%99%84%E5%8A%A0%E6%AA%94%E6%A1%88%E7%9A%84URL/</url>
    <content><![CDATA[<p>當ListItem有附加檔案時，用以下方法來抓取該附檔的連結</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://3.bp.blogspot.com/-4cMr5xgDNcY/UKGzLSCms9I/AAAAAAAAAN0/iUjTDRLCsTk/s1600/1.png)](http://3.bp.blogspot.com/-4cMr5xgDNcY/UKGzLSCms9I/AAAAAAAAAN0/iUjTDRLCsTk/s1600/1.png)</div>]]></content>
      <tags>
        <tag>SharePoint</tag>
      </tags>
  </entry>
  <entry>
    <title>【SharePoint】VisualWebPart</title>
    <url>/2012/12/27/%E3%80%90SharePoint%E3%80%91VisualWebPart/</url>
    <content><![CDATA[<div class="separator" style="clear: both; text-align: center;">[![](http://1.bp.blogspot.com/-BbJDYNJ9yJQ/UNu49lR8hFI/AAAAAAAAAeA/ETeG2o2Gs4M/s640/111.png)](http://1.bp.blogspot.com/-BbJDYNJ9yJQ/UNu49lR8hFI/AAAAAAAAAeA/ETeG2o2Gs4M/s1600/111.png)</div>

<p><span style="background-color: white;"><strong>建立VisualWebPart(後面簡稱vwp)後會產生以下檔案結構</strong></span></p>
<div class="separator" style="clear: both; text-align: center;">[![](http://4.bp.blogspot.com/-sj79ZvE6lH4/UNu5jeqCYrI/AAAAAAAAAeI/stuhIeBL11k/s1600/111.png)](http://4.bp.blogspot.com/-sj79ZvE6lH4/UNu5jeqCYrI/AAAAAAAAAeI/stuhIeBL11k/s1600/111.png)</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">**.XML檔中可以設定vwp佈署後歸類在哪個群組裡面**</div><div class="separator" style="clear: both; text-align: center;">[![](http://4.bp.blogspot.com/-Vv3Q5WgnzGo/UNu68vKX92I/AAAAAAAAAeg/l0j6pcw1oLY/s640/111.png)](http://4.bp.blogspot.com/-Vv3Q5WgnzGo/UNu68vKX92I/AAAAAAAAAeg/l0j6pcw1oLY/s1600/111.png)</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: center;">[![](http://4.bp.blogspot.com/-8K_6ifqFwTw/UNu7eFJb4gI/AAAAAAAAAeo/uMqpnmtiMNc/s320/111.png)](http://4.bp.blogspot.com/-8K_6ifqFwTw/UNu7eFJb4gI/AAAAAAAAAeo/uMqpnmtiMNc/s1600/111.png)</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">**VWP的CS檔中可以增加可設定的參數**</div>```csharp
namespace ScinoPharm.EIP.vwpSurveys
   {
        [ToolboxItemAttribute(false)]
        public class vwpSurveys : WebPart
        {
            //增加可設定的參數
            [Category("MySetting"),
             Personalizable(PersonalizationScope.Shared), //共用設定
             WebBrowsable(true), //是否顯示在面板上
             WebDisplayName("來源清單名稱"),
             WebDescription("請填寫Survey資料來源的清單名稱") //描述
            ]

<pre><code>        public string ListName&#123;get;set;&#125;

        //當您變更視覺 Web 組件專案項目時，Visual Studio 可能會自動更新此路徑
        private const string _ascxPath = @&quot;~/_CONTROLTEMPLATES/ScinoPharm.EIP/vwpSurveys/vwpSurveysUserControl.ascx&quot;;

        protected override void CreateChildControls()
        &#123;
            Control control = Page.LoadControl(_ascxPath);
            ControlSkin.Add(control);
        &#125;
    &#125;
</code></pre>
<p>   }</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;div class&#x3D;&quot;separator&quot; style&#x3D;&quot;clear: both; text-align: left;&quot;&gt;**</span><br><span class="line">**&lt;&#x2F;div&gt;&lt;div class&#x3D;&quot;separator&quot; style&#x3D;&quot;clear: both; text-align: center;&quot;&gt;[![](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-vNWquvR2rzs&#x2F;UNu9Aq_nY_I&#x2F;AAAAAAAAAe4&#x2F;lNd-Ro9x2Z4&#x2F;s1600&#x2F;111.png)](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-vNWquvR2rzs&#x2F;UNu9Aq_nY_I&#x2F;AAAAAAAAAe4&#x2F;lNd-Ro9x2Z4&#x2F;s1600&#x2F;111.png)&lt;&#x2F;div&gt;&lt;div class&#x3D;&quot;separator&quot; style&#x3D;&quot;clear: both; text-align: left;&quot;&gt;</span><br><span class="line">&lt;&#x2F;div&gt;&lt;div class&#x3D;&quot;separator&quot; style&#x3D;&quot;clear: both; text-align: left;&quot;&gt;</span><br><span class="line">&lt;&#x2F;div&gt;**在UserControl中要抓到VWP的參數設定，需要透過以下的方法**</span><br><span class="line">&#96;&#96;&#96;csharp</span><br><span class="line">public vwpSurveys SurveyParameter;</span><br><span class="line"></span><br><span class="line">    protected void Page_Load(object sender, EventArgs e) </span><br><span class="line">    &#123;</span><br><span class="line">        if (!Page.IsPostBack) </span><br><span class="line">        &#123;</span><br><span class="line">            SurveyParameter &#x3D; this.Parent as vwpSurveys;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>**<br>**</p>
]]></content>
      <tags>
        <tag>SharePoint</tag>
      </tags>
  </entry>
  <entry>
    <title>【SharePoint】判斷清單屬性</title>
    <url>/2012/12/27/%E3%80%90SharePoint%E3%80%91%E5%88%A4%E6%96%B7%E6%B8%85%E5%96%AE%E5%B1%AC%E6%80%A7/</url>
    <content><![CDATA[<p>最近做一個SharePoint的功能，需要將SiteCollection裡面所有子網站的清單全數撈出來，並判斷是否為Survey或Announcement </p>
<ul>
<li>  判斷是否為Survey    ```csharp<br>List.BaseType.ToString() ==”Survey”<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">*   判斷是否為Announcement &#96;&#96;&#96;csharp</span><br><span class="line">List.BaseTemplate.ToString() &#x3D;&#x3D; &quot;Announcements&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<table style="width:300px;margin:0px auto;"><tr> <td>問卷</td> <td>Survey</td></tr><tr> <td>公告</td> <td>Announcements</td></tr><tr> <td>文件庫</td> <td>DocumentLibrary</td></tr></table>

<p>另外網路上查到各種清單的對照表，可以參考 :  <a href="http://blog.bugrapostaci.com/2010/09/22/sharepoint-list-type-numbers/">清單對照表</a></p>
]]></content>
      <tags>
        <tag>SharePoint</tag>
      </tags>
  </entry>
  <entry>
    <title>【SharePoint】讀取目前使用者的DispayName</title>
    <url>/2012/11/13/%E3%80%90SharePoint%E3%80%91%E8%AE%80%E5%8F%96%E7%9B%AE%E5%89%8D%E4%BD%BF%E7%94%A8%E8%80%85%E7%9A%84DispayName/</url>
    <content><![CDATA[<p>是DisplayName不是Account喔!!</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://2.bp.blogspot.com/-NaAuRmyrQd0/UKG2nwaZzcI/AAAAAAAAAOM/dE6rh8dC8PI/s1600/1.png)](http://2.bp.blogspot.com/-NaAuRmyrQd0/UKG2nwaZzcI/AAAAAAAAAOM/dE6rh8dC8PI/s1600/1.png)</div>]]></content>
      <tags>
        <tag>SharePoint</tag>
      </tags>
  </entry>
  <entry>
    <title>【SharePoint】安裝筆記</title>
    <url>/2012/10/16/%E3%80%90SharePoint%E3%80%91%E5%AE%89%E8%A3%9D%E7%AD%86%E8%A8%98/</url>
    <content><![CDATA[<p>1.先安裝Window server 2008 R2</p>
<p>2.啟動Active Directory網域服務</p>
<p>3.啟動DC</p>
<p>4.新增兩名Domain的使用者 　EX：sps_service , sps_admin</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://1.bp.blogspot.com/-pdH93mRSZ6U/UHz7sukxtvI/AAAAAAAAALE/kVexakOlhXY/s1600/11.png)](http://1.bp.blogspot.com/-pdH93mRSZ6U/UHz7sukxtvI/AAAAAAAAALE/kVexakOlhXY/s1600/11.png)</div><div class="separator" style="clear: both; text-align: center;">[![](http://1.bp.blogspot.com/-23V72MV9S64/UHz9Wwu1EeI/AAAAAAAAALM/mo-DmwO5fbo/s1600/11.png)](http://1.bp.blogspot.com/-23V72MV9S64/UHz9Wwu1EeI/AAAAAAAAALM/mo-DmwO5fbo/s1600/11.png)</div>

<p>之後再將兩個帳號加到Builtin的administrator的成員之中</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://4.bp.blogspot.com/-naehp0j1yl8/UHz96Ob1eDI/AAAAAAAAALU/b_CzKkYeyfM/s1600/11.png)](http://4.bp.blogspot.com/-naehp0j1yl8/UHz96Ob1eDI/AAAAAAAAALU/b_CzKkYeyfM/s1600/11.png)</div>

<p>接下來的安裝都用sps_admin來做<br>5.安裝SQL Server 2008 R2<br>&nbsp; &nbsp;將帳戶指定給sps_service</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://2.bp.blogspot.com/-bf65-cgmngg/UH0IyzgAmSI/AAAAAAAAALs/1NXycYusVwc/s1600/11.png)](http://2.bp.blogspot.com/-bf65-cgmngg/UH0IyzgAmSI/AAAAAAAAALs/1NXycYusVwc/s1600/11.png)</div>

<p>6.安裝SharePointService<br>&nbsp; &nbsp;先點選安裝軟體先決條件</p>
<div class="separator" style="clear: both; text-align: center;">[![](http://1.bp.blogspot.com/-lQXiOG1zWlA/UH0UVHgAi7I/AAAAAAAAAME/VtB6ot6gQFY/s1600/11.png)](http://1.bp.blogspot.com/-lQXiOG1zWlA/UH0UVHgAi7I/AAAAAAAAAME/VtB6ot6gQFY/s1600/11.png)</div>
過程中如果有問題的話，可以參考提示另行下載元件安裝
<div class="separator" style="clear: both; text-align: center;">[![](http://1.bp.blogspot.com/-9tHDhQmuN54/UH0Us5D-7SI/AAAAAAAAAMM/TvIjFqbK7CE/s1600/11.png)](http://1.bp.blogspot.com/-9tHDhQmuN54/UH0Us5D-7SI/AAAAAAAAAMM/TvIjFqbK7CE/s1600/11.png)</div>元件表
<div class="separator" style="clear: both; text-align: center;">[![](http://4.bp.blogspot.com/-Go4DUvNwuLo/UH0ZDeWE2bI/AAAAAAAAAMk/yG6Z_ePVICY/s1600/11.png)](http://4.bp.blogspot.com/-Go4DUvNwuLo/UH0ZDeWE2bI/AAAAAAAAAMk/yG6Z_ePVICY/s1600/11.png)</div>
7.正式安裝SharePoint
&nbsp; &nbsp;選擇新的伺服器陣列 &gt; 設定機器名稱 &gt; 輸入使用者名稱與密碼
<div class="separator" style="clear: both; text-align: center;">[![](http://1.bp.blogspot.com/-p-X5WlDPa0E/UH0ZgKYDUFI/AAAAAAAAAMs/8dSN3t3oWiM/s1600/1-1.png)](http://1.bp.blogspot.com/-p-X5WlDPa0E/UH0ZgKYDUFI/AAAAAAAAAMs/8dSN3t3oWiM/s1600/1-1.png)</div>
指定Port
<div class="separator" style="clear: both; text-align: center;">[![](http://2.bp.blogspot.com/-Xyvy6bqdUBA/UH0Z3-axdmI/AAAAAAAAAM0/NHBNBdBTnrU/s1600/1-2.png)](http://2.bp.blogspot.com/-Xyvy6bqdUBA/UH0Z3-axdmI/AAAAAAAAAM0/NHBNBdBTnrU/s1600/1-2.png)</div>
之後再設定頂層網站就大功告成了!!]]></content>
      <tags>
        <tag>SharePoint</tag>
      </tags>
  </entry>
  <entry>
    <title>【Swagger】活著的API規格書</title>
    <url>/2016/10/14/%E3%80%90Swagger%E3%80%91%E6%B4%BB%E8%91%97%E7%9A%84API%E8%A6%8F%E6%A0%BC%E6%9B%B8/</url>
    <content><![CDATA[<p>所謂的工程師就是，【接手別人專案時，總是問怎麼沒有規格書? 自己開發專案時卻又不喜歡寫規格書】的一群人，本人也是一個極度不喜歡寫規格書的人，簡單說就是懶到極致，懶到深處無怨尤。而且常常改版時來匆匆忙忙，寫程式的時間都不夠了，誰還管你規格書有沒有更新，就這樣恍神個兩三次忘記回去更新規格，這本規格書就光榮列入公司十大(搞不好百大?)不可思議天書，可謂極度麻煩費時討厭…..</p>
<p>還好同事介紹了Swagger的用法，讓你邊開發程式時，規格就產生書產生出來了，而且還是本可以使用的規格書，讓你從今以後再也不用擔心規格書與實際規格脫鉤的問題，以下就筆記一下如何使用</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://4.bp.blogspot.com/-DHN0U1Vqe3U/WAA8GQA474I/AAAAAAAAH-o/idcyU1UFoPoM9sI2fs7Jga7vTRrA_Lz7gCLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://4.bp.blogspot.com/-DHN0U1Vqe3U/WAA8GQA474I/AAAAAAAAH-o/idcyU1UFoPoM9sI2fs7Jga7vTRrA_Lz7gCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">Swagger-當開發完API時，規格書也就完成了!!</td></tr></tbody></table><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://4.bp.blogspot.com/-Q_gy5BypWEQ/WAA8wzGS32I/AAAAAAAAH-s/dbAyDeDRpPgfEc-OjH9_s2GIaafUpCBjACLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://4.bp.blogspot.com/-Q_gy5BypWEQ/WAA8wzGS32I/AAAAAAAAH-s/dbAyDeDRpPgfEc-OjH9_s2GIaafUpCBjACLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">輸入的參數與說明也寫得清清楚楚</td></tr></tbody></table><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://1.bp.blogspot.com/-WbKmvP1AzgE/WAA-rbXKmUI/AAAAAAAAH-8/-tLhejDldqI_HmO2FNDS1gO6ImyOrrfngCLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://1.bp.blogspot.com/-WbKmvP1AzgE/WAA-rbXKmUI/AAAAAAAAH-8/-tLhejDldqI_HmO2FNDS1gO6ImyOrrfngCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">按下Try it Out後，可以馬上測試API跟觀看結果!!</span></td></tr></tbody></table>

<h3 id="使用步驟"><a href="#使用步驟" class="headerlink" title="使用步驟"></a>使用步驟</h3><div>

<ul>
<li>  首先我先開一個WebAPI專案，然後寫一支簡單的API讓他可以運作</div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a href="https://1.bp.blogspot.com/-esv5JivSR4Y/WABBED8FfQI/AAAAAAAAH_E/YiqAJZ5gpAoLo97p4H6T6hp6ipz9r54mgCLcB/s1600/1.png"><img src="https://1.bp.blogspot.com/-esv5JivSR4Y/WABBED8FfQI/AAAAAAAAH_E/YiqAJZ5gpAoLo97p4H6T6hp6ipz9r54mgCLcB/s640/1.png"></a></td></tr><tr><td class="tr-caption" style="text-align: center;">開一個WebAPI專案</td></tr></tbody></table><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-VmbQGY5UMMU/WABBEd25TPI/AAAAAAAAH_I/MGng_1nDDSEQ-zLiXyahRK5GTT9XMtSEwCLcB/s640/2.png)](https://3.bp.blogspot.com/-VmbQGY5UMMU/WABBEd25TPI/AAAAAAAAH_I/MGng_1nDDSEQ-zLiXyahRK5GTT9XMtSEwCLcB/s1600/2.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">新增一個新的TestSwaggerController</td></tr></tbody></table>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-AENbjbb3Ia4/WABBERDf0cI/AAAAAAAAH_M/Ea_va3RXz0kCcplepPRx-nBqaHHpLLsCwCLcB/s1600/3.png)](https://1.bp.blogspot.com/-AENbjbb3Ia4/WABBERDf0cI/AAAAAAAAH_M/Ea_va3RXz0kCcplepPRx-nBqaHHpLLsCwCLcB/s1600/3.png)</div><div>
</div><div>
</div><div>
</div><div></li>
</ul>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><ul>
<li><p><strong>開始撰寫幾個簡單的API跟輸入輸出參數</strong></p>
</div><div>
</div>```csharp
public class testSwaggerGetParameter
  {
      /// <summary>
      /// 帳號
      /// </summary>
      /// <value>
      /// The identifier.
      /// </value>
      public string ID { get; set; }

<pre><code>  /// &lt;summary&gt;
  /// 密碼
  /// &lt;/summary&gt;
  /// &lt;value&gt;
  /// The passWord.
  /// &lt;/value&gt;
  public string PassWord &#123; get; set; &#125;
</code></pre>
<p>  }</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;csharp</span><br><span class="line">public class TestSwaggerController : ApiController</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 測試Swagger的API</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;parameter&quot;&gt;The parameter.&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">        [HttpGet]</span><br><span class="line">        [Route(&quot;api&#x2F;testSwagger&quot;)]</span><br><span class="line">        public HttpResponseMessage Get([FromUri]testSwaggerGetParameter parameter)</span><br><span class="line">        &#123;</span><br><span class="line">            if (parameter !&#x3D; null &amp;&amp;</span><br><span class="line">                parameter.ID &#x3D;&#x3D; &quot;toyo&quot; &amp;&amp; </span><br><span class="line">                parameter.PassWord &#x3D;&#x3D; &quot;123456&quot;)</span><br><span class="line">            &#123;</span><br><span class="line">                return Request.CreateResponse(HttpStatusCode.OK, &quot;帳號密碼正確&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return Request.CreateResponse(HttpStatusCode.OK, &quot;帳號密碼錯誤摟!!!!!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><ul>
<li>  接著先來測試API的運作是否正常<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-NGEX0U-saSw/WABFAd9ksPI/AAAAAAAAH_c/AQuEDjoIGL4jbBYZs2PJ7B7lnAS7fB8xQCLcB/s640/2.png)](https://3.bp.blogspot.com/-NGEX0U-saSw/WABFAd9ksPI/AAAAAAAAH_c/AQuEDjoIGL4jbBYZs2PJ7B7lnAS7fB8xQCLcB/s1600/2.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">輸入正確的測試</td></tr></tbody></table>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://1.bp.blogspot.com/-i923xx2aY30/WABFABbQrdI/AAAAAAAAH_Y/cvhLOl1x6xw3aJ5Yvd-T7gBcePHTb8GCwCLcB/s640/1.png)](https://1.bp.blogspot.com/-i923xx2aY30/WABFABbQrdI/AAAAAAAAH_Y/cvhLOl1x6xw3aJ5Yvd-T7gBcePHTb8GCwCLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">輸入錯誤的測試</td></tr></tbody></table></li>
</ul>
<h3 id="-2"><a href="#-2" class="headerlink" title=""></a></h3><ul>
<li>  <strong>API都準備就緒後，來安裝Swagger吧</strong><br>首先打開Nuget搜尋<strong>Swashbuckle</strong>並安裝<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-I6T6On4UU0I/WABGKKbp_4I/AAAAAAAAH_g/thsWbtJB9d8M-wBG3oHoBHct0d6N-7ohwCLcB/s640/1.png)](https://1.bp.blogspot.com/-I6T6On4UU0I/WABGKKbp_4I/AAAAAAAAH_g/thsWbtJB9d8M-wBG3oHoBHct0d6N-7ohwCLcB/s1600/1.png)</div></li>
</ul>
<p>接著打開專案屬性，設定輸出XML說明格式</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-Q35LXg-ZAbc/WABHQqOA9II/AAAAAAAAH_o/IqpSnKPL7AIkGskPH8LPMKDBYKS-cJvNACLcB/s640/1.png)](https://3.bp.blogspot.com/-Q35LXg-ZAbc/WABHQqOA9II/AAAAAAAAH_o/IqpSnKPL7AIkGskPH8LPMKDBYKS-cJvNACLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-kTvzjXCAY7Q/WABHWnjk79I/AAAAAAAAH_s/WYApFDnj0RACcVPP3KQC9qGsgdxf3a3swCLcB/s640/2.png)](https://2.bp.blogspot.com/-kTvzjXCAY7Q/WABHWnjk79I/AAAAAAAAH_s/WYApFDnj0RACcVPP3KQC9qGsgdxf3a3swCLcB/s1600/2.png)</div>

<p>打開SwaggerConfig做些設定</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-3KPOfrFBs7A/WABHvcNMO4I/AAAAAAAAH_w/-tsOz_SqAGcvVxxSOOwok_Q1yTpZyDAiQCLcB/s1600/1.png)](https://1.bp.blogspot.com/-3KPOfrFBs7A/WABHvcNMO4I/AAAAAAAAH_w/-tsOz_SqAGcvVxxSOOwok_Q1yTpZyDAiQCLcB/s1600/1.png)</div>

<p>在第一百行的地方把註解拿掉</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-sNuzZJH1_Tk/WABH-ckCYAI/AAAAAAAAH_0/dY91muQCTvAggbaSNAxXFuf687P37-f4wCLcB/s640/1.png)](https://2.bp.blogspot.com/-sNuzZJH1_Tk/WABH-ckCYAI/AAAAAAAAH_0/dY91muQCTvAggbaSNAxXFuf687P37-f4wCLcB/s1600/1.png)</div>

<p>在最下面補上以下程式碼</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-LZWGCrO2m1E/WABIPqVRXuI/AAAAAAAAH_4/XDwqWQFF4zIfyBMKgjUfNqisGADqPMPvQCLcB/s640/1.png)](https://2.bp.blogspot.com/-LZWGCrO2m1E/WABIPqVRXuI/AAAAAAAAH_4/XDwqWQFF4zIfyBMKgjUfNqisGADqPMPvQCLcB/s1600/1.png)</div>

<h3 id="-3"><a href="#-3" class="headerlink" title=""></a></h3><ul>
<li>  重新執行WebAPI，並且在網址列輸入……./Swagger<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-VKr_8qKHN7Y/WABIxRpt8gI/AAAAAAAAH_8/XaVeA3uG-9whtv0DrZ7DQYIzKXjaHryYgCLcB/s640/1.png)](https://2.bp.blogspot.com/-VKr_8qKHN7Y/WABIxRpt8gI/AAAAAAAAH_8/XaVeA3uG-9whtv0DrZ7DQYIzKXjaHryYgCLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">看到API被輸出成規格了，參數的註解是跟著Summary的</td></tr></tbody></table><div>
</div><div>
</div><div>
</div><div>來測試看看!!!</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-651X7h-rIVw/WABJN-3Jf-I/AAAAAAAAIAA/iBthsKVDiscN_ItWjk4WUUSgemSLEfDLQCLcB/s640/1.png)](https://1.bp.blogspot.com/-651X7h-rIVw/WABJN-3Jf-I/AAAAAAAAIAA/iBthsKVDiscN_ItWjk4WUUSgemSLEfDLQCLcB/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-JPjRZMJusSE/WABJOPutBbI/AAAAAAAAIAE/aFON9GjhDe0HKHY_jjJ8M8JfstfCDLoLgCLcB/s640/2.png)](https://3.bp.blogspot.com/-JPjRZMJusSE/WABJOPutBbI/AAAAAAAAIAE/aFON9GjhDe0HKHY_jjJ8M8JfstfCDLoLgCLcB/s1600/2.png)</div><div>
</div><div>
</div><div>
</div><div>
</div><div>最後，Swagger雖然已經非常好用了，也能符合大部分的情境運用，但還是有些美中不足的地方，例如如果今天API部分資訊要帶在Header裡面傳給API，在預設產生的地方是沒有提供可以輸入的地方。</div><div>
</div><div>但慶幸的是Swagger可以很彈性的去改寫這張最後會產生的View，可以自己擴充需要的欄位，下一篇在來介紹如何客製化Swagger頁面!!!</div><div>
</div><div>
</div><div>
</div><div>
</div></li>
</ul>
<h4 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a>參考文章</h4><div>

<ol>
<li> <a href="http://kevintsengtw.blogspot.tw/2015/12/aspnet-web-api-swagger.html">mrkt&nbsp;- ASP.NET Web API 文件產生器 - 使用 Swagger</a></li>
<li> <a href="http://kevintsengtw.blogspot.tw/2015/12/swashbuckle-swagger-for-web-api.html">mrkt-&nbsp;Swashbuckle - Swagger for Web Api 顯示內容的調整</a></div><div></div><div>
</div></li>
</ol>
]]></content>
      <tags>
        <tag>Swagger</tag>
      </tags>
  </entry>
  <entry>
    <title>【SharePoint】確認Web或List是否有權限讀取</title>
    <url>/2012/12/26/%E3%80%90SharePoint%E3%80%91%E7%A2%BA%E8%AA%8DWeb%E6%88%96List%E6%98%AF%E5%90%A6%E6%9C%89%E6%AC%8A%E9%99%90%E8%AE%80%E5%8F%96/</url>
    <content><![CDATA[<p>詳細可以參考這個<a href="http://webcache.googleusercontent.com/search?q=cache:ubXwX-z3mF4J:blogs.salmanghani.info/check-if-user-has-permissions-on-list-or-web/+&amp;cd=4&amp;hl=zh-TW&amp;ct=clnk&amp;gl=tw">網站</a></p>
<p>節錄摘要，</p>
<pre class="brush : csharp">if (oWeb.DoesUserHavePermissions(SPBasePermissions.ViewPages))
{
      SPList oList = oWeb.Lists[ListName];
      if (oList.DoesUserHavePermissions(SPBasePermissions.ViewListItems))
      {
          // some smart code
      }
}
</pre>
<p>因為要先Get Web或是List的物件才能進行判斷，所以如果該使用者對該物件沒有權限，這樣寫可能會當掉，所以建議寫法如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">SPUser User = SPContext.Current.Web.CurrentUser; <span class="comment">//先記錄目前使用者</span></span><br><span class="line"></span><br><span class="line">SPSecurity.RunWithElevatedPrivileges(<span class="built_in">delegate</span> &#123;        <span class="comment">//進行升權的動作</span></span><br><span class="line">                        <span class="keyword">using</span> (SPSite Site = <span class="keyword">new</span> SPSite(SPContext.Current.Site.ID))</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">using</span> (SPWeb Web = Site.OpenWeb(WebName))</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="comment">//在將剛剛紀錄的使用者丟到Function進行權限的判斷</span></span><br><span class="line">                                <span class="keyword">if</span>(Web.DoesUserHavePermissions(User.LoginName,SPBasePermissions.ViewPages))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    SPList List = Web.GetList(URL);</span><br><span class="line">                                    <span class="keyword">if</span>(List.DoesUserHavePermissions(User, SPBasePermissions.ViewPages))</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        HavePermission = <span class="literal">true</span>;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                             &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>或是</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//如果不把SPSecurity.CatchAccessDeniedException改回正常狀況，Sharepoint網站會直接返回無權限的頁面</span></span><br><span class="line"><span class="comment">//並停止執行接下來的程式</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">CheckPermission</span>(<span class="params">SPWeb _web</span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   Boolean catchException = SPSecurity.CatchAccessDeniedException;</span><br><span class="line">   SPSecurity.CatchAccessDeniedException = <span class="literal">false</span>;</span><br><span class="line">   <span class="keyword">try</span></span><br><span class="line">   &#123;</span><br><span class="line">      <span class="keyword">if</span> (_web.DoesUserHavePermissions(currentUser.LoginName, SPBasePermissions.ViewPages))</span><br><span class="line">      &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> </span><br><span class="line">      &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    catch </span><br><span class="line">    &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">         <span class="comment">//reset the flag to original value</span></span><br><span class="line">         SPSecurity.CatchAccessDeniedException = catchException;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>SharePoint</tag>
      </tags>
  </entry>
  <entry>
    <title>【SharePoint 2013】開啟以不同使用者登入選項</title>
    <url>/2013/04/13/%E3%80%90SharePoint-2013%E3%80%91%E9%96%8B%E5%95%9F%E4%BB%A5%E4%B8%8D%E5%90%8C%E4%BD%BF%E7%94%A8%E8%80%85%E7%99%BB%E5%85%A5%E9%81%B8%E9%A0%85/</url>
    <content><![CDATA[<p>在SharePoint 2013中，預設沒有切換使用者的選項</p>
<p><img src="https://1.bp.blogspot.com/-3Fzzh6KvIog/UWvXRQFmtgI/AAAAAAAACYE/M96nwlEF1gs/s1600/111.png" alt="https://1.bp.blogspot.com/-3Fzzh6KvIog/UWvXRQFmtgI/AAAAAAAACYE/M96nwlEF1gs/s1600/111.png"></p>
<p>叫出來的方法如下:</p>
<ul>
<li>先找到以下路徑開啟 <strong>\15\TEMPLATE\CONTROLTEMPLATES\Welcome.ascx</strong><br><img src="https://2.bp.blogspot.com/-XTar0tN4fs4/UWvY1NbOs2I/AAAAAAAACYQ/IZLGfEJyrOA/s1600/11.png" alt="https://2.bp.blogspot.com/-XTar0tN4fs4/UWvY1NbOs2I/AAAAAAAACYQ/IZLGfEJyrOA/s1600/11.png"></li>
<li>用編輯器打開，並找到ID為 <strong>ID_RequestAccess</strong>的控制項<br><img src="https://2.bp.blogspot.com/-foGebgpfQQU/UWvZvzG7kxI/AAAAAAAACYg/Ft0kIEB-Ejg/s1600/11.png" alt="https://2.bp.blogspot.com/-foGebgpfQQU/UWvZvzG7kxI/AAAAAAAACYg/Ft0kIEB-Ejg/s1600/11.png"></li>
<li>在該控制項前面加入以下程式碼 <figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">SharePoint:MenuItemTemplate</span>  <span class="attr">runat</span>=<span class="string">&quot;server&quot;</span>  <span class="attr">ID</span>=<span class="string">&quot;ID_LoginAsDifferentUser&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">Text</span>=<span class="string">&quot;&lt;%$Resources:wss,personalactions_loginasdifferentuser%&gt;&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">Description</span>=<span class="string">&quot;    &lt;%$Resources:wss,personalactions_loginasdifferentuserdescription%&gt;&quot;</span>              </span></span><br><span class="line"><span class="tag"> <span class="attr">MenuGroupId</span>=<span class="string">&quot;100&quot;</span> </span></span><br><span class="line"><span class="tag"> <span class="attr">Sequence</span>=<span class="string">&quot;100&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">UseShortId</span>=<span class="string">&quot;true&quot;</span>  /&gt;</span></span><br></pre></td></tr></table></figure>
<img src="https://3.bp.blogspot.com/-FDGUOFCxbhs/UWvarNajT7I/AAAAAAAACYs/iLMMk-yB1tw/s1600/11.png" alt="https://3.bp.blogspot.com/-FDGUOFCxbhs/UWvarNajT7I/AAAAAAAACYs/iLMMk-yB1tw/s1600/11.png"></li>
<li>大功告成<br><img src="https://4.bp.blogspot.com/-uFjLjbAQEO0/UWva_j6HqfI/AAAAAAAACY0/2ELRqrG5QS8/s1600/11.png" alt="https://4.bp.blogspot.com/-uFjLjbAQEO0/UWva_j6HqfI/AAAAAAAACY0/2ELRqrG5QS8/s1600/11.png"></li>
</ul>
]]></content>
      <tags>
        <tag>SharePoint</tag>
      </tags>
  </entry>
  <entry>
    <title>【Tools】修復Html缺少Close Tag問題 - HtmlAgilityPack</title>
    <url>/2017/11/15/%E3%80%90Tools%E3%80%91%E4%BF%AE%E5%BE%A9Html%E7%BC%BA%E5%B0%91Close-Tag%E5%95%8F%E9%A1%8C-HtmlAgilityPack/</url>
    <content><![CDATA[<p>開放後台給非工程人員編輯Html，往往都要擔負一些Html Tag錯誤整導致破版的風險。這次就碰到上線前發現部分資料區塊缺少了Close Tag，導致只要讀到那些資料的頁面都破版，但上千筆資料請人一筆一筆去檢查又太不切實際。所以就研究了一下是否有套件可以處理這類的問題，結果就發現了一個強大的套件 :&nbsp;<a href="http://html-agility-pack.net/?z=codeplex">HtmlAgilityPack</a></p>
<div class="note info">
            <p>該套件主要功能是拿來解析網頁，似乎更多人是拿來製作爬蟲工具，但他同時也很貼心的提供API來分析Html Tag是否正確</p>
          </div>


<p>首先先從Nuget載入該套件</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-cMfu_9lAHPY/WguV9l_rY0I/AAAAAAAAIQM/3thXpbJDKr4ZQPGb5T7Ff-waUuo7p6tWgCLcBGAs/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://2.bp.blogspot.com/-cMfu_9lAHPY/WguV9l_rY0I/AAAAAAAAIQM/3thXpbJDKr4ZQPGb5T7Ff-waUuo7p6tWgCLcBGAs/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</div>
然後用以下程式來進行Html修復
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//商品的尺寸報表Html有錯誤</span></span><br><span class="line"><span class="keyword">var</span> ps = <span class="keyword">this</span>.Products.Where(x = &gt; x.SizeReport != <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> p <span class="keyword">in</span> ps)</span><br><span class="line">&#123;</span><br><span class="line"> HtmlDocument doc = <span class="keyword">new</span> HtmlDocument();</span><br><span class="line"> <span class="comment">//fix when nesting errors are detected</span></span><br><span class="line"> doc.OptionFixNestedTags = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//將Html Editor編輯的東西丟進去</span></span><br><span class="line"> doc.LoadHtml(p.SizeReport.ToString());</span><br><span class="line"></span><br><span class="line"> <span class="comment">//將修復後的Html結果存到MemoryStream</span></span><br><span class="line"> MemoryStream stream = <span class="keyword">new</span> MemoryStream();</span><br><span class="line"> doc.Save(stream);</span><br><span class="line"> <span class="keyword">try</span></span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">using</span> (StreamReader reader = <span class="keyword">new</span> StreamReader(stream, Encoding.Default))</span><br><span class="line">  &#123;</span><br><span class="line">   stream.Position = <span class="number">0</span>;</span><br><span class="line">   p.SizeReport = reader.ReadToEnd(); <span class="comment">//儲存回DB</span></span><br><span class="line">   <span class="keyword">this</span>.SubmitChanges();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line"> catch (Exception ex)</span><br><span class="line"> &#123;</span><br><span class="line"></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>C#</tag>
        <tag>Tools</tag>
      </tags>
  </entry>
  <entry>
    <title>【Swagger】客製化可以輸入Header的欄位</title>
    <url>/2016/10/14/%E3%80%90Swagger%E3%80%91%E5%AE%A2%E8%A3%BD%E5%8C%96%E5%8F%AF%E4%BB%A5%E8%BC%B8%E5%85%A5Header%E7%9A%84%E6%AC%84%E4%BD%8D/</url>
    <content><![CDATA[<p>上一篇<a href="http://toyo0103.blogspot.tw/2016/10/swaggerapi.html">【Swagger】活著的API規格書</a>&nbsp;提到如何使用Swagger來產生規格與測試API，但遇到一個問題是，很多API會把驗證的Key放到Header傳遞，但Swagger產出來的頁面並沒有設定Header的地方，這時候就要來小調整一下已符合需求。</p>
<p>首先我們先把原本的API改成要吃Header的Key值才算驗證通過</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestSwaggerController</span> : <span class="title">ApiController</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 測試Swagger的API</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;parameter&quot;&gt;</span>The parameter.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        [<span class="meta">Route(<span class="meta-string">&quot;api/testSwagger&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> HttpResponseMessage <span class="title">Get</span>(<span class="params">[FromUri]testSwaggerGetParameter parameter</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//沒有帶Appkey在Header</span></span><br><span class="line">            <span class="keyword">if</span> (!Request.Headers.Contains(<span class="string">&quot;X-Key&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Request.CreateResponse(HttpStatusCode.NotAcceptable, <span class="string">&quot;必須輸入AppKey&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> AppKey =  Request.Headers.GetValues(<span class="string">&quot;X-Key&quot;</span>).FirstOrDefault();</span><br><span class="line">            <span class="keyword">if</span> (AppKey != <span class="string">&quot;MyKey&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Request.CreateResponse(HttpStatusCode.NotAcceptable, <span class="string">&quot;AppKey不正確!!!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (parameter != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                parameter.ID == <span class="string">&quot;toyo&quot;</span> &amp;&amp; </span><br><span class="line">                parameter.PassWord == <span class="string">&quot;123456&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Request.CreateResponse(HttpStatusCode.OK, <span class="string">&quot;帳號密碼正確&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Request.CreateResponse(HttpStatusCode.OK, <span class="string">&quot;帳號密碼錯誤摟!!!!!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這時候測試一下原本的API，會發現因為吃不到Header裡面的X-Key，導致輸出驗證失敗的錯誤</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-hntf0ZIC-cQ/WAB1wx9JTOI/AAAAAAAAIAU/R5nql0g5UZwtIU6pdfk82zPO7EjDp4FggCLcB/s640/1.png)](https://1.bp.blogspot.com/-hntf0ZIC-cQ/WAB1wx9JTOI/AAAAAAAAIAU/R5nql0g5UZwtIU6pdfk82zPO7EjDp4FggCLcB/s1600/1.png)</div>

<p>Header中也再次確認沒有帶X-key在其中</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-pevW7o5r1eg/WAB2BE9-ayI/AAAAAAAAIAY/ErtqWFRqK7k0WBAKQXBZB32ghXOn3196gCLcB/s640/1.png)](https://1.bp.blogspot.com/-pevW7o5r1eg/WAB2BE9-ayI/AAAAAAAAIAY/ErtqWFRqK7k0WBAKQXBZB32ghXOn3196gCLcB/s1600/1.png)</div>

<h3 id="開始客製化吧"><a href="#開始客製化吧" class="headerlink" title="開始客製化吧"></a>開始客製化吧</h3><ul>
<li><p>  首先先建立一個JS檔，讓Swagger的View能引用這支JS，然後透過這支JS與Jquery去改View，我將這支JS就命名為AppKey.js</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-VdaLRHRtOlI/WAB3LAbaafI/AAAAAAAAIAc/tDB1aQ-EzzEutJ0RXZkrr4TRwvcWwFUnwCLcB/s1600/1.png)](https://1.bp.blogspot.com/-VdaLRHRtOlI/WAB3LAbaafI/AAAAAAAAIAc/tDB1aQ-EzzEutJ0RXZkrr4TRwvcWwFUnwCLcB/s1600/1.png)</div></li>
<li><p>  接著請在這支JS檔案寫下以下JS</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">&#x27;#input_apiKey&#x27;</span>).hide();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加上Header區塊</span></span><br><span class="line">    <span class="keyword">var</span> HeaderBar = $(<span class="string">&#x27;&lt;div id=&quot;headerbar&quot;&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;h2 class=&quot;heading&quot;&gt;Header&lt;/h2&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;table style=&quot;background-color:#E8E8D0&quot;&gt;&lt;thead&gt;&lt;tr&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;th style=&quot;width: 100px; max-width: 100px&quot; data-sw-translate=&quot;&quot;&gt;Parameter&lt;/th&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;th style=&quot;width: 310px; max-width: 310px&quot; data-sw-translate=&quot;&quot;&gt;Value&lt;/th&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;th style=&quot;width: 200px; max-width: 200px&quot; data-sw-translate=&quot;&quot;&gt;Description&lt;/th&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/tr&gt;&lt;/thead&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;tbody class=&quot;operation-params&quot;&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;tr&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;td class=&quot;code required&quot;&gt;&lt;label for=&quot;custom_appkey&quot;&gt;appkey&lt;/label&gt;&lt;/td&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;td&gt;&lt;input class=&quot;parameter required&quot; minlength=&quot;1&quot; name=&quot;custom_appkey&quot; placeholder=&quot;(required)&quot; id=&quot;custom_appkey&quot; type=&quot;text&quot; value=&quot;&quot;&gt;&lt;/td&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;td class=&quot;markdown&quot;&gt;&lt;p&gt;AppKey&lt;/p&gt;&lt;/td&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/tr&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/tbody&gt;&lt;/table&gt;&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;&lt;/div&gt;&#x27;</span>);</span><br><span class="line">    $(<span class="string">&#x27;#resources_container&#x27;</span>).before(HeaderBar);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把值加到Header</span></span><br><span class="line">    $(<span class="string">&#x27;#custom_appkey&#x27;</span>).on(<span class="string">&#x27;change&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> key = <span class="built_in">this</span>.value;</span><br><span class="line">        <span class="keyword">if</span> (key &amp;&amp; key.trim() !== <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            swaggerUi.api.clientAuthorizations.add(<span class="string">&quot;key&quot;</span>, <span class="keyword">new</span> SwaggerClient.ApiKeyAuthorization(<span class="string">&quot;X-Key&quot;</span>, key, <span class="string">&quot;header&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>主要內容就是抓到特定區塊，然後組Html用Jquery的方式放上去，然後透過Swagger開放的API塞到Header裡面送出</p>
<ul>
<li>  接著請將這支JS修改屬性 &gt; 建置動作 &gt; <strong>內嵌資源</strong></li>
</ul>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-BwLvO5AMcYw/WAB4kuDTvUI/AAAAAAAAIAg/QBIkgR01zCYDIxd2UjHmhHLanbuwCchqQCLcB/s320/1.png)](https://4.bp.blogspot.com/-BwLvO5AMcYw/WAB4kuDTvUI/AAAAAAAAIAg/QBIkgR01zCYDIxd2UjHmhHLanbuwCchqQCLcB/s1600/1.png)</div>

<ul>
<li>  打開SwaggerConfig找到188~189行的地方把註解拿掉改成如下<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-kG8umCQL1M0/WAB5FrxW2gI/AAAAAAAAIAo/RwoPyjGGq0YB1SE6f9jTvJ3h9mcveFFlQCLcB/s640/1.png)](https://2.bp.blogspot.com/-kG8umCQL1M0/WAB5FrxW2gI/AAAAAAAAIAo/RwoPyjGGq0YB1SE6f9jTvJ3h9mcveFFlQCLcB/s1600/1.png)</div>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">c.InjectJavaScript(thisAssembly, <span class="string">&quot;WebApplication1.CustomSwagger.AppKey.js&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>  接著再次執行專案<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-jAdPbsrj5yI/WAB5_JNiKdI/AAAAAAAAIAs/7DMJc1iTBl4kAm6_7yTv2f4pmNCfqFEQQCLcB/s640/1.png)](https://2.bp.blogspot.com/-jAdPbsrj5yI/WAB5_JNiKdI/AAAAAAAAIAs/7DMJc1iTBl4kAm6_7yTv2f4pmNCfqFEQQCLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">Header欄位出現了</td></tr></tbody></table>
試試看欄位是否有效，因為剛剛程式是改成要帶**MyKey**，所以來測試看看</li>
</ul>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://1.bp.blogspot.com/-v7nxyvIuGfs/WAB6YhN2EEI/AAAAAAAAIAw/luDPe_40Fpc-xvazlnkwp6qEPRdUbKMvgCLcB/s640/1.png)](https://1.bp.blogspot.com/-v7nxyvIuGfs/WAB6YhN2EEI/AAAAAAAAIAw/luDPe_40Fpc-xvazlnkwp6qEPRdUbKMvgCLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">可以抓到X-Key了</td></tr></tbody></table>

<p>完成!!!! 因為是透過Jquery的方式去改變欄位，所以只要透過上述的方式去載入JS，要怎麼改View應該都不是問題了，以上。</p>
<h4 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a><strong>參考文章</strong></h4><p><a href="http://stevemichelotti.com/customize-authentication-header-in-swaggerui-using-swashbuckle/">Customize Authentication Header in SwaggerUI using Swashbuckle</a></p>
]]></content>
      <tags>
        <tag>Swagger</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】Day 2 - 如何寫一個好的單元測試</title>
    <url>/2017/04/18/%E3%80%90Unit-Test%E3%80%91Day-2-%E5%A6%82%E4%BD%95%E5%AF%AB%E4%B8%80%E5%80%8B%E5%A5%BD%E7%9A%84%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6/</url>
    <content><![CDATA[<p>接著來討論一下單元測試究竟該怎麼寫，你可能也會有這樣的疑問，如果今天我的程式是要呼叫資料庫來取得資料，那是否真要接上一個資料庫去做單元測試呢？又公司的資料庫如果對外是連不到的，悲苦的工程師回家怎麼做單元測試呢？ 那如果是外部API呢？網路不通時單元測試是不是就都壞掉了？ 那該怎麼知道現在單元測試是真正的邏輯錯誤還是只是因為網路或是資料庫連不上導致的錯誤？是不是寫了單元測試後反而我要花大量的時間常常在檢查到底現在是錯哪邊啊…..。</p>
<p>其實我剛開始接觸單元測試的時候上面的問題也都想過一輪，但這也點出了單元測試一個很重要的特性</p>
<div class="note info">
            <p><span style="color: red;">單元測試應該是隨時隨地都要能正確執行，只要它本身的邏輯是正確的！！</span></p>
          </div>
<p>看完這句話你可能會默默響起ＯＳ，「阿鬼，你還是說中文吧～」。不過這段容我之後另外篇幅再做詳盡的解說，現在只要有這樣的觀念就好，單元測試不應該隨著你在的環境不同而有結果的落差，他關注的是<strong>邏輯</strong>而<strong>不是與外部的關聯。</strong><br>**<br>**<br>那好，假設我們做到了單元測試跟外部的關聯都斷開了，只專注在自己的邏輯上，這樣就稱得上是好的單元測試了嗎？ 當然不是！ 單元測試的命名也是一個很重要的課題</p>
<div class="note info">
            <p><span style="color: red;">單元測試的標題需要具備好的可讀性、明確、標題與測試的內容精確吻合</span></p>
          </div>
<p>還記得上一篇文章提到，撰寫良好的單元測試應該像是規格書一般，不僅要讓專案品質提高，更是要充當新接觸專案人員能透過閱讀單元測試對程式有基本認識的工具。</p>
<p>舉例來說：有一個單元測試標題這樣寫「public void GetTest_呼叫得到True()」，對於一個不看單元測試內容的人來說，這個標題一點意義都沒有，首先他不知道這個方法裡面是在幹嘛的，再來他究竟會做什麼事情導致他得到True，帶入的參數意義是什麼…等，這樣的單元測試反而是造成專案難以維護的幫兇。</p>
<p>所以比較好的單元測試標題應該詳盡，例：「public void GetTest_帶入會員ID＿應回該ID搜尋到的會員資料DTO」，盡量符合</p>
<div class="note info">
            <p>受測方法＿傳入參數意義＿期望得到的結果</p>
          </div>
<p>比起第一種命名方式是否明確易懂多了。</p>
<p>你可能又會冒出一個問題，如果這個方法帶進的ID查不到會員時，我會回傳Null，但怎麼在一個單元測試表示？這邊點出另一個重點</p>
<div class="note info">
            <p><span style="color: red;">一個測試只應該關注一件事情，如果受測目標有多種狀況，應該分成好幾個測試去涵蓋所有邏輯</span></p>
          </div>
<p>順著上面的邏輯，這個方法應該就會有另一個測試為「public void GetTest_帶入會員ID＿如搜尋不到該ID的會員＿回傳Null」。</p>
<p>所以如果一個方法裡面的IF ELSE很多，導致程式邏輯複雜度提高，則單元測試可能就會有對應的很多方法來涵蓋所有可能，所以如果有寫單元測試，則<strong>職責分離就是一個重要的課題</strong>，如果你把很多職責都放在同一段程式中，你的單元測試可能是倍數成長之外，測試也會變得很難撰寫。</p>
<p>從上面的舉例也可以看出，每個單元測試都只關注一種邏輯，一個方法難免包含多種邏輯狀況，但當修改程式時如果單元測試錯誤，也能幫助你快速鎖定可能是哪一段邏輯錯了，減少除錯的時間。再者，因為每個單元測試名稱都很明確，執行的方法帶入的參數也都明確的情況下，讓人閱讀時可以很容易進入狀況，符合一開始提到的<strong>可以執行的規格書</strong>，對專案是非常有幫助的。</p>
<p>接著來探討單元測試的內文該如何撰寫，首先應該符合所謂的<strong>3A原則</strong></p>
<div class="note info">
            <p>Arrange = 準備受測物件、參數、預期結果<br>Act = 執行受測方法<br>Assert = 驗證執行結果與預測結果是否一致</p>
          </div>

<p>拿昨天的單元測試來說明</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Method1Test_呼叫時應回傳結果為<span class="number">7</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> Sut = <span class="keyword">new</span> EasyMethod();</span><br><span class="line">            <span class="keyword">var</span> expected = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Sut.Method1();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(expected, actual);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Arrange中Sut(<span style="background-color: white; color: #242729; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-size: 15px;">System Under Test</span><span style="background-color: white; color: #242729; font-family: Arial, 'Helvetica Neue', Helvetica, sans-serif; font-size: 15px;">&nbsp;</span>),受測的目標為EasyMethod這跟Class,而這個單元測試預期的結果為7。</p>
<p>Act中actual是EasyMethod執行Method1這個方法得到的結果。</p>
<p>Assert中用MsTest提供的Assert.AreEqual方法驗證得到的結果與預期的結果是否一致。</p>
<p>如果每個單元測試都照著這樣的風格撰寫，則對於閱讀的人來說會很清楚歸類出每個區段各自的職責。</p>
<p>那今天就談到這邊，之後應該就會有比較多的實作了(擦汗)</p>
]]></content>
      <categories>
        <category>學習單元測試</category>
      </categories>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】Day 3 - 專注於邏輯，隔離與外部的關聯</title>
    <url>/2017/04/19/%E3%80%90Unit-Test%E3%80%91Day-3-%E5%B0%88%E6%B3%A8%E6%96%BC%E9%82%8F%E8%BC%AF%EF%BC%8C%E9%9A%94%E9%9B%A2%E8%88%87%E5%A4%96%E9%83%A8%E7%9A%84%E9%97%9C%E8%81%AF/</url>
    <content><![CDATA[<div class="note info">
            <p>Demo檔案 : <a href="https://github.com/toyo0103/UnitTest_Day3">Git傳送門</a></p>
          </div>
<p>昨天有提到對於外部有關聯時該如何寫單元測試，例如API就是一個典型的例子，當在沒有網路環境時，對於要拿到API的結果做後續處理，這時候該怎麼辦？今天要來實作並且落實昨天提到的重要特性</p>
<div class="note info">
            <p>單元測試應該是隨時隨地都要能正確執行，只要它本身的邏輯是正確的！！</p>
          </div>
<p>**<br>**<strong>來看看今天的情境範例</strong><br>我們有一個需求，它要能夠讓我們帶入台北市的公車路線名稱，並取回該路線的站點資料，該資料來源從<a href="http://ptx.transportdata.tw/PTX/">公共運輸整合資訊流通服務平台</a>的API取得。</p>
<div class="note info">
            <p>測試API : <a href="http://ptx.transportdata.tw/MOTC/v2/Bus/StopOfRoute/City/Taipei/307?$top=1&amp;$format=JSON">http://ptx.transportdata.tw/MOTC/v2/Bus/StopOfRoute/City/Taipei/307?$top=1&amp;$format=JSON</a></p>
          </div>
<p>從呼叫API看到的呼叫結果大致如下</p>
<p><img src="https://4.bp.blogspot.com/-te6lfBR6K44/WPb5BSAp1NI/AAAAAAAAIIE/lRXidmjjdE042MalNHIsNkgtogf_8gz-ACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-19%2B%25E4%25B8%258B%25E5%258D%25881.43.10.png"></p>
<p><strong>開始寫程式</strong><br>首先我們準備了一個主控台專案，裡面有一個PTX的Class，希望他有個方法能帶入<strong>縣市</strong>、<strong>公車路線名稱</strong>，然後回傳該路線所有站牌名稱與ID</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 巴士路線(該方法要回傳的結果)</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BusRouteDTO</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 路線名稱</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 巴士站列表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> List&lt;BusStop&gt; BusStops &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 巴士站</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BusStop</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 站名</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>用來承接API回傳資料的DTO </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 取PTX BusRoute的結果</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PTXBusRouteResult</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> NameDTO RouteName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> List&lt;StopDTO&gt; Stops &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 巴士路線名稱</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NameDTO</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> Zh_tw &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> En &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 站點</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">StopDTO</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 站點ID</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            <span class="keyword">public</span> <span class="built_in">string</span> StopUID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> 站點名稱</span></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">            <span class="keyword">public</span> NameDTO StopName &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NameDTO</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="built_in">string</span> Zh_tw &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">                <span class="keyword">public</span> <span class="built_in">string</span> En &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>PTX的程式</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PTX</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 取得巴士路線資料</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;city&quot;&gt;</span>縣市名稱<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;routeName&quot;&gt;</span>巴士路線名稱<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> BusRouteDTO <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> city,<span class="built_in">string</span> routeName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            BusRouteDTO Result = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//Use RestSharp Call API</span></span><br><span class="line">            <span class="keyword">var</span> client = <span class="keyword">new</span> RestClient(<span class="string">$&quot;http://ptx.transportdata.tw/MOTC/v2/Bus/StopOfRoute/City/<span class="subst">&#123;city&#125;</span>/<span class="subst">&#123;routeName&#125;</span>?%24top=1&amp;%24format=JSON&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> request = <span class="keyword">new</span> RestRequest(Method.GET);</span><br><span class="line">            request.AddHeader(<span class="string">&quot;cache-control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">            IRestResponse response = client.Execute(request);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (response.StatusCode == HttpStatusCode.OK)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> APIResult = JsonConvert.DeserializeObject&lt;List&lt;PTXBusRouteResult&gt;&gt;(response.Content);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (APIResult != <span class="literal">null</span> &amp;&amp; APIResult.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> Route = APIResult.First();</span><br><span class="line">                    Result = <span class="keyword">new</span> BusRouteDTO</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = Route.RouteName.Zh_tw,</span><br><span class="line">                        BusStops = <span class="keyword">new</span> List&lt;BusRouteDTO.BusStop&gt;()</span><br><span class="line">                    &#125;;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> stop <span class="keyword">in</span> Route.Stops)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Result.BusStops.Add(<span class="keyword">new</span> BusRouteDTO.BusStop</span><br><span class="line">                        &#123;</span><br><span class="line">                            ID = stop.StopUID,</span><br><span class="line">                            Name = stop.StopName.Zh_tw</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這邊呼叫API用的套件為RestSharp<br><img src="https://2.bp.blogspot.com/-NABAfYFPjgY/WPcA6MJCu5I/AAAAAAAAIIU/oMdlNWKwh4M7ZJ5vSuL4tkV10WoMUJzpACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-19%2B%25E4%25B8%258B%25E5%258D%25882.01.34.png"></p>
<p>將回傳的Json格式轉成DTO的套件是Newtonsoft.Json</p>
<p><img src="https://1.bp.blogspot.com/-opEwoBAjHF4/WPcBOB9kjhI/AAAAAAAAIIY/Ke3oAKptN_8zE9TQvYWpVa7rbylKfH_7QCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-19%2B%25E4%25B8%258B%25E5%258D%25882.18.08.png"></p>
<p>OK，因為是範例程式，所以一些寫作風格或是是否會Null的問題我們就先擺一邊吧，還是專注在我們的怎麼寫單元測試上。</p>
<p>接著我們來執行看看程式是否依照我們預期的可以取回結果</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> PTXFunction = <span class="keyword">new</span> PTX();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> Result = PTXFunction.Get(<span class="string">&quot;Taipei&quot;</span>,<span class="string">&quot;307&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Console.Write(JsonConvert.SerializeObject(Result));</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://3.bp.blogspot.com/-OWf1ZOiTZ7E/WPcJ0i-lFFI/AAAAAAAAIIo/sEjugyqLlpQI9lVT6VMi6VbbvBATGEt8QCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-19%2B%25E4%25B8%258B%25E5%258D%25882.52.18.png"></p>
<p>程式正確執行也取得回資料，第一階段搞定！！接下來開始寫單元測試了</p>
<h4 id="單元測試"><a href="#單元測試" class="headerlink" title="單元測試"></a>單元測試</h4><p>首先替它加上單元測試吧，老樣子在PTX的Get方法<strong>右鍵 &gt; 建立單元測試</strong></p>
<p><img src="https://3.bp.blogspot.com/-Mte3C3QIeVI/WPcKsy_8lrI/AAAAAAAAIIw/ew6tzFNAUlAP3mb-D-2pCk3mEo9jd23ewCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-19%2B%25E4%25B8%258B%25E5%258D%25882.58.09.png"></p>
<p>寫單元測試，這邊稍微解釋一下，因為還沒說怎麼驗證整個Class的內容比對，所以這邊先驗證回傳結果名稱就好，之後的章節會講怎麼驗證整個回傳內容的數值</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestClass()</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PTXTests</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">TestMethod()</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> GetTest_傳入縣市和公車路線名稱_如果查的到資料_應回傳該路線的BusRouteDTO()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> Sut = <span class="keyword">new</span> PTX();</span><br><span class="line">            <span class="keyword">var</span> City = <span class="string">&quot;Taipei&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> RouteName = <span class="string">&quot;307&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> expected = <span class="string">&quot;307&quot;</span>;</span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Sut.Get(City, RouteName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(actual.Name, expected);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>執行看看，得到正確的結果！！</p>
<p><img src="https://2.bp.blogspot.com/-yA_Wv9OQc3U/WPcMSNtLG4I/AAAAAAAAII8/3j0wOx6UXeYfc8CC-P_j-H5B3hGPE_wfACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-19%2B%25E4%25B8%258B%25E5%258D%25883.05.31.png"></p>
<p>但這邊我們都知道，如果今天網路斷掉或是對方API暫時提供服務，則我們的單元測試就會壞掉，因為他呼叫不到真實的API，而這其實違反我們之前說的「單元測試應該關注的是它的邏輯，而非外部的關聯」。如果今天因為環境就出錯，單元測試一多，可能我們常常都要花很多時間去找目前狀況是什麼，更可能的是查到最後才發現原來你的程式沒錯….</p>
<p>所以回頭看看我們的PTX程式，它的外部關聯是什麼？它關注的邏輯又是什麼？</p>
<div class="note info">
            <p>PTX.Get程式目前內部的邏輯如下<br>1.將帶入的參數組成API Url並進行呼叫<br>2.將取回的Json轉成DTO<br>3.判斷回傳的DTO是否有值？有則轉成我們要的結果回傳<br>3.1 否則直接回傳Null</p>
          </div>
<p>從這邊我會把它拆成<strong>1.呼叫外部API</strong>為外部行為，因為如果今天網路斷掉或是對方API壞掉、甚至是對方的API還沒開發好，理論上都不是我們程式的問題，而是網路或是對方要依照規格來處理。</p>
<p>所以第一步是我們要把外部行為隔離出去，並且想辦法讓我們可以模擬它而不是真正去呼叫線上的API，當然這邊做法有很多種，我選擇將Call API的行為還是視為PTX這個物件的內部行為，所以沒有獨立到別的Class去處理，而是封裝起來</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PTX</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 取得巴士路線資料</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;city&quot;&gt;</span>縣市名稱<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;routeName&quot;&gt;</span>巴士路線名稱<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> BusRouteDTO <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> city,<span class="built_in">string</span> routeName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            BusRouteDTO Result = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> JsonResult = CallAPI(city, routeName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(JsonResult))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> APIResult = JsonConvert.DeserializeObject&lt;List&lt;PTXBusRouteResult&gt;&gt;(JsonResult);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (APIResult != <span class="literal">null</span> &amp;&amp; APIResult.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> Route = APIResult.First();</span><br><span class="line">                    Result = <span class="keyword">new</span> BusRouteDTO</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = Route.RouteName.Zh_tw,</span><br><span class="line">                        BusStops = <span class="keyword">new</span> List&lt;BusRouteDTO.BusStop&gt;()</span><br><span class="line">                    &#125;;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> stop <span class="keyword">in</span> Route.Stops)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Result.BusStops.Add(<span class="keyword">new</span> BusRouteDTO.BusStop</span><br><span class="line">                        &#123;</span><br><span class="line">                            ID = stop.StopUID,</span><br><span class="line">                            Name = stop.StopName.Zh_tw</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Call API</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;city&quot;&gt;</span>縣市<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;routeName&quot;&gt;</span>巴士路線名稱<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="built_in">string</span> <span class="title">CallAPI</span>(<span class="params"><span class="built_in">string</span> city, <span class="built_in">string</span> routeName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//Use RestSharp Call API</span></span><br><span class="line">            <span class="keyword">var</span> client = <span class="keyword">new</span> RestClient(<span class="string">$&quot;http://ptx.transportdata.tw/MOTC/v2/Bus/StopOfRoute/City/<span class="subst">&#123;city&#125;</span>/<span class="subst">&#123;routeName&#125;</span>?%24top=1&amp;%24format=JSON&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> request = <span class="keyword">new</span> RestRequest(Method.GET);</span><br><span class="line">            request.AddHeader(<span class="string">&quot;cache-control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">            IRestResponse response = client.Execute(request);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (response.StatusCode == HttpStatusCode.OK)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> response.Content;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">string</span>.Empty;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這樣就達到分離了Call API這個外部行為，但是接下來的問題是我們該如何模擬CallAPI的行為，因為目前的程式還是會去呼叫外部API。</p>
<p><strong>讓我們把CallAPI從private改成protect吧，並且把它改成可以virtual，讓繼承它的子類別都可以改寫它</strong></p>
<p><img src="https://3.bp.blogspot.com/-5c0QoB53oMk/WPcSezyN0uI/AAAAAAAAIJM/Q-yAz7HaCEsF9035DvdLbpaAqnPx58YxgCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-19%2B%25E4%25B8%258B%25E5%258D%25883.31.18.png"></p>
<p>接著我們在單元測試專案中，然後開一個PTXStub的Class來繼承它並賦予他特殊屬性能改寫CallAPI的內部行為</p>
<div class="note info">
            <p>這邊提到Stub，在單元測試中還有一種叫做Ｍock，詳情定義跟討論可以參考<br><a href="http://stackoverflow.com/questions/3459287/whats-the-difference-between-a-mock-stub">stackoverflow - What’s the difference between a mock &amp; stub?</a></p>
          </div>

<p><img src="https://2.bp.blogspot.com/-2F8TjU8dKmg/WPcTQ0NTwpI/AAAAAAAAIJU/aJUEa1WYgp4azwqfmuCQw6CRJAxwvN1DgCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-19%2B%25E4%25B8%258B%25E5%258D%25883.35.13.png"></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PTXStub</span> :<span class="title">PTX</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用來模擬API回傳的Json Result</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> CallAPIResult;</span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">string</span> <span class="title">CallAPI</span>(<span class="params"><span class="built_in">string</span> city, <span class="built_in">string</span> routeName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(CallAPIResult))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> CallAPIResult;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span>  <span class="keyword">base</span>.CallAPI(city, routeName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我們將CallAPIResult的方法改寫掉，讓他回傳我們對外開放出來的CallAPIResult這個屬性，此屬性可以讓我們設定API應該回傳的結果。</p>
<p>接下就回頭改單元測試的部分 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> GetTest_傳入縣市和公車路線名稱_如果查的到資料_應回傳該路線的BusRouteDTO()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> Sut = <span class="keyword">new</span> PTXStub(); <span class="comment">//改成PTXStub</span></span><br><span class="line">            <span class="keyword">var</span> City = <span class="string">&quot;Taipei&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> RouteName = <span class="string">&quot;307&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//API應該回傳的結果</span></span><br><span class="line">            <span class="keyword">var</span> sb = <span class="keyword">new</span> System.Text.StringBuilder(<span class="number">12766</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">@&quot;[&#123;&quot;&quot;RouteUID&quot;&quot;:&quot;&quot;TPE16111&quot;&quot;,&quot;&quot;RouteID&quot;&quot;:&quot;&quot;16111&quot;&quot;,&quot;&quot;RouteName&quot;&quot;:&#123;&quot;&quot;Zh_tw&quot;&quot;:&quot;&quot;307&quot;&quot;,&quot;&quot;En&quot;&quot;:&quot;&quot;307&quot;&quot;&#125;,&quot;&quot;KeyPattern&quot;&quot;:false,&quot;&quot;SubRouteUID&quot;&quot;:&quot;&quot;TPE157462&quot;&quot;,&quot;&quot;SubRouteID&quot;&quot;:&quot;&quot;157462&quot;&quot;,&quot;&quot;SubRouteName&quot;&quot;:&#123;&quot;&quot;Zh_tw&quot;&quot;:&quot;&quot;307莒光經板橋前站&quot;&quot;,&quot;&quot;En&quot;&quot;:&quot;&quot;307&quot;&quot;&#125;,&quot;&quot;Direction&quot;&quot;:0,&quot;&quot;Stops&quot;&quot;:[&#123;&quot;&quot;StopUID&quot;&quot;:&quot;&quot;TPE15294&quot;&quot;,&quot;&quot;StopID&quot;&quot;:&quot;&quot;15294&quot;&quot;,&quot;&quot;StopName&quot;&quot;:&#123;&quot;&quot;Zh_tw&quot;&quot;:&quot;&quot;莊敬里&quot;&quot;,]............&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//設定CallAPI回傳結果</span></span><br><span class="line">            Sut.CallAPIResult = sb.ToString();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> expected = <span class="string">&quot;307&quot;</span>;</span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Sut.Get(City, RouteName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(actual.Name, expected);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>API應該回傳的結果那邊因為太長，所以省略部分回傳結果，但在實際程式是完整貼上，詳請看Git的Source Code。</p>
<p>這樣就可以模擬CallAPI這個跟外部連結的結果，但依然可以測試我們所關注的邏輯，是否可卻轉成我們要的結果，執行後可以發現單元測試還是顯示綠燈的正確無誤。</p>
<p>但這個方法也不是百分之百沒有缺點，你應該也可以觀察到其中一段在這單元測試中無法被涵蓋到，那就是組API Url那段，在這種透過繼承解耦合的方式中，因為回傳結果是自己設定的，實際上組成的URL正確與否我們並不知道，換句話說，如果我們今天這樣寫測試可能會過，但上線後才會發現錯誤，檢查之下發現原來是在串Url的時候錯字之類的。</p>
<p>這是這種測試方法的缺點，但今天就先談到這邊，還有別種方法可以解決這個問題，只是通常有一好沒兩好，各自都會有優缺點，就看實際專案情形自行判斷跟取捨了。</p>
]]></content>
      <categories>
        <category>學習單元測試</category>
      </categories>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】Day 1 - 為何要寫單元測試</title>
    <url>/2017/04/17/%E3%80%90Unit-Test%E3%80%91Day-1-%E7%82%BA%E4%BD%95%E8%A6%81%E5%AF%AB%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6/</url>
    <content><![CDATA[<div class="note info">
            <p>Demo檔案 : <a href="https://github.com/toyo0103/UnitTest_Day1">Git傳送門</a></p>
          </div>
<p>算一算開始寫單元測試也快兩年了，很感謝當時能有機會得到前輩的指導並接觸到這個技術，在實際運用到開發上面時，也真正的感受到它的好，為了將單元測試這好東西分享給更多人知道，所以有了寫這系列文章的想法。</p>
<p>這系列文章是希望在讀者讀完後，能讓你從一位不會寫單元測試的開發者，粗略的搞懂單元測試為何、如何撰寫、並且能透過實作中體會到它如何幫助專案更加穩固。</p>
<div class="note info">
            <p>我不是什麼技術大牛，如果發現文章有疏漏的地方，還請不吝指正指導。 感謝!!</p>
          </div>


<h3 id="為何我要寫單元測試"><a href="#為何我要寫單元測試" class="headerlink" title="為何我要寫單元測試"></a>為何我要寫單元測試</h3><p>不知你可曾遇過這樣的狀況….</p>
<h4 id="情境一"><a href="#情境一" class="headerlink" title="情境一 :"></a>情境一 :</h4><p>接手了一個很舊的系統維護，關於規格與文件皆已不可考，連開發過的工程師們都已離職不幹了，現在PM跟你說他想改一個功能，並拍拍你肩說「這個很簡單，一下下就好」。而你卻不知道該從何下手….<br>_<br>_<em>單元測試能幫你做什麼?</em></p>
<div class="note info">
            <p>優良的單元測試就像活著的規格書，不僅能幫助你了解那些不是你負責的功能，更是能夠執行的規格書</p>
          </div>


<h4 id="情境二"><a href="#情境二" class="headerlink" title="情境二:"></a>情境二:</h4><div>是否曾經改發生過改好新功能，但舊功能就壞掉，修好舊功能，新功能又壞掉了呢?&nbsp; 假設下圖就是你的功能，而你希望它三個能同時選取時....

<p><img src="https://2.bp.blogspot.com/-VWE1ZTU6uKI/WPRM9LqlYgI/AAAAAAAAIGc/F2gVhAE0QQEBLjrFwBHlc6AKJsJBoqxBACLcB/s320/GoodCheapFast_MissingCloud_O%255B1%255D.gif"></p>
<p><em>單元測試能幫你做什麼?</em></p>
<div class="note info">
            <p>它能告訴你目前的程式，是否執行都符合當時所要求的規格與產出結果，如果舊規格舊方法沒有改的情況下，單元測試壞了，那就表示你這次的改動絕對有影響到它，趕緊去修好它吧!!</p>
          </div>


<h4 id="情境三"><a href="#情境三" class="headerlink" title="情境三 :"></a>情境三 :</h4><div>一個你覺得很簡單的功能，直到你上線才發現原來功能是錯的無法正常執行，偵錯下去才發現，天殺的，原來是自己觀念上錯誤或不熟悉。例如Double&nbsp;a&nbsp; = 1.1加上Double b&nbsp;=&nbsp;1.2，而你以為它的結果會是2.3....&nbsp; </div>_
__單元測試能幫你做什麼?_
<div class="note info">
            <p>它能即時的驗證你的想法，而不是到上線時才賭人品，尤其是那些你覺得理所當然會對的功能中，魔鬼往往藏在細節裡</p>
          </div>

<p>在你還沒寫單元測試之前，上述狀況是否都似曾相識呢?如果你想解決這些問題，那麼開始寫單元測試將是可以大幅度降低這些錯誤的有效方法，而且你一定會愛上它。</p>
<h3 id="該如何開始寫單元測試"><a href="#該如何開始寫單元測試" class="headerlink" title="該如何開始寫單元測試"></a>該如何開始寫單元測試</h3><p>接著我們就來用實際案例重現上面提到了一些問題，並且透過撰寫單元測試來看看它如何幫我們避免這些狀況。</p>
<p><strong>首先準備一個類別庫專案</strong><br><img src="https://4.bp.blogspot.com/-LYJzaBr-6qU/WPReTQlg_EI/AAAAAAAAIGs/JdQPXNcMt2s0xnjtr0iRh1sp4lf6wJBIQCLcB/s1600/Image%2B2.jpg"><br>**<br>****寫下一段簡單的程式，而這段程式很簡單，就只是把基數加上2回傳回去即可 **<br>**<br>**</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EasyMethod</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">private</span> <span class="built_in">int</span> BaseNumber = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">Method1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>   &#123;</span><br><span class="line">      <span class="keyword">return</span> BaseNumber + <span class="number">2</span>;</span><br><span class="line">   &#125;   </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>而這段程式真的非常簡單，簡單到你一看就覺得它回傳是7，不過沒關係我們繼續完成單元測試，看它能幫助我們什麼</p>
<p><strong>接著建立單元測試專案</strong></p>
<div>在Method1的的方案下右鍵 &gt; 建立單元測試 
<div class="note info">
            <p>如果你是用VS2017，可能會發現沒有建立單元測試這個選項，請將VS更新到最新版就有了</p>
          </div>

<p><img src="https://4.bp.blogspot.com/-pl7THbVdv5Q/WPRl5WWW7cI/AAAAAAAAIG8/iTQ4_sz0Fosq4W8Ecx3h91bG4MstQKutgCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-17%2B%25E4%25B8%258B%25E5%258D%25882.50.45.png"></p>
<p><img src="https://3.bp.blogspot.com/-LM9F1XlZwb4/WPRmLeGDlYI/AAAAAAAAIHA/3yZqleBgG6gO4V_w3HogGIU5fT-b6gydQCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-17%2B%25E4%25B8%258B%25E5%258D%25882.52.06.png"></p>
<p>接著就會看到單元測試專案已經幫你建立完成</p>
<p><img src="https://4.bp.blogspot.com/-zM7aFE7GH3Y/WPRmlQOhxaI/AAAAAAAAIHE/qkSV7SacRQcPC6LrXIfxXSa5fMoxKMgzACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-17%2B%25E4%25B8%258B%25E5%258D%25882.53.38.png"></p>
<p>讓我們來寫下第一個完整的單元測試，將那個自動建立的單元測試改成</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod()</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Method1Test_呼叫時應回傳結果為<span class="number">7</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> Sut = <span class="keyword">new</span> EasyMethod();</span><br><span class="line">            <span class="keyword">var</span> expected = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Sut.Method1();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(expected, actual);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>稍微檢視一下這個單元測試能帶給我們什麼？首先從標題上我們可以知道這個方法的目的跟應得到的結果，接著我們可以從單元測試的程式碼中看出這個方法該如何使用。</p>
<p>接著我們在測試總管中執行單元測試，知道目前這個方法符合我們需求跟得到預期的結果</p>
<p><img src="https://1.bp.blogspot.com/-QgRTYArFcLg/WPRpcgKZECI/AAAAAAAAIHQ/1IQu0Kv4A8oH3gUolF7t2Ztf8iDe6e5FACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-17%2B%25E4%25B8%258B%25E5%258D%25883.04.21.png"></p>
<p><strong>當我們面臨需求的更改…..</strong><br>接著我們知道日常狀況是，需求總是一直的在擴充及變動，所以我們有了一個新需求</p>
<div class="note info">
            <p>我希望能有個新的方法，並且呼叫它時能回傳給我10這個答案，而且因應業務需求，基數需要改變成2</p>
          </div>

<p>OK!!一切聽起來都不是太難，那就讓我們直接動手下去做吧<br>首先我先將基數改成2，並且新增一個<strong>Method2</strong>的方法，並且讓他加上基數後得到10這個結果回傳。</p>
<p><img src="https://2.bp.blogspot.com/-FRy0jhit7No/WPRq_jFpwqI/AAAAAAAAIHc/y44CWdcjDrcJQDxL7R_IKJu2toEwKfXnACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-17%2B%25E4%25B8%258B%25E5%258D%25883.12.47.png"></p>
<p>老方法，在Method2那邊按下右鍵 &gt; 建立單元測試，並寫上新的方法的單元測試</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">UnitTestDay1.Tests</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">TestClass()</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EasyMethodTests</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">TestMethod()</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Method1Test_呼叫時應回傳結果為<span class="number">7</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> Sut = <span class="keyword">new</span> EasyMethod();</span><br><span class="line">            <span class="keyword">var</span> expected = <span class="number">7</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Sut.Method1();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(expected, actual);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">TestMethod()</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Method2Test_呼叫時應回傳結果為<span class="number">10</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> Sut = <span class="keyword">new</span> EasyMethod();</span><br><span class="line">            <span class="keyword">var</span> expected = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Sut.Method2();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(expected, actual);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>一切完美直到你執行單元測試時你會發現，原本的Method1壞掉啦！！</p>
<p><img src="https://1.bp.blogspot.com/-ONucqHcnfT8/WPRtaLBmZyI/AAAAAAAAIHo/uo-JgM5v1vAAkpq_vhK0zdcGEA3nrq2KACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-17%2B%25E4%25B8%258B%25E5%258D%25883.23.01.png"><br>原來因為我們更改了基數所以造成了Method1回傳時不符合當時所制定的規格，這時候我們如果確定原需求沒有變動的情況下，那就是去修改原本的方法讓它能通過單元測試。這樣新舊需求就都確保正確的情況下更正完成了。</p>
<p><img src="https://2.bp.blogspot.com/-4utjp7_INMM/WPRuZ_dtOGI/AAAAAAAAIH0/UD48Au_NHgMZuOiSgIV4CcDf-GhIzRb1gCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-17%2B%25E4%25B8%258B%25E5%258D%25883.26.26.png"></p>
<p><img src="https://3.bp.blogspot.com/-jPiCnkysVEA/WPRuZ6HDvaI/AAAAAAAAIHw/3kcZvX35-BECFdVE-PJWHIDJSCQt_RdUQCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-17%2B%25E4%25B8%258B%25E5%258D%25883.26.40.png"></p>
<h3 id="今日小結"><a href="#今日小結" class="headerlink" title="今日小結"></a>今日小結</h3><p>從這個範例中我們可以整理出一些單元測試所能帶來的好處。</p>
<p>首先，因為在撰寫程式時，我們會在當下寫上單元測試，並且讓它通過，日後不管任何原因它壞掉了，我們都能從標題中或是案例來知道當時的需求與狀況，形成上面提到的所謂活著可執行的規格書，（當然前提是你的標題跟內容要寫得乾淨易懂，否則維護單元測試可能又是另一場災難），即便規格書遺失或是人員異動，對於程式本身的維護都有一定品質的保障。</p>
<p>接著是需求異動，雖然這個範例舉例的有點極端，但我只是想表達一種狀況，常常我們在改動共用方法或是核心功能時，往往不知道這樣改可能會造成哪邊的錯誤，甚至是編譯執行都是正常，但其實違反了當時所定義的程式或商業邏輯，而這往往是要上線的時候才會發現，但從這案例中，基數被改變時，雖然把Mehod2順利地完成的，但我們卻忽略了Method1可能導致它變動進而產生錯誤，有了單元測試或是整合測試，這樣的狀況可以有效地減少跟被控管（特別強調：非百分之百！！所以整合測試跟單元測試都一樣很重要，如果可以，兩個都做會是最好的選擇）</p>
<p>好的，希望第一篇文章可以淺顯易懂的讓大家感受單元測試的好處！！</p>
]]></content>
      <categories>
        <category>學習單元測試</category>
      </categories>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】Day 4 - Mock</title>
    <url>/2017/04/20/%E3%80%90Unit-Test%E3%80%91Day-4-Mock/</url>
    <content><![CDATA[<div class="note info">
            <p>Demo檔案 : <a href="https://github.com/toyo0103/UnitTest_Day3/tree/UnitTest_Day4">Git傳送門</a><br>因為程式是昨天的延續，所以是同一個Repository切出UnitTest_Day4的Branch</p>
          </div>

<p>讓繼續我們昨天的議題，節錄昨天最後的結論</p>
<div class="note info">
            <p>…這個方法也不是百分之百沒有缺點，你應該也可以觀察到其中一段在這單元測試中無法被涵蓋到，<br>那就是組API Url那段，在這種透過繼承解耦合的方式中，因為回傳結果是自己設定的，<br>實際上組成的URL正確與否我們並不知道，換句話說，如果我們今天這樣寫測試可能會過，<br>但上線後才會發現錯誤，檢查之下發現原來是在串Url的時候錯字之類的。</p>
          </div>
<p>身為一位專業有責任感的工程師，你一定想著「爾等豈能如此<strike><span style="font-size: xx-small;">苟且偷生便宜行事</span></strike>草率」，所以今天就來談談另一種方法，Mock。</p>
<div class="note info">
            <p>何謂Mock。<br>當測試時你關注與外部相依物件互動時其狀態的變化，並且驗證它，則此就是Mock物件。</p>
          </div>
<p>很抽象對吧，沒關係讓我們來改改昨天的實作，重中瞭解Stub與Mock的差異。</p>
<p><strong>先將呼叫API的地方徹底隔離出去</strong><br>開一個NetTool的資料夾，建立一個IRestSharp的介面</p>
<p><img src="https://1.bp.blogspot.com/-cvva5eQ2U_4/WPhm4hWfpZI/AAAAAAAAIJk/65nHytvwgT4QxLHwZL44KK4dmIJV1-xSACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-20%2B%25E4%25B8%258B%25E5%258D%25883.44.02.png"></p>
<p>該介面定義出呼叫API該傳入Url，回傳得到的結果 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IRestSharp</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用Get的方法呼叫API</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;url&quot;&gt;</span>Url<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>回傳的內容<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="built_in">string</span> <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> url</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>實做這個介面</p>
<p><img src="https://1.bp.blogspot.com/-eC21gpDf_0k/WPhoKU1dJVI/AAAAAAAAIJs/lLuPr3k2Yus1qBm3VHltK9zSz1gZ7fDTgCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-20%2B%25E4%25B8%258B%25E5%258D%25883.49.03.png"></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyRestSharp</span> : <span class="title">IRestSharp</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 用Get的方法呼叫API</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;url&quot;&gt;</span>Url<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>回傳的內容<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> url</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//Use RestSharp Call API</span></span><br><span class="line">            <span class="keyword">var</span> client = <span class="keyword">new</span> RestClient(url);</span><br><span class="line">            <span class="keyword">var</span> request = <span class="keyword">new</span> RestRequest(Method.GET);</span><br><span class="line">            request.AddHeader(<span class="string">&quot;cache-control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">            IRestResponse response = client.Execute(request);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (response.StatusCode == HttpStatusCode.OK)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> response.Content;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">string</span>.Empty;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>修改PTX的程式</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PTX</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRestSharp _MyRestSharp;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Construct</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;myRestSharp&quot;&gt;</span>外部注入呼叫API的實體<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PTX</span>(<span class="params">IRestSharp myRestSharp</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//改由外部注入呼叫API的實體</span></span><br><span class="line">            <span class="keyword">this</span>._MyRestSharp = myRestSharp;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 取得巴士路線資料</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;city&quot;&gt;</span>縣市名稱<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;routeName&quot;&gt;</span>巴士路線名稱<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> BusRouteDTO <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> city,<span class="built_in">string</span> routeName</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            BusRouteDTO Result = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//要呼叫的API Url</span></span><br><span class="line">            <span class="built_in">string</span> Url = <span class="built_in">string</span>.Format(<span class="string">$&quot;http://ptx.transportdata.tw/MOTC/v2/Bus/StopOfRoute/City/<span class="subst">&#123;city&#125;</span>/<span class="subst">&#123;routeName&#125;</span>?%24top=1&amp;%24format=JSON&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> JsonResult = _MyRestSharp.Get(Url);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(JsonResult))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> APIResult = JsonConvert.DeserializeObject&lt;List&lt;PTXBusRouteResult&gt;&gt;(JsonResult);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (APIResult != <span class="literal">null</span> &amp;&amp; APIResult.Count &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> Route = APIResult.First();</span><br><span class="line">                    Result = <span class="keyword">new</span> BusRouteDTO</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = Route.RouteName.Zh_tw,</span><br><span class="line">                        BusStops = <span class="keyword">new</span> List&lt;BusRouteDTO.BusStop&gt;()</span><br><span class="line">                    &#125;;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> stop <span class="keyword">in</span> Route.Stops)</span><br><span class="line">                    &#123;</span><br><span class="line">                        Result.BusStops.Add(<span class="keyword">new</span> BusRouteDTO.BusStop</span><br><span class="line">                        &#123;</span><br><span class="line">                            ID = stop.StopUID,</span><br><span class="line">                            Name = stop.StopName.Zh_tw</span><br><span class="line">                        &#125;);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>修改Program.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//new PTX時變成要帶入呼叫API的實體</span></span><br><span class="line">            <span class="keyword">var</span> PTXFunction = <span class="keyword">new</span> PTX(<span class="keyword">new</span> MyRestSharp());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> Result = PTXFunction.Get(<span class="string">&quot;Taipei&quot;</span>,<span class="string">&quot;307&quot;</span>);</span><br><span class="line"></span><br><span class="line">            Console.Write(JsonConvert.SerializeObject(Result));</span><br><span class="line"></span><br><span class="line">            Console.ReadKey();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>執行後結果是對的！！</p>
<p><img src="https://3.bp.blogspot.com/-umwBITYCb_Y/WPhq7RbpxfI/AAAAAAAAIJ4/GK1TVxOKx2U6rlKhuePmBD4S1RyjuA3QACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-20%2B%25E4%25B8%258B%25E5%258D%25883.55.53.png"></p>
<h4 id="單元測試"><a href="#單元測試" class="headerlink" title="單元測試"></a>單元測試</h4><p>到目前為止都沒有解釋太多為何要這樣改，不過這跟物件導向設計比較有關，即所謂的外部注入即依賴介面，但這比較偏設計的範疇這邊就不特別討論，不過之後應該會漸漸的發現，如果單元測試要能寫，很多地方都會必須要有物件導向的設計方式才有辦法。</p>
<p>讓我們回頭看單元測試，首先昨天做的PTXStub就沒用了，因為目前的PTX沒有將呼叫API封裝起來，也就沒有可以override的CallAPI方法了，把它砍掉了。</p>
<p>這時就會看到昨天的單元測試壞掉了，因為找不到PTXStub</p>
<p><img src="https://2.bp.blogspot.com/-Uq_dKbo7G8Q/WPhsMNWenvI/AAAAAAAAIKA/yLCKydQzNJs0uHSUapDP3LihRXtxgKnTgCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-20%2B%25E4%25B8%258B%25E5%258D%25884.06.34.png"></p>
<p><strong>開始做我們的假物件MyRestSharpMock吧</strong></p>
<p><img src="https://3.bp.blogspot.com/-ZDXJ_Arjt2o/WPhtjaZXn7I/AAAAAAAAIKI/35r-33sGq6ol4iSwqgTJj1gtLGdtoO0awCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-20%2B%25E4%25B8%258B%25E5%258D%25884.12.06.png"></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyRestSharpMock</span> : <span class="title">IRestSharp</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> url</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (url == <span class="string">&quot;http://ptx.transportdata.tw/MOTC/v2/Bus/StopOfRoute/City/Taipei/307?%24top=1&amp;%24format=JSON&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> sb = <span class="keyword">new</span> System.Text.StringBuilder(<span class="number">12766</span>);</span><br><span class="line">                sb.AppendLine(<span class="string">@&quot;[&#123;&quot;&quot;RouteUID&quot;&quot;:&quot;&quot;TPE16111&quot;&quot;,&quot;&quot;RouteID&quot;&quot;:&quot;&quot;16111&quot;&quot;,&quot;&quot;RouteName&quot;&quot;:&#123;&quot;&quot;Zh_tw&quot;&quot;:&quot;&quot;307&quot;&quot;,&quot;&quot;En&quot;&quot;:&quot;&quot;307&quot;&quot;&#125;,.....省略&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> sb.ToString();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">string</span>.Empty;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這邊特別注意一下if那邊，依據昨天的單元測試，最後網址應該要組成這樣才是正確的，所以我們MyRestSharpMock特地加上這段判斷，已經不像昨天override一樣，不關心它組的網址為何，一律依照我們設定的結果回傳，即便你其實Url組的是錯誤的。</p>
<p><strong>修改PTXTest.cs</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestClass()</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PTXTests</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">TestMethod()</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> GetTest_傳入縣市和公車路線名稱_如果查的到資料_應回傳該路線的BusRouteDTO()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> RestSharpMock = <span class="keyword">new</span> MyRestSharpMock();</span><br><span class="line">            <span class="keyword">var</span> Sut = <span class="keyword">new</span> PTX(RestSharpMock); <span class="comment">//注入我們模擬的假物件MyRestSharpMock</span></span><br><span class="line">            <span class="keyword">var</span> City = <span class="string">&quot;Taipei&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> RouteName = <span class="string">&quot;307&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> expected = <span class="string">&quot;307&quot;</span>;</span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Sut.Get(City, RouteName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(actual.Name, expected);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>我們注入的是自己Mock的物件，他不會實際去呼叫API，但它關注我們傳入的值對不對，執行單元測試看看結果。</p>
<p><img src="https://3.bp.blogspot.com/-4ez2utZWgfk/WPhwpoXVMlI/AAAAAAAAIKU/rT34UNZDtQcdRNNasA1cBkX_IquRVtmqQCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-20%2B%25E4%25B8%258B%25E5%258D%25884.25.56.png"></p>
<p>可能到這邊會有一個疑問是，「廢話，Mock的物件是我們自己做的，我們想怎麼樣都馬可以！！」，一開始學到這段的時候也有這個疑問，所以容我解釋一下，還記得先前提到的觀念嗎？</p>
<div class="note info">
            <p>單元測試關注本身的邏輯，而非外部的關聯</p>
          </div>
<p>如果今天上線後發現錯誤，而發生錯誤的地方是在呼叫API的程式，那該修改的是誰？當然是MyRestSharp.cs，也絕對不是PTX這支程式，因為它職責掌管的邏輯全部都是正確的。而我們現在單元測試以及MyRestSharpMock都是在做什麼？ 都是在輔助我們驗證PTX所有包含到的邏輯，我們並不關注外部其他程式到底幹了什麼，退一萬步說（好啦其實退一步就可以了）（你好煩）今天IRestSharp這個Interface你的夥伴忘記去實作導致程式上線壞了，那也不會是改你的PTX吧，要改可以，over my dead body先，所以希望這囉說的補充可以幫助釐清這件事情。</p>
<p>好的，上面這邊如果沒問題的話，那下一步應該心裡就會冒出一個OS :<strong>我的好天鵝啊！！ 如果外部相依的物件很多，每個都自己做Mock物件，做完都老了，單元測試沒寫完Deadline就到了，搞毛啊….</strong><br>看官稍安勿躁，你的心聲有人聽到了，所以接下來介紹一個可以省略掉剛剛一堆繁瑣的動作，登登登登，為您隆重介紹<a href="http://nsubstitute.github.io/">NSubstitute</a>，怎麼用呢？讓我們在<strong>UnitTestDay3Tests</strong>這個專案透過Nuget安裝這個套件</p>
<p><img src="https://2.bp.blogspot.com/-VfiePWyp1vI/WPh09qCW9TI/AAAAAAAAIKg/uWpWPXnQyQUCseoMK9_Li286b-8LndYFwCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-20%2B%25E4%25B8%258B%25E5%258D%25884.44.06.png"></p>
<p>怎麼用呢？先Using</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> NSubstitute;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>然後… </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestClass()</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PTXTests</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">TestMethod()</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> GetTest_傳入縣市和公車路線名稱_如果查的到資料_應回傳該路線的BusRouteDTO()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="comment">//透過NSubstitute跟它說你想Mock實作的Interface</span></span><br><span class="line">            <span class="keyword">var</span> NsubRestSharpMock = Substitute.For&lt;IRestSharp&gt;();</span><br><span class="line">            <span class="keyword">var</span> Sut = <span class="keyword">new</span> PTX(NsubRestSharpMock); <span class="comment">//注入</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//期望API回傳的Json </span></span><br><span class="line">            <span class="keyword">var</span> sb = <span class="keyword">new</span> System.Text.StringBuilder(<span class="number">12766</span>);</span><br><span class="line">            sb.AppendLine(<span class="string">@&quot;[&#123;&quot;&quot;RouteUID&quot;&quot;:&quot;&quot;TPE16111&quot;&quot;,&quot;&quot;RouteID&quot;&quot;:&quot;&quot;16111&quot;&quot;,&quot;&quot;RouteName&quot;&quot;:...後略&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//這邊的意思是,當這個透過NSubstitute Mock的物件</span></span><br><span class="line">            <span class="comment">//被呼叫Get的方法時,且帶入的參數是我們這邊寫的字串</span></span><br><span class="line">            <span class="comment">//就回傳Returns那裡面我們設定的字串</span></span><br><span class="line">            NsubRestSharpMock.Get(<span class="string">&quot;http://ptx.transportdata.tw/MOTC/v2/Bus/StopOfRoute/City/Taipei/307?%24top=1&amp;%24format=JSON&quot;</span>)</span><br><span class="line">                             .Returns(sb.ToString());</span><br><span class="line">            <span class="keyword">var</span> City = <span class="string">&quot;Taipei&quot;</span>;</span><br><span class="line">            <span class="keyword">var</span> RouteName = <span class="string">&quot;307&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> expected = <span class="string">&quot;307&quot;</span>;</span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Sut.Get(City, RouteName);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(actual.Name, expected);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>因為NSubstitute Mock出來實作IRestSharp的物件也會有Get的方法，他還可以設定帶入參數為何才回傳值，如果比對的Url不符合預期，則就會回傳String的預設值Null，是不是超方便的！！</p>
<p>當然如果你的方法是要回傳物件，一樣往Returns擺進去就對了，且它驗證參數的方法還有很多種而且很彈性，例如帶入如果是數字，你可以說大於100才回傳結果之類的，因為太多有需要的話還是直接參考他的文件比較快。</p>
<p>那今天的部分就談到這邊，能幫助我們做到Mock的套件還有很多，這邊只是其中一種我使用的而已，不一定要一樣，但只要了解原來Mock是這麼回事即可。</p>
]]></content>
      <categories>
        <category>學習單元測試</category>
      </categories>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】Day 6 - 單元測試初始化與清除</title>
    <url>/2017/04/24/%E3%80%90Unit-Test%E3%80%91Day-6-%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6%E5%88%9D%E5%A7%8B%E5%8C%96%E8%88%87%E6%B8%85%E9%99%A4/</url>
    <content><![CDATA[<div class="note info">
            <p>Demo檔案 : <a href="https://github.com/toyo0103/UnitTest_Day6">Git傳送門</a></p>
          </div>
<p>今天要來看看單元測試的初始化設定與清除</p>
<p><img src="https://4.bp.blogspot.com/-rdIHeq-FScw/WPt7g9bnUSI/AAAAAAAAIMQ/2259b_3JrGc7ie6uQsiv0k09fX53AaNAACLcB/s1600/UnitTest03-Fig1.png"><br>圖片出處：<a href="https://www.codeproject.com/Articles/1165536/Unit-Test-Initialization-and-Cleanup">https://www.codeproject.com/Articles/1165536/Unit-Test-Initialization-and-Cleanup</a></p>
<p>上圖是單元測試在執行時的生命週期，知道了這特性的時候我們就可以依據測試的需要來加入適當的初始化設定。</p>
<p>**<br>**<strong>以下範例來說明執行順序</strong><br>這邊準備了一個Static Class，裡面有個Get方法很簡單的回傳Now這個屬性值</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">Demo</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> Now &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> Now;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然後為它建立單元測試<br><img src="https://4.bp.blogspot.com/-X86wEgoGgkI/WP1gOEKaSiI/AAAAAAAAIMg/V1bLniG0AOEAJmbzJuzDXQNm7CVgijKYACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-24%2B%25E4%25B8%258A%25E5%258D%258810.17.04.png"></p>
<p>先加上一個TestHook的檔案</p>
<p><img src="https://3.bp.blogspot.com/-6l9LIosfyy4/WP1p_8gzszI/AAAAAAAAIMw/28CyY4ytG74DIybRasVkfi7tIjsrMCJtwCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-24%2B%25E4%25B8%258A%25E5%258D%258810.58.35.png"></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestClass</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestHook</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">AssemblyInitialize</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AssemblyInit</span>(<span class="params">TestContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; - AssemblyInitialize&quot;</span>, Demo.Get()));</span><br><span class="line">            Demo.Now += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">AssemblyCleanup</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">AssemblyCleanUp</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; - AssemblyCleanup&quot;</span>, Demo.Get()));</span><br><span class="line">            Demo.Now += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接著撰寫DemoTests.cs</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestClass</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DemoTests</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">ClassInitialize</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ClassInit</span>(<span class="params">TestContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; - ClassInitialize&quot;</span>, Demo.Get()));</span><br><span class="line">            Demo.Now += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">TestInitialize</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TestInit</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; - TestInitialize&quot;</span>, Demo.Get()));</span><br><span class="line">            Demo.Now += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetTest</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; - Test1&quot;</span>, Demo.Get()));</span><br><span class="line">            Demo.Now += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">TestCleanup</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">TestCleanUp</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; - TestCleanup&quot;</span>, Demo.Get()));</span><br><span class="line">            Demo.Now += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">ClassCleanup</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ClassCleanUp</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; - ClassCleanup&quot;</span>, Demo.Get()));</span><br><span class="line">            Demo.Now += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這裡目標很間單，測試的內容不是重點，而是希望透過輸出來看到執行的順序</p>
<div class="note info">
            <p>可能有人會注意到為何有些方法例如ClassCleanup是需要Static，有些又需要帶入TestContext的參數？<br>這其實是規定，如果不按照規則撰寫的話，執行單元測試時就會得到以下錯誤訊息</p>
          </div>
<p><img src="https://2.bp.blogspot.com/-D28yVaI4mMo/WP1rM1wtoKI/AAAAAAAAIM4/Wa2QHfFy3m41NHYlJm8-NtttcjKt07D6ACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-24%2B%25E4%25B8%258A%25E5%258D%258810.29.04.png"></p>
<p><strong>接著執行單元測試看看輸出，點擊下面的輸出按鈕</strong></p>
<p><img src="https://3.bp.blogspot.com/-PpLe69AriAs/WP1rrh8-ELI/AAAAAAAAINA/Ukg8A3hKfoknWO7IKj5zCsEZ-M306bqhwCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-24%2B%25E4%25B8%258A%25E5%258D%258811.05.30.png"></p>
<p><img src="https://3.bp.blogspot.com/-_v6merhgenM/WP1sBwJRZ7I/AAAAAAAAINI/qS2TUZfSDE8yXnE6wI_mHkE94YrW2ekRwCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-24%2B%25E4%25B8%258A%25E5%258D%258811.07.32.png"></p>
<p>這樣看就很明顯知道順序了！！<br>讓我們加上第二個測試</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GetTest2</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Console.WriteLine(<span class="built_in">string</span>.Format(<span class="string">&quot;&#123;0&#125; - Test2&quot;</span>, Demo.Get()));</span><br><span class="line">            Demo.Now += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>全部測試執行然後看看結果</p>
<p><img src="https://4.bp.blogspot.com/-wm4jDNZ5sEc/WP1s6kv5NNI/AAAAAAAAINU/Df741_DV140IV1YsYfPrtKe-xPuOPNSDACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-24%2B%25E4%25B8%258A%25E5%258D%258811.10.38.png"></p>
<p><img src="https://2.bp.blogspot.com/-lXVB0a3ukHo/WP1tG9-eswI/AAAAAAAAINY/aDrjV6DTRWIBHXlGvYJ-rmhgq7gbU-9kACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-24%2B%25E4%25B8%258A%25E5%258D%258811.11.51.png"></p>
<p><img src="https://3.bp.blogspot.com/-rNUhwY9nnwE/WP1tKQDwjHI/AAAAAAAAINc/DFmtGmn_dMIhsGYfCWOqtfAdCNV4fircgCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-24%2B%25E4%25B8%258A%25E5%258D%258811.12.06.png"></p>
<p>可以發現<strong>TestInitialize</strong>與<strong>TestCleanUp</strong>是每個測試在執行前/後都會執行一次的，而且要特別強調一下，<span style="color: red; font-weight: bold;">每個單元測試執行的順序是不固定的</span>，所以如果在單元測試中有些初始化的動作，切記不要依賴每個測試之間的順序關係，否則可能會不定時的產生錯誤，請把每個測試都當成是獨立且無相依關係！！</p>
<p>從這個範例也可以看得到一個結論，如果在測試中有用到Production Code中Static的參數或屬性，請記得養成良好習慣，要在CleanUp的方法中恢復它的預設值，否則Static是共用的，如果其他測試有用到同一個Static屬性，而互相改來改去不初始化，就很可能發生單元測試時好時壞的問題，這是切身之痛請勿以身試法ＸＤＤ</p>
]]></content>
      <categories>
        <category>學習單元測試</category>
      </categories>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】Day 7 - Assert</title>
    <url>/2017/04/25/%E3%80%90Unit-Test%E3%80%91Day-7-Assert/</url>
    <content><![CDATA[<div class="note info">
            <p>Demo檔案 : <a href="https://github.com/toyo0103/UnitTest_Day7">Git傳送門</a></p>
          </div>
<p>今天要來談談驗證，還記得之前的PTX範例都只驗證名稱嗎？</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//assert</span></span><br><span class="line">   Assert.AreEqual(actual.Name, expected);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>因為有說如果是參考型別的話，Assert.AreEqual可能會驗證失敗</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> 透過Assert驗證參考型別()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            Guid ID = Guid.NewGuid();</span><br><span class="line">            <span class="keyword">var</span> expected = <span class="keyword">new</span> Member</span><br><span class="line">            &#123;</span><br><span class="line">                ID = ID,</span><br><span class="line">                Name = <span class="string">&quot;Name&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = <span class="keyword">new</span> Member</span><br><span class="line">            &#123;</span><br><span class="line">                ID = ID,</span><br><span class="line">                Name = <span class="string">&quot;Name&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(expected,actual);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>結果 </p>
<p><img src="https://2.bp.blogspot.com/-8fAoTQY1vvc/WP6tmPHut6I/AAAAAAAAINs/ndANX4zMz30h6IlZV0MP4xjltHadHZ-7gCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-25%2B%25E4%25B8%258A%25E5%258D%25889.59.30.png"></p>
<p>試試看改一下寫法</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> 透過Assert驗證參考型別<span class="number">2</span>()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            Guid ID = Guid.NewGuid();</span><br><span class="line">            <span class="keyword">var</span> expected = <span class="keyword">new</span> Member</span><br><span class="line">            &#123;</span><br><span class="line">                ID = ID,</span><br><span class="line">                Name = <span class="string">&quot;Name&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = expected;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(expected, actual);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://3.bp.blogspot.com/-b5RzbbKJujg/WP6uXB1tHdI/AAAAAAAAIN0/_8LddyllasU-Ztc1Ims04uiExvBgeHetgCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-25%2B%25E4%25B8%258A%25E5%258D%258810.02.51.png"></p>
<p>原來Assert.AreEqual當碰到參考型別的時候是驗證記憶體位置，但其實像我是寫商業邏輯的，常常在乎的是透過方法執行完後得到的DTO（Data Transfer Object）是否符合預期，這樣其實Assert對我來說不是那麼方便。</p>
<div class="note info">
            <p>MSDN: <a href="https://msdn.microsoft.com/zh-tw/library/microsoft.visualstudio.testtools.unittesting.assert.aspx">Assert 類別</a></p>
          </div>
<p>如果我真的只想驗證執行完的DTO內容是否符合預期，該怎麼做呢？<strong>來看看<a href="http://fluentassertions.com/documentation.html">FluentAssertions</a>吧</strong></p>
<p><img src="https://2.bp.blogspot.com/-FlJIcwQ1rxg/WP67GWbFDUI/AAAAAAAAIOQ/IDGl70pgSzgDDoNcOPPmlGT0fTXU_JPawCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-25%2B%25E4%25B8%258A%25E5%258D%258810.57.08.png"></p>
<p>在單元測試專案用Nuget安裝完成後，來看看範例寫法</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> 透過FluentAssertions驗證參考型別()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            Guid ID = Guid.NewGuid();</span><br><span class="line">            <span class="keyword">var</span> expected = <span class="keyword">new</span> Member</span><br><span class="line">            &#123;</span><br><span class="line">                ID = ID,</span><br><span class="line">                Name = <span class="string">&quot;Name&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = <span class="keyword">new</span> Member</span><br><span class="line">            &#123;</span><br><span class="line">                ID = ID,</span><br><span class="line">                Name = <span class="string">&quot;Name&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            actual.ShouldBeEquivalentTo(expected);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>就這麼簡單，它就會幫你驗證內容的值而不是記憶體位置，而且可讀性也很高，再舉幾個範例</p>
<p><strong>是否為Null</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> 透過FluentAssertions驗證不為Null()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = <span class="keyword">new</span> Member</span><br><span class="line">            &#123;</span><br><span class="line">                ID = Guid.NewGuid(),</span><br><span class="line">                Name = <span class="string">&quot;Name&quot;</span></span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            actual.Should().NotBeNull();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> 透過FluentAssertions驗證為Null()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            Member actual = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            actual.Should().BeNull();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>**</p>
<hr>
<p>**<br><strong>驗證數字</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> 透過FluentAssertions驗證數字()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="built_in">int</span> actual = <span class="number">123</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            actual.Should().Be(<span class="number">123</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>驗證趨近於</strong><br>倍精準相加時會有些微誤差</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> 透過FluentAssertions驗證趨近於()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> a = <span class="number">1.3</span>;</span><br><span class="line">            <span class="keyword">var</span> b = <span class="number">0.1</span>;</span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="built_in">double</span> actual = a + b ;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            actual.Should().Be(<span class="number">1.4</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://3.bp.blogspot.com/-BrAxR_LWsk8/WP7A2lLy8DI/AAAAAAAAIOg/psK_O4jn2loxOGfX-u0Gf1KNMWL-NGHIgCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-25%2B%25E4%25B8%258A%25E5%258D%258811.20.45.png"></p>
<p>驗證地方可改成</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//assert</span></span><br><span class="line"><span class="comment">//趨近於1.4 且如果誤差小於0.00001時視為一樣</span></span><br><span class="line">actual.Should().BeApproximately(<span class="number">1.4</span>,<span class="number">0.00001</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>驗證排序</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> 透過FluentAssertions驗證升冪排序()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> parameter = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt; &#123; <span class="number">4</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">8</span> &#125;;</span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = parameter.OrderBy(x=&gt;x);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            actual.Should().BeInAscendingOrder();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> 透過FluentAssertions驗證降冪排序()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> parameter = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt; &#123; <span class="number">4</span>, <span class="number">7</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="number">8</span> &#125;;</span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = parameter.OrderByDescending(x =&gt; x);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            actual.Should().BeInDescendingOrder();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>結論</strong><br>FluentAssertions是個閱讀性高且豐富的驗證套件，以上提供一些我常常使用到的斷言方法，還有很多可以參考官網文件，那今天就先到這了！！</p>
]]></content>
      <categories>
        <category>學習單元測試</category>
      </categories>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】Day 5 - 透過InternalsVisibleTo來達成單元測試的外部注入</title>
    <url>/2017/04/21/%E3%80%90Unit-Test%E3%80%91Day-5-%E9%80%8F%E9%81%8EInternalsVisibleTo%E4%BE%86%E9%81%94%E6%88%90%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6%E7%9A%84%E5%A4%96%E9%83%A8%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<div class="note info">
            <p>Demo檔案 : <a href="https://github.com/toyo0103/UnitTest_Day3/tree/UnitTest_Day5">Git傳送門</a><br>請參照UnitTest_Day5的Branch</p>
          </div>
<p>延續昨日的進度，我們將呼叫API的RestSharp獨立出來，並且用依賴介面及外部注入的方式將IRestSharp注入到PTX來達成隔離，並且做到可測試性。</p>
<p><img src="https://2.bp.blogspot.com/-HjInxsBTGiI/WPmXSYDpTRI/AAAAAAAAIKw/KgSB2yeC2T48twP-CxCExImX9ijhXqHxwCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-21%2B%25E4%25B8%258B%25E5%258D%25881.23.02.png"></p>
<p>但面臨令一個問題，如果今天開發的是共用套件類的專案，這樣變成要使用物件都必須知道該用什麼東西注入才可使用，這往往會造成使用者困擾，封裝性也不佳，因外部注入的IRestSharp是每個人都可以另外實作的。 甚至更深一層去想，究竟IRestSharp是否需要用Public讓外部使用者都知道有這個東西呢？ 是不是反而因為要達到可測試性而讓封裝這件事做得更差？</p>
<p><strong>來看看另一種方式</strong></p>
<p>假設我認為使用這個套件的人只要簡單的建立PTX後即可使用，至於內部如何呼叫API的實作使用者並不需要關心，那麼我們先將IRestSharp從建構子拿掉吧，並且做一個專門產生IRestSharp實體的Factory來滿足需求。</p>
<p>撰寫IRestSharpFactory<br><img src="https://4.bp.blogspot.com/-8W6FoK7MRiA/WPmcVCDx-VI/AAAAAAAAILA/qpjugEjgNw06nPLvv6RqLB28XqGRWW78ACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-21%2B%25E4%25B8%258B%25E5%258D%25881.32.57.png"></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 製作IRestSharp的工廠</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">IRestSharpFactory</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//這邊特別注意存取修飾子是用Internal</span></span><br><span class="line">        <span class="comment">//原因是我並不希望專案之外的人使用且知道有這東西</span></span><br><span class="line">        <span class="comment">//而internal剛好能滿足這需求</span></span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> IRestSharp <span class="title">Generate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//產生實體</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MyRestSharp();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接著修改原本的PTX.cs</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PTX</span></span><br><span class="line">    &#123;</span><br><span class="line">        IRestSharp _MyRestSharp</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">get</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//這邊改成用工廠建立MyRestSharp實體</span></span><br><span class="line">                <span class="keyword">return</span> IRestSharpFactory.Generate();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Construct</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">PTX</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//建構子參數移除</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        以下省略.....</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這邊馬上面臨到一個問題，那我們怎麼Mock IRestSharp，昨天是放在建構子中並透過Nsubstitute來Mock</p>
<p><img src="https://1.bp.blogspot.com/-gPv3l1uHmls/WPmehkxafVI/AAAAAAAAILQ/iR_X30LEPAcPwhxGNHDSUrjTx_AGPJ7rQCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-21%2B%25E4%25B8%258B%25E5%258D%25881.53.09.png"></p>
<p>封裝性變好了，但也變得難以介入模擬外部行為</p>
<p><strong>從IRestSharpFactory著手吧！！</strong></p>
<div class="note info">
            <p>想辦法讓<strong>IRestSharpFactory</strong>可以讓我們注入Mock的假物件</p>
          </div>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 製作IRestSharp的工廠</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">IRestSharpFactory</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 此屬性只供UnitTest注入</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">internal</span> <span class="keyword">static</span> IRestSharp _IRestSharpForUnitTest;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">internal</span> <span class="keyword">static</span> IRestSharp <span class="title">Generate</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//如果這個值不為Null,則表示單元測試所注入,直接回傳</span></span><br><span class="line">            <span class="keyword">if</span> (_IRestSharpForUnitTest != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> _IRestSharpForUnitTest;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//產生實體</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> MyRestSharp();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這邊開了一個_IRestSharpForUnitTest屬性，讓外部能夠注入它，接著在Generate的方法中判斷，如果當_IRestSharpForUnitTest不為Null時，直接回傳（通常會特別在這個屬性寫上說明僅供單元測試使用，正常Production Code禁止使用！！）</p>
<p><strong>想辦法在單元測試中注入_IRestSharpForUnitTest</strong><br>你可能會發現在單元測試中看不到IRestSharpFactory….</p>
<p><img src="https://1.bp.blogspot.com/-432-uYA3xzA/WPmi7ubMQPI/AAAAAAAAILc/lRWIC9z0Rl4J-gDK4S3FqFH-IFAOb4dMQCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-21%2B%25E4%25B8%258B%25E5%258D%25882.12.43.png"></p>
<p>原因是我們宣告成Internal，如果要能在專案之外看到就只能開成Public了，但回到最一開始討論的，不就是為了封裝才把他宣告成Internal嗎？如果又改回Public那我們這段工不就白費了，還好還有別的方法可以達成。</p>
<p><strong>告訴UnitTestDay3這個專案，除了它自己之外，還有誰能看到它宣告成Internal的類別與屬性方法</strong><br>**<br><strong>讓我們先打開</strong>UnitTestDay3**專案的AssemblyInfo</p>
<p><img src="https://4.bp.blogspot.com/-xJUoNFOIdrs/WPmkLQsBL2I/AAAAAAAAILk/ZZ0cCPNog9QCsdYvinuDtv5sdIQmojNJQCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-21%2B%25E4%25B8%258B%25E5%258D%25882.17.36.png"></p>
<p>寫下這行</p>
<p><img src="https://1.bp.blogspot.com/-IZGTMVt3-Lo/WPmkhpuNB7I/AAAAAAAAILo/uiMhb0tvoP8qSxl8ql46g_fS4VsrTxBRACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-21%2B%25E4%25B8%258B%25E5%258D%25882.19.05.png"></p>
<p>InternalsVisibleTo這邊是要填AssemblyName，透過這個Attribute告訴<strong>UnitTestDay3</strong>這個專案還有誰能看到它內部的Internal。<br>而AssemblyName怎麼看呢？在專案上右鍵 &gt; 屬性</p>
<p><img src="https://4.bp.blogspot.com/-HfxlXJV0Eqw/WPml-pvikQI/AAAAAAAAIL0/VeJoBU8c2XEOV2StCNpE-njJpvnWsE6nQCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-21%2B%25E4%25B8%258B%25E5%258D%25882.25.13.png"></p>
<p><img src="https://3.bp.blogspot.com/-8jsc7ogPU80/WPmmNjXGWVI/AAAAAAAAIL4/pKT3iPG1rIYC5c4-5yLrzjrACSJzaxeJQCLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-21%2B%25E4%25B8%258B%25E5%258D%25882.26.18.png"></p>
<p>如果你有很多單元測試專案需要能看到，InternalsVisibleTo是可以很多組的。</p>
<p>接著在單元測試中就可以看到啦</p>
<p><img src="https://1.bp.blogspot.com/-FJOWCQNSfqE/WPmnDZpn4dI/AAAAAAAAIMA/OnLezxrmtFcC-FrJT-E3FO1gyQlcgbNnACLcB/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2017-04-21%2B%25E4%25B8%258B%25E5%258D%25882.29.57.png"></p>
<p>這樣就達成我們想封裝起來的需求，卻也能讓單元測試進行注入，那今天就談到這吧！！</p>
]]></content>
      <categories>
        <category>學習單元測試</category>
      </categories>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】Fake System.DateTime</title>
    <url>/2016/10/17/%E3%80%90Unit-Test%E3%80%91Fake-System-DateTime/</url>
    <content><![CDATA[<p>在寫程式的時後，常常會用到DateTime.Now來判斷目前時間，依照時間邏輯去撈取不同的資料，但碰到單元測試要驗證的時候就是個大麻煩，因為DateTime.Now每次執行的時候時間都會改變，所以以前的做法都是這樣</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">SystemTime</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">//Internal For UnitTest</span></span><br><span class="line"> <span class="keyword">internal</span> <span class="keyword">static</span> Func&lt;DateTime&gt; SetCurrentTime = () =&gt; DateTime.Now;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> DateTime Now</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">get</span></span><br><span class="line">  &#123;</span><br><span class="line">   <span class="keyword">return</span> SetCurrentTime();</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然後在在程式碼裡面使用的時候不直接使用DateTime.Now，改用SystemTime.Now</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (SystemTime.Now == <span class="keyword">new</span> DateTime(<span class="number">2016</span>,<span class="number">10</span>,<span class="number">17</span>,<span class="number">12</span>,<span class="number">0</span>,<span class="number">0</span>))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="string">&quot;時間到了&quot;</span>.Dump();</span><br><span class="line"> &#125; </span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> &#123;</span><br><span class="line">  <span class="string">&quot;時間不對&quot;</span>.Dump();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之後單元測試驗證時，動態去改寫SetCurrentTime，就能確保拿到自己要的時間 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">SystemTime.SetCurrentTime = () =&gt; <span class="keyword">new</span> DateTime(<span class="number">2016</span>,<span class="number">10</span>,<span class="number">17</span>,<span class="number">12</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>雖然這樣可以解決問題沒錯，但實在太麻煩，為了單元測試要多寫一堆Code之外，System底下很多東西有用到時，都要因為可以單元測試的關係而擴充出來。</p>
<p>還好之後有找到方法可以針對DLL做Fake，讓我們可以繼續安心使用DateTime.Now之餘，單元測試也能指定時間，接下來就來實作一下這個步驟</p>
<ul>
<li><p>  首先在單元測試的專案對參考的組件System按下右鍵，新增Fake物件</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-2CmHnA1rUMA/WARsswfjOPI/AAAAAAAAIBI/HGzYnnuIOzM6DuGEl8psJIIA4EtBmutgQCLcB/s1600/1.png)](https://4.bp.blogspot.com/-2CmHnA1rUMA/WARsswfjOPI/AAAAAAAAIBI/HGzYnnuIOzM6DuGEl8psJIIA4EtBmutgQCLcB/s1600/1.png)</div></li>
<li><p>  接著就會跑出Fake資料夾</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-QhvjMs19Dr4/WARtB33gWvI/AAAAAAAAIBM/ptqbpm0CKTgbi5C8CWZY3DjWbmykiJa4gCLcB/s1600/1.png)](https://3.bp.blogspot.com/-QhvjMs19Dr4/WARtB33gWvI/AAAAAAAAIBM/ptqbpm0CKTgbi5C8CWZY3DjWbmykiJa4gCLcB/s1600/1.png)</div></li>
<li><p>接著只要在單元測試的地方寫如此寫，就能設定DateTime.Now應該回傳的時間了```csharp<br>[TestMethod]</p>
<pre><code>  public void 取得現在時間()
  &#123;
      using (ShimsContext.Create())
      &#123;
          System.Fakes.ShimDateTime.NowGet= () =&gt;
          &#123;
              return new DateTime(2016, 9, 25);
          &#125;;

           //arrange
          var expected = new DateTime(2016, 9, 25);

          //act
          var actual = DateTime.Now;

          //assert
          Assert.AreEqual(expected, actual);
      &#125;
  &#125;
</code></pre>
</li>
</ul>
<p>```</p>
<h3 id="補充2017-01-24"><a href="#補充2017-01-24" class="headerlink" title="補充2017/01/24"></a><span style="color: red;">補充2017/01/24</span></h3><p>單元測試Fake的功能，以Visual Studio 2015來說只有Enterprise版本才有支援，所以使用的時候請特別小心，像今天公司因為授權費的關係，要求調降成Professional，之前有用到Fake的地方就都測不過了，還請特別注意</p>
<p>各版本比較 : <a href="https://www.visualstudio.com/vs/compare/">Compare Visual Studio 2015 Offerings</a></p>
<h3 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a>參考文章</h3><div>[Huan-Lin - Microsoft Fakes 入門](http://huan-lin.blogspot.com/2012/10/microsoft-fakes.html)</div>]]></content>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】重構 (一) 透過繼承解耦</title>
    <url>/2016/03/02/%E3%80%90Unit-Test%E3%80%91%E9%87%8D%E6%A7%8B-%E4%B8%80-%E9%80%8F%E9%81%8E%E7%B9%BC%E6%89%BF%E8%A7%A3%E8%80%A6/</url>
    <content><![CDATA[<p>將一個本來沒有單元測試的專案，改成能測試的狀態，通常第一個遇到的問題就是耦合太深，導致無法切開來模擬外部對象，大幅度改動又可能牽扯很多Method與Class，在沒有測試保護下，怕改到壞掉而不自知。</p>
<div>
</div><div>以下記錄第一種重構方式，讓測試能在安全的重構之下進行</div><div>
</div><div>範例Code:</div><div>原本的Legacy Code&nbsp;</div>```csharp
public class UnitTestSampleBase
    {
        public UnitTestSampleBase() { }

<pre><code>    public int WantUnitTestMethod()
    &#123;
        //直接引用,導致無法隔離測試
        ThirdPartyObject tpObj = new ThirdPartyObject();

        int value =  tpObj.GetValue();

        return value + 1;
    &#125;
&#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">1.  分離耦合的部分</span><br><span class="line"></span><br><span class="line">    &#96;&#96;&#96;csharp</span><br><span class="line">public class UnitTestSampleBase</span><br><span class="line">    &#123;</span><br><span class="line">        public UnitTestSampleBase() &#123; &#125;</span><br><span class="line"></span><br><span class="line">            protected virtual int GetValue()</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;開一個virtual的Method，將外部引用隔離出來</span><br><span class="line">            ThirdPartyObject tpobj &#x3D; new ThirdPartyObject();</span><br><span class="line">            return tpobj.GetValue();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            public int WantUnitTestMethod()</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;避免直接引用</span><br><span class="line">            int value &#x3D; GetValue();</span><br><span class="line"></span><br><span class="line">                return value + 1;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ol start="2">
<li>做一個Fake的受測對象，並繼承受測得目標，並改寫取得外部資源的結果的Method,讓它回傳我們寫死的固定值 ```csharp<br>public class UnitTestSampleFake : UnitTestSampleBase<br> {<pre><code> protected override int GetValue()
 &#123;
     return 1;
 &#125;
</code></pre>
 }</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">3.  進行測試 &#96;&#96;&#96;csharp</span><br><span class="line">[TestClass]</span><br><span class="line">    public class UnitTestSampleFakeTest</span><br><span class="line">    &#123;</span><br><span class="line">        [TestMethod]</span><br><span class="line">        public void WantUnitTestMethod_Call_ShouldRetuen2()</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F;arrange</span><br><span class="line">            var sut &#x3D; new UnitTestSampleFake();</span><br><span class="line">            &#x2F;&#x2F;act</span><br><span class="line">            var actual &#x3D; sut.WantUnitTestMethod();</span><br><span class="line">            &#x2F;&#x2F;assert</span><br><span class="line">            &#x2F;&#x2F;1+1 &#x3D; 2</span><br><span class="line">            Assert.AreEqual(actual, 2);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="4">
<li> 測試通過<br><a href="https://2.bp.blogspot.com/-uYkKOQtjTGM/VtaZbA1HanI/AAAAAAAAHtw/o2uLfutn6XU/s1600/1.png"><img src="https://2.bp.blogspot.com/-uYkKOQtjTGM/VtaZbA1HanI/AAAAAAAAHtw/o2uLfutn6XU/s320/1.png"></a></li>
</ol>
<p>這樣對於外部使用你的Mthod的人來說，他Code都不用改(因為你還是保有原本的Method<br><strong>WantUnitTestMethod</strong>，且不需要額外的外部注入或參數注入)，但你的Code已經做了初步的分離跟測試，之後就可以慢慢在這個測試保護的基礎之上，繼續後續的開發了!!</p>
]]></content>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】Fake DLL發生does not exist in the namespace &#39;System.Diagnostics.Tracing&#39;</title>
    <url>/2016/10/17/%E3%80%90Unit-Test%E3%80%91Fake-DLL%E7%99%BC%E7%94%9Fdoes-not-exist-in-the-namespace-System-Diagnostics-Tracing/</url>
    <content><![CDATA[<p>上一篇<a href="http://toyo0103.blogspot.tw/2016/10/unittestfake-systemdatetime.html">【Unit Test】Fake System.DateTime</a>&nbsp;寫到如何Fake DLL，在本機建置與進行測試都沒問題，唯獨放到CICD機器去做自動化部屬時，一直鬼擋牆的跳建置方案錯誤，錯誤內容如下</p>
<p><span style="background-color: white; font-family: &quot;Segoe UI&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, Verdana;">The type or namespace name ‘EventSourceCreatedEventArgs’ does not exist in the namespace ‘System.Diagnostics.Tracing’ (are you missing an assembly reference?)&nbsp;</span><br><span style="background-color: white; font-family: &quot;Segoe UI&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, Verdana;"><br></span>上網查了一下找到以下解法</p>
<ul>
<li>打開mscorlib.fakes，改成以下內容```csharp<Fakes xmlns="http://schemas.microsoft.com/fakes/2011/">
<Assembly Name="mscorlib" Version="4.0.0.0"/>
<StubGeneration>
  <Remove FullName="System.Diagnostics.Tracing"/>
  <Remove FullName="System.Text.Encoding"/>
  <Remove FullName="System.Security.Cryptography" />
</StubGeneration>
</Fakes></li>
</ul>
<p>```</p>
<p>自動化佈署機器這樣去建置佈署就過關了!!!!</p>
]]></content>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】重構 (二) 單元測試的可讀性</title>
    <url>/2016/03/07/%E3%80%90Unit-Test%E3%80%91%E9%87%8D%E6%A7%8B-%E4%BA%8C-%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6%E7%9A%84%E5%8F%AF%E8%AE%80%E6%80%A7/</url>
    <content><![CDATA[<ol>
<li><p><span style="color: #073763; font-weight: normal;">方法命名 &nbsp;: &nbsp;受測的方法名稱Test_動作_預期結果</span><br><span style="font-weight: normal;"><span style="font-weight: normal;"><br></span></span><span style="font-weight: normal;"><span style="font-weight: normal;">這樣可以看標題名稱，馬上就能大略的明白此單元測試的受測者與目標是什麼，對於之後如果改版發生單元錯誤時，也才能明白該如何修復</span></span></p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-CaS4BNBA6a4/VtzcFkfagkI/AAAAAAAAHuQ/2mAf5riuHfk/s1600/1.png)](https://3.bp.blogspot.com/-CaS4BNBA6a4/VtzcFkfagkI/AAAAAAAAHuQ/2mAf5riuHfk/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">錯誤寫法&nbsp;</td></tr></tbody></table><span style="font-weight: normal;">
&nbsp;哪天因為改版造成這個單元測試錯誤了，要修復時非得看完全部的Code才能明白何謂"正確的狀況"，對於維護來說是不利的</span>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-B7ro_7k5cAo/VtzauPAEglI/AAAAAAAAHuE/KnntqnWuvpQ/s640/1.png)](https://2.bp.blogspot.com/-B7ro_7k5cAo/VtzauPAEglI/AAAAAAAAHuE/KnntqnWuvpQ/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">建議寫法</td></tr></tbody></table></li>
<li><p><span style="color: #073763; font-weight: normal;">共用的參數應該有個父類別來管理</span><br>有時候我們會為了測試某些情境，對於public static的東西進行設定，但也因為這是public static的變數，為了避免與其它單元測試交互影響，所以我們會在TestCleanUp的方法中做清除的動作</p>
 <div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-t9BldDR6eJU/VtzepBta3lI/AAAAAAAAHug/Uv5g94SdikU/s640/1.png)](https://1.bp.blogspot.com/-t9BldDR6eJU/VtzepBta3lI/AAAAAAAAHug/Uv5g94SdikU/s1600/1.png)</div>

<p> 但這種寫法如果散落在各個單元測試的Class之中，對於維護也是一大挑戰，所以建議建立一個TestBase之類的父類別，讓所有單元測試的類別繼承它，並統一管理。<br>總結，單元測試是為了讓程式更有品質，且在一些保護的基礎上進行改版，但如果單元測試的撰寫沒有一些有效的管理，對於後續的維護成本可能會比沒單元測試來的更高更難維護，如果單元測試寫的不清不楚，誰會知道這個測試到底要保護什麼呢?</p>
</li>
</ol>
]]></content>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】針對Repository做單元測試 (一)</title>
    <url>/2016/07/29/%E3%80%90Unit-Test%E3%80%91%E9%87%9D%E5%B0%8DRepository%E5%81%9A%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6-%E4%B8%80/</url>
    <content><![CDATA[<p><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">大部分的專案都會需要跟資料庫溝通，存取資料。雖然說開發的時候往往都有測試資料庫，但測試機料庫也可能因為很多人都在開發存取，導致資料可能會時常受到異動。</span><br><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br></span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">單元測試的一大重點就是不管任何人、時、地，都要能測試成功，如果今天用來測試的資料庫可能面臨資料在不確定何時何人會異動的情境下，這可能會讓我們的單元測試雖然邏輯正確，但最後驗證失敗。</span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">例如:原本預期A會員權限有效，但因為測試資料庫別人也在使用開發，所以被改成失效，這時候你如果去跑單元測試就會亮起紅燈失敗，直到你去查了後才發現原來是源頭資料被改動了。</span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">為了解決這樣的問題，我們最好能創造一個資料庫只給單元測試使用，且能跟著專案走的(不然別人從Git把專案抓下來，沒有資料庫的情況下單元測試全掛掉…..這該如何是好)，所以LocalDB就是一個很好的選擇。</span><br><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br></span><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">第一篇就紀錄一下我如何建立LocalDB、並準備測試資料，這邊大部分都參考</span><br><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><a href="http://kevintsengtw.blogspot.tw/2015/06/localdb-entity-framework.html">MRKT大師 : 測試專案使用 LocalDB - 使用 Entity Framework 的情境</a>&nbsp;</span><br><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><a href="http://kevintsengtw.blogspot.tw/2015/10/dapper-linqpad-sql-command.html">MRKT大師 :&nbsp;Dapper - 使用 LINQPad 快速產生相對映 SQL Command 查詢結果的類別</a><br>，以及一些公司同事提供的方便小工具，非自己原創XD</span><br><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br></span></p>
<h3 id="第一步、建立專案來擺放LocalDB"><a href="#第一步、建立專案來擺放LocalDB" class="headerlink" title="第一步、建立專案來擺放LocalDB"></a>第一步、建立專案來擺放LocalDB</h3><p>建立一般的Library Project</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-QN2Lgo0WWLM/V5nWU8uV4rI/AAAAAAAAHwg/AjshLUxypfUm3whgktw12ZXq7ApXm3FGgCLcB/s640/1.png)](https://4.bp.blogspot.com/-QN2Lgo0WWLM/V5nWU8uV4rI/AAAAAAAAHwg/AjshLUxypfUm3whgktw12ZXq7ApXm3FGgCLcB/s1600/1.png)</div>

<p>接下在專案底下新增LocalDB</p>
<div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-8T2Ln5dZrpo/V5nWwfdpzFI/AAAAAAAAHwk/vk4Ujt5NUeMltYoBoSBlZnMSmv-HD27twCLcB/s640/1.png)](https://2.bp.blogspot.com/-8T2Ln5dZrpo/V5nWwfdpzFI/AAAAAAAAHwk/vk4Ujt5NUeMltYoBoSBlZnMSmv-HD27twCLcB/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-sfnO0MbA31s/V5rEVI9uucI/AAAAAAAAHw4/dHkcoCnpGTc_4O7I_BY0NKphzT2uP03vACLcB/s1600/1.png)](https://4.bp.blogspot.com/-sfnO0MbA31s/V5rEVI9uucI/AAAAAAAAHw4/dHkcoCnpGTc_4O7I_BY0NKphzT2uP03vACLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">
</div>

<h3 id="第二步、幫LocalDB建立Schema-已NorthWind資料庫為例"><a href="#第二步、幫LocalDB建立Schema-已NorthWind資料庫為例" class="headerlink" title="第二步、幫LocalDB建立Schema (已NorthWind資料庫為例)"></a>第二步、幫LocalDB建立Schema (已NorthWind資料庫為例)</h3><div>基本上SSMS操作差不多，在資料表右鍵 &gt; 新增查詢，然後把Create Employees Table的Script貼過去執行</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-5ji6J1LhAWQ/V5rJYfKcExI/AAAAAAAAHxI/IFxpZPmJ5skP5CFyB11VLs-iKe0DLSnLACLcB/s1600/1.png)](https://2.bp.blogspot.com/-5ji6J1LhAWQ/V5rJYfKcExI/AAAAAAAAHxI/IFxpZPmJ5skP5CFyB11VLs-iKe0DLSnLACLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-nqLVzU-QAqQ/V5rJolPPJII/AAAAAAAAHxM/Z99R12JALYgIIAq12h6mZGB4JdVBQl0HQCLcB/s640/1.png)](https://3.bp.blogspot.com/-nqLVzU-QAqQ/V5rJolPPJII/AAAAAAAAHxM/Z99R12JALYgIIAq12h6mZGB4JdVBQl0HQCLcB/s1600/1.png)</div><div>
</div><div>

<h3 id="第三步、準備測試資料"><a href="#第三步、準備測試資料" class="headerlink" title="第三步、準備測試資料"></a>第三步、準備測試資料</h3></div><div>因為每個測試之間應該都是獨立的，為了避免互相干擾，所以資料通常不會預先倒到LocalDB裡面去，而是在執行每次測試時，動態的將準備好的資料寫進去，每個測試完畢後砍掉資料，這樣不停的重複著。</div><div>
</div><div>而一個Table的資料可能會很多很多，如果用手寫成SQL Script應該寫完專案DeadLine也過了，</div><div>所以這邊打算將資料匯出到CSV檔案中，然後透過CSVHelper讀出來倒進DB，做法如下:</div><div>
</div><div>已下搭配LinqPad使用</div><div>
</div><div>
</div>```csharp


void Main()
{
 // 這邊修改為你要執行的 SQL Command
 var sqlCommand = @"select top 1 * from Employees";

 // 第一個參數填入 SQL Command, 第二個參數輸入要產生的 Class 名稱
 this.Connection.DumpClass(sql: sqlCommand.ToString(), className: "Employees").Dump();
}

public static class LINQPadExtensions
{
 private static readonly Dictionary<Type, string> TypeAliases = new Dictionary<Type, string>
 {
  { typeof(int), "int" },
  { typeof(short), "short" },
  { typeof(byte), "byte" },
  { typeof(byte[]), "byte[]" },
  { typeof(long), "long" },
  { typeof(double), "double" },
  { typeof(decimal), "decimal" },
  { typeof(float), "float" },
  { typeof(bool), "bool" },
  { typeof(string), "string" }
 };

 private static readonly HashSet<Type> NullableTypes = new HashSet<Type>
 {
  typeof(int),
  typeof(short),
  typeof(long),
  typeof(double),
  typeof(decimal),
  typeof(float),
  typeof(bool),
  typeof(DateTime)
 };

 public static string DumpClass(this IDbConnection connection, string sql, string className = "Info")
 {
  if (connection.State != ConnectionState.Open)
  {
   connection.Open();
  }

  var cmd = connection.CreateCommand();
  cmd.CommandText = sql;
  var reader = cmd.ExecuteReader();

  var builder = new StringBuilder();
  do
  {
   if (reader.FieldCount <= 1) continue;

   builder.AppendFormat("public class {0}{1}", className, Environment.NewLine);
   builder.AppendLine("{");
   var schema = reader.GetSchemaTable();

   foreach (DataRow row in schema.Rows)
   {
    var type = (Type)row["DataType"];
    var name = TypeAliases.ContainsKey(type) ? TypeAliases[type] : type.Name;
    var isNullable = (bool)row["AllowDBNull"] && NullableTypes.Contains(type);
    var collumnName = (string)row["ColumnName"];

    builder.AppendLine(string.Format("\tpublic {0}{1} {2} {{ get; set; }}", name, isNullable ? "?" : string.Empty, collumnName));
    builder.AppendLine();
   }

   builder.AppendLine("}");
   builder.AppendLine();
  }
  while (reader.NextResult());

  return builder.ToString();
 }
}



<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">這支程式的目的是先做出符合Employees對應的Class，方便支後匯出跟匯入資料，執行後應該會看到產出的Class文字檔</span><br><span class="line">&lt;div class&#x3D;&quot;separator&quot; style&#x3D;&quot;clear: both; text-align: center;&quot;&gt;[![](https:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-lnj9t366iQ4&#x2F;V5rM--fHASI&#x2F;AAAAAAAAHxc&#x2F;fb_na4MSXXgUZTpXFxaxy65YfjGEWs5lgCLcB&#x2F;s640&#x2F;1.png)](https:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-lnj9t366iQ4&#x2F;V5rM--fHASI&#x2F;AAAAAAAAHxc&#x2F;fb_na4MSXXgUZTpXFxaxy65YfjGEWs5lgCLcB&#x2F;s1600&#x2F;1.png)&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">接著用第一支程式產出的Class貼到第二支程式底下</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;csharp</span><br><span class="line">void Main()</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;修改匯出CSV資料存放的位置</span><br><span class="line"> using (var sw &#x3D; new StreamWriter(@&quot;D:\Employees.csv&quot;))</span><br><span class="line"> using (var writer &#x3D; new CsvWriter(sw))</span><br><span class="line"> &#123;</span><br><span class="line">  var result &#x3D; new List&lt;Employees&gt;();</span><br><span class="line">  var connectionString &#x3D; this.Connection.ConnectionString;</span><br><span class="line"></span><br><span class="line">  using (var conn &#x3D; new SqlConnection(connectionString))</span><br><span class="line">  &#123;</span><br><span class="line">   conn.Open();</span><br><span class="line"></span><br><span class="line">   var sqlCommand &#x3D; new StringBuilder();</span><br><span class="line">   &#x2F;&#x2F;要匯出哪些資料的SQL SCript</span><br><span class="line">   sqlCommand.AppendLine(@&quot;select top 10 * from Employees&quot;);</span><br><span class="line">   result &#x3D; conn.Query&lt;Employees&gt;(sqlCommand.ToString())</span><br><span class="line">       .ToList();</span><br><span class="line">  &#125;</span><br><span class="line">  writer.WriteRecords(result);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;將第一支程式產出的Class貼在這邊!!!</span><br><span class="line"></span><br><span class="line">public class Employees</span><br><span class="line">&#123;</span><br><span class="line"> public int EmployeeID &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string LastName &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string FirstName &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string Title &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string TitleOfCourtesy &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public DateTime? BirthDate &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public DateTime? HireDate &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string Address &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string City &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string Region &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string PostalCode &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string Country &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string HomePhone &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string Extension &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public byte[] Photo &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string Notes &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public int? ReportsTo &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line"> public string PhotoPath &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>執行之後，依照你寫的路徑去找到產出的CSV檔，並把他貼到測試專案之中</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-UxqEWgpQ1Z8/V5rQF-UsS7I/AAAAAAAAHxo/UM-O8j-1vqg4RoZOaC266QtsGuVB742IACLcB/s1600/1.png)](https://3.bp.blogspot.com/-UxqEWgpQ1Z8/V5rQF-UsS7I/AAAAAAAAHxo/UM-O8j-1vqg4RoZOaC266QtsGuVB742IACLcB/s1600/1.png)</div>
將檔案屬性改成如下
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-5JmcyzIAZrY/V5rQUsVtfsI/AAAAAAAAHxs/Hzn8l6q895IZQ-qdmNZJjzopfvReaDfSwCLcB/s320/1.png)](https://1.bp.blogspot.com/-5JmcyzIAZrY/V5rQUsVtfsI/AAAAAAAAHxs/Hzn8l6q895IZQ-qdmNZJjzopfvReaDfSwCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: left;">將測試專案參考放LocalDB的Resource專案，基本上基礎的設置就大功告成了</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-J3w_UzNgjqI/V5rQv3jUagI/AAAAAAAAHxw/2ZLjd4ZnFlwKx1k4SWnmR42iD4t2NIgzgCLcB/s320/1.png)](https://2.bp.blogspot.com/-J3w_UzNgjqI/V5rQv3jUagI/AAAAAAAAHxw/2ZLjd4ZnFlwKx1k4SWnmR42iD4t2NIgzgCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-W22EdOO54UQ/V5rQ4alyKlI/AAAAAAAAHx0/0OsWQ0t7roQiwlxBcctsrV8Nnwkb9J1JgCLcB/s640/1.png)](https://2.bp.blogspot.com/-W22EdOO54UQ/V5rQ4alyKlI/AAAAAAAAHx0/0OsWQ0t7roQiwlxBcctsrV8Nnwkb9J1JgCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-0GrZTpNVuYA/V5rRUwzF5EI/AAAAAAAAHx8/EU3rhcWLSFo0HH0UsxyYuEI3czy_nJKWwCLcB/s320/1.png)](https://3.bp.blogspot.com/-0GrZTpNVuYA/V5rRUwzF5EI/AAAAAAAAHx8/EU3rhcWLSFo0HH0UsxyYuEI3czy_nJKWwCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">下一篇接著寫Production Code，並針對那段Code去做測試</div>



]]></content>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【Unit Test】針對Repository做單元測試 (二)</title>
    <url>/2016/07/29/%E3%80%90Unit-Test%E3%80%91%E9%87%9D%E5%B0%8DRepository%E5%81%9A%E5%96%AE%E5%85%83%E6%B8%AC%E8%A9%A6-%E4%BA%8C/</url>
    <content><![CDATA[<p>曾上一篇，開始在我們的Production專案寫一段跟DB要資料的程式吧。(註 : 這邊不考慮分層與物件導向問題，一切專注在單元測試上)</p>
<p>首先先在專案中加入EntityFramework，並把Northwind的Employees Table加進來</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-rgwWYtv-ueQ/V5rwi6Q1TII/AAAAAAAAHyQ/uRS4J_82bxsDX5wZNtqjqoA8hjVtRUjcQCLcB/s640/1.png)](https://4.bp.blogspot.com/-rgwWYtv-ueQ/V5rwi6Q1TII/AAAAAAAAHyQ/uRS4J_82bxsDX5wZNtqjqoA8hjVtRUjcQCLcB/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-yQ-t7YWi-qI/V5rwi006AII/AAAAAAAAHyY/1ftZ1r6NWgQVEmiKy4uhK84XBGa4le3TQCLcB/s1600/2.png)](https://2.bp.blogspot.com/-yQ-t7YWi-qI/V5rwi006AII/AAAAAAAAHyY/1ftZ1r6NWgQVEmiKy4uhK84XBGa4le3TQCLcB/s1600/2.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-eUqI2lewHEY/V5rwi_fRLXI/AAAAAAAAHyU/D-s4l_BrxWE2XOmsvflt-8s-Uo2arn95gCLcB/s640/3.png)](https://2.bp.blogspot.com/-eUqI2lewHEY/V5rwi_fRLXI/AAAAAAAAHyU/D-s4l_BrxWE2XOmsvflt-8s-Uo2arn95gCLcB/s1600/3.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-dbz2xrn6Veo/V5rwjJrehdI/AAAAAAAAHyc/zTVkWvQnVoMUaEVjPiL9TwqtZhTwYxeyQCLcB/s1600/4.png)](https://2.bp.blogspot.com/-dbz2xrn6Veo/V5rwjJrehdI/AAAAAAAAHyc/zTVkWvQnVoMUaEVjPiL9TwqtZhTwYxeyQCLcB/s1600/4.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-gY9k8ego5EE/V5rwjPDRHwI/AAAAAAAAHyg/7ICoznJNU74dBS7VPVp56-He_BOoF6HxwCLcB/s1600/5.png)](https://3.bp.blogspot.com/-gY9k8ego5EE/V5rwjPDRHwI/AAAAAAAAHyg/7ICoznJNU74dBS7VPVp56-He_BOoF6HxwCLcB/s1600/5.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-4HqmVn15BgY/V5rw-Q4Ow3I/AAAAAAAAHyk/kQKue8geuyUfymRmy-mPAhsTIKt_-iPSwCLcB/s1600/6.png)](https://2.bp.blogspot.com/-4HqmVn15BgY/V5rw-Q4Ow3I/AAAAAAAAHyk/kQKue8geuyUfymRmy-mPAhsTIKt_-iPSwCLcB/s1600/6.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-xa7G6erk2fM/V5rxkJIbLSI/AAAAAAAAHys/sTsfBXgEjCAPXHa1C4YXqdZ4VZLEHeSIgCLcB/s1600/1.png)](https://3.bp.blogspot.com/-xa7G6erk2fM/V5rxkJIbLSI/AAAAAAAAHys/sTsfBXgEjCAPXHa1C4YXqdZ4VZLEHeSIgCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">接著寫一段程式，讓我們帶入ID能順利取回該筆員工資料</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-iG0Vl0uUc0I/V5ryyt4eQoI/AAAAAAAAHy8/DsdR1LF6JycomPbTS1zop1NvFhb1C8olwCLcB/s1600/1.png)](https://2.bp.blogspot.com/-iG0Vl0uUc0I/V5ryyt4eQoI/AAAAAAAAHy8/DsdR1LF6JycomPbTS1zop1NvFhb1C8olwCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">
</div>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EmployeesRepository</span> :<span class="title">IDisposable</span></span><br><span class="line">    &#123;</span><br><span class="line">        NorthwindEntities DBContext;</span><br><span class="line">        <span class="built_in">bool</span> disposedValue;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">EmployeesRepository</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            DBContext = <span class="keyword">new</span> NorthwindEntities();</span><br><span class="line">            disposedValue = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Employees <span class="title">Get</span>(<span class="params"><span class="built_in">int</span> id</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> DBContext.Employees.FirstOrDefault(x =&gt; x.EmployeeID == id);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"><span class="built_in">bool</span> disposing</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (!disposedValue)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (DBContext != <span class="literal">null</span>)</span><br><span class="line">                    DBContext.Dispose();</span><br><span class="line"></span><br><span class="line">                disposedValue = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Dispose</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Dispose(disposedValue);</span><br><span class="line">             GC.SuppressFinalize(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>改寫HomeController的Index Action，依據帶入的ID取回員工，並顯示於葉面上</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-nqGw1xVRRX0/V5r20E6fPAI/AAAAAAAAHzc/qRcvr7Lr_Os9IrcMr_1XqYnNJYTxKfVsgCLcB/s640/1.png)](https://3.bp.blogspot.com/-nqGw1xVRRX0/V5r20E6fPAI/AAAAAAAAHzc/qRcvr7Lr_Os9IrcMr_1XqYnNJYTxKfVsgCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div>
View的部分(一切從簡 XDD)
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-Z3oYtUvXjqo/V5r3L10zYiI/AAAAAAAAHzg/RH5ZJQSpyHk5X8NVMhOpk7JA0rJT95nkQCLcB/s640/1.png)](https://4.bp.blogspot.com/-Z3oYtUvXjqo/V5r3L10zYiI/AAAAAAAAHzg/RH5ZJQSpyHk5X8NVMhOpk7JA0rJT95nkQCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div>
來執行看看這段Code有沒有用!!!
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-6bOfbEOFZ_M/V5r3beLjkWI/AAAAAAAAHzo/Q1YmS32wgeMfNPkUeJqFVVQDjRRmu-iKQCLcB/s640/1.png)](https://1.bp.blogspot.com/-6bOfbEOFZ_M/V5r3beLjkWI/AAAAAAAAHzo/Q1YmS32wgeMfNPkUeJqFVVQDjRRmu-iKQCLcB/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-NfsCSeUstAo/V5r3ooighWI/AAAAAAAAHzs/R94VplAsQn8XeC3QaeL9euzBNLf8NvPjACLcB/s1600/1.png)](https://3.bp.blogspot.com/-NfsCSeUstAo/V5r3ooighWI/AAAAAAAAHzs/R94VplAsQn8XeC3QaeL9euzBNLf8NvPjACLcB/s1600/1.png)</div>

<p>所以這段Code的確可以正常運作，確定之後我們來寫單元測試驗證這件事情。</p>
<p>首先在單元測試專案建立EmployeesRepositoryTests</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-LVviiAdNxxs/V5r4xF2a5NI/AAAAAAAAHz8/8H5uWifglgYlr2hqA9WDZ5aageApPJrYACLcB/s1600/1.png)](https://3.bp.blogspot.com/-LVviiAdNxxs/V5r4xF2a5NI/AAAAAAAAHz8/8H5uWifglgYlr2hqA9WDZ5aageApPJrYACLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">
</div>上一篇有提到，這邊做的單元測試是每個測試前將準備好的CSV資料匯入LocalDB，做完測試後把資料全部砍掉，所以我們得先寫一段TestInitial讓每次測試之前先跑匯入資料的部分，先在單元測試專把CSVHelper安裝起來。

<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/--r9VuX4WFbQ/V5r5fTcTc_I/AAAAAAAAH0E/to6r2WGGomsVjlG3sQhFFworO3dAasVqgCLcB/s640/1.png)](https://2.bp.blogspot.com/--r9VuX4WFbQ/V5r5fTcTc_I/AAAAAAAAH0E/to6r2WGGomsVjlG3sQhFFworO3dAasVqgCLcB/s1600/1.png)</div>

<p>接著寫程式把資料從CSV讀出來，並寫入LocalDB，但首先先將測試專案安裝EntityFramwork套件</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-CbTTIt0AEHI/V5scdqAt-FI/AAAAAAAAH0U/ZiSP3YNeYMwuoUwkZ8dC6iTIq7EMZ8mkACLcB/s640/1.png)](https://4.bp.blogspot.com/-CbTTIt0AEHI/V5scdqAt-FI/AAAAAAAAH0U/ZiSP3YNeYMwuoUwkZ8dC6iTIq7EMZ8mkACLcB/s1600/1.png)</div>

<p>然後記得把連線字串加到單元測試的專案之中</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">connectionStrings</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;NorthwindEntities&quot;</span> <span class="attr">connectionString</span>=<span class="string">&quot;metadata=res://*/Models.Northwind.csdl|res://*/Models.Northwind.ssdl|res://*/Models.Northwind.msl;provider=System.Data.SqlClient;provider connection string=<span class="symbol">&amp;quot;</span>data source=(LocalDB)\MSSQLLocalDB;attachdbfilename=|DataDirectory|\TestDB.mdf;integrated security=True;MultipleActiveResultSets=True;App=EntityFramework<span class="symbol">&amp;quot;</span>&quot;</span> <span class="attr">providerName</span>=<span class="string">&quot;System.Data.EntityClient&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">connectionStrings</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>寫以下程式</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> Microsoft.VisualStudio.TestTools.UnitTesting;</span><br><span class="line"><span class="keyword">using</span> WebApplication4.Models;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> CsvHelper;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication4.Tests</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">TestClass</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EmployeesRepositoryTests</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">TestInitialize</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Initial</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//讀取檔案</span></span><br><span class="line">            <span class="keyword">using</span> (StreamReader reader = <span class="keyword">new</span> StreamReader(</span><br><span class="line">                <span class="built_in">string</span>.Concat(Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location), <span class="string">@&quot;\CSVs\Employees.csv&quot;</span>), </span><br><span class="line">                <span class="keyword">new</span> UTF8Encoding()))</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> csvReader = <span class="keyword">new</span> CsvReader(reader))</span><br><span class="line">            &#123;</span><br><span class="line">                csvReader.Configuration.WillThrowOnMissingField = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">var</span> Employees = csvReader.GetRecords&lt;Employees&gt;().ToList();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//將資料寫入DB</span></span><br><span class="line">                <span class="keyword">var</span> DBContext = <span class="keyword">new</span> NorthwindEntities();</span><br><span class="line">                DBContext.Employees.AddRange(Employees);</span><br><span class="line">                DBContext.SaveChanges();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Get_帶入ID_應取回該ID的Employee()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> ID = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">var</span> Sut = <span class="keyword">new</span> EmployeesRepository();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> Expected = <span class="string">&quot;Nancy&quot;</span>;</span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Sut.Get(ID);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(Expected, actual.FirstName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>執行看看會發現爆掉了!!!!!! 果然事情不是憨人我想的那麼簡單  </p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/--GWQvH-BzPo/V5srR-gwv8I/AAAAAAAAH0k/P2uj3DhlLwI1Q5ZTEPa0_E7CdwyQvMNngCLcB/s640/1.png)](https://1.bp.blogspot.com/--GWQvH-BzPo/V5srR-gwv8I/AAAAAAAAH0k/P2uj3DhlLwI1Q5ZTEPa0_E7CdwyQvMNngCLcB/s1600/1.png)</div>

<p>原因出在於Employee這個Table的ID欄位為流水自動編號，透過EF是無法寫入的，這時候只好透過Dapper下指令解決了，先安裝Dapper</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-pST5pb51uh0/V5srvCR_TVI/AAAAAAAAH0o/rH5mdCRr574aqTB8_sQIQ6S2clZ4bcU1QCLcB/s640/1.png)](https://3.bp.blogspot.com/-pST5pb51uh0/V5srvCR_TVI/AAAAAAAAH0o/rH5mdCRr574aqTB8_sQIQ6S2clZ4bcU1QCLcB/s1600/1.png)</div>

<p>將剛剛從CSVHelper的資料用Dapper塞進去，而且要將Identity Insert打開，先補上要給Dapper用的連線字串</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">add</span> <span class="attr">name</span>=<span class="string">&quot;NorthwindString&quot;</span> <span class="attr">connectionString</span>=<span class="string">&quot;Data Source=(LocalDB)\MSSQLLocalDB;attachdbfilename=|DataDirectory|\TestDB.mdf;Persist Security Info=True;&quot;</span> <span class="attr">providerName</span>=<span class="string">&quot;System.Data.SqlClient&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>把程式改成如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> Microsoft.VisualStudio.TestTools.UnitTesting;</span><br><span class="line"><span class="keyword">using</span> WebApplication4.Models;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> CsvHelper;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Reflection;</span><br><span class="line"><span class="keyword">using</span> System.Data.SqlClient;</span><br><span class="line"><span class="keyword">using</span> Dapper;</span><br><span class="line"><span class="keyword">namespace</span> <span class="title">WebApplication4.Tests</span></span><br><span class="line">&#123;</span><br><span class="line">    [<span class="meta">TestClass</span>]</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EmployeesRepositoryTests</span></span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">TestInitialize</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Initial</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//讀取檔案</span></span><br><span class="line">            <span class="keyword">using</span> (StreamReader reader = <span class="keyword">new</span> StreamReader(</span><br><span class="line">                <span class="built_in">string</span>.Concat(Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location), <span class="string">@&quot;\CSVs\Employees.csv&quot;</span>), </span><br><span class="line">                <span class="keyword">new</span> UTF8Encoding()))</span><br><span class="line">            <span class="keyword">using</span> (<span class="keyword">var</span> csvReader = <span class="keyword">new</span> CsvReader(reader))</span><br><span class="line">            &#123;</span><br><span class="line">                csvReader.Configuration.WillThrowOnMissingField = <span class="literal">false</span>;</span><br><span class="line">                <span class="keyword">var</span> Employees = csvReader.GetRecords&lt;Employees&gt;().ToList();</span><br><span class="line"></span><br><span class="line">                <span class="comment">//將資料寫入DB</span></span><br><span class="line">                <span class="comment">//var DBContext = new NorthwindEntities();</span></span><br><span class="line">                <span class="comment">//DBContext.Employees.AddRange(Employees);</span></span><br><span class="line">                <span class="comment">//DBContext.SaveChanges();</span></span><br><span class="line">                <span class="keyword">using</span> (<span class="keyword">var</span> cn = <span class="keyword">new</span> SqlConnection(System.Configuration.ConfigurationManager.ConnectionStrings[<span class="string">&quot;NorthwindString&quot;</span>].ConnectionString))</span><br><span class="line">                &#123;</span><br><span class="line">                    cn.Execute(<span class="string">@&quot;SET IDENTITY_INSERT Employees ON </span></span><br><span class="line"><span class="string">                            INSERT INTO Employees (EmployeeID,LastName,FirstName,Title,TitleOfCourtesy,BirthDate,HireDate,Address,City,Region,PostalCode,Country,HomePhone,Extension,Notes,ReportsTo,PhotoPath) </span></span><br><span class="line"><span class="string">                            VALUES (@EmployeeID,@LastName,@FirstName,@Title,@TitleOfCourtesy,@BirthDate,@HireDate,@Address,@City,@Region,@PostalCode,@Country,@HomePhone,@Extension,@Notes,@ReportsTo,@PhotoPath)</span></span><br><span class="line"><span class="string">                            SET IDENTITY_INSERT Employees OFF&quot;</span>,</span><br><span class="line">                          Employees);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> Get_帶入ID_應取回該ID的Employee()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> ID = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">var</span> Sut = <span class="keyword">new</span> EmployeesRepository();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> Expected = <span class="string">&quot;Nancy&quot;</span>;</span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Sut.Get(ID);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            Assert.AreEqual(Expected, actual.FirstName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>執行看看，就會發現終於成功了…….</p>
<div style="text-align: center;">[![](https://1.bp.blogspot.com/-XvPJF-Zf0u8/V5su65wLx5I/AAAAAAAAH04/D4u0LHDen-EHvjOweb7yfV2r9aLUehYmACLcB/s320/1.png)](https://1.bp.blogspot.com/-XvPJF-Zf0u8/V5su65wLx5I/AAAAAAAAH04/D4u0LHDen-EHvjOweb7yfV2r9aLUehYmACLcB/s1600/1.png)</div><div style="text-align: center;">
</div><div style="text-align: center;">
</div><div style="text-align: center;">
</div><div style="text-align: center;">
</div><div style="text-align: left;">最後別忘了前面提到的，每個單元測試應該都是獨立的，所以既然每次都會寫資料進去，當然每次測試完也都要把資料砍掉啦</div><div style="text-align: left;">
</div><div style="text-align: left;">所以在單元測試的最後補上這個Method，讓他每個單元測試執行完畢後都會清掉資料</div>```csharp
[TestCleanup]
        public void CleanUp()
        {
            using (var cn = new SqlConnection(System.Configuration.ConfigurationManager.ConnectionStrings["NorthwindString"].ConnectionString))
            {
                cn.Execute(@"Delete Employees");
            }
        }

<p>```</p>
<p>這樣就大功告成了!!!!</p>
]]></content>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【UnitTest】Mock Controller Request</title>
    <url>/2017/02/14/%E3%80%90UnitTest%E3%80%91Mock-Controller-Request/</url>
    <content><![CDATA[<p>寫單元測試測試Controller的時候，有時候程式中會用到<a href="https://msdn.microsoft.com/en-us/library/system.web.mvc.controller.request(v=vs.118).aspx">Controller.Request Property</a>，但單元測試並不是真的Web連線行為，所以呼叫到Request的時候會是Null , 想要做一個假的塞給他，這個屬性卻是只能讀取不能寫入的</p>
<div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-4_O_yEIRJeA/WKJdDhYR0MI/AAAAAAAAIEk/pa8aYvPcJw4jt62eTTSYrp6h-hK98eP1ACLcB/s1600/1.png)](https://2.bp.blogspot.com/-4_O_yEIRJeA/WKJdDhYR0MI/AAAAAAAAIEk/pa8aYvPcJw4jt62eTTSYrp6h-hK98eP1ACLcB/s1600/1.png)</div>

<p>每次寫完沒多久碰到就又會忘記，所以筆記下來方便以後查找，這邊一樣用NSubstitute套件做處理</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-dMNVp94tO1Y/WKJeLHnEa8I/AAAAAAAAIEs/7yAUVlh29F0wsXsmTjh_UcSZUdoC8MfpgCLcB/s1600/1.png)](https://4.bp.blogspot.com/-dMNVp94tO1Y/WKJeLHnEa8I/AAAAAAAAIEs/7yAUVlh29F0wsXsmTjh_UcSZUdoC8MfpgCLcB/s1600/1.png)</div>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">YourController Sut = <span class="keyword">new</span> YourController();</span><br><span class="line"> <span class="keyword">var</span> request = Substitute.For&lt;HttpRequestBase&gt;();</span><br><span class="line"> <span class="keyword">var</span> context = Substitute.For&lt;HttpContextBase&gt;();</span><br><span class="line"> request.HttpMethod.Returns(<span class="string">&quot;Get&quot;</span>);</span><br><span class="line"> context.Request.Returns(request);</span><br><span class="line"></span><br><span class="line"> Sut.ControllerContext = <span class="keyword">new</span> ControllerContext(context, <span class="keyword">new</span> RouteData(), Sut);</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Unit Test</tag>
      </tags>
  </entry>
  <entry>
    <title>【WebAPI】Custom ActionFilter Order</title>
    <url>/2015/12/14/%E3%80%90WebAPI%E3%80%91Custom-ActionFilter-Order/</url>
    <content><![CDATA[<h1 id="ActionAttribute"><a href="#ActionAttribute" class="headerlink" title="ActionAttribute"></a>ActionAttribute</h1><div class="note info">
            <p>環境 : WebAPI 2.2 <a href="http://www.asp.net/web-api/overview/releases/whats-new-in-aspnet-web-api-22">詳細</a></p>
          </div>

<p>在WebAPI中，通常都繪有需要客製化ActionFilter的情況發生</p>
<p><img src="https://3.bp.blogspot.com/-tfA3HwTsUBA/VnIwd3pjxiI/AAAAAAAAHrc/qzbMwEmMBb4/s1600/1.png"></p>
<h2 id="執行順序不固定"><a href="#執行順序不固定" class="headerlink" title="執行順序不固定"></a>執行順序不固定</h2><p>ActionFilter的執行順序並非在上面的就優先執行，Filter有個FilterScope來表示他屬於何種層級的ActionFilter，執行順序依次是 Global , Controller , Action 。但如果是在同一層級的ActionFilter順序則未必按照固定。 </p>
<p><img src="https://2.bp.blogspot.com/-vZ-NniyEom4/VnIx1sGnvcI/AAAAAAAAHro/-ykVRvzvq3Y/s1600/1.png" alt="https://2.bp.blogspot.com/-vZ-NniyEom4/VnIx1sGnvcI/AAAAAAAAHro/-ykVRvzvq3Y/s1600/1.png">]</p>
<h2 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h2><p><img src="https://4.bp.blogspot.com/-LiCgWC_Ob3M/VnIyiMCn0nI/AAAAAAAAHr0/H58PiNpUUvA/s1600/1.png" alt="https://4.bp.blogspot.com/-LiCgWC_Ob3M/VnIyiMCn0nI/AAAAAAAAHr0/H58PiNpUUvA/s1600/1.png"></p>
<p>裡面全部都一樣繼承ActionFilterAttribute即可</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FourAttribute</span> :<span class="title">ActionFilterAttribute</span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>註冊OneAttribute到Global<br><img src="https://2.bp.blogspot.com/-oCMhVi2M5_w/VnIzKgzvzrI/AAAAAAAAHsA/e9vuB3fiZE4/s1600/1.png" alt="https://2.bp.blogspot.com/-oCMhVi2M5_w/VnIzKgzvzrI/AAAAAAAAHsA/e9vuB3fiZE4/s1600/1.png"></p>
<p>將其它Attribute分別註冊到Controller與Action<br><img src="https://1.bp.blogspot.com/-VZm61VIoQZY/VnIzc88dwGI/AAAAAAAAHsM/piz8hD4vdXo/s1600/1.png" alt="https://1.bp.blogspot.com/-VZm61VIoQZY/VnIzc88dwGI/AAAAAAAAHsM/piz8hD4vdXo/s1600/1.png"></p>
<p>在Get中補上以下程式然後執行看看</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">HttpGet</span>]</span><br><span class="line">[<span class="meta">Three</span>]</span><br><span class="line">[<span class="meta">Four</span>]</span><br><span class="line"><span class="keyword">public</span> IEnumerable&lt;Tuple&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt;&gt; Get()</span><br><span class="line">&#123;</span><br><span class="line">    IHttpActionSelector actionSelector =</span><br><span class="line">        <span class="keyword">this</span>.Configuration.Services.GetActionSelector();</span><br><span class="line"> </span><br><span class="line">    HttpActionDescriptor actionDescriptor =</span><br><span class="line">        actionSelector.SelectAction(<span class="keyword">this</span>.ControllerContext);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">foreach</span> (FilterInfo filterInfo <span class="keyword">in</span> actionDescriptor.GetFilterPipeline())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">Tuple</span>&lt;<span class="title">string</span>, <span class="title">string</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            filterInfo.Instance.GetType(</span>).Name,</span></span><br><span class="line"><span class="function">            filterInfo.Scope.<span class="title">ToString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        )</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="測試結果"><a href="#測試結果" class="headerlink" title="測試結果"></a>測試結果</h2><p><img src="https://2.bp.blogspot.com/-ExqARkhthR8/VnI0IaZEwvI/AAAAAAAAHsY/iSNXKBQFZF0/s1600/1.png" alt="https://2.bp.blogspot.com/-ExqARkhthR8/VnI0IaZEwvI/AAAAAAAAHsY/iSNXKBQFZF0/s1600/1.png"></p>
<p>排序依據所對應的層級，雖然這邊排序與我們在程式上的排序相同。但實際上順序同層級的順序未必是由上而下，為了避免這樣的問題，最好的方法就是在ActionFilter加上排序的屬性來解決。</p>
<h2 id="實作Order屬性"><a href="#實作Order屬性" class="headerlink" title="實作Order屬性"></a>實作Order屬性</h2><h3 id="定義IOrderAttribute"><a href="#定義IOrderAttribute" class="headerlink" title="定義IOrderAttribute"></a>定義IOrderAttribute</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IOrderAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">int</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FourAttribute</span> : <span class="title">ActionFilterAttribute</span>, <span class="title">IOrderAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">int</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="實做IComparable介面"><a href="#實做IComparable介面" class="headerlink" title="實做IComparable介面"></a>實做IComparable介面</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomFilterInfo</span> : <span class="title">IComparable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> IFilter Instance &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> FilterScope Scope &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//FilterInfo</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomFilterInfo</span>(<span class="params">IFilter instance, FilterScope scope</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Instance = instance;</span><br><span class="line">            <span class="keyword">this</span>.Scope = scope;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">CompareTo</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (obj <span class="keyword">is</span> CustomFilterInfo)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> item = obj <span class="keyword">as</span> CustomFilterInfo;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">if</span> (item.Instance <span class="keyword">is</span> IAttribute)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> attr = item.Instance <span class="keyword">as</span> IAttribute;</span><br><span class="line">                    <span class="keyword">return</span> (<span class="keyword">this</span>.Instance <span class="keyword">as</span> IAttribute).Order.CompareTo(attr.Order);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> FilterInfo <span class="title">ConvertToFilterInfo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FilterInfo(<span class="keyword">this</span>.Instance, <span class="keyword">this</span>.Scope);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="實做IFilterProvider介面"><a href="#實做IFilterProvider介面" class="headerlink" title="實做IFilterProvider介面"></a>實做IFilterProvider介面</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomFilterProvider</span> : <span class="title">IFilterProvider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IEnumerable&lt;FilterInfo&gt; <span class="title">GetFilters</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        HttpConfiguration configuration, </span></span></span><br><span class="line"><span class="function"><span class="params">        HttpActionDescriptor actionDescriptor</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IEnumerable&lt;CustomFilterInfo&gt; customActionFilters =</span><br><span class="line">            actionDescriptor.GetFilters()</span><br><span class="line">                            .Select(i =&gt; <span class="keyword">new</span> CustomFilterInfo(i, FilterScope.Controller));</span><br><span class="line"> </span><br><span class="line">        IEnumerable&lt;CustomFilterInfo&gt; customControllerFilters =</span><br><span class="line">            actionDescriptor.ControllerDescriptor</span><br><span class="line">                            .GetFilters()</span><br><span class="line">                            .Select(i =&gt; <span class="keyword">new</span> CustomFilterInfo(i, FilterScope.Controller));</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> customControllerFilters.Concat(customActionFilters)</span><br><span class="line">                                      .OrderBy(i =&gt; i)</span><br><span class="line">                                      .Select(i =&gt; i.ConvertToFilterInfo());</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Global註冊"><a href="#Global註冊" class="headerlink" title="Global註冊"></a>Global註冊</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Application_Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AreaRegistration.RegisterAllAreas();</span><br><span class="line">    GlobalConfiguration.Configure(WebApiConfig.Register);</span><br><span class="line">    FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters);</span><br><span class="line">    GlobalConfiguration.Configuration.Formatters.XmlFormatter.SupportedMediaTypes.Clear();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//註冊Global Attribute</span></span><br><span class="line">    GlobalConfiguration.Configuration.Filters.Add(<span class="keyword">new</span> OneAttribute());</span><br><span class="line"> </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//新增CustomFilterProvider</span></span><br><span class="line">    GlobalConfiguration.Configuration.Services.Add(</span><br><span class="line">        <span class="keyword">typeof</span>(System.Web.Http.Filters.IFilterProvider), <span class="keyword">new</span> CustomFilterProvider());</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> providers = GlobalConfiguration.Configuration.Services.GetFilterProviders();</span><br><span class="line">    <span class="keyword">var</span> defaultprovider = providers.First(i =&gt; i <span class="keyword">is</span> ActionDescriptorFilterProvider);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//移除DefaultProvider</span></span><br><span class="line">    GlobalConfiguration.Configuration.Services.Remove(</span><br><span class="line">        <span class="keyword">typeof</span>(System.Web.Http.Filters.IFilterProvider),</span><br><span class="line">        defaultprovider);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="測試-1"><a href="#測試-1" class="headerlink" title="測試"></a>測試</h3><p>將Attibute補上Order再執行看看得到的順序</p>
<p><img src="https://1.bp.blogspot.com/-UucLgmkDBeE/VnJTKlpyjVI/AAAAAAAAHso/5-37Ww458bE/s1600/1.png" alt="https://1.bp.blogspot.com/-UucLgmkDBeE/VnJTKlpyjVI/AAAAAAAAHso/5-37Ww458bE/s1600/1.png"></p>
<p>可以看到Four排在Three的前面了</p>
<p><img src="https://4.bp.blogspot.com/-YndO7jfF4M0/VnJTkNiXDzI/AAAAAAAAHs0/S6HXWfK1_ks/s1600/1.png" alt="https://4.bp.blogspot.com/-YndO7jfF4M0/VnJTkNiXDzI/AAAAAAAAHs0/S6HXWfK1_ks/s1600/1.png"></p>
]]></content>
      <tags>
        <tag>WebAPI</tag>
      </tags>
  </entry>
  <entry>
    <title>【WebConfig】擴充WebConfig</title>
    <url>/2013/10/01/%E3%80%90WebConfig%E3%80%91%E6%93%B4%E5%85%85WebConfig/</url>
    <content><![CDATA[<p>做專案時常常會有測試機與正式機的區別，又兩者要呼叫的API常常也有正式與測試的區別。如果將網址寫死在Code裡，將造成佈署測試機時compile一次，佈署到正式機又要打開code改好網址後再compile一次，不僅耗時又容易出錯。</p>
<p>所以大部分有這種情況時會將網址參數寫在WebConfig裡，這樣只要到兩台機器去修改參數網址即可，避免了一再compile的問題。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appSettings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">&quot;APIUrlTest&quot;</span> <span class="attr">value</span>=<span class="string">&quot;TestAPI.com.tw&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">add</span> <span class="attr">key</span>=<span class="string">&quot;APIUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;xxx.com.tw&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appSettings</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但可能會有很多類似這種參數會寫在Config裡，網址、時間、變數…琳瑯滿目，寫到最後連RD自己也搞得亂七八糟，所以就會寫要將同類型的參數歸類整理一翻。接下來Demo如何將WebConfig隔離與整理。</p>
<ul>
<li>  首先先在專案中新增一個新的Config檔，就暫且命名為i.config<br><a href="http://1.bp.blogspot.com/-veBTX-iUwNo/UkpqoxSTeHI/AAAAAAAAELI/rtGjX7tlMBE/s1600/1.png"><img src="http://1.bp.blogspot.com/-veBTX-iUwNo/UkpqoxSTeHI/AAAAAAAAELI/rtGjX7tlMBE/s1600/1.png"></a></li>
<li>  在這個i.config中寫下新的區段(這邊我創了一個新的區塊叫iconfig)<a href="http://1.bp.blogspot.com/-E0LwShdrRYY/UkprFgFcGYI/AAAAAAAAELQ/7hiXZ5kz3Kg/s1600/1.png"><img src="http://1.bp.blogspot.com/-E0LwShdrRYY/UkprFgFcGYI/AAAAAAAAELQ/7hiXZ5kz3Kg/s1600/1.png"></a></li>
<li>接著到Web.Config註冊這個區段<pre><code>  *   在configSections中註冊[![](http://4.bp.blogspot.com/-Fgx71lYcBws/UkprtA0ViaI/AAAAAAAAELY/07Mhjt5ygQ4/s1600/1.png)](http://4.bp.blogspot.com/-Fgx71lYcBws/UkprtA0ViaI/AAAAAAAAELY/07Mhjt5ygQ4/s1600/1.png)
</code></pre>
<ul>
<li>  在appSettings區段下面註冊<a href="http://4.bp.blogspot.com/-t3Q4eGgcdNM/UkpsCLpeqBI/AAAAAAAAELg/ZMZ5sWLIkyY/s1600/1.png"><img src="http://4.bp.blogspot.com/-t3Q4eGgcdNM/UkpsCLpeqBI/AAAAAAAAELg/ZMZ5sWLIkyY/s1600/1.png"></a></li>
</ul>
</li>
<li>在code裡面抓取i.config參數值得方法 ```csharp<br>public class iconfig<br>{<br> private static System.Collections.Hashtable iConfig = (System.Collections.Hashtable)System.Configuration.ConfigurationManager.GetSection(“iconfig”);<br> public static string ReservationApi { get { return (string)iConfig[“ReservationApi”]; } }<br>}</li>
</ul>
<p>```<br>依照上述方法就可以將很多不同類型的參數分門別類的整理起來了!!!</p>
]]></content>
      <tags>
        <tag>MVC</tag>
        <tag>webconfig</tag>
        <tag>ASP</tag>
      </tags>
  </entry>
  <entry>
    <title>【XML】將資料匯出到EXCEL - 透過ClosedXML套件</title>
    <url>/2014/08/11/%E3%80%90XML%E3%80%91%E5%B0%87%E8%B3%87%E6%96%99%E5%8C%AF%E5%87%BA%E5%88%B0EXCEL-%E9%80%8F%E9%81%8EClosedXML%E5%A5%97%E4%BB%B6/</url>
    <content><![CDATA[<p>最近有寫Excel報表的需求，ClosedXML真的是個不錯的套件<br><a href="http://4.bp.blogspot.com/-U77EUQ5N4bI/U-gfNomELwI/AAAAAAAAEOg/pmy-h-xJt78/s1600/1.png"><img src="https://4.bp.blogspot.com/-U77EUQ5N4bI/U-gfNomELwI/AAAAAAAAEOg/pmy-h-xJt78/s1600/1.png"></a></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> workbook = <span class="keyword">new</span> XLWorkbook(); <span class="comment">//new Excel</span></span><br><span class="line"> <span class="keyword">var</span> sheet_A = workbook.Worksheets.Add(<span class="string">&quot;Sheet_A&quot;</span>); <span class="comment">//新增Sheet到 Excel</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">//塞資料到Sheet中</span></span><br><span class="line"> worksheet.Cell(_index, <span class="number">1</span>).Value = <span class="string">&quot;欄位一&quot;</span>;</span><br><span class="line"> worksheet.Cell(_index, <span class="number">2</span>).Value = <span class="string">&quot;欄位二&quot;</span>;</span><br><span class="line"> worksheet.Cell(_index, <span class="number">3</span>).Value = <span class="string">&quot;欄位三&quot;</span>;</span><br><span class="line"> worksheet.Cell(_index, <span class="number">4</span>).Value = <span class="string">&quot;欄位四&quot;</span>;</span><br><span class="line"> worksheet.Cell(_index, <span class="number">5</span>).Value = <span class="string">&quot;欄位五&quot;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>用法還滿簡單的，如果有更深入的用法想瞭解也可以到<a href="https://closedxml.codeplex.com/documentation">ClosedXml網站</a>看文件<br>在使用的過程有遇到一個情況就是從DB裡面撈出大量的資料倒入Excel時，匯出打開檔案會顯示Excel已經損毀，可是直接把DB撈出來的資料用複製貼上卻可以完整地貼到Excel中，存檔再打開也不會壞掉。這個問題搞了好久…最後查到大陸網站得到以下的解答 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 提示??，??信息如下： 十六?制值 0x0B 是?效的字符??</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>?生原因是xml文件中包含低位非打印字符造成的</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span>?理方法：在?生xml文件的?候，??低位非打印字符</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;tmp&quot; /&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">ReplaceLowOrderASCIICharacters</span>(<span class="params"><span class="built_in">string</span> tmp</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   StringBuilder info = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">   <span class="keyword">foreach</span> (<span class="built_in">char</span> cc <span class="keyword">in</span> tmp)</span><br><span class="line">   &#123;</span><br><span class="line">      <span class="built_in">int</span> ss = (<span class="built_in">int</span>)cc;</span><br><span class="line">      <span class="keyword">if</span> (((ss &gt;= <span class="number">0</span>) &amp;&amp; (ss &lt;= <span class="number">8</span>)) || ((ss &gt;= <span class="number">11</span>) &amp;&amp; (ss &lt;= <span class="number">12</span>)) || ((ss &gt;= <span class="number">14</span>) &amp;&amp; (ss &lt;= <span class="number">32</span>)))</span><br><span class="line">         info.AppendFormat(<span class="string">&quot; &quot;</span>, ss);<span class="comment">//&amp;#x&#123;0:X&#125;;</span></span><br><span class="line">      <span class="keyword">else</span> info.Append(cc);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> info.ToString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>把字元丟到這個function去過濾後就可以避免錯誤了!!</p>
]]></content>
      <tags>
        <tag>C#</tag>
        <tag>Excel</tag>
      </tags>
  </entry>
  <entry>
    <title>【地理位置】透過座標框出地理位置，與判斷地理位置是否重疊</title>
    <url>/2016/08/04/%E3%80%90%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%E3%80%91%E9%80%8F%E9%81%8E%E5%BA%A7%E6%A8%99%E6%A1%86%E5%87%BA%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%EF%BC%8C%E8%88%87%E5%88%A4%E6%96%B7%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%E6%98%AF%E5%90%A6%E9%87%8D%E7%96%8A/</url>
    <content><![CDATA[<p>如果取得<strong>西北</strong>與<strong>東南</strong>的兩點座標透過<span style="color: #6aa84f;">DbGeography</span>這個類別能夠框出地理面積，程式碼如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">DbGeography.FromText(<span class="built_in">string</span>.Format(<span class="string">&quot;POLYGON((&#123;0&#125; &#123;1&#125;, &#123;0&#125; &#123;2&#125;, &#123;3&#125; &#123;2&#125;, &#123;3&#125; &#123;1&#125;, &#123;0&#125; &#123;1&#125;))&quot;</span>,</span><br><span class="line">                     西北座標點的經度,</span><br><span class="line">                     西北座標點的緯度,</span><br><span class="line">                     東南座標點的緯度,</span><br><span class="line">                     東南座標點的經度), <span class="number">4326</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣能取回<span style="color: #6aa84f;">DbGeography</span>的地理面積的類別，透過這個類別的Intersects這個Method能判斷兩個面積，或是座標點是否有交集。<a href="https://msdn.microsoft.com/zh-tw/library/system.data.spatial.dbgeography.intersects(v=vs.110).aspx">參考MSDN</a></p>
<p>範例 : 用Google地圖來取得兩個座標點，框出地理位置<br>**<br>**<strong>座標點1 :</strong>&nbsp;25.029768, 121.546829</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-2gYLmcT7YnE/V6Lj8q2dPzI/AAAAAAAAH1I/paibCBIx16cafBaBrvhNCJkrFTcVrYS0gCLcB/s400/1.png)](https://1.bp.blogspot.com/-2gYLmcT7YnE/V6Lj8q2dPzI/AAAAAAAAH1I/paibCBIx16cafBaBrvhNCJkrFTcVrYS0gCLcB/s1600/1.png)</div>

<p><strong>座標點2 :</strong>&nbsp;25.028854, 121.548417</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-U3tLa6GFY3U/V6LkMN-HODI/AAAAAAAAH1M/9FhZt1GbnlQPi29X-gO8YKwhuiZbLUBvACLcB/s400/1.png)](https://2.bp.blogspot.com/-U3tLa6GFY3U/V6LkMN-HODI/AAAAAAAAH1M/9FhZt1GbnlQPi29X-gO8YKwhuiZbLUBvACLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div>

<p>所以透過剛剛的程式我們可以框出這塊地理面積</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-vt2mdO_TXx0/V6LlFRP_RrI/AAAAAAAAH1U/iyilo98OOwsCNtTPvlcvN9Hs-LAiD0uAwCLcB/s320/1.png)](https://2.bp.blogspot.com/-vt2mdO_TXx0/V6LlFRP_RrI/AAAAAAAAH1U/iyilo98OOwsCNtTPvlcvN9Hs-LAiD0uAwCLcB/s1600/1.png)</div>

<p>依樣畫葫蘆，在選兩個點去框出下個面積<br><strong>座標點1 :</strong>&nbsp;25.029541, 121.547474<br>**座標點2 :&nbsp;**25.028199, 121.549636</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-uv7-0y_8x2I/V6LlwFgayyI/AAAAAAAAH1k/4lmNDDpGBmMhF0xtmFJjIuAtlQKfqw_mwCLcB/s320/1.png)](https://1.bp.blogspot.com/-uv7-0y_8x2I/V6LlwFgayyI/AAAAAAAAH1k/4lmNDDpGBmMhF0xtmFJjIuAtlQKfqw_mwCLcB/s1600/1.png)</div>

<p>從兩張圖可以看到在四維路那邊有重疊的部分，用程式碼來跑跑看</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-1wdcHZ4VBEU/V6LmrE_EI7I/AAAAAAAAH1s/4_wwJ8SwkEw-neIcwpAeeaoTfrcJ544JgCLcB/s640/1.png)](https://1.bp.blogspot.com/-1wdcHZ4VBEU/V6LmrE_EI7I/AAAAAAAAH1s/4_wwJ8SwkEw-neIcwpAeeaoTfrcJ544JgCLcB/s1600/1.png)</div>

<p>為了驗證不重疊會回傳False,我們將Area2的西北座標往右下角移動，讓面積縮小不會跟Area1重疊，再次實驗看看<br><strong>Area2&nbsp;</strong><br><strong>座標點1 :</strong>&nbsp;25.029541, 121.547474 &gt;&gt;&nbsp;<span style="color: red;">25.029123, 121.548772 &nbsp;(改到敦化南路二段上)</span><br>**座標點2 :&nbsp;**25.028199, 121.549636</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-EYzYtuHuPs0/V6Lnj8MSgYI/AAAAAAAAH14/cDU5K1uKDQUlQbYYNdFEt_h_sJySf0ZmACLcB/s1600/1.png)](https://4.bp.blogspot.com/-EYzYtuHuPs0/V6Lnj8MSgYI/AAAAAAAAH14/cDU5K1uKDQUlQbYYNdFEt_h_sJySf0ZmACLcB/s1600/1.png)</div>

<p>補充:<br>上面介紹的是兩點框出面積，如果要判斷一個座標點有無落在一個面積裡面，用法也相同，只是建立<span style="color: #6aa84f;">DbGeography</span>座標點的方法略有不同，如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> point = DbGeography.PointFromText(<span class="built_in">string</span>.Format(<span class="string">&quot;POINT(&#123;0&#125; &#123;1&#125;)&quot;</span>, 經度, 緯度), <span class="number">4326</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>一樣帶到Intersects就可以得到答案了!! 以上</p>
]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>【日文】か、かどうか 如何使用</title>
    <url>/2018/11/21/%E3%80%90%E6%97%A5%E6%96%87%E3%80%91%E3%81%8B_%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B/</url>
    <content><![CDATA[<p>日文中的疑問子句</p>
<p><strong>普通型 + かどうか + 子句</strong></p>
<ol>
<li><p>このカメラは日本で買ったかどうか、わからない<br>這個相機是不是在日本買的,我不知道</p>
</li>
<li><p>先生が上手に歌えるかどうか、わからない<br>老師唱歌拿不拿手,我不知道</p>
</li>
</ol>
<p><strong>(前面出現疑問詞)+普通型 + か + 子句</strong></p>
<ol>
<li><p>このカメラは誰のか、わからない<br>這個相機是誰的,我並不知道</p>
</li>
<li><p>いつ日本へ行くか、知っていますか<br>何時要去日本,你知道嗎？</p>
</li>
</ol>
<div class="note info">
            <p>參考文章</p><p><a href="https://www.facebook.com/wangcolaneko/posts/%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E8%B7%9F%E3%81%8B%E5%BF%AB%E9%80%9F%E8%A7%A3%E9%A1%8C%E6%B3%95%E6%9C%AC%E6%95%99%E5%AD%B8%E7%82%BA-%E9%9B%B2%E7%AB%AF%E8%AA%B2%E7%A8%8B%E5%88%9D%E7%B4%9A%E2%85%A3n3%E4%B8%AD%E7%B4%9A%E7%AF%80%E9%8C%84%E6%97%A5%E6%96%87%E5%8F%A5%E4%B8%AD%E5%B8%B8%E6%9C%83%E7%9C%8B%E5%88%B0%E4%BB%8A%E4%BD%95%E6%99%82%E3%81%8B%E3%82%8F%E3%81%8B%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E4%BB%8A%E6%97%A5%E3%81%AF%E4%BD%95%E6%9B%9C%E6%97%A5%E3%81%8B%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E7%9A%84%E9%96%93%E6%8E%A5%E5%95%8F%E5%8F%A5%E6%89%80%E8%AC%82%E7%9A%84%E5%95%8F%E5%8F%A5%E6%8C%87%E7%9A%84%E6%98%AF%E7%96%91%E5%95%8F%E8%A9%9E%E3%81%8B%E7%9A%84%E5%8F%A5/1624497210915932/">王可樂的日文教室【「かどうか」跟「か」快速解題法！】</a></p><p><a href="http://www2.nkfust.edu.tw/~jwd/playgrammar/1know/page2_10.htm">間接句型的用法</a></p>
          </div>]]></content>
      <tags>
        <tag>日文學習</tag>
      </tags>
  </entry>
  <entry>
    <title>【演算法】Counting Sort</title>
    <url>/2018/06/04/%E3%80%90%E6%BC%94%E7%AE%97%E6%B3%95%E3%80%91Counting%20Sort/</url>
    <content><![CDATA[<h1 id="何謂Counting-Sort"><a href="#何謂Counting-Sort" class="headerlink" title="何謂Counting Sort"></a>何謂Counting Sort</h1><p>是一種排序的演算法，特色是不需要比較數字間的大小，而是透過計算在Array中的Index的位置來達到排序的效果，限制是必須先知道數字的範圍以及數字組的個數，屬於線性排序 O(n) 。</p>
<h1 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h1><div class="note info">
            <p>Suppose you have an array of 1000 integers. The integers are in random order, but you know each of the integers is between 1 and 5000 (inclusive). In addition, each number appears only once in the array. Assume that you can access each element of the array only once. Describe an algorithm to sort it. </p><p>假設你有個數字陣列其中包含1000個數字，且這些數字來自1~5000之間不重複，請用一組演算法來達成只讀取數字一次並排序完成。</p>
          </div>

<h2 id="解題"><a href="#解題" class="headerlink" title="解題"></a>解題</h2><p><strong>欲排序的陣列</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//隨機取1000個</span></span><br><span class="line"><span class="built_in">int</span> Amount = <span class="number">1000</span>;</span><br><span class="line"><span class="comment">//隨機從1~5000中取出不重複的1000個數字</span></span><br><span class="line"><span class="built_in">int</span>[] IntPool = Enumerable.Range(<span class="number">1</span>, <span class="number">5000</span>).OrderBy(x =&gt; Guid.NewGuid()).Take(Amount).ToArray();</span><br></pre></td></tr></table></figure>
<p><strong>準備一個的數字陣列，空間為5000</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span>[] IndexArray = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">5000</span>];</span><br></pre></td></tr></table></figure>
<p><strong>計算哪些位置應該存在數字</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> element <span class="keyword">in</span> IntPool)</span><br><span class="line">&#123;</span><br><span class="line">    IndexArray[ element <span class="number">-1</span> ] ++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>將IndexArray中值為1的挑出來</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span>[] Result = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">1000</span>];</span><br><span class="line"><span class="keyword">var</span> Index = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; IndexArray.Length; i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (IndexArray[i] &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Result[Index] = i + <span class="number">1</span>;</span><br><span class="line">		Index++;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//此時Result即為排序後的結果</span></span><br></pre></td></tr></table></figure>

<h1 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h1><div class="note info">
            <p>假設你有個數字陣列其中包含1000個數字，這些數字來自1~5000之間且<strong>可能會重複</strong>，如何用Counting Sort達成排序</p>
          </div>

<h2 id="解題-1"><a href="#解題-1" class="headerlink" title="解題"></a>解題</h2><p><strong>欲排序的陣列</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">Random Rnd = <span class="keyword">new</span> Random();</span><br><span class="line"><span class="built_in">int</span>[] IntPool  =<span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">1000</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)</span><br><span class="line">&#123;</span><br><span class="line">   IntPool[i] = Rnd.Next(<span class="number">1</span>,<span class="number">5001</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>找出最大值與最小值</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span> Min = IntPool[<span class="number">0</span>];</span><br><span class="line"><span class="built_in">int</span> Max = IntPool[<span class="number">0</span>];</span><br><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt; IntPool.Length; i++)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (IntPool[i] &gt; Max)</span><br><span class="line">		Max = IntPool[i];</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IntPool[i] &lt; Min)</span><br><span class="line">		Min = IntPool[i];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>準備一個能容納最大範圍的IndexArray</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span>[] IndexArray = <span class="keyword">new</span> <span class="built_in">int</span>[Max - Min +<span class="number">1</span>];</span><br></pre></td></tr></table></figure>
<p><strong>計算每個數字在IndexArray中的相對位置，並統計每個位置重複的數字數</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> element <span class="keyword">in</span> IntPool)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//統計每個位置有幾個重複的數字</span></span><br><span class="line">	IndexArray[element - Min] ++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>計算每個位置累積的數字個數</strong><br>這邊是我想比較久的地方，所以畫了一個圖希望能幫助理解，假設我們算出來後陣列長這樣，表示Index 0放著2個數字，Index 2有1個數字，Index 4有1個數字以此類推<br><a href="/images/20180614/1/1.png"><img src="/images/20180614/1/1.png"></a><br>所以如果我們將每個位置的數字與前一格相加，可以得到該Index實際上已經排了幾個數字，<br><a href="/images/20180614/1/2.png"><img src="/images/20180614/1/2.png"></a></p>
<p><strong>計算到達該位子時，實際上總共已經有幾個數字</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">1</span>; i &lt; IndexArray.Length; i++)</span><br><span class="line">&#123;</span><br><span class="line">	IndexArray[i] = IndexArray[i] + IndexArray[i - <span class="number">1</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>排序</strong></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span>[] Result = <span class="keyword">new</span> <span class="built_in">int</span>[<span class="number">1000</span>];</span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">var</span> element <span class="keyword">in</span> IntPool)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">var</span> TotalCount = IndexArray[element - Min];</span><br><span class="line">	<span class="comment">//第幾個數字-1，其實就表示他要放在Result的Index位置</span></span><br><span class="line">	Result[TotalCount- <span class="number">1</span>] = element;</span><br><span class="line">	IndexArray[element - Min] --;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//此時Result即為排序後的結果</span></span><br></pre></td></tr></table></figure>


]]></content>
      <tags>
        <tag>演算法</tag>
      </tags>
  </entry>
  <entry>
    <title>【心情】世殊事異</title>
    <url>/2013/12/09/%E3%80%90%E5%BF%83%E6%83%85%E3%80%91%E4%B8%96%E6%AE%8A%E4%BA%8B%E7%95%B0/</url>
    <content><![CDATA[<div style="position: relative; z-index: 5;">[![](http://4.bp.blogspot.com/-O5EO2Xn1EKo/UqWGOc7xaRI/AAAAAAAAEM0/dPda1T6sNAI/s400/IMG_0440.JPG)](http://4.bp.blogspot.com/-O5EO2Xn1EKo/UqWGOc7xaRI/AAAAAAAAEM0/dPda1T6sNAI/s1600/IMG_0440.JPG) 
最近心情持續低氣壓，想在FB上抒發一下心情卻又礙於人多口雜。希望能在這找到屬於自己的另一個僻靜小天地
剛剛看到有人用CSS畫出幾個下雨的樣式，正好也符合自己的心境就來跟部落格整合一下好了。
[下雨CSS請參考](http://www.blogger.com/blogger.g?blogID=6692337573339064262)
html
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;body&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;rain&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
javascript
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// number of drops created.</span></span><br><span class="line"><span class="keyword">var</span> nbDrop = <span class="number">858</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// function to generate a random number range.</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">randRange</span>(<span class="params"> minNum, maxNum</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * (maxNum - minNum + <span class="number">1</span>)) + minNum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// function to generate drops</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRain</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">for</span>( i=<span class="number">1</span>;i &lt; nbDrop;i++) &#123;</span><br><span class="line"> <span class="keyword">var</span> dropLeft = randRange(<span class="number">0</span>,<span class="number">1600</span>);</span><br><span class="line"> <span class="keyword">var</span> dropTop = randRange(-<span class="number">1000</span>,<span class="number">1400</span>);</span><br><span class="line"></span><br><span class="line"> $(<span class="string">&#x27;.rain&#x27;</span>).append(<span class="string">&#x27;&lt;div class=&quot;drop&quot; id=&quot;drop&#x27;</span>+i+<span class="string">&#x27;&quot;&gt;&lt;/div&gt;&#x27;</span>);</span><br><span class="line"> $(<span class="string">&#x27;#drop&#x27;</span>+i).css(<span class="string">&#x27;left&#x27;</span>,dropLeft);</span><br><span class="line"> $(<span class="string">&#x27;#drop&#x27;</span>+i).css(<span class="string">&#x27;top&#x27;</span>,dropTop);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Make it rain</span></span><br><span class="line">createRain();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
css 
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span><span class="selector-class">.body</span> &#123;</span><br><span class="line">            <span class="attribute">background</span>:<span class="number">#0D343A</span>;</span><br><span class="line">            <span class="attribute">background</span>:<span class="built_in">-webkit-gradient</span>(linear,<span class="number">0%</span> <span class="number">0%</span>,<span class="number">0%</span> <span class="number">100%</span>, <span class="built_in">from</span>(<span class="built_in">rgba</span>(<span class="number">13</span>,<span class="number">52</span>,<span class="number">58</span>,<span class="number">1</span>) ), <span class="built_in">to</span>(<span class="number">#000000</span>)  );</span><br><span class="line">            <span class="attribute">background</span>: <span class="built_in">-moz-linear-gradient</span>(top, <span class="built_in">rgba</span>(<span class="number">13</span>,<span class="number">52</span>,<span class="number">58</span>,<span class="number">1</span>) <span class="number">0%</span>, <span class="built_in">rgba</span>(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span>) <span class="number">100%</span>);</span><br><span class="line"></span><br><span class="line">            <span class="attribute">overflow</span>:hidden;&#125;</span><br><span class="line"></span><br><span class="line">            <span class="selector-class">.drop</span> &#123;</span><br><span class="line">              <span class="attribute">background</span>:<span class="built_in">-webkit-gradient</span>(linear,<span class="number">0%</span> <span class="number">0%</span>,<span class="number">0%</span> <span class="number">100%</span>, <span class="built_in">from</span>(<span class="built_in">rgba</span>(<span class="number">13</span>,<span class="number">52</span>,<span class="number">58</span>,<span class="number">1</span>) ), <span class="built_in">to</span>(<span class="built_in">rgba</span>(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">0.6</span>))  );</span><br><span class="line">              <span class="attribute">background</span>: <span class="built_in">-moz-linear-gradient</span>(top, <span class="built_in">rgba</span>(<span class="number">13</span>,<span class="number">52</span>,<span class="number">58</span>,<span class="number">1</span>) <span class="number">0%</span>, <span class="built_in">rgba</span>(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,.<span class="number">6</span>) <span class="number">100%</span>);</span><br><span class="line">                <span class="attribute">width</span>:<span class="number">1px</span>;</span><br><span class="line">                <span class="attribute">height</span>:<span class="number">89px</span>;</span><br><span class="line">                <span class="attribute">position</span>: absolute;</span><br><span class="line">                <span class="attribute">bottom</span>:<span class="number">200px</span>;</span><br><span class="line">                -webkit-<span class="attribute">animation</span>: fall .<span class="number">63s</span> linear infinite;</span><br><span class="line">              -moz-<span class="attribute">animation</span>: fall .<span class="number">63s</span> linear infinite;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* animate the drops*/</span></span><br><span class="line">        <span class="keyword">@-webkit-keyframes</span> fall &#123;</span><br><span class="line">           <span class="selector-tag">to</span> &#123;<span class="attribute">margin-top</span>:<span class="number">900px</span>;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">@-moz-keyframes</span> fall &#123;</span><br><span class="line">           <span class="selector-tag">to</span> &#123;<span class="attribute">margin-top</span>:<span class="number">900px</span>;&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</div><div class="body" style="height: 500px; position: relative; z-index: 2;">
<section class="rain"></section></div><div style="position: relative; z-index: 5;">[雨滴請參考](http://codepen.io/lbebber/full/uIiJp)</div> <!-- 下雨 --><style>        div.body {             background:#0D343A;             background:-webkit-gradient(linear,0% 0%,0% 100%, from(rgba(13,52,58,1) ), to(#000000)  );             background: -moz-linear-gradient(top, rgba(13,52,58,1) 0%, rgba(0,0,0,1) 100%);                          overflow:hidden;}                                       .drop {               background:-webkit-gradient(linear,0% 0%,0% 100%, from(rgba(13,52,58,1) ), to(rgba(255,255,255,0.6))  );               background: -moz-linear-gradient(top, rgba(13,52,58,1) 0%, rgba(255,255,255,.6) 100%);                 width:1px;                 height:89px;                 position: absolute;                 bottom:200px;                 -webkit-animation: fall .63s linear infinite;               -moz-animation: fall .63s linear infinite;         }                /* animate the drops*/         @-webkit-keyframes fall {            to {margin-top:900px;}         }         @-moz-keyframes fall {            to {margin-top:900px;}         } </style>  <script language='JavaScript'>//<![CDATA[  // number of drops created. var nbDrop = 858;   // function to generate a random number range. function randRange( minNum, maxNum) {   return (Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum); }  // function to generate drops function createRain() {   for( i=1;i < nbDrop;i++) {  var dropLeft = randRange(0,1600);  var dropTop = randRange(-1000,1400);   $('.rain').append('<div class="drop" id="drop'+i+'"></div>');  $('#drop'+i).css('left',dropLeft);  $('#drop'+i).css('top',dropTop);  }  } // Make it rain createRain();  //]]>  </script><!-- 下雨 END -->]]></content>
      <tags>
        <tag>CSS</tag>
        <tag>HTML</tag>
      </tags>
  </entry>
  <entry>
    <title>【爬蟲】透過Selenium WebDriver 爬網頁，以Instagram為例</title>
    <url>/2018/01/24/%E3%80%90%E7%88%AC%E8%9F%B2%E3%80%91%E9%80%8F%E9%81%8ESelenium-WebDriver-%E7%88%AC%E7%B6%B2%E9%A0%81%EF%BC%8C%E4%BB%A5Instagram%E7%82%BA%E4%BE%8B/</url>
    <content><![CDATA[<p>常常因為資料分析的需求，會有需要爬網頁資料的時候，而以往爬網頁不外乎將Html拉回來後，依據Tag去拆解資訊。 但現今的網站很大部分都是前端透過API拉版面，以Instagram來說，如果直接透過網址將Html拉回來，會只得到空空的外殼而已，什麼都找不到。 這時候就需要模擬瀏覽器行為來讓Javascript運作，甚至操作瀏覽器去點擊特定按鈕。</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-6yR04AI5phg/Wmf7S3BE3TI/AAAAAAAAITs/gELt5or7tQkL60jmDRYwb1-YGuNU8cKggCLcBGAs/s400/1.png)](https://2.bp.blogspot.com/-6yR04AI5phg/Wmf7S3BE3TI/AAAAAAAAITs/gELt5or7tQkL60jmDRYwb1-YGuNU8cKggCLcBGAs/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">Instagram拉回來的網頁就只有一個空殼而已....</td></tr></tbody></table>
透過Selenium.WebDriver，以及Seleium.WebDriver.ChromeDriver套件，可以寫程式操作Chrome的操作行為
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-DkheSsyDReI/Wmf8FTKy0VI/AAAAAAAAIT0/raZdEEh40xgGJQbTFwhZ2A3aQbOOh4VWACLcBGAs/s640/1.png)](https://1.bp.blogspot.com/-DkheSsyDReI/Wmf8FTKy0VI/AAAAAAAAIT0/raZdEEh40xgGJQbTFwhZ2A3aQbOOh4VWACLcBGAs/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-vnkv6jsDImY/Wmf8OnewkhI/AAAAAAAAIT4/FnlCPUMVsH05noZ1RVbhxFbWqMIYKZJ5gCLcBGAs/s640/1.png)](https://3.bp.blogspot.com/-vnkv6jsDImY/Wmf8OnewkhI/AAAAAAAAIT4/FnlCPUMVsH05noZ1RVbhxFbWqMIYKZJ5gCLcBGAs/s1600/1.png)</div>

<p>接著來一步一步分析如何透過它來爬網頁</p>
<p>開啟Chrome瀏覽器，並且連到想爬的網頁 : <a href="https://www.instagram.com/mercci22/">https://www.instagram.com/mercci22/</a> </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> (IWebDriver driver = <span class="keyword">new</span> ChromeDriver())</span><br><span class="line">            &#123;</span><br><span class="line"></span><br><span class="line">                driver.Navigate().GoToUrl(<span class="string">&quot;https://www.instagram.com/mercci22/&quot;</span>);            </span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>接著分析目標網頁，會發現所有PO文資料都放在一個Div且Class為_cmdpi裡面</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-sbreT5cUils/Wmf99JegYUI/AAAAAAAAIUI/oIXZxzMGX7c9LU4uVQ9H0BSJUI67UgdGwCLcBGAs/s640/1.png)](https://1.bp.blogspot.com/-sbreT5cUils/Wmf99JegYUI/AAAAAAAAIUI/oIXZxzMGX7c9LU4uVQ9H0BSJUI67UgdGwCLcBGAs/s1600/1.png)</div>

<p>往下找出每一行、每一格，在div[class=’_cmdpi’]底下會有div[class=’_70iju’]每一行</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-yluY12_h7T0/Wmf_JJsdiBI/AAAAAAAAIUQ/zLIRDslBbZQEYGRvu0qXp4JoSdObu-lPwCLcBGAs/s640/1.png)](https://4.bp.blogspot.com/-yluY12_h7T0/Wmf_JJsdiBI/AAAAAAAAIUQ/zLIRDslBbZQEYGRvu0qXp4JoSdObu-lPwCLcBGAs/s1600/1.png)</div>

<p>而每一行裡面又有三個Div代表每一格</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-jnEHEexjkeM/Wmf_roHtA4I/AAAAAAAAIUY/4t6RR_UwEP8-1I7EipD7guWU4Ddyk3d5QCLcBGAs/s640/1.png)](https://4.bp.blogspot.com/-jnEHEexjkeM/Wmf_roHtA4I/AAAAAAAAIUY/4t6RR_UwEP8-1I7EipD7guWU4Ddyk3d5QCLcBGAs/s1600/1.png)</div>

<p>所以就來透過套件的API找出每一行，並點擊每一格吧 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> (IWebDriver driver = <span class="keyword">new</span> ChromeDriver())</span><br><span class="line">            &#123;</span><br><span class="line">                driver.Navigate().GoToUrl(<span class="string">&quot;https://www.instagram.com/mercci22/&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//找到Post的Container</span></span><br><span class="line">                <span class="keyword">var</span> PostContainerElement = driver.FindElement(By.ClassName(<span class="string">&quot;_cmdpi&quot;</span>));</span><br><span class="line">                <span class="comment">//每一行</span></span><br><span class="line">                <span class="keyword">var</span> Rows = PostContainerElement.FindElements(By.ClassName(<span class="string">&quot;_70iju&quot;</span>));</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> row <span class="keyword">in</span> Rows)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> Boxs = row.FindElements(By.XPath(<span class="string">&quot;div&quot;</span>));</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> box <span class="keyword">in</span> Boxs)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//點擊每一格讓它展開Dialog</span></span><br><span class="line">                        box.Click();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>這時候如果你執行程式，應該會看到它開啟Chrome並且連到網址然後點擊每一格打開視窗</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-UIjpEynpLcA/WmgBKT9R10I/AAAAAAAAIUk/WA64zbd-g-YoQdf33ZVlrfVbXDLsYJkhACLcBGAs/s640/1.png)](https://3.bp.blogspot.com/-UIjpEynpLcA/WmgBKT9R10I/AAAAAAAAIUk/WA64zbd-g-YoQdf33ZVlrfVbXDLsYJkhACLcBGAs/s1600/1.png)</div>

<p>接著來分析彈跳出來的視窗，會發現當視窗開啟時，網頁會出現以下Div[role=’dialog’]這個元素，關閉後就會移除</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-clgYAUdg4y0/WmgBoMCshoI/AAAAAAAAIUo/E3NwCF5n5i8Cpilg7m-OChlEQEgGHOGAwCLcBGAs/s640/1.png)](https://4.bp.blogspot.com/-clgYAUdg4y0/WmgBoMCshoI/AAAAAAAAIUo/E3NwCF5n5i8Cpilg7m-OChlEQEgGHOGAwCLcBGAs/s1600/1.png)</div>

<p>所以我們要想辦法拿到這個Div Dialog，才有辦法擷取Po文的文案、日期、圖片，找到Dialog後，後面就重複上述步驟分析Tag，會發現</p>
<p><strong>圖片</strong> : 放在Div[class=’_4rbun’]底下的Img Tag<br><strong>文案&nbsp;</strong>: 放在Img Tag的Alt裡面<br><strong>時間</strong> : 放在Article &gt; div &gt; div &gt; a &gt; time這個Tag裡面</p>
<p>所以目前程式如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> (IWebDriver driver = <span class="keyword">new</span> ChromeDriver())</span><br><span class="line">            &#123;</span><br><span class="line">                driver.Navigate().GoToUrl(<span class="string">&quot;https://www.instagram.com/mercci22/&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">//找到Post的Container</span></span><br><span class="line">                <span class="keyword">var</span> PostContainerElement = driver.FindElement(By.ClassName(<span class="string">&quot;_cmdpi&quot;</span>));</span><br><span class="line">                <span class="comment">//每一行</span></span><br><span class="line">                <span class="keyword">var</span> Rows = PostContainerElement.FindElements(By.ClassName(<span class="string">&quot;_70iju&quot;</span>));</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> row <span class="keyword">in</span> Rows)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> Boxs = row.FindElements(By.XPath(<span class="string">&quot;div&quot;</span>));</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> box <span class="keyword">in</span> Boxs)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//點擊每一格讓它展開Dialog</span></span><br><span class="line">                        box.Click();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//取得Dialog底下的Article元素</span></span><br><span class="line">                        <span class="keyword">var</span> article = driver.FindElement(By.XPath(<span class="string">&quot;//div[@role=&#x27;dialog&#x27;]/div/div/article&quot;</span>));</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//如果Dialog裡面放的是影片，則_4rbun會不存在</span></span><br><span class="line">                        <span class="keyword">if</span> (article.FindElements(By.ClassName(<span class="string">&quot;_4rbun&quot;</span>)).Count == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">//跳過這則，這次目標只抓出圖片</span></span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//第一張圖</span></span><br><span class="line">                        <span class="keyword">var</span> ImgContainer = article.FindElement(By.ClassName(<span class="string">&quot;_4rbun&quot;</span>));</span><br><span class="line">                        <span class="keyword">var</span> Img = ImgContainer.FindElement(By.TagName(<span class="string">&quot;img&quot;</span>));                       </span><br><span class="line">                        <span class="keyword">var</span> Date = article.FindElement(By.XPath(<span class="string">&quot;div/div/a/time&quot;</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這時候執行的時候可能會發生Exception，原因嘗試取得Dialog底下的Artilce，但Dialog點擊後產生會有時間差導致</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-TUSU5eY99xU/WmgWjs_9uBI/AAAAAAAAIVE/QnOtvHvoW38zNLWZQ7m6NpICJluVxyc2QCLcBGAs/s640/1.png)](https://4.bp.blogspot.com/-TUSU5eY99xU/WmgWjs_9uBI/AAAAAAAAIVE/QnOtvHvoW38zNLWZQ7m6NpICJluVxyc2QCLcBGAs/s1600/1.png)</div>

<p>優化這段程式，加上Wait的限制，而Selenium提供兩種Wait的方式</p>
<div class="note info">
            <p>implicitly Wait: 預設等待，當元件暫時找不到時，會嘗試等待，直到timeout時間到。<br>Explicit Wait: 針對特別元件等待。</p><p>參考文件:<br><a href="http://selenium-python.readthedocs.io/waits.html">Selenium 5. Waits 官方文件</a></p>
          </div>

<p>我們這邊加上第一種預設等待 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">driver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(<span class="number">2</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>讀取每個Element時，如果暫時不存在兩秒後TimeOut，之後再執行看看，會發現跑到第二次box.Click()的時候跳Exception。</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-y0clUXejLl4/WmgZwH5ZmeI/AAAAAAAAIVQ/bDTSCWKn9jkNDem1AxJ-TAQPwPQpW-7hACLcBGAs/s640/1.png)](https://4.bp.blogspot.com/-y0clUXejLl4/WmgZwH5ZmeI/AAAAAAAAIVQ/bDTSCWKn9jkNDem1AxJ-TAQPwPQpW-7hACLcBGAs/s1600/1.png)</div>

<p>原因是當我們打開Dialog時，如果爬完不點擊關閉視窗，會點不到第二隔的元素</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://1.bp.blogspot.com/-gPgFjISg5XI/WmgaJ1qWtUI/AAAAAAAAIVU/ii1yaeglfDgqvpH05tnhPa8Soxe3OszjACLcBGAs/s640/1.png)](https://1.bp.blogspot.com/-gPgFjISg5XI/WmgaJ1qWtUI/AAAAAAAAIVU/ii1yaeglfDgqvpH05tnhPa8Soxe3OszjACLcBGAs/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">蓋住了第二格元素，所以要執行關閉視窗按鈕</td></tr></tbody></table>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> (IWebDriver driver = <span class="keyword">new</span> ChromeDriver())</span><br><span class="line">            &#123;</span><br><span class="line">                driver.Navigate().GoToUrl(<span class="string">&quot;https://www.instagram.com/mercci22/&quot;</span>);</span><br><span class="line">                driver.Manage().Timeouts().ImplicitWait = TimeSpan.FromSeconds(<span class="number">2</span>);</span><br><span class="line">                <span class="comment">//找到Post的Container</span></span><br><span class="line">                <span class="keyword">var</span> PostContainerElement = driver.FindElement(By.ClassName(<span class="string">&quot;_cmdpi&quot;</span>));</span><br><span class="line">                <span class="comment">//每一行</span></span><br><span class="line">                <span class="keyword">var</span> Rows = PostContainerElement.FindElements(By.ClassName(<span class="string">&quot;_70iju&quot;</span>));</span><br><span class="line">                <span class="keyword">foreach</span> (<span class="keyword">var</span> row <span class="keyword">in</span> Rows)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> Boxs = row.FindElements(By.XPath(<span class="string">&quot;div&quot;</span>));</span><br><span class="line">                    <span class="keyword">foreach</span> (<span class="keyword">var</span> box <span class="keyword">in</span> Boxs)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="comment">//點擊每一格讓它展開Dialog</span></span><br><span class="line">                        box.Click();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//取得Dialog底下的Article元素</span></span><br><span class="line">                        <span class="keyword">var</span> article = driver.FindElement(By.XPath(<span class="string">&quot;//div[@role=&#x27;dialog&#x27;]/div/div/article&quot;</span>));</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//如果Dialog裡面放的是影片，則_4rbun會不存在</span></span><br><span class="line">                        <span class="keyword">if</span> (article.FindElements(By.ClassName(<span class="string">&quot;_4rbun&quot;</span>)).Count == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">//關閉Dialog</span></span><br><span class="line">                            driver.FindElement(By.ClassName(<span class="string">&quot;_dcj9f&quot;</span>)).Click();</span><br><span class="line">                            <span class="comment">//跳過這則，這次目標只抓出圖片</span></span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//第一張圖</span></span><br><span class="line">                        <span class="keyword">var</span> ImgContainer = article.FindElement(By.ClassName(<span class="string">&quot;_4rbun&quot;</span>));</span><br><span class="line">                        <span class="keyword">var</span> Img = ImgContainer.FindElement(By.TagName(<span class="string">&quot;img&quot;</span>));</span><br><span class="line">                        <span class="keyword">var</span> Date = article.FindElement(By.XPath(<span class="string">&quot;div/div/a/time&quot;</span>));</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//關閉Dialog</span></span><br><span class="line">                        driver.FindElement(By.ClassName(<span class="string">&quot;_dcj9f&quot;</span>)).Click();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣就可以順利地走完每一格，並且把圖片、文案、時間資料都讀出來了</p>
<p>**<br>**</p>
<h4 id="多圖片的情境"><a href="#多圖片的情境" class="headerlink" title="多圖片的情境"></a><strong>多圖片的情境</strong></h4><p>加下來是應用的第二部分，Instagram是可以分享多圖片的，而多張圖片是在點擊向右按鈕後，才會動態透過JS撈出來</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-S8AFeQpjcHk/WmgbnCX9SgI/AAAAAAAAIVk/2jcAH-RsJ4cg7IN6X2_UwCWVmbNX1BJeACLcBGAs/s400/1.png)](https://4.bp.blogspot.com/-S8AFeQpjcHk/WmgbnCX9SgI/AAAAAAAAIVk/2jcAH-RsJ4cg7IN6X2_UwCWVmbNX1BJeACLcBGAs/s1600/1.png)</div>
所以必須寫程式判斷是否有這個按鈕，如果有，表示有多張圖片，要求Driver去點擊那個按鈕，並且撈取Img的Src路徑
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//第一張圖</span></span><br><span class="line">                        <span class="keyword">var</span> ImgContainer = article.FindElement(By.ClassName(<span class="string">&quot;_4rbun&quot;</span>));</span><br><span class="line">                        <span class="keyword">var</span> Img = ImgContainer.FindElement(By.TagName(<span class="string">&quot;img&quot;</span>));</span><br><span class="line">                        <span class="comment">//存放Image的Src List</span></span><br><span class="line">                        List&lt;<span class="built_in">string</span>&gt; ImgUrls = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt; &#123; Img.GetAttribute(<span class="string">&quot;src&quot;</span>) &#125;;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//如果有第二張圖以上,則會出現a[class=&#x27;&#x27;_8kphn _by8kl coreSpriteRightChevron&#x27;]</span></span><br><span class="line">                        <span class="comment">//直到不再出現表示最後一張圖到了</span></span><br><span class="line">                        <span class="keyword">while</span> (article.FindElements(By.CssSelector(<span class="string">&quot;a[class=&#x27;_8kphn _by8kl coreSpriteRightChevron&#x27;]&quot;</span>)).Count &gt; <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="comment">//點擊按鈕</span></span><br><span class="line">                            <span class="keyword">var</span> nextBtn = article.FindElement(By.CssSelector(<span class="string">&quot;a[class=&#x27;_8kphn _by8kl coreSpriteRightChevron&#x27;]&quot;</span>));</span><br><span class="line">                            nextBtn.Click();</span><br><span class="line"></span><br><span class="line">                            <span class="comment">//因為Instagram是透過同一個Img Tag動態去換Src，因為程式點擊下一張按鈕太快</span></span><br><span class="line">                            <span class="comment">//會導致有Img Tag存在，但Src還來不及換，導致抓到空白的Src</span></span><br><span class="line">                            <span class="comment">//所以不是元素沒出現的問題，只好要求Thread換下一張圖時先暫停0.5秒再抓</span></span><br><span class="line">                            Thread.Sleep(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">                            Img = ImgContainer.FindElement(By.TagName(<span class="string">&quot;img&quot;</span>));</span><br><span class="line">                            ImgUrls.Add(Img.GetAttribute(<span class="string">&quot;src&quot;</span>));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這樣就能順利拿到多張圖的路徑了</p>
<h4 id="讀取第二頁的情境"><a href="#讀取第二頁的情境" class="headerlink" title="讀取第二頁的情境"></a>讀取第二頁的情境</h4><div>Instagram是滑鼠移到最下方才會動態載入第二頁，所以需要能控制視窗移到最下方來觸發它</div>```csharp
IJavaScriptExecutor js = (IJavaScriptExecutor)driver;
            //如果爬完第一頁還沒爬完，則執行JS讓視窗滾到最下方，觸發讀取第二頁
            js.ExecuteScript("window.scrollTo(0,1000000)");

<p>```</p>
<p>目前綜合以上所提的應用，應該已經能完全將Instagram的網站資料爬回來，只能說Selenium真的是一個強大的東西阿!!</p>
<p>參考文章:<br><a href="http://www.hosp.ncku.edu.tw/mis/48-netdisk/57-xml-xpath.html">XML XPath的選擇節點語法</a><br><a href="http://www.seleniumhq.org/docs/">Selenium Documentation</a></p>
]]></content>
      <tags>
        <tag>Selenium</tag>
      </tags>
  </entry>
  <entry>
    <title>【生產力】Code Snippet</title>
    <url>/2018/07/11/%E3%80%90%E7%94%9F%E7%94%A2%E5%8A%9B%E3%80%91Code%20Snippet/</url>
    <content><![CDATA[<h1 id="什麼是Code-Snippet"><a href="#什麼是Code-Snippet" class="headerlink" title="#什麼是Code Snippet"></a>#什麼是Code Snippet</h1><p>從字面來看是程式碼片段，如果已經寫程式一段時間應該都有用到過，例如在Visual Studio打上Switch後按兩下Tab自動產生的程式碼就是Code Snippet功能做出來的。</p>
<p><img src="/images/20180711/1.png" alt="/images/20180711/1.png"></p>
<p><img src="/images/20180711/2.jpg" alt="/images/20180711/2.jpg"></p>
<p>所以將常常重複寫的程式碼做成Code Snippet是一件很方便的事情</p>
<h1 id="如何自訂"><a href="#如何自訂" class="headerlink" title="#如何自訂"></a>#如何自訂</h1><p>因為寫單元測試常常需要寫3A原則,所以把它做成Code Snippet就可以重用。</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span>/ arrange</span></span><br><span class="line"><span class="keyword">var</span> sut = GetSystemUnderTest();</span><br><span class="line"><span class="keyword">var</span> expected = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span>/ act</span></span><br><span class="line"><span class="keyword">var</span> actual = sut.DoSomething();</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span>/ assert</span></span><br></pre></td></tr></table></figure>



<h2 id="建立3A-Pattern-snippet的檔案"><a href="#建立3A-Pattern-snippet的檔案" class="headerlink" title="建立3A Pattern.snippet的檔案"></a>建立3A Pattern.snippet的檔案</h2><p>打開一個記事本命名成3A Pattern，然後副檔名儲存成.snippet</p>
<p><img src="/images/20180711/3.jpg"></p>
<h2 id="撰寫內容"><a href="#撰寫內容" class="headerlink" title="撰寫內容"></a>撰寫內容</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">CodeSnippets</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/VisualStudio/2005/CodeSnippet&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">CodeSnippet</span> <span class="attr">Format</span>=<span class="string">&quot;1.0.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Header</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">SnippetTypes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">SnippetType</span>&gt;</span>Expansion<span class="tag">&lt;/<span class="name">SnippetType</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">SnippetType</span>&gt;</span>SurroundsWith<span class="tag">&lt;/<span class="name">SnippetType</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">SnippetTypes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Title</span>&gt;</span>你的Code Snippet名稱<span class="tag">&lt;/<span class="name">Title</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Author</span>&gt;</span>Steven<span class="tag">&lt;/<span class="name">Author</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Description</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Description</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">HelpUrl</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">HelpUrl</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Shortcut</span>&gt;</span>你想要呼叫時的代碼<span class="tag">&lt;/<span class="name">Shortcut</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Snippet</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Declarations</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Literal</span> <span class="attr">Editable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ID</span>&gt;</span>變數ID<span class="tag">&lt;/<span class="name">ID</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ToolTip</span>&gt;</span>變數描述<span class="tag">&lt;/<span class="name">ToolTip</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Default</span>&gt;</span>預設值<span class="tag">&lt;/<span class="name">Default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Function</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">Function</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Literal</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Declarations</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Code</span> <span class="attr">Language</span>=<span class="string">&quot;csharp&quot;</span> <span class="attr">Delimiter</span>=<span class="string">&quot;$&quot;</span>&gt;</span>&lt;![CDATA[</span><br><span class="line">		......</span><br><span class="line">         放入程式碼的地方        </span><br><span class="line">		......</span><br><span class="line">        ]]&gt;<span class="tag">&lt;/<span class="name">Code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Snippet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">CodeSnippet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">CodeSnippets</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>依據上面的Template,將3A Pattern Code Snippet改成</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">CodeSnippets</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.microsoft.com/VisualStudio/2005/CodeSnippet&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">CodeSnippet</span> <span class="attr">Format</span>=<span class="string">&quot;1.0.0&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Header</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">SnippetTypes</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">SnippetType</span>&gt;</span>Expansion<span class="tag">&lt;/<span class="name">SnippetType</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">SnippetType</span>&gt;</span>SurroundsWith<span class="tag">&lt;/<span class="name">SnippetType</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">SnippetTypes</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Title</span>&gt;</span>3A Pattern<span class="tag">&lt;/<span class="name">Title</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Author</span>&gt;</span>Steven<span class="tag">&lt;/<span class="name">Author</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Description</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Description</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">HelpUrl</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">HelpUrl</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Shortcut</span>&gt;</span>aaa<span class="tag">&lt;/<span class="name">Shortcut</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Snippet</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Declarations</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Literal</span> <span class="attr">Editable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ID</span>&gt;</span>expected<span class="tag">&lt;/<span class="name">ID</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ToolTip</span>&gt;</span>expected<span class="tag">&lt;/<span class="name">ToolTip</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Default</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Function</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">Function</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Literal</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Literal</span> <span class="attr">Editable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ID</span>&gt;</span>DoSomthing<span class="tag">&lt;/<span class="name">ID</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">ToolTip</span>&gt;</span>DoSomthing<span class="tag">&lt;/<span class="name">ToolTip</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Default</span>&gt;</span>DoSomething()<span class="tag">&lt;/<span class="name">Default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">Function</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">Function</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Literal</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">Declarations</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">Code</span> <span class="attr">Language</span>=<span class="string">&quot;csharp&quot;</span> <span class="attr">Delimiter</span>=<span class="string">&quot;$&quot;</span>&gt;</span>&lt;![CDATA[</span><br><span class="line">        //// arrange</span><br><span class="line">        var sut = GetSystemUnderTest();</span><br><span class="line">        var expected = $expected$;</span><br><span class="line">        </span><br><span class="line">        //// act</span><br><span class="line">        var actual = sut.$DoSomthing$;</span><br><span class="line">        </span><br><span class="line">        //// assert</span><br><span class="line">        ]]&gt;<span class="tag">&lt;/<span class="name">Code</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Snippet</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">CodeSnippet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">CodeSnippets</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>$變數$</strong> , 兩個前字號中間的就是變數ID,在Snippet &gt; Declarations &gt;  Literal 設定變數相關值</p>
<h1 id="匯入Visual-Studio"><a href="#匯入Visual-Studio" class="headerlink" title="#匯入Visual Studio"></a>#匯入Visual Studio</h1><p>最後一步就是匯入Visual Studio中,點擊<strong>工具</strong> &gt; <strong>程式碼片段管理員</strong></p>
<p><img src="/images/20180711/4.jpg" alt="/images/20180711/4.jpg"></p>
<p>點擊<strong>匯入</strong>，選擇剛剛的3A Pattern.snippet檔案</p>
<p><img src="/images/20180711/5.jpg" alt="/images/20180711/5.jpg"></p>
<p>匯入到<strong>My Code Snippets</strong> &gt; <strong>完成</strong> ，就可以看到3A Pattern了</p>
<p><img src="/images/20180711/6.jpg" alt="/images/20180711/6.jpg"></p>
<p><img src="/images/20180711/7.jpg" alt="/images/20180711/7.jpg"></p>
<h1 id="結果"><a href="#結果" class="headerlink" title="#結果"></a>#結果</h1><p>在程式碼中打aaa加兩次Tab就會呼叫出我們設定的Code Snippet</p>
<p><img src="/images/20180711/8.jpg" alt="/images/20180711/8.jpg"></p>
<p><img src="/images/20180711/9.jpg" alt="/images/20180711/9.jpg"></p>
<div class="note info">
            <p><strong>參考文章</strong></p><p><a href="https://msdn.microsoft.com/zh-tw/library/ms165394.aspx">逐步解說：建立程式碼片段</a></p>
          </div>]]></content>
      <tags>
        <tag>生產力</tag>
      </tags>
  </entry>
  <entry>
    <title>【神奇事件】看不見的點</title>
    <url>/2017/01/11/%E3%80%90%E7%A5%9E%E5%A5%87%E4%BA%8B%E4%BB%B6%E3%80%91%E7%9C%8B%E4%B8%8D%E8%A6%8B%E7%9A%84%E9%BB%9E/</url>
    <content><![CDATA[<p>最近遇到一個Token怎麼送都錯誤的問題，找遍了程式都找不到原因出在哪，最後沒招只好把傳輸的封包都截下來，看看到底哪邊出了問題，結果發現….</p>
<div class="note info">
            <p>“Te6g5R?”</p>
          </div>

<p>這串部分Token看起來沒有什麼特別的，但如果你把滑鼠放到最後”的位置開始用鍵盤的往前鍵遍覽整串字，你會發現在R”中間需要按兩次才跳得過去，從封包監視器看到的結果卻是多了一個”點”</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-XRCi-hr6diU/WHWjX1QA3RI/AAAAAAAAIDI/qTjeVZqBPm0M81EFKCe0Q1b_8UnOHU7dACLcB/s640/1.png)](https://4.bp.blogspot.com/-XRCi-hr6diU/WHWjX1QA3RI/AAAAAAAAIDI/qTjeVZqBPm0M81EFKCe0Q1b_8UnOHU7dACLcB/s1600/1.png)</div>保哥有篇文章提到類似的問題 : <span style="font-size: x-small;">&nbsp;</span>[魔鬼般的細節：使用 C# 的 String.Trim() 方法刪除空白字元](http://blog.miniasp.com/post/2014/01/15/C-Sharp-String-Trim-ZWSP-Zero-width-space.aspx)

<p>雖然我碰到的字元跟文章中碰到的不同，但應該是類似的問題，用BackSpace把那個看不到的點移除掉後，API就都正常了。</p>
<p>紀錄一下，提醒自己以後可能是因為這種…..奇怪的事情導致的，不要只顧著埋頭找程式Bug</p>
<p><strong><span style="color: red;">#更新</span></strong><br>那個看不見的點應該是 : <a href="http://www.fileformat.info/info/unicode/char/200b/index.htm">Unicode Character ‘ZERO WIDTH SPACE’</a><span style="background-color: white; color: #333333; font-family: &quot;open sans&quot; , &quot;helvetica neue&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif;">&nbsp;</span></p>
]]></content>
      <tags>
        <tag>神奇事件</tag>
      </tags>
  </entry>
  <entry>
    <title>【英文】Down the line</title>
    <url>/2018/10/24/%E3%80%90%E8%8B%B1%E6%96%87%E3%80%91Down%20the%20line/</url>
    <content><![CDATA[<p>幾天前聽強者我同事上課提到寫部落格跟筆記的重要，想一想的確自己這樣斷斷續續也寫了 5~6 年左右，漸漸也陷入了一種迷失之中</p>
<blockquote>
<p>這篇的內容隨便google就有答案了還需要寫嗎？</p>
</blockquote>
<p>但忘了最初寫部落格的初衷不是為了給誰看，而是想記錄遇到的難題跟解決的方法，幫助自己能快速查找並系統的學習解。<del>我的部落格其實也沒啥人看，不知道有啥好包袱的</del></p>
<p>重點一直都不在有沒有人想看，而是我從中又學到了什麼，所以打算來寫幾篇會長期更新的學習筆記，可能包含 AWS、英文、日文..等。希望幾年後，這些會成為自己的能量與成長的基石。</p>
<h1 id="Down-the-line"><a href="#Down-the-line" class="headerlink" title="Down the line"></a>Down the line</h1><h4 id="未來"><a href="#未來" class="headerlink" title="未來"></a>未來</h4><p>從字面解釋就是「沿著線往下」，有<code>過段時間</code>、<code>未來</code>的意思，</p>
<p>例句 ：</p>
<blockquote>
<p>Pick one OS for your production set-up. No need to get master of every OS out there. It would make your job diffcult down the line.</p>
<p>選一種 OS 做為你生產的設置，你不需要精通每一種 OS ，這只會讓你之後的工作變得困難。</p>
</blockquote>
<blockquote>
<p>If you don’t learn English now , you will get many problems down the line.</p>
<p>如果你現在不學習英文, 那你將來會碰到許多問題的</p>
</blockquote>
<h4 id="徹底、始終"><a href="#徹底、始終" class="headerlink" title="徹底、始終"></a>徹底、始終</h4><p>例句 ：</p>
<blockquote>
<p>Errors are to be found down the line.</p>
<p>錯誤總有一天會被找到的</p>
</blockquote>
<blockquote>
<p>If something should be yours , that will be yours down the line.</p>
<p>屬於你的,終究會是你的</p>
</blockquote>
]]></content>
      <tags>
        <tag>英文學習</tag>
      </tags>
  </entry>
  <entry>
    <title>【生產力】SmartPaster</title>
    <url>/2017/03/13/%E3%80%90%E7%94%9F%E7%94%A2%E5%8A%9B%E3%80%91SmartPaster/</url>
    <content><![CDATA[<p>常常我會在SSMS上面撰寫SQL語法，等到確定之後才會把他挪到專案內，這時候就會碰到要補上前後雙引號或是跳脫字元等問題，以前都會笨笨的一行一行慢慢改，直到朋友介紹我一款<strike>好藥</strike>好套件<strong>SmartPaster</strong></p>
<div>**
**</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-z9hPIDANTMo/WMX_dl7i0HI/AAAAAAAAIFE/PS6PSdkYy4w1lh-BSUYlR608rsaAfU89wCLcB/s1600/1.png)](https://2.bp.blogspot.com/-z9hPIDANTMo/WMX_dl7i0HI/AAAAAAAAIFE/PS6PSdkYy4w1lh-BSUYlR608rsaAfU89wCLcB/s1600/1.png)</div><div>**
**</div><div>
<div class="note info">
            <p>下載位置 : <a href="https://marketplace.visualstudio.com/items?itemName=martinw.SmartPaster2013">https://marketplace.visualstudio.com/items?itemName=martinw.SmartPaster2013</a></p>
          </div>


<p>它的功用是做什麼呢? 我想直接看圖就一目了然了</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-QzoRYhI2WNg/WMYAOrkP_DI/AAAAAAAAIFI/7dsnic6h8wohlRxmfLkli7y7krZfv5URACLcB/s1600/1.png)](https://4.bp.blogspot.com/-QzoRYhI2WNg/WMYAOrkP_DI/AAAAAAAAIFI/7dsnic6h8wohlRxmfLkli7y7krZfv5URACLcB/s1600/1.png)</div>

<p>只要你複製好任何字串，這邊以這串為例</p>
<div class="note info">
            <p>select *<br>from Employee</p>
          </div>
<p>到VS裡面的時候點擊右鍵 &gt;&gt; Paste As… &gt;&gt; 選擇你要貼上的格式，登登~~~</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-Z0tq9CXFV1M/WMYBiGjJ7DI/AAAAAAAAIFU/8sWywyAkPfQRAE3w9FS-AJn7KJAyjH7cACLcB/s1600/1.png)](https://3.bp.blogspot.com/-Z0tq9CXFV1M/WMYBiGjJ7DI/AAAAAAAAIFU/8sWywyAkPfQRAE3w9FS-AJn7KJAyjH7cACLcB/s1600/1.png)</div>

<p>自動就會幫你補上可以執行的程式了，不用再自己前後雙引號、跳脫字元等等，搞到格式大亂啦!!!! YES</div></p>
]]></content>
      <tags>
        <tag>生產力</tag>
      </tags>
  </entry>
  <entry>
    <title>【英文】About time</title>
    <url>/2018/10/31/%E3%80%90%E8%8B%B1%E6%96%87%E3%80%91About%20time/</url>
    <content><![CDATA[<p>這篇是要記錄關於一些時間的用法</p>
<h1 id="On-time"><a href="#On-time" class="headerlink" title="On time"></a>On time</h1><p>『片語』 準時; 準點</p>
<p>例句 ：</p>
<blockquote>
<p>The train is always on time.</p>
<p>這班火車總是非常準時</p>
</blockquote>
<blockquote>
<p>Ruth  never  arrives office on time.</p>
<p>魯斯總是沒有準時到公司</p>
</blockquote>
<h1 id="In-time"><a href="#In-time" class="headerlink" title="In time"></a>In time</h1><p>『片語』 即時;最後</p>
<p>例句 ：</p>
<blockquote>
<p>I arrived at the office in time for the meeting.</p>
<p>我及時趕上了公司的會議</p>
</blockquote>
<blockquote>
<p>I finished the test in time</p>
<p>我在最後一秒完成考試</p>
</blockquote>
<h1 id="Time-off"><a href="#Time-off" class="headerlink" title="Time off"></a>Time off</h1><p>『片語』 請假;休假</p>
<p>例句 ：</p>
<blockquote>
<p>I have some time off in July, so I’m going to the beach.</p>
<p>我在7月有一些假日，所以我應該會去海邊</p>
</blockquote>
<blockquote>
<p>I can’t take time off to go to Iceland</p>
<p>我不能請假去冰島</p>
</blockquote>
<h1 id="Time-out"><a href="#Time-out" class="headerlink" title="Time out"></a>Time out</h1><p>『片語』 暫停;休息時間</p>
<p>例句 ：</p>
<blockquote>
<p>I need to take some time out( time off ). I’ve been very stressed at work recently.</p>
<p>我需要一些休息時間.最近工作壓力太大</p>
</blockquote>
<h1 id="About-time"><a href="#About-time" class="headerlink" title="About time"></a>About time</h1><p>『片語』 是時候了</p>
<p>例句 ：</p>
<blockquote>
<p>It’s about time to go to Iceland.</p>
<p>是時候該去冰島了</p>
</blockquote>
<h1 id="Spend-time"><a href="#Spend-time" class="headerlink" title="Spend time"></a>Spend time</h1><p>花時間</p>
<p>例句 : </p>
<blockquote>
<p>I’m going to spend some time with my grandmother at the weekend.</p>
<p>我這週末會花些時間陪祖母</p>
</blockquote>
<h1 id="Kill-time"><a href="#Kill-time" class="headerlink" title="Kill time"></a>Kill time</h1><p>殺時間</p>
<p>例句：</p>
<blockquote>
<p>I love to kill time in the afternoon by reading a good book.</p>
<p>我喜歡花整個下午的時間讀本好書</p>
</blockquote>
<h1 id="Waste-time"><a href="#Waste-time" class="headerlink" title="Waste time"></a>Waste time</h1><p>浪費時間</p>
<p>例句 : </p>
<blockquote>
<p>I waste so much time using the internet on my phone.</p>
<p>我浪費很多時間在用手機上網</p>
</blockquote>
<h1 id="Pressed-for-time"><a href="#Pressed-for-time" class="headerlink" title="Pressed for time"></a>Pressed for time</h1><p>『片語』 時間緊迫</p>
<p>例句 ：</p>
<blockquote>
<p>Sorry, I can’t talk at the moment, I’m a bit pressed for time.</p>
<p>抱歉, 我現在無法說話, 因為我時間有點緊迫</p>
</blockquote>
<h1 id="Save-time"><a href="#Save-time" class="headerlink" title="Save time"></a>Save time</h1><p>『片語』 節省時間</p>
<p>例句 ：</p>
<blockquote>
<p>You can save time by using an electronic dictionary.</p>
<p>用電子辭典可以替你省下很多時間</p>
</blockquote>
]]></content>
      <tags>
        <tag>英文學習</tag>
      </tags>
  </entry>
  <entry>
    <title>【重構系列】(三) 單一職責原則(Single Responsibility Principle , SRP)</title>
    <url>/2016/08/18/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%B8%89-%E5%96%AE%E4%B8%80%E8%81%B7%E8%B2%AC%E5%8E%9F%E5%89%87-Single-Responsibility-Principle-SRP/</url>
    <content><![CDATA[<p>SourceCode :&nbsp;<a href="https://github.com/toyo0103/Demo_EditTemplate_1">https://github.com/toyo0103/Demo_EditTemplate_1</a></p>
<p>這邊提供幾篇覺得很棒的文章，看完其實也可以略過這篇了XD</p>
<p>&nbsp;1.&nbsp;<a href="https://msdn.microsoft.com/zh-tw/library/dn155886.aspx">30天快速上手 TDD Day 12 - Refactoring - 職責分離 &nbsp;By 91</a></p>
<p>&nbsp;2. <a href="https://dotblogs.com.tw/hatelove/archive/2010/10/16/single-responsibility-principle.aspx">[ASP.NET]91之ASP.NET由淺入深 不負責講座 Day17 – 單一職責原則</a></p>
<p>&nbsp;3.&nbsp;<a href="https://vinta.ws/booch/?p=101">Clean code: 無瑕的程式碼 – 書摘心得（二）</a></p>
<p>好的!!誠如上面幾篇文章提到的，我對於SRP的理解是「<strong>每個類別應該都只有一個理由被修改</strong>」。 其實看起來很簡單但卻又抽象到頭痛，之前寫程式時常常為了分離程式碼而頭痛不已，不可否認的是，全部寫成一起在開發上又快又方便，但這其實無形中堆高了技術債，為了在改動需求或修改程式時，要嘛就從頭看到尾找出其中的一兩行改，要嘛就是乾脆重寫，因為互相綁得太死了，牽一髮動全身阿(遠目)</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-cYpekfGnPkg/V7UdvdmnldI/AAAAAAAAH84/MR0-YMqszPUeIoiFGPID_Tmx_ERoWnO0wCLcB/s320/srp.jpg)](https://2.bp.blogspot.com/-cYpekfGnPkg/V7UdvdmnldI/AAAAAAAAH84/MR0-YMqszPUeIoiFGPID_Tmx_ERoWnO0wCLcB/s1600/srp.jpg)</td></tr><tr><td class="tr-caption" style="text-align: center;">如果想在這萬能的瑞士刀加上一個新型刀片，除了重做一個更長的基座，似乎無解阿....</td></tr></tbody></table>

<p><span style="font-size: large;">一、分析</span></p>
<p>讓我們來看看原本的程式中哪邊明顯的沒有單一職責?</p>
<p>**<br>**<strong>Application層</strong><br>**<br>**傳入Channel ID,透過IPOISerice取得對應的POI資料並且回傳資料，看起來職責非常明確</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        IPOIService _POIService;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HomeController</span>(<span class="params">IPOIService poiService</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//POIService改成依賴介面IPOIService</span></span><br><span class="line">            <span class="comment">//並且實體是由外部來決定，也就是所謂的依賴注入DI</span></span><br><span class="line">            _POIService = poiService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>(<span class="params"><span class="built_in">string</span> id</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//依賴外部注入的IPOIService介面</span></span><br><span class="line">            <span class="keyword">var</span> POIs = _POIService.Get(id);</span><br><span class="line">            <span class="keyword">return</span> Json(POIs,JsonRequestBehavior.AllowGet);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><strong>Repository層</strong></p>
<p>看起來兩個供應商的Repository也都恰如其分的只撈自己所屬的資料，職責明確，要改哪個供應商撈資料的方式，打開對應的Repository檔案即可，腎好腎好 (難道肝不好嗎?)<br>**<br>**</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> POI A供應商</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">ASupplierRepository</span> : <span class="title">ISupplierRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//隨機建立十筆Supplier為A的資料回傳</span></span><br><span class="line">            <span class="keyword">var</span> fixture = <span class="keyword">new</span> Fixture();</span><br><span class="line">            <span class="keyword">var</span> Result = fixture.Build&lt;POI&gt;()</span><br><span class="line">                            .With(x =&gt; x.Name, <span class="built_in">string</span>.Concat(<span class="string">&quot;捷運&quot;</span>, rnd.Next(<span class="number">1</span>, <span class="number">100</span>)))</span><br><span class="line">                            .With(x =&gt; x.Supplier, SupplierEnum.A)</span><br><span class="line">                            .CreateMany().ToList();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> POI B供應商</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">BSupplierRepository</span> : <span class="title">ISupplierRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//隨機建立十筆Supplier為B的資料回傳</span></span><br><span class="line">            <span class="keyword">var</span> fixture = <span class="keyword">new</span> Fixture();</span><br><span class="line">            <span class="keyword">var</span> Result = fixture.Build&lt;POI&gt;()</span><br><span class="line">                            .With(x =&gt; x.Name, <span class="built_in">string</span>.Concat(<span class="string">&quot;捷運&quot;</span>, rnd.Next(<span class="number">1</span>, <span class="number">100</span>)))</span><br><span class="line">                            .With(x =&gt; x.Supplier, SupplierEnum.B)</span><br><span class="line">                            .CreateMany().ToList();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>**</p>
<hr>
<p>**<strong>Service層</strong><br>**</p>
<hr>
<p>**</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">POIService</span> :<span class="title">IPOIService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;POI&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> channel = GetChannel(channelID);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//逐一搜尋頻道底下的各類別</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> category <span class="keyword">in</span> channel.Categorys)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//依據該類別所指定的供應商向Repository要資料</span></span><br><span class="line">                category.Supplier.ForEach(x =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> Repository = SupplierFactory.Generate(x);</span><br><span class="line">                    <span class="keyword">var</span> POIs = Repository.Get();</span><br><span class="line">                    Result.AddRange(POIs);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//並接總合的結果回傳</span></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 模擬頻道類別對應表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;channelID&quot;&gt;</span>The channel identifier.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Channel.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">Channel <span class="title">GetChannel</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (channelID == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">                &#123;</span><br><span class="line">                    ID = <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                    Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">new</span> Channel.Category</span><br><span class="line">                        &#123;</span><br><span class="line">                            Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                            Supplier =<span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">            &#123;</span><br><span class="line">                ID = channelID,</span><br><span class="line">                Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">new</span> Channel.Category</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                        Supplier = <span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A , SupplierEnum.B &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>讓我們用人話的方式說說它目前都做了啥(驚世劇場口氣)!!</p>
<ul>
<li>  Get() : 傳入Channel ID,先呼叫私有方法GetChannel，取得該頻道該有的類別跟對應POI廠商表，然後依據POI廠商去跟源頭Repository要資料</li>
<li>  GetChannel() : 傳入Channel ID，取回該頻道該有的類別與對應的POI廠商表</li>
</ul>
<p>如果今天我要修改<strong>取POI源頭資料的邏輯</strong>，我要打開POIService修改。</p>
<p>如果今天我要修改<strong>取頻道與廠商的對應表邏輯，或是接上真實的DB資料</strong>，我也要打開POIService修改</p>
<p>對於POIService來說，它的職責已經包含兩個不同面向的事情了，所以在這邊我們要抽離<strong>取頻道與廠商的對應表邏輯</strong>到專屬負責的類別去，來符合SRP</p>
<span style="font-size: large;">
</span><span style="font-size: large;">二、重構開始</span>
<span style="font-size: large;">
</span>首先在**Service層**建立專屬的類別來取頻道與廠商的對應表，所以這邊建立一個**ChannelService**，然後將原本屬於POIService的邏輯搬到這邊來

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChannelService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 模擬頻道類別對應表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;channelID&quot;&gt;</span>The channel identifier.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Channel.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Channel <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (channelID == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">                &#123;</span><br><span class="line">                    ID = <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                    Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">new</span> Channel.Category</span><br><span class="line">                        &#123;</span><br><span class="line">                            Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                            Supplier =<span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">            &#123;</span><br><span class="line">                ID = channelID,</span><br><span class="line">                Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">new</span> Channel.Category</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                        Supplier = <span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A , SupplierEnum.B &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>把原本不該屬於POIService的程式碼刪除，改成如下 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">POIService</span> :<span class="title">IPOIService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;POI&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//取得ChannelService實體，取得Channel對應供應商資料</span></span><br><span class="line">            <span class="keyword">var</span> channelService = <span class="keyword">new</span> ChannelService();</span><br><span class="line">            <span class="keyword">var</span> channel = channelService.Get(channelID);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//逐一搜尋頻道底下的各類別</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> category <span class="keyword">in</span> channel.Categorys)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//依據該類別所指定的供應商向Repository要資料</span></span><br><span class="line">                category.Supplier.ForEach(x =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> Repository = SupplierFactory.Generate(x);</span><br><span class="line">                    <span class="keyword">var</span> POIs = Repository.Get();</span><br><span class="line">                    Result.AddRange(POIs);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//並接總合的結果回傳</span></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下來是不是因為達成職責分離了，所以大家可以手拉手一起去吃冰快樂的下午茶了阿。<br>如果是的話請到旁邊面壁思過(拍掉已經牽起來的手)，**說好的高內聚低耦合呢? 說好的IOC與DI呢 ? 說好的面對抽象呢? **(左手心拍右手背)</p>
<ul>
<li><p>隔離ChannelService，建立Interface</p>
  <div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-CbLQzZGAVWA/V7Uk_BjnrQI/AAAAAAAAH9I/2X3Wh9Igf34lYISJFe19Tu2pANOaX6tUgCLcB/s1600/1.png)](https://2.bp.blogspot.com/-CbLQzZGAVWA/V7Uk_BjnrQI/AAAAAAAAH9I/2X3Wh9Igf34lYISJFe19Tu2pANOaX6tUgCLcB/s1600/1.png)</div>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IChannelService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">Channel <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li><p>POIService透過DI與IOC的概念，面對IChannelService而非實體 ```csharp<br>public class POIService :IPOIService<br>  {</p>
<pre><code>  IChannelService _ChannelService;
  public POIService(IChannelService channelService)
  &#123;
      //DI
      _ChannelService = channelService;
  &#125;

      public List&lt;POI&gt; Get(string channelID)
  &#123;
      var Result = new List&lt;POI&gt;();

          //面對抽象
      var channel = _ChannelService.Get(channelID);

          //逐一搜尋頻道底下的各類別
      foreach (var category in channel.Categorys)
      &#123;
          //依據該類別所指定的供應商向Repository要資料
          category.Supplier.ForEach(x =&gt;
          &#123;
              var Repository = SupplierFactory.Generate(x);
              var POIs = Repository.Get();
              Result.AddRange(POIs);
          &#125;);
      &#125;

          //並接總合的結果回傳
      return Result;
  &#125;
</code></pre>
<p>  }</p>
</li>
</ul>
<p>```</p>
<ul>
<li>  別忘記到Unity把Interface與實體的關係註冊起來<div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-vp--aOOPX5s/V7UmVz9p1sI/AAAAAAAAH9M/bZNYIW4-xJ4ckr5k11B_jWgSrr55nn5oQCLcB/s1600/1.png"><img src="https://3.bp.blogspot.com/-vp--aOOPX5s/V7UmVz9p1sI/AAAAAAAAH9M/bZNYIW4-xJ4ckr5k11B_jWgSrr55nn5oQCLcB/s640/1.png"></a></div><span style="font-size: large;"><br></span><span style="font-size: large;"><br></span><span style="font-size: large;"><br></span><span style="font-size: large;"><br></span><span style="font-size: large;">三、小結</span><span style="font-size: large;">
</span>看看執行的結果是否正常
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-rn9m0xATZ2A/V7Umyyoz9_I/AAAAAAAAH9U/rAETSPwprloEh1HSjPDpP3v0Cq0iAp_gACLcB/s640/1.png)](https://3.bp.blogspot.com/-rn9m0xATZ2A/V7Umyyoz9_I/AAAAAAAAH9U/rAETSPwprloEh1HSjPDpP3v0Cq0iAp_gACLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">妥妥的阿!!!</td></tr></tbody></table>
所以這邊我們重構了Service的部分，讓它職責更為明確，而且也用了前幾篇提到的物件導向觀念，讓彼此是互相合作但是又具有高獨立性的。</li>
</ul>
<p>如果現在真的想把取Channel的對應資料改去接DB，我們只要打開<strong>ChannelService</strong>去接對應的Repository即可，其他地方都不會動到。</p>
<p>如果現在是主管說Demo的時候要用假資料，正式機要接DB取真實的Channel資料，那我們只要保留原本<strong>ChannelService，</strong>另外寫一個<strong>ChannelFromDBService</strong>，然後都實做<span style="color: #bf9000;">IChannelService</span>，並且在Unity那邊做個開關動態改變註冊的實體即可</p>
<p>應該有漸漸感受到，物件導向對於變動這件事情的高擴展性與可維護性了，相信天下沒有不改需求的PM，所以也就不可能有不改版的軟體了阿(再次遠目)</p>
<p>最後記住一件事情，<strong>「別讓你的Code又臭又長」</strong>，那麼下回見啦~</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-NHl1LCbQLR0/V7UoU2H1ijI/AAAAAAAAH9g/1CJwhDpona4tNKcNlesR5HCDoruhHCvVgCLcB/s320/687474703a2f2f692e696d6775722e636f6d2f63464a6b6638692e6a7067.jpg)](https://2.bp.blogspot.com/-NHl1LCbQLR0/V7UoU2H1ijI/AAAAAAAAH9g/1CJwhDpona4tNKcNlesR5HCDoruhHCvVgCLcB/s1600/687474703a2f2f692e696d6775722e636f6d2f63464a6b6638692e6a7067.jpg)</div>]]></content>
      <tags>
        <tag>C#</tag>
        <tag>Refactor</tag>
      </tags>
  </entry>
  <entry>
    <title>【重構系列】(二) DI與IOC</title>
    <url>/2016/08/17/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%BA%8C-DI%E8%88%87IOC/</url>
    <content><![CDATA[<p>SourceCode :&nbsp;<a href="https://github.com/toyo0103/Demo_EditTemplate_1">https://github.com/toyo0103/Demo_EditTemplate_1</a></p>
<p>依據前一篇延續，接著我們把焦點放在Application與Service之間的狀況</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-urWNSzGdlp8/V7O6-tD1woI/AAAAAAAAH6w/z2GwsqBn9hANkslSqNpALNAuRiBIuuI4ACLcB/s400/1.png)](https://3.bp.blogspot.com/-urWNSzGdlp8/V7O6-tD1woI/AAAAAAAAH6w/z2GwsqBn9hANkslSqNpALNAuRiBIuuI4ACLcB/s1600/1.png)</div>
前一篇有提到程式應該要面對**抽象**避免高耦合的情況發生，改一髮進而動全身，所以有用**介面**的方式去處理

<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-O7kXIwvgtDk/V7O7kOH1D0I/AAAAAAAAH60/M49OysRZ7R4LxOLv4UNE9WJVLBBpsICJwCLcB/s400/1.png)](https://3.bp.blogspot.com/-O7kXIwvgtDk/V7O7kOH1D0I/AAAAAAAAH60/M49OysRZ7R4LxOLv4UNE9WJVLBBpsICJwCLcB/s1600/1.png)</div>

<p>然而來看看目前實際的程式狀況 : <strong>直接耦合</strong></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-csgLbuLY5Dw/V7O9BEEADYI/AAAAAAAAH7A/n6mzb9hYUiksdAHYuQmBXuH6aPO0Sk8-wCLcB/s400/1.png)](https://4.bp.blogspot.com/-csgLbuLY5Dw/V7O9BEEADYI/AAAAAAAAH7A/n6mzb9hYUiksdAHYuQmBXuH6aPO0Sk8-wCLcB/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-LkVwTAXMQHc/V7O9TcpERgI/AAAAAAAAH7I/18cwMlw6YtQxVKhppexI25lzS--gxIIagCLcB/s400/1.png)](https://2.bp.blogspot.com/-LkVwTAXMQHc/V7O9TcpERgI/AAAAAAAAH7I/18cwMlw6YtQxVKhppexI25lzS--gxIIagCLcB/s1600/1.png)</div>

<p>這邊會談到兩個用來解開這種狀況的觀念</p>
<ul>
<li>  <strong><span style="color: red;">依賴注入</span></strong>(Dependency Injection)簡稱DI</li>
<li>  **<span style="color: red;">控制反轉(</span>**Inversion Of Control)簡稱IOC</li>
</ul>
<p>先看看Google怎麼解釋<br><span style="color: #222222; font-family: &quot;arial&quot; , sans-serif;"><span style="background-color: #cccccc; line-height: 19.2px;"><strong>控制反轉（Inversion of Control，縮寫為IoC），是面向對象編程中的一種設計原則，可以用來減低計算機代碼之間的耦合度。其中最常見的方式叫做依賴注入（Dependency Injection，簡稱DI）</strong></span></span></p>
<p>不知道看完有沒有懂的感覺XD，明明都是中文看完卻很想說「先生(小姐)可以講中文嗎?」。<br>撇開這些專業的術語不看，我們直接開始重構來體會這兩個概念</p>
<span style="color: #444444;">
</span><span style="color: #444444; font-size: x-large;">一、重構開始</span>

<p><span style="font-size: large;"><strong>抽取介面</strong></span><br>避免直接耦合的第一步，抽取介面來隔離實體，既然這邊實際耦合了<strong>POIService</strong>，那我們就為它抽取出Interface <span style="color: #bf9000;">IPOIService</span></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-LrWsJfLH2vU/V7PAEPoqZKI/AAAAAAAAH7Y/VCUD_9YVxnEPfAzFCKpQvHY3jQRkMBD9ACLcB/s1600/1.png)](https://3.bp.blogspot.com/-LrWsJfLH2vU/V7PAEPoqZKI/AAAAAAAAH7Y/VCUD_9YVxnEPfAzFCKpQvHY3jQRkMBD9ACLcB/s1600/1.png)</div>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPOIService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 取得屬於頻道的POI資料</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;channelID&quot;&gt;</span>The channel identifier.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>List&amp;lt;POI&amp;gt;.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">List&lt;POI&gt; <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>將<strong>POIService</strong>掛上<span style="color: #bf9000;">IPOIService</span><br><span style="color: #bf9000;"><br></span></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-YS5Dd3-SnX4/V7PA1QAh0ZI/AAAAAAAAH7g/Av6PbiG5yYgct0SYM1kP_n8mTQTLy0N2ACLcB/s400/1.png)](https://2.bp.blogspot.com/-YS5Dd3-SnX4/V7PA1QAh0ZI/AAAAAAAAH7g/Av6PbiG5yYgct0SYM1kP_n8mTQTLy0N2ACLcB/s1600/1.png)</div><span style="color: #bf9000;">
</span><span style="color: #bf9000;">
</span>**讓Application依賴介面**

<p>上一篇遇到這種狀況時，我們會做一個Factory來產生實體，並且封裝在Service層。這次我們不這麼做，改成用依賴注入(DI)的方式來實作，將<span style="color: #bf9000;">IPOIService</span>改成用建構子帶入</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        IPOIService _POIService;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HomeController</span>(<span class="params">IPOIService poiService</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//POIService改成依賴介面IPOIService</span></span><br><span class="line">            <span class="comment">//並且實體是由外部來決定，也就是所謂的依賴注入DI</span></span><br><span class="line">            _POIService = poiService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>(<span class="params"><span class="built_in">string</span> id</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//依賴外部注入的IPOIService介面</span></span><br><span class="line">            <span class="keyword">var</span> POIs = _POIService.Get(id);</span><br><span class="line">            <span class="keyword">return</span> Json(POIs,JsonRequestBehavior.AllowGet);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這邊用的<span style="color: #bf9000;">IPOIService</span>是由外部注入的，實體已經不由<strong>HomeController <strong>內部來決定了(不New實體了)，也就是上面所提到的</strong>DI 依賴注入</strong>(<em>要用的實體由建構子注入</em>)，<strong>IOC控制反轉</strong>(<em>實體已經由內部控制改由外部控制了</em>)</p>
<p>接下來面臨的問題是，雖然我們讓實體改成用外部注入的方式，但HomeController在建立的時候是由系統去產生的，它怎麼知道<span style="color: #bf9000;">IPOIService</span>的實體是要注入誰，所以現在執行程式會看到以下結果</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-0ijdWklCbSk/V7QYVfZnz_I/AAAAAAAAH7w/Bj3Sa8cECEcTJNOsObhzWMd6vMjwUJIggCLcB/s1600/1.png)](https://4.bp.blogspot.com/-0ijdWklCbSk/V7QYVfZnz_I/AAAAAAAAH7w/Bj3Sa8cECEcTJNOsObhzWMd6vMjwUJIggCLcB/s1600/1.png)</div>

<p>這時候就要介紹<strong>Unity</strong>這個套件來幫我們解決這個問題了</p>
<p>**</p>
<hr>
<p>**<strong>何謂Unity</strong></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-PEXphTQycyE/V7QY_Y7zGoI/AAAAAAAAH70/n8FT2stz8PQnOEXWrUSl95ilLNBrmTz1gCLcB/s400/MSUNITY.jpg)](https://1.bp.blogspot.com/-PEXphTQycyE/V7QY_Y7zGoI/AAAAAAAAH70/n8FT2stz8PQnOEXWrUSl95ilLNBrmTz1gCLcB/s1600/MSUNITY.jpg)</div>MSDN上的Unity套件介紹 : [https://msdn.microsoft.com/en-us/library/ff647202.aspx](https://msdn.microsoft.com/en-us/library/ff647202.aspx)
**
**<span style="font-size: large;">其實這個套件說穿了就是在Application啟動時，註冊每個Interface對應的實體是誰，當碰到要注入這個Interface時，Unity就會去找找看你有沒有跟它說對應的實體，如果有，它就把實體產生出來幫你帶入。</span>那就一步一步做做看邊體會它的意思
<span style="font-size: large;">
</span>
<span style="font-size: large;">
</span><span style="font-size: large;">**1.安裝Unity套件&nbsp;**</span>
<span style="font-size: large;">
</span>請在Application專案透過Nuget搜尋Unity安裝**Unity.Mvc**
<div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-HhIfl_RkSKA/V7QbZyR_3SI/AAAAAAAAH8M/C4VxtKVrLdUkdbq6eGIXxg0bH9m_A6DpACLcB/s640/1.png)](https://2.bp.blogspot.com/-HhIfl_RkSKA/V7QbZyR_3SI/AAAAAAAAH8M/C4VxtKVrLdUkdbq6eGIXxg0bH9m_A6DpACLcB/s1600/1.png)</div>
**
****<b style="font-size: medium;">2.註冊Interface應該對應的實體**</b>
**<b style="font-size: medium;">
**</b>這時候打開App_Start資料夾應該會看到多了一個檔案**UnityConfig.cs**

<div class="separator" style="clear: both; font-weight: bold; text-align: center;">[![](https://2.bp.blogspot.com/-MCmsg-5dEEY/V7Qb_xiRLFI/AAAAAAAAH8U/3JMMEHww4joUlfQI3HjpW0abcn343O9KwCLcB/s320/1.png)](https://2.bp.blogspot.com/-MCmsg-5dEEY/V7Qb_xiRLFI/AAAAAAAAH8U/3JMMEHww4joUlfQI3HjpW0abcn343O9KwCLcB/s1600/1.png)</div><div class="separator" style="clear: both; font-weight: bold; text-align: center;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">打開它會看到以下Code跟註解，教你怎麼使用它</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-B5FxVSeEW9Q/V7QcPsxDVeI/AAAAAAAAH8Y/lsWGO864ftoAVFsUH3nmO9mB4LL0lOAZwCLcB/s640/1.png)](https://2.bp.blogspot.com/-B5FxVSeEW9Q/V7QcPsxDVeI/AAAAAAAAH8Y/lsWGO864ftoAVFsUH3nmO9mB4LL0lOAZwCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">請將**RegisterTypes**&nbsp;改成以下</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">
</div>```csharp
/// <summary>Registers the type mappings with the Unity container.</summary>
        /// <param name="container">The unity container to configure.</param>
        /// <remarks>There is no need to register concrete types such as controllers or API controllers (unless you want to 
        /// change the defaults), as Unity allows resolving a concrete type even if it was not previously registered.</remarks>
        public static void RegisterTypes(IUnityContainer container)
        {

<pre><code>        //TransientLifetimeManager為這個實體的創建生命週期
        //表示執行程式時，每次碰到IPOIService都會去new 一個新的POIService
        //Unity有許多生命週期可以使用，可以參考官方的文件
        //例如PerResolveLifetimeManager就是本次Request只有New一次實體，如果同個Request碰到多次
        //都還是會返回第一次New的實體，直到Reqeust結束才會被消滅掉,Singleton的概念
        container.RegisterType&lt;IPOIService, POIService&gt;(new TransientLifetimeManager());
    &#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">關於Unity創建實體的生命週期請參考官方文件 :&amp;nbsp;[https:&#x2F;&#x2F;msdn.microsoft.com&#x2F;en-us&#x2F;library&#x2F;ff660872(v&#x3D;pandp.20).aspx](https:&#x2F;&#x2F;msdn.microsoft.com&#x2F;en-us&#x2F;library&#x2F;ff660872(v&#x3D;pandp.20).aspx)</span><br><span class="line"></span><br><span class="line">註冊好後接著執行看看，會發現程式又活過來了，不會再出現剛剛的錯誤頁面，因為程式已經知道該Interface對應的實體是誰，當由外部注入時，Unity會自己去幫你控制實體的產生並且注入</span><br><span class="line"></span><br><span class="line">&lt;div class&#x3D;&quot;separator&quot; style&#x3D;&quot;clear: both; text-align: center;&quot;&gt;[![](https:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-QgBTpClZA_g&#x2F;V7QgW_P_VNI&#x2F;AAAAAAAAH8o&#x2F;EBBv1BKh0pIIbOKaZoPRQB4Gt-dmnLcmgCLcB&#x2F;s640&#x2F;1.png)](https:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-QgBTpClZA_g&#x2F;V7QgW_P_VNI&#x2F;AAAAAAAAH8o&#x2F;EBBv1BKh0pIIbOKaZoPRQB4Gt-dmnLcmgCLcB&#x2F;s1600&#x2F;1.png)&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">透過這個重構的實例，我們可以從裡面瞭解到何謂**DI**與**IOC**的概念，但可能會想說，那這樣的好處是什麼? 直接New錯了嗎?</span><br><span class="line"></span><br><span class="line">回到前一篇提到的，如果直接New的話也就是高耦合的狀況，如果今天面對的實體改動時，很難避免耦合的地方不會跟著變動，所以我們**依賴抽象**(Interface)，用了Unity後其實又牽扯到一個大重點&quot;**職責分離**&quot;。</span><br><span class="line"></span><br><span class="line">以後如果有Interface與實體的對應關係，直接就會想到要去**UnityConfig.cs**來改，所有的註冊表在這邊統一管理而且一目了然，如果哪天主管跟你說**POIService**它不喜歡，要重新寫個**NewPOIService**，那我們是不是直接把**NewPOIService實作**&lt;span style&#x3D;&quot;color: #bf9000;&quot;&gt;IPOIService&lt;&#x2F;span&gt;後，然後打開**UnityConfig.cs**改成這樣即可</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;csharp</span><br><span class="line">container.RegisterType&lt;IPOIService, NewPOIService&gt;(new TransientLifetimeManager());</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>其他地方連動都不用動，就已經直接將對應的實體給換掉了!!! 統一管理之外，也能達到最小更動原則。</p>
<p>這次的重構就先到這邊~</p>
]]></content>
      <tags>
        <tag>C#</tag>
        <tag>Refactor</tag>
      </tags>
  </entry>
  <entry>
    <title>動態新增或刪除MenuTab與MultiView</title>
    <url>/2013/05/07/%E5%8B%95%E6%85%8B%E6%96%B0%E5%A2%9E%E6%88%96%E5%88%AA%E9%99%A4MenuTab%E8%88%87MultiView/</url>
    <content><![CDATA[<p>雖然我應該八萬年都不會用這兩個控制項，但今天幫人家改了一個莫名其妙的問題，就順便紀錄一下吧<br>必須寫在Page_Init，且MultiView在新增時不能放在Page_Load裡面，不然有時候會當掉….超怪!! ```vb<br>Protected Sub Page_Init(ByVal Sender As Object, ByVal e As EventArgs) Handles Me.Init</p>
<pre><code>    If Not Page.IsPostBack Then
        Me.MultiViewControl.Controls.Clear()
        Select Case Request.QueryString(&quot;Type&quot;)
            Case &quot;01&quot;
                Me.MenuTab.Items.RemoveAt(0)
                Me.MenuTab.Items.RemoveAt(0)
                Me.MenuTab.Items.RemoveAt(0)
                Me.MenuTab.Items(0).Selected = True

                Me.MultiViewControl.Controls.Add(View4)
            Case &quot;02&quot;
                Me.MenuTab.Items.RemoveAt(0)
                Me.MenuTab.Items.RemoveAt(1)
                Me.MenuTab.Items.RemoveAt(1)
                Me.MenuTab.Items(0).Selected = True

                Me.MultiViewControl.Controls.Add(View2)
            Case Else
                Me.MenuTab.Items.RemoveAt(3)

                Me.MultiViewControl.Controls.Add(View1)
                Me.MultiViewControl.Controls.Add(View2)
                Me.MultiViewControl.Controls.Add(View3)
        End Select
    End If
End Sub
</code></pre>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">**補充!!!**</span><br><span class="line"></span><br><span class="line">*   之前是用QueryString的參數來決定要加入哪些View，但因為其實開的WebForm都是同一個，所以如果有使用一些控制項(例如:UpdatePanel之類的)，會回傳ViewState不一致或一些奇奇怪怪的問題一堆，所以改正了上述的作法，MultiView從頭到尾都不移除，而是依據目前Menu選取來決定show哪個View</span><br><span class="line">*   修正版本 &#96;&#96;&#96;vb</span><br><span class="line">Protected Sub Page_Init(ByVal Sender As Object, ByVal e As EventArgs) Handles Me.Init</span><br><span class="line"></span><br><span class="line">            If Not Page.IsPostBack Then</span><br><span class="line">            Select Case Request.QueryString(&quot;Type&quot;)</span><br><span class="line">                Case &quot;01&quot;</span><br><span class="line">                    Me.MenuTab.Items.RemoveAt(0)</span><br><span class="line">                    Me.MenuTab.Items.RemoveAt(0)</span><br><span class="line">                    Me.MenuTab.Items.RemoveAt(0)</span><br><span class="line">                    Me.MenuTab.Items(0).Selected &#x3D; True</span><br><span class="line">                Case &quot;02&quot;</span><br><span class="line">                    Me.MenuTab.Items.RemoveAt(0)</span><br><span class="line">                    Me.MenuTab.Items.RemoveAt(1)</span><br><span class="line">                    Me.MenuTab.Items.RemoveAt(1)</span><br><span class="line">                    Me.MenuTab.Items(0).Selected &#x3D; True</span><br><span class="line"></span><br><span class="line">                    Case Else</span><br><span class="line">                    Me.MenuTab.Items.RemoveAt(3)</span><br><span class="line">            End Select</span><br><span class="line">        End If</span><br><span class="line"> End Sub</span><br><span class="line"> Protected Sub View_Select(sender As Object, e As EventArgs) Handles Menu1.PreRender</span><br><span class="line">        Select Case Menu1.SelectedValue</span><br><span class="line">            Case &quot;1&quot;</span><br><span class="line">                MultiView1.ActiveViewIndex &#x3D; 0</span><br><span class="line">            Case &quot;2&quot;</span><br><span class="line">                MultiView1.ActiveViewIndex &#x3D; 1</span><br><span class="line">            Case &quot;3&quot;</span><br><span class="line">                MultiView1.ActiveViewIndex &#x3D; 2</span><br><span class="line">        End Select</span><br><span class="line"> End Sub</span><br><span class="line"></span><br><span class="line">    </span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>ASP</tag>
      </tags>
  </entry>
  <entry>
    <title>【生產力】自訂Google Search Engine</title>
    <url>/2018/09/14/%E8%87%AA%E8%A8%82Google_SearchEngine/</url>
    <content><![CDATA[<p>常常會有需要查詢英文、日文單字的情形，以前都會先打開Yahoo或是Google的辭典然後查詢單字，直到今天學到了自訂Chrome Search Engine實在太好用了，所以決定寫下來記錄一下</p>
<h1 id="設定"><a href="#設定" class="headerlink" title="#設定"></a>#設定</h1><p>首先先打開Chrome瀏覽器，在網址列輸入</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">chrome:&#x2F;&#x2F;settings&#x2F;searchEngines</span><br></pre></td></tr></table></figure>



<p>接著點選**[新增]**</p>
<p><img src="/images/20180914/1.png" alt="/images/20180914/1.png"></p>
<p><img src="/images/20180914/2.png" alt="/images/20180914/1.png"></p>
<ul>
<li><p><strong>搜尋引擎</strong></p>
<p>​    讓自己識別的名稱，可以隨便寫</p>
</li>
<li><p><strong>關鍵字</strong> </p>
<p>​    這個是你啟動自訂Google Search Engine的關鍵字，請寫自己好記的</p>
</li>
<li><p><strong>網址</strong> </p>
<p>告訴Chrome如何用你下的關鍵字去搜尋，以Google翻譯為例，當你輸入apple時網址會變成如圖，而紅框處就是我們要替換的地方，請以<code>%s</code>替代</p>
<p><img src="/images/20180914/3.png" alt="/images/20180914/1.png"></p>
</li>
</ul>
<h1 id="使用"><a href="#使用" class="headerlink" title="#使用"></a>#使用</h1><p>之後只要我在Chrome瀏覽器輸入<code>gdic</code>+<code>空格</code>，就會變成這樣</p>
<p><img src="/images/20180914/4.png" alt="/images/20180914/1.png"></p>
<p>再次輸入Apple後Enter就會跑到Google翻譯頁並查好了</p>
<p><img src="/images/20180914/5.gif" alt="/images/20180914/1.png"></p>
]]></content>
      <tags>
        <tag>生產力</tag>
      </tags>
  </entry>
  <entry>
    <title>【SQL】Split</title>
    <url>/2013/04/24/%E3%80%90SQL%E3%80%91Split/</url>
    <content><![CDATA[<p>今天遇到一個需求如下<br>Table1  T1<br>裡面有問候語加上一群使用者的代碼(用逗號區隔開來)<br><a href="http://3.bp.blogspot.com/-OzkM7YK0R78/UXeV_oe2GBI/AAAAAAAACkE/B3UB92iezUg/s1600/1.png"><img src="http://3.bp.blogspot.com/-OzkM7YK0R78/UXeV_oe2GBI/AAAAAAAACkE/B3UB92iezUg/s320/1.png"></a></p>
<p>Table1  T2<br>裡面有使用者代碼跟其對應的名稱<br><a href="http://3.bp.blogspot.com/-13Y4NMNrPEI/UXeWZzSIyVI/AAAAAAAACkM/YxhNCCQCzOs/s1600/1.png"><img src="http://3.bp.blogspot.com/-13Y4NMNrPEI/UXeWZzSIyVI/AAAAAAAACkM/YxhNCCQCzOs/s320/1.png"></a></p>
<p>目標搜尋出來的結果如下：<br>意即代碼要被換成其對應的名稱<br><a href="http://1.bp.blogspot.com/-wMsczC4e4XU/UXeW9nyRJ8I/AAAAAAAACkU/Wql8AdNj2ow/s1600/1.png"><img src="http://1.bp.blogspot.com/-wMsczC4e4XU/UXeW9nyRJ8I/AAAAAAAACkU/Wql8AdNj2ow/s320/1.png"></a></p>
<p>首先先建立一個可以將分隔符號拆開，並且去搜尋對應名稱的function (抓網路上高手寫的Code回來修改而成) ```sql<br>create FUNCTION [dbo].[ufn_Split]( @InputString nvarchar(4000))<br>RETURNS varchar(1000) –執行這個function會回傳字串<br>AS<br>BEGIN<br>    –用來儲存分隔符號的Index<br>    DECLARE @CIndex smallint<br>    –用來串接字串並最後回傳回去的字串<br>    declare @OutputString varchar(1000) =’’<br>    declare @tempString varchar(500) =’’</p>
<p> WHILE (@InputString&lt;&gt;’’)<br> BEGIN<br>  SET @CIndex=CHARINDEX(‘,’,@InputString) –抓到第一個分隔符號的Index<br>  IF @CIndex=0 SET @CIndex=LEN(@InputString)+1</p>
<p>  –將第一組代碼拆解出來並帶到T2去搜尋對應的名稱，如果搜尋出來為null的話則當作空字串處理<br>                set @tempString = isnull((select name from t2 where id = (SUBSTRING(@InputString,1,@CIndex-1))),’’)</p>
<p>  –這串if else純粹只是要解決多餘的逗號問題而已，就不多加解釋了<br>  if @tempString &lt;&gt; ‘’<br>  begin<br>     if @OutputString = ‘’<br>     begin<br>        set @OutputString = @tempString<br>     end<br>            else<br>        set @OutputString = @OutputString +’,‘+@tempString<br>  end</p>
<p>  IF @CIndex=LEN(@InputString)+1 BREAK</p>
<p>  –把剛剛搜尋過的代碼挑掉後，剩下的繼續跑迴圈<br>  SET @InputString=SUBSTRING(@InputString,@CIndex+1,LEN(@InputString)-@CIndex)<br> END<br> RETURN @OutputString<br>END</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">最後SQL command如下，就可以得到上述合併的結果了!!! &#96;&#96;&#96;sql</span><br><span class="line">select title,dbo.ufn_Split(number) from t1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>如何設定檔案、資料夾匿名驗證存取權限</title>
    <url>/2017/03/22/%E5%A6%82%E4%BD%95%E8%A8%AD%E5%AE%9A%E6%AA%94%E6%A1%88%E3%80%81%E8%B3%87%E6%96%99%E5%A4%BE%E5%8C%BF%E5%90%8D%E9%A9%97%E8%AD%89%E5%AD%98%E5%8F%96%E6%AC%8A%E9%99%90/</url>
    <content><![CDATA[<p>每次討論到windows或是IIS權限都是我的弱項，碰到這類問題總是要搞個老半天，所以處理完趕緊來記錄一下!!</p>
<h4 id="情境"><a href="#情境" class="headerlink" title="情境 :"></a>情境 :</h4><p>同事希望某個資料夾下的Json檔案都不能被外部存取，但唯獨某一支有資訊安全問題，想要排除</p>
<h4 id="解決方案"><a href="#解決方案" class="headerlink" title="解決方案:"></a>解決方案:</h4><div>一開始單純的想說透過IIS的驗證設定將該資料夾的匿名驗證停用，但這樣就變成所有在該資料夾底下的檔案都讀取不到了。</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-RnKuPAsgeo4/WNHuiKDxc5I/AAAAAAAAIFo/iW3Vy1dIanMIQnrg8fN8Bey6ieywbJX8ACLcB/s640/1.png)](https://2.bp.blogspot.com/-RnKuPAsgeo4/WNHuiKDxc5I/AAAAAAAAIFo/iW3Vy1dIanMIQnrg8fN8Bey6ieywbJX8ACLcB/s1600/1.png)</div><div>
</div><div>
</div><div>最後查了一下後，採取透過Web.config設定的方式來達成!!</div><div>
</div><div>

<ol>
<li>首先在Web.config的system.webServer區段接入以下區段 ```xml<handlers>
   <add name="JsonHandler" verb="*" path="*.json" type="System.Web.StaticFileHandler" resourceType="Unspecified" />
</handlers></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">2.  接著在想要權限控管的那個資料夾底下加入一個新的web.config，並且寫入以下區段 &#96;&#96;&#96;xml</span><br><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;system.web&gt;</span><br><span class="line">      &lt;authorization&gt;</span><br><span class="line">        &lt;deny users&#x3D;&quot;?&quot; &#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;authorization&gt;</span><br><span class="line">    &lt;&#x2F;system.web&gt;</span><br><span class="line">    &lt;location path&#x3D;&quot;xxx.json&quot;&gt;    &lt;system.web&gt;</span><br><span class="line">        &lt;authorization&gt;</span><br><span class="line">            &lt;allow users&#x3D;&quot;?&quot; &#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;authorization&gt;</span><br><span class="line">    &lt;&#x2F;system.web&gt;</span><br><span class="line">    &lt;&#x2F;location&gt;</span><br><span class="line">&lt;&#x2F;configuration&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這邊稍微解釋一下意思，首先authorization區段底下寫著deny user=”?”，表示匿名驗證的使用者都無法存取。</p>
<pre><code>接著location path這段是表示，xxx.json，他的權限是可以允許(allow)匿名驗證者個存取。&amp;nbsp;&lt;/div&gt;&lt;div&gt;
</code></pre>
</div><div>這樣設定完後進行測試，的確該資料夾底下的所以檔案都會無法直接讀取，並且跳出401權限驗證錯誤，而xxx.json雖然在同資料夾下，但卻是可以直接讀取檔案的

<p>因為關於權限設定真的是肉腳一枚，如果有寫錯或觀念偏誤的地方，也歡迎留言指正教導，感激不盡!!!</p>
</div><div>
</div><div>
</div>]]></content>
  </entry>
  <entry>
    <title>【MVC教學】6.驗證參數- 透過FluentValidation</title>
    <url>/2018/05/07/%E3%80%90MVC%E6%95%99%E5%AD%B8%E3%80%916.%E9%A9%97%E8%AD%89%E5%8F%83%E6%95%B8-%E9%80%8F%E9%81%8EFluentValidation/</url>
    <content><![CDATA[<div class="note info">
            <p>Demo範例 ：<a href="https://github.com/toyo0103/HelloDotNetMVC">Git位置</a></p>
          </div>

<p>上一篇簡介了Controller如何安排程式邏輯流程、驗證參數，卻也發現了驗證參數導致程式寫得冗長不易維護，這一篇要介紹【FluentValidation】這個套件來解決這個問題。</p>
<h1 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h1><p><a href="https://1.bp.blogspot.com/-xZDktMEHvG4/WvAKIceF2VI/AAAAAAAAIuQ/psmk0OXE26sun-H3XramjrzcSCNrD3QgACLcBGAs/s1600/1.png"><img src="https://1.bp.blogspot.com/-xZDktMEHvG4/WvAKIceF2VI/AAAAAAAAIuQ/psmk0OXE26sun-H3XramjrzcSCNrD3QgACLcBGAs/s400/1.png"></a><br><a href="https://2.bp.blogspot.com/-uGUzfrokFpI/WvAKaNzXTKI/AAAAAAAAIuY/1O8SMAL7FgkP5wX5l2BBYOKhcPSAF_o_gCLcBGAs/s1600/2.png"><img src="https://2.bp.blogspot.com/-uGUzfrokFpI/WvAKaNzXTKI/AAAAAAAAIuY/1O8SMAL7FgkP5wX5l2BBYOKhcPSAF_o_gCLcBGAs/s400/2.png"></a><br><a href="https://3.bp.blogspot.com/-kfFy1Iqdl1M/WvALDvzwBKI/AAAAAAAAIug/YO4AjyC_No42Xg24hCgC02nf1Qjwb1ZeACLcBGAs/s1600/3.png" title="安裝完後應該會在參考中看到多出兩個FluentValidation的組件"><img src="https://3.bp.blogspot.com/-kfFy1Iqdl1M/WvALDvzwBKI/AAAAAAAAIug/YO4AjyC_No42Xg24hCgC02nf1Qjwb1ZeACLcBGAs/s320/3.png"></a></p>
<h1 id="設定"><a href="#設定" class="headerlink" title="設定"></a>設定</h1><p>把之前的程式碼稍作整理，將Account與Password新建一個類型(Class)來封裝起來，原本Controller裡面的程式整理一下</p>
<p><a href="https://3.bp.blogspot.com/-7bpU-eurJAI/WvANP8ghptI/AAAAAAAAIus/ayYDM6pHzhwgsRgEigXWwUNGCRGIc7X6wCLcBGAs/s1600/4.png"><img src="https://3.bp.blogspot.com/-7bpU-eurJAI/WvANP8ghptI/AAAAAAAAIus/ayYDM6pHzhwgsRgEigXWwUNGCRGIc7X6wCLcBGAs/s400/4.png"></a></p>
<p><a href="https://4.bp.blogspot.com/-eIdaQ522IWo/WvAOfKE3BBI/AAAAAAAAIu0/wUYV51Bv-qAP5Dl-vmOAd_fNomrKCjFYwCLcBGAs/s1600/5.png"><img src="https://4.bp.blogspot.com/-eIdaQ522IWo/WvAOfKE3BBI/AAAAAAAAIu0/wUYV51Bv-qAP5Dl-vmOAd_fNomrKCjFYwCLcBGAs/s640/5.png"></a></p>
<h2 id="自定義驗證Class"><a href="#自定義驗證Class" class="headerlink" title="自定義驗證Class"></a>自定義驗證Class</h2><p>建立一個Class命名為UserSignUpParameterValidation</p>
<p><a href="https://2.bp.blogspot.com/-CGzCYQgNgpI/WvAQfRjh6rI/AAAAAAAAIvA/W__122acCJg4ivhkTljIzoKdeB3JYM0jwCLcBGAs/s1600/6.png"><img src="https://2.bp.blogspot.com/-CGzCYQgNgpI/WvAQfRjh6rI/AAAAAAAAIvA/W__122acCJg4ivhkTljIzoKdeB3JYM0jwCLcBGAs/s640/6.png"></a></p>
<p>將UserSignUpParameter掛上Validator Attribute，意思是UserSignUpParameter請幫我用UserSignUpParameterValidation裡面的邏輯來驗證</p>
<p><a href="https://4.bp.blogspot.com/-znw_JXDtBNI/WvARI9F6b8I/AAAAAAAAIvI/D4GtFgo5dQc06aEnUhlKjE503vuXegEmgCLcBGAs/s1600/7.png"><img src="https://4.bp.blogspot.com/-znw_JXDtBNI/WvARI9F6b8I/AAAAAAAAIvI/D4GtFgo5dQc06aEnUhlKjE503vuXegEmgCLcBGAs/s400/7.png"></a></p>
<h2 id="帳號密碼不能為空值"><a href="#帳號密碼不能為空值" class="headerlink" title="帳號密碼不能為空值"></a>帳號密碼不能為空值</h2><p><a href="https://1.bp.blogspot.com/-ZEqu3b-BvNc/WvARv5EsieI/AAAAAAAAIvQ/PZO_L_04kLsABp9rYw6dnXYYnKAymKEwACLcBGAs/s1600/8.png"><img src="https://1.bp.blogspot.com/-ZEqu3b-BvNc/WvARv5EsieI/AAAAAAAAIvQ/PZO_L_04kLsABp9rYw6dnXYYnKAymKEwACLcBGAs/s400/8.png"></a></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Validation UserSignUpParameter</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;seealso cref=&quot;FluentValidation.AbstractValidator&#123;HelloDotNetMVC.Parameters.UserSignUpParameter&#125;&quot; /&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserSignUpParameterValidation</span>:<span class="title">AbstractValidator</span>&lt;<span class="title">UserSignUpParameter</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserSignUpParameterValidation</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//AbstractValidator為FluentValidation提供的抽象類別</span></span><br><span class="line">        <span class="comment">//目的是讓使用者可以透過繼承這個抽象類別後，實作自己的驗證邏輯</span></span><br><span class="line">        <span class="comment">//而泛型T， AbstractValidator&lt;T&gt; ，則帶入你想驗證的類別</span></span><br><span class="line">        <span class="comment">//所以這邊帶入UserSignUpParameter，這個我們剛剛製作的Class</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Account</span></span><br><span class="line">        RuleFor(x =&gt; x.Account)</span><br><span class="line">        .NotEmpty()</span><br><span class="line">        .WithMessage(<span class="string">&quot;帳號不能為Empty&quot;</span>)</span><br><span class="line">        .NotNull()</span><br><span class="line">        .WithMessage(<span class="string">&quot;帳號不能為Null&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Password</span></span><br><span class="line">        RuleFor(x=&gt;x.Password)</span><br><span class="line">        .NotEmpty()</span><br><span class="line">        .WithMessage(<span class="string">&quot;密碼不能為Empty&quot;</span>)</span><br><span class="line">        .NotNull()</span><br><span class="line">        .WithMessage(<span class="string">&quot;密碼不能為Null&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RuleFor是FluentValidation提供的方法，意思是我為Account這個屬性建立驗證的Rule，而Rule分別是，NotEmpty(不能為空值)、NotNull(不能為Null)，而緊接在每個驗證邏輯下面的WithMessage則是表示，當發生它上面的錯誤時，錯誤訊息請回傳這行。</p>
<p>接著我們可以將Controller的這塊驗證邏輯拿掉，交給<strong>UserSignUpParameterValidation</strong>專責處理就好。</p>
<p><a href="https://2.bp.blogspot.com/-xebs-1HJ_Xo/WvAT_qTPsOI/AAAAAAAAIvc/PNSq-SW_qdczF4pHIZCzu8hhnsQdpMN1gCLcBGAs/s1600/9.png"><img src="https://2.bp.blogspot.com/-xebs-1HJ_Xo/WvAT_qTPsOI/AAAAAAAAIvc/PNSq-SW_qdczF4pHIZCzu8hhnsQdpMN1gCLcBGAs/s400/9.png"></a></p>
<h2 id="帳號必須包含-字元，Password必須大於6個字"><a href="#帳號必須包含-字元，Password必須大於6個字" class="headerlink" title="帳號必須包含@字元，Password必須大於6個字"></a>帳號必須包含@字元，Password必須大於6個字</h2><p>因為判斷字元@並不像判斷空值與Null一樣，官方有實做好的方法，必須自己透過Must來定義，這邊提供兩種寫法給讀者參考</p>
<p><a href="https://4.bp.blogspot.com/-Qd2w4MEWlFk/WvAV24u79OI/AAAAAAAAIvo/ZUAMLs0fn6kx07JMLchQHKYOsP_fKCwvQCLcBGAs/s1600/10.png"><img src="https://4.bp.blogspot.com/-Qd2w4MEWlFk/WvAV24u79OI/AAAAAAAAIvo/ZUAMLs0fn6kx07JMLchQHKYOsP_fKCwvQCLcBGAs/s320/10.png"></a></p>
<p>上面是匿名方法的寫法，但如果你對於匿名委派還不是很熟悉，也可以用比較簡單的方式寫</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-KmJSyZdiGb0/WvAWiccBedI/AAAAAAAAIvw/17gYP6xPzgIUFII1ptocXolNHkBXfGeegCLcBGAs/s400/11.png)](https://4.bp.blogspot.com/-KmJSyZdiGb0/WvAWiccBedI/AAAAAAAAIvw/17gYP6xPzgIUFII1ptocXolNHkBXfGeegCLcBGAs/s1600/11.png)</div>
先寫好驗證的方法，然後在Must中帶入方法。

<div class="note info">
            <p>延伸閱讀 :<br><a href="https://msdn.microsoft.com/zh-tw/library/bb549151(v=vs.110).aspx">MSDN : Func&lt;T,TResult&gt; 委派</a><br><a href="https://docs.microsoft.com/zh-tw/dotnet/csharp/programming-guide/statements-expressions-operators/anonymous-methods">MSDN : 匿名方法</a></p>
          </div>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Validation UserSignUpParameter</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;seealso cref=&quot;FluentValidation.AbstractValidator&#123;HelloDotNetMVC.Parameters.UserSignUpParameter&#125;&quot; /&gt;</span></span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">UserSignUpParameterValidation</span>:<span class="title">AbstractValidator</span>&lt;<span class="title">UserSignUpParameter</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserSignUpParameterValidation</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">//AbstractValidator為FluentValidation提供的抽象類別</span></span><br><span class="line">        <span class="comment">//目的是讓使用者可以透過繼承這個抽象類別後，實作自己的驗證邏輯</span></span><br><span class="line">        <span class="comment">//而泛型T， AbstractValidator&lt;T&gt; ，則帶入你想驗證的類別</span></span><br><span class="line">        <span class="comment">//所以這邊帶入UserSignUpParameter，這個我們剛剛製作的Class</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Account</span></span><br><span class="line">        RuleFor(x =&gt; x.Account)</span><br><span class="line">        .NotEmpty()</span><br><span class="line">        .WithMessage(<span class="string">&quot;帳號不能為Empty&quot;</span>)</span><br><span class="line">        .NotNull()</span><br><span class="line">        .WithMessage(<span class="string">&quot;帳號不能為Null&quot;</span>)</span><br><span class="line">        .Must(IncludeAccountKeyword)</span><br><span class="line">        .WithMessage(<span class="string">&quot;帳號不符合格式&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Password</span></span><br><span class="line">        RuleFor(x=&gt;x.Password)</span><br><span class="line">        .NotEmpty()</span><br><span class="line">        .WithMessage(<span class="string">&quot;密碼不能為Empty&quot;</span>)</span><br><span class="line">        .NotNull()</span><br><span class="line">        .WithMessage(<span class="string">&quot;密碼不能為Null&quot;</span>)</span><br><span class="line">        .MinimumLength(<span class="number">7</span>)</span><br><span class="line">        .WithMessage(<span class="string">&quot;密碼必須大於6個字元&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Accounts 必須包含@.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;account&quot;&gt;</span>The account.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="built_in">bool</span> <span class="title">IncludeAccountKeyword</span>(<span class="params"><span class="built_in">string</span> account</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrWhiteSpace(account))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span> account.Contains(<span class="string">&quot;@&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整理後的Controller</p>
<p><a href="https://3.bp.blogspot.com/-VBKP-msTxnE/WvAYvl0-HBI/AAAAAAAAIv8/tgh1Rp_cN0cyjKsFKbOnefX9VsBI5HPWQCLcBGAs/s1600/12.png"><img src="https://3.bp.blogspot.com/-VBKP-msTxnE/WvAYvl0-HBI/AAAAAAAAIv8/tgh1Rp_cN0cyjKsFKbOnefX9VsBI5HPWQCLcBGAs/s400/12.png"></a></p>
<h2 id="透過ModelState得知驗證結果"><a href="#透過ModelState得知驗證結果" class="headerlink" title="透過ModelState得知驗證結果"></a>透過ModelState得知驗證結果</h2><div class="note info">
            <p>ModelState是本來MVC就有提供的參數驗證方式，而使用方法這邊提供幾篇文章給有興趣的讀者參考<br><a href="https://www.exceptionnotfound.net/asp-net-mvc-demystified-modelstate/">What is the ModelState? - ASP.NET MVC Demystified</a><br><a href="https://blog.miniasp.com/post/2016/03/14/ASPNET-MVC-Developer-Note-Part-28-Understanding-ModelState.aspx">保哥 : ASP.NET MVC 開發心得分享 (28)：深入了解 ModelState 內部細節</a></p>
          </div>

<p>而因為開發習慣的關係，我習慣用FluentValidation的方式來取代原本ModelState驗證方法與設定方式，接著我們在Global.asax中呼叫FluentValidationModelValidatorProvider.Configure()</p>
<p><a href="https://1.bp.blogspot.com/-MtTiRt-qd-0/WvAjEv49mHI/AAAAAAAAIwM/cAcBsXbIuCEgOlfsPQVCMMB58ne84x8uQCLcBGAs/s1600/13.png"><img src="https://1.bp.blogspot.com/-MtTiRt-qd-0/WvAjEv49mHI/AAAAAAAAIwM/cAcBsXbIuCEgOlfsPQVCMMB58ne84x8uQCLcBGAs/s400/13.png"></a></div> </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">[<span class="meta">HttpPost</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> ActionResult <span class="title">SignUp</span>(<span class="params">UserSignUpParameter parameter</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!ModelState.IsValid)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//IsValida為False時，表示驗證參數不過</span></span><br><span class="line">        <span class="comment">//取出第一筆錯誤訊息回傳</span></span><br><span class="line">        <span class="keyword">var</span> Error = ModelState.Values.SelectMany(x =&gt; x.Errors).First();</span><br><span class="line">        TempData[<span class="string">&quot;Message&quot;</span>] = Error.ErrorMessage;</span><br><span class="line">        <span class="keyword">return</span> RedirectToAction(<span class="string">&quot;signup&quot;</span>, <span class="string">&quot;user&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//這邊沒有搬到FluentValidation去驗證的原因是</span></span><br><span class="line">    <span class="comment">//使用者存在與否比較屬於服務層的事情，通常需要讀取資料庫才能判斷</span></span><br><span class="line">    <span class="comment">//開發上習慣盡量讓驗證參數越乾淨簡單越好，而不是在裡面呼叫很多外部服務(例如資料庫)後做驗證</span></span><br><span class="line">    <span class="comment">//這會讓職責過於複雜</span></span><br><span class="line">    <span class="keyword">if</span> (parameter.Account != <span class="string">&quot;steven@mymail.com&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        TempData[<span class="string">&quot;Message&quot;</span>] = <span class="string">&quot;註冊成功!!&quot;</span>;</span><br><span class="line">        <span class="comment">//註冊成功,導到首頁 </span></span><br><span class="line">        <span class="keyword">return</span> RedirectToAction(<span class="string">&quot;index&quot;</span>, <span class="string">&quot;home&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        TempData[<span class="string">&quot;Message&quot;</span>] = <span class="string">&quot;帳號已經存在&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> RedirectToAction(<span class="string">&quot;signup&quot;</span>, <span class="string">&quot;user&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接著執行程式，驗證看看是否之前的驗證邏輯都還是正常運作。</p>
<p><a href="https://2.bp.blogspot.com/-eQpSlQBWHTE/WvAoYn_ChaI/AAAAAAAAIwk/C-Y7_RCGGuIvOHE8u-VhS8OPriHmspgpgCLcBGAs/s1600/15.png"><img src="https://2.bp.blogspot.com/-eQpSlQBWHTE/WvAoYn_ChaI/AAAAAAAAIwk/C-Y7_RCGGuIvOHE8u-VhS8OPriHmspgpgCLcBGAs/s400/15.png"></a> <a href="https://3.bp.blogspot.com/-yVOQuBNw_cM/WvAoYoDVp_I/AAAAAAAAIwg/aGZLbMDSrTgCcZS2TwFEfFzGMiYktMsXACLcBGAs/s1600/16.png"><img src="https://3.bp.blogspot.com/-yVOQuBNw_cM/WvAoYoDVp_I/AAAAAAAAIwg/aGZLbMDSrTgCcZS2TwFEfFzGMiYktMsXACLcBGAs/s400/16.png"></a><br><a href="https://2.bp.blogspot.com/-Qyvaso2H-qg/WvAoYTtzkxI/AAAAAAAAIwc/wILEhIgySEExN0Wy-V33ohsrwpIKpG-JACLcBGAs/s1600/14.png"><img src="https://2.bp.blogspot.com/-Qyvaso2H-qg/WvAoYTtzkxI/AAAAAAAAIwc/wILEhIgySEExN0Wy-V33ohsrwpIKpG-JACLcBGAs/s400/14.png"></a></p>
<p>比較一下最一開始與套用FluentValidation後的程式碼，應該可以明顯感受到差異，這不僅僅只是讓程式變乾淨，更重要的是驗證參數的職責被分離到UserSignUpParameterValidation這個類別中，以後要改參數驗證的邏輯只要到這調整即可，不用再擔心Controller會被不小心改壞。</p>
<p><a href="https://4.bp.blogspot.com/-3mLUKzjO55A/WvArsPEl3hI/AAAAAAAAIw0/8AidDEBX-jwgO7iFO3nyt7ENHCg8xd7PwCLcBGAs/s1600/17.png"><img src="https://4.bp.blogspot.com/-3mLUKzjO55A/WvArsPEl3hI/AAAAAAAAIw0/8AidDEBX-jwgO7iFO3nyt7ENHCg8xd7PwCLcBGAs/s640/17.png"></a></p>
<h1 id="延伸閱讀"><a href="#延伸閱讀" class="headerlink" title="延伸閱讀"></a>延伸閱讀</h1><p><a href="https://github.com/JeremySkinner/FluentValidation/wiki">FluentValidation : 官方文件、各種API使用方法</a><br><a href="https://toyo0103.blogspot.tw/2016/10/fluentvalidation-webapi.html">FluentValidation : 擴充驗證方法</a><br><a href="https://toyo0103.blogspot.tw/2016/11/fluentvalidation.html">FluentValidation : 繼承父類別的驗證</a></p>
]]></content>
      <categories>
        <category>學習MVC</category>
      </categories>
      <tags>
        <tag>MVC教學</tag>
      </tags>
  </entry>
  <entry>
    <title>跨DB select</title>
    <url>/2013/05/02/%E8%B7%A8DB-select/</url>
    <content><![CDATA[<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> opendatasource(<span class="string">&#x27;SQLNCLI10&#x27;</span>,<span class="string">&#x27;Data Source=192.168.1.110;User ID=帳號;Password=密碼&#x27;</span>).DataBaseName.dbo.TableName</span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>SQL</tag>
      </tags>
  </entry>
  <entry>
    <title>【.Net Core】AWS Lambda + Chrome Headless + Snapshot</title>
    <url>/2018/10/11/AWS_Lambda_Chrome_HeadLess/</url>
    <content><![CDATA[<div class="note danger">
            <p><strong>2018-10-25 更新</strong> :DotNet Core 版本已經找出解決方案了，更新在最下面</p><p><strong>注意 !!</strong> </p><p><del>這篇的結論是 <code>DotNet Core + Selenium + Chrome headless  + AWS Lambda</code>  執行是失敗的，所以如果不想看失敗案例的可以直接跳過了，寫下來是因為過程踩了太多雷想記錄一下</del> ，如果想要簡單一點的作法，建議採用  <code>NodeJs + Chrome Headless + AWS Lambda</code>  的解決方案，幾乎不用什麼調整即可使用。</p><p><a href="https://github.com/adieuadieu/serverless-chrome">NodeJs 版本參考: adieuadieu/serverless-chrome</a></p>
          </div>



<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>近期公司希望將訂單快照從 <a href="http://phantomjs.org/">PhantomJS</a> 改成 Chrome Headless 來實作，然後放到 <a href="https://aws.amazon.com/cn/lambda/?sc_channel=PS&sc_campaign=acquisition_TW&sc_publisher=google&sc_medium=lambda_b&sc_content=lambda_e&sc_detail=aws%20lambda&sc_category=lambda&sc_segment=165241565701&sc_matchtype=e&sc_country=TW&s_kwcid=AL!4422!3!165241565701!e!!g!!aws%20lambda&ef_id=W5skSAAAAUVNZtNI:20181011080758:s">AWS Lambda</a> 上透過 <a href="https://aws.amazon.com/tw/sqs/">AWS SQS</a> 來觸發，達成 Serverless 的架構。</p>
<p>隨著 Chrome Headless 的推出，PhantomJS 也宣布停止更新了，想當年也跟它奮戰許久，又一滴時代的眼淚阿，而要能在 Lambda 上執行，則必須是能在 Linux 上執行的程式，所以 .Net Core 成為這次的選擇，為了不要每次改程式都要佈署到 Lambda 上才能測試(跑一次大概5分鐘)，所以透過 Docker 模擬 AWS Lambda 的環境直接在本機測試。</p>
<h1 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h1><h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><p>DotNet Core 2.1 : <a href="https://www.microsoft.com/net/download">下載</a><br>Docker for Windows : <a href="https://docs.docker.com/docker-for-windows/install/">下載</a></p>
<h1 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h1><p>因為大量使用到 AWS SDK，查找官方 API 文件會更清楚些，所以本篇不著重在程式內容本身，只會帶到自己覺得關鍵的地方。</p>
<h2 id="建立-Net-Core-類別庫專案"><a href="#建立-Net-Core-類別庫專案" class="headerlink" title="建立 .Net Core 類別庫專案"></a>建立 .Net Core 類別庫專案</h2><p>請選擇 .Net Core &gt; 類別庫 (.Net Core)</p>
<p><img src="/images/20181011/1.png" alt="/images/20181011/1.png"></p>
<h2 id="安裝-AWS-相關套件"><a href="#安裝-AWS-相關套件" class="headerlink" title="安裝 AWS 相關套件"></a>安裝 AWS 相關套件</h2><p><img src="/images/20181011/2.png" alt="/images/20181011/2.png"></p>
<h2 id="實作-SQSHandler"><a href="#實作-SQSHandler" class="headerlink" title="實作 SQSHandler"></a>實作 SQSHandler</h2><p>因為是接收 SQS 來的命令，所以我建立了一支類別 <strong>SQSHandler</strong> ，並且寫了一個名為 <strong>Snapshot</strong> 的方法</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 執行快照</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sqsEvent&quot;&gt;</span>The SQS event.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>執行結果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ResponseEntity&gt; <span class="title">Snapshot</span>(<span class="params">SQSEvent sqsEvent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">                    </span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">record</span> = sqsEvent.Records.First();</span><br><span class="line">    <span class="keyword">var</span> parameter = JsonConvert.DeserializeObject&lt;SqsEventBodyEntity&gt;(<span class="keyword">record</span>.Body);</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/ 拍照</span></span><br><span class="line">    snapshotService.Do(parameter.TSCode, parameter.SalePageId);</span><br><span class="line">			</span><br><span class="line">    ...   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要接收 SQS 來的命令， AWS SDK 有提供 <strong>SQSEvent</strong> 類別，傳入自訂的參數會放在 <strong>Records</strong> 中，我們是將要拍照的參數用 Json 組起來後透過 SQS 拋進來，所以讀出 Records 後返解 Json String 為 Object ，然後拋給實作的SnapshotServiece。</p>
<p>Snapshot 這個方法回傳值為<code>自定義</code>的，可以依照自己需求調整，避免誤會所以特別說明一下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 執行快照</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sqsEvent&quot;&gt;</span>The SQS event.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>執行結果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Snapshot</span>(<span class="params">SQSEvent sqsEvent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;		</span><br></pre></td></tr></table></figure>



<h2 id="Chrome-Headless"><a href="#Chrome-Headless" class="headerlink" title="Chrome Headless"></a>Chrome Headless</h2><p>什麼是 <a href="https://developers.google.com/web/updates/2017/04/headless-chrome">Chrome Headless</a> ,簡單說就是透過無介面的方式要求Chrome執行一些快照、讀取頁面的服務。</p>
<p>為了能夠執行驅動 Chrome，所以這邊安裝 Selenium 來輔助</p>
<p><img src="/images/20181011/3.png" alt="/images/20181011/3.png"></p>
<p>Selenium 還需要搭配 Chorme Driver 來操作 Chrome，所以需要先去<a href="http://chromedriver.chromium.org/">http://chromedriver.chromium.org/</a>下載，但需要特別注意的是要下載 <strong>Linux64</strong> 的版本，因為 AWS Lambda 是 Linux 環境</p>
<p><img src="/images/20181011/4.png" alt="/images/20181011/4.png"></p>
<h3 id="實作-1"><a href="#實作-1" class="headerlink" title="實作"></a>實作</h3><p>這邊將下載回來的 Chrome Driver 放在 Root 的資料夾，所以在建立 ChromeDriver Instance 需要告訴它 Driver的位置</p>
<p><img src="/images/20181011/5.png" alt="/images/20181011/5.png"></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//chrome headless的參數</span></span><br><span class="line">ChromeOptions options = <span class="keyword">new</span> ChromeOptions();</span><br><span class="line">options.AddArgument(<span class="string">&quot;no-sandbox&quot;</span>);</span><br><span class="line">options.AddArgument(<span class="string">&quot;headless&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//取得Driver的位置</span></span><br><span class="line"><span class="keyword">var</span> root = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> driver = <span class="keyword">new</span> ChromeDriver(root, options);</span><br></pre></td></tr></table></figure>



<p>拍照</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="comment">//等待Timeout的設定</span></span><br><span class="line">WebDriverWait _wait = <span class="keyword">new</span> WebDriverWait(driver, <span class="keyword">new</span> TimeSpan(<span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//要連的網址</span></span><br><span class="line">driver.Navigate().GoToUrl(targetUrl);</span><br><span class="line"></span><br><span class="line"><span class="comment">//尋找要拍的Element Class</span></span><br><span class="line"><span class="keyword">var</span> targetElement = _wait.Until&lt;IWebElement&gt;(d =&gt; driver.FindElement(By.ClassName(targetElementClass)));</span><br><span class="line"></span><br><span class="line"><span class="comment">//因為要拍的區塊可能超過預設螢幕大小，所以這邊抓到Element後將它的寬高設定給Chrome Windows Size</span></span><br><span class="line">driver.Manage().Window.Size = <span class="keyword">new</span> Size(targetElement.Size.Width, targetElement.Size.Height);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拍照</span></span><br><span class="line">Screenshot screenShot = ((ITakesScreenshot)driver).GetScreenshot();</span><br><span class="line"></span><br><span class="line"><span class="comment">//處理圖片存到哪邊，我是存到S3，但因為不是本篇重點所以省略後面的程式碼</span></span><br><span class="line"><span class="keyword">var</span> imgStream = <span class="keyword">new</span> MemoryStream(screenShot.AsByteArray, <span class="number">0</span>, screenShot.AsByteArray.Length);</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h1 id="Docker-測試"><a href="#Docker-測試" class="headerlink" title="Docker 測試"></a>Docker 測試</h1><p>打開 Power Shell，先確定已正確安裝 Docker</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker --version</span><br></pre></td></tr></table></figure>

<p><img src="/images/20181011/6.png" alt="/images/20181011/6.png"></p>
<p>將目錄移到 .csproj 那層，然後執行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ dotnet publish -c release -r linux-x64</span><br></pre></td></tr></table></figure>

<div class="note info">
            <p>dotnet publish command : <a href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-publish?tabs=netcore21">文件</a></p>
          </div>

<p>如果發行成功應該可以在 <code>\bin\release\netcoreapp2.1\linux-x64\publish</code> 找到發行好的檔案</p>
<p>透過 Docker Image 測試執行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat test.json | docker run -v <span class="variable">$&#123;PWD&#125;</span>/bin/QA/netcoreapp2.1/publish:/var/task/ -i -e DOCKER_LAMBDA_USE_STDIN=1 lambci/lambda:dotnetcore2.1 xxx.Slsa.Snapshot.Console::xxx.Slsa.Snapshot.Console.SqsHandler::Snapshot</span><br></pre></td></tr></table></figure>

<p>解釋一下 Command</p>
<p><code>cat test.json</code>  : 這是拿來模擬 SQS 的呼叫時傳遞的參數檔案，檔案內容如下，我會一直替換Body 的值來測試程式是否正確去拍我要求拍的頁面，所以可以理解成是把檔案讀取後丟到後面的指令執行。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;Records&quot;</span>:[</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;messageId&quot;</span>:<span class="string">&quot;xxxxxxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;receiptHandle&quot;</span>:<span class="string">&quot;xxxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;body&quot;</span>:<span class="string">&quot;&#123;\&quot;SalePageId\&quot;: 12345,\&quot;TSCode\&quot;: \&quot;abcde\&quot;&#125;&quot;</span>,</span><br><span class="line"><span class="attr">&quot;attributes&quot;</span>:&#123;</span><br><span class="line"><span class="attr">&quot;ApproximateReceiveCount&quot;</span>:<span class="string">&quot;x&quot;</span>,</span><br><span class="line"><span class="attr">&quot;SentTimestamp&quot;</span>:<span class="string">&quot;xxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;SenderId&quot;</span>:<span class="string">&quot;xxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;ApproximateFirstReceiveTimestamp&quot;</span>:<span class="string">&quot;xxxxxx&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">&quot;messageAttributes&quot;</span>:&#123;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">&quot;md5OfBody&quot;</span>:<span class="string">&quot;xxxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;eventSource&quot;</span>:<span class="string">&quot;aws:sqs&quot;</span>,</span><br><span class="line"><span class="attr">&quot;eventSourceARN&quot;</span>:<span class="string">&quot;xxxxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;awsRegion&quot;</span>:<span class="string">&quot;xxxxxx&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>docker run -v $&#123;PWD&#125;/bin/QA/netcoreapp2.1/publish:/var/task/ </code> : ${PWD} 為預設變數，表示目前的目路位置，加上 /bin/QA/netcoreapp2.1/publish 後就是剛剛發行的檔案位置，mount 到 Docker container 裡面的 <code>/var/task</code> 位置，而這也是 lambda 預設執行的位置</p>
<p><code>lambci/lambda:dotnetcore2.1</code> : Docker Image 的名稱，這是別人已經做好跟 AWS lambda 一模一樣環境的 Image ，透過它來建置我們要的環境做測試</p>
<p><code>xxx.Slsa.Snapshot.Console::xxx.Slsa.Snapshot.Console.SqsHandler::Snapshot</code> : 格式為 Assembly Name :: Class Name ::  FunctionName，表示請它執行剛剛我們開發的 SQSHandler 的 Snapshot 方法</p>
<h2 id="找不到-Chrome-binary-錯誤"><a href="#找不到-Chrome-binary-錯誤" class="headerlink" title="找不到 Chrome binary 錯誤"></a>找不到 Chrome binary 錯誤</h2><p>這時候應該會發生找不到 Chrome binary 的錯誤，原因是在 Lambda 的環境並不能安裝 Chrome，所以 Chrome Driver 想去預設環境找 Chrome 核心來執行時會找不到。</p>
<p><img src="/images/20181011/7.png" alt="/images/20181011/7.png"></p>
<div class="note info">
            <p>整個驅動 Chrome 的流程</p><p>Selenum → Chrome Driver → Chrome binary</p>
          </div>

<p>還好已經有網路上的大神解決了這問題，<a href="https://github.com/adieuadieu/serverless-chrome/blob/master/docs/chrome.md">serverless-chrome</a>這個 Project 就是將 Chrome 封裝成 Binary 檔後可以打包進專案中，在 Power Shell 執行以下指令來取得 Chrome Binary</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -dt --rm --name headless-chromium adieuadieu/headless-chromium-for-aws-lambda:stable</span><br><span class="line">$ docker cp headless-chromium:/bin/headless-chromium ./</span><br><span class="line">$ docker stop headless-chromium</span><br></pre></td></tr></table></figure>



<p>在目前 Power Shell 指的資料底下可以找到 <strong>headless-chromium</strong> 檔案，將這個檔案加到專案中</p>
<p><img src="/images/20181011/8.png" alt="/images/20181011/8.png"></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//chrome headless的參數</span></span><br><span class="line">ChromeOptions options = <span class="keyword">new</span> ChromeOptions();</span><br><span class="line">options.AddArgument(<span class="string">&quot;no-sandbox&quot;</span>);</span><br><span class="line">options.AddArgument(<span class="string">&quot;headless&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//取得Driver的位置</span></span><br><span class="line"><span class="keyword">var</span> root = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定Chrome Binary位置</span></span><br><span class="line">options.BinaryLocation = Path.Combine(root, <span class="string">&quot;headless-chromium&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> driver = <span class="keyword">new</span> ChromeDriver(root, options);</span><br></pre></td></tr></table></figure>

<p>做到這邊再執行剛剛的指令應該可以正常拍照了。</p>
<h1 id="掃雷"><a href="#掃雷" class="headerlink" title="掃雷"></a>掃雷</h1><h2 id="亂碼問題"><a href="#亂碼問題" class="headerlink" title="亂碼問題"></a>亂碼問題</h2><p>因為 Chrome Binary 輕量化，所以作者並沒有把中文/日文/韓文包進來，所以拍一下遇到上述文字都會出現亂碼</p>
<div class="note info">
            <p>詳細討論串</p><p><a href="https://github.com/adieuadieu/serverless-chrome/issues/49">Include Chinese/Japanese/Korean/more fonts in headless Chrome binary #49</a></p>
          </div>

<p>依據該討論串下方的回應，已經有對應的解決方案</p>
<p><img src="/images/20181011/9.png" alt="/images/20181011/9.png"></p>
<p>1.將需要的字典檔下載回來放在 Root 的 <code>.fonts</code> 資料夾中</p>
<p><img src="/images/20181011/10.png" alt="/images/20181011/10.png"></p>
<p>2.將 <code>$HOME</code> 環境變數指到 <code>/var/task</code></p>
<p>建立一個檔案 <code>env.variable</code> 裡面寫</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">HOME=/var/task</span><br></pre></td></tr></table></figure>

<p>接著透過 Docker Container 執行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat test.json | docker run --env-file ./env.variable -v <span class="variable">$&#123;PWD&#125;</span>/bin/QA/netcoreapp2.1/publish:/var/task/ -i -e DOCKER_LAMBDA_USE_STDIN=1 lambci/lambda:dotnetcore2.1 xxx.Slsa.Snapshot.Console::xxx.Slsa.Snapshot.Console.SqsHandler::Snapshot</span><br></pre></td></tr></table></figure>

<p>這樣拍出來的中文、韓文、日文的畫面就不會亂碼了</p>
<h2 id="權限"><a href="#權限" class="headerlink" title="權限"></a>權限</h2><p>將程式打包好放到 AWS Lambda 上面跑，隨即碰到以下錯誤</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">Permission denied: Win32Exception</span><br><span class="line">at Interop.Sys.ForkAndExecProcess(String filename, String[] argv, String[] envp, String cwd, Boolean redirectStdin, Boolean redirectStdout, Boolean redirectStderr, Boolean setUser, UInt32 userId, UInt32 groupId, Int32&amp; lpChildPid, Int32&amp; stdinFd, Int32&amp; stdoutFd, Int32&amp; stderrFd, Boolean shouldThrow)</span><br><span class="line">at System.Diagnostics.Process.StartCore(ProcessStartInfo startInfo)</span><br><span class="line">at System.Diagnostics.Process.Start()</span><br><span class="line">at OpenQA.Selenium.DriverService.Start()</span><br><span class="line">at OpenQA.Selenium.Remote.DriverServiceCommandExecutor.Execute(Command commandToExecute)</span><br><span class="line">at OpenQA.Selenium.Remote.RemoteWebDriver.Execute(String driverCommandToExecute, Dictionary`2 parameters)</span><br><span class="line">at OpenQA.Selenium.Remote.RemoteWebDriver.StartSession(ICapabilities desiredCapabilities)</span><br><span class="line">at OpenQA.Selenium.Remote.RemoteWebDriver..ctor(ICommandExecutor commandExecutor, ICapabilities desiredCapabilities)</span><br><span class="line">at OpenQA.Selenium.Chrome.ChromeDriver..ctor(ChromeDriverService service, ChromeOptions options, TimeSpan commandTimeout)</span><br><span class="line">at .........</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>原因是 Lambda 的 <code>/var/task</code> 是 read-only，所以要執行 Chrome Driver 與 Chrome Binary 時會沒有權限，只好用很 tricky 的方式，先把 Chrome Driver 與 Chrome Binary 搬到 <code>/tmp</code> 底下再授予權限</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Isinitialeds this instance.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Initial</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!File.Exists(<span class="string">&quot;/tmp/chromedriver&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        File.Copy(<span class="string">&quot;/var/task/chromedriver&quot;</span>, <span class="string">&quot;/tmp/chromedriver&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        Exec(<span class="string">&quot;chmod +x /tmp/chromedriver&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!File.Exists(<span class="string">&quot;/tmp/headless-chromium&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        File.Copy(<span class="string">&quot;/var/task/headless-chromium&quot;</span>, <span class="string">&quot;/tmp/headless-chromium&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        Exec(<span class="string">&quot;chmod +x /tmp/headless-chromium&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Executes the specified command.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;cmd&quot;&gt;</span>The command.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Exec</span>(<span class="params"><span class="built_in">string</span> cmd</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> escapedArgs = cmd.Replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> process = <span class="keyword">new</span> Process</span><br><span class="line">    &#123;</span><br><span class="line">        StartInfo = <span class="keyword">new</span> ProcessStartInfo</span><br><span class="line">        &#123;</span><br><span class="line">            RedirectStandardOutput = <span class="literal">true</span>,</span><br><span class="line">            UseShellExecute = <span class="literal">false</span>,</span><br><span class="line">            CreateNoWindow = <span class="literal">true</span>,</span><br><span class="line">            WindowStyle = ProcessWindowStyle.Hidden,</span><br><span class="line">            FileName = <span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line">            Arguments = <span class="string">$&quot;-c \&quot;<span class="subst">&#123;escapedArgs&#125;</span>\&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    process.Start();</span><br><span class="line">    process.WaitForExit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//chrome headless的參數</span></span><br><span class="line">ChromeOptions options = <span class="keyword">new</span> ChromeOptions();</span><br><span class="line">options.AddArgument(<span class="string">&quot;no-sandbox&quot;</span>);</span><br><span class="line">options.AddArgument(<span class="string">&quot;headless&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定Chrome Binary位置</span></span><br><span class="line">options.BinaryLocation = <span class="string">&quot;/tmp/headless-chromium&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> driver = <span class="keyword">new</span> ChromeDriver(<span class="string">&quot;/tmp&quot;</span>, options);</span><br></pre></td></tr></table></figure>



<h2 id="CreatePlatformSocket-Operation-not-permitted-1"><a href="#CreatePlatformSocket-Operation-not-permitted-1" class="headerlink" title="CreatePlatformSocket() Operation not permitted (1)"></a>CreatePlatformSocket() Operation not permitted (1)</h2><p>接著遇到下個問題是， ChromeDriver Init 起來時會去呼叫 <a href="http://localhost:xxxx/Session">http://localhost:xxxx/Session</a> ，而這時後就會因為沒有權限而失敗，但這個在 NodeJs 的版本不會發生，查了 Selenium 的 Source Code 也看不出原因，找了相當多的討論串，<del>目前似乎依然無解，也是在這一題後不得不先放棄</del>，改採用相容較高的 NodeJs 版本</p>
<p><img src="/images/20181011/11.png" alt="/images/20181011/11.png"></p>
<div class="note info">
            <p><strong>相關討論串</strong></p><p><a href="https://github.com/SeleniumHQ/selenium/issues/5457">The HTTP request to the remote WebDriver server for URL http://localhost:42607/session timed out after 60 seconds.</a></p><p><a href="https://github.com/SeleniumHQ/selenium/issues/6234">Message: OpenQA.Selenium.WebDriverException : The HTTP request to the remote WebDriver server for URL when using Chrome Headles #6234</a></p>
          </div>



<p><strong>2018-10-25 更新</strong></p>
<p>在產生 ChromeDriver 的時候加上 <code>disable-dev-shm-usage</code> 、 <code>single-process</code> 兩個參數可以解決這個問題，</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line">options.AddArguments(<span class="string">&quot;no-sandbox&quot;</span>, <span class="string">&quot;headless&quot;</span>, <span class="string">&quot;disable-dev-shm-usage&quot;</span>, <span class="string">&quot;disable-gpu&quot;</span>, <span class="string">&quot;single-process&quot;</span>, <span class="string">&quot;no-zygote&quot;</span>, <span class="string">&quot;hide-scrollbars&quot;</span>, <span class="string">&quot;lang=zh-TW,zh&quot;</span>);</span><br><span class="line"></span><br><span class="line">options.BinaryLocation = <span class="string">&quot;/tmp/headless-chromium&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> driver = <span class="keyword">new</span> ChromeDriver(<span class="string">&quot;/tmp&quot;</span>, options);</span><br></pre></td></tr></table></figure>

<p>其中 <code>single-process</code> 為 Chromium 的模式之一，詳細可以參考文件</p>
<div class="note info">
            <p><a href="https://www.chromium.org/developers/design-documents/process-models">[The Chromium Projects] - Process Models</a></p><p><a href="https://peter.sh/experiments/chromium-command-line-switches/">List of Chromium Command Line Switches</a></p>
          </div>



<p><code>disable-dev-shm-usage</code> </p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">To fix, run the container with docker run --shm-size&#x3D;1gb to increase the size of &#x2F;dev&#x2F;shm . Since Chrome 65, this is no longer necessary. Instead, launch the browser with the --disable-dev-shm-usage flag</span><br></pre></td></tr></table></figure>



<p>會找到這個解法是因為去看了 <a href="https://github.com/adieuadieu/serverless-chrome">serverless-chrome</a> 的 source code 發現他是這樣寫的，但這樣搭配為什麼會正常，說實在的目前我還看不出為什麼 ， 只能等之後讀更多文件再看看有沒有辦法解答。</p>
<p>加上這兩個參數後 Lambda 上面雖然還是會報 <code>CreatePlatformSocket() Operation not permitted (1)</code> 錯誤，但減少到只剩下兩次，就正常執行了</p>
<p><img src="/images/20181011/12.png" alt="/images/20181011/12.png"></p>
<h2 id="補充-環境問題"><a href="#補充-環境問題" class="headerlink" title="補充 : 環境問題"></a>補充 : 環境問題</h2><p>最後雖然我們採用了 NodeJs 的版本，但還是踩了一個小小的雷，那就是要把檔案壓縮成 zip 檔放到 AWS Lambda 時，相同的程式用我的電腦壓出來是不能執行，但同事壓出來的 zip 檔案卻可以，經過測試後發現，因為我的 Mac 語系環境是中文，壓縮出來時預設會是<code>封裝.zip</code>，不管是中文的的放上去，或是改了檔名後放上去都會錯誤。</p>
<p>只能下 command 指定壓縮出來的檔名才可解決這個問題</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ zip -r -j ./destination/pacakge ./<span class="built_in">source</span></span><br></pre></td></tr></table></figure>

<p>相同的，在 Windows 壓出來放上去一樣會壞掉，推測是相同原因….真的是雷到你不要不要的</p>
<p><strong>2018-10-25 更新</strong></p>
<p>網路上找到有人討論 Windows 壓縮後放上去會壞掉的問題，解法是請安裝 7zip，並且直接到 root 層執行壓縮，壓完後解壓就要是Root，不要再包一層資料夾，另外…只能用 GUI 執行壓縮，我用 PowerShell 壓縮一樣不行，不知道為什麼(暈)，難怪論壇開宗明義第一句話就是，<strong>不要用 Windows</strong> ，Linux base 的東西跟 windows 真的是很不合…</p>
<p><img src="/images/20181011/13.png" alt="/images/20181011/13.png"></p>
 <div class="note info">
            <p><a href="https://forums.aws.amazon.com/thread.jspa?threadID=179638">Lambda disdains ZIP files compressed with PowerShell</a></p>
          </div>











]]></content>
      <tags>
        <tag>dotnet core</tag>
        <tag>AWS</tag>
        <tag>Lambda</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC教學】1. 工欲善其事、必先利其器 Visual Studio</title>
    <url>/2018/02/21/%E3%80%90MVC%E6%95%99%E5%AD%B8%E3%80%911-%E5%B7%A5%E6%AC%B2%E5%96%84%E5%85%B6%E4%BA%8B%E3%80%81%E5%BF%85%E5%85%88%E5%88%A9%E5%85%B6%E5%99%A8-Visual-Studio/</url>
    <content><![CDATA[<p>年前朋友討論是否寫Dot Net Mvc的簡單教學文章,害我過年都在思考該怎麼寫這東西…可惡(果然是個心裡容不下待辦事項的人啊)。</p>
<p>認真的想了後覺得這真是個非常難的主題,一來是網路上已經有很多資源,我也不是什麼大神,很怕誤人子弟。二來雖然以前曾經幫忙教育訓練過新進同事,但面對面的溝通且依照每個人程度不同給予討論,跟用文章教會一個不知道對象是誰,且博大精深的框架與語言,這個差距實在太大,所以最後只好一直將目標縮小再縮小,希望這系列文如果看完時能達到以下目標我就滿足了</p>
<p>**目標對象 **</p>
<div class="note info">
            <p>1.你有一點程式語言的底子,但沒接觸過Dot Net MVC<br>2.寫過Dot Net MVC,但還不是很熟悉它怎麼應用</p>
          </div>

<p><strong>希望達成目標</strong></p>
<div class="note info">
            <p>1.能夠比較清楚的理解Dot Net MVC怎麼運作<br>2.知道了一些小東西,或許能改善目前你開發上困擾</p>
          </div>


<p>那就先從工具開始吧</p>
<div class="note info">
            <p>Visual Studio Community : <a href="https://www.visualstudio.com/zh-hant/vs/community/">微軟官網載點</a></p>
          </div>
<p>開發Dot Net的工程師,應該9成9的人都是使用Visual Studio,它不僅號稱地表最強編輯器,微軟更佛心的提供了免費版本給大家使用,否則最基礎的一套Visual Studio的價格應該也會讓初學者非常卻步。</p>
<p>當然既然是免費版本,功能上一定會有些陽春,但對於只是入門學習Dot Net而言已經是相當強大的工具了。</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://4.bp.blogspot.com/-AThY6IIeOMU/Wozqfrbkj8I/AAAAAAAAIhM/unPhEYOMwi4GocjIIbH3sQLsG6zFLwLXgCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258A%25E5%258D%258811.41.26.png)](https://4.bp.blogspot.com/-AThY6IIeOMU/Wozqfrbkj8I/AAAAAAAAIhM/unPhEYOMwi4GocjIIbH3sQLsG6zFLwLXgCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258A%25E5%258D%258811.41.26.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">功能比較(來源: [https://www.visualstudio.com/zh-hant/vs/compare/](https://www.visualstudio.com/zh-hant/vs/compare/))</td></tr></tbody></table>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-IAZ842DU7bE/WozrAMFvS5I/AAAAAAAAIhU/hXxvWOr48VIim3dJ2gxOVdllEfdLsvspgCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258A%25E5%258D%258811.43.35.png)](https://2.bp.blogspot.com/-IAZ842DU7bE/WozrAMFvS5I/AAAAAAAAIhU/hXxvWOr48VIim3dJ2gxOVdllEfdLsvspgCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258A%25E5%258D%258811.43.35.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">價格表(來源:[https://www.visualstudio.com/zh-hant/vs/pricing/](https://www.visualstudio.com/zh-hant/vs/pricing/))</td></tr></tbody></table>

<p>下載完之後將它安裝起來</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://4.bp.blogspot.com/-l_GogekWtuo/Wo0NeymgUGI/AAAAAAAAIhk/a9KRtEucnA8ZAofXpTfM1WKc0Cn1-VSeACLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25882.10.47.png)](https://4.bp.blogspot.com/-l_GogekWtuo/Wo0NeymgUGI/AAAAAAAAIhk/a9KRtEucnA8ZAofXpTfM1WKc0Cn1-VSeACLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25882.10.47.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">選擇Community安裝</td></tr></tbody></table><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://4.bp.blogspot.com/-VxH0BFcP1N4/Wo0OAeM_n8I/AAAAAAAAIhs/XbpBzTLtFQsEQwdPNDVF0V1-yghRDhHMgCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25882.13.01.png)](https://4.bp.blogspot.com/-VxH0BFcP1N4/Wo0OAeM_n8I/AAAAAAAAIhs/XbpBzTLtFQsEQwdPNDVF0V1-yghRDhHMgCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25882.13.01.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">勾選ASP.NET與網頁程式開發</td></tr></tbody></table><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://1.bp.blogspot.com/-YT3wMLUPuxQ/Wo0OS6i817I/AAAAAAAAIhw/cJGnL6jonT0Kf9XxbKzB9k_5qT6vdB16wCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25882.14.13.png)](https://1.bp.blogspot.com/-YT3wMLUPuxQ/Wo0OS6i817I/AAAAAAAAIhw/cJGnL6jonT0Kf9XxbKzB9k_5qT6vdB16wCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25882.14.13.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">等它安裝完</td></tr></tbody></table>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-mb-CXRobkYs/Wo0ZC8U4VJI/AAAAAAAAIiE/hVP-yUd9UtMsSVpt3iVTjyRgksp825iLwCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.00.10.png)](https://2.bp.blogspot.com/-mb-CXRobkYs/Wo0ZC8U4VJI/AAAAAAAAIiE/hVP-yUd9UtMsSVpt3iVTjyRgksp825iLwCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.00.10.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">安裝完之後打開應該會看到這個畫面</td></tr></tbody></table>
<div class="note info">
            <p>因為寫程式大部分時間都需要一直長盯著螢幕,所以螢幕底色如果是淺色系通常到下午我眼睛都會很酸,所以Visual Studio也很貼心了提供修改視窗色系的功能,例如我截圖就是深色系。<br>調整方式如下<br>工具 &gt; 選項 &gt; 色彩佈景主題<br><a href="https://1.bp.blogspot.com/-ExYk1nrzalI/Wo0aNHm1jLI/AAAAAAAAIiM/xA5vmqHWUkgo1DYB_4zz9nbfb1oKw3vyQCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.03.31.png"><img src="https://1.bp.blogspot.com/-ExYk1nrzalI/Wo0aNHm1jLI/AAAAAAAAIiM/xA5vmqHWUkgo1DYB_4zz9nbfb1oKw3vyQCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.03.31.png"></a></p>
          </div>
**
****
****建立第一個Web專案**
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-8NkEiv-Pdy0/Wo0atMIeTBI/AAAAAAAAIiY/Xqtt1Nt4vdYMutyRHnF6SK0ywGJw6IBVwCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.07.17.png)](https://3.bp.blogspot.com/-8NkEiv-Pdy0/Wo0atMIeTBI/AAAAAAAAIiY/Xqtt1Nt4vdYMutyRHnF6SK0ywGJw6IBVwCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.07.17.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">檔案 &gt; 新增 &gt; 專案</td></tr></tbody></table><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-52w4Z2LQrMo/Wo0bFfQ42ZI/AAAAAAAAIic/W7IdEeXSIqIh3rG2CmSN4slAT6Qu1qkzgCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.08.51.png)](https://3.bp.blogspot.com/-52w4Z2LQrMo/Wo0bFfQ42ZI/AAAAAAAAIic/W7IdEeXSIqIh3rG2CmSN4slAT6Qu1qkzgCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.08.51.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">選擇Web &gt; Web應用程式(.NET Framework) 。
專案名稱與放的位置依照自己喜好即可</td></tr></tbody></table><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-sG9_1osHZzM/Wo0bo1ny1kI/AAAAAAAAIio/mRKCMTpCjp461LAbSFCK6EzS02y1Z02KQCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.11.14.png)](https://3.bp.blogspot.com/-sG9_1osHZzM/Wo0bo1ny1kI/AAAAAAAAIio/mRKCMTpCjp461LAbSFCK6EzS02y1Z02KQCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.11.14.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">選擇MVC</td></tr></tbody></table>
建立完成之後應該可以看到這個畫面
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-bgNV43jpPbY/Wo0cBzZrZPI/AAAAAAAAIis/U152KITJzwkkk3aMigyzBB7fAyCPS0pIACLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.12.56.png)](https://3.bp.blogspot.com/-bgNV43jpPbY/Wo0cBzZrZPI/AAAAAAAAIis/U152KITJzwkkk3aMigyzBB7fAyCPS0pIACLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.12.56.png)</div><div class="note info">
            <p>如果看不到方案總管,可以透過<strong>檢視</strong>&gt; <strong>方案總管</strong>來打開</p>
          </div>


<p>右邊就是我們寫程式要放的地方,之後介紹Dot Net MVC時會慢慢帶到,但今天還不需要寫到程式,先直接將程式執行起來,看看預設建立好的網站是長什麼樣</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-rsiatvazfV0/Wo0dW96VDgI/AAAAAAAAIi0/62hUceI6RWI5zmuuQrkAE9MP5q0ZXAjaQCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.17.44.png)](https://2.bp.blogspot.com/-rsiatvazfV0/Wo0dW96VDgI/AAAAAAAAIi0/62hUceI6RWI5zmuuQrkAE9MP5q0ZXAjaQCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.17.44.png)</div>
因為這是網站程式, 點選執行旁邊的向下箭頭後,可以依照個人喜好選擇習慣用的瀏覽器來瀏覽,我個人是習慣用Google Chrome,所以以下用Chrome做示範,選好後按下綠色的箭頭執行。

<p>執行起來之後應該可以看到一個很專業的診斷工具面板,分別顯示目前佔了CPU幾%,用了多少記憶體…等等</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-02yTU2prJZY/Wo0ekE8DgvI/AAAAAAAAIi8/8BiY3LezXhUhV7QMK8XeKO9oy3RG4jKOQCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.22.30.png)](https://2.bp.blogspot.com/-02yTU2prJZY/Wo0ekE8DgvI/AAAAAAAAIi8/8BiY3LezXhUhV7QMK8XeKO9oy3RG4jKOQCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.22.30.png)</div>

<p>而這時候你選擇的瀏覽器應該也會開啟，然後看到目前網站的成果</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-Xw28Lnnj1vI/Wo0euDl5nmI/AAAAAAAAIjA/hj1eQKYS0jcS8goj3FDv0yngDCHDYPmVACLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.24.20.png)](https://2.bp.blogspot.com/-Xw28Lnnj1vI/Wo0euDl5nmI/AAAAAAAAIjA/hj1eQKYS0jcS8goj3FDv0yngDCHDYPmVACLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.24.20.png)</div>

<p>可以隨意的點擊網站按鈕逛逛玩玩後,現在來簡單講一下該如何追蹤偵錯</p>
<div class="note info">
            <p>偵錯是門大學問,常常我們寫的程式編譯時都沒有錯誤,但執行結果卻不如我們預期那般時,一步一步偵錯就會是我們發現問題的好朋友</p>
          </div>

<p>我們以<strong>關於這個按鈕</strong>為例,究竟點擊<strong>關於</strong>這個按鈕時,程式是如何執行,讓我們可以看到畫面的</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/--aluBIC6nMg/Wo0gH9fbBYI/AAAAAAAAIjQ/BaKOSBTJacIOl9_W7YAz8lqi-9Fx5C0FQCLcBGAs/s640/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.29.58.png)](https://3.bp.blogspot.com/--aluBIC6nMg/Wo0gH9fbBYI/AAAAAAAAIjQ/BaKOSBTJacIOl9_W7YAz8lqi-9Fx5C0FQCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.29.58.png)</div>

<p>因為我們還不知道目前整個程式的運作原理,所以依照下面的指示這樣做</p>
<ol>
<li><p> 找到HomeController,並且打開它</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-kCJKeJELsx0/Wo0gxIiQthI/AAAAAAAAIjY/FPc1xN8m0oQzv5tfWhG8hf649M2gp4jUACLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.31.50.png)](https://4.bp.blogspot.com/-kCJKeJELsx0/Wo0gxIiQthI/AAAAAAAAIjY/FPc1xN8m0oQzv5tfWhG8hf649M2gp4jUACLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.31.50.png)</div></li>
<li><p> 找到第18行的地方,點擊那行的最左邊邊框,會產生一個紅色的原點,我們稱之為中斷點</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-LIvuofL8J2g/Wo0ha-LzXzI/AAAAAAAAIjg/GrPyIZE-hss6nVqf2b6CgYKIhaXTjpfNgCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.34.22.png)](https://2.bp.blogspot.com/-LIvuofL8J2g/Wo0ha-LzXzI/AAAAAAAAIjg/GrPyIZE-hss6nVqf2b6CgYKIhaXTjpfNgCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.34.22.png)</div><div class="note info">
            <p>中斷點的意思就是,當程式執行到這行時會停下來讓你知道,並且等待你的指示</p>
          </div></li>
<li><p> 接著再回去剛剛的網頁點擊<strong>關於,<strong>你會發現</strong>,視窗會跳到你剛剛下得中斷點位置,而網頁會卡住,並沒有顯示關於的頁面</strong><div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-_VDwlMMcZM0/Wo0iMV7i_mI/AAAAAAAAIjo/8yZiG4s8Kb0bXtwGlMl4UaLUxau9yZ5rACLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.39.13.png"><img src="https://3.bp.blogspot.com/-_VDwlMMcZM0/Wo0iMV7i_mI/AAAAAAAAIjo/8yZiG4s8Kb0bXtwGlMl4UaLUxau9yZ5rACLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.39.13.png"></a></div><br>那是因為程式還沒執行完,所以還沒辦法顯示頁面資訊4.  按下<strong>F11</strong>,每按一次<strong>F11</strong>,你會看到程式往下走一行,藉此來觀察程式如何運行,並且是否符合我們預期的結果</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-2hTcGcR7bAg/Wo0mas9EleI/AAAAAAAAIj0/H7T3H2WKSO0yF_lGqHIcrR-CxhuraR1egCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.56.54.png)](https://4.bp.blogspot.com/-2hTcGcR7bAg/Wo0mas9EleI/AAAAAAAAIj0/H7T3H2WKSO0yF_lGqHIcrR-CxhuraR1egCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25883.56.54.png)</div></li>
<li><p> 當然,我們不必每次進入中斷點後都一步一步將它執行完,如果已經找到哪邊有問題,只要再按下繼續,程式就會自動往下跑,直到碰到下一個中斷點為止 <div class="separator" style="clear: both; text-align: center;"><a href="https://3.bp.blogspot.com/-R2SEzOTjLeU/Wo0nRTaBCsI/AAAAAAAAIj8/Sx_eFGxFUgo0TNDMGsWEcVYutD1U9pYSgCLcBGAs/s1600/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25884.00.22.png"><img src="https://3.bp.blogspot.com/-R2SEzOTjLeU/Wo0nRTaBCsI/AAAAAAAAIj8/Sx_eFGxFUgo0TNDMGsWEcVYutD1U9pYSgCLcBGAs/s400/%25E8%259E%25A2%25E5%25B9%2595%25E5%25BF%25AB%25E7%2585%25A7%2B2018-02-21%2B%25E4%25B8%258B%25E5%258D%25884.00.22.png"></a></div><br>當然以上所提的,都是非常非常基礎的Visual Studio（之後文章都簡稱為VS）操作,跟日常比較會運用到的情境,VS之所以被人稱為地表最強編輯器,想當然耳不可能只有這樣而已,但這都是要慢慢開發中去體會跟累積的。相信如果真的用久了,開始使用擴充輔助套件之類的,就會知道它的強大之處。</p>
</li>
</ol>
<p>下一篇來提何謂MVC，知道後應就能理解為何會知道<strong>關於</strong>這個按鈕點擊後,會停在我們今天下的中斷點了。</p>
]]></content>
      <categories>
        <category>學習MVC</category>
      </categories>
      <tags>
        <tag>MVC教學</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC教學】8.View(一)</title>
    <url>/2018/06/27/%E3%80%90MVC%E6%95%99%E5%AD%B8%E3%80%918.View(%E4%B8%80)/</url>
    <content><![CDATA[<div class="note info">
            <p>Demo範例 ：<a href="https://github.com/toyo0103/HelloDotNetMVC">Git位置</a></p>
          </div>

<h1 id="目標"><a href="#目標" class="headerlink" title="#目標"></a>#目標</h1><p>將網路上下載來的免費漂亮版型套進專案中，從實作中瞭解如何<strong>套版</strong>跟應用.Net提供的一些API方法，過程中或許會有許多小地方不懂，例如Html結構，View Render的機制等等，沒關係，這會在後續的篇章中慢慢補足，而此篇主要是希望讓讀者知道套版原理，並享受網頁隨著套版變漂亮的過程。</p>
<div class="note info">
            <p>在Google搜尋中輸入free template download可以找到一大堆免費授權的版型，而這次從這個<a href="https://templated.co/">TEMPLATED</a>挑了一個喜歡的，有興趣可以先看一下該版型的<a href="https://templated.co/hielo">Live Demo</a></p>
          </div>

<p><img src="/images/20180627/1.jpg" alt="/images/20180627/1.jpg"></p>
<p>如果不方便從網路下載也無妨，我已經將下載好且解壓的版本放到Git的專案之中，如果要練習可以直接從裡面取得Source Code</p>
<p><img src="/images/20180627/2.jpg" alt="/images/20180627/2.jpg"></p>
<h1 id="實作"><a href="#實作" class="headerlink" title="#實作"></a>#實作</h1><h2 id="套版前準備"><a href="#套版前準備" class="headerlink" title="套版前準備"></a>套版前準備</h2><h3 id="Chrome"><a href="#Chrome" class="headerlink" title="Chrome"></a>Chrome</h3><p>通常我會用Chrome瀏覽器來輔助套版的工作，所以以下的操作都是針對Chrome撰寫，不過現在各家瀏覽器其實都大同小異了，只要有相對應的功能即可。</p>
<div class="note info">
            <p><a href="https://www.google.com.tw/chrome/index.html">Chrome下載</a></p>
          </div>



<h3 id="Web-Server-For-Chrome-非必要"><a href="#Web-Server-For-Chrome-非必要" class="headerlink" title="Web Server For Chrome(非必要)"></a>Web Server For Chrome(非必要)</h3><p>為了方便瀏覽下載的版型，可以安裝Web Server For Chrome這個套件</p>
<p><img src="/images/20180627/3.jpg" alt="/images/20180627/3.jpg"></p>
<p>安裝完後應該會在Chrome的<strong>應用程式</strong>中看到Web Server</p>
<p><img src="/images/20180627/4.jpg" alt="/images/20180627/4.jpg"></p>
<p>打開它並把資料夾選到版型的根目錄</p>
<p><img src="/images/20180627/5.jpg" alt="/images/20180627/5.jpg"></p>
<p><img src="/images/20180627/6.jpg" alt="/images/20180627/6.jpg"></p>
<p>點擊**Web Server URL(s)**，應該就可以看到網站出現了</p>
<p><img src="/images/20180627/7.jpg" alt="/images/20180627/7.jpg"></p>
<p><img src="/images/20180627/8.jpg" alt="/images/20180627/8.jpg"></p>
<h2 id="首頁套版"><a href="#首頁套版" class="headerlink" title="首頁套版"></a>首頁套版</h2><p>從Visual Studio中開啟Index.html</p>
<p><img src="/images/20180627/9.jpg" alt="/images/20180627/9.jpg"></p>
<p><img src="/images/20180627/10.jpg" alt="/images/20180627/10.jpg"></p>
<p>將<strong>所有內容</strong>複製貼到我們的/Home/Index.cshtml之中</p>
<p><img src="/images/20180627/11.jpg" alt="/images/20180627/11.jpg"></p>
<p>這時候會發現第一個錯誤</p>
<p><img src="/images/20180627/12.jpg" alt="/images/20180627/12.jpg"></p>
<h3 id="跳脫字元"><a href="#跳脫字元" class="headerlink" title="跳脫字元"></a>跳脫字元</h3><p>原因是.Net MVC預設用的套版語法是Razor，而**@<strong>是它的保留字，所以要用跳脫字元來解決，只要將*@*templatedco變成</strong>@@templatedco**，它在顯示網頁的時候就會印出我們想要的@templatedco了</p>
<p><img src="/images/20180627/13.jpg" alt="/images/20180627/13.jpg"></p>
<p>執行網站看首頁結果會發現，它怪怪的…</p>
<p><img src="/images/20180627/14.jpg" alt="/images/20180627/14.jpg"></p>
<h3 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h3><p>首先網頁最上面那排黑黑的Header，明明我們版型的Header沒這塊，它是從哪邊長出來的?</p>
<p>這邊就要瞭解<strong>Layout</strong>是什麼</p>
<p><img src="/images/20180627/15.jpg" alt="/images/20180627/15.jpg"></p>
<p>很多網頁都會有一個特性，那就是不管切換到哪個頁面都會有共用的區塊，以Sony頁面為例</p>
<p><strong>PlayStation頁面</strong></p>
<p><img src="/images/20180627/16.jpg" alt="/images/20180627/16.jpg"></p>
<p><strong>消費性電子&gt;電視頁面</strong></p>
<p><img src="/images/20180627/17.jpg" alt="/images/20180627/17.jpg"></p>
<p>共通點就是Header不管到哪一頁都不會換</p>
<p><img src="/images/20180627/18.jpg" alt="/images/20180627/18.jpg"></p>
<p>而如果每頁都要重新把Header套版一次會衍伸一些問題</p>
<ul>
<li><strong>重工</strong> : 有一百頁就要把一樣的內容貼一百次</li>
<li><strong>維護困難</strong> : 如果想在Header多一顆按鈕，就要打開一百個頁面調整一百次</li>
</ul>
<p>所以實務上會透過Layout來解決這問題，將全站幾乎都會共用的部分抽出來當Layout，而會變動的部分當作<strong>Body</strong>。</p>
<p>所以套用了新的版型還會跑出Header，那是因為Layout裡面有這個區塊</p>
<p><img src="/images/20180627/19.jpg" alt="/images/20180627/19.jpg"></p>
<p>依照剛剛說的，我們把共用的區塊抽到Layout裡面去放</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    Hielo by TEMPLATED</span></span><br><span class="line"><span class="comment">    templated.co @@templatedco</span></span><br><span class="line"><span class="comment">    Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hielo by TEMPLATED<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;assets/css/main.css&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        ....</span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>Layout調整成</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    Hielo by TEMPLATED</span></span><br><span class="line"><span class="comment">    templated.co @@templatedco</span></span><br><span class="line"><span class="comment">    Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hielo by TEMPLATED<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;assets/css/main.css&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    @RenderBody()</span><br><span class="line"></span><br><span class="line">    @RenderSection(&quot;scripts&quot;, required: false)</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        @<span class="keyword">if</span> (TempData[<span class="string">&quot;Message&quot;</span>] != <span class="literal">null</span>)</span></span><br><span class="line">        &#123;</span><br><span class="line"><span class="handlebars"><span class="xml">            <span class="tag">&lt;<span class="name">text</span>&gt;</span>alert(&#x27;@TempData[&quot;Message&quot;]&#x27;)<span class="tag">&lt;/<span class="name">text</span>&gt;</span></span></span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>Index調整成</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    ViewBag.Title = &quot;Home Page&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Header --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span> <span class="attr">id</span>=<span class="string">&quot;header&quot;</span> <span class="attr">class</span>=<span class="string">&quot;alt&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;logo&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;index.html&quot;</span>&gt;</span>Hielo <span class="tag">&lt;<span class="name">span</span>&gt;</span>by TEMPLATED<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#menu&quot;</span>&gt;</span>Menu<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Nav --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">id</span>=<span class="string">&quot;menu&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;links&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;index.html&quot;</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;generic.html&quot;</span>&gt;</span>Generic<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;elements.html&quot;</span>&gt;</span>Elements<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Banner --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">class</span>=<span class="string">&quot;banner full&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">article</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/slide01.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inner&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>A free responsive web site template by <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://templated.co&quot;</span>&gt;</span>TEMPLATED<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Hielo<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">article</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/slide02.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inner&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>Lorem ipsum dolor sit amet nullam feugiat<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Magna etiam<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">article</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/slide03.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inner&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>Sed cursus aliuam veroeros lorem ipsum nullam<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Tempus dolor<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">article</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/slide04.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inner&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>Adipiscing lorem ipsum feugiat sed phasellus consequat<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Etiam feugiat<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">article</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/slide05.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inner&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">header</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>Ipsum dolor sed magna veroeros lorem ipsum<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Lorem adipiscing<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">article</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- One --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">id</span>=<span class="string">&quot;one&quot;</span> <span class="attr">class</span>=<span class="string">&quot;wrapper style2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inner&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;grid-style&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;image fit&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/pic02.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">&quot;align-center&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">p</span>&gt;</span>maecenas sapien feugiat ex purus<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Lorem ipsum dolor<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span>&gt;</span> Cras aliquet urna ut sapien tincidunt, quis malesuada elit facilisis. Vestibulum sit amet tortor velit. Nam elementum nibh a libero pharetra elementum. Maecenas feugiat ex purus, quis volutpat lacus placerat malesuada.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">footer</span> <span class="attr">class</span>=<span class="string">&quot;align-center&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button alt&quot;</span>&gt;</span>Learn More<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;image fit&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/pic03.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;content&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">&quot;align-center&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">p</span>&gt;</span>mattis elementum sapien pretium tellus<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Vestibulum sit amet<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">p</span>&gt;</span> Cras aliquet urna ut sapien tincidunt, quis malesuada elit facilisis. Vestibulum sit amet tortor velit. Nam elementum nibh a libero pharetra elementum. Maecenas feugiat ex purus, quis volutpat lacus placerat malesuada.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">footer</span> <span class="attr">class</span>=<span class="string">&quot;align-center&quot;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;button alt&quot;</span>&gt;</span>Learn More<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Two --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">id</span>=<span class="string">&quot;two&quot;</span> <span class="attr">class</span>=<span class="string">&quot;wrapper style3&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inner&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">&quot;align-center&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Nam vel ante sit amet libero scelerisque facilisis eleifend vitae urna<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Morbi maximus justo<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Three --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">section</span> <span class="attr">id</span>=<span class="string">&quot;three&quot;</span> <span class="attr">class</span>=<span class="string">&quot;wrapper style2&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;inner&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">header</span> <span class="attr">class</span>=<span class="string">&quot;align-center&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">&quot;special&quot;</span>&gt;</span>Nam vel ante sit amet libero scelerisque facilisis eleifend vitae urna<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h2</span>&gt;</span>Morbi maximus justo<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;gallery&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;image fit&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/pic01.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;image fit&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/pic02.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;image fit&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/pic03.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;image fit&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;images/pic04.jpg&quot;</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> /&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">section</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Footer --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">footer</span> <span class="attr">id</span>=<span class="string">&quot;footer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;icons&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;icon fa-twitter&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Twitter<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;icon fa-facebook&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Facebook<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;icon fa-instagram&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Instagram<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">class</span>=<span class="string">&quot;icon fa-envelope-o&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;label&quot;</span>&gt;</span>Email<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;copyright&quot;</span>&gt;</span></span><br><span class="line">        <span class="symbol">&amp;copy;</span> Untitled. All rights reserved.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">footer</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Scripts --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/jquery.scrollex.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/skel.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/util.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/main.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="RenderBody"><a href="#RenderBody" class="headerlink" title="@RenderBody()"></a>@RenderBody()</h4><p>Layout中間有一行@RenderBody()這是Razor提供的方法，意思是所有套用這個Layout的頁面，它的內容會取代@RenderBody()。</p>
<p>假設我們的Index內容為</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>I&#x27;m Index<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>那套上Layout後產生給使用者看到的完整Html就會是這樣</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    Hielo by TEMPLATED</span></span><br><span class="line"><span class="comment">    templated.co @@templatedco</span></span><br><span class="line"><span class="comment">    Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hielo by TEMPLATED<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;assets/css/main.css&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>I&#x27;m Index<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    .....</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="RenderSection"><a href="#RenderSection" class="headerlink" title="@RenderSection()"></a>@RenderSection()</h4><p>實務上會希望Javascript或是CSS在特定的地方載入，如果只是單純放在Index中將會變成這樣</p>
<p><strong>Index</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>I&#x27;m Index<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>結果</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    Hielo by TEMPLATED</span></span><br><span class="line"><span class="comment">    templated.co @@templatedco</span></span><br><span class="line"><span class="comment">    Released for free under the Creative Commons Attribution 3.0 license (templated.co/license)</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hielo by TEMPLATED<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;assets/css/main.css&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>I&#x27;m Index<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    ....</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>此時就可以透過在Layout中挖**@RenderSection()**區塊來解決</p>
<p><strong>Layout</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    ....</span><br><span class="line">    @RenderSection(&quot;css&quot;, required: false)</span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    @RenderBody()</span><br><span class="line"></span><br><span class="line">    @RenderSection(&quot;scripts&quot;, required: false)</span><br><span class="line">    ....</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>Index</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">@section scripts&#123;</span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#125;</span><br><span class="line">@section css&#123;</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;assets/css/main.css&quot;</span> /&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>I&#x27;m Index<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>結果</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">HTML</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    ....</span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;assets/css/main.css&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>I&#x27;m Index<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;assets/js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    ....</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<div class="note info">
            <p>@RenderSection(“scripts”, <strong>required: false</strong>)</p><p>required參數意義為 </p><p><strong>True</strong> :套用這個Layout的子版面一定要寫@section scripts{ }這個區段</p><p><strong>False</strong> :套用這個Layout的子版面可以沒有@section scripts{ }區段</p>
          </div>



<h3 id="ViewStart"><a href="#ViewStart" class="headerlink" title="_ViewStart"></a>_ViewStart</h3><p>檢視Index頁面，為何它知道要套用Layout呢?其實這寫在_ViewStart.cshtml之中</p>
<p><img src="/images/20180627/20.jpg" alt="/images/20180627/20.jpg"></p>
<p><strong>_ViewStart.cshtml</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = &quot;~/Views/Shared/_Layout.cshtml&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>所有頁面如果沒有特別指定Layout的情況下，預設套用這個設定。</p>
<p>但這不意謂著不能自行修改，假設所有專案有兩三個頁面要套用_Layout2.cshtml，那我們可以在<strong>各自的頁面中</strong>指定Layout，而指定的Layout優先於預設。</p>
<p><strong>Index</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">@&#123;</span><br><span class="line">    Layout = &quot;~/Views/Shared/_Layout2.cshtml&quot;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>I&#x27;m Index<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="載入CSS、Javascript"><a href="#載入CSS、Javascript" class="headerlink" title="載入CSS、Javascript"></a>載入CSS、Javascript</h3><p>重新調整Layout與Index內容後，頁面依然沒有正常顯示</p>
<p><img src="/images/20180627/21.jpg" alt="/images/20180627/21.jpg"></p>
<p>在Chrome按下<strong>F12</strong>點擊右上角的錯誤可以得知是因為沒有載入CSS與Javascript</p>
<p><img src="/images/20180627/22.jpg" alt="/images/20180627/22.jpg"></p>
<p><strong>將Javascript與CSS移到專案之中</strong></p>
<p><img src="/images/20180627/23.jpg" alt="/images/20180627/23.jpg"></p>
<p><img src="/images/20180627/24.jpg" alt="/images/20180627/24.jpg"></p>
<p>同時我們也刪除掉原本在專案內的Javascript與CSS</p>
<p><strong>修改Index中Javascript的位置</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">....</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Scripts --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;~/assets/js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;~/assets/js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;~/assets/js/jquery.scrollex.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;~/assets/js/skel.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;~/assets/js/util.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;~/assets/js/main.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>修改_Layout中CSS的位置</strong></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hielo by TEMPLATED<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;viewport&quot;</span> <span class="attr">content</span>=<span class="string">&quot;width=device-width, initial-scale=1&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&quot;~/assets/css/main.css&quot;</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<div class="note info">
            <p>~/assets/css/main.css</p><p>~/assets/js/main.js</p><p>前面的 <strong>~</strong> 符號表示從根目錄開始算起</p>
          </div>



<p><strong>再次執行專案</strong></p>
<p>發生錯誤，原因是BundleConfig的地方有抓原本放Javascript的資料夾但被我們砍掉了，Bundle基本上目前我們很少用到所以先暫時不理它，把內容清空不影響結果</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BundleConfig</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 如需統合的詳細資訊，請瀏覽 https://go.microsoft.com/fwlink/?LinkId=301862</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RegisterBundles</span>(<span class="params">BundleCollection bundles</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>執行起來後</p>
<p><img src="/images/20180627/25.jpg" alt="/images/20180627/25.jpg"></p>
<p>看起來正常許多但圖片還是沒有出來，將圖片移入</p>
<p><img src="/images/20180627/26.jpg" alt="/images/20180627/26.jpg"></p>
<p><img src="/images/20180627/27.jpg" alt="/images/20180627/27.jpg"></p>
<h1 id="小結"><a href="#小結" class="headerlink" title="#小結"></a>#小結</h1><p><img src="/images/20180627/28.jpg" alt="/images/20180627/28.jpg"></p>
<p>已經成功將首頁移入專案之中，下一篇將來客製化將之前完成的登入頁面也套進這個漂亮的版型之中，中間將會碰到更多套版的Razor API與一些小技巧。</p>
]]></content>
      <categories>
        <category>學習MVC</category>
      </categories>
      <tags>
        <tag>MVC教學</tag>
      </tags>
  </entry>
  <entry>
    <title>【四元樹】透過四元樹搜尋範圍內的座標</title>
    <url>/2016/09/26/%E3%80%90%E5%9B%9B%E5%85%83%E6%A8%B9%E3%80%91%E9%80%8F%E9%81%8E%E5%9B%9B%E5%85%83%E6%A8%B9%E6%90%9C%E5%B0%8B%E7%AF%84%E5%9C%8D%E5%85%A7%E7%9A%84%E5%BA%A7%E6%A8%99/</url>
    <content><![CDATA[<p>將之前四元樹的程式改良後寫成筆記，之後用到才不會忘記 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Class QuadTreeNode.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">QuadTreeNode</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">        <span class="keyword">where</span> <span class="title">T</span> : <span class="title">IQuadTreeNodeData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 西北象限.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The north west.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode&lt;T&gt; NorthWest &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 東北象限.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The north east.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode&lt;T&gt; NorthEast &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 西南象限.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The south west.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode&lt;T&gt; SouthWest &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 東南象限.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The south east.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode&lt;T&gt; SouthEast &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 邊界</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> BoundingBox BoundingBox &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 節點數量</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> BucketCapacity &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 節點</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> List&lt;T&gt; Points &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Initializes a new instance of the <span class="doctag">&lt;see cref=&quot;QuadTreeNode&#123;T&#125;&quot;/&gt;</span> class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;boundingBox&quot;&gt;</span>The bounding box.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;capacity&quot;&gt;</span>The capacity.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">QuadTreeNode</span>(<span class="params">BoundingBox boundingBox, <span class="built_in">int</span> capacity</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            BoundingBox = boundingBox;</span><br><span class="line">            BucketCapacity = capacity;</span><br><span class="line">            Points = <span class="keyword">new</span> List&lt;T&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>要使用四元樹，就要將資料結點實作這個介面 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> &amp;lt;summary&amp;gt;</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface IQuadTreeNodeData.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> &amp;lt;/summary&amp;gt;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IQuadTreeNodeData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &amp;lt;summary&amp;gt;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Gets or sets the position.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &amp;lt;/summary&amp;gt;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &amp;lt;value&amp;gt;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The position.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &amp;lt;/value&amp;gt;</span></span><br><span class="line">        Coordinate Position &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>要搜尋範圍的DTO </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Class BoundingBox.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoundingBox</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 左上角節點</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> Coordinate LeftTop &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 右下角節點</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> Coordinate RightBottom &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Class Coordinate.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Coordinate</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 緯度</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Latitude &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 經度</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Longitude &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>四元樹搜尋邏輯 </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Class QuadTreeService.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">QuadTreeService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Inserts the specified node.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span>The node.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span>The data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Insert</span>&lt;<span class="title">T</span>&gt;(<span class="params">QuadTreeNode&lt;T&gt; node, T data</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> T : IQuadTreeNodeData</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Bail if our coordinate is not in the boundingBox</span></span><br><span class="line">            <span class="keyword">if</span> (!CheckBoundingBoxContainData(node.BoundingBox, data))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the coordinate to the points array</span></span><br><span class="line">            <span class="keyword">if</span> ((node.Points.Count + <span class="number">1</span>) &lt;= node.BucketCapacity)</span><br><span class="line">            &#123;</span><br><span class="line">                node.Points.Add(data);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check to see if the current node is a leaf, if it is, split</span></span><br><span class="line">            <span class="keyword">if</span> (node.NorthWest == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Subdivide(node);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Traverse the tree</span></span><br><span class="line">            <span class="keyword">if</span> (Insert(node.NorthWest, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (Insert(node.NorthEast, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (Insert(node.SouthWest, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (Insert(node.SouthEast, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 搜尋在範圍內的所有節點</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span>四元樹節點<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;range&quot;&gt;</span>範圍<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datas&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SearchDataInRange</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            QuadTreeNode&lt;T&gt; node, </span></span></span><br><span class="line"><span class="function"><span class="params">            BoundingBox range, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">ref</span> List&lt;T&gt; datas</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> T : IQuadTreeNodeData</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//如果QuadTree完全在要搜尋的Range之內，</span></span><br><span class="line">            <span class="comment">//那包含在它底下的分裂節點都不用判斷,一定全部都在範圍內</span></span><br><span class="line">            <span class="keyword">if</span> (CheckBoundingBoxIncludeInRange(node.BoundingBox, range))</span><br><span class="line">            &#123;</span><br><span class="line">                GetNodeAllPointData(node, <span class="keyword">ref</span> datas);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If range is not contained in the node&#x27;s boundingBox then bail</span></span><br><span class="line">            <span class="keyword">if</span> (!CheckIntersectionBoundingBox(node.BoundingBox, range))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> node.Points)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Gather points contained in range</span></span><br><span class="line">                <span class="keyword">if</span> (CheckBoundingBoxContainData(range, item))</span><br><span class="line">                &#123;</span><br><span class="line">                    datas.Add(item);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Bail if node is leaf</span></span><br><span class="line">            <span class="keyword">if</span> (node.NorthWest == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Otherwise traverse down the tree</span></span><br><span class="line">            SearchDataInRange(node.NorthWest, range, <span class="keyword">ref</span> datas);</span><br><span class="line">            SearchDataInRange(node.NorthEast, range, <span class="keyword">ref</span> datas);</span><br><span class="line">            SearchDataInRange(node.SouthWest, range, <span class="keyword">ref</span> datas);</span><br><span class="line">            SearchDataInRange(node.SouthEast, range, <span class="keyword">ref</span> datas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 建立四元樹.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span>The data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;boundingBox&quot;&gt;</span>QuadTree Bounding<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">QuadTreeNode</span>&lt;<span class="title">T</span>&gt; <span class="title">CreateQuadTree</span>&lt;<span class="title">T</span>&gt;(<span class="params">List&lt;T&gt; data, BoundingBox boundingBox</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> T : IQuadTreeNodeData</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> TreeNode = <span class="keyword">new</span> QuadTreeNode&lt;T&gt;(</span><br><span class="line">                boundingBox: boundingBox,</span><br><span class="line">                capacity: <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> d <span class="keyword">in</span> data)</span><br><span class="line">            &#123;</span><br><span class="line">                Insert(TreeNode, d);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> TreeNode;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 取得節點以及所有子節點的Point Data</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span>The node.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datas&quot;&gt;</span>The datas.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GetNodeAllPointData</span>&lt;<span class="title">T</span>&gt;(<span class="params">QuadTreeNode&lt;T&gt; node, <span class="keyword">ref</span> List&lt;T&gt; datas</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> T : IQuadTreeNodeData</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            datas.AddRange(node.Points);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (node.NorthWest == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            GetNodeAllPointData(node.NorthWest, <span class="keyword">ref</span> datas);</span><br><span class="line">            GetNodeAllPointData(node.NorthEast, <span class="keyword">ref</span> datas);</span><br><span class="line">            GetNodeAllPointData(node.SouthWest, <span class="keyword">ref</span> datas);</span><br><span class="line">            GetNodeAllPointData(node.SouthEast, <span class="keyword">ref</span> datas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 確認兩個區域是否有交集</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;BoundingBox&quot;&gt;</span>The bounding box.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;range&quot;&gt;</span>The range.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CheckIntersectionBoundingBox</span>(<span class="params">BoundingBox BoundingBox, BoundingBox range</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (BoundingBox.LeftTop.Latitude.ToString() == BoundingBox.RightBottom.Latitude.ToString() &amp;&amp;</span><br><span class="line">                BoundingBox.LeftTop.Longitude.ToString() == BoundingBox.RightBottom.Longitude.ToString())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//Point</span></span><br><span class="line">                <span class="keyword">var</span> Lng =  range.LeftTop.Longitude &lt;= BoundingBox.LeftTop.Longitude &amp;&amp;</span><br><span class="line">                           BoundingBox.LeftTop.Longitude &lt;= range.RightBottom.Longitude;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> Lat =  range.RightBottom.Latitude &lt;= BoundingBox.LeftTop.Latitude &amp;&amp;</span><br><span class="line">                           BoundingBox.LeftTop.Latitude &lt;= range.LeftTop.Latitude;</span><br><span class="line">                <span class="keyword">return</span> Lng &amp;&amp; Lat;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> MinCx = Math.Max(range.LeftTop.Longitude, BoundingBox.LeftTop.Longitude);</span><br><span class="line">                <span class="keyword">var</span> MaxCy = Math.Min(range.LeftTop.Latitude, BoundingBox.LeftTop.Latitude);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> MaxCx = Math.Min(range.RightBottom.Longitude, BoundingBox.RightBottom.Longitude);</span><br><span class="line">                <span class="keyword">var</span> MinCy = Math.Max(range.RightBottom.Latitude, BoundingBox.RightBottom.Latitude);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> (MinCx &lt; MaxCx) &amp;&amp; (MinCy &lt; MaxCy);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 確認BoundingBox是否完全包含在要搜尋的區域範圍內(小於等於).</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;BoundingBox&quot;&gt;</span>The bounding box.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;range&quot;&gt;</span>The range.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CheckBoundingBoxIncludeInRange</span>(<span class="params">BoundingBox BoundingBox, BoundingBox range</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> LTLng = (range.LeftTop.Longitude &lt;= BoundingBox.LeftTop.Longitude &amp;&amp;</span><br><span class="line">                        BoundingBox.LeftTop.Longitude &lt;= range.RightBottom.Longitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> LTLat = (range.RightBottom.Latitude &lt;= BoundingBox.LeftTop.Latitude &amp;&amp;</span><br><span class="line">                        BoundingBox.LeftTop.Latitude &lt;= range.LeftTop.Latitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> RBLng = (range.LeftTop.Longitude &lt;= BoundingBox.RightBottom.Longitude &amp;&amp;</span><br><span class="line">                        BoundingBox.RightBottom.Longitude &lt;= range.RightBottom.Longitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> RBLat = (range.RightBottom.Latitude &lt;= BoundingBox.RightBottom.Latitude &amp;&amp;</span><br><span class="line">                        BoundingBox.RightBottom.Latitude &lt;= range.LeftTop.Latitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> LTLng &amp;&amp; LTLat &amp;&amp; RBLng &amp;&amp; RBLat;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CheckBoundingBoxContainData</span>(<span class="params">BoundingBox boundingBox, IQuadTreeNodeData data</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> CheckLng = (boundingBox.LeftTop.Longitude &lt;= data.Position.Longitude &amp;&amp;</span><br><span class="line">                            data.Position.Longitude &lt;= boundingBox.RightBottom.Longitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> CheckLat = (boundingBox.RightBottom.Latitude &lt;= data.Position.Latitude &amp;&amp;</span><br><span class="line">                            data.Position.Latitude &lt;= boundingBox.LeftTop.Latitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> CheckLng &amp;&amp; CheckLat;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 四元樹分裂</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span>四元樹節點<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Subdivide</span>&lt;<span class="title">T</span>&gt;(<span class="params">QuadTreeNode&lt;T&gt; node</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> T:IQuadTreeNodeData</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> box = node.BoundingBox;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//中心點</span></span><br><span class="line">            <span class="built_in">double</span> LatMid = (box.LeftTop.Latitude + box.RightBottom.Latitude) / <span class="number">2.0</span>;</span><br><span class="line">            <span class="built_in">double</span> LngMid = (box.LeftTop.Longitude + box.RightBottom.Longitude) / <span class="number">2.0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//左上</span></span><br><span class="line">            <span class="keyword">var</span> NorthWest = <span class="keyword">new</span> BoundingBox</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.LeftTop.Latitude,</span><br><span class="line">                    Longitude = box.LeftTop.Longitude</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.NorthWest = <span class="keyword">new</span> QuadTreeNode&lt;T&gt;(NorthWest, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//右上</span></span><br><span class="line">            <span class="keyword">var</span> NorthEast = <span class="keyword">new</span> BoundingBox</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.LeftTop.Latitude,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = box.RightBottom.Longitude</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.NorthEast = <span class="keyword">new</span> QuadTreeNode&lt;T&gt;(NorthEast, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//左下</span></span><br><span class="line">            <span class="keyword">var</span> SouthWest = <span class="keyword">new</span> BoundingBox</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = box.LeftTop.Longitude</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.RightBottom.Latitude,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.SouthWest = <span class="keyword">new</span> QuadTreeNode&lt;T&gt;(SouthWest, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//右下</span></span><br><span class="line">            <span class="keyword">var</span> SouthEast = <span class="keyword">new</span> BoundingBox</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.RightBottom.Latitude,</span><br><span class="line">                    Longitude = box.RightBottom.Longitude</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.SouthEast = <span class="keyword">new</span> QuadTreeNode&lt;T&gt;(SouthEast, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>————使用方法—————–</strong><br>**<br>**</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> Stopwatch timer = <span class="keyword">new</span> Stopwatch();</span><br><span class="line"> timer.Reset();</span><br><span class="line"> timer.Start();</span><br><span class="line"> <span class="keyword">var</span> YouWantToSearchData = <span class="keyword">new</span> List&lt;UserQuery.YourCoordinateData&gt;();</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000000</span>; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  YouWantToSearchData.Add(</span><br><span class="line">   <span class="keyword">new</span> YourCoordinateData</span><br><span class="line">   &#123;</span><br><span class="line">    Position = <span class="keyword">new</span> Coordinate </span><br><span class="line">    &#123;</span><br><span class="line">      Latitude = GetRandomNumber(<span class="number">22</span>,<span class="number">26</span>),</span><br><span class="line">      Longitude = GetRandomNumber(<span class="number">120</span>,<span class="number">122</span>)</span><br><span class="line">    &#125; </span><br><span class="line">   &#125;);</span><br><span class="line"> &#125; </span><br><span class="line"> <span class="keyword">var</span> QuadTree = QuadTreeService.CreateQuadTree(YouWantToSearchData,GetBoundingBox()); <span class="comment">//建立四元樹</span></span><br><span class="line"> <span class="built_in">string</span>.Format(<span class="string">&quot;建資料花了: &#123;0&#125; ticks (&#123;1&#125; msec)&quot;</span>, timer.ElapsedTicks, timer.ElapsedMilliseconds).Dump();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//要搜尋的範圍</span></span><br><span class="line"> BoundingBox range = <span class="keyword">new</span> BoundingBox</span><br><span class="line"> &#123;</span><br><span class="line">  LeftTop = <span class="keyword">new</span> Coordinate &#123; Latitude = <span class="number">24.997123</span>, Longitude = <span class="number">121.21940612793</span> &#125;,</span><br><span class="line">  RightBottom = <span class="keyword">new</span> Coordinate &#123;Latitude =<span class="number">24.958553314209</span>,Longitude = <span class="number">121.485925</span>&#125;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//一般搜尋</span></span><br><span class="line"> timer.Reset();</span><br><span class="line"> timer.Start();</span><br><span class="line"> <span class="keyword">var</span> Result1 = Search(range,YouWantToSearchData);</span><br><span class="line"> <span class="built_in">string</span>.Format(<span class="string">&quot;搜尋資料花了: &#123;0&#125; ticks (&#123;1&#125; msec)&quot;</span>, timer.ElapsedTicks, timer.ElapsedMilliseconds).Dump();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//四元樹搜尋</span></span><br><span class="line"> timer.Reset();</span><br><span class="line"> timer.Start();</span><br><span class="line"> <span class="keyword">var</span> Result2 = <span class="keyword">new</span> List&lt;YourCoordinateData&gt;();</span><br><span class="line"> QuadTreeService.SearchDataInRange(QuadTree,range,<span class="keyword">ref</span> Result2);</span><br><span class="line"> <span class="built_in">string</span>.Format(<span class="string">&quot;四元樹搜尋資料花了: &#123;0&#125; ticks (&#123;1&#125; msec)&quot;</span>, timer.ElapsedTicks, timer.ElapsedMilliseconds).Dump();</span><br><span class="line"></span><br><span class="line"> <span class="built_in">string</span>.Format(<span class="string">&quot;一般搜尋資料筆數: &#123;0&#125;&quot;</span>,Result1.Count()).Dump();</span><br><span class="line"> <span class="built_in">string</span>.Format(<span class="string">&quot;四元樹搜尋資料筆數: &#123;0&#125;&quot;</span>,Result2.Count()).Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;YourCoordinateData&gt; <span class="title">Search</span>(<span class="params">BoundingBox range,  List&lt;YourCoordinateData&gt; Datas</span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">return</span> Datas.Where(x =&gt; range.RightBottom.Latitude  &lt;= x.Position.Latitude  &amp;&amp; x.Position.Latitude &lt;= range.LeftTop.Latitude &amp;&amp;</span><br><span class="line">                            range.LeftTop.Longitude  &lt;= x.Position.Longitude  &amp;&amp; x.Position.Longitude &lt;= range.RightBottom.Longitude).ToList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">YourCoordinateData</span> : <span class="title">IQuadTreeNodeData</span> </span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> Coordinate Position&#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//台灣的範圍</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BoundingBox <span class="title">GetBoundingBox</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> BoundingBox</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="comment">//台灣範圍</span></span><br><span class="line">  LeftTop = <span class="keyword">new</span> Coordinate</span><br><span class="line">  &#123;</span><br><span class="line">   Latitude = <span class="number">26</span>,</span><br><span class="line">   Longitude = <span class="number">120</span></span><br><span class="line">  &#125;,</span><br><span class="line">  RightBottom = <span class="keyword">new</span> Coordinate</span><br><span class="line">  &#123;</span><br><span class="line">   Latitude = <span class="number">22</span>,</span><br><span class="line">   Longitude = <span class="number">122</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//隨機取得經緯度亂數</span></span><br><span class="line"><span class="keyword">static</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">double</span> <span class="title">GetRandomNumber</span>(<span class="params"><span class="built_in">double</span> minimum, <span class="built_in">double</span> maximum</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">return</span> random.NextDouble() * (maximum - minimum) + minimum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>分別實驗了10萬筆與500萬筆的搜尋數據，當然筆數擴張的越大，這個數據差距會越大</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-ZxXLvUMEaU8/V-jEmww86II/AAAAAAAAH98/12-o58aYKrcsVPIi6iPjGxEbt8ngHFFvwCLcB/s1600/1.png)](https://3.bp.blogspot.com/-ZxXLvUMEaU8/V-jEmww86II/AAAAAAAAH98/12-o58aYKrcsVPIi6iPjGxEbt8ngHFFvwCLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">10萬筆</td></tr></tbody></table>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-Kba3y7eAdFo/V-jFYZ5hXoI/AAAAAAAAH-I/_Mk3UU4NCII26OC6RqXubc5SdEkAMawogCLcB/s1600/2.png)](https://2.bp.blogspot.com/-Kba3y7eAdFo/V-jFYZ5hXoI/AAAAAAAAH-I/_Mk3UU4NCII26OC6RqXubc5SdEkAMawogCLcB/s1600/2.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">500萬筆</td></tr></tbody></table>]]></content>
      <tags>
        <tag>C#</tag>
        <tag>QuadTree</tag>
      </tags>
  </entry>
  <entry>
    <title>【重構系列】(一) 多型</title>
    <url>/2016/08/16/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%B8%80-%E5%A4%9A%E5%9E%8B/</url>
    <content><![CDATA[<p>以下實做的SourceCode已經放到GitHub :<br><a href="https://github.com/toyo0103/Demo_EditTemplate_1">https://github.com/toyo0103/Demo_EditTemplate_1</a></p>
<p>最近在幫專案成員導入開發分層以及物件導向的觀念，也想把這Demo的過程記錄下來。畢竟想法可能隨著專案的經歷而不斷的在修正，也可藉此不斷回頭檢視自己的基本功是否足夠</p>
<h4 id="一、首先來看一下專案分層的關聯圖"><a href="#一、首先來看一下專案分層的關聯圖" class="headerlink" title="        一、首先來看一下專案分層的關聯圖     "></a><span style="font-size: x-large;">        一、首先來看一下專案分層的關聯圖     </span></h4><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-2uYHHE-iq7c/V7JxJbl6gCI/AAAAAAAAH3w/I-gYOBfJq8U_fLoVSQTuySsCtNMSb9J6ACLcB/s1600/1.png)](https://2.bp.blogspot.com/-2uYHHE-iq7c/V7JxJbl6gCI/AAAAAAAAH3w/I-gYOBfJq8U_fLoVSQTuySsCtNMSb9J6ACLcB/s1600/1.png)</div>

<p>Application : 應用層，參考了邏輯層</p>
<p>Service : &nbsp;邏輯層，參考了資料存取層</p>
<p>Repository : 資料存取層</p>
<p>Lib : 共用層 ，被Application、Service、Repository參考</p>
<h3 id="二、目前各層尚未重構的程式"><a href="#二、目前各層尚未重構的程式" class="headerlink" title="        二、目前各層尚未重構的程式     "></a><span style="font-size: x-large;">        二、目前各層尚未重構的程式     </span></h3><div>

<h3 id="Repository層"><a href="#Repository層" class="headerlink" title="Repository層"></a><strong><span style="color: #444444; font-size: large;"><u>Repository層</u></span></strong></h3></div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-tg5bIS8XXLo/V7Kv7donQqI/AAAAAAAAH4A/LMM962SvdT8znywny9YxnzQbnxKS0H-oQCLcB/s1600/1.png)](https://2.bp.blogspot.com/-tg5bIS8XXLo/V7Kv7donQqI/AAAAAAAAH4A/LMM962SvdT8znywny9YxnzQbnxKS0H-oQCLcB/s1600/1.png)</div>

<p>模擬A廠商提供的POI(地圖座標點)資料</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> POI A供應商</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ASupplierRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">            <span class="comment">//隨機建立十筆Supplier為A的資料回傳</span></span><br><span class="line">            <span class="keyword">var</span> fixture = <span class="keyword">new</span> Fixture();</span><br><span class="line">            <span class="keyword">var</span> Result = fixture.Build&lt;POI&gt;()</span><br><span class="line">                            .With(x =&gt; x.Name, <span class="built_in">string</span>.Concat(<span class="string">&quot;捷運&quot;</span>, rnd.Next(<span class="number">1</span>, <span class="number">100</span>)))</span><br><span class="line">                            .With(x =&gt; x.Supplier, SupplierEnum.A)</span><br><span class="line">                            .CreateMany().ToList();</span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><span style="color: #444444; font-size: large;"><u><br></u></span>****<span style="color: #444444; font-size: large;"><u>Service層</u></span></strong></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-Bcv7-vwubuU/V7KxJwqZf9I/AAAAAAAAH4I/9vgY1F6fzbI28ZdK-OCZZmF9bzaM9_FJQCLcB/s1600/1.png)](https://4.bp.blogspot.com/-Bcv7-vwubuU/V7KxJwqZf9I/AAAAAAAAH4I/9vgY1F6fzbI28ZdK-OCZZmF9bzaM9_FJQCLcB/s1600/1.png)</div>**<span style="color: #666666;">
</span>****<span style="color: #666666;">
</span>**傳入頻道代碼，依據頻道底下的類別，去各供應商取得POI資料，目前模擬頻道資料如下
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-e-CVa7nJHGo/V7KxhdAVBQI/AAAAAAAAH4M/4xbGZY9o5JE9Dg6fnyvtWQOmm0wMKcDXgCLcB/s320/1.png)](https://4.bp.blogspot.com/-e-CVa7nJHGo/V7KxhdAVBQI/AAAAAAAAH4M/4xbGZY9o5JE9Dg6fnyvtWQOmm0wMKcDXgCLcB/s1600/1.png)</div>

<p><strong>頻道1</strong>底下有一個<strong>交通</strong>的類別，該類別的POI資料來源為<span style="color: red;">A廠商</span>提供<br><strong>頻道2</strong>底下有一個<strong>交通</strong>的類別，該類別的POI資料來源為<span style="color: red;">A廠商</span>與<span style="color: red;">B廠商</span>提供的總和</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">POIService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;POI&gt;();</span><br><span class="line">            <span class="keyword">var</span> channel = GetChannel(channelID);</span><br><span class="line">            <span class="comment">//逐一搜尋頻道底下的各類別</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> category <span class="keyword">in</span> channel.Categorys)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//依據該類別所指定的供應商向Repository要資料</span></span><br><span class="line">                category.Supplier.ForEach(x =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (x)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">case</span> SupplierEnum.A:</span><br><span class="line">                            <span class="keyword">var</span> ASupplier = <span class="keyword">new</span> ASupplierRepository();</span><br><span class="line">                            <span class="keyword">var</span> APOIs = ASupplier.Get();</span><br><span class="line">                            Result.AddRange(APOIs);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> SupplierEnum.B:</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//並接總合的結果回傳</span></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 模擬頻道類別對應表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;channelID&quot;&gt;</span>The channel identifier.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Channel.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">Channel <span class="title">GetChannel</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (channelID == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">                &#123;</span><br><span class="line">                    ID = <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                    Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">new</span> Channel.Category</span><br><span class="line">                        &#123;</span><br><span class="line">                            Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                            Supplier =<span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">            &#123;</span><br><span class="line">                ID = channelID,</span><br><span class="line">                Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">new</span> Channel.Category</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                        Supplier = <span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A , SupplierEnum.B &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="Application層"><a href="#Application層" class="headerlink" title="Application層"></a><strong><span style="color: #444444; font-size: large;"><u>Application層</u></span></strong></h3><div>將傳入的ID透過Service去取得POI資料，並解用Json回傳     **<span style="color: #990000;">
</span>**</div>```csharp
public ActionResult Index(string id)
        {
            var Service = new POIService();
            var POIs = Service.Get(id);
            return Json(POIs,JsonRequestBehavior.AllowGet);
        }

<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">目前執行結果</span><br><span class="line">&lt;div class&#x3D;&quot;separator&quot; style&#x3D;&quot;clear: both; text-align: center;&quot;&gt;[![](https:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-COJi7ExMLgY&#x2F;V7KzgT1tBuI&#x2F;AAAAAAAAH4c&#x2F;59FwAwpv1U4UniOKgZUJGJMy-jM4AxskgCLcB&#x2F;s320&#x2F;1.png)](https:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-COJi7ExMLgY&#x2F;V7KzgT1tBuI&#x2F;AAAAAAAAH4c&#x2F;59FwAwpv1U4UniOKgZUJGJMy-jM4AxskgCLcB&#x2F;s1600&#x2F;1.png)&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">###     &lt;span style&#x3D;&quot;font-size: x-large;&quot;&gt;三、加入B廠商Repository&lt;&#x2F;span&gt;</span><br><span class="line">&lt;div&gt;&lt;span style&#x3D;&quot;font-size: x-large;&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line"></span><br><span class="line">###         &lt;span style&#x3D;&quot;font-size: x-large;&quot;&gt;            **&lt;span style&#x3D;&quot;color: #444444; font-size: large;&quot;&gt;&lt;u&gt;Repository層加入BSupplierRepositoy&lt;&#x2F;u&gt;&lt;&#x2F;span&gt;**        &lt;&#x2F;span&gt;    </span><br><span class="line">&lt;span style&#x3D;&quot;font-size: x-large;&quot;&gt;    &lt;&#x2F;span&gt;&lt;&#x2F;div&gt;&lt;div class&#x3D;&quot;separator&quot; style&#x3D;&quot;clear: both; text-align: center;&quot;&gt;[![](https:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-qhpGz7u6oVg&#x2F;V7K0fW7yuaI&#x2F;AAAAAAAAH4k&#x2F;nGTc-zqfiE4MS4uEtO_gG_mdHZbJkkNsACLcB&#x2F;s1600&#x2F;1.png)](https:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-qhpGz7u6oVg&#x2F;V7K0fW7yuaI&#x2F;AAAAAAAAH4k&#x2F;nGTc-zqfiE4MS4uEtO_gG_mdHZbJkkNsACLcB&#x2F;s1600&#x2F;1.png)&lt;&#x2F;div&gt;&lt;div&gt;**&lt;span style&#x3D;&quot;color: #990000;&quot;&gt;</span><br><span class="line">&lt;&#x2F;span&gt;**    **&lt;span style&#x3D;&quot;color: #990000;&quot;&gt;</span><br><span class="line">&lt;&#x2F;span&gt;**&lt;&#x2F;div&gt;&#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; POI B供應商</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public class BSupplierRepository</span><br><span class="line">    &#123;</span><br><span class="line">        public List&lt;POI&gt; Get()</span><br><span class="line">        &#123;</span><br><span class="line">            Random rnd &#x3D; new Random();</span><br><span class="line">            &#x2F;&#x2F;隨機建立十筆Supplier為B的資料回傳</span><br><span class="line">            var fixture &#x3D; new Fixture();</span><br><span class="line">            var Result &#x3D; fixture.Build&lt;POI&gt;()</span><br><span class="line">                            .With(x &#x3D;&gt; x.Name, string.Concat(&quot;捷運&quot;, rnd.Next(1, 100)))</span><br><span class="line">                            .With(x &#x3D;&gt; x.Supplier, SupplierEnum.B)</span><br><span class="line">                            .CreateMany().ToList();</span><br><span class="line">            return Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id=""><a href="#" class="headerlink" title=""></a><span style="color: #444444; font-size: large;"></span></h3><h3 id="Service層"><a href="#Service層" class="headerlink" title="Service層"></a><span style="font-size: x-large;"><strong><span style="color: #444444; font-size: large;"><u>Service層</u></span></strong></span></h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//逐一搜尋頻道底下的各類別</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> category <span class="keyword">in</span> channel.Categorys)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//依據該類別所指定的供應商向Repository要資料</span></span><br><span class="line">                category.Supplier.ForEach(x =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (x)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">case</span> SupplierEnum.A:</span><br><span class="line">                            <span class="keyword">var</span> ASupplier = <span class="keyword">new</span> ASupplierRepository();</span><br><span class="line">                            <span class="keyword">var</span> APOIs = ASupplier.Get();</span><br><span class="line">                            Result.AddRange(APOIs);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> SupplierEnum.B: <span class="comment">//補上B廠商</span></span><br><span class="line">                            <span class="keyword">var</span> BSupplier = <span class="keyword">new</span> BSupplierRepository();</span><br><span class="line">                            <span class="keyword">var</span> BPOIs = BSupplier.Get();</span><br><span class="line">                            Result.AddRange(BPOIs);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="執行結果"><a href="#執行結果" class="headerlink" title="執行結果"></a><span style="font-size: x-large;"><strong><span style="color: #444444; font-size: large;"><u>執行結果</u></span></strong></span></h3><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-oLBfowU5dPE/V7K3te4Ug8I/AAAAAAAAH4w/HWxKp39vbfwkUb4zpQkvoB_umOlCnBk2gCLcB/s1600/1.png)](https://3.bp.blogspot.com/-oLBfowU5dPE/V7K3te4Ug8I/AAAAAAAAH4w/HWxKp39vbfwkUb4zpQkvoB_umOlCnBk2gCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">
</div><div><span style="font-size: x-large;">
</span>    

</div><span style="font-size: x-large;">四、重構開始</span>
<span style="font-size: medium;"><span style="font-size: medium;">
</span></span><span style="font-size: medium;">    <span style="font-size: medium;">        首先需要思考一個問題，雖然這樣已經可以達成需求，但很明顯的是如果今天提供POI的廠商一直增加的話，我們要一直替**Repository層**新增廠商之外，**Service層**也會一直在Switch那邊做修改。&nbsp;</span></span>
<span style="font-size: medium;">
</span><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-At8pfSKZU1A/V7O464uATbI/AAAAAAAAH6Y/_ZteovVvDKgiWIP4C7VOW0d_ID0T3Yn0gCLcB/s640/1.png)](https://3.bp.blogspot.com/-At8pfSKZU1A/V7O464uATbI/AAAAAAAAH6Y/_ZteovVvDKgiWIP4C7VOW0d_ID0T3Yn0gCLcB/s1600/1.png)</div><span style="font-size: medium;">
</span><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-_mL7zcPN80s/V7O5MABxbiI/AAAAAAAAH6c/iwdP7xw3pVkJlb08t52ggMFcpuNRywTZQCLcB/s640/1.png)](https://4.bp.blogspot.com/-_mL7zcPN80s/V7O5MABxbiI/AAAAAAAAH6c/iwdP7xw3pVkJlb08t52ggMFcpuNRywTZQCLcB/s1600/1.png)</div>
 <span style="font-size: medium;"><span style="font-size: medium;"></span></span><span style="font-size: medium;">那該怎麼改可以避免每次改Repository又要一直改Service層呢?</span>

<span style="font-size: medium;">
</span><span style="font-size: medium;">這時就會運用到OO原則中的**依賴抽象**概念，當我們面對的是實體(例如:**ASupplierRepository** , **BSupplierRepository**)時也就是所謂的高耦合，如果面對的實體有所變動時，所有耦合的地方都會有高機率要一起改動的風險。</span>
<span style="font-size: medium;">
</span><span style="font-size: medium;">因為要面對抽象，第一步我們就要來觀察這兩個實體共通處是什麼?     其實說穿了都是提供一個叫做Get()的方法，當呼叫他時，回傳對應的POI List，這就是它們共通的地方，接下來透過抽取介面的方式來實行隔離&nbsp;</span>
<span style="font-size: medium;">**<span style="color: #bf9000;">
</span>**</span><span style="font-size: medium;">**<span style="color: #bf9000;">
</span>**</span><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-8ZNSvrUREs8/V7O5d9RkdPI/AAAAAAAAH6g/l9zIPDnhW2MYl-bCWyutTDSp9UeRtpDigCLcB/s640/1.png)](https://1.bp.blogspot.com/-8ZNSvrUREs8/V7O5d9RkdPI/AAAAAAAAH6g/l9zIPDnhW2MYl-bCWyutTDSp9UeRtpDigCLcB/s1600/1.png)</div>
 <span style="font-size: medium;">**<span style="color: #bf9000;">
</span>**</span><span style="font-size: medium;"></span><span style="font-size: medium;">**<span style="color: #bf9000;">ISupplierRepository</span>**</span>

<p><span style="font-size: medium;"><a href="https://2.bp.blogspot.com/--6JFyTbCJPw/V7K6stloRhI/AAAAAAAAH48/_u2UnWJmUL8lQhC91Ts5ieBO4iAfdYsCgCLcB/s1600/1.png"><img src="https://2.bp.blogspot.com/--6JFyTbCJPw/V7K6stloRhI/AAAAAAAAH48/_u2UnWJmUL8lQhC91Ts5ieBO4iAfdYsCgCLcB/s1600/1.png"></a></span> </p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface ISupplierRepository</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISupplierRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 取得POI資料</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>List&amp;lt;POI&amp;gt;.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">List&lt;POI&gt; <span class="title">Get</span>(<span class="params"></span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>將<strong>ASupplierRepository</strong><span style="font-size: medium;">&nbsp;, <strong>B</strong></span><strong>SupplierRepository</strong><span style="font-size: medium;">都套上介面</span><br><span style="font-size: medium;"><br></span></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-Jcpo5G8HHb0/V7K7uHZpu4I/AAAAAAAAH5I/uBTimpbb1_YxzjwVDH3ApMka-KNPy-fBwCLcB/s640/1.png)](https://3.bp.blogspot.com/-Jcpo5G8HHb0/V7K7uHZpu4I/AAAAAAAAH5I/uBTimpbb1_YxzjwVDH3ApMka-KNPy-fBwCLcB/s1600/1.png)</div><span style="font-size: medium;">
</span><span style="font-size: medium;">
</span>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-e3WLuMtpxh4/V7K7kaOISdI/AAAAAAAAH5E/ZLhqJrVmBcMxApVZcO82qEAbAGXsNTcaACLcB/s640/1.png)](https://2.bp.blogspot.com/-e3WLuMtpxh4/V7K7kaOISdI/AAAAAAAAH5E/ZLhqJrVmBcMxApVZcO82qEAbAGXsNTcaACLcB/s1600/1.png)</div><span style="font-size: medium;">
</span><span style="font-size: medium;">
</span><span style="font-size: medium;">將兩個類別都實作了</span><span style="color: #bf9000;"><span style="color: #bf9000;">ISupplierRepository</span><span style="font-size: medium;">介面後，來修改**Service層**，讓它能面對抽象而非直接面對實體</span></span>
<span style="color: #bf9000;"><span style="font-size: medium;">
</span></span><span style="color: #bf9000;"></span>

<h3 id="Service層-1"><a href="#Service層-1" class="headerlink" title="Service層"></a><span style="font-size: x-large;"><strong><span style="color: #444444; font-size: large;"><u>Service層</u></span></strong></span></h3><div><span style="color: #444444;">首先先運用簡單工廠模式，請它來幫我們建造SupplierRepository的實體</span></div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-sUw1JL2z37U/V7K9OulK-EI/AAAAAAAAH5Y/VeGijYdLK7ElsbQb0Cie22U4PnGOex-BwCLcB/s1600/1.png)](https://2.bp.blogspot.com/-sUw1JL2z37U/V7K9OulK-EI/AAAAAAAAH5Y/VeGijYdLK7ElsbQb0Cie22U4PnGOex-BwCLcB/s1600/1.png)</div><div><span style="color: #444444;"><u>
</u></span></div>```csharp
public class SupplierFactory
    {
        public static ISupplierRepository Generate(SupplierEnum supplierType)
        {
            //因為A跟B的SupplierRepository都有實做ISupplierRepository
            //所以這邊可以直接回傳介面，也間接地規範以後新增SupplierRepository都要實作ISupplierRepository介面
            switch (supplierType)
            {
                case SupplierEnum.A:
                    return new ASupplierRepository();
                case SupplierEnum.B:
                    return new BSupplierRepository();
            }
            return null;
        }
    }

<p>```</p>
<p>修改原本的POIService，讓它透過工廠來取得Repository，而不是直接去New實體</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-yqxvmh12FqM/V7K97eMgJOI/AAAAAAAAH5c/jeYldicOfYYSTvZJeGJRKOkPtJ7OETKXwCLcB/s640/1.png)](https://1.bp.blogspot.com/-yqxvmh12FqM/V7K97eMgJOI/AAAAAAAAH5c/jeYldicOfYYSTvZJeGJRKOkPtJ7OETKXwCLcB/s1600/1.png)</div>

<p>瞬間乾淨很多，而且<strong>POIService</strong>不再直接對<strong>ASupplierRepository</strong><span style="font-size: small;">&nbsp;,&nbsp;<strong>B</strong></span><strong>SupplierRepository</strong><span style="font-size: medium;">，而是面對</span><span style="color: #bf9000;">ISupplierRepository</span>，達成了所謂的面對抽象。</p>
<p>這時候思考一下，以後新增供應商的Repository時POIService都不用改動了，只要Repository層新增好後，將Factory改一下即可，但是否又跳出另一個問題了。<strong>這樣Repository層更動時還不是要打開Service層去做修改。 因此在這我會將Factory搬Repository層去封裝起來</strong></p>
<h3 id="將SupplierFactory搬到Repository層，並將實體Repository改成Internal封裝起來"><a href="#將SupplierFactory搬到Repository層，並將實體Repository改成Internal封裝起來" class="headerlink" title="將SupplierFactory搬到Repository層，並將實體Repository改成Internal封裝起來"></a><span style="font-family: &quot;times new roman&quot;; font-size: x-large;"><strong><span style="color: #444444; font-size: large;"><u>將</u></span></strong></span><span style="color: #444444; font-family: &quot;times new roman&quot;; font-size: large;"><u>SupplierFactory搬到Repository</u></span><strong><span style="color: #444444; font-size: large;"><u>層，並將實體Repository改成Internal封裝起來</u></span></strong></h3><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-WrLZP8-uAWU/V7LAj2T_ieI/AAAAAAAAH5s/uZ2PH9JQGX4X1aOwYavGDKaCHKfXC95MQCLcB/s1600/1.png)](https://2.bp.blogspot.com/-WrLZP8-uAWU/V7LAj2T_ieI/AAAAAAAAH5s/uZ2PH9JQGX4X1aOwYavGDKaCHKfXC95MQCLcB/s1600/1.png)</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-6shnp4lJN7Q/V7LA6VF0OmI/AAAAAAAAH5w/7eVfEwIFG38IGqtWYLxr-QDBdIAHtw1_wCLcB/s400/1.png)](https://2.bp.blogspot.com/-6shnp4lJN7Q/V7LA6VF0OmI/AAAAAAAAH5w/7eVfEwIFG38IGqtWYLxr-QDBdIAHtw1_wCLcB/s1600/1.png)</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-OMNNg00W0qE/V7LBG6V83fI/AAAAAAAAH50/1stqCDyKtRMLmxt-QBvl3vXZ9khxZOFpACLcB/s400/1.png)](https://2.bp.blogspot.com/-OMNNg00W0qE/V7LBG6V83fI/AAAAAAAAH50/1stqCDyKtRMLmxt-QBvl3vXZ9khxZOFpACLcB/s1600/1.png)</div>
<div>換句話說，因為改成Internal的關係，現在Service層也碰不到**ASupplierRepository**<span style="font-size: small;">&nbsp;,&nbsp;**B**</span>**SupplierRepository**<span style="font-size: medium;">這兩個實體了，完全只能依賴Factory來取得介面的對應實體，未來不管怎麼新增Repository都不會再改**Service層**，到這邊就是重構並且實踐多型了</span></div><div><span style="font-size: medium;">
</span>    <span style="font-size: medium;">
</span>    <span style="font-size: medium;">目前UML結構圖如下</span>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-fUMrd2aOxZs/V7LGMRcCTpI/AAAAAAAAH6I/lgwJmCO6LYse8DXoFEJKw3NqwtL7Z7f7QCLcB/s1600/1.png)](https://1.bp.blogspot.com/-fUMrd2aOxZs/V7LGMRcCTpI/AAAAAAAAH6I/lgwJmCO6LYse8DXoFEJKw3NqwtL7Z7f7QCLcB/s1600/1.png)    </div><span style="font-size: medium;">
</span></div>]]></content>
      <tags>
        <tag>C#</tag>
        <tag>Refactor</tag>
      </tags>
  </entry>
  <entry>
    <title>快速搜尋可視範圍的座標點。 透過四元樹演算法</title>
    <url>/2016/08/04/%E5%BF%AB%E9%80%9F%E6%90%9C%E5%B0%8B%E5%8F%AF%E8%A6%96%E7%AF%84%E5%9C%8D%E7%9A%84%E5%BA%A7%E6%A8%99%E9%BB%9E%E3%80%82-%E9%80%8F%E9%81%8E%E5%9B%9B%E5%85%83%E6%A8%B9%E6%BC%94%E7%AE%97%E6%B3%95/</url>
    <content><![CDATA[<p>接到一個任務，要把全國的公車資料座標訊息爬回來，並且做整理歸納。研究了一下<a href="http://ptx.transportdata.tw/PTX/Service">交通部的公共運輸整合資訊平台</a>的內容，資訊相當完整，API也寫得很彈性。</p>
<p>唯獨公車站牌的部分，是以公車路線為出發點思考，每條路線雖然會經過同一個站牌，站牌的ID都會視為不同，不同ID的站牌，經緯度可能相同。</p>
<p>例如 :<br>富陽街口的公車站牌資料</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-rsJGRd8q0Yk/V6LuwauETRI/AAAAAAAAH2I/MXCywQPawicA3nbmx9j-D6608XWt5RxXQCLcB/s640/13765731_1287175481295263_7952967575366659415_o.jpg)](https://1.bp.blogspot.com/-rsJGRd8q0Yk/V6LuwauETRI/AAAAAAAAH2I/MXCywQPawicA3nbmx9j-D6608XWt5RxXQCLcB/s1600/13765731_1287175481295263_7952967575366659415_o.jpg)</div>
富陽街口去程回程的公車，透過GoogleMap算大概有8支站牌，但透過API去撈會發現有17支ID皆為不同的資料。

<p><strong>任務目標 :</strong><br>將所有站牌資料爬回來，相同的站名距離20公尺內的站牌要能自動聚合在一起，成為一支站牌。</p>
<p>原本思考是全部爬回來後用站名做整合，但發現一個問題是宜蘭與桃園都有相同站名的站牌”吊橋頭”，而距離相差十萬八千里，所以站名不可行。會加上20公尺的條件是因為像是台北火車站他的腹地很大，公車站牌可能很多相距很遠， 或是有些捷運站出口在兩條路口的轉角都有公車站牌，且站名相同，如果單純把這些點整合在一起放回地圖上，會發現公車站牌少了許多，失真。</p>
<p>歸納以上的條件，我們會有一大批公車站牌的資料(<u>118728筆資料</u>)，如果把每個站牌用同名稱的逐筆下去比對各自的距離，顯然掃到天荒地老也跑不完，顯然浪費效能且不切實際。</p>
<p>看了一篇文章後得到非常大的啟發，該方法是透過四元樹演算法將大批座標快速塞選出範圍內的點，並且做出聚合。<br>參考 &nbsp;: &nbsp;<a href="https://robots.thoughtbot.com/how-to-handle-large-amounts-of-data-on-maps">How To Efficiently Display Large Amounts of Data on iOS Maps</a><br>四元樹演算法 : <a href="https://zh.wikipedia.org/wiki/%E5%9B%9B%E5%8F%89%E6%A0%91">Wiki</a></p>
<p>節錄Wiki對四元樹的解說:「<span style="background-color: white; color: #252525; font-family: sans-serif; font-size: 14px; line-height: 22.4px;"><strong>假如四元樹區塊被用來表達一組點資料(諸如一組城市的經緯度)，區塊就進行次分割直到每個葉節點包含最多一個單點。</strong></span>」</p>
<p>用圖片來表示就像這樣</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://4.bp.blogspot.com/-waUqxqrmcf8/V6L7oy8YO-I/AAAAAAAAH2Y/kMcCy8J_kGw45_XPYsvcsqONAuQa767qgCLcB/s320/quadTreeInsert.gif)](https://4.bp.blogspot.com/-waUqxqrmcf8/V6L7oy8YO-I/AAAAAAAAH2Y/kMcCy8J_kGw45_XPYsvcsqONAuQa767qgCLcB/s1600/quadTreeInsert.gif)</td></tr><tr><td class="tr-caption" style="text-align: center;">**<span style="background-color: white; font-family: &quot;helvetica neue&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 14px; line-height: 16px;">Source &nbsp;: &nbsp;</span><span style="font-family: &quot;helvetica neue&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif;"><span style="font-size: 14px; line-height: 16px;">https://robots.thoughtbot.com/how-to-handle-large-amounts-of-data-on-maps</span></span>**

</td></tr></tbody></table>四元樹包含幾個概念
1.每個節點最多只能包含一個座標
2.當節點的座標滿了，會分裂出四個象限

<p>根據以上概念寫出以下Class</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 四元樹節點</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">QuadTreeNode</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//四個象限</span></span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode NorthWest &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode NorthEast &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode SouthWest &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode SouthEast &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 邊界</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> BoundingBoxDTO BoundingBox &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 節點數量</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> BucketCapacity &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 座標資料</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> List&lt;Data&gt; Points &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">QuadTreeNode</span>(<span class="params">BoundingBoxDTO boundingBox , <span class="built_in">int</span> capacity</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            BoundingBox = boundingBox;</span><br><span class="line">            BucketCapacity = capacity;</span><br><span class="line">            Points = <span class="keyword">new</span> List&lt;BusStopAPIResult&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>那座標插入四元樹節點時如何運作?</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Insert</span>(<span class="params">QuadTreeNode node, Data point</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// 確定這個座標符合四元樹的框框範圍</span></span><br><span class="line">            <span class="keyword">if</span> (!CheckBoundingBoxContainData(node.BoundingBox, point))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 如果這個座標符合框框範圍，檢查這個節點是否已經超過座標存放上限</span></span><br><span class="line">            <span class="comment">// 如果沒有，那就座標放入回傳True</span></span><br><span class="line">            <span class="keyword">if</span> ((node.Points.Count +<span class="number">1</span>) &lt;= node.BucketCapacity)</span><br><span class="line">            &#123;</span><br><span class="line">                node.Points.Add(data);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 會走到這一步，表示這個座標在這個四元樹的框框範圍內</span></span><br><span class="line">            <span class="comment">// 但是能存放的座標已經滿了，判斷這個四元樹節點是否有四個象限</span></span><br><span class="line">            <span class="comment">// 如果沒有，進行分裂</span></span><br><span class="line">            <span class="keyword">if</span> (node.NorthWest == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Subdivide(node);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 將座標丟到新分裂出來的四個四元樹象限，符合座標坐落的位置，存放好回傳True</span></span><br><span class="line">            <span class="keyword">if</span> (Insert(node.NorthWest, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (Insert(node.NorthEast, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (Insert(node.SouthWest, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (Insert(node.SouthEast, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>四元樹分裂的程式碼</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 四元樹分裂</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span>四元樹節點<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">Subdivide</span>(<span class="params">QuadTreeNode node</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> box = node.BoundingBox;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//找出要分裂的四元樹中心點</span></span><br><span class="line">            <span class="built_in">double</span> LatMid = (box.LeftTop.Latitude + box.RightBottom.Latitude) / <span class="number">2.0</span>;</span><br><span class="line">            <span class="built_in">double</span> LngMid = (box.LeftTop.Longitude + box.RightBottom.Longitude) / <span class="number">2.0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//算出西北象限的左上右下座標點</span></span><br><span class="line">            <span class="keyword">var</span> NorthWest = <span class="keyword">new</span> BoundingBoxDTO</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> CoordinateDTO</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.LeftTop.Latitude,</span><br><span class="line">                    Longitude = box.LeftTop.Longitude</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> CoordinateDTO</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.NorthWest = <span class="keyword">new</span> QuadTreeNode(NorthWest, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//算出東北象限的左上右下座標點</span></span><br><span class="line">            <span class="keyword">var</span> NorthEast = <span class="keyword">new</span> BoundingBoxDTO</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> CoordinateDTO</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.LeftTop.Latitude,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> CoordinateDTO</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = box.RightBottom.Longitude</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.NorthEast = <span class="keyword">new</span> QuadTreeNode(NorthEast, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//算出西南象限的左上右下座標點</span></span><br><span class="line">            <span class="keyword">var</span> SouthWest = <span class="keyword">new</span> BoundingBoxDTO</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> CoordinateDTO</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = box.LeftTop.Longitude</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> CoordinateDTO</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.RightBottom.Latitude,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.SouthWest = <span class="keyword">new</span> QuadTreeNode(SouthWest, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//算出東南象限的左上右下座標點</span></span><br><span class="line">            <span class="keyword">var</span> SouthEast = <span class="keyword">new</span> BoundingBoxDTO</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> CoordinateDTO</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> CoordinateDTO</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.RightBottom.Latitude,</span><br><span class="line">                    Longitude = box.RightBottom.Longitude</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.SouthEast = <span class="keyword">new</span> QuadTreeNode(SouthEast, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>看到這邊可能會有個疑問，那就是雖然知道四元樹就像是遞迴的概念，將地圖分裂成很多塊，每個大區塊可能又被分裂成若干的小區塊，一層一層的往下長</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://1.bp.blogspot.com/-m_rkkVB1hxw/V6MCmq-X0gI/AAAAAAAAH2o/FHOE9VcWAvkLDp8BWJvjYnWvP9-NlbGfgCLcB/s320/500px-Point_quadtree.svg.png)](https://1.bp.blogspot.com/-m_rkkVB1hxw/V6MCmq-X0gI/AAAAAAAAH2o/FHOE9VcWAvkLDp8BWJvjYnWvP9-NlbGfgCLcB/s1600/500px-Point_quadtree.svg.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">**<span style="background-color: white; font-family: &quot;helvetica neue&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 14px; line-height: 16px;">Source &nbsp;: &nbsp;</span><span style="font-family: &quot;helvetica neue&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 12.8px;"><span style="font-size: 14px; line-height: 16px;">https://zh.wikipedia.org/wiki/%E5%9B%9B%E5%8F%89%E6%A0%91</span></span>**</td></tr></tbody></table>
但為何會讓搜尋速度加快呢? 原因是他從上層開始看是否有重疊到要搜尋的區塊，如果有就往該節點的四象限遞迴繼續往下找重疊，如果在大區塊的節點就已經沒有包含重疊區域，那他無限往下延伸的子節點也就不會被搜尋了。引用原作者的圖片就一目了然

<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-FXlbFONjFzI/V6MEINzRBHI/AAAAAAAAH20/gXhavItzQ_o3GgeyMPRgBGAxhJ9U6MuVwCLcB/s400/quadTreeQuery.gif)](https://3.bp.blogspot.com/-FXlbFONjFzI/V6MEINzRBHI/AAAAAAAAH20/gXhavItzQ_o3GgeyMPRgBGAxhJ9U6MuVwCLcB/s1600/quadTreeQuery.gif)</td></tr><tr><td class="tr-caption" style="text-align: center;">**<span style="background-color: white; font-family: &quot;helvetica neue&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 14px; line-height: 16px;">Source &nbsp;: &nbsp;</span><span style="font-family: &quot;helvetica neue&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 12.8px;"><span style="font-size: 14px; line-height: 16px;">https://robots.thoughtbot.com/how-to-handle-large-amounts-of-data-on-maps</span></span>**</td></tr></tbody></table>

<p>搜尋程式碼如下<br>如何透過座標判斷地理位置有無交集，請參考上一篇文章:&nbsp;【<a href="http://toyo0103.blogspot.tw/2016/08/blog-post.html">地理位置】透過座標框出地理位置，與判斷地理位置是否重疊</a></p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SearchDataInRange</span>(<span class="params">QuadTreeNode node, BoundingBoxDTO range, <span class="keyword">ref</span> List&lt;Data&gt; datas</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// 確認要搜尋的區塊是否與四元樹節點所涵蓋的區塊有重疊到，如果沒有就直接跳掉</span></span><br><span class="line">            <span class="keyword">if</span> (!CheckIntersectionBoundingBox(node.BoundingBox, range))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果有，將這個區塊的節點拿出來比對是否在要搜尋的範圍中</span></span><br><span class="line">            <span class="comment">//因為雖然範圍有重疊到，但不代表裡面的所有節點都落在重疊的範圍</span></span><br><span class="line">            <span class="comment">//如果落在重疊的範圍，儲存起來，之後回傳</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> node.Points)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Gather points contained in range</span></span><br><span class="line">                <span class="keyword">if</span> (CheckBoundingBoxContainData(range, item))</span><br><span class="line">                &#123;</span><br><span class="line">                    datas.Add(item);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//確認這個節點是否有分裂過</span></span><br><span class="line">            <span class="keyword">if</span> (node.NorthWest == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//如果有分裂成四個象限，繼續遞迴往下找</span></span><br><span class="line">            SearchDataInRange(node.NorthWest, range, <span class="keyword">ref</span> datas);</span><br><span class="line">            SearchDataInRange(node.NorthEast, range, <span class="keyword">ref</span> datas);</span><br><span class="line">            SearchDataInRange(node.SouthWest, range, <span class="keyword">ref</span> datas);</span><br><span class="line">            SearchDataInRange(node.SouthEast, range, <span class="keyword">ref</span> datas);</span><br><span class="line">        &#125; </span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>說了這麼多，我們如何將上述的四元樹理論運用在我們的目標上呢?</p>
<p>首先我們把一堆的公車站牌資料抓回來後，依據名稱先進行第一次分類，把每個名稱相同的依據上面的方式做成四元樹節點，但這邊有個前面提到的問題，如果是同個站名但其實是不同的站點呢? </p>
<p>這邊我用的方法是將同名稱的公車站牌，找出兩個離最遠的站牌算距離，如果超過1公里合理懷疑這是兩個不同的站點，只是碰巧相同名稱。台灣應該沒有差了一公里遠但是是同一個站的吧……(有的話請跟我說XD)。</p>
<p>將這群同站名但其實不同地方的站牌，依據一公里為單位分組，這樣就能有效地將這類同名的站牌做更細部的歸類。</p>
<p>計算兩點座標距離的程式</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">double</span> EARTH_RADIUS = <span class="number">6378.137</span>; <span class="comment">//地球半?</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 計算距離(返回公尺)</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;lat1&quot;&gt;</span>點1經<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;lng1&quot;&gt;</span>點1緯<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;lat2&quot;&gt;</span>點2經<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;lng2&quot;&gt;</span>點2緯<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">double</span> <span class="title">GetDistance</span>(<span class="params"><span class="built_in">double</span> lat1, <span class="built_in">double</span> lng1, <span class="built_in">double</span> lat2, <span class="built_in">double</span> lng2</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="built_in">double</span> radLat1 = rad(lat1);</span><br><span class="line">            <span class="built_in">double</span> radLat2 = rad(lat2);</span><br><span class="line">            <span class="built_in">double</span> a = radLat1 - radLat2;</span><br><span class="line">            <span class="built_in">double</span> b = rad(lng1) - rad(lng2);</span><br><span class="line">            <span class="built_in">double</span> s = <span class="number">2</span> * Math.Asin(Math.Sqrt(Math.Pow(Math.Sin(a / <span class="number">2</span>), <span class="number">2</span>) +</span><br><span class="line">             Math.Cos(radLat1) * Math.Cos(radLat2) * Math.Pow(Math.Sin(b / <span class="number">2</span>), <span class="number">2</span>)));</span><br><span class="line">            s = s * EARTH_RADIUS;</span><br><span class="line">            s = Math.Round(s * <span class="number">10000</span>) / <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">double</span> <span class="title">rad</span>(<span class="params"><span class="built_in">double</span> d</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> d * Math.PI / <span class="number">180.0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>上面的問題皆排除並分類後，依據同名的站牌，算出這群站牌座標的中心點，並用離中心最遠的座標距離做為範圍，依照每小格20公尺的矩形進行四元樹搜尋，在同一格內的整合成一個站牌，記錄下來</p>
<p>概念圖</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-C9CqLPtlx7Q/V6MKsEK1vTI/AAAAAAAAH3E/KDH_KTeXYQQnoFWCQdLL7mvIihxNMh7KgCLcB/s640/1.png)](https://2.bp.blogspot.com/-C9CqLPtlx7Q/V6MKsEK1vTI/AAAAAAAAH3E/KDH_KTeXYQQnoFWCQdLL7mvIihxNMh7KgCLcB/s1600/1.png)</div>
1.這些點只是亂標的，但假設真的有個同名站牌坐落在這些位置，找到中心點後，藍色線為中心點與最遠座標的直線距離，依據這個距離做為矩形二分之一寬。

<p>2.有了距離後就能求出左上跟右下角的點，透過<span style="background-color: white; color: #6aa84f; font-family: &quot;roboto slab&quot; , sans-serif; font-size: 15px; line-height: 25.5px;">DbGeography</span><span style="background-color: white; font-family: &quot;roboto slab&quot; , sans-serif; font-size: 15px; line-height: 25.5px;">這個來取得地理面積的物件</span><br><span style="background-color: white; font-family: &quot;roboto slab&quot; , sans-serif; font-size: 15px; line-height: 25.5px;"><br></span><span style="background-color: white; font-family: &quot;roboto slab&quot; , sans-serif; font-size: 15px; line-height: 25.5px;">3.從左上開始，橘色的每小格為長寬各20公尺的矩形，透過四元樹下去搜尋，被同一格橘色小框框到的座標收納成同一個點，記錄下來</span><br><span style="background-color: white; font-family: &quot;roboto slab&quot; , sans-serif; font-size: 15px; line-height: 25.5px;"><br></span></p>
<p>經過實測，如果只是雙北市的公車站點，只要4分鐘就能全部歸類掃描完畢，全國的話大概4個小時能算完，以上是這次任務的小筆記</p>
<p>測試環境 :<br>CPU &nbsp;: &nbsp;I7 &nbsp;4核 (實際在跑的時候控制大概在3核左右)<br>RAM : 16G</p>
]]></content>
      <tags>
        <tag>C#</tag>
      </tags>
  </entry>
  <entry>
    <title>用 FluentValidation 驗證參數</title>
    <url>/2016/10/12/%E7%94%A8-FluentValidation-%E9%A9%97%E8%AD%89%E5%8F%83%E6%95%B8/</url>
    <content><![CDATA[<p>FluentValidation是個很不錯的套件，且擴充性也高，解決了一些以前常常要寫很多遍的驗證邏輯。 <a href="https://2.bp.blogspot.com/-7V1LvfPGBlQ/V_3PMBxBPFI/AAAAAAAAH-Y/24jx-pArEUk_I3Gp2_SJwVOzy7CQ8asYgCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png"><img src="https://2.bp.blogspot.com/-7V1LvfPGBlQ/V_3PMBxBPFI/AAAAAAAAH-Y/24jx-pArEUk_I3Gp2_SJwVOzy7CQ8asYgCLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png"></a></p>
<p>以前常常驗證參數時都會有很多的If..Else，搞得程式碼很長很醜之外，閱讀性不佳。自從公司同事推薦了這個套件後，用了兩三個專案發現程式碼變得簡潔易懂之外，寫了一些擴充方法也可以重複使用，不像以前常常重複造輪子</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">var</span> Parameter = <span class="keyword">new</span> APIInputParameter </span><br><span class="line"> &#123;</span><br><span class="line">  ID = <span class="string">&quot;123&quot;</span>,</span><br><span class="line">  Name = <span class="string">&quot;Toyo&quot;</span></span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> Guid _ID;</span><br><span class="line"> <span class="comment">//驗證邏輯</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(Parameter.ID) ||</span><br><span class="line">           !Guid.TryParse(Parameter.ID,<span class="keyword">out</span> _ID) ||</span><br><span class="line">     <span class="built_in">string</span>.IsNullOrWhiteSpace(Parameter.Name) )</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="string">&quot;參數錯誤&quot;</span>.Dump();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> &#123;</span><br><span class="line">  <span class="string">&quot;參數正確&quot;</span>.Dump();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">APIInputParameter</span> </span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">//此參數應該為Guid，但為了能Log下來所以接的時候要先接成String</span></span><br><span class="line"> <span class="comment">//否則輸入端不是傳入GUID就記錄不到了</span></span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> Name &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>上面的範例是以前的寫法，常常欄位多，各個欄位又有不同的要求時，總是把驗證的邏輯寫得又臭又長。</p>
<p>加上公司要求所有輸入輸出的欄位都要被Log下來，所以基本上參數都要是String型別，否則如果ID寫成GUID，因為傳入的時候不是GUID會接不到，自然無法被Log到，但也因此衍生了驗證的複雜度提高的問題。</p>
<p>想想如果各個參數錯誤要回傳的訊息會不同時，又該寫的多複雜才做得到呢……</p>
<p>那讓來看看如何透FluentValidation 驗證參數，</p>
<ol>
<li> 首先先把驗證邏輯寫成一個Class<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">APIInputParameterValidator</span> : <span class="title">AbstractValidator</span>&lt;<span class="title">APIInputParameter</span>&gt;&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">APIInputParameterValidator</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span> &#123;</span><br><span class="line">  <span class="comment">//ID - 必填，應為GUID</span></span><br><span class="line">  <span class="keyword">this</span>.RuleFor(x =&gt; x.ID)</span><br><span class="line">     .NotEmpty()</span><br><span class="line">     .WithErrorCode(<span class="string">&quot;X400&quot;</span>)</span><br><span class="line">     .WithMessage(<span class="string">&quot;ID不得為空字串&quot;</span>)</span><br><span class="line">     .NotNull()</span><br><span class="line">     .WithErrorCode(<span class="string">&quot;X400&quot;</span>)</span><br><span class="line">     .WithMessage(<span class="string">&quot;ID不得為Null&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.RuleFor(x =&gt; x.Name)</span><br><span class="line">   .NotEmpty()</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;X401&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;Name不得為空字串&quot;</span>)</span><br><span class="line">   .NotNull()</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;X401&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;Name不得為Null&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<ol start="2">
<li>自己寫一個HasError的Extension```csharp<br>/// <summary><br>/// FluentValidation 自訂驗證擴充方法.<br>/// </summary><br>public static class FluentValidationExtensions<br>{<br>/// <summary><br>/// 驗證結果是否有 Error.<br>/// </summary><br>/// <param name="validationFailure"></param><br>/// <returns></returns><br>public static bool HasError(this ValidationFailure validationFailure)<br>{<br>return validationFailure != null &amp;&amp;<br> !string.IsNullOrWhiteSpace(validationFailure.ErrorMessage);<br>}<br>}</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">3.  驗證的地方改成如下 &#96;&#96;&#96;csharp</span><br><span class="line">var Parameter &#x3D; new APIInputParameter &#123;</span><br><span class="line">  ID &#x3D; &quot;123&quot;,</span><br><span class="line">  Name &#x3D; &quot;Toyo&quot;</span><br><span class="line"> &#125;;</span><br><span class="line"> &#x2F;&#x2F; 檢查輸入參數</span><br><span class="line"> var validator &#x3D; new APIInputParameterValidator();</span><br><span class="line"></span><br><span class="line">     var error &#x3D; validator.Validate(Parameter).Errors.FirstOrDefault();</span><br><span class="line"> if (error.HasError())</span><br><span class="line"> &#123;</span><br><span class="line">   string.Format(&quot;&#123;0&#125;-&#123;1&#125;&quot;,error.ErrorCode,error.ErrorMessage).Dump();</span><br><span class="line"> &#125;</span><br><span class="line"> else</span><br><span class="line"> &#123;</span><br><span class="line">   &quot;驗證成功&quot;.Dump();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣只要有參數帶入錯誤，他就會依照你要求的帶回ErrorCode跟ErrorMessage，那可能各位會發現，阿驗證是否為GUID的地方怎麼不見了?? 因為套件並沒有提供，所以這邊要自己擴充</p>
<ol>
<li><p>先寫一個驗證String是否為Guid的方法 ```csharp<br>/// <summary><br> /// 驗證是否為GUID<br> /// </summary><br> /// <seealso cref="FluentValidation.Validators.PropertyValidator" /><br> public class GUIDValidator : PropertyValidator<br> {</p>
<pre><code> /// &lt;summary&gt;
 /// 是否允許字串參數為空白.
 /// &lt;/summary&gt;
 /// &lt;value&gt;&lt;c&gt;true&lt;/c&gt; if [allow empty]; otherwise, &lt;c&gt;false&lt;/c&gt;.&lt;/value&gt;
 private bool AllowEmpty &#123; get; set; &#125;

     /// &lt;summary&gt;
 /// Initializes a new instance of the &lt;see cref=&quot;GUIDValidator&quot;/&gt; class.
 /// &lt;/summary&gt;
 /// &lt;param name=&quot;allowEmpty&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [allow empty].&lt;/param&gt;
 public GUIDValidator(
     bool allowEmpty = false) : base(&quot;傳入參數錯誤。&quot;)
 &#123;
     this.AllowEmpty = allowEmpty;
 &#125;

     /// &lt;summary&gt;
 /// Returns true if ... is valid.
 /// &lt;/summary&gt;
 /// &lt;param name=&quot;context&quot;&gt;The context.&lt;/param&gt;
 /// &lt;returns&gt;
 ///   &lt;c&gt;true&lt;/c&gt; if the specified context is valid; otherwise, &lt;c&gt;false&lt;/c&gt;.
 /// &lt;/returns&gt;
 protected override bool IsValid(PropertyValidatorContext context)
 &#123;
     var propertyValue = context.PropertyValue as string;

         if (AllowEmpty &amp;&amp;
         string.IsNullOrWhiteSpace(propertyValue))
     &#123;
         return true;
     &#125;

         Guid guid;
     return Guid.TryParse(propertyValue, out guid);
 &#125;
</code></pre>
<p> }</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">2.  接著在Extension的地方補上兩個擴充方法，分別是【應該是GUID】、【應該是GUID但允許其為空字串或Null】 &#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; FluentValidation 自訂驗證擴充方法.</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public static class FluentValidationExtensions</span><br><span class="line">&#123;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; 驗證結果是否有 Error.</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;validationFailure&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line"> public static bool HasError(this ValidationFailure validationFailure)</span><br><span class="line"> &#123;</span><br><span class="line">  return validationFailure !&#x3D; null &amp;&amp;</span><br><span class="line">    !string.IsNullOrWhiteSpace(validationFailure.ErrorMessage);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">     &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; 應該是 GUID 型別.</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;typeparam name&#x3D;&quot;T&quot;&gt;&lt;&#x2F;typeparam&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;typeparam name&#x3D;&quot;TProperty&quot;&gt;The type of the t property.&lt;&#x2F;typeparam&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;ruleBuilder&quot;&gt;The rule builder.&lt;&#x2F;param&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;returns&gt;IRuleBuilderOptions&lt;T, TProperty&gt;.&lt;&#x2F;returns&gt;</span><br><span class="line"> public static IRuleBuilderOptions&lt;T, TProperty&gt; IsGUID&lt;T, TProperty&gt;(</span><br><span class="line">  this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)</span><br><span class="line"> &#123;</span><br><span class="line">  return ruleBuilder.SetValidator(new GUIDValidator(allowEmpty: false));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">     &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; 應該是 GUID 型別, 但允許 String.Empty.</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;typeparam name&#x3D;&quot;T&quot;&gt;&lt;&#x2F;typeparam&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;typeparam name&#x3D;&quot;TProperty&quot;&gt;The type of the t property.&lt;&#x2F;typeparam&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;ruleBuilder&quot;&gt;The rule builder.&lt;&#x2F;param&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;returns&gt;IRuleBuilderOptions&lt;T, TProperty&gt;.&lt;&#x2F;returns&gt;</span><br><span class="line"> public static IRuleBuilderOptions&lt;T, TProperty&gt; IsGUIDAllowEmpty&lt;T, TProperty&gt;(</span><br><span class="line">  this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)</span><br><span class="line"> &#123;</span><br><span class="line">  return ruleBuilder.SetValidator(new GUIDValidator(allowEmpty: true));</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li> 接著在原本驗證的地方補上<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment">//ID - 必填，應為GUID</span></span><br><span class="line"><span class="keyword">this</span>.RuleFor(x =&gt; x.ID)</span><br><span class="line">  .NotEmpty()</span><br><span class="line">  .WithErrorCode(<span class="string">&quot;X400&quot;</span>)</span><br><span class="line">  .WithMessage(<span class="string">&quot;ID不得為空字串&quot;</span>)</span><br><span class="line">  .NotNull()</span><br><span class="line">  .WithErrorCode(<span class="string">&quot;X400&quot;</span>)</span><br><span class="line">  .WithMessage(<span class="string">&quot;ID不得為Null&quot;</span>)</span><br><span class="line">  .IsGUID()</span><br><span class="line">  .WithErrorCode(<span class="string">&quot;X400&quot;</span>)</span><br><span class="line">  .WithMessage(<span class="string">&quot;ID應為GUID&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<p>再執行原本的驗證就會得到錯誤訊息 <strong>X400-ID應為GUID</strong><br>對我來說不止讓程式可讀性增加之外，也讓驗證的地方被分離出來，做到所謂的關注點分離</p>
<p>以下補上幾個我常常用到的驗證擴充出來的方法供各位參考，再強調一次，因為公司要求輸入輸出都要被Log下來，所以所有參數都是從String出發去驗證</p>
<ul>
<li><p><strong><span style="color: #0c343d;">驗證是否為DateTime or TimeStamp</span></strong></p>
  <figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 驗證是否為DateTime</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;seealso cref=&quot;FluentValidation.Validators.PropertyValidator&quot; /&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DateTimeValidator</span> : <span class="title">PropertyValidator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否允許參數為空白.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span><span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> if [allow empty]; otherwise, <span class="doctag">&lt;c&gt;</span>false<span class="doctag">&lt;/c&gt;</span>.<span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> AllowEmpty &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Initializes a new instance of the <span class="doctag">&lt;see cref=&quot;DateTimeValidator&quot;/&gt;</span> class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;allowEmpty&quot;&gt;</span>if set to <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> [allow empty].<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DateTimeValidator</span>(<span class="params"><span class="built_in">bool</span> allowEmpty</span>) : <span class="title">base</span>(<span class="params"><span class="string">&quot;型別錯誤&quot;</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.AllowEmpty = allowEmpty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Returns true if ... is valid.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span>The context.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> if the specified context is valid; otherwise, <span class="doctag">&lt;c&gt;</span>false<span class="doctag">&lt;/c&gt;</span>.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsValid</span>(<span class="params">PropertyValidatorContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> propertyValue = context.PropertyValue <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.AllowEmpty &amp;&amp;</span><br><span class="line">                <span class="built_in">string</span>.IsNullOrWhiteSpace(propertyValue))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">int</span> <span class="keyword">value</span>;</span><br><span class="line">            <span class="built_in">bool</span> result = <span class="built_in">int</span>.TryParse(propertyValue, <span class="keyword">out</span> <span class="keyword">value</span>);</span><br><span class="line">            <span class="comment">//TimeStamp</span></span><br><span class="line">            <span class="keyword">if</span> (result &amp;&amp; <span class="keyword">value</span> &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                DateTime dateTimeValue;</span><br><span class="line">            <span class="keyword">return</span> DateTime.TryParse(propertyValue, <span class="keyword">out</span> dateTimeValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>擴充方法</strong>```csharp<br>/// <summary><br>        /// 是 DateTime 型別 or TimeStamp .<br>        /// </summary><br>        /// <typeparam name="T"></typeparam><br>        /// <typeparam name="TProperty">The type of the t property.</typeparam><br>        /// <param name="ruleBuilder">The rule builder.</param><br>        /// <returns>IRuleBuilderOptions&lt;T, TProperty&gt;.</returns><br>        public static IRuleBuilderOptions&lt;T, TProperty&gt; IsDateTimeOrTimeStamp&lt;T, TProperty&gt;(<br>            this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)<br>        {<br>            return ruleBuilder.SetValidator(new DateTimeValidator(allowEmpty: false));<br>        }</p>
<pre><code>        /// &lt;summary&gt;
    /// 是 DateTime 型別 or TimeStamp, 但允許 String.Empty.
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the t property.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;returns&gt;IRuleBuilderOptions&amp;lt;T, TProperty&amp;gt;.&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsDateTimeOrTimeStampAllowEmpty&lt;T, TProperty&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)
    &#123;
        return ruleBuilder.SetValidator(new DateTimeValidator(allowEmpty: true));
    &#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">*   **&lt;span style&#x3D;&quot;color: #073763;&quot;&gt;驗證是否為GUID Array &lt;&#x2F;span&gt;**</span><br><span class="line"></span><br><span class="line">    &#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 驗證是否為GUID Array</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public class GUIDArrayValidator : PropertyValidator</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 是否允許字串參數為空白.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;value&gt;&lt;c&gt;true&lt;&#x2F;c&gt; if [allow empty]; otherwise, &lt;c&gt;false&lt;&#x2F;c&gt;.&lt;&#x2F;value&gt;</span><br><span class="line">        private bool AllowEmpty &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Initializes a new instance of the &lt;see cref&#x3D;&quot;GUIDArrayValidator&quot;&#x2F;&gt; class.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;allowEmpty&quot;&gt;if set to &lt;c&gt;true&lt;&#x2F;c&gt; [allow empty].&lt;&#x2F;param&gt;</span><br><span class="line">        public GUIDArrayValidator(</span><br><span class="line">            bool allowEmpty &#x3D; false) :base(&quot;傳入參數錯誤。&quot;)</span><br><span class="line">        &#123;</span><br><span class="line">            this.AllowEmpty &#x3D; allowEmpty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Returns true if ... is valid.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;context&quot;&gt;The context.&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;returns&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F;   &lt;c&gt;true&lt;&#x2F;c&gt; if the specified context is valid; otherwise, &lt;c&gt;false&lt;&#x2F;c&gt;.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;returns&gt;</span><br><span class="line">        protected override bool IsValid(PropertyValidatorContext context)</span><br><span class="line">        &#123;</span><br><span class="line">            var propertyValue &#x3D; context.PropertyValue as List&lt;string&gt;;</span><br><span class="line">            if (AllowEmpty &amp;&amp;</span><br><span class="line">                (propertyValue &#x3D;&#x3D; null || propertyValue.Count &#x3D;&#x3D; 0))</span><br><span class="line">            &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                if (!AllowEmpty &amp;&amp;</span><br><span class="line">                (propertyValue &#x3D;&#x3D; null || propertyValue.Count &#x3D;&#x3D; 0))</span><br><span class="line">            &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                Guid guid;</span><br><span class="line">            foreach (var item in propertyValue)</span><br><span class="line">            &#123;</span><br><span class="line">                if (!Guid.TryParse(item, out guid))</span><br><span class="line">                &#123;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>擴充方法</strong>```csharp<br>/// <summary><br>        /// 是 Guid Array, 但允許空集合.<br>        /// </summary><br>        /// <typeparam name="T"></typeparam><br>        /// <typeparam name="TProperty">The type of the t property.</typeparam><br>        /// <param name="ruleBuilder">The rule builder.</param><br>        /// <returns>IRuleBuilderOptions&lt;T, TProperty&gt;.</returns><br>        public static IRuleBuilderOptions&lt;T, TProperty&gt; IsGUIDArrayAllowEmpty&lt;T, TProperty&gt;(<br>            this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)<br>        {<br>            return ruleBuilder.SetValidator(new GUIDArrayValidator(allowEmpty: true));<br>        }</p>
<pre><code>        /// &lt;summary&gt;
    /// 是 Guid Array.
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the t property.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;returns&gt;IRuleBuilderOptions&amp;lt;T, TProperty&amp;gt;.&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsGUIDArray&lt;T, TProperty&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)
    &#123;
        return ruleBuilder.SetValidator(new GUIDArrayValidator(allowEmpty: false));
    &#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">*   **&lt;span style&#x3D;&quot;color: #073763;&quot;&gt;驗證是否為數字 &lt;&#x2F;span&gt;**</span><br><span class="line"></span><br><span class="line">    &#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 驗證是否為Integer</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;seealso cref&#x3D;&quot;FluentValidation.Validators.PropertyValidator&quot; &#x2F;&gt;</span><br><span class="line">    public class IntegerValidator : PropertyValidator</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 是否允許字串參數為空白.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;value&gt;&lt;c&gt;true&lt;&#x2F;c&gt; if [allow empty]; otherwise, &lt;c&gt;false&lt;&#x2F;c&gt;.&lt;&#x2F;value&gt;</span><br><span class="line">        private bool AllowEmpty &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Initializes a new instance of the &lt;see cref&#x3D;&quot;IntegerValidator&quot;&#x2F;&gt; class.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;allowEmpty&quot;&gt;if set to &lt;c&gt;true&lt;&#x2F;c&gt; [allow empty].&lt;&#x2F;param&gt;</span><br><span class="line">        public IntegerValidator(bool allowEmpty &#x3D; false)</span><br><span class="line">            : base(&quot;型別錯誤&quot;)</span><br><span class="line">        &#123;</span><br><span class="line">            this.AllowEmpty &#x3D; allowEmpty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Returns true if ... is valid.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;context&quot;&gt;The context.&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;returns&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F;   &lt;c&gt;true&lt;&#x2F;c&gt; if the specified context is valid; otherwise, &lt;c&gt;false&lt;&#x2F;c&gt;.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;returns&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;exception cref&#x3D;&quot;NotImplementedException&quot;&gt;&lt;&#x2F;exception&gt;</span><br><span class="line">        protected override bool IsValid(PropertyValidatorContext context)</span><br><span class="line">        &#123;</span><br><span class="line">            var propertyValue &#x3D; context.PropertyValue as string;</span><br><span class="line"></span><br><span class="line">                if (this.AllowEmpty &amp;&amp;</span><br><span class="line">                string.IsNullOrWhiteSpace(propertyValue))</span><br><span class="line">            &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                int value;</span><br><span class="line">            bool result &#x3D; int.TryParse(propertyValue, out value);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>擴充方法</strong>```csharp<br>/// <summary><br>        /// 是 Integer 型別.<br>        /// </summary><br>        /// <typeparam name="T"></typeparam><br>        /// <typeparam name="TProperty">The type of the t property.</typeparam><br>        /// <param name="ruleBuilder">The rule builder.</param><br>        /// <returns>IRuleBuilderOptions&lt;T, TProperty&gt;.</returns><br>        public static IRuleBuilderOptions&lt;T, TProperty&gt; IsInteger&lt;T, TProperty&gt;(<br>            this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)<br>        {<br>            return ruleBuilder.SetValidator(new IntegerValidator(allowEmpty: false));<br>        }</p>
<pre><code>        /// &lt;summary&gt;
    /// 是 Integer 型別, 但允許 String.Empty.
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the t property.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;returns&gt;IRuleBuilderOptions&amp;lt;T, TProperty&amp;gt;.&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsIntegerAllowEmpty&lt;T, TProperty&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)
    &#123;
        return ruleBuilder.SetValidator(new IntegerValidator(allowEmpty: true));
    &#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">*   **&lt;span style&#x3D;&quot;color: #073763;&quot;&gt;檢查數字是否在要求範圍內 &lt;&#x2F;span&gt;**</span><br><span class="line"></span><br><span class="line">    &#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 驗證數字是否在範圍內</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;typeparam name&#x3D;&quot;TNumeric&quot;&gt;The type of the numeric.&lt;&#x2F;typeparam&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;seealso cref&#x3D;&quot;FluentValidation.Validators.PropertyValidator&quot; &#x2F;&gt;</span><br><span class="line">    public class NumericBetweenInValidator&lt;TNumeric&gt; : PropertyValidator</span><br><span class="line">        where TNumeric : IComparable</span><br><span class="line">    &#123;</span><br><span class="line">        private TNumeric compareValueUp;</span><br><span class="line"></span><br><span class="line">            private TNumeric compareValueDown;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 是否允許字串參數為空白.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;value&gt;&lt;c&gt;true&lt;&#x2F;c&gt; if [allow empty]; otherwise, &lt;c&gt;false&lt;&#x2F;c&gt;.&lt;&#x2F;value&gt;</span><br><span class="line">        private bool AllowEmpty &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 轉型是否成功</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        private bool IsConvertable;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 是否允許等於輸入的上下閥值值</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        private bool AllowEquals;</span><br><span class="line"></span><br><span class="line">            public NumericBetweenInValidator(</span><br><span class="line">            string valueUp,</span><br><span class="line">            string valueDown,</span><br><span class="line">            bool allowEquals &#x3D; false,</span><br><span class="line">            bool allowEmpty &#x3D; false) : base(&quot;傳入參數錯誤。&quot;)</span><br><span class="line">        &#123;</span><br><span class="line">            this.compareValueUp &#x3D; ConvertHelper.ToT&lt;TNumeric&gt;(valueUp, out IsConvertable);</span><br><span class="line"></span><br><span class="line">                this.compareValueDown &#x3D; ConvertHelper.ToT&lt;TNumeric&gt;(valueDown, out IsConvertable);</span><br><span class="line"></span><br><span class="line">                this.AllowEquals &#x3D; allowEquals;</span><br><span class="line">            this.AllowEmpty &#x3D; allowEmpty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            protected override bool IsValid(PropertyValidatorContext context)</span><br><span class="line">        &#123;</span><br><span class="line">            var propertyValue &#x3D; context.PropertyValue as string;</span><br><span class="line"></span><br><span class="line">                if (this.AllowEmpty &amp;&amp;</span><br><span class="line">                string.IsNullOrWhiteSpace(propertyValue))</span><br><span class="line">            &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var value &#x3D; ConvertHelper.ToT&lt;TNumeric&gt;(propertyValue, out IsConvertable);</span><br><span class="line"></span><br><span class="line">                if (!IsConvertable)</span><br><span class="line">            &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; -1 value &lt; compareValue</span><br><span class="line">            &#x2F;&#x2F; 0  value &#x3D; compareValue</span><br><span class="line">            &#x2F;&#x2F; 1  value &gt; compareValue</span><br><span class="line">            if (AllowEquals)</span><br><span class="line">            &#123;</span><br><span class="line">                return value.CompareTo(compareValueDown) &gt;&#x3D; 0</span><br><span class="line">                       &amp;&amp; value.CompareTo(compareValueUp) &lt;&#x3D; 0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                return value.CompareTo(compareValueDown) &gt; 0</span><br><span class="line">                   &amp;&amp; value.CompareTo(compareValueUp) &lt; 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Class ConvertHelper</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ConvertHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 轉型成 T.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>The value.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;System.ArgumentException&quot;&gt;</span>Convert fail.;Convert<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">ToT</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> <span class="keyword">value</span>, <span class="keyword">out</span> <span class="built_in">bool</span> result</span>) <span class="keyword">where</span> T : IComparable</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            result = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (Type.GetTypeCode(<span class="keyword">typeof</span>(T)))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> TypeCode.Double:</span><br><span class="line"></span><br><span class="line">                            <span class="built_in">double</span> doubleValue;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">double</span>.TryParse(<span class="keyword">value</span>, <span class="keyword">out</span> doubleValue))</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> (T)(<span class="built_in">object</span>)Convert.ToDouble(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> TypeCode.Int16:</span><br><span class="line"></span><br><span class="line">                            Int16 int16Value;</span><br><span class="line">                        <span class="keyword">if</span> (Int16.TryParse(<span class="keyword">value</span>, <span class="keyword">out</span> int16Value))</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> (T)(<span class="built_in">object</span>)Convert.ToInt16(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> TypeCode.Int32:</span><br><span class="line"></span><br><span class="line">                            Int32 int32Value;</span><br><span class="line">                        <span class="keyword">if</span> (Int32.TryParse(<span class="keyword">value</span>, <span class="keyword">out</span> int32Value))</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> (T)(<span class="built_in">object</span>)Convert.ToInt32(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> TypeCode.Int64:</span><br><span class="line"></span><br><span class="line">                            Int64 int64Value;</span><br><span class="line">                        <span class="keyword">if</span> (Int64.TryParse(<span class="keyword">value</span>, <span class="keyword">out</span> int64Value))</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> (T)(<span class="built_in">object</span>)Convert.ToInt64(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> TypeCode.Decimal:</span><br><span class="line"></span><br><span class="line">                            <span class="built_in">decimal</span> decimalValue;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">decimal</span>.TryParse(<span class="keyword">value</span>, <span class="keyword">out</span> decimalValue))</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> (T)(<span class="built_in">object</span>)Convert.ToDecimal(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="literal">default</span>:</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">default</span>(T);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">default</span>(T);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>擴充方法</strong>```csharp<br>/// <summary><br>        /// 符合數字區間,但允許空值.<br>        /// <para>EX : (1 &lt; x &lt; 3) </para><br>        /// </summary><br>        /// <typeparam name="T"></typeparam><br>        /// <typeparam name="TProperty">The type of the property.</typeparam><br>        /// <typeparam name="TNumeric">The type of the numeric.</typeparam><br>        /// <param name="ruleBuilder">The rule builder.</param><br>        /// <param name="upThreshold">Up threshold.</param><br>        /// <param name="downThreshold">Down threshold.</param><br>        /// <returns></returns><br>        public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericAllowEmptyOrBetweenOf&lt;T, TProperty, TNumeric&gt;(<br>            this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder,<br>            string upThreshold,<br>            string downThreshold)<br>            where TNumeric : IComparable<br>        {<br>            return ruleBuilder.SetValidator(<br>                new NumericBetweenInValidator<TNumeric>(<br>                    upThreshold,<br>                    downThreshold,<br>                    allowEquals: false,<br>                    allowEmpty: true));<br>        }</p>
<pre><code>        /// &lt;summary&gt;
    /// 符合數字區間且允許等於閥值,但允許空值.
    /// &lt;para&gt;EX : (1 &amp;lt;= x &amp;lt;= 3) &lt;/para&gt;
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the property.&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TNumeric&quot;&gt;The type of the numeric.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;param name=&quot;upThreshold&quot;&gt;Up threshold.&lt;/param&gt;
    /// &lt;param name=&quot;downThreshold&quot;&gt;Down threshold.&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericAllowEmptyOrBetweenOfAllowEquals&lt;T, TProperty, TNumeric&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder,
        string upThreshold,
        string downThreshold)
        where TNumeric : IComparable
    &#123;
        return ruleBuilder.SetValidator(
            new NumericBetweenInValidator&lt;TNumeric&gt;(
                upThreshold,
                downThreshold,
                allowEquals: true,
                allowEmpty: true));
    &#125;

        /// &lt;summary&gt;
    /// 符合數字區間.
    /// &lt;para&gt;EX : (1 &amp;lt; x &amp;lt; 3) &lt;/para&gt;
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the property.&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TNumeric&quot;&gt;The type of the numeric.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;param name=&quot;upThreshold&quot;&gt;Up threshold.&lt;/param&gt;
    /// &lt;param name=&quot;downThreshold&quot;&gt;Down threshold.&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericBetweenOf&lt;T, TProperty, TNumeric&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder,
        string upThreshold,
        string downThreshold)
        where TNumeric : IComparable
    &#123;
        return ruleBuilder.SetValidator(
            new NumericBetweenInValidator&lt;TNumeric&gt;(
                upThreshold,
                downThreshold,
                allowEquals: false,
                allowEmpty: false));
    &#125;

        /// &lt;summary&gt;
    /// 符合數字區間且允許等於閥值
    /// &lt;para&gt;EX : (1 &amp;lt;= x &amp;lt;= 3) &lt;/para&gt;
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the property.&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TNumeric&quot;&gt;The type of the numeric.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;param name=&quot;upThreshold&quot;&gt;Up threshold.&lt;/param&gt;
    /// &lt;param name=&quot;downThreshold&quot;&gt;Down threshold.&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericBetweenOfAllowEquals&lt;T, TProperty, TNumeric&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder,
        string upThreshold,
        string downThreshold)
        where TNumeric : IComparable
    &#123;
        return ruleBuilder.SetValidator(
            new NumericBetweenInValidator&lt;TNumeric&gt;(
                upThreshold,
                downThreshold,
                allowEquals: true,
                allowEmpty: false));
    &#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">使用方法 &#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;OrderBy - 允許空值或(0、1)</span><br><span class="line">this.RuleFor(x &#x3D;&gt; x.OrderBy)</span><br><span class="line">  .NotNumericAllowEmptyOrBetweenOfAllowEquals&lt;GetBuildingDealCaseParameter, string, int&gt;(</span><br><span class="line">  &quot;2&quot;,</span><br><span class="line">  &quot;1&quot;)</span><br><span class="line">  .WithErrorCode(&quot;X400&quot;)</span><br><span class="line">  .WithMessage(&quot;OrderBy應該在1~2之間&quot;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li><p><strong><span style="color: #073763;">驗證是否為數字Array </span></strong></p>
  <figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 驗證是否為數字 Array</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;seealso cref=&quot;FluentValidation.Validators.PropertyValidator&quot; /&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NumericArrayValidator</span>&lt;<span class="title">TNumeric</span>&gt; : <span class="title">PropertyValidator</span></span><br><span class="line">        <span class="keyword">where</span> <span class="title">TNumeric</span> : <span class="title">IComparable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否允許Array為Null或空集合.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> if [allow empty]; otherwise, <span class="doctag">&lt;c&gt;</span>false<span class="doctag">&lt;/c&gt;</span>.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> AllowEmpty &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Initializes a new instance of the <span class="doctag">&lt;see cref=&quot;NumericArrayValidator&#123;TNumeric&#125;&quot;/&gt;</span> class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;allowEmpty&quot;&gt;</span>if set to <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> [allow empty].<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">NumericArrayValidator</span>(<span class="params"><span class="built_in">bool</span> allowEmpty</span>) : <span class="title">base</span>(<span class="params"><span class="string">&quot;型別錯誤&quot;</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.AllowEmpty = allowEmpty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Returns true if ... is valid.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span>The context.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> if the specified context is valid; otherwise, <span class="doctag">&lt;c&gt;</span>false<span class="doctag">&lt;/c&gt;</span>.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsValid</span>(<span class="params">PropertyValidatorContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> propertyValue = context.PropertyValue <span class="keyword">as</span> List&lt;<span class="built_in">string</span>&gt;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.AllowEmpty &amp;&amp;</span><br><span class="line">                (propertyValue == <span class="literal">null</span> || propertyValue.Count == <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//不允許空集合或Null</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.AllowEmpty &amp;&amp;</span><br><span class="line">                (propertyValue == <span class="literal">null</span> || propertyValue.Count == <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">bool</span> IsConvertable;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> x <span class="keyword">in</span> propertyValue)</span><br><span class="line">            &#123;</span><br><span class="line">                ConvertHelper.ToT&lt;TNumeric&gt;(x, <span class="keyword">out</span> IsConvertable);</span><br><span class="line">                <span class="keyword">if</span> (!IsConvertable)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><em>擴充方法</em>*```csharp<br>/// <summary></p>
<pre><code>   /// 是數字 Array,但允許空陣列或Null.
   /// &lt;/summary&gt;
   /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
   /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the property.&lt;/typeparam&gt;
   /// &lt;typeparam name=&quot;TNumeric&quot;&gt;The type of the numeric.&lt;/typeparam&gt;
   /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
   /// &lt;returns&gt;&lt;/returns&gt;
   public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericArrayAllowEmpty&lt;T, TProperty, TNumeric&gt;(
       this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)
       where TNumeric : IComparable
   &#123;
       return ruleBuilder.SetValidator(
           new NumericArrayValidator&lt;TNumeric&gt;(allowEmpty: true));
   &#125;

   /// &lt;summary&gt;
   /// 是數字 Array.
   /// &lt;/summary&gt;
   /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
   /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the property.&lt;/typeparam&gt;
   /// &lt;typeparam name=&quot;TNumeric&quot;&gt;The type of the numeric.&lt;/typeparam&gt;
   /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
   /// &lt;returns&gt;&lt;/returns&gt;
   public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericArray&lt;T, TProperty, TNumeric&gt;(
       this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)
       where TNumeric : IComparable
   &#123;
       return ruleBuilder.SetValidator(
           new NumericArrayValidator&lt;TNumeric&gt;(allowEmpty: false));
   &#125;
</code></pre>
</li>
</ul>
<pre><code>
</code></pre>
]]></content>
      <tags>
        <tag>FluentValidation</tag>
      </tags>
  </entry>
  <entry>
    <title>雜湊表(Hash Table)</title>
    <url>/2018/04/25/%E9%9B%9C%E6%B9%8A%E8%A1%A8-Hash-Table/</url>
    <content><![CDATA[<p>學生時期學資料結構跟演算法時，每次看到厚厚的課本加上一堆用C語言寫的範例，雖然都有修過，但說真的不知道它可以拿來做什麼? 直到出了社會開始寫一些專案要調教效能時，才發現原來以前學的是這麼厲害的東西阿。</p>
<p>開始前想先推薦一下這本書【**<a href="http://www.books.com.tw/products/0010771263">演算法圖鑑：26種演算法 + 7種資料結構，人工智慧、數據分析、邏輯思考的原理和應用全圖解</a>**】，作者用簡單的圖解方式帶領讀者瞭解艱澀的資料結構與演算法的歷程，雖然要實際應用在專案中還需要一些內化，但已經比我以前的課本好多了(拭淚)，對這方面有興趣的非常推薦買這本書來看看</p>
<p><img src="https://3.bp.blogspot.com/-smnC4Uqvy2o/WuAO9eoEKeI/AAAAAAAAIpA/bCPO3w0V8foQypYlEuzEOE0Kix5ieq9owCLcBGAs/s320/getImage.jpg"><br>圖片出處:&nbsp;<a href="http://www.books.com.tw/products/0010771263">http://www.books.com.tw/products/0010771263</a></p>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>公司有派送Coupon券的需求，而條件是該券不能與過往中的任何一張重複，所以在產生Coupon券代碼後，最好跟以前的做一下比對來確保沒有發生重複的情形，而Coupon券為英數字12個字元格式，區分大小寫，比對方法想過以下幾種方式</p>
<p><strong>1. 寫入時，用SQL語法的方式要求DB先搜尋確定沒有再寫</strong></p>
<ul>
<li>優點 : 寫法簡單</li>
<li>缺點 : 耗掉DB效能，當要寫入的筆數一多時，DB會出現效能瓶頸</li>
</ul>
<p><strong>2. 將全部的Coupon券撈出來後，進行比對，確定沒有再進行寫入</strong></p>
<ul>
<li>優點 : 因為是將資料撈出DB再從Application端做比對，所以對DB負擔較小</li>
<li>缺點 : 進行字串比對時該如何有效率執行是個問題，尤其是字串比對，如果處理方式不佳，也一樣會在Application端產生效能瓶頸</li>
</ul>
<p>這邊我採取<strong>方式2</strong>並搭配雜湊表來解決，而為何要用雜湊表以下慢慢說明<br>產生Coupon券的程式如下</p>
<figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 隨機產生Couopn</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;number&quot;&gt;</span>幾位數<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">CreateNewCode</span>(<span class="params"><span class="built_in">int</span> number</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="built_in">string</span> allChar = <span class="string">&quot;0,1,2,3,4,5,6,7,8,9,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z&quot;</span>;</span><br><span class="line"> <span class="built_in">string</span>[] allCharArray = allChar.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line"> <span class="built_in">string</span> randomCode = <span class="built_in">string</span>.Empty;</span><br><span class="line"></span><br><span class="line"> Random rand = <span class="keyword">new</span> Random();</span><br><span class="line"> <span class="built_in">int</span> temp = <span class="number">-1</span>;</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; number; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">if</span> (temp != <span class="number">-1</span>)</span><br><span class="line">   rand = <span class="keyword">new</span> Random(i * temp * Guid.NewGuid().GetHashCode());</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> t = rand.Next(<span class="number">62</span>);</span><br><span class="line">  <span class="keyword">if</span> (temp != <span class="number">-1</span> &amp;&amp; temp == t)</span><br><span class="line">   <span class="keyword">return</span> CreateNewCode(number);</span><br><span class="line"></span><br><span class="line">  temp = t;</span><br><span class="line">  randomCode += allCharArray[t];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> randomCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>執行方式<br><img src="https://2.bp.blogspot.com/-VCEeS9lnvOA/WuATxkpoMJI/AAAAAAAAIpQ/Gk1ddWkT2LQiXkmBFVC91MKl5bY9JeO4ACLcBGAs/s400/1524634551190.jpg"></p>
<h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><p>如果你是寫C#的，那要比對是否有一樣的東西存在List中最快的方式就是用Any()這個方法，而我們知道List儲存方式實際是這樣<br><img src="https://3.bp.blogspot.com/-8zOTRs4Cc2c/WuAVJpzqr3I/AAAAAAAAIpY/cXL5qgSCJfACEtr2M1mFW0G5Y6sHYE7SQCLcBGAs/s400/4.png"></p>
<p>記憶體位置放置資料內容，而每個節點會記錄下一筆資料的記憶體位置在哪，所以List裡面的資料未必是一個相連的記憶體區段，但它只要知道開頭那筆資料，就可以依序將資料逐筆讀取出來。</p>
<p>換言之，如果要搜尋一個列表中是否有相同的資料存在，必須用線性的方式搜尋，也就是逐筆檢查，從第一筆開始每筆拿出來看看，直到比對到為止，最佳的狀況是第一筆就是你要比對的資料，最差，就是最後一筆才是你要的資料，而且搜尋的成本會隨著資料的增長而遞增。</p>
<h3 id="1萬筆資料搜尋效能"><a href="#1萬筆資料搜尋效能" class="headerlink" title="1萬筆資料搜尋效能"></a>1萬筆資料搜尋效能</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span> 產生的資料筆數 = <span class="number">10000</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="comment">//準備要用來搜尋的資料</span></span><br><span class="line"> <span class="keyword">var</span> Pools = CreateSearchPool();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//透過Stopwatch來看看實際搜尋要花費的時間</span></span><br><span class="line"> Stopwatch sw = <span class="keyword">new</span> System.Diagnostics.Stopwatch();</span><br><span class="line"></span><br><span class="line"> Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//總共花費的時間</span></span><br><span class="line"> <span class="built_in">double</span> TotalTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//搜尋一百次</span></span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="comment">//動態從產生的資料母體中抽一筆作為我們要搜尋的目標</span></span><br><span class="line">  <span class="keyword">var</span> RandomIndex = rnd.Next(<span class="number">0</span>, 產生的資料筆數 <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//取出要搜尋的字</span></span><br><span class="line">  <span class="keyword">var</span> Target = Pools[RandomIndex];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//碼表歸零</span></span><br><span class="line">  sw.Reset();</span><br><span class="line">  <span class="comment">//碼表開始計時</span></span><br><span class="line">  sw.Start();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//透過Any方式對List做搜尋</span></span><br><span class="line">  <span class="keyword">var</span> Result = Pools.Any(x=&gt; x == Target);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//搜尋結束，碼錶停止</span></span><br><span class="line">  sw.Stop();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//將時間加上這次搜尋花費的時間，為毫秒</span></span><br><span class="line">  TotalTime += sw.Elapsed.TotalMilliseconds;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//算出平均每次搜尋，耗費的秒數</span></span><br><span class="line"> (TotalTime /<span class="number">100</span>).Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//建立要搜尋的母體</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt; <span class="title">CreateSearchPool</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> List&lt;<span class="built_in">string</span>&gt;  Pool = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; 產生的資料筆數; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="comment">//動態新增Coupon資料</span></span><br><span class="line">  <span class="keyword">var</span> Code = CreateNewCode(<span class="number">12</span>);</span><br><span class="line">  <span class="comment">//丟進我們要用來搜尋Pool</span></span><br><span class="line">  Pool.Add(Code);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> Pool;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 隨機產生Couopn券代碼</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">CreateNewCode</span>(<span class="params"><span class="built_in">int</span> number</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="built_in">string</span> allChar = <span class="string">&quot;0,1,2,3,4,5,6,7,8,9,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z&quot;</span>;</span><br><span class="line"> <span class="built_in">string</span>[] allCharArray = allChar.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line"> <span class="built_in">string</span> randomCode = <span class="built_in">string</span>.Empty;</span><br><span class="line"></span><br><span class="line"> Random rand = <span class="keyword">new</span> Random();</span><br><span class="line"> <span class="built_in">int</span> temp = <span class="number">-1</span>;</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; number; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">if</span> (temp != <span class="number">-1</span>)</span><br><span class="line">   rand = <span class="keyword">new</span> Random(i * temp * Guid.NewGuid().GetHashCode());</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> t = rand.Next(<span class="number">62</span>);</span><br><span class="line">  <span class="keyword">if</span> (temp != <span class="number">-1</span> &amp;&amp; temp == t)</span><br><span class="line">   <span class="keyword">return</span> CreateNewCode(number);</span><br><span class="line"></span><br><span class="line">  temp = t;</span><br><span class="line">  randomCode += allCharArray[t];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> randomCode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>實際算出來的平均搜尋時間為 0.083978(毫秒)<br><img src="https://2.bp.blogspot.com/-tQqJviXLOCo/WuAYO5enERI/AAAAAAAAIpk/0phrut2lXZAeKHlxmUmaJcwRH5XKPOQ2gCLcBGAs/s320/1524634551190.jpg"></p>
<h3 id="100萬筆資料搜尋效能"><a href="#100萬筆資料搜尋效能" class="headerlink" title="100萬筆資料搜尋效能"></a>100萬筆資料搜尋效能</h3><p>將搜尋母體放大100倍，也就是從100萬筆資料中隨機抽樣搜尋100次，結果為8.540132(毫秒)<br><img src="https://4.bp.blogspot.com/-y_vAjnwVC8g/WuAY6Daco7I/AAAAAAAAIps/jBd4pstz1C4a8M-Romh7y6DLjbwxM8oQACLcBGAs/s320/1524634551190.jpg"></p>
<p><strong>可以觀察到搜尋效率隨著資料量的增長快速遞減</strong>，而一百萬筆對於Coupon券來說其實不多，如果你的會員數有一萬人，每個人發到第100張時，總共發出去的數量就達到這個等級了 ，相信很多店商平台所產出的Coupon數遠遠大於這個量。</p>
<h2 id="雜湊表"><a href="#雜湊表" class="headerlink" title="雜湊表"></a>雜湊表</h2><p>雜湊表與List的最大差異是它非線性搜尋，它將所有要放入的資料先進行雜湊的方式算出一個值後，依據算出來的值放到對應的記憶體位置去，搜尋時也是先將要搜尋的值進行雜湊運算，算出對應位置，直接取出該記憶體的資料進行比對</p>
<p><img src="https://1.bp.blogspot.com/-3NId_KHtuNQ/WuAcAKGQ_TI/AAAAAAAAIp4/Zlj2-QGfly0AVMqrN0ISR6ZmwDgLPqYlACLcBGAs/s640/5.png"></p>
<p>特點是它非線性搜尋，也就是說它不需要抓到第一筆資料後，依序依據指標，往下找下一筆資料，即便不是還是要每筆遍尋才能知道結果，雜湊表的好處就在於，你要搜尋時，就已經知道該去哪找了。</p>
<p>而可能會有一個問題，那如果經過運算後，兩筆資料要儲存的地方一樣呢?這時候就是發生所謂的<strong>碰撞</strong>，一張好的雜湊表理論上要盡量避免碰撞發生，但現實中難以避免，所以進階的用法就是將相同位置內再放入List來存入更多筆資料。<br><img src="https://4.bp.blogspot.com/-jHUfoyB0QxQ/WuAdptnHTMI/AAAAAAAAIqE/vOzIaX6O0-0A1JbkLAtF5HB28UkSbyDsQCLcBGAs/s640/5.png"></p>
<p>這邊可能會有一個疑問是，那跟我一開始用List有什麼差別 ?</p>
<p>如果我們相信資料是平均分佈，那雜湊結果理論上也會平均分佈，但就如前面提的，現實中實在難以避免碰撞的發生，所以即便真的發生碰撞，我們也能確定List中的資料絕對不會有很多筆，多到導致效能瓶頸的發生。所以雜湊表的陣列該開出幾格來就是需要經過考量的，如果你有數百萬筆的資料，只開出100格，那最平均的結果就是每一格裡面會有1萬筆的資料，這顯然不理想。</p>
<h3 id="1萬筆資料搜尋效能-1"><a href="#1萬筆資料搜尋效能-1" class="headerlink" title="1萬筆資料搜尋效能"></a>1萬筆資料搜尋效能</h3><figure class="highlight csharp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span> 產生的資料筆數 = <span class="number">10000</span>;</span><br><span class="line"><span class="built_in">int</span> 雜湊表格數 = <span class="number">1000</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="comment">//準備要用來搜尋的資料</span></span><br><span class="line"> <span class="keyword">var</span> Pools = CreateSearchPool();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//透過Stopwatch來看看實際搜尋要花費的時間</span></span><br><span class="line"> Stopwatch sw = <span class="keyword">new</span> System.Diagnostics.Stopwatch();<span class="comment">//引用stopwatch物件</span></span><br><span class="line"></span><br><span class="line"> Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//總共花費的時間</span></span><br><span class="line"> <span class="built_in">double</span> TotalTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//搜尋一百次</span></span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="comment">//動態從產生的資料母體中抽一筆作為我們要搜尋的目標</span></span><br><span class="line">  <span class="keyword">var</span> RandomIndex = rnd.Next(<span class="number">0</span>, 產生的資料筆數 - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//取出要搜尋的字</span></span><br><span class="line">  <span class="keyword">var</span> Target = AllCode[RandomIndex];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//碼表歸零</span></span><br><span class="line">  sw.Reset();</span><br><span class="line">  <span class="comment">//碼表開始計時</span></span><br><span class="line">  sw.Start();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//取得Hash後應該存放的位置</span></span><br><span class="line">  <span class="keyword">var</span> HashPosition = GetHashPosition(Target);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//從陣列中取出該筆資料</span></span><br><span class="line">  <span class="keyword">var</span> PositionData = Pools[HashPosition];</span><br><span class="line"></span><br><span class="line">  <span class="comment">//如果有資料</span></span><br><span class="line">  <span class="keyword">if</span> (PositionData != <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="comment">//檢查這個List是否存在相同的Coupon代碼</span></span><br><span class="line">   <span class="keyword">var</span> Result = PositionData.Any(x =&gt; x == Target);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//碼錶停止</span></span><br><span class="line">  sw.Stop();</span><br><span class="line"></span><br><span class="line">  <span class="comment">//將時間加上這次搜尋花費的時間，為毫秒</span></span><br><span class="line">  TotalTime += sw.Elapsed.TotalMilliseconds;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//算出平均每次搜尋，耗費的秒數</span></span><br><span class="line"> (TotalTime / <span class="number">100</span>).Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">List&lt;<span class="built_in">string</span>&gt; AllCode =<span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"><span class="function"><span class="keyword">private</span> List&lt;<span class="built_in">string</span>&gt;[] <span class="title">CreateSearchPool</span>(<span class="params"></span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> List&lt;<span class="built_in">string</span>&gt;[] SearchPool = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;[雜湊表格數];</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; 產生的資料筆數; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">var</span> Code = CreateNewCode(<span class="number">12</span>);</span><br><span class="line">  AllCode.Add(Code);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> p = GetHashPosition(Code);</span><br><span class="line">  <span class="keyword">var</span> PositionData = SearchPool[p];</span><br><span class="line">  <span class="keyword">if</span> (PositionData == <span class="literal">null</span>)</span><br><span class="line">  &#123;</span><br><span class="line">   PositionData = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line">   SearchPool[p] = PositionData;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  PositionData.Add(Code);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">return</span> SearchPool;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 隨機產生Couopn</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;number&quot;&gt;</span>幾位數<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">CreateNewCode</span>(<span class="params"><span class="built_in">int</span> number</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="built_in">string</span> allChar = <span class="string">&quot;0,1,2,3,4,5,6,7,8,9,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z&quot;</span>;</span><br><span class="line"> <span class="built_in">string</span>[] allCharArray = allChar.Split(<span class="string">&#x27;,&#x27;</span>);</span><br><span class="line"> <span class="built_in">string</span> randomCode = <span class="built_in">string</span>.Empty;</span><br><span class="line"></span><br><span class="line"> Random rand = <span class="keyword">new</span> Random();</span><br><span class="line"> <span class="built_in">int</span> temp = <span class="number">-1</span>;</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; number; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">if</span> (temp != <span class="number">-1</span>)</span><br><span class="line">   rand = <span class="keyword">new</span> Random(i * temp * Guid.NewGuid().GetHashCode());</span><br><span class="line"></span><br><span class="line">  <span class="built_in">int</span> t = rand.Next(<span class="number">62</span>);</span><br><span class="line">  <span class="keyword">if</span> (temp != <span class="number">-1</span> &amp;&amp; temp == t)</span><br><span class="line">   <span class="keyword">return</span> CreateNewCode(number);</span><br><span class="line"></span><br><span class="line">  temp = t;</span><br><span class="line">  randomCode += allCharArray[t];</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">return</span> randomCode;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SHA256 sha256 = <span class="keyword">new</span> SHA256CryptoServiceProvider();</span><br><span class="line"><span class="comment">//取得Hash後應該存放的位置</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">GetHashPosition</span>(<span class="params"><span class="built_in">string</span> code</span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">var</span> ByteArray = sha256.ComputeHash(Encoding.Default.GetBytes(code));</span><br><span class="line"> <span class="keyword">var</span> IntResult = BitConverter.ToInt32(ByteArray, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"> <span class="comment">//轉正</span></span><br><span class="line"> IntResult = Math.Abs(IntResult);</span><br><span class="line">        <span class="comment">//除格子數，餘數就是這筆資料該放的位置</span></span><br><span class="line"> <span class="keyword">return</span> IntResult % 雜湊表格數;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>實際算出來的平均搜尋時間為 0.004124(毫秒)<br><img src="https://4.bp.blogspot.com/-vJKz9RTTIrE/WuAgfayRf2I/AAAAAAAAIqY/dfiypYwPw6U3FsOpd7KSfq9PTEoP77aFQCLcBGAs/s320/1524634551190.jpg"></p>
<h3 id="100萬筆資料搜尋效能-1"><a href="#100萬筆資料搜尋效能-1" class="headerlink" title="100萬筆資料搜尋效能"></a>100萬筆資料搜尋效能</h3><p>一樣將數字放大到100萬筆，實際算出來的平均搜尋時間為 0.033612(毫秒)，可以發現即便搜尋筆數擴張了100倍，效率並沒有完全等比遞減<br><img src="https://2.bp.blogspot.com/-OnhkLzr3Sbk/WuAim-sw7YI/AAAAAAAAIqk/jjOy-f4I-24HB97unw6zo9yvrhKVxm9uwCLcBGAs/s320/1524634551190.jpg"></p>
<p>當然各種資料型態跟搜尋狀況不同，可能適用的資料結構與演算法也會略有不同要取捨，雜湊法也並非沒有缺點，例如在製作表時比較耗時，所以適合用在資料變動不大的情境，先將表做起來後放到快取去更新維護都是一些優化的方法，以上提供給大家參考。</p>
]]></content>
      <tags>
        <tag>資料結構</tag>
      </tags>
  </entry>
  <entry>
    <title>Regular Expression 苦手筆記</title>
    <url>/2016/03/01/Regular-Expression-%E8%8B%A6%E6%89%8B%E7%AD%86%E8%A8%98/</url>
    <content><![CDATA[<p>Regular Expression(後面簡稱<strong>RE</strong>)真的是一個非常難以閱讀的語言，從大學時期初次碰到，到現在當工程師已經5年多，常常碰到都還是要翻找書籍和嘗試很久才能寫出自己想要的東西，這邊就做點簡單的筆記避免之後又忘記了。</p>
<p>範例:<br>如果今天我有一段Log如下</p>
<p>=================================================<br>2016-02-25 00:05:50.9017 | INFO | TID:9 |</p>
<p>Request:<br>Method: <span style="color: red;">GET</span>,<span style="color: red;"> </span>RequestUri: ‘<span style="color: red;"><a href="http://regularexpression.com.tw/v1/1456329948291/500">http://regularexpression.com.tw/v1/1456329948291/500</a></span>‘, Version: 1.1, Content: System.Web.Http.WebHost.HttpControllerHandler+LazyStreamContent, Headers:<br>{<br>&nbsp; Connection: keep-alive<br>&nbsp; Accept-Encoding: gzip<br>&nbsp; Host:&nbsp;regularexpression.com.tw<br>&nbsp; X-YC-IM-Device-OS: 2<br>&nbsp; X-YC-IM-Token: <span style="color: red;">Token</span><br>&nbsp; X-Forwarded-For: xx.xxx.xxx.xxx<br>&nbsp; X-Forwarded-Port: 443<br>&nbsp; X-Forwarded-Proto: https<br>&nbsp; Process-Start-Time: Time: 2016-02-25 00:05:50.183<br>&nbsp; Process–End–Time: Time: 2016-02-25 00:05:50.901<br>&nbsp; Process-Time-Count: Ticks: 7141131, <span style="color: red;">714 ms</span><br>&nbsp; Content-Length: 0<br>}<br>=================================================</p>
<p>我想節錄出紅字的部分，我自己解法如下</p>
<ol>
<li> 首先因為<strong>RE</strong>具有將斷行視為一個完整句子的特性，所以要跨行搜尋變的很困難，所以我先會將斷行符號換成自己定義的連結符號，好讓整段Log可以變成一個連貫的字串 ```csharp<br>content.Replace(Environment.NewLine,”&lt;^^&gt;”);<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">2.  接著RE Pattern如下</span><br><span class="line">**&#123;% note info %&#125;</span><br><span class="line">&#x2F;Method:\s(?&lt;mehtod&gt;[^,]*),\sRequestUri:\s&#39;(?&lt;uri&gt;[^&#39;]*)&#39;,.*?X-YC-IM-Token:\s(?&lt;token&gt;[^&lt;]*)&lt;\^\^&gt;.*?Process-Time-Count:\sTicks:\s[0-9]+,\s(?&lt;processTime&gt;[^&lt;]*)&lt;\^\^&gt;&#x2F;</span><br><span class="line">&#123;% endnote %&#125;</span><br><span class="line">**</span><br><span class="line"></span><br><span class="line">    **@解析**Method:\s(?&lt;mehtod&gt;**&lt;span style&#x3D;&quot;color: red;&quot;&gt;[^,]&lt;&#x2F;span&gt;***),**</span><br><span class="line">**\s為空白字元，所以等於從Method: 開始到下一個不是**&lt;span style&#x3D;&quot;color: red;&quot;&gt;逗號&lt;&#x2F;span&gt;**的字元抓出來儲存到method這個參數之中</span><br><span class="line"></span><br><span class="line">@**解析**\sRequestUri:\s&#39;(?&lt;uri&gt;**&lt;span style&#x3D;&quot;color: red;&quot;&gt;[^&#39;]&lt;&#x2F;span&gt;***)&#39;,</span><br><span class="line">從 RequestUri: &#39;開始到下一個不是&amp;nbsp;&lt;span style&#x3D;&quot;color: red;&quot;&gt;&#39;&amp;nbsp;&lt;&#x2F;span&gt;的字元抓出來儲存到uri這個參數之中</span><br><span class="line"></span><br><span class="line">@**解析.*?X-YC-IM-Token:\s(?&lt;token&gt;&lt;span style&#x3D;&quot;color: red;&quot;&gt;[^&lt;]&lt;&#x2F;span&gt;*)&lt;\^\^&gt;**</span><br><span class="line">之後接著N個字元直到出現**X-YC-IM-Token: **將**&amp;nbsp;之後抓取N個字元直到出現****&lt;span style&#x3D;&quot;color: red;&quot;&gt;&lt;&lt;&#x2F;span&gt;為止，**儲存到token。這邊特別提一下這段最前面的.*?，如果我們的Log只有這麼一段沒有太大問題，如果我們的Log是重複上面的格式出現很多串，如果單純只下**.*X-YC-IM-Token也就是少了**&lt;span style&#x3D;&quot;color: red;&quot;&gt;問號&lt;&#x2F;span&gt;，那他就會一直抓且跨很多段Log直到最後一個**X-YC-IM-Token**出現為止。</span><br><span class="line"></span><br><span class="line">    ?號有與沒有差別在於貪婪搜尋，有問號表示非貪婪模式，搜尋到第一個符合的即停</span><br><span class="line">3.  後面的符號都出現過也一直重複，所以就不另外說明，在.NET中要取出剛剛用RE儲存的參數寫法如下</span><br><span class="line">&#96;&#96;&#96;csharp</span><br><span class="line">content &#x3D; content.Replace(Environment.NewLine,&quot;&lt;^^&gt;&quot;);</span><br><span class="line">string pattern &#x3D; @&quot;Method:\s(?&lt;mehtod&gt;[^,]*),\sRequestUri:\s&#39;(?&lt;uri&gt;[^&#39;]*)&#39;,.*?X-YC-IM-Token:\s(?&lt;token&gt;[^&lt;]*)&lt;\^\^&gt;.*?Process-Time-Count:\sTicks:\s[0-9]+,\s(?&lt;processTime&gt;[^&lt;]*)&lt;\^\^&gt;&quot;;</span><br><span class="line"></span><br><span class="line">    Regex reg &#x3D; new Regex(pattern, RegexOptions.IgnoreCase);</span><br><span class="line"></span><br><span class="line">    MatchCollection matches &#x3D; reg.Matches(content);</span><br><span class="line">foreach (Match match in matches)</span><br><span class="line">&#123;</span><br><span class="line">Console.WriteLine(match.Groups[&quot;mehtod&quot;].Value);</span><br><span class="line">Console.WriteLine(match.Groups[&quot;uri&quot;].Value);</span><br><span class="line">Console.WriteLine(match.Groups[&quot;token&quot;].Value);</span><br><span class="line">Console.WriteLine(match.Groups[&quot;processTime&quot;].Value);&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<p>以下附錄來源 : <a href="https://atedev.wordpress.com/2007/11/23/%E6%AD%A3%E8%A6%8F%E8%A1%A8%E7%A4%BA%E5%BC%8F-regular-expression/">就是愛程式 -&nbsp;正規表示式 Regular Expression</a></p>
<table border="1" style="background-color: white; border-spacing: 0px; border: 0px; color: #404040; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 20px; margin: 0px 0px 20px; outline: 0px; padding: 0px; vertical-align: baseline; width: 700px;"><thead style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; font-weight: 700; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">正規表示式</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; font-weight: 700; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">說明及範例</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; font-weight: 700; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對不成立之字串</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a/</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;" width="230">含字母 “a” 的字串，例如 “ab”, “bac”, “cba”</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">“xyz”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a./</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;" width="230">含字母 “a” 以及其後任一個字元的字串，例如 “ab”, “bac”（若要比對.，請使用 \.）</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">“a”, “ba”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/^xy/</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;" width="230">以 “xy” 開始的字串，例如 “xyz”, “xyab”（若要比對 ^，請使用 \^）</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">“axy”, “bxy”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/xy$/</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;" width="230">以 “xy” 結尾的字串，例如 “axy”, “abxy”以 “xy” 結尾的字串，例如 “axy”, “abxy” （若要比對 $，請使用 \$）</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">“xya”, “xyb”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[13579]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;" width="230">包含 “1” 或 “3” 或 “5” 或 “7” 或 “9” 的字串，例如：”a3b”, “1xy”</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">“y2k”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[0-9]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">含數字之字串</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">不含數字之字串</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[a-z0-9]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">含數字或小寫字母之字串</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">不含數字及小寫字母之字串</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[a-zA-Z0-9]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">含數字或字母之字串</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">不含數字及字母之字串</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">b[aeiou]t</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">“bat”, “bet”, “bit”, “bot”, “but”</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">“bxt”, “bzt”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[^0-9]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">不含數字之字串（若要比對 ^，請使用 \^）</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">含數字之字串</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[^aeiouAEIOU]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">不含母音之字串（若要比對 ^，請使用 \^）</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">含母音之字串</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[^\^]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">不含 “^” 之字串，例如 “xyz”, “abc”</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">“xy^”, “a^bc”</td></tr></thead></table><div style="background-color: white; border: 0px; color: #404040; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 20px; margin-bottom: 1.5em; outline: 0px; padding: 0px; vertical-align: baseline;">.</div><table border="1" style="background-color: white; border-spacing: 0px; border: 0px; color: #404040; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 20px; margin: 0px 0px 20px; outline: 0px; padding: 0px; vertical-align: baseline; width: 700px;"><thead style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">正規表示式的特定字元</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">說明</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">等效的正規表示式</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\d</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">數字</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[0-9]</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\D</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">非數字</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[^0-9]</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\w</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">數字、字母、底線</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[a-zA-Z0-9_]</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\W</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">非 \w</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[^a-zA-Z0-9_]</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\s</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">空白字元</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[ \r\t\n\f]</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\S</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">非空白字元</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[^ \r\t\n\f]</td></tr></thead></table><div style="background-color: white; border: 0px; color: #404040; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 20px; margin-bottom: 1.5em; outline: 0px; padding: 0px; vertical-align: baseline;">.</div><table border="1" style="background-color: white; border-spacing: 0px; border: 0px; color: #404040; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 20px; margin: 0px 0px 20px; outline: 0px; padding: 0px; vertical-align: baseline; width: 700px;"><thead style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">正規表示式</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">說明</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a?/</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">零或一個 a（若要比對? 字元，請使用 \?）</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a+/</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">一或多個 a（若要比對+ 字元，請使用 \+）</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a*/</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">零或多個 a（若要比對* 字元，請使用 \*）</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a{4}/</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">四個 a</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a{5,10}/</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">五至十個 a</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a{5,}/</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">至少五個 a</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a{,3}/</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">至多三個 a</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a.{5}b/</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">a 和 b中間夾五個（非換行）字元</td></tr></thead></table><div style="background-color: white; border: 0px; color: #404040; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 20px; margin-bottom: 1.5em; outline: 0px; padding: 0px; vertical-align: baseline;">.</div><table border="1" style="background-color: white; border-spacing: 0px; border: 0px; color: #404040; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; line-height: 20px; margin: 0px 0px 20px; outline: 0px; padding: 0px; vertical-align: baseline; width: 700px;"><thead style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">字元</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">說明</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">簡單範例</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">避開特殊字元</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/A\*/ 可用於比對 “A*”，其中 * 是一個特殊字元，為避開其特殊意義，所以必須加上 “\”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">^</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對輸入列的啟始位置</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/^A/ 可比對 “Abcd” 中的 “A”，但不可比對 “aAb”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">$</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對輸入列的結束位置</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/A$/ 可比對 “bcdA” 中的 “A”，但不可比對 “aAb”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">*</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對前一個字元零次或更多次</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/bo*/ 可比對 “Good boook” 中的 “booo”，亦可比對 “Good bk” 中的 “b”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">+</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對前一個字元一次或更多次，等效於 {1,}</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a+/ 可比對 “caaandy” 中的 “aaa”，但不可比對 “cndy”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">?</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對前一個字元零次或一次</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/e?l/ 可比對 “angel” 中的 “el”，也可以比對 “angle” 中的 “l”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">.</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對任何一個字元（但換行符號不算）</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/.n/ 可比對 “nay, an apple is on the tree” 中的 “an” 和 “on”，但不可比對 “nay”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">(x)</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對 x 並將符合的部分存入一個變數</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/(a*) and (b*)/ 可比對 “aaa and bb” 中的 “aaa” 和 “bb”，並將這兩個比對得到的字串設定至變數 RegExp.$1 和 RegExp.$2。</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">xy</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對 x 或 y</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a*b*/g 可比對 “aaa and bb” 中的 “aaa” 和 “bb”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">{n}</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對前一個字元 n 次，n 為一個正整數</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a{3}/ 可比對 “lllaaalaa” 其中的 “aaa”，但不可比對 “aa”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">{n,}</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對前一個字元至少 n 次，n 為一個正整數</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a{3,}/ 可比對 “aa aaa aaaa” 其中的 “aaa” 及 “aaaa”，但不可比對 “aa”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">{n,m}</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對前一個字元至少 n 次，至多 m 次，m、n 均為正整數</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/a{3,4}/ 可比對 “aa aaa aaaa aaaaa” 其中的 “aaa” 及 “aaaa”，但不可比對 “aa” 及 “aaaaa”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[xyz]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對中括弧內的任一個字元</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/[ecm]/ 可比對 “welcome” 中的 “e” 或 “c” 或 “m”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[^xyz]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對不在中括弧內出現的任一個字元</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/[^ecm]/ 可比對 “welcome” 中的 “w”、”l”、”o”，可見出其與 [xyz] 功能相反。（同時請注意 /^/ 與 [^] 之間功能的不同。）</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">[\b]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對退位字元（Backspace character）</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">可以比對一個 backspace ，也請注意 [\b] 與 \b 之間的差別</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\b</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對英文字的邊界，例如空格</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">例如 /\bn\w/ 可以比對 “noonday” 中的 ‘no’ ;
/\wy\b/ 可比對 “possibly yesterday.” 中的 ‘ly’</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\B</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對非「英文字的邊界」</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">例如, /\w\Bn/ 可以比對 “noonday” 中的 ‘on’ ,
另外 /y\B\w/ 可以比對 “possibly yesterday.” 中的 ‘ye’</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\cX</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對控制字元（Control character），其中 X 是一個控制字元</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/\cM/ 可以比對 一個字串中的 control-M</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\d</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對任一個數字，等效於 [0-9]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/[\d]/ 可比對 由 “0” 至 “9” 的任一數字 但其餘如字母等就不可比對</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\D</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對任一個非數字，等效於 [^0-9]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/[\D]/ 可比對 “w” “a”… 但不可比對如 “7” “1” 等數字</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\f</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對 form-feed</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">若是在文字中有發生 “換頁” 的行為 則可以比對成功</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\n</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對換行符號</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">若是在文字中有發生 “換行” 的行為 則可以比對成功</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\r</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對 carriage return</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;"></td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\s</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對任一個空白字元（White space character），等效於 [ \f\n\r\t\v]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/\s\w*/ 可比對 “A b” 中的 “b”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\S</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對任一個非空白字元，等效於 [^ \f\n\r\t\v]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/\S/\w* 可比對 “A b” 中的 “A”</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\t</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對定位字元（Tab）</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;"></td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\v</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對垂直定位字元（Vertical tab）</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;"></td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\w</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對數字字母字元（Alphanumerical characters）或底線字母（”_”），等效於 [A-Za-z0-9_]</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/\w/ 可比對 “.A _!9” 中的 “A”、”_”、”9〃。</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="background: rgb(247, 247, 247); border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\W</td><td style="background: rgb(247, 247, 247); border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對非「數字字母字元或底線字母」，等效於 [^A-Za-z0-9_]</td><td style="background: rgb(247, 247, 247); border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/\W/ 可比對 “.A _!9” 中的 “.”、” “、”!”，可見其功能與 /\w/ 恰好相反。</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\o_octal_</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對八進位，其中_octal<em style="border: 0px; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">是八進位數目_</em></td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/\oocetal123/ 可比對 與 八進位的ASCII中 “123” 所相對應的字元值。</td></tr><tr style="border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;"><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">\x_hex_</td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">比對十六進位，其中_hex<em style="border: 0px; font-family: inherit; font-weight: inherit; margin: 0px; outline: 0px; padding: 0px; vertical-align: baseline;">是十六進位數目_</em></td><td style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-width: 0px 0px 1px; font-family: inherit; font-style: inherit; margin: 0px; outline: 0px; padding: 8px; vertical-align: middle;">/\xhex38/ 可比對 與 16進位的ASCII中 “38” 所相對應的字元。</td></tr></thead></table>

<p>好用的Regular expression測試網站 : &nbsp;<a href="http://www.rubular.com/">http://www.rubular.com/</a><br>延伸閱讀 : <a href="https://disp.cc/b/11-2q1S">貪婪與非貪婪效能問題</a></p>
]]></content>
      <tags>
        <tag>Regular Expression</tag>
      </tags>
  </entry>
  <entry>
    <title>【MVC教學】3. Route(一)</title>
    <url>/2018/03/17/%E3%80%90MVC%E6%95%99%E5%AD%B8%E3%80%913-Route-%E4%B8%80/</url>
    <content><![CDATA[<div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">什麼是<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>？<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> </span>在現實生活中比較接近於郵差與地圖的關係，你將想要送的東西交給郵差,郵差依據包裹上的地址，透過地圖找到目的地然後投遞。

<p>而對應到程式中[網址]就是你包裹要送達的目的地址，Route就是[地圖]，而網址的[參數]就是你要投遞的包裹</div><div></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-v_OpLGzjdtw/Wq0MHMSi2mI/AAAAAAAAIko/7mcxcoPLkpUWExDOSn657rGCjMfUtiJSgCLcBGAs/s400/1.jpg)](https://4.bp.blogspot.com/-v_OpLGzjdtw/Wq0MHMSi2mI/AAAAAAAAIko/7mcxcoPLkpUWExDOSn657rGCjMfUtiJSgCLcBGAs/s1600/1.jpg)</div>
<div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">接著我們來看看專案內的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>在哪邊設定，又它是如何透過網址知道該把[包裹]送去哪支程式的，這邊先把我們之前的專案執行起來，並且點擊[關於]</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-ryN1Z3Mp3SI/Wq0MU9PT8mI/AAAAAAAAIks/ONCnMFBGRhYG0YWmLnZUV__5jGS5gpBBgCLcBGAs/s400/2.png)](https://1.bp.blogspot.com/-ryN1Z3Mp3SI/Wq0MU9PT8mI/AAAAAAAAIks/ONCnMFBGRhYG0YWmLnZUV__5jGS5gpBBgCLcBGAs/s1600/2.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">可以看到關於頁的網址為</span> /Home/About</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-F1fHYAInGic/Wq0MkAgp4uI/AAAAAAAAIkw/PN3nKltrc5wH8Lkb9Lk5_6flzLCy80GOACLcBGAs/s400/3.png)](https://4.bp.blogspot.com/-F1fHYAInGic/Wq0MkAgp4uI/AAAAAAAAIkw/PN3nKltrc5wH8Lkb9Lk5_6flzLCy80GOACLcBGAs/s1600/3.png)</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">接著我們在<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">HomeController</span>的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">About</span>下中斷點後再點擊一次網頁的[關於]按鈕，會發現程式停在我們下中斷點的地方了？<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> </span>為什麼知道程式會跑到這邊呢<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> ? </span>這一切都是因為有<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>指路的關係</div></div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-LFueIPKzOYI/Wq0MwArDFLI/AAAAAAAAIk4/gJdWivFruxcZoCKaGNAfYamVnM8JEO3igCLcBGAs/s400/4.png)](https://1.bp.blogspot.com/-LFueIPKzOYI/Wq0MwArDFLI/AAAAAAAAIk4/gJdWivFruxcZoCKaGNAfYamVnM8JEO3igCLcBGAs/s1600/4.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">
</div>

<h3 id="RouteConfig"><a href="#RouteConfig" class="headerlink" title="RouteConfig"></a><strong>RouteConfig</strong></h3><div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>的規則是可以自己制訂的，而制定的地方就在<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">App_Start</span>資料夾底下的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">RouteConfig</span>裡面</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-empHw_-1tig/Wq0M_p2kL-I/AAAAAAAAIlA/XQjsx0UahlsjJyqijDxTtSa7hmnkJVm5ACLcBGAs/s400/5.png)](https://2.bp.blogspot.com/-empHw_-1tig/Wq0M_p2kL-I/AAAAAAAAIlA/XQjsx0UahlsjJyqijDxTtSa7hmnkJVm5ACLcBGAs/s1600/5.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-r4pEpAts3NA/Wq0NBNPYBKI/AAAAAAAAIlE/rUslCqFTfUEvvPRAG5cWKdDvL8S_CgGGQCLcBGAs/s400/6.png)](https://3.bp.blogspot.com/-r4pEpAts3NA/Wq0NBNPYBKI/AAAAAAAAIlE/rUslCqFTfUEvvPRAG5cWKdDvL8S_CgGGQCLcBGAs/s1600/6.png)</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-size: 12px; font-stretch: normal; line-height: normal;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-size: 12px; font-stretch: normal; line-height: normal;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">讓我們來解讀這段程式碼，首先<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">routes.MapRoute</span>就是註冊地址的方法，裡面有幾個參數分別為</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal;">Name : <span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">你對於這個</span>Route<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的命名</span></div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Url : </span>網址條件，當網址符合這個條件特徵時，就會依據這個<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>的指示去找對應執行的程式碼</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal;">defaults : <span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">參數的預設值</span></div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">相信光是講解參數的意義對於要理解<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>還有相當的距離，讓我們直接來實戰理解<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> /Home/About</span>這串網址如何對應到<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>的吧，剛剛有說，<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">routes.MapRoute</span>的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Url</span>參數是用來判斷網址特徵是否相符，如果相符就會被這串<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>捕捉到，但是這兩個怎麼看都不像啊</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">真實網址</span> <span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">：</span> /Home/About</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal;">Route Url :&nbsp; {controller}/{action}/{id}</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">首先必須先知道一件事情，當<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route Url</span>的網址用<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">{ }</span>包起來的時候，代表他是個變數，什麼是變數？變數是一個表示值，它可以是任意的值，而<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">{}</span>裡面的字就是變數的名稱，以上述例子為例</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">controller</span>，它可以是任意的值</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">action</span>，它可以是任意得值</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">id</span>，它也可以是任意的值</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">那套入</span>/Home/About<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">會變成什麼結果？</span></div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">controller</span>，它現在的值是<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Home</span></div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">action</span>，它現在的值是<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">About</span></div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">id</span>，它現在沒有值</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"><span style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">而</span><span style="color: #454545;">Route</span><span style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的制定中，</span>**<span style="color: red;">controller<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">跟</span>action</span>**<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">**<span style="color: red;">為保留字</span>**<span style="color: #454545;">，意思是告訴他要執行哪個</span></span><span style="color: #454545;">controller</span><span style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">跟</span><span style="color: #454545;">Action</span><span style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，依據這邊的規定，所以它知道要去執行</span><span style="color: #454545;">Home</span><span style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">這個</span><span style="color: #454545;">Controller</span><span style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，裡面一個叫做</span><span style="color: #454545;">About</span><span style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的</span><span style="color: #454545;">Action</span></div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-lPmkR6MJKWs/Wq0NMR-XeJI/AAAAAAAAIlM/NuECRMJtFww8ve031wVUqj-dnCa6K4FQgCLcBGAs/s400/7.png)](https://3.bp.blogspot.com/-lPmkR6MJKWs/Wq0NMR-XeJI/AAAAAAAAIlM/NuECRMJtFww8ve031wVUqj-dnCa6K4FQgCLcBGAs/s1600/7.png)</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-size: 12px; font-stretch: normal; line-height: normal;">
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div class="note info">
            <p>在Controller裡面寫的方法我們稱之為Action，而他通常都會回傳ActionResult</p>
          </div>
<div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-stretch: normal; line-height: normal;">再讓我們看一個例子<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> </span>：<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> </span>[首頁]</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">首頁的網址為</span> : http://localhost:54004/</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-size: 12px; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-l2A_55syPtg/Wq0NzWKrZFI/AAAAAAAAIlg/NYnq1QMfQBUv9_fsyYczIqUSy4BW4ZHEQCLcBGAs/s400/8.png)](https://1.bp.blogspot.com/-l2A_55syPtg/Wq0NzWKrZFI/AAAAAAAAIlg/NYnq1QMfQBUv9_fsyYczIqUSy4BW4ZHEQCLcBGAs/s1600/8.png)</div>
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div class="note info">
            <p>網址最前面這段寫著 Localhost :54004 ，Localhost為網址的Domain，54004為Port，Domain是網站的位置，例如我們在google搜尋Facebook時，會看到網址變成<a href="https://www.google.com.tw/search?q=facebook%EF%BC%8C%E8%80%8Cwww.google.com.tw%E5%B0%B1%E6%98%AFDomain%EF%BC%8C%E7%95%B6%E8%AE%80%E5%88%B0%E9%80%99%E4%B8%B2Domain%E6%99%82%EF%BC%8C%E5%B0%B1%E6%9C%83%E9%80%8FDNS%E6%89%BE%E5%88%B0Google%E7%9A%84%E4%BC%BA%E6%9C%8D%E5%99%A8%EF%BC%8C%E7%84%B6%E5%BE%8C%E5%91%BC%E5%8F%AB%E5%AE%83%EF%BC%8C%E4%B8%A6%E4%B8%94%E8%AB%8B%E6%B1%82%E4%BB%96%E5%9F%B7%E8%A1%8C/search?q=facebook%EF%BC%8C%E9%80%99%E4%B9%9F%E6%98%AF%E7%82%BA%E4%BB%80%E9%BA%BC%E6%88%91%E5%80%91%E8%A8%8E%E8%AB%96Route%E6%99%82%E6%B2%92%E6%9C%89%E6%8A%8ADomain%E7%B4%8D%E9%80%B2%E4%BE%86%EF%BC%8CDomain%E5%8F%AA%E6%98%AF%E8%AE%93%E7%B6%B2%E8%B7%AF%E8%83%BD%E6%89%BE%E5%88%B0%E4%BD%A0%E6%9C%8D%E5%8B%99%E7%9A%84%E4%BC%BA%E6%9C%8D%E5%99%A8%E4%BD%8D%E7%BD%AE%EF%BC%8C%E5%BE%8C%E9%9D%A2%E6%89%8D%E6%98%AF%E4%BD%A0%E6%92%B0%E5%AF%AB%E7%A8%8B%E5%BC%8F%E8%A6%81%E8%99%95%E7%90%86%E7%9A%84Route%E7%B6%B2%E5%9D%80">https://www.google.com.tw/search?q=facebook，而www.google.com.tw就是Domain，當讀到這串Domain時，就會透DNS找到Google的伺服器，然後呼叫它，並且請求他執行/search?q=facebook，這也是為什麼我們討論Route時沒有把Domain納進來，Domain只是讓網路能找到你服務的伺服器位置，後面才是你撰寫程式要處理的Route網址</a></p>
          </div>
<div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">所以首頁網址等於<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> &nbsp;</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">首頁網址<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> </span>：<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> /</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route Url :&nbsp; {controller}/{action}/{id}</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">controller</span>，它現在沒有值</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">action</span>，它現在沒有值</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">id</span>，它現在沒有值</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">什麼都沒有，那程式到底要執行哪邊？<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> </span>這時候<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Default</span>終於派上用場了，<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Default</span>的意思就是，當沒有值時，請用我設定的值代替吧</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-size: 12px; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-TDgD-ND409Y/Wq0OX06AV7I/AAAAAAAAImc/CSNnXFgp6jkv3ajpzFLwlQuWyC8t7rBUgCEwYBhgL/s400/9.png)](https://1.bp.blogspot.com/-TDgD-ND409Y/Wq0OX06AV7I/AAAAAAAAImc/CSNnXFgp6jkv3ajpzFLwlQuWyC8t7rBUgCEwYBhgL/s1600/9.png)</div>
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">所以</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">controller<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">為空值，所以用</span>Default<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的值代替，所以它的值為</span>Home</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">action<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">為空值，所以用</span>Default<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的值代替，所以它的值為</span>Index</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">id<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">為空直，但</span>Default<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">設定它為</span>UrlParameter.Optional<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，意思是它是選擇性的，如果沒有沒關係</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">所以這個<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>設定又完美符合了，所以依據條件，我們去<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">HomeController</span>的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Index</span>下中斷點，試試看進入首頁時是不是會停在這邊</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-size: 12px; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-3I8rJaSlSzI/Wq0OT3PebrI/AAAAAAAAIlo/gtyIS1YVuD83WLbI_Fh1huvHCyqCFcwUgCEwYBhgL/s400/10.png)](https://2.bp.blogspot.com/-3I8rJaSlSzI/Wq0OT3PebrI/AAAAAAAAIlo/gtyIS1YVuD83WLbI_Fh1huvHCyqCFcwUgCEwYBhgL/s1600/10.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-koCX4c7IthY/Wq0OT1iZPOI/AAAAAAAAIls/8Crncjqy5b0piO1OdxXPkaPVzgxpD2pzwCEwYBhgL/s400/11.png)](https://3.bp.blogspot.com/-koCX4c7IthY/Wq0OT1iZPOI/AAAAAAAAIls/8Crncjqy5b0piO1OdxXPkaPVzgxpD2pzwCEwYBhgL/s1600/11.png)</div>

</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的確，他依據規則跑到了</span>HomeController<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的</span>Index Action<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">了。</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">那舉一反三一下，換句話說首頁網址也可以是<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> /Home/Index </span>摟，試試看，你會發現它的確走到一樣的中斷點</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-size: 12px; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-PGK33fEJg-Q/Wq0OT4Pa-7I/AAAAAAAAImo/_9AR8OUt1Iga3IytGl1LuqwTxbsmNeWkwCEwYBhgL/s400/12.png)](https://2.bp.blogspot.com/-PGK33fEJg-Q/Wq0OT4Pa-7I/AAAAAAAAImo/_9AR8OUt1Iga3IytGl1LuqwTxbsmNeWkwCEwYBhgL/s1600/12.png)</div>
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">你可能會說，那這樣<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>還有什麼好學的，這個寫法幾乎萬用了啊？<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> </span>的確在ＭＶＣ預設專案中的這個<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>設定我們通常稱它為萬用<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>，但也因為它幾乎萬用，所以不好管理，所以正常來說都還是會制定自己的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>規則，好方便管理，這個之後慢慢寫專案碰到多了會更有感觸。</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">接著我們來試著修改一下程式，讓我們的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">{id}</span>能派上用場吧！！</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">在剛剛的案例中，因為<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">id</span>設定是<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Optional</span>所以都沒派上用場，來試試看他怎麼用吧，首先我們先在<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">HomeController</span>的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">About Action</span>中加入參數<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">id</span>，並且把回傳的訊息改成<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Your id is </span>(你帶進來的值)</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.PingFang TC&quot;; font-size: 12px; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-FLI7MLnnMfw/Wq0OUuGGE3I/AAAAAAAAImk/nXWFNqHfTN8NUtq0rDJzxIB1jou_4DAdwCEwYBhgL/s400/13.png)](https://3.bp.blogspot.com/-FLI7MLnnMfw/Wq0OUuGGE3I/AAAAAAAAImk/nXWFNqHfTN8NUtq0rDJzxIB1jou_4DAdwCEwYBhgL/s1600/13.png)</div>
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;Helvetica Neue&quot;; font-size: 12px; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">接著我們重新執行一次程式，並且把網址改成<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">/Home/About/Steven</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-Zks5ZE30New/Wq0OUxoT8HI/AAAAAAAAIms/WxfowIPPItUnVcXErJ1H2FQPfHTWr58RgCEwYBhgL/s400/14.png)](https://2.bp.blogspot.com/-Zks5ZE30New/Wq0OUxoT8HI/AAAAAAAAIms/WxfowIPPItUnVcXErJ1H2FQPfHTWr58RgCEwYBhgL/s1600/14.png)</div>
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">再練習一次<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>比對</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">controller</span>，它現在的值是<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Home</span></div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">action</span>，它現在的值是<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">About</span></div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">我們有一個變數叫做<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">id</span>，它現在的值是<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Steven</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">讓接著看中斷點，把滑鼠移到<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">id</span>那的參數會看到，<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Id</span>依據我們下的網址，以<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Steven</span>帶進來了</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-h6ZLvBxZDRE/Wq0OVDhncjI/AAAAAAAAImo/IL83Kj55bx4EQb6yZg5uz7jkxi9Poyq1QCEwYBhgL/s400/15.png)](https://3.bp.blogspot.com/-h6ZLvBxZDRE/Wq0OVDhncjI/AAAAAAAAImo/IL83Kj55bx4EQb6yZg5uz7jkxi9Poyq1QCEwYBhgL/s1600/15.png)</div>
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">接著看網頁呈現的成果</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-4scpot89dZU/Wq0OVopL--I/AAAAAAAAImg/sdGZ1pxWLIMBO-ftiDpWhDA3l2f1tz7XwCEwYBhgL/s400/16.png)](https://3.bp.blogspot.com/-4scpot89dZU/Wq0OVopL--I/AAAAAAAAImg/sdGZ1pxWLIMBO-ftiDpWhDA3l2f1tz7XwCEwYBhgL/s1600/16.png)</div>
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal; margin-bottom: 2px;">

<h3 id="練習制定一個屬於我們的Route"><a href="#練習制定一個屬於我們的Route" class="headerlink" title="練習制定一個屬於我們的Route"></a>練習制定一個屬於我們的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"><strong>Route</strong></span></h3></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">看了兩個範例，我們也來制定一個<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>規則給自己用吧，而且我們不要用變數的方式。</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-cOBHu8_QRGw/Wq0OV84UZ2I/AAAAAAAAImo/GhiHQFpeFGkvHHlIju0NPcUDtmSpF9OmQCEwYBhgL/s400/17.png)](https://3.bp.blogspot.com/-cOBHu8_QRGw/Wq0OV84UZ2I/AAAAAAAAImo/GhiHQFpeFGkvHHlIju0NPcUDtmSpF9OmQCEwYBhgL/s1600/17.png)</div>
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">我們希望有個網址為<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">/tellMe/whoAreYou/{name}</span>，且<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">name</span>跟之前的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">id</span>一樣是個變數，可以由你自己打喜歡的文字來決定，寫完後來試試看這個<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">route</span>可不可行</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-DviuNDcFiHg/Wq0OWIgZMfI/AAAAAAAAImk/uDokBOMNij0mSGMLcLZsxjp63J7qOdKDwCEwYBhgL/s400/18.png)](https://1.bp.blogspot.com/-DviuNDcFiHg/Wq0OWIgZMfI/AAAAAAAAImk/uDokBOMNij0mSGMLcLZsxjp63J7qOdKDwCEwYBhgL/s1600/18.png)</div>
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">結果竟然錯了，來看看少了什麼</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">網址</span> <span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">：</span> /tellMe/whoAreYou/steven</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route Url :&nbsp; /tellMe/whoAreYou/{name}</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">比對</span>tellMe<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，符合</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">比對</span>whoAreYou<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，符合</span></div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">比對<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Name</span>這個變數，現在的值為<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Steven</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">然後呢？<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> </span>有沒有發現即便這邊都比對正確，符合<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">route</span>規則，但我們沒告訴他<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Controller</span>是誰，<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Action</span>是誰，程式當然不知道該去執行誰，所以再來改一下，因為我們還沒學到如何建立<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Controller</span>跟<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Action</span>，所以先用現成的，<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> </span>導到<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">homeController</span>的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Contact</span>吧</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-qH5gM8_e5zA/Wq0OWghkjZI/AAAAAAAAImo/3gENq49UAPUaqw-ybuBoWEy2tlBNdeM6wCEwYBhgL/s400/19.png)](https://1.bp.blogspot.com/-qH5gM8_e5zA/Wq0OWghkjZI/AAAAAAAAImo/3gENq49UAPUaqw-ybuBoWEy2tlBNdeM6wCEwYBhgL/s1600/19.png)</div>
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-dSlvDEn3NLw/Wq0OW9IOoBI/AAAAAAAAIms/uPwgRJ_nwzkB6qAltJkNWfcSZGUu6h44wCEwYBhgL/s400/20.png)](https://2.bp.blogspot.com/-dSlvDEn3NLw/Wq0OW9IOoBI/AAAAAAAAIms/uPwgRJ_nwzkB6qAltJkNWfcSZGUu6h44wCEwYBhgL/s1600/20.png)</div>
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">讓我們再試試看剛剛的網址</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-Pm-1-hAQ2Xc/Wq0OXEQrCpI/AAAAAAAAImo/7jBfE4xT3w8Y4QRu_iDmqrxtYcEk-8AgACEwYBhgL/s400/21.png)](https://1.bp.blogspot.com/-Pm-1-hAQ2Xc/Wq0OXEQrCpI/AAAAAAAAImo/7jBfE4xT3w8Y4QRu_iDmqrxtYcEk-8AgACEwYBhgL/s1600/21.png)</div>
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">這次不會壞掉了，且正確的導到</span>HomeController<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的</span>Contact Action<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">去，接著試試不帶</span>{Name}<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">會怎麼樣</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;"><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-qulCDWyyTIs/Wq0OXeD8fFI/AAAAAAAAIms/3CVn_ntnPms8AvxipLFd34dYGInhrSN_wCEwYBhgL/s400/22.png)](https://2.bp.blogspot.com/-qulCDWyyTIs/Wq0OXeD8fFI/AAAAAAAAIms/3CVn_ntnPms8AvxipLFd34dYGInhrSN_wCEwYBhgL/s1600/22.png)</div>
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">變成找不到資源，為什麼？因為我們的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Name</span>沒有設定為<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">UrlParameter.Optional</span>，所以是必帶的參數，這邊要特別注意！！！<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"> </span>之前教很多新人<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>時很多人都卡在這邊</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal; margin-bottom: 2px;"><span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">**Route**</span>比對時必須完全符合才會被捕捉到</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-stretch: normal; line-height: normal;"><div style="font-family: &quot;.pingfang tc&quot;;">所以回頭審視我們的<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>註冊目前有兩個規則</div><div style="font-family: &quot;.pingfang tc&quot;;"><span style="font-family: &quot;helvetica neue&quot;;">
</span></div><span style="font-family: &quot;pingfang tc&quot;;">1.&nbsp;</span><span style="font-family: &quot;helvetica neue&quot;;">tellMe/whoAreYou/{name}</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">2\. {controller}/{action}/{id}</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">而我們帶的網址為</span> /tellMe/whoAreYou <span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，比對的規則將會是</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">

</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">由上到下，所以先比對了</span> 1\. **tellMe/whoAreYou/{name}** <span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的規則</span>&nbsp;</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">tellMe<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，符合</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">whoAreYou<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，符合</span></div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>要求要有<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Name</span>，且不是<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Optional</span>，所以必帶，”不符合”</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">
</span><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">這段</span>Route<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">會被跳過，執行比對</span>2\. **{controller}/{action}/{id}&nbsp;**<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的規則</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Controller<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">為</span>tellMe<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，符合</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Action<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">為</span>WhoAreYou<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，符合</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Id<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">為空值，因為為</span>Optional<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，符合</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">

</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;"><span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">所以實際程式去找的是</span>TellMeController<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">裡面的</span>WhoAreYou<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">這個</span>Action<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">，因為找不到這支程式所以顯示錯誤，而不是去執行規則</span>1.<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的</span> HomeController<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">的</span>Contact<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">這個</span>Action<span style="font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">。</span></div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal; min-height: 14px;">
</div><div style="color: #454545; font-family: &quot;.pingfang tc&quot;; font-stretch: normal; line-height: normal;">這是新手常常會犯的觀念錯誤，所以特別舉這個例子希望能夠較清楚的比較跟釐清，而<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">Route</span>因為還有很多種設定，避免一次太多造成混亂，所以先到這邊。試著將上述的觀念釐清，對於之後撰寫<span style="font-family: &quot;helvetica neue&quot;; font-stretch: normal; line-height: normal;">MVC Route</span>時會很有幫助</div></div><div>
</div><div>
</div>]]></content>
      <categories>
        <category>學習MVC</category>
      </categories>
      <tags>
        <tag>MVC教學</tag>
      </tags>
  </entry>
</search>
