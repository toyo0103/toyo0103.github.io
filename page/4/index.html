<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"toyo0103.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="程式隨筆">
<meta property="og:url" content="https://toyo0103.github.io/page/4/index.html">
<meta property="og:site_name" content="程式隨筆">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Toyo">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://toyo0103.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>程式隨筆</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程式隨筆" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程式隨筆</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/02/12/anycpu_x86_x64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/12/anycpu_x86_x64/" class="post-title-link" itemprop="url">將程式編譯成 x86、x64、Any CPU差別在哪</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-02-12 11:09:00" itemprop="dateCreated datePublished" datetime="2019-02-12T11:09:00+08:00">2019-02-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/02/12/anycpu_x86_x64/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/12/anycpu_x86_x64/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>相信用過 Visual Studio 的應該都注意過編譯時可以選擇 Any CPU、x86、x64 (x86、x64 需要編輯組態檔才會看的到)</p>
<p><img src="/images/20190212/1.png" alt="/images/20190212/1.png"></p>
<p>這次踩到問題是，明明程式用 Any CPU 來編譯，但在 64 bit OS 上卻會用 32 bit  Process 來執行</p>
<p><img src="/images/20190212/2.png" alt="/images/20190212/2.png"></p>
<p>原來是因為專案建置的屬性勾到了 <code>建議使用32位元</code>的選項導致</p>
<p><img src="/images/20190212/3.png" alt="/images/20190212/3.png"></p>
<p>解決的同時也引起了對於編譯成 x86、x64、Any CPU 有什麼差別的好奇心，找了文章後整理如下</p>
<br>

<h1 id="差異"><a href="#差異" class="headerlink" title="差異"></a>差異</h1><br>

<h2 id="在-32-bit-OS-上執行"><a href="#在-32-bit-OS-上執行" class="headerlink" title="在 32 bit OS 上執行"></a>在 32 bit OS 上執行</h2><p><strong>Any CPU</strong> : 會用 32 bit Process 來執行，可以載入 Any CPU 和 x86 方式編譯的組件，但如果載入 x64 編譯的組件將會引發 BadImageFormatException </p>
<p><strong>Any CPU (勾選建議使用32位元)</strong> : 運作方式同上</p>
<p><strong>x86</strong> : 運作方式同上</p>
<p><strong>x64</strong> : 引發 BadImageFormatException</p>
<br>

<h2 id="在-64-bit-OS-上執行"><a href="#在-64-bit-OS-上執行" class="headerlink" title="在 64 bit OS 上執行"></a>在 64 bit OS 上執行</h2><p><strong>Any CPU</strong> : 會用 64 bit Process 來執行，可以載入 Any CPU 和 x64 方式編譯的組件，但如果載入 x86 編譯的組件將會引發 BadImageFormatException</p>
<p><strong>Any CPU (勾選建議使用32位元)</strong> : 會用 32 bit Process 來執行，可以載入 Any CPU 和 <code>x86</code> 方式編譯的組件，但如果載入 x64 編譯的組件將會引發 BadImageFormatException</p>
<p><strong>x86</strong> : 運作方式同 <strong>Any CPU (勾選建議使用32位元)</strong></p>
<p><strong>x64</strong> : 運作方式同 <strong>Any CPU</strong>  </p>
<br>

<h2 id="Machine-Config"><a href="#Machine-Config" class="headerlink" title="Machine Config"></a>Machine Config</h2><p>依據執行的 Process 位元決定</p>
<p>32 bit Process 吃的 Machine Config 位置 : C:\Windows\Microsoft.NET\ <code>Framework</code> \v4.0.30319\Config</p>
<p>64 bit Process 吃的 Machine Config 位置 : C:\Windows\Microsoft.NET\ <code>Framework64</code> \v4.0.30319\Config</p>
<br>

<h1 id="怎麼查是用哪種方式編譯的"><a href="#怎麼查是用哪種方式編譯的" class="headerlink" title="怎麼查是用哪種方式編譯的?"></a>怎麼查是用哪種方式編譯的?</h1><p>可以透過 <code>CorFlags.exe</code> 的工具來查詢，該程式放在 <code>C:\Program Files (x86)\Microsoft SDKs\Windows\v8.1A\bin\NETFX 4.5.1 Tools</code> 路徑底下，設定為環境變數後就可以用 command 來檢視 PE </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ corflags yourPE.exe</span><br></pre></td></tr></table></figure>

<div class="note info">
            <p>PE : Process Executables (EXEs and DLLs)</p>
          </div>

<p><img src="/images/20190212/4.png" alt="/images/20190212/4.png"></p>
<p>意義如下</p>
<p><img src="/images/20190212/5.png" alt="/images/20190212/5.png"></p>
<p>(圖片節錄至 : <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/18608785/how-to-interpret-the-corflags-flags/23614024#23614024">https://stackoverflow.com/questions/18608785/how-to-interpret-the-corflags-flags/23614024#23614024</a>)</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://blog.darkthread.net/blog/corflags/">【茶包射手日記】檢查.NET程式平台目標(Platform Target)</a></p><p><a target="_blank" rel="noopener" href="https://www.codeproject.com/Articles/1160645/Dealing-with-bit-bit-and-Any-CPU-Compilation-Optio">Dealing with 32-bit, 64-bit and Any CPU Compilation Options in .NET</a></p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/18608785/how-to-interpret-the-corflags-flags">How to interpret the CorFlags flags?</a></p>
          </div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2018/12/21/%E3%80%90C-%E3%80%91yield_retuen/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/21/%E3%80%90C-%E3%80%91yield_retuen/" class="post-title-link" itemprop="url">【C#】Yield Return與迭代器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-21 13:54:00" itemprop="dateCreated datePublished" datetime="2018-12-21T13:54:00+08:00">2018-12-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/12/21/%E3%80%90C-%E3%80%91yield_retuen/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/12/21/【C-】yield_retuen/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="什麼是-Yield"><a href="#什麼是-Yield" class="headerlink" title="什麼是 Yield"></a>什麼是 Yield</h1><p>Yield 就是 .Net 中用來實作 iterator(迭代器) 設計模式的語法糖，雖然很早就知道這東西，但一直都不太知道怎麼用，剛好最近同事在翻寫寄送大量信件的程式有用到就跟他請教了一下。</p>
<p><strong>以前的做法</strong></p>
<p>將收件人從 DB 撈出來後 ，依據每封信的 Template 去置換內容，再批次送去給寄信服務執行</p>
<p><strong>問題</strong></p>
<p>如果這批收件人很多，把整批的信件都置換完 Template 再送出，會導致系統吃掉大量的記憶。當然最簡單的解決方法就是用迴圈組完一筆就送出一次，但其實用 Yield Return 可以更優雅的解決這個問題</p>
<h1 id="範例"><a href="#範例" class="headerlink" title="範例"></a>範例</h1><p>同事提供了簡單的範例來理解這件事情</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> mail <span class="keyword">in</span> <span class="title">GetData</span>(<span class="params"></span>))</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		Console.WriteLine(<span class="string">$&quot;- Received: <span class="subst">&#123;mail.Title&#125;</span>&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> List&lt;Mail&gt; <span class="title">GetData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> mailList = <span class="keyword">new</span> List&lt;Mail&gt;();</span><br><span class="line">	<span class="built_in">int</span> buffer_size = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">4</span>;  <span class="comment">// 4MB</span></span><br><span class="line">	Random _rnd = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>; index &lt; <span class="number">1024</span>; index++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">var</span> _buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[buffer_size];</span><br><span class="line">		_rnd.NextBytes(_buffer);</span><br><span class="line"></span><br><span class="line">		mailList.Add(<span class="keyword">new</span> Mail()</span><br><span class="line">		&#123;</span><br><span class="line">			Title = <span class="string">$&quot;buffer[<span class="subst">&#123;index&#125;</span>], <span class="subst">&#123;buffer_size / <span class="number">1024</span> / <span class="number">1024</span>&#125;</span> MB&quot;</span>,</span><br><span class="line">			Buffer = _buffer,</span><br><span class="line">		&#125;);</span><br><span class="line">		Task.Delay(<span class="number">50</span>).Wait();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> mailList;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mail</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">byte</span>[] Buffer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code> GetData()</code> 這是模擬處理信件的地方，每封信件假設 4MB (到底是寄啥…)，整批處理完後回傳 mailList </p>
<p>如果把這段 Code 放到 LINQPad 執行，會發現記憶體一直往上飆，因為會全部都做完放到 List 再回傳並寄信</p>
<p><img src="/images/20181221/1.gif" alt="/images/20181221/1.gif"></p>
<h2 id="Yield-Return-版本"><a href="#Yield-Return-版本" class="headerlink" title="Yield Return 版本"></a>Yield Return 版本</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="function"><span class="keyword">var</span> mail <span class="keyword">in</span> <span class="title">GetData</span>(<span class="params"></span>))</span></span><br><span class="line"><span class="function"></span>	&#123;</span><br><span class="line">		Console.WriteLine(<span class="string">$&quot;- Received: <span class="subst">&#123;mail.Title&#125;</span>&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> IEnumerable&lt;Mail&gt; <span class="title">GetData</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">int</span> buffer_size = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">4</span>;  <span class="comment">// 4MB</span></span><br><span class="line">	Random _rnd = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> index = <span class="number">0</span>; index &lt; <span class="number">1024</span>; index++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">var</span> _buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[buffer_size];</span><br><span class="line">		_rnd.NextBytes(_buffer);</span><br><span class="line"></span><br><span class="line">	    <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">Mail</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>		&#123;</span><br><span class="line">			Title = <span class="string">$&quot;buffer[<span class="subst">&#123;index&#125;</span>], <span class="subst">&#123;buffer_size / <span class="number">1024</span> / <span class="number">1024</span>&#125;</span> MB&quot;</span>,</span><br><span class="line">			Buffer = _buffer,</span><br><span class="line">		&#125;;</span><br><span class="line">		Task.Delay(<span class="number">50</span>).Wait();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Mail</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">string</span> Title &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">	<span class="keyword">public</span> <span class="built_in">byte</span>[] Buffer &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>觀察記憶體會發現非常的平穩，因為逐筆處理完就被消滅掉了</p>
<p><img src="/images/20181221/2.gif" alt="/images/20181221/2.gif"></p>
<h1 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h1><p>至於如果不用語法糖 Yield 該如何實作迭代器，可參考安德魯的部落格裡面介紹非常詳細，希望這個方法以後可以更融會貫通的套在專案中使用</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://columns.chicken-house.net/2008/09/18/c-yield-return-1-how-it-work/">安德魯的部落格 - [C#: yield return] #1. How It Work ?</a></p><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E8%BF%AD%E4%BB%A3%E5%99%A8">Wiki - 迭代器</a></p>
          </div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2018/12/03/Task_WaitAll/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/12/03/Task_WaitAll/" class="post-title-link" itemprop="url">【C#】Task WaitAll</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-12-03 15:53:00" itemprop="dateCreated datePublished" datetime="2018-12-03T15:53:00+08:00">2018-12-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/12/03/Task_WaitAll/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/12/03/Task_WaitAll/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>假設有一項任務，執行時會做三件事情，而這三件事情彼此並沒有相依關係，傳統程式寫法通常都是 1  &gt;  2  &gt; 3 依序呼叫下去做，但這樣有一個問題就是，假設 1 這個任務要執行特別久，那 2、3 都得等 1 做完才能執行到，整體來說效率並沒有最佳化。</p>
<p><img src="/images/20181203/1.png" alt="/images/20181203/1.png"></p>
<p>跑一次需要 2.012 秒完成，如果需要重複 10 次 、100 次，那所需時間會相當可觀。 </p>
<h1 id="非同步版本"><a href="#非同步版本" class="headerlink" title="非同步版本"></a>非同步版本</h1><p>改成非同步版本後，它執行順序就不會被第一步給拖累，三個工作是併行處理</p>
<p><img src="/images/20181203/2.png" alt="/images/20181203/2.png"></p>
<p>但這會有一個問題，如果程式是 Run 在 Console Application 中，因為沒有等待非同步的程式都執行完，就已經跑到 Done ，而導致 Console Application 被關掉，其相應的 Process 也會被停掉，導致有些工作沒有執行完，所以必須要確保所有程式都執行完才關閉的機制在。</p>
<p><img src="/images/20181203/3.png" alt="/images/20181203/3.png"></p>
<h1 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a>參考文章</h1><ol>
<li><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/dotnet/standard/parallel-programming/task-based-asynchronous-programming">MSDN : 以工作為基礎的非同步程式設計</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2018/11/21/%E3%80%90%E6%97%A5%E6%96%87%E3%80%91%E3%81%8B_%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/21/%E3%80%90%E6%97%A5%E6%96%87%E3%80%91%E3%81%8B_%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B/" class="post-title-link" itemprop="url">【日文】か、かどうか 如何使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-21 15:52:00" itemprop="dateCreated datePublished" datetime="2018-11-21T15:52:00+08:00">2018-11-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/11/21/%E3%80%90%E6%97%A5%E6%96%87%E3%80%91%E3%81%8B_%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/21/【日文】か_かどうか/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>日文中的疑問子句</p>
<p><strong>普通型 + かどうか + 子句</strong></p>
<ol>
<li><p>このカメラは日本で買ったかどうか、わからない<br>這個相機是不是在日本買的,我不知道</p>
</li>
<li><p>先生が上手に歌えるかどうか、わからない<br>老師唱歌拿不拿手,我不知道</p>
</li>
</ol>
<p><strong>(前面出現疑問詞)+普通型 + か + 子句</strong></p>
<ol>
<li><p>このカメラは誰のか、わからない<br>這個相機是誰的,我並不知道</p>
</li>
<li><p>いつ日本へ行くか、知っていますか<br>何時要去日本,你知道嗎？</p>
</li>
</ol>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://www.facebook.com/wangcolaneko/posts/%E3%81%8B%E3%81%A9%E3%81%86%E3%81%8B%E8%B7%9F%E3%81%8B%E5%BF%AB%E9%80%9F%E8%A7%A3%E9%A1%8C%E6%B3%95%E6%9C%AC%E6%95%99%E5%AD%B8%E7%82%BA-%E9%9B%B2%E7%AB%AF%E8%AA%B2%E7%A8%8B%E5%88%9D%E7%B4%9A%E2%85%A3n3%E4%B8%AD%E7%B4%9A%E7%AF%80%E9%8C%84%E6%97%A5%E6%96%87%E5%8F%A5%E4%B8%AD%E5%B8%B8%E6%9C%83%E7%9C%8B%E5%88%B0%E4%BB%8A%E4%BD%95%E6%99%82%E3%81%8B%E3%82%8F%E3%81%8B%E3%82%8A%E3%81%BE%E3%81%9B%E3%82%93%E4%BB%8A%E6%97%A5%E3%81%AF%E4%BD%95%E6%9B%9C%E6%97%A5%E3%81%8B%E6%95%99%E3%81%88%E3%81%A6%E3%81%8F%E3%81%A0%E3%81%95%E3%81%84%E7%9A%84%E9%96%93%E6%8E%A5%E5%95%8F%E5%8F%A5%E6%89%80%E8%AC%82%E7%9A%84%E5%95%8F%E5%8F%A5%E6%8C%87%E7%9A%84%E6%98%AF%E7%96%91%E5%95%8F%E8%A9%9E%E3%81%8B%E7%9A%84%E5%8F%A5/1624497210915932/">王可樂的日文教室【「かどうか」跟「か」快速解題法！】</a></p><p><a target="_blank" rel="noopener" href="http://www2.nkfust.edu.tw/~jwd/playgrammar/1know/page2_10.htm">間接句型的用法</a></p>
          </div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2018/11/14/MissingMethodException/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/11/14/MissingMethodException/" class="post-title-link" itemprop="url">MissingMethodException</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-14 17:04:00" itemprop="dateCreated datePublished" datetime="2018-11-14T17:04:00+08:00">2018-11-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/11/14/MissingMethodException/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/14/MissingMethodException/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>寫單元測試的時候編譯都沒問題，但在執行時一直報錯 <strong>System.MissingMethodException</strong> 的錯誤，查了一下發現跟 <code>System.Net.Http</code> 有關</p>
<div class="note info">
            <p>System.MissingMethodException with message</p><p>“Method not found: ‘System.Web.Http.Results.ResponseMessageResult</p><p>System.Web.Http.ApiController.ResponseMessage(System.Net.Http.HttpResponseMessage)”</p>
          </div>



<p>檢查測試專案與受測專案的 <code>System.Net.Http</code> Nuget套件皆為同一個版本</p>
<p><img src="/images/20181114/1.png" alt="/images/20181114/1.png"></p>
<p>但意外發現兩個專案的 <code>System.Net.Http</code> 參考卻為不同位置</p>
<p><img src="/images/20181114/2.png" alt="/images/20181114/2.png"></p>
<p><img src="/images/20181114/3.png" alt="/images/20181114/3.png"></p>
<p>照理來說應該都要參考到專案內的 packages 底下才對，檢查 <code>.csproj</code> 裡面的 Reference 並沒有寫錯</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Reference</span> <span class="attr">Include</span>=<span class="string">&quot;System.Net.Http, Version=4.1.1.1, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a, processorArchitecture=MSIL&quot;</span>&gt;</span> 		  </span><br><span class="line"><span class="tag">&lt;<span class="name">HintPath</span>&gt;</span>..\..\packages\System.Net.Http.4.3.2\lib\net46\System.Net.Http.dll<span class="tag">&lt;/<span class="name">HintPath</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Reference</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>在網路上也搜尋到相關文章討論似乎是 Visual Studio Bug 導致</p>
<p><img src="/images/20181114/4.png" alt="/images/20181114/4.png"></p>
<p>這位仁兄也碰到一樣問題</p>
<ol>
<li><p>他開啟了一個新專案</p>
</li>
<li><p>Nuget 安裝 System.Net.Http v4.3.3 </p>
</li>
<li><p>建置時 System.Net.Http 參考都還是來自於 Package 資料夾底下</p>
</li>
<li><p>Nuget 安裝 System.Collections.Immutable v1.4.0 </p>
</li>
<li><p>建置時 System.Net.Http 參考就跑到 C:\Program Files (x86)\Microsoft Visual Studio\2017\Enterprise\MSBuild\Microsoft\Microsoft.NET.Build.Extensions\net461\lib\System.Net.Http.dll 底下</p>
</li>
</ol>
<div class="note info">
            <p>討論串</p><p><a target="_blank" rel="noopener" href="https://github.com/dotnet/corefx/issues/25773">System.Net.Http v4.2.0.0 being copied/loaded from MSBuild tooling</a></p>
          </div>



<h1 id="解決方法"><a href="#解決方法" class="headerlink" title="解決方法"></a>解決方法</h1><p>檢查 Microsoft.NET.Build.Extensions 資料夾底下的 dll 版本為 <code>4.2.0.0</code> ，而 Nuget  System.Net.Http 4.3.2 的 dll 版本則為 <code>4.1.1.1</code> ，這也是間接導致發生此錯誤的原因。</p>
<p>但 Reference HintPath也沒寫錯，VS 裡面也沒辦法調整 dll 位置 ， 最後索性直接刪除 Microsoft.NET.Build.Extensions 資料夾底下的 System.Net.Http ，重新建置後 dll 就重新指向 Package了，此問題得到解決</p>
<p>世界又再一次恢復了和平，!@#$%</p>
<h1 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a>參考文章</h1><ol>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/46451247/missing-method-in-system-web-http-apicontroller-get-request">MIssing method in System.Web.Http.ApiController.get_Request()</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/dotnet/corefx/issues/22781">System.Net.Http package 4.3.2 - redirect to 4.2.0.0, assembly loading failure</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2018/10/31/%E3%80%90%E8%8B%B1%E6%96%87%E3%80%91About%20time/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/31/%E3%80%90%E8%8B%B1%E6%96%87%E3%80%91About%20time/" class="post-title-link" itemprop="url">【英文】About time</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-31 22:49:00" itemprop="dateCreated datePublished" datetime="2018-10-31T22:49:00+08:00">2018-10-31</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/10/31/%E3%80%90%E8%8B%B1%E6%96%87%E3%80%91About%20time/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/31/【英文】About time/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>這篇是要記錄關於一些時間的用法</p>
<h1 id="On-time"><a href="#On-time" class="headerlink" title="On time"></a>On time</h1><p>『片語』 準時; 準點</p>
<p>例句 ：</p>
<blockquote>
<p>The train is always on time.</p>
<p>這班火車總是非常準時</p>
</blockquote>
<blockquote>
<p>Ruth  never  arrives office on time.</p>
<p>魯斯總是沒有準時到公司</p>
</blockquote>
<h1 id="In-time"><a href="#In-time" class="headerlink" title="In time"></a>In time</h1><p>『片語』 即時;最後</p>
<p>例句 ：</p>
<blockquote>
<p>I arrived at the office in time for the meeting.</p>
<p>我及時趕上了公司的會議</p>
</blockquote>
<blockquote>
<p>I finished the test in time</p>
<p>我在最後一秒完成考試</p>
</blockquote>
<h1 id="Time-off"><a href="#Time-off" class="headerlink" title="Time off"></a>Time off</h1><p>『片語』 請假;休假</p>
<p>例句 ：</p>
<blockquote>
<p>I have some time off in July, so I’m going to the beach.</p>
<p>我在7月有一些假日，所以我應該會去海邊</p>
</blockquote>
<blockquote>
<p>I can’t take time off to go to Iceland</p>
<p>我不能請假去冰島</p>
</blockquote>
<h1 id="Time-out"><a href="#Time-out" class="headerlink" title="Time out"></a>Time out</h1><p>『片語』 暫停;休息時間</p>
<p>例句 ：</p>
<blockquote>
<p>I need to take some time out( time off ). I’ve been very stressed at work recently.</p>
<p>我需要一些休息時間.最近工作壓力太大</p>
</blockquote>
<h1 id="About-time"><a href="#About-time" class="headerlink" title="About time"></a>About time</h1><p>『片語』 是時候了</p>
<p>例句 ：</p>
<blockquote>
<p>It’s about time to go to Iceland.</p>
<p>是時候該去冰島了</p>
</blockquote>
<h1 id="Spend-time"><a href="#Spend-time" class="headerlink" title="Spend time"></a>Spend time</h1><p>花時間</p>
<p>例句 : </p>
<blockquote>
<p>I’m going to spend some time with my grandmother at the weekend.</p>
<p>我這週末會花些時間陪祖母</p>
</blockquote>
<h1 id="Kill-time"><a href="#Kill-time" class="headerlink" title="Kill time"></a>Kill time</h1><p>殺時間</p>
<p>例句：</p>
<blockquote>
<p>I love to kill time in the afternoon by reading a good book.</p>
<p>我喜歡花整個下午的時間讀本好書</p>
</blockquote>
<h1 id="Waste-time"><a href="#Waste-time" class="headerlink" title="Waste time"></a>Waste time</h1><p>浪費時間</p>
<p>例句 : </p>
<blockquote>
<p>I waste so much time using the internet on my phone.</p>
<p>我浪費很多時間在用手機上網</p>
</blockquote>
<h1 id="Pressed-for-time"><a href="#Pressed-for-time" class="headerlink" title="Pressed for time"></a>Pressed for time</h1><p>『片語』 時間緊迫</p>
<p>例句 ：</p>
<blockquote>
<p>Sorry, I can’t talk at the moment, I’m a bit pressed for time.</p>
<p>抱歉, 我現在無法說話, 因為我時間有點緊迫</p>
</blockquote>
<h1 id="Save-time"><a href="#Save-time" class="headerlink" title="Save time"></a>Save time</h1><p>『片語』 節省時間</p>
<p>例句 ：</p>
<blockquote>
<p>You can save time by using an electronic dictionary.</p>
<p>用電子辭典可以替你省下很多時間</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2018/10/24/%E3%80%90%E8%8B%B1%E6%96%87%E3%80%91Down%20the%20line/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/24/%E3%80%90%E8%8B%B1%E6%96%87%E3%80%91Down%20the%20line/" class="post-title-link" itemprop="url">【英文】Down the line</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-24 15:45:00" itemprop="dateCreated datePublished" datetime="2018-10-24T15:45:00+08:00">2018-10-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/10/24/%E3%80%90%E8%8B%B1%E6%96%87%E3%80%91Down%20the%20line/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/24/【英文】Down the line/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>幾天前聽強者我同事上課提到寫部落格跟筆記的重要，想一想的確自己這樣斷斷續續也寫了 5~6 年左右，漸漸也陷入了一種迷失之中</p>
<blockquote>
<p>這篇的內容隨便google就有答案了還需要寫嗎？</p>
</blockquote>
<p>但忘了最初寫部落格的初衷不是為了給誰看，而是想記錄遇到的難題跟解決的方法，幫助自己能快速查找並系統的學習解。<del>我的部落格其實也沒啥人看，不知道有啥好包袱的</del></p>
<p>重點一直都不在有沒有人想看，而是我從中又學到了什麼，所以打算來寫幾篇會長期更新的學習筆記，可能包含 AWS、英文、日文..等。希望幾年後，這些會成為自己的能量與成長的基石。</p>
<h1 id="Down-the-line"><a href="#Down-the-line" class="headerlink" title="Down the line"></a>Down the line</h1><h4 id="未來"><a href="#未來" class="headerlink" title="未來"></a>未來</h4><p>從字面解釋就是「沿著線往下」，有<code>過段時間</code>、<code>未來</code>的意思，</p>
<p>例句 ：</p>
<blockquote>
<p>Pick one OS for your production set-up. No need to get master of every OS out there. It would make your job diffcult down the line.</p>
<p>選一種 OS 做為你生產的設置，你不需要精通每一種 OS ，這只會讓你之後的工作變得困難。</p>
</blockquote>
<blockquote>
<p>If you don’t learn English now , you will get many problems down the line.</p>
<p>如果你現在不學習英文, 那你將來會碰到許多問題的</p>
</blockquote>
<h4 id="徹底、始終"><a href="#徹底、始終" class="headerlink" title="徹底、始終"></a>徹底、始終</h4><p>例句 ：</p>
<blockquote>
<p>Errors are to be found down the line.</p>
<p>錯誤總有一天會被找到的</p>
</blockquote>
<blockquote>
<p>If something should be yours , that will be yours down the line.</p>
<p>屬於你的,終究會是你的</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2018/10/11/AWS_Lambda_Chrome_HeadLess/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/10/11/AWS_Lambda_Chrome_HeadLess/" class="post-title-link" itemprop="url">【.Net Core】AWS Lambda + Chrome Headless + Snapshot</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-10-11 17:58:00" itemprop="dateCreated datePublished" datetime="2018-10-11T17:58:00+08:00">2018-10-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/10/11/AWS_Lambda_Chrome_HeadLess/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/11/AWS_Lambda_Chrome_HeadLess/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div class="note danger">
            <p><strong>2018-10-25 更新</strong> :DotNet Core 版本已經找出解決方案了，更新在最下面</p><p><strong>注意 !!</strong> </p><p><del>這篇的結論是 <code>DotNet Core + Selenium + Chrome headless  + AWS Lambda</code>  執行是失敗的，所以如果不想看失敗案例的可以直接跳過了，寫下來是因為過程踩了太多雷想記錄一下</del> ，如果想要簡單一點的作法，建議採用  <code>NodeJs + Chrome Headless + AWS Lambda</code>  的解決方案，幾乎不用什麼調整即可使用。</p><p><a target="_blank" rel="noopener" href="https://github.com/adieuadieu/serverless-chrome">NodeJs 版本參考: adieuadieu/serverless-chrome</a></p>
          </div>



<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>近期公司希望將訂單快照從 <a target="_blank" rel="noopener" href="http://phantomjs.org/">PhantomJS</a> 改成 Chrome Headless 來實作，然後放到 <a target="_blank" rel="noopener" href="https://aws.amazon.com/cn/lambda/?sc_channel=PS&sc_campaign=acquisition_TW&sc_publisher=google&sc_medium=lambda_b&sc_content=lambda_e&sc_detail=aws%20lambda&sc_category=lambda&sc_segment=165241565701&sc_matchtype=e&sc_country=TW&s_kwcid=AL!4422!3!165241565701!e!!g!!aws%20lambda&ef_id=W5skSAAAAUVNZtNI:20181011080758:s">AWS Lambda</a> 上透過 <a target="_blank" rel="noopener" href="https://aws.amazon.com/tw/sqs/">AWS SQS</a> 來觸發，達成 Serverless 的架構。</p>
<p>隨著 Chrome Headless 的推出，PhantomJS 也宣布停止更新了，想當年也跟它奮戰許久，又一滴時代的眼淚阿，而要能在 Lambda 上執行，則必須是能在 Linux 上執行的程式，所以 .Net Core 成為這次的選擇，為了不要每次改程式都要佈署到 Lambda 上才能測試(跑一次大概5分鐘)，所以透過 Docker 模擬 AWS Lambda 的環境直接在本機測試。</p>
<h1 id="環境"><a href="#環境" class="headerlink" title="環境"></a>環境</h1><h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><p>DotNet Core 2.1 : <a target="_blank" rel="noopener" href="https://www.microsoft.com/net/download">下載</a><br>Docker for Windows : <a target="_blank" rel="noopener" href="https://docs.docker.com/docker-for-windows/install/">下載</a></p>
<h1 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h1><p>因為大量使用到 AWS SDK，查找官方 API 文件會更清楚些，所以本篇不著重在程式內容本身，只會帶到自己覺得關鍵的地方。</p>
<h2 id="建立-Net-Core-類別庫專案"><a href="#建立-Net-Core-類別庫專案" class="headerlink" title="建立 .Net Core 類別庫專案"></a>建立 .Net Core 類別庫專案</h2><p>請選擇 .Net Core &gt; 類別庫 (.Net Core)</p>
<p><img src="/images/20181011/1.png" alt="/images/20181011/1.png"></p>
<h2 id="安裝-AWS-相關套件"><a href="#安裝-AWS-相關套件" class="headerlink" title="安裝 AWS 相關套件"></a>安裝 AWS 相關套件</h2><p><img src="/images/20181011/2.png" alt="/images/20181011/2.png"></p>
<h2 id="實作-SQSHandler"><a href="#實作-SQSHandler" class="headerlink" title="實作 SQSHandler"></a>實作 SQSHandler</h2><p>因為是接收 SQS 來的命令，所以我建立了一支類別 <strong>SQSHandler</strong> ，並且寫了一個名為 <strong>Snapshot</strong> 的方法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 執行快照</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sqsEvent&quot;&gt;</span>The SQS event.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>執行結果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;ResponseEntity&gt; <span class="title">Snapshot</span>(<span class="params">SQSEvent sqsEvent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">                    </span><br><span class="line">    <span class="keyword">var</span> <span class="keyword">record</span> = sqsEvent.Records.First();</span><br><span class="line">    <span class="keyword">var</span> parameter = JsonConvert.DeserializeObject&lt;SqsEventBodyEntity&gt;(<span class="keyword">record</span>.Body);</span><br><span class="line">    </span><br><span class="line">    <span class="comment"><span class="doctag">///</span>/ 拍照</span></span><br><span class="line">    snapshotService.Do(parameter.TSCode, parameter.SalePageId);</span><br><span class="line">			</span><br><span class="line">    ...   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要接收 SQS 來的命令， AWS SDK 有提供 <strong>SQSEvent</strong> 類別，傳入自訂的參數會放在 <strong>Records</strong> 中，我們是將要拍照的參數用 Json 組起來後透過 SQS 拋進來，所以讀出 Records 後返解 Json String 為 Object ，然後拋給實作的SnapshotServiece。</p>
<p>Snapshot 這個方法回傳值為<code>自定義</code>的，可以依照自己需求調整，避免誤會所以特別說明一下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 執行快照</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;sqsEvent&quot;&gt;</span>The SQS event.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>執行結果<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Snapshot</span>(<span class="params">SQSEvent sqsEvent</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;		</span><br></pre></td></tr></table></figure>



<h2 id="Chrome-Headless"><a href="#Chrome-Headless" class="headerlink" title="Chrome Headless"></a>Chrome Headless</h2><p>什麼是 <a target="_blank" rel="noopener" href="https://developers.google.com/web/updates/2017/04/headless-chrome">Chrome Headless</a> ,簡單說就是透過無介面的方式要求Chrome執行一些快照、讀取頁面的服務。</p>
<p>為了能夠執行驅動 Chrome，所以這邊安裝 Selenium 來輔助</p>
<p><img src="/images/20181011/3.png" alt="/images/20181011/3.png"></p>
<p>Selenium 還需要搭配 Chorme Driver 來操作 Chrome，所以需要先去<a target="_blank" rel="noopener" href="http://chromedriver.chromium.org/">http://chromedriver.chromium.org/</a>下載，但需要特別注意的是要下載 <strong>Linux64</strong> 的版本，因為 AWS Lambda 是 Linux 環境</p>
<p><img src="/images/20181011/4.png" alt="/images/20181011/4.png"></p>
<h3 id="實作-1"><a href="#實作-1" class="headerlink" title="實作"></a>實作</h3><p>這邊將下載回來的 Chrome Driver 放在 Root 的資料夾，所以在建立 ChromeDriver Instance 需要告訴它 Driver的位置</p>
<p><img src="/images/20181011/5.png" alt="/images/20181011/5.png"></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chrome headless的參數</span></span><br><span class="line">ChromeOptions options = <span class="keyword">new</span> ChromeOptions();</span><br><span class="line">options.AddArgument(<span class="string">&quot;no-sandbox&quot;</span>);</span><br><span class="line">options.AddArgument(<span class="string">&quot;headless&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//取得Driver的位置</span></span><br><span class="line"><span class="keyword">var</span> root = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> driver = <span class="keyword">new</span> ChromeDriver(root, options);</span><br></pre></td></tr></table></figure>



<p>拍照</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">    </span><br><span class="line"><span class="comment">//等待Timeout的設定</span></span><br><span class="line">WebDriverWait _wait = <span class="keyword">new</span> WebDriverWait(driver, <span class="keyword">new</span> TimeSpan(<span class="number">0</span>, <span class="number">0</span>, <span class="number">10</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//要連的網址</span></span><br><span class="line">driver.Navigate().GoToUrl(targetUrl);</span><br><span class="line"></span><br><span class="line"><span class="comment">//尋找要拍的Element Class</span></span><br><span class="line"><span class="keyword">var</span> targetElement = _wait.Until&lt;IWebElement&gt;(d =&gt; driver.FindElement(By.ClassName(targetElementClass)));</span><br><span class="line"></span><br><span class="line"><span class="comment">//因為要拍的區塊可能超過預設螢幕大小，所以這邊抓到Element後將它的寬高設定給Chrome Windows Size</span></span><br><span class="line">driver.Manage().Window.Size = <span class="keyword">new</span> Size(targetElement.Size.Width, targetElement.Size.Height);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 拍照</span></span><br><span class="line">Screenshot screenShot = ((ITakesScreenshot)driver).GetScreenshot();</span><br><span class="line"></span><br><span class="line"><span class="comment">//處理圖片存到哪邊，我是存到S3，但因為不是本篇重點所以省略後面的程式碼</span></span><br><span class="line"><span class="keyword">var</span> imgStream = <span class="keyword">new</span> MemoryStream(screenShot.AsByteArray, <span class="number">0</span>, screenShot.AsByteArray.Length);</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>



<h1 id="Docker-測試"><a href="#Docker-測試" class="headerlink" title="Docker 測試"></a>Docker 測試</h1><p>打開 Power Shell，先確定已正確安裝 Docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker --version</span><br></pre></td></tr></table></figure>

<p><img src="/images/20181011/6.png" alt="/images/20181011/6.png"></p>
<p>將目錄移到 .csproj 那層，然後執行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ dotnet publish -c release -r linux-x64</span><br></pre></td></tr></table></figure>

<div class="note info">
            <p>dotnet publish command : <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/dotnet/core/tools/dotnet-publish?tabs=netcore21">文件</a></p>
          </div>

<p>如果發行成功應該可以在 <code>\bin\release\netcoreapp2.1\linux-x64\publish</code> 找到發行好的檔案</p>
<p>透過 Docker Image 測試執行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat test.json | docker run -v <span class="variable">$&#123;PWD&#125;</span>/bin/QA/netcoreapp2.1/publish:/var/task/ -i -e DOCKER_LAMBDA_USE_STDIN=1 lambci/lambda:dotnetcore2.1 xxx.Slsa.Snapshot.Console::xxx.Slsa.Snapshot.Console.SqsHandler::Snapshot</span><br></pre></td></tr></table></figure>

<p>解釋一下 Command</p>
<p><code>cat test.json</code>  : 這是拿來模擬 SQS 的呼叫時傳遞的參數檔案，檔案內容如下，我會一直替換Body 的值來測試程式是否正確去拍我要求拍的頁面，所以可以理解成是把檔案讀取後丟到後面的指令執行。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;Records&quot;</span>:[</span><br><span class="line">&#123;</span><br><span class="line"><span class="attr">&quot;messageId&quot;</span>:<span class="string">&quot;xxxxxxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;receiptHandle&quot;</span>:<span class="string">&quot;xxxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;body&quot;</span>:<span class="string">&quot;&#123;\&quot;SalePageId\&quot;: 12345,\&quot;TSCode\&quot;: \&quot;abcde\&quot;&#125;&quot;</span>,</span><br><span class="line"><span class="attr">&quot;attributes&quot;</span>:&#123;</span><br><span class="line"><span class="attr">&quot;ApproximateReceiveCount&quot;</span>:<span class="string">&quot;x&quot;</span>,</span><br><span class="line"><span class="attr">&quot;SentTimestamp&quot;</span>:<span class="string">&quot;xxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;SenderId&quot;</span>:<span class="string">&quot;xxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;ApproximateFirstReceiveTimestamp&quot;</span>:<span class="string">&quot;xxxxxx&quot;</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">&quot;messageAttributes&quot;</span>:&#123;</span><br><span class="line">&#125;,</span><br><span class="line"><span class="attr">&quot;md5OfBody&quot;</span>:<span class="string">&quot;xxxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;eventSource&quot;</span>:<span class="string">&quot;aws:sqs&quot;</span>,</span><br><span class="line"><span class="attr">&quot;eventSourceARN&quot;</span>:<span class="string">&quot;xxxxxx&quot;</span>,</span><br><span class="line"><span class="attr">&quot;awsRegion&quot;</span>:<span class="string">&quot;xxxxxx&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>docker run -v $&#123;PWD&#125;/bin/QA/netcoreapp2.1/publish:/var/task/ </code> : ${PWD} 為預設變數，表示目前的目路位置，加上 /bin/QA/netcoreapp2.1/publish 後就是剛剛發行的檔案位置，mount 到 Docker container 裡面的 <code>/var/task</code> 位置，而這也是 lambda 預設執行的位置</p>
<p><code>lambci/lambda:dotnetcore2.1</code> : Docker Image 的名稱，這是別人已經做好跟 AWS lambda 一模一樣環境的 Image ，透過它來建置我們要的環境做測試</p>
<p><code>xxx.Slsa.Snapshot.Console::xxx.Slsa.Snapshot.Console.SqsHandler::Snapshot</code> : 格式為 Assembly Name :: Class Name ::  FunctionName，表示請它執行剛剛我們開發的 SQSHandler 的 Snapshot 方法</p>
<h2 id="找不到-Chrome-binary-錯誤"><a href="#找不到-Chrome-binary-錯誤" class="headerlink" title="找不到 Chrome binary 錯誤"></a>找不到 Chrome binary 錯誤</h2><p>這時候應該會發生找不到 Chrome binary 的錯誤，原因是在 Lambda 的環境並不能安裝 Chrome，所以 Chrome Driver 想去預設環境找 Chrome 核心來執行時會找不到。</p>
<p><img src="/images/20181011/7.png" alt="/images/20181011/7.png"></p>
<div class="note info">
            <p>整個驅動 Chrome 的流程</p><p>Selenum → Chrome Driver → Chrome binary</p>
          </div>

<p>還好已經有網路上的大神解決了這問題，<a target="_blank" rel="noopener" href="https://github.com/adieuadieu/serverless-chrome/blob/master/docs/chrome.md">serverless-chrome</a>這個 Project 就是將 Chrome 封裝成 Binary 檔後可以打包進專案中，在 Power Shell 執行以下指令來取得 Chrome Binary</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -dt --rm --name headless-chromium adieuadieu/headless-chromium-for-aws-lambda:stable</span><br><span class="line">$ docker cp headless-chromium:/bin/headless-chromium ./</span><br><span class="line">$ docker stop headless-chromium</span><br></pre></td></tr></table></figure>



<p>在目前 Power Shell 指的資料底下可以找到 <strong>headless-chromium</strong> 檔案，將這個檔案加到專案中</p>
<p><img src="/images/20181011/8.png" alt="/images/20181011/8.png"></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chrome headless的參數</span></span><br><span class="line">ChromeOptions options = <span class="keyword">new</span> ChromeOptions();</span><br><span class="line">options.AddArgument(<span class="string">&quot;no-sandbox&quot;</span>);</span><br><span class="line">options.AddArgument(<span class="string">&quot;headless&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//取得Driver的位置</span></span><br><span class="line"><span class="keyword">var</span> root = Path.GetDirectoryName(Assembly.GetExecutingAssembly().Location);</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定Chrome Binary位置</span></span><br><span class="line">options.BinaryLocation = Path.Combine(root, <span class="string">&quot;headless-chromium&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> driver = <span class="keyword">new</span> ChromeDriver(root, options);</span><br></pre></td></tr></table></figure>

<p>做到這邊再執行剛剛的指令應該可以正常拍照了。</p>
<h1 id="掃雷"><a href="#掃雷" class="headerlink" title="掃雷"></a>掃雷</h1><h2 id="亂碼問題"><a href="#亂碼問題" class="headerlink" title="亂碼問題"></a>亂碼問題</h2><p>因為 Chrome Binary 輕量化，所以作者並沒有把中文/日文/韓文包進來，所以拍一下遇到上述文字都會出現亂碼</p>
<div class="note info">
            <p>詳細討論串</p><p><a target="_blank" rel="noopener" href="https://github.com/adieuadieu/serverless-chrome/issues/49">Include Chinese/Japanese/Korean/more fonts in headless Chrome binary #49</a></p>
          </div>

<p>依據該討論串下方的回應，已經有對應的解決方案</p>
<p><img src="/images/20181011/9.png" alt="/images/20181011/9.png"></p>
<p>1.將需要的字典檔下載回來放在 Root 的 <code>.fonts</code> 資料夾中</p>
<p><img src="/images/20181011/10.png" alt="/images/20181011/10.png"></p>
<p>2.將 <code>$HOME</code> 環境變數指到 <code>/var/task</code></p>
<p>建立一個檔案 <code>env.variable</code> 裡面寫</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HOME=/var/task</span><br></pre></td></tr></table></figure>

<p>接著透過 Docker Container 執行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat test.json | docker run --env-file ./env.variable -v <span class="variable">$&#123;PWD&#125;</span>/bin/QA/netcoreapp2.1/publish:/var/task/ -i -e DOCKER_LAMBDA_USE_STDIN=1 lambci/lambda:dotnetcore2.1 xxx.Slsa.Snapshot.Console::xxx.Slsa.Snapshot.Console.SqsHandler::Snapshot</span><br></pre></td></tr></table></figure>

<p>這樣拍出來的中文、韓文、日文的畫面就不會亂碼了</p>
<h2 id="權限"><a href="#權限" class="headerlink" title="權限"></a>權限</h2><p>將程式打包好放到 AWS Lambda 上面跑，隨即碰到以下錯誤</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Permission denied: Win32Exception</span><br><span class="line">at Interop.Sys.ForkAndExecProcess(String filename, String[] argv, String[] envp, String cwd, Boolean redirectStdin, Boolean redirectStdout, Boolean redirectStderr, Boolean setUser, UInt32 userId, UInt32 groupId, Int32&amp; lpChildPid, Int32&amp; stdinFd, Int32&amp; stdoutFd, Int32&amp; stderrFd, Boolean shouldThrow)</span><br><span class="line">at System.Diagnostics.Process.StartCore(ProcessStartInfo startInfo)</span><br><span class="line">at System.Diagnostics.Process.Start()</span><br><span class="line">at OpenQA.Selenium.DriverService.Start()</span><br><span class="line">at OpenQA.Selenium.Remote.DriverServiceCommandExecutor.Execute(Command commandToExecute)</span><br><span class="line">at OpenQA.Selenium.Remote.RemoteWebDriver.Execute(String driverCommandToExecute, Dictionary`2 parameters)</span><br><span class="line">at OpenQA.Selenium.Remote.RemoteWebDriver.StartSession(ICapabilities desiredCapabilities)</span><br><span class="line">at OpenQA.Selenium.Remote.RemoteWebDriver..ctor(ICommandExecutor commandExecutor, ICapabilities desiredCapabilities)</span><br><span class="line">at OpenQA.Selenium.Chrome.ChromeDriver..ctor(ChromeDriverService service, ChromeOptions options, TimeSpan commandTimeout)</span><br><span class="line">at .........</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>原因是 Lambda 的 <code>/var/task</code> 是 read-only，所以要執行 Chrome Driver 與 Chrome Binary 時會沒有權限，只好用很 tricky 的方式，先把 Chrome Driver 與 Chrome Binary 搬到 <code>/tmp</code> 底下再授予權限</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Isinitialeds this instance.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Initial</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!File.Exists(<span class="string">&quot;/tmp/chromedriver&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        File.Copy(<span class="string">&quot;/var/task/chromedriver&quot;</span>, <span class="string">&quot;/tmp/chromedriver&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        Exec(<span class="string">&quot;chmod +x /tmp/chromedriver&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!File.Exists(<span class="string">&quot;/tmp/headless-chromium&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        File.Copy(<span class="string">&quot;/var/task/headless-chromium&quot;</span>, <span class="string">&quot;/tmp/headless-chromium&quot;</span>, <span class="literal">true</span>);</span><br><span class="line">        Exec(<span class="string">&quot;chmod +x /tmp/headless-chromium&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> Executes the specified command.</span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;cmd&quot;&gt;</span>The command.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Exec</span>(<span class="params"><span class="built_in">string</span> cmd</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> escapedArgs = cmd.Replace(<span class="string">&quot;\&quot;&quot;</span>, <span class="string">&quot;\\\&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> process = <span class="keyword">new</span> Process</span><br><span class="line">    &#123;</span><br><span class="line">        StartInfo = <span class="keyword">new</span> ProcessStartInfo</span><br><span class="line">        &#123;</span><br><span class="line">            RedirectStandardOutput = <span class="literal">true</span>,</span><br><span class="line">            UseShellExecute = <span class="literal">false</span>,</span><br><span class="line">            CreateNoWindow = <span class="literal">true</span>,</span><br><span class="line">            WindowStyle = ProcessWindowStyle.Hidden,</span><br><span class="line">            FileName = <span class="string">&quot;/bin/bash&quot;</span>,</span><br><span class="line">            Arguments = <span class="string">$&quot;-c \&quot;<span class="subst">&#123;escapedArgs&#125;</span>\&quot;&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    process.Start();</span><br><span class="line">    process.WaitForExit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//chrome headless的參數</span></span><br><span class="line">ChromeOptions options = <span class="keyword">new</span> ChromeOptions();</span><br><span class="line">options.AddArgument(<span class="string">&quot;no-sandbox&quot;</span>);</span><br><span class="line">options.AddArgument(<span class="string">&quot;headless&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//指定Chrome Binary位置</span></span><br><span class="line">options.BinaryLocation = <span class="string">&quot;/tmp/headless-chromium&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> driver = <span class="keyword">new</span> ChromeDriver(<span class="string">&quot;/tmp&quot;</span>, options);</span><br></pre></td></tr></table></figure>



<h2 id="CreatePlatformSocket-Operation-not-permitted-1"><a href="#CreatePlatformSocket-Operation-not-permitted-1" class="headerlink" title="CreatePlatformSocket() Operation not permitted (1)"></a>CreatePlatformSocket() Operation not permitted (1)</h2><p>接著遇到下個問題是， ChromeDriver Init 起來時會去呼叫 <a href="http://localhost:xxxx/Session">http://localhost:xxxx/Session</a> ，而這時後就會因為沒有權限而失敗，但這個在 NodeJs 的版本不會發生，查了 Selenium 的 Source Code 也看不出原因，找了相當多的討論串，<del>目前似乎依然無解，也是在這一題後不得不先放棄</del>，改採用相容較高的 NodeJs 版本</p>
<p><img src="/images/20181011/11.png" alt="/images/20181011/11.png"></p>
<div class="note info">
            <p><strong>相關討論串</strong></p><p><a target="_blank" rel="noopener" href="https://github.com/SeleniumHQ/selenium/issues/5457">The HTTP request to the remote WebDriver server for URL http://localhost:42607/session timed out after 60 seconds.</a></p><p><a target="_blank" rel="noopener" href="https://github.com/SeleniumHQ/selenium/issues/6234">Message: OpenQA.Selenium.WebDriverException : The HTTP request to the remote WebDriver server for URL when using Chrome Headles #6234</a></p>
          </div>



<p><strong>2018-10-25 更新</strong></p>
<p>在產生 ChromeDriver 的時候加上 <code>disable-dev-shm-usage</code> 、 <code>single-process</code> 兩個參數可以解決這個問題，</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">options.AddArguments(<span class="string">&quot;no-sandbox&quot;</span>, <span class="string">&quot;headless&quot;</span>, <span class="string">&quot;disable-dev-shm-usage&quot;</span>, <span class="string">&quot;disable-gpu&quot;</span>, <span class="string">&quot;single-process&quot;</span>, <span class="string">&quot;no-zygote&quot;</span>, <span class="string">&quot;hide-scrollbars&quot;</span>, <span class="string">&quot;lang=zh-TW,zh&quot;</span>);</span><br><span class="line"></span><br><span class="line">options.BinaryLocation = <span class="string">&quot;/tmp/headless-chromium&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> driver = <span class="keyword">new</span> ChromeDriver(<span class="string">&quot;/tmp&quot;</span>, options);</span><br></pre></td></tr></table></figure>

<p>其中 <code>single-process</code> 為 Chromium 的模式之一，詳細可以參考文件</p>
<div class="note info">
            <p><a target="_blank" rel="noopener" href="https://www.chromium.org/developers/design-documents/process-models">[The Chromium Projects] - Process Models</a></p><p><a target="_blank" rel="noopener" href="https://peter.sh/experiments/chromium-command-line-switches/">List of Chromium Command Line Switches</a></p>
          </div>



<p><code>disable-dev-shm-usage</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">To fix, run the container with docker run --shm-size&#x3D;1gb to increase the size of &#x2F;dev&#x2F;shm . Since Chrome 65, this is no longer necessary. Instead, launch the browser with the --disable-dev-shm-usage flag</span><br></pre></td></tr></table></figure>



<p>會找到這個解法是因為去看了 <a target="_blank" rel="noopener" href="https://github.com/adieuadieu/serverless-chrome">serverless-chrome</a> 的 source code 發現他是這樣寫的，但這樣搭配為什麼會正常，說實在的目前我還看不出為什麼 ， 只能等之後讀更多文件再看看有沒有辦法解答。</p>
<p>加上這兩個參數後 Lambda 上面雖然還是會報 <code>CreatePlatformSocket() Operation not permitted (1)</code> 錯誤，但減少到只剩下兩次，就正常執行了</p>
<p><img src="/images/20181011/12.png" alt="/images/20181011/12.png"></p>
<h2 id="補充-環境問題"><a href="#補充-環境問題" class="headerlink" title="補充 : 環境問題"></a>補充 : 環境問題</h2><p>最後雖然我們採用了 NodeJs 的版本，但還是踩了一個小小的雷，那就是要把檔案壓縮成 zip 檔放到 AWS Lambda 時，相同的程式用我的電腦壓出來是不能執行，但同事壓出來的 zip 檔案卻可以，經過測試後發現，因為我的 Mac 語系環境是中文，壓縮出來時預設會是<code>封裝.zip</code>，不管是中文的的放上去，或是改了檔名後放上去都會錯誤。</p>
<p>只能下 command 指定壓縮出來的檔名才可解決這個問題</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ zip -r -j ./destination/pacakge ./<span class="built_in">source</span></span><br></pre></td></tr></table></figure>

<p>相同的，在 Windows 壓出來放上去一樣會壞掉，推測是相同原因….真的是雷到你不要不要的</p>
<p><strong>2018-10-25 更新</strong></p>
<p>網路上找到有人討論 Windows 壓縮後放上去會壞掉的問題，解法是請安裝 7zip，並且直接到 root 層執行壓縮，壓完後解壓就要是Root，不要再包一層資料夾，另外…只能用 GUI 執行壓縮，我用 PowerShell 壓縮一樣不行，不知道為什麼(暈)，難怪論壇開宗明義第一句話就是，<strong>不要用 Windows</strong> ，Linux base 的東西跟 windows 真的是很不合…</p>
<p><img src="/images/20181011/13.png" alt="/images/20181011/13.png"></p>
 <div class="note info">
            <p><a target="_blank" rel="noopener" href="https://forums.aws.amazon.com/thread.jspa?threadID=179638">Lambda disdains ZIP files compressed with PowerShell</a></p>
          </div>












      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2018/09/14/%E8%87%AA%E8%A8%82Google_SearchEngine/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/09/14/%E8%87%AA%E8%A8%82Google_SearchEngine/" class="post-title-link" itemprop="url">【生產力】自訂Google Search Engine</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-09-14 10:04:00" itemprop="dateCreated datePublished" datetime="2018-09-14T10:04:00+08:00">2018-09-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/09/14/%E8%87%AA%E8%A8%82Google_SearchEngine/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/09/14/自訂Google_SearchEngine/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>常常會有需要查詢英文、日文單字的情形，以前都會先打開Yahoo或是Google的辭典然後查詢單字，直到今天學到了自訂Chrome Search Engine實在太好用了，所以決定寫下來記錄一下</p>
<h1 id="設定"><a href="#設定" class="headerlink" title="#設定"></a>#設定</h1><p>首先先打開Chrome瀏覽器，在網址列輸入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chrome:&#x2F;&#x2F;settings&#x2F;searchEngines</span><br></pre></td></tr></table></figure>



<p>接著點選**[新增]**</p>
<p><img src="/images/20180914/1.png" alt="/images/20180914/1.png"></p>
<p><img src="/images/20180914/2.png" alt="/images/20180914/1.png"></p>
<ul>
<li><p><strong>搜尋引擎</strong></p>
<p>​    讓自己識別的名稱，可以隨便寫</p>
</li>
<li><p><strong>關鍵字</strong> </p>
<p>​    這個是你啟動自訂Google Search Engine的關鍵字，請寫自己好記的</p>
</li>
<li><p><strong>網址</strong> </p>
<p>告訴Chrome如何用你下的關鍵字去搜尋，以Google翻譯為例，當你輸入apple時網址會變成如圖，而紅框處就是我們要替換的地方，請以<code>%s</code>替代</p>
<p><img src="/images/20180914/3.png" alt="/images/20180914/1.png"></p>
</li>
</ul>
<h1 id="使用"><a href="#使用" class="headerlink" title="#使用"></a>#使用</h1><p>之後只要我在Chrome瀏覽器輸入<code>gdic</code>+<code>空格</code>，就會變成這樣</p>
<p><img src="/images/20180914/4.png" alt="/images/20180914/1.png"></p>
<p>再次輸入Apple後Enter就會跑到Google翻譯頁並查好了</p>
<p><img src="/images/20180914/5.gif" alt="/images/20180914/1.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2018/08/23/byte_order_mark/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2018/08/23/byte_order_mark/" class="post-title-link" itemprop="url">什麼是BOM(Byte-order mark)?</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-08-23 09:44:00" itemprop="dateCreated datePublished" datetime="2018-08-23T09:44:00+08:00">2018-08-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2018/08/23/byte_order_mark/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/08/23/byte_order_mark/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近開發了一支收集資訊然後將資料轉成Json檔案給其它單位讀取，但收到對口單位回報Json格式不正確。但我將檔案內容貼到線上的Json解析網站，或是自己肉眼判斷都覺得格式沒問題，所以執行了一次對方的解析程式，錯誤訊息如下。</p>
<p>在字串0的位置有錯誤</p>
<p><img src="/images/20180823/1.png" alt="/images/20180823/1.png"></p>
<p>打開我提供的檔案，字串0也就是最前面感覺很正常…</p>
<p><img src="/images/20180823/2.png" alt="/images/20180823/2.png"></p>
<p>接著我將這段錯誤訊息貼Notepad++，轉成Hex碼來看看究竟是藏了什麼東西</p>
<p><img src="/images/20180823/3.png" alt="/images/20180823/3.png"></p>
<h1 id="什麼是BOM"><a href="#什麼是BOM" class="headerlink" title="#什麼是BOM"></a>#什麼是BOM</h1><p>把<strong>ef bb bf</strong>拿去Google最後查到了<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BD%8D%E5%85%83%E7%B5%84%E9%A0%86%E5%BA%8F%E8%A8%98%E8%99%9F">Wiki-位元組順序記號</a></p>
<div class="note info">
            <p>節錄Wiki</p><p><strong>位元組順序記號</strong>（英語：byte-order mark，<strong>BOM</strong>）是位於碼點<code>U+FEFF</code>的<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%B5%B1%E4%B8%80%E7%A2%BC">統一碼</a>字元的名稱。當以<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-16">UTF-16</a>或<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-32">UTF-32</a>來將<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UCS">UCS</a>/統一碼字元所組成的字串編碼時，這個字元被用來標示其<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82%E5%BA%8F">位元組序</a>。它常被用來當做標示檔案是以<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-8">UTF-8</a>、<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-16">UTF-16</a>或<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/UTF-32">UTF-32</a>編碼的記號。 </p>
          </div>



<h1 id="解法"><a href="#解法" class="headerlink" title="#解法"></a>#解法</h1><p>而會塞入位元組序是因為在寫檔案時這樣指定編碼</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (StreamWriter file = <span class="keyword">new</span> StreamWriter(</span><br><span class="line">    					<span class="keyword">new</span> FileStream(path,FileMode.OpenOrCreate,FileAccess.Write),</span><br><span class="line">                        Encoding.UTF8))</span><br><span class="line">&#123;</span><br><span class="line">	.....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>只要將寫改改成 <strong>new UTF8Encoding(false)</strong> 即可</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> (StreamWriter file = <span class="keyword">new</span> StreamWriter(</span><br><span class="line">                         <span class="keyword">new</span> FileStream(path, FileMode.OpenOrCreate, FileAccess.Write),</span><br><span class="line">                         <span class="keyword">new</span> UTF8Encoding(<span class="literal">false</span>)))</span><br><span class="line">&#123;</span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Toyo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">203</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">75</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Toyo</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://toyo0103.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
