<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"toyo0103.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="程式隨筆">
<meta property="og:url" content="https://toyo0103.github.io/page/3/index.html">
<meta property="og:site_name" content="程式隨筆">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Toyo">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://toyo0103.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>程式隨筆</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程式隨筆" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程式隨筆</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/04/30/jenkins_update_remote_docker_container/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/30/jenkins_update_remote_docker_container/" class="post-title-link" itemprop="url">【Docker】透過 Jenkins 重新部屬遠端機器 Container</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-30 10:00:00" itemprop="dateCreated datePublished" datetime="2019-04-30T10:00:00+08:00">2019-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/04/30/jenkins_update_remote_docker_container/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/30/jenkins_update_remote_docker_container/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190430/0.jpg" alt="/images/20190430/0.jpg"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>公司慢慢在導入 Docker 等相關 Container 技術，但因為剛起步所以很多 CI/CD 流程都還在優化建構中，前幾天為了能讓 Jenkins 順利重新部屬新版 Container 搞得焦頭爛額，乾脆把這些過程記錄下來</p>
<br>

<h2 id="部屬流程"><a href="#部屬流程" class="headerlink" title="部屬流程"></a>部屬流程</h2><p><img src="/images/20190430/1.png" alt="/images/20190430/1.png"></p>
<p>這個服務是由三個 Component 來組成，分開維護開發，換句話說如果有任何一個組件更新，整個服務都需要更新並重新部屬，目前的流程是各個 Component 更新後都會觸發 CD 流程將完成品打包放到 S3。</p>
<p>而我這次做得線就是 Docker Image 那條，當有任何 Component 更新了都會觸發，我會將 S3 的各個 Component 最新版抓下來後整理，接著再打包一版 Build Docker Image 會需要的原料放到 S3。</p>
<p>接著 Jenkins 接手將 Docker Image Artifact 抓下來開始 build =&gt; push =&gt; 換掉遠端機器正在跑的 Container。</p>
<br>

<h1 id="設定權限"><a href="#設定權限" class="headerlink" title="設定權限"></a>設定權限</h1><p> 所以第一步是釐清 Jenkins 所使用的 user 是否有執行 docker 相關指令的權限，後面都簡稱這位使用者為 <code>ciuser</code>。</p>
<p>因為 docker 為 service 等級的服務，預設是 admin 才能使用相關指令，所以理所當然地馬上卡關</p>
<p><img src="/images/20190430/2.png" alt="/images/20190430/2.png"></p>
<p>要讓使用者有執行 docker 相關指令的權限有兩種方法</p>
<ol>
<li>賦予該 User Admin 的權限</li>
<li>開一個群組，並設定 docker daemon ，賦予該群組權限</li>
</ol>
<p>顯然 (1) 不太可能(雖然最簡單)，所以這邊採取 (2) 的方法</p>
<p>*** Windows 上右鍵 &gt; Computer Management**</p>
<p><img src="/images/20190430/3.png" alt="/images/20190430/3.png"></p>
<p>*** Local Users and Groups &gt;&gt; Groups **</p>
<p><img src="/images/20190430/4.png" alt="/images/20190430/4.png"></p>
<p>*** New Group &gt;&gt; 建立一個群組 &gt;&gt; 將 ciuser 加進去**</p>
<p><img src="/images/20190430/5.png" alt="/images/20190430/5.png"></p>
<p>*** 到 C:\ProgramData\docker\config 修改 daemon.json 檔案**(如果沒有這個檔案，請自己建一個)</p>
<p>將剛剛的群組加進去</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;group&quot;</span>: <span class="string">&quot;docker-users&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>*** 重新啟動 docker service ** (這邊需要 admin 權限)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Powershell</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">Restart-Service</span> docker</span><br></pre></td></tr></table></figure>

<p>做到這邊你在用 <code>ciuser</code> 下 docker command 應該就可以動了</p>
<p><img src="/images/20190430/6.png" alt="/images/20190430/6.png"></p>
<p>PS. 如果還不行，請先登出 <code>ciuser</code> 再登入，因為將使用者加入一個群組或賦予權限，重登才會生效</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-docker/configure-docker-daemon">Docker Engine on Windows</a></p>
          </div>



<p>到這邊應該已經打通 <code>ciuser</code> 可以執行 docker command 的權限了，接著在 Jenkins 設定 build 、 push Image的流程測試會發現依然錯誤</p>
<div class="note info">
            <p>error during connect: Get http://%2F%2F.%2Fpipe%2Fdocker_engine/v1.40/containers/json: open //./pipe/docker_engine: The system cannot find the file specified. In the default daemon configuration on Windows, the docker client must be run elevated to connect. This error may also indicate that the docker daemon is not running.</p>
          </div>

<p>但同樣的指令不透過 Jenkins 執行，而是用遠端登入直接執行會過，這個問題想了很久還是搞不懂為什麼，明明使用的 User 相同 …</p>
<p>但找到了一篇文章也提到相同的事情並提供了解決方案，主要是需要調整 docker_engine ACL 設定，但因為過程太麻煩，作者很貼心的還提供了小套件可以使用</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Powershell</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">Install-Module</span> <span class="literal">-Name</span> dockeraccesshelper</span><br><span class="line"><span class="variable">$</span> <span class="built_in">Import-Module</span> dockeraccesshelper</span><br><span class="line"><span class="variable">$</span> <span class="built_in">Add-AccountToDockerAccess</span> <span class="string">&quot;ciuser&quot;</span></span><br></pre></td></tr></table></figure>

<p>再次執行 Jenkins 就真的成功了</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://www.axians-infoma.com/techblog/allow-access-to-the-docker-engine-without-admin-rights-on-windows/">Allow access to the Docker Engine without admin rights on Windows</a></p>
          </div>

<br>

<h1 id="設定-Jenkins"><a href="#設定-Jenkins" class="headerlink" title="設定 Jenkins"></a>設定 Jenkins</h1><p>Build Image 、 Push Image 這些流程就直接省略了，重點是最後一步怎麼觸發遠端機器更新 Container 。</p>
<p>Docker Compose 提供 <code>--host</code> ，讓你可以操作遠端機器的 Container</p>
<p><img src="/images/20190430/7.png" alt="/images/20190430/7.png"></p>
<p>但前提是你必須先去該機器開啟 2376 port 的防火牆，還有設定 docker daemon config，跟上面那段一樣檔案，只是上次設定的是 jenkins 機器，這次是跑 Container 的機器</p>
<p>路徑 :  C:\ProgramData\docker\config\daemon.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;hosts&quot;</span>: [<span class="string">&quot;tcp://0.0.0.0:2376&quot;</span>, <span class="string">&quot;npipe://&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>都開好後回頭在 Jenkins 的流程中埋下最後一段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker-compose -H machineIp:2376 pull</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker-compose -H machineIp:2376 up -d</span></span><br></pre></td></tr></table></figure>

<br>

<h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>雖然只是短短的一篇，但是整個設定的過程其實卡很久，尤其是 windows 的權限不是很熟常常會把自己搞得很亂，但為了團隊能接手維運，這些過程又勢必有人需要去踩過一次，以前都覺得 DevOps 的 Dev 才是主力(自己大部分經歷也都是待在開發團隊)，對於維運一直都沒有很深入去了解並感受他們的痛。</p>
<p>但當角色從 Developer 漸漸轉成 Infra ，不同的角度去看這些事情有了完全不同的感受，<code>維運</code>真的才是整個軟體生命週期佔最大的部分，一套系統你可能開發個 1 ~ 3 年，但產品的維運可能是數十年，怎麼讓一套機制落地，讓人為介入越少越好，要考慮的面向真的比過去單純開發差非常多，果然還有得學阿。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/04/22/Docker_build/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/22/Docker_build/" class="post-title-link" itemprop="url">【Docker】Build Image</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-22 10:19:00" itemprop="dateCreated datePublished" datetime="2019-04-22T10:19:00+08:00">2019-04-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/04/22/Docker_build/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/22/Docker_build/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190422/0.png" alt="/images/20190422/0.png"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>剛開始使用 Docker 的時候，我常常都是使用別人已經包好的 Image，但難免會有不符使用需要客製的時候，又或是將公司的某些服務做成 Docker Image ，再從多台機器上 Pull Docker Image  直接執行，所以 Docker Build 幾乎是玩 Docker 必學的技巧了  </p>
<p>從 Docker Hub 尋找適合的 Image 來使用</p>
<p><img src="/images/20190422/1.png" alt="/images/20190422/1.png"></p>
<p>前陣子將公司一些服務包成 Docker Image 並部署執行</p>
<p><img src="/images/20190422/2.png" alt="/images/20190422/2.png"></p>
<br>

<h1 id="製作第一個-Docker-Image"><a href="#製作第一個-Docker-Image" class="headerlink" title="製作第一個 Docker Image"></a>製作第一個 Docker Image</h1><p>下面的範例會透過一個簡單的範例來解說包 Docker Image 的過程，希望最後的成果是，我們透過執行自製的 Docker Image 就跑起來一個 ASP.Net 的網站</p>
<br>

<h2 id="開新專案"><a href="#開新專案" class="headerlink" title="開新專案"></a>開新專案</h2><p><img src="/images/20190422/3.png" alt="/images/20190422/1.png"></p>
<p><img src="/images/20190422/4.png" alt="/images/20190422/1.png"></p>
<p>直接用 VS 執行起來就是一個最原始的 MVC 網站</p>
<p><img src="/images/20190422/5.png" alt="/images/20190422/1.png"></p>
<br>

<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><p>Dockerfile 是 Build Docker Image 的根本，這個檔案會告訴 Docker 該把什麼東西放進 Image ? 步驟是什麼 ? 怎麼啟動 ?</p>
<br>

<p>先新增一個 Docker File 到剛剛的專案中</p>
<p><img src="/images/20190422/6.png" alt="/images/20190422/6.png"></p>
<p>調整屬性</p>
<p><img src="/images/20190422/7.png" alt="/images/20190422/7.png"></p>
<p>這樣如果發行這個專案，dockerfile 就會一起過去</p>
<p><img src="/images/20190422/8.png" alt="/images/20190422/8.png"></p>
<p><img src="/images/20190422/9.png" alt="/images/20190422/9.png"></p>
<br>

<p><strong>Dockerfile 內容</strong></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">mcr.microsoft.com/dotnet/framework/aspnet:latest</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">.</span> <span class="string">/inetpub/wwwroot</span></span><br></pre></td></tr></table></figure>

<p><code>From</code> : 表示你這個 Image 是以哪一個當作 Base，以這次的案例為例，我們選擇微軟官方提供的 mcr.microsoft.com/dotnet/framework/aspnet Image 作為 base，因為它已經幫我們安裝好 IIS 、.net Framework，這樣我們只要專注在我們開發的程式即可。</p>
<p><code>COPY</code> : dockerfile 所屬資料夾所有的內容複製到 container 裡面的 <code>c:/inetpub/wwwroot</code>，也就是 IIS 的預設目錄</p>
<br>

<h2 id="Docker-build"><a href="#Docker-build" class="headerlink" title="Docker build"></a>Docker build</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker build -t &lt;ImageName&gt;:&lt;Tag&gt; &lt;Dockerfile Path&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker build -t my_first_docker_image:latest -t my_first_docker_image:1.0.0 .</span></span><br></pre></td></tr></table></figure>

<p>docker build 時我為這個 Image 下了兩個 tag，分別為 latest、1.0.0</p>
<p><img src="/images/20190422/10.png" alt="/images/20190422/10.png"></p>
<br>

<h2 id="Docker-Run"><a href="#Docker-Run" class="headerlink" title="Docker Run"></a>Docker Run</h2><p>執行剛剛我們自建的 Image，並且將本機的 9999 port mapping 到 container 內的 80 port</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -d -p 9999:80 my_first_docker_image:latest</span></span><br></pre></td></tr></table></figure>

<p>這樣就可以看到網站啦</p>
<p><img src="/images/20190422/11.png" alt="/images/20190422/11.png"></p>
<br>

<h1 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h1><p>這邊只是小小演示如何 Build 一個最簡單的 docker image，其實 Dockerfile 還有很多可以發揮的地方，如果有需要，可以參考以下官方文件</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/build/">Docker build</a></p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/aspnet/mvc/overview/deployment/docker-aspnetmvc">將 ASP.NET MVC 應用程式遷移到 Windows 容器</a></p>
          </div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/03/23/windows_container_smb_/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/23/windows_container_smb_/" class="post-title-link" itemprop="url">【Docker】Widows Container SMB</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-23 17:53:00" itemprop="dateCreated datePublished" datetime="2019-03-23T17:53:00+08:00">2019-03-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/03/23/windows_container_smb_/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/23/windows_container_smb_/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190323/0.png" alt="/images/20190323/0.png"></p>
<p>之前在將公司某支程式移植到 Windows Container 時碰到一個問題，該程式會透過<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BC%BA%E6%9C%8D%E5%99%A8%E8%A8%8A%E6%81%AF%E5%8D%80%E5%A1%8A">網路磁碟 (SMB)</a> Eamil Template 來套版並寄出，但將網路磁碟透過 Volume 的方式 Mount 到 Container 卻抓不到檔案，查了一下才知道原來需要用 SmbGlobalMapping 掛載的網路磁碟才行</p>
<div class="note info">
            <p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/virtualization/windowscontainers/manage-containers/container-storage">Windows Server 容器儲存體</a></p>
          </div>

<p>以下這段是先將要用到的網路磁碟透過 New-SmbGlobalMapping 指令掛成 T: </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="variable">$User</span>=<span class="string">&quot;yourUSerAccount&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="variable">$PWD</span> = ConvertTo-SecureString -String <span class="string">&quot;yourPassword&quot;</span> -AsPlainText -Force</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="variable">$Credential</span> = New-Object -TypeName System.Management.Automation.PSCredential -ArgumentList <span class="variable">$User</span>, <span class="variable">$PWD</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> New-SmbGlobalMapping -LocalPath T: -RemotePath \\my-company-Filer\Files -Credential <span class="variable">$Credential</span></span></span><br></pre></td></tr></table></figure>

<p>然後在透過 Volume 即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it -v T:\:C:\Files myContainer</span></span><br></pre></td></tr></table></figure>

<br >

<div class="note danger">
            <p>不過還要特別注意的是，在 Windows Server (版本 1709)，SMB 全域對應不支援 DFS、DFSN、DFSR 共用。</p>
          </div>

<p>所以如果是 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E5%88%86%E6%95%A3%E5%BC%8F%E6%AA%94%E6%A1%88%E7%B3%BB%E7%B5%B1_(Microsoft)">DFS</a> 那就只好先強制指到某一台，期待哪一天 Windows Container 可以支援了</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/03/21/microservice_battlefield/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/21/microservice_battlefield/" class="post-title-link" itemprop="url">微服務的戰場</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-21 23:30:00" itemprop="dateCreated datePublished" datetime="2019-03-21T23:30:00+08:00">2019-03-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/03/21/microservice_battlefield/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/21/microservice_battlefield/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190321/0.jpg" alt="/images/20190321/0.jpg"></p>
<p>整理一下最近在學習的 Road map，大致上圍繞著微服務</p>
<ul>
<li><p>微服務</p>
<ul>
<li><p>什麼是微服務</p>
</li>
<li><p>微服務的好幫手</p>
<ul>
<li>Container<ul>
<li><a href="/2019/02/21/dockerforwindows_vs_dockeronwindowserver/">Docker for Windows 和 Docker on Windows Server 一樣嗎?</a></li>
<li><a href="/2019/04/22/Docker_build/">Docker Build Image</a></li>
<li>Docker Compose</li>
<li><a href="/2019/02/22/docker_debug_skill/">偵錯技巧</a></li>
<li><a href="/2019/02/20/windows_container_dnsserver/">Widows Container DNS Server 問題</a></li>
<li><a href="/2019/02/19/windows_contianer_iamrole_/">Widows Container IAM Role 問題</a></li>
<li><a href="/2019/03/23/windows_container_smb_/">Windosw Container SMB </a></li>
</ul>
</li>
<li>Queue<ul>
<li>RabbitMQ</li>
<li><a href="/2019/08/19/nats_streaming/">NATS</a></li>
</ul>
</li>
<li>Self Hosting<ul>
<li>Owin</li>
</ul>
</li>
<li>Graceful Shutdown</li>
<li><a href="/2019/11/09/service_discovery/">Service Discovery</a></li>
</ul>
</li>
<li><p>部署</p>
<ul>
<li>K8S</li>
<li>docker swarm</li>
<li><a href="/2019/04/30/jenkins_update_remote_docker_container/">透過 Jenkins 重新部屬遠端機器 Container</a></li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/03/15/yield_return_2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/15/yield_return_2/" class="post-title-link" itemprop="url">【C#】Yield Return (二)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-15 17:30:00" itemprop="dateCreated datePublished" datetime="2019-03-15T17:30:00+08:00">2019-03-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/03/15/yield_return_2/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/15/yield_return_2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190315/0.jpg" alt="/images/20190315/0.jpg"></p>
<p>最近經過大師的指導後，對於 Yield Return 又或是迭代器有更深的感受，先來看一段以前常常會寫的程式</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> users = GetUser(idList);</span><br><span class="line">	<span class="comment">//過濾黑名單</span></span><br><span class="line">	<span class="keyword">var</span> notInBlackList = users.Where(x=&gt; !x.InBlackList);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//往下做其他邏輯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">GetUser</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; ids</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//透過 ID 取得會員的詳細資料</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 Id 一次有一百萬筆，為了避免擊沉 Database 做了分批查詢也是很合理的</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> users = GetUser(idList);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//過濾黑名單</span></span><br><span class="line">	<span class="keyword">var</span> notInBlackList = users.Where(x=&gt; !x.InBlackList);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">//往下做其他邏輯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">GetUser</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; ids</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;User&gt;();</span><br><span class="line">	<span class="comment">// 每批搜尋 1000筆</span></span><br><span class="line">	<span class="keyword">var</span> batchCount = <span class="number">1000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//計算出搜尋次數後分批查詢</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; 搜尋次數; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		Result.AddRange(</span><br><span class="line">			UserRepository.Get(ids.Skip(i * batchCount).Take(batchCount)));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>當然也可以從呼叫端分批處理</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 每批搜尋 1000筆</span></span><br><span class="line">	<span class="keyword">var</span> batchCount = <span class="number">1000</span>;</span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; 搜尋次數; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">var</span> users = GetUser(idList);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//過濾黑名單</span></span><br><span class="line">		<span class="keyword">var</span> notInBlackList = users.Where(x=&gt; !x.InBlackList);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//往下做其他邏輯</span></span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">GetUser</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; ids</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//透過 ID 取得會員的詳細資料</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果需要再更複雜一些，要依據使用者的設定濾掉一些人，最終要將處理過程都填回 DB ，以便追蹤那些人是因為那些條件被過濾掉的 (不然被客戶抱怨沒收到通知，不知道往哪找)，這時候程式就會變成這樣….</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 每批搜尋 1000筆</span></span><br><span class="line">	<span class="keyword">var</span> batchCount = <span class="number">1000</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">var</span> temp = <span class="keyword">new</span> List&lt;User&gt;()</span><br><span class="line">	<span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; 搜尋次數; i++)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">var</span> users = GetUser(idList);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> notInBlackList = users.Where(x=&gt; !x.InBlackList);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">var</span> wantToReceiveThisMessage = notInBlackList.Where(x =&gt; x.BlockMessageType != ThisMessageType);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//統計誰在黑名單被過濾掉</span></span><br><span class="line">		<span class="comment">//統計誰不想收到這種類型的 DB</span></span><br><span class="line">		</span><br><span class="line">		<span class="comment">//可能批次更新是 5000 筆最有效率</span></span><br><span class="line">		temp.Add(InBlackList);</span><br><span class="line">		temp.Add(DontWantToReceiveThisMessage);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span> (temp.Count &gt; <span class="number">5000</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Insert Log</span></span><br><span class="line">			LogRepository.Add(temp);</span><br><span class="line">			temp.Clear();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;User&gt; <span class="title">GetUser</span>(<span class="params">List&lt;<span class="built_in">int</span>&gt; ids</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//透過 ID 取得會員的詳細資料</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>條件可以無限增長上去，程式也會變得越來越複雜，當然這時候可以採取一些物件導向的設計將功能職責拆開，不過這不是這篇的重點所以跳過。</p>
<h1 id="更符合語意的寫法"><a href="#更符合語意的寫法" class="headerlink" title="更符合語意的寫法"></a>更符合語意的寫法</h1><p>如果有用過 <a target="_blank" rel="noopener" href="https://fluentassertions.com/">FluentAssertion</a>、<a target="_blank" rel="noopener" href="https://nsubstitute.github.io/">Nsubstitute</a> 等套件，應該會發現它 API 設計得非常好讀好懂</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">customer.Active.Should().BeTrue(because, becauseArgs);</span><br><span class="line"></span><br><span class="line">theObject.Should().NotBeSameAs(otherObject);</span><br></pre></td></tr></table></figure>

<p>讓程式不再是一段一段的，而是一看程式就能理解這邊在做什麼，而且也因為如此讓每個方法的職責更清楚單一，所以我們可以將上述的程式改成</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">//從使用端傳來一大批 Ids List</span></span><br><span class="line">	Ids.GetUser().NotInBlackList().WantToReceiveThisMessage(ThisMessageType).Record();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;User&gt; <span class="title">GetUser</span>(<span class="params"><span class="keyword">this</span> IEnumerable&lt;<span class="built_in">int</span>&gt; ids</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> temp = <span class="keyword">new</span> List&lt;<span class="built_in">int</span>&gt;();</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="keyword">var</span> id <span class="keyword">in</span> ids)</span><br><span class="line">	&#123;</span><br><span class="line">		temp.Add(id);</span><br><span class="line">		<span class="comment">// 假設每 1000 筆是有最好的搜尋效率</span></span><br><span class="line">		<span class="keyword">if</span> (temp.Count == <span class="number">1000</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">foreach</span> (<span class="keyword">var</span> user <span class="keyword">in</span> UserRepository.Get(temp))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">yield</span> <span class="keyword">return</span> user;</span><br><span class="line">			&#125;</span><br><span class="line">			temp.Clear();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (temp.Count &gt; <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">foreach</span> (<span class="keyword">var</span> user <span class="keyword">in</span> UserRepository.Get(temp))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">yield</span> <span class="keyword">return</span> user;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;User&gt; <span class="title">NotInBlackList</span>(<span class="params"><span class="keyword">this</span> IEnumerable&lt;User&gt; users</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="keyword">var</span> user <span class="keyword">in</span> users)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (user.InBlackList == <span class="literal">false</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">yield</span> <span class="keyword">return</span> user;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;User&gt; <span class="title">NotInBlackList</span>(<span class="params"><span class="keyword">this</span> IEnumerable&lt;User&gt; users, MessageType type</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="keyword">var</span> user <span class="keyword">in</span> users)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (user.BlockMessageType != type)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">yield</span> <span class="keyword">return</span> user;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IEnumerable&lt;User&gt; <span class="title">Record</span>(<span class="params"><span class="keyword">this</span> IEnumerable&lt;User&gt; users</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> temp = <span class="keyword">new</span> List&lt;User&gt;();</span><br><span class="line">	<span class="keyword">foreach</span> (<span class="keyword">var</span> user <span class="keyword">in</span> users)</span><br><span class="line">	&#123;</span><br><span class="line">		temp.Add(user);</span><br><span class="line">		<span class="keyword">if</span> (temp.Count == <span class="number">5000</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="comment">// Insert Log</span></span><br><span class="line">			LogRepository.Add(temp);</span><br><span class="line">			temp.Clear();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">yield</span> <span class="keyword">return</span> user;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (temp.Count &gt; <span class="number">5000</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		LogRepository.Add(temp);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>如果還需要紀錄每個過程的分別過濾的狀態，只需要在方法開個統計的物件參數，在每筆過程中做紀錄即可，不只讓整個程式可讀性更高、內聚更強，之後如果不想要紀錄或不想要過濾黑名單，也可以很快的調整完成</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ids.GetUser().WantToReceiveThisMessage(ThisMessageType);</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/03/01/centos_jenkins_hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/03/01/centos_jenkins_hexo/" class="post-title-link" itemprop="url">Jenkins,GitHub自動化部署Hexo</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-03-01 07:38:00" itemprop="dateCreated datePublished" datetime="2019-03-01T07:38:00+08:00">2019-03-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/03/01/centos_jenkins_hexo/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/01/centos_jenkins_hexo/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190301/0.png" alt="/images/20190301/0.png"></p>
<p>這個部落格是用 <a target="_blank" rel="noopener" href="https://hexo.io/zh-tw/index.html">hexo</a> 來製作的，優點是可以用 Markdown 寫法，且很多套件支援,讓我這個美感小白痴也可以輕鬆弄出富有質感的部落格(自己說)。</p>
<p>但也因為這樣,每次寫完文章都需要下 command 來編譯部落格、發佈到 Github ，讓我覺得不夠自動化</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> hexo g</span> </span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo deploy</span></span><br></pre></td></tr></table></figure>

<p>剛好最近在玩 AWS ，就想說來弄一台 t2.small Centos 機器來做 CI 機器好了</p>
<p><img src="/images/20190301/1.png" alt="/images/20190301/1.png"></p>
<br>

<h1 id="AWS-EC2"><a href="#AWS-EC2" class="headerlink" title="AWS EC2"></a>AWS EC2</h1><br>

<h2 id="Launch-Instance"><a href="#Launch-Instance" class="headerlink" title="Launch Instance"></a>Launch Instance</h2><p>AMI ： CentOS 7 </p>
<p><img src="/images/20190301/2.png" alt="/images/20190301/2.png"></p>
<p>Type ： t2.small </p>
<p><img src="/images/20190301/3.png" alt="/images/20190301/3.png"></p>
<p>原本用 t2.micro ，但經過測試在 Jenkins 執行 Job 的時候常常因為記憶體不足就當掉了，改 t2.small 後穩定許多</p>
<p>因為我之前已經有其他台 EC2 ，所以這邊我選擇用已經產過的 ssh key 來當作連線這台機器的 Key</p>
<p><img src="/images/20190301/4.png" alt="/images/20190301/4.png"> </p>
<br>

<h2 id="Security-Group"><a href="#Security-Group" class="headerlink" title="Security Group"></a>Security Group</h2><p>SSH 連線需要開 22 Port，先確認一下 Security Group 有開啟</p>
<p><img src="/images/20190301/5.png" alt="/images/20190301/5.png"> </p>
<p>用剛剛產出的 pem 檔連線到機器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh -i ~/.ssh/&#123;yourSSH.pem&#125; centos@&#123;yourEc2IP&#125;</span></span><br></pre></td></tr></table></figure>

<p>如果登入成功應該會看到這樣</p>
<p><img src="/images/20190301/6.png" alt="/images/20190301/6.png"> </p>
<p>如果遇到 Permission denied ，你需要先調整剛剛下載下來的 pem 檔的權限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> chmod 400 yourSSH.pem</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@<br>@         WARNING: UNPROTECTED PRIVATE KEY FILE!          @<br>@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@<br>Permissions 0644 for ‘amazonec2.pem’ are too open.<br>It is recommended that your private key files are NOT accessible by others.<br>This private key will be ignored.<br>bad permissions: ignore key: amazonec2.pem<br>Permission denied (publickey).</p>
</blockquote>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/8193768/trying-to-ssh-into-an-amazon-ec2-instance-permission-error">Trying to SSH into an Amazon Ec2 instance - permission error</a></p><p><a target="_blank" rel="noopener" href="http://linux.vbird.org/linux_basic/0210filepermission.php#chmod">鳥哥的 Linux 私房菜</a></p>
          </div>

<br>

<h1 id="Jenkins"><a href="#Jenkins" class="headerlink" title="Jenkins"></a>Jenkins</h1><br>

<h2 id="安裝"><a href="#安裝" class="headerlink" title="安裝"></a>安裝</h2><div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://linuxize.com/post/how-to-install-jenkins-on-centos-7/#adjust-the-firewall">How To Install Jenkins on CentOS 7</a></p>
          </div>

<blockquote>
<p>基本上我完全是按照上面的文章教學一步一步完成的，在 Linux 還不是很熟的情況下，這邊只記下流水帳，詳細建議參考上述文章。</p>
</blockquote>
<ol>
<li><p>Install the OpenJDK 8 package</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install java-1.8.0-openjdk-devel</span></span><br></pre></td></tr></table></figure></li>
<li><p>Import the GPG key </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --silent --location http://pkg.jenkins-ci.org/redhat-stable/jenkins.repo | sudo tee /etc/yum.repos.d/jenkins.repo</span></span><br></pre></td></tr></table></figure></li>
<li><p>Add the Jenkins repository to your system</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo rpm --import https://jenkins-ci.org/redhat/jenkins-ci.org.key</span></span><br></pre></td></tr></table></figure></li>
<li><p>Install Jenkins</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install jenkins</span></span><br></pre></td></tr></table></figure></li>
<li><p>Start the Jenkins service</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl start jenkins</span></span><br></pre></td></tr></table></figure></li>
<li><p>Check Jenkins Status</p>
</li>
</ol>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> systemctl status jenkins</span></span><br></pre></td></tr></table></figure>

<p>  <img src="/images/20190301/7.png" alt="/images/20190301/7.png"></p>
<ol start="7">
<li><p>Enable the Jenkins service to start on system boot</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo systemctl <span class="built_in">enable</span> jenkins</span></span><br></pre></td></tr></table></figure></li>
</ol>
<br>

<h2 id="設定"><a href="#設定" class="headerlink" title="設定"></a>設定</h2><p>這時候透過瀏覽器連線 Jenkins，應該會得到 Timeout 的回應</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">網址：http:&#x2F;&#x2F;yourEc2PublicIP:8080</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190301/8.png" alt="/images/20190301/8.png"></p>
<p>原因是機器的 Security Group 並沒有開放 80 Port 可以連進來，所以需要設定一下</p>
<p><img src="/images/20190301/9.png" alt="/images/20190301/9.png"></p>
<p>再次連線應該就可以看到設定畫面了</p>
<p><img src="/images/20190301/10.png" alt="/images/20190301/10.png"></p>
<br>

<p>第一次設定需要透過機器取得密碼</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo cat /var/lib/jenkins/secrets/initialAdminPassword</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/20190301/11.png" alt="/images/20190301/11.png"></p>
<p>將這段密碼貼上去後就可以進入下一步</p>
<p><img src="/images/20190301/12.png" alt="/images/20190301/12.png"></p>
<p>選擇 Install Suggested plugins</p>
<p><img src="/images/20190301/13.png" alt="/images/20190301/13.png"></p>
<p>設定 Admin User</p>
<p><img src="/images/20190301/14.png" alt="/images/20190301/14.png"></p>
<p><img src="/images/20190301/15.png" alt="/images/20190301/15.png"></p>
<h1 id="Hexo"><a href="#Hexo" class="headerlink" title="Hexo"></a>Hexo</h1><br>

<h2 id="安裝-Nodejs-、-NPM"><a href="#安裝-Nodejs-、-NPM" class="headerlink" title="安裝 Nodejs 、 NPM"></a>安裝 Nodejs 、 NPM</h2><p>為了能在 Jenkins Build Hexo ，必須先安裝好 NodeJs 並安裝 Hexo</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://linuxize.com/post/how-to-install-node-js-on-centos-7/">How to install Node.js and npm on CentOS 7</a></p>
          </div>

<blockquote>
<p>這邊一樣只節錄流水帳，詳細說明建議參考原文</p>
</blockquote>
<ol>
<li><p>Add NodeSource yum repository</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl -sL https://rpm.nodesource.com/setup_10.x | sudo bash -</span></span><br></pre></td></tr></table></figure></li>
<li><p>Install NodeJs and NPM</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install nodejs</span></span><br></pre></td></tr></table></figure></li>
<li><p>Check</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> node --version</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm --version</span></span><br></pre></td></tr></table></figure></li>
</ol>
<br>

<h2 id="Install-Git"><a href="#Install-Git" class="headerlink" title="Install Git"></a>Install Git</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo yum install git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> git --version</span></span><br></pre></td></tr></table></figure>

<br>

<h2 id="Build-Hexo"><a href="#Build-Hexo" class="headerlink" title="Build Hexo"></a>Build Hexo</h2><p>因為我原本就已經有 Hexo Blog Repository，所以我該先讓 Jenkins 機器能夠從 pull blog source</p>
<ol>
<li><p>建立 ssh key</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> ssh-keygen</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/20190301/16.png" alt="/images/20190301/16.png"></p>
</li>
<li><p>Add this ssh public key to github </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat ~/.ssh/id_rsa.pub</span></span><br></pre></td></tr></table></figure>

<p>將這整段 Public Key 加到 Github </p>
<p><img src="/images/20190301/17.png" alt="/images/20190301/17.png"></p>
<p><img src="/images/20190301/18.png" alt="/images/20190301/18.png"></p>
</li>
<li><p>Install Hexo</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo npm install hexo-cli -g</span></span><br></pre></td></tr></table></figure></li>
<li><p>Test git clone and hexo build</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> git <span class="built_in">clone</span> git@github.com:yourRepository/yourRepository.github.io.source.git</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">cd</span> yourRepository</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> npm install</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo g</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> hexo server</span></span><br></pre></td></tr></table></figure>

<p>如果到這邊都正常，基本上 Jenkins 機器已經有能力幫你 Build Hexo了</p>
</li>
</ol>
<br>

<h1 id="Create-Jenkins-Job"><a href="#Create-Jenkins-Job" class="headerlink" title="Create Jenkins Job"></a>Create Jenkins Job</h1><ol>
<li><p>新增作業</p>
<p><img src="/images/20190301/19.png" alt="/images/20190301/19.png"></p>
</li>
<li><p>原始碼管理</p>
<p><img src="/images/20190301/20.png" alt="/images/20190301/20.png"></p>
</li>
<li><p>設置 Credentials（點選 Add &gt; Jenkins） </p>
<p>將 Private Key 貼進去</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cat ~/.ssh/id_rsa</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/20190301/21.png" alt="/images/20190301/21.png"></p>
<p>連線就正常了</p>
<p><img src="/images/20190301/22.png" alt="/images/20190301/22.png"></p>
</li>
<li><p>建置觸發程序</p>
<p><img src="/images/20190301/23.png" alt="/images/20190301/23.png"></p>
</li>
<li><p>建置</p>
<p><img src="/images/20190301/24.png" alt="/images/20190301/24.png"></p>
</li>
</ol>
<br>

<h1 id="Github-Webhook"><a href="#Github-Webhook" class="headerlink" title="Github Webhook"></a>Github Webhook</h1><p>這邊是要設定，當 Github 發現 Repository 被更新時，主動打個 Request 觸發剛剛建立好的 Jenkins</p>
<ol>
<li><p>先進到 Your Repository &gt; Settings &gt; Webhooks</p>
<p><img src="/images/20190301/25.png" alt="/images/20190301/25.png"></p>
</li>
<li><p>Add Webhooks</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;yourEc2PublicIP:8080&#x2F;github-webhook&#x2F;</span><br></pre></td></tr></table></figure>

<p>請特別注意！！ github-webhook/ 後面這個斜線一定要，不然會 302 錯誤</p>
<p><img src="/images/20190301/26.png" alt="/images/20190301/26.png"></p>
</li>
</ol>
<h1 id="錯誤排除"><a href="#錯誤排除" class="headerlink" title="錯誤排除"></a>錯誤排除</h1><p>看似一切美好又順利的把 Webhooks 接了起來，但觸發 Jenkins 後發現以下錯誤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">INFO  Deploying: git</span><br><span class="line">Permission denied (publickey).</span><br><span class="line">fatal: Could not read from remote repository.</span><br></pre></td></tr></table></figure>

<p>為什麼 ？ 剛剛不是遠端登進去都試過跟 Git 之前的操作沒問題嗎？</p>
<p>原來是因為剛剛的 SSH Key 是建立在 centos 這個登入帳號底下，Jenkins 是透過自己的帳號權限在執行，所以我們必須將剛剛的SSH Key 搬過去給你，並賦予它權限</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> cp ~/.ssh/id_rsa.pub /var/lib/jenkins/.ssh/</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> cp ~/.ssh/id_rsa /var/lib/jenkins/.ssh/</span></span><br></pre></td></tr></table></figure>

<p>移過去後還需要將檔案擁有者改成 Jenkins，或是你可以針對 Jenkins 這跟帳號設定檔案權限，我這邊選擇直接把擁有者改成 Jenkins</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo chown jenkins /var/lib/jenkins/.ssh/id_rsa.pub</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> sudo chown jenkins /var/lib/jenkins/.ssh/id_rsa</span></span><br></pre></td></tr></table></figure>

<p>確認權限都正確就大功告成啦！！</p>
<p><img src="/images/20190301/27.png" alt="/images/20190301/27.png"></p>
<br>

<p>現在你看到的這篇，就是透過 Jenkins 自動建置部署上來的</p>
<br>



<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://www.mkshell.com/using-github-and-jenkins-deploy-hexo/">[小题大做] Github + Jenkins 实现自动化部署 hexo 博客静态文件</a></p>
          </div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/02/22/docker_debug_skill/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/22/docker_debug_skill/" class="post-title-link" itemprop="url">【Docker】偵錯技巧</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-02-22 16:48:00" itemprop="dateCreated datePublished" datetime="2019-02-22T16:48:00+08:00">2019-02-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/02/22/docker_debug_skill/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/22/docker_debug_skill/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190221/02/1.jpg" alt="/images/20190221/02/1.jpg"></p>
<p>學習 Docker 最先碰到的困擾應該都是<code>究竟該如何偵錯</code> ，畢竟 Docker Run Container 如果沒有下一些指令，通常都是執行完就砍掉，什麼都沒留下，不像在本機可以透過開發的 IDE、Log … 等手段來 Debug，所以這邊就寫下一些我較常使用的偵錯方式</p>
<br>

<h1 id="Run"><a href="#Run" class="headerlink" title="Run"></a>Run</h1><p>如果 Build Docker Image 時就有指定 CMD 或是 ENTRYPOINT，那 Container Run 起來後跑完就關掉了，這時候可以透過 Run 的最後一個參數來覆蓋過原本的 CMD 指令。 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it mcr.microsoft.com/windows/nanoserver:1809 cmd.exe</span><br></pre></td></tr></table></figure>

<p>這邊的 cmd.exe 就是要覆蓋 Build Image 所指定的指令，讓你可以進入 Container 的 terminal 中執行你想做的指令</p>
<div class="note info">
            <p><a target="_blank" rel="noopener" href="https://medium.freecodecamp.org/docker-entrypoint-cmd-dockerfile-best-practices-abc591c30e21">Docker ENTRYPOINT &amp; CMD: Dockerfile best practices</a></p>
          </div>

<br>

<h1 id="Volume"><a href="#Volume" class="headerlink" title="Volume"></a>Volume</h1><p>因為 Container 每次執行都是全新的，所以導致 Log 不易保留，但我們可以 Volume 的方式將 Host Folder 與 Container 內的 Log Folder Mount ，這樣就可以將 Container 內的 Log File 寫出來，達到持久化的效果。</p>
<p><img src="/images/20190221/02/2.png" alt="/images/20190221/02/2.png"></p>
<p>(圖片來源 : <a target="_blank" rel="noopener" href="https://docs.docker.com/storage/volumes/">Docker Docs</a> )</p>
<p>接著用簡單的範例來展示一下 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it mcr.microsoft.com/windows/nanoserver:1809 cmd.exe</span><br></pre></td></tr></table></figure>

<p>進到 Container 後，隨便寫個檔案</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir <span class="built_in">log</span></span><br><span class="line">$ <span class="built_in">cd</span> <span class="built_in">log</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hi&quot;</span> &gt;&gt; test.txt</span><br><span class="line">$ dir</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190221/02/3.png" alt="/images/20190221/02/3.png"></p>
<p>可以看到在 Container 內的確長出了 C:\log 資料夾，並且裡面有個 test.txt 的檔案，檔案裡面寫著 “hi”。但這時候你在 host 機器應該找不到對應的檔案，因為 Container 是彼此獨立且隔離的。</p>
<p>這時候離開 Container 再重啟一次，會發現剛剛 log 的 Folder 已經消失，因為這個 Container 是全新的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">exit</span></span><br><span class="line">$ docker run -it mcr.microsoft.com/windows/nanoserver:1809 cmd.exe</span><br><span class="line">$ dir</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190221/02/4.png" alt="/images/20190221/02/4.png"></p>
<br >

<p><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/volumes/">Volume</a> 使用方式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -v HostFolderPath:ContainerFolderPath </span><br></pre></td></tr></table></figure>

<p>加上 Volume 參數再重新執行一次剛剛的步驟</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it -v c:\files:c:\<span class="built_in">log</span> mcr.microsoft.com/windows/nanoserver:1809 cmd.exe</span><br></pre></td></tr></table></figure>

<p>將 Host 機器的 <code>c:\files</code> Folder Mount 到 Container 內的 <code>c:\log</code> 資料夾，所以在 Container 內新增檔案寫 Log 也會同時寫出來</p>
<p><img src="/images/20190221/02/5.png" alt="/images/20190221/02/5.png"></p>
<p>這邊應該會注意到，因為 Volume 了 Container 內原本不存在的 log 資料夾，所以一進去的時候它就長出來了，並不需要特別另外建立。</p>
<br>

<h1 id="EXEC"><a href="#EXEC" class="headerlink" title="EXEC"></a>EXEC</h1><p>有時候 Container 內執行的是常駐程式，它可能會持續執行直到任務完成，如果又沒有將 Log 寫出來的必要，其實很難知道它目前的狀況為何，這時候 <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/exec/">EXEC</a> 就派上用場了，它可以讓你進入一個正在執行中的 Container 中。</p>
<p>一樣用個簡單的範例來演練一下</p>
<p>先 Run 一個 Container 起來，並且一樣寫一個 log 下來</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it mcr.microsoft.com/windows/nanoserver:1809 cmd.exe</span><br><span class="line">$ mkdir <span class="built_in">log</span></span><br><span class="line">$ <span class="built_in">cd</span> <span class="built_in">log</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hi&quot;</span> &gt;&gt; test.txt</span><br><span class="line">$ dir</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190221/02/6.png" alt="/images/20190221/02/6.png"></p>
<p>這時候開另一個 terminal，先查詢剛剛的 Container ID</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker ps</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190221/02/7.png" alt="/images/20190221/02/7.png"></p>
<p>透過 EXEC 指定要執行哪個 Container</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it d24e6db4de85 cmd.exe</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190221/02/8.png" alt="/images/20190221/02/8.png"></p>
<p>可以看到一進去就已經有剛剛我們寫下的 test.txt，表示這是同一個 Container，或是可以透過 hostname 來做驗證，可以得到相同的 ID</p>
<p><img src="/images/20190221/02/9.png" alt="/images/20190221/02/9.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/02/21/dockerforwindows_vs_dockeronwindowserver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/21/dockerforwindows_vs_dockeronwindowserver/" class="post-title-link" itemprop="url">【Docker】Docker for Windows 和 Docker on Windows Server 一樣嗎?</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-02-21 10:36:00" itemprop="dateCreated datePublished" datetime="2019-02-21T10:36:00+08:00">2019-02-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/02/21/dockerforwindows_vs_dockeronwindowserver/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/21/dockerforwindows_vs_dockeronwindowserver/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190221/0.png" alt="/images/20190221/0.png"></p>
<p>一開始以為 Docker For Windows 跟 Windows Containers on Windows Server 是一樣的東西，結果在建置 CI 機器時碰到一些問題才發現原來是不同東西啊</p>
<br>

<h1 id="Docker-for-Windows"><a href="#Docker-for-Windows" class="headerlink" title="Docker for Windows"></a>Docker for Windows</h1><p>Docker for Windows 底層是透過 Hyper-V 來乘載 Docker Engine，也因為需要多一層 Hyper-V  ，所以執行效率比之後出的 Docker on Windows Server 直接原生 Docker Engine 效率來說差了一截，但也因為有 Hyper-V 的協助下，可切換成能執行 Linux Container 的模式。</p>
<p><img src="/images/20190221/1.png" alt="/images/20190221/1.png"></p>
<p> Windows 10 Professional 版本就可以安裝 ( 因為Professional 版本才有 Hyper-V )</p>
<p><img src="/images/20190221/2.png" alt="/images/20190221/2.png"></p>
<p>圖片來源 : <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/virtualization/windowscontainers/deploy-containers/linux-containers">Microsoft</a></p>
<div class="note info">
            <p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/virtualization/windowscontainers/quick-start/quick-start-windows-10">Windows 10 上的 Windows 容器</a></p><p><a target="_blank" rel="noopener" href="https://docs.docker.com/docker-for-windows/">Get started with Docker for Windows</a></p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/virtualization/windowscontainers/deploy-containers/linux-containers">Windows 上的 Linux 容器</a></p>
          </div>



<br>

<h1 id="Windows-Containers-on-Windows-Server"><a href="#Windows-Containers-on-Windows-Server" class="headerlink" title="Windows Containers on Windows Server"></a>Windows Containers on Windows Server</h1><div class="note info">
            <p><a target="_blank" rel="noopener" href="https://docs.docker.com/install/windows/docker-ee/">Install Docker Engine - Enterprise on Windows Servers</a></p>
          </div>

<p>Windows Server 2016 或更新的版本才可使用，直接在 OS 上執行 Docker Engine，所以效能比需要 Hyper-V 的 Docker for Windows 好上一大截，如果要跑 Linux 類的 Container 也可以透過 <code>--isolation=hyperv</code> 的方式，不過有個限制是這個方法不能在 VM 中用，也就是說如果你今天是用雲端的 Windows Server，本身已經是在 VM 裡面了，就無法在裡面執行 <code>isolation</code>。</p>
<p><img src="/images/20190221/3.png" alt="/images/20190221/3.png"></p>
<p>圖片來源 : <a target="_blank" rel="noopener" href="https://blogs.msdn.microsoft.com/msgulfcommunity/2015/06/20/what-is-windows-server-containers-and-hyper-v-containers/">MSDN</a></p>
<p>目前因為公司內部很多既有專案都是用 .Net Framework 開發的，所以轉移到 Container 也是選擇用 Windows Containers on Windows Server，畢竟如果是 Production Service，效能還是非常重要的一個考量</p>
<br>

<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://columns.chicken-house.net/2016/09/05/windows-container-faq/#q3-windows-container-%E8%83%BD%E5%9F%B7%E8%A1%8C%E7%8F%BE%E6%9C%89%E7%9A%84-docker-container-image-%E5%97%8E">Windows Container FAQ - 官網沒有說的事</a></p><p><a target="_blank" rel="noopener" href="https://blog.vizuri.com/docker-for-windows-vs.-docker-on-windows-server">Docker FOR Windows vs. Docker ON Windows Server - vizuri</a></p>
          </div>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/02/20/windows_container_dnsserver/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/20/windows_container_dnsserver/" class="post-title-link" itemprop="url">【Docker】Widows Container DNS Server 問題</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-02-20 15:10:00" itemprop="dateCreated datePublished" datetime="2019-02-20T15:10:00+08:00">2019-02-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/02/20/windows_container_dnsserver/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/20/windows_container_dnsserver/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190220/0.png" alt="/images/20190220/0.png"></p>
<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>Windows Container 執行起來的時候，DNS Server 預設會吃 Host 的設定，但第一組會擺 Default Gateway 的 IP</p>
<p><img src="/images/20190220/1.png" alt="/images/20190220/1.png"></p>
<p>但會碰到當在解析  IP 時，只會走第一組 Name Server 去問，如果問不到並不會問第二組，導致解析失敗</p>
<p><img src="/images/20190220/2.png" alt="/images/20190220/2.png"></p>
<p>(需明確指定 Name Server 才能查的到)</p>
<p>聽說這也是 Windows Container 才會碰到的問題，用 Linux 的同事們表示黑人問號 ???</p>
<br>

<h1 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h1><p>DotNet 人有 DotNet 人的玩法，果然找到有人有相同的問題</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://github.com/docker/for-win/issues/397">the –dns option is not working with windows container</a></p>
          </div>

<p>解法就是當 Container 執行起來的時候，用 Powershell 去改 DNS Server 設定 ….</p>
<p>恩 …. 就改吧</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ powershell  Set-DnsClientServerAddress -InterfaceAlias vEthernet* -ServerAddresses 10.2.x.x,10.2.x.x</span><br></pre></td></tr></table></figure>

<p>執行完後重新查詢網路設定會看到 DNS Server 第一組已經不是 Default Gateway</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ipconfig /all</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190220/4.png" alt="/images/20190220/4.png"></p>
<p>這時候在重新查一次 IP ，不用特別指定 Name Server 就正確了</p>
<p><img src="/images/20190220/3.png" alt="/images/20190220/3.png"></p>
<h1 id="同場加映"><a href="#同場加映" class="headerlink" title="同場加映"></a>同場加映</h1><p>這邊特別介紹 <a target="_blank" rel="noopener" href="https://docs.docker.com/v17.09/engine/userguide/networking/default_network/configure-dns/">dns_search</a> 這個 docker 參數</p>
<p><img src="/images/20190220/5.png" alt="/images/20190220/5.png"></p>
<p>因為公司測試機都有加入 AD 群組，所以伺服器別名即便不寫全名還是可以查的到，但在 Container 內就不是這麼回事了，必須寫完整的全名不可，原本以為要改 Config ，請大家都寫完整，還好同事提醒有這個參數可以使用。</p>
<p>只要在 Docker Run 時或是 Docker Compose 設定加上 Domain Name，這樣 Container 找不到時就會加上 Domain Name 在完整搜尋一次</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">dns_search:</span> <span class="string">your.domain</span></span><br></pre></td></tr></table></figure>



<p>這參數又拯救了 IT 狗的一天…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/02/19/windows_contianer_iamrole_/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/02/19/windows_contianer_iamrole_/" class="post-title-link" itemprop="url">【Docker】Widows Container IAM Role 問題</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-02-19 16:25:00" itemprop="dateCreated datePublished" datetime="2019-02-19T16:25:00+08:00">2019-02-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/02/19/windows_contianer_iamrole_/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/19/windows_contianer_iamrole_/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190219/0.png" alt="/images/20190219/0.png"></p>
<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>通常在使用 EC2 的建議上都是希望將機器掛上 IAM Role 的權限，在機器上面執行相關 AWS 資源時就可以透過該角色的權限來執行，避免將 Access Toke 、Secret Key 寫到程式中去跑。</p>
<p>但如果將程式包到 Container 裡面去執行時卻發現，Linux Container 可以吃到 Host 的 IAM Role 權限，而 Windows Container 卻不行，為何 ?</p>
<br>

<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p>原來 AWS 之所以能夠讓機器能知道執行權限為何是否過一個叫 Metadata Service 的服務來達成 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl 169.254.169.254</span><br></pre></td></tr></table></figure>

<p>當在 EC2 上執行該指令應該能看到基本的回應</p>
<p><img src="/images/20190219/1.png" alt="/images/20190219/1.png"></p>
<p>連線到 <code>http://169.254.169.254/latest/meta-data/</code> 也可以看到一些對應的 Metadata 設定，而這個 Metadata Service IP 很巧的在 Azure 上也一模一樣 XD</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html">Instance Metadata and User Data</a></p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/azure/virtual-machines/windows/instance-metadata-service">Azure 執行個體中繼資料服務</a></p>
          </div>

<br>

<p>所以要能夠透過 IAM Role 的權限來執行 AWS 相關資源，169.254.169.254 就勢必要能通，接著將 Windows Container Run起來並執行相同指令會發現得到 Timeout 的回應</p>
<p><img src="/images/20190219/2.png" alt="/images/20190219/2.png"></p>
<br>

<p>Windows Container 預設是走 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E7%BD%91%E7%BB%9C%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2">NAT</a> 的網路模式，如果你在 Host 與 Windows Container 內列出 Routing Table IPv4 的資料會發現，169.254.169.254 Gateway 是走同一條</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ route <span class="built_in">print</span> -4</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/3.png" alt="/images/20190219/3.png"></p>
<p>這也是導致 Container 內得不到回應的原因</p>
<p><img src="/images/20190219/11.png" alt="/images/20190219/11.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ ipconfig /all</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/4.png" alt="/images/20190219/4.png"></p>
<p>應該透過 NAT Router default gateway 才出的去</p>
<p><img src="/images/20190219/12.png" alt="/images/20190219/12.png"></p>
<br>

<h1 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h1><p>先看看預設 Container 用的網路是如何設定的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network ls</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/5.png" alt="/images/20190219/5.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network inspect nat</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/6.png" alt="/images/20190219/6.png"></p>
<p>可以看到紅框處並沒有指定 Default Gateway，所以每次執行 Container 時都是動態分配 Subnet 與 Default Gateway，這樣讓我們設定上會有困難</p>
<br>

<h2 id="自建一組網路給-Container-使用"><a href="#自建一組網路給-Container-使用" class="headerlink" title="自建一組網路給 Container 使用"></a>自建一組網路給 Container 使用</h2><p>可以透過 <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/network_create/">Docker network create</a> 來預先建立一組規範好的網路，並讓 Container 起起來的時候指定吃這組設定</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker network create --driver nat --gateway 172.17.0.1 --subnet 172.17.0.0/20 mynetwork</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/7.png" alt="/images/20190219/7.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ docker run -it --rm --network mynetwork mycontainer:latest</span><br></pre></td></tr></table></figure>



<p>檢視 Container 起來後網路設定狀況，可以看到 Default Gateway 已經被定下來了</p>
<p><img src="/images/20190219/8.png" alt="/images/20190219/8.png"></p>
<p>接著執行 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ route -p add 169.254.169.254 172.17.0.1</span><br></pre></td></tr></table></figure>

<p><img src="/images/20190219/9.png" alt="/images/20190219/9.png"></p>
<p><img src="/images/20190219/10.png" alt="/images/20190219/10.png"></p>
<p>至於 route add 怎麼在 Container 起起來時自動執行那就是另一個課題了，這邊不討論</p>
<h2 id="Docker-compose-動態建網路給-Container-使用"><a href="#Docker-compose-動態建網路給-Container-使用" class="headerlink" title="Docker compose 動態建網路給 Container 使用"></a>Docker compose 動態建網路給 Container 使用</h2><p>第二種方法是透過 Docker compose 執行時動態建立一組網路來使用，方法大同小異，只是透過 Docker Compose 來設定而已</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;2.1&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mycontainer:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mycontainer:latest</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mynetwork</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">mynetwork:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">nat</span></span><br><span class="line">    <span class="attr">ipam:</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">subnet:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.0</span><span class="string">/20</span></span><br><span class="line">          <span class="attr">gateway:</span> <span class="number">172.17</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">      </span><br></pre></td></tr></table></figure>



<h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>最近跟著架構師還有一群很厲害的同事做新的專案，發現自己對於 Infra 與網路的知識真的相當不足，所以在Docker 一些設定與建置上常常卡的亂七八糟，也趁著這個機會把以前一堆已經還老師的知識又惡補了一翻，希望能越來越順利 </p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://www.speedoflightmedia.com/blog/aws-iam-roles-windows-containers/">AWSS IAM Roles in Windows Containers</a></p><p><a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E4%BF%9D%E7%95%99IP%E5%9C%B0%E5%9D%80">wiki - 保留IP位址</a></p>
          </div>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Toyo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">203</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">75</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Toyo</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://toyo0103.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
