<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"toyo0103.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="程式隨筆">
<meta property="og:url" content="https://toyo0103.github.io/page/12/index.html">
<meta property="og:site_name" content="程式隨筆">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Toyo">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://toyo0103.github.io/page/12/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>程式隨筆</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程式隨筆" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程式隨筆</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/01/20/Async-Await-DeadLock%E5%95%8F%E9%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/20/Async-Await-DeadLock%E5%95%8F%E9%A1%8C/" class="post-title-link" itemprop="url">Async Await DeadLock問題</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-01-20 14:52:00" itemprop="dateCreated datePublished" datetime="2016-01-20T14:52:00+08:00">2016-01-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/01/20/Async-Await-DeadLock%E5%95%8F%E9%A1%8C/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/20/Async-Await-DeadLock問題/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>之前寫了一個簡單上傳圖片的功能，碰到用await跟async非同執行的問題，本來在本機Visual Studio偵錯執行Run都好好的，但是放到線上後就永遠得不到回應TimeOut</p>
<p>隱隱約約記得之前黑大寫過類似的文章，當時看過沒啥特別感覺，翻回來看後在實際操作後終於弄懂了(果然寫程式很多地方一知半解會GG的)，關於Async、Await這些推薦可以看這兩篇文章</p>
<p><a target="_blank" rel="noopener" href="http://huan-lin.blogspot.com/2016/01/async-and-await.html">Huan-Lin 學習筆記-async 與 await</a><br><a target="_blank" rel="noopener" href="http://blog.darkthread.net/post-2015-08-06-await-task-block-deadlock.aspx">黑暗執行緒-&nbsp;await與Task.Result/Task.Wait()的Deadlock問題</a></p>
<p>兩位前輩大大已經寫的很完整詳盡了，在這邊就不獻醜了，只簡單提供個範例給有興趣的人玩玩</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DeadLockController</span> : <span class="title">ApiController</span></span><br><span class="line">    &#123;</span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        [<span class="meta">Route(<span class="meta-string">&quot;api/DeadLock/Index&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> HttpResponseMessage <span class="title">Index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Task&lt;<span class="built_in">int</span>&gt; mytask = Go();</span><br><span class="line">            mytask.Wait();</span><br><span class="line">            <span class="keyword">return</span> Request.CreateResponse(mytask.Result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        [<span class="meta">Route(<span class="meta-string">&quot;api/DeadLock&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> HttpResponseMessage <span class="title">DeadLock</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = Go().Result;</span><br><span class="line">            <span class="keyword">return</span> Request.CreateResponse(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        [<span class="meta">Route(<span class="meta-string">&quot;api/DeadLock/NoDeadLock&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task&lt;HttpResponseMessage&gt; <span class="title">NoDeadLock</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="keyword">await</span> Go();</span><br><span class="line">            <span class="keyword">return</span> Request.CreateResponse(result);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">async</span> Task&lt;<span class="built_in">int</span>&gt; <span class="title">Go</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="built_in">int</span> res = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">await</span> Task.Run(() =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//假裝執行某個耗時程序後取得結果</span></span><br><span class="line">                Task.Delay(<span class="number">1000</span>);</span><br><span class="line">                res = <span class="number">32767</span>;</span><br><span class="line">            &#125;);</span><br><span class="line">            <span class="keyword">return</span> res;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這邊只有NoDeadLock那個Action的寫法才不會DeadLock,其餘兩個永遠都不會得到回應，原因簡單的說就是在<span style="color: red;">Web中</span>**(特別強調在Web中，因為Console並不會)**，.Result 與 Wait()的方法都會鎖定目前的Thread等待結果回應再繼續執行，而上面的範例GO()這個Method在Web中會記住是哪個Thread來呼叫他的，以便他執行完後回應該Thread結果繼續執行。</p>
<p>這時候就會發生DeadLock了，因為外面用Wait() or .Result鎖住當前Thread，GO()這個Method又在等待他被釋放好跟他回應結果，互相等待也就DeadLock了。</p>
<p>前面兩篇文章很久以前就看過了，只是當時沒有特別放在心上，直到被這個簡單到只有5行Code的東西困擾了3~4天，才終於想到有這件事情，現在不懂沒關係，等到被鎖一次就懂了(吶喊!!)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/01/11/Linq-%E5%8B%95%E6%85%8B%E7%B5%84%E5%90%88Linq%E6%A2%9D%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/01/11/Linq-%E5%8B%95%E6%85%8B%E7%B5%84%E5%90%88Linq%E6%A2%9D%E4%BB%B6/" class="post-title-link" itemprop="url">[Linq]動態組合Linq條件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-01-11 15:11:00" itemprop="dateCreated datePublished" datetime="2016-01-11T15:11:00+08:00">2016-01-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/01/11/Linq-%E5%8B%95%E6%85%8B%E7%B5%84%E5%90%88Linq%E6%A2%9D%E4%BB%B6/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/01/11/Linq-動態組合Linq條件/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>以前寫Linq的時候常常碰到一個問題,就是判斷一個條件是否達成來決定Linq的Where條件該如何組合,<br>例如:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="built_in">bool</span> Flag = <span class="literal">true</span>;</span><br><span class="line"> List&lt;DealDataForGov&gt; SourceData = <span class="keyword">new</span> List&lt;DealDataForGov&gt;</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">new</span> DealDataForGov</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;台北市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;a1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2015</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">new</span> DealDataForGov</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;高雄市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;a1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2016</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">new</span> DealDataForGov</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;台中市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;c1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2014</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (Flag)</span><br><span class="line"> &#123;</span><br><span class="line">  SourceData.Where((x) =&gt; x.HouseKind == <span class="string">&quot;a1&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span> </span><br><span class="line"> &#123;</span><br><span class="line">  <span class="comment">//因為某個條件,新增新的搜尋條件</span></span><br><span class="line">  SourceData.Where((x) =&gt; x.HouseKind ==<span class="string">&quot;a1&quot;</span> &amp;&amp; x.Year &gt;= <span class="number">2015</span> );</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DealDataForGov</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> Address &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> HouseKind &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">int</span> Year &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>條件少還算好寫，一旦條件落落長的時候就會貼的到處都是，不僅彈性降低也讓維護增加困難度，還好在黑大那邊看到LINQKIT這個好東西<a target="_blank" rel="noopener" href="http://blog.darkthread.net/post-2015-10-23-linqkit.aspx">黑暗執行緒-組裝動態LINQ條件的利器－LINQKit</a></p>
<p>以下簡短介紹一下這個<a target="_blank" rel="noopener" href="https://www.nuget.org/packages/LinqKit/">LINQKit</a>的套件，有了他之後感覺Code都活過來了XD<br>範例:</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> List&lt;TargetModel&gt; SourceData = <span class="keyword">new</span> List&lt;TargetModel&gt;</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">new</span> TargetModel</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;台北市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;a1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2015</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">new</span> TargetModel</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;高雄市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;a1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2016</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="keyword">new</span> TargetModel</span><br><span class="line">  &#123;</span><br><span class="line">   Address = <span class="string">&quot;台中市xxxx&quot;</span>,</span><br><span class="line">   HouseKind = <span class="string">&quot;c1&quot;</span>,</span><br><span class="line">   Year = <span class="number">2014</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> expression = GetWhereExpression();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//SourceData.Where((x) =&gt; x.HouseKind == &quot;a1&quot;);</span></span><br><span class="line"> <span class="keyword">var</span> e1 = SourceData.Where(expression.Compile());</span><br><span class="line"> e1.Dump();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//SourceData.Where((x) =&gt; x.HouseKind ==&quot;a1&quot; &amp;&amp; x.Year &gt; 2015 );</span></span><br><span class="line"> <span class="keyword">var</span> e2 = SourceData.Where(expression.And(x =&gt; x.Year &gt; <span class="number">2015</span>).Compile());</span><br><span class="line"> e2.Dump();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//SourceData.Where((x) =&gt; x.HouseKind ==&quot;a1&quot; || x.Year &gt;=2014 );</span></span><br><span class="line"> <span class="keyword">var</span> e3 = SourceData.Where(expression.Or(x =&gt; x.Year &gt;= <span class="number">2014</span>).Compile());</span><br><span class="line"> e3.Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Expression&lt;Func&lt;TargetModel, <span class="built_in">bool</span>&gt;&gt; GetWhereExpression()</span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">var</span> pred = PredicateBuilder.True&lt;TargetModel&gt;();</span><br><span class="line">  pred = pred.And(x=&gt; x.HouseKind ==<span class="string">&quot;a1&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> pred;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TargetModel</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> Address &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> HouseKind &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">int</span> Year &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上面有三個範例分別是替代掉註解的寫法,如果有碰到很多條件會動態產生的結果,用LinqKit可以大幅度省掉很多Code以及維護上的複雜度。算是非常好用的小物，推薦給大家</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2015/12/14/%E3%80%90SQL%E3%80%91%E9%81%9E%E8%BF%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2015/12/14/%E3%80%90SQL%E3%80%91%E9%81%9E%E8%BF%B4/" class="post-title-link" itemprop="url">【SQL】遞迴</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-12-14 10:08:00" itemprop="dateCreated datePublished" datetime="2015-12-14T10:08:00+08:00">2015-12-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2015/12/14/%E3%80%90SQL%E3%80%91%E9%81%9E%E8%BF%B4/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/14/【SQL】遞迴/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>有張表格如下，Parent欄位代表他的父層的RegionID，所以裡面包含所有縣市、行政區、鄉里等資料，那要如何用SQL遞迴的方式把台北市用階層的方式表列出來呢?<br>台北市 &gt; 信義區、大安區、中正區…. &gt;&nbsp;港華里、老泉里…..</p>
<p><a target="_blank" rel="noopener" href="http://4.bp.blogspot.com/-ezOt-MPBhp8/Vm4i1FAr5_I/AAAAAAAAHq8/GEW1WgWPjps/s1600/1.png"><img src="http://4.bp.blogspot.com/-ezOt-MPBhp8/Vm4i1FAr5_I/AAAAAAAAHq8/GEW1WgWPjps/s1600/1.png"></a></p>
<p>用CTE的寫法可以解決，把台北市當做茅點，然後Join自己即可達到遞迴的效果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> 遞迴 <span class="keyword">as</span>(</span><br><span class="line"><span class="comment">------茅點 start-------</span></span><br><span class="line"><span class="keyword">SELECT</span> RegionID , Name</span><br><span class="line"><span class="keyword">FROM</span> Region a</span><br><span class="line"><span class="keyword">WHERE</span> RegionID <span class="operator">=</span> <span class="number">1</span> <span class="comment">--台北市</span></span><br><span class="line"><span class="comment">------茅點 end ---------</span></span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span> b.RegionID , b.name</span><br><span class="line"><span class="keyword">from</span> Region b</span><br><span class="line"><span class="keyword">join</span> 遞迴 <span class="keyword">on</span>  b.Parent <span class="operator">=</span> 遞迴.RegionID</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 遞迴</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>搜尋出來的結果<br><a target="_blank" rel="noopener" href="http://4.bp.blogspot.com/-SGZfLH0gsGo/Vm4kfeQCk6I/AAAAAAAAHrI/M3N0VaRWT-8/s1600/1.png"><img src="http://4.bp.blogspot.com/-SGZfLH0gsGo/Vm4kfeQCk6I/AAAAAAAAHrI/M3N0VaRWT-8/s1600/1.png"></a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2015/12/14/%E3%80%90WebAPI%E3%80%91Custom-ActionFilter-Order/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2015/12/14/%E3%80%90WebAPI%E3%80%91Custom-ActionFilter-Order/" class="post-title-link" itemprop="url">【WebAPI】Custom ActionFilter Order</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-12-14 10:08:00" itemprop="dateCreated datePublished" datetime="2015-12-14T10:08:00+08:00">2015-12-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2015/12/14/%E3%80%90WebAPI%E3%80%91Custom-ActionFilter-Order/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/14/【WebAPI】Custom-ActionFilter-Order/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ActionAttribute"><a href="#ActionAttribute" class="headerlink" title="ActionAttribute"></a>ActionAttribute</h1><div class="note info">
            <p>環境 : WebAPI 2.2 <a target="_blank" rel="noopener" href="http://www.asp.net/web-api/overview/releases/whats-new-in-aspnet-web-api-22">詳細</a></p>
          </div>

<p>在WebAPI中，通常都繪有需要客製化ActionFilter的情況發生</p>
<p><img src="https://3.bp.blogspot.com/-tfA3HwTsUBA/VnIwd3pjxiI/AAAAAAAAHrc/qzbMwEmMBb4/s1600/1.png"></p>
<h2 id="執行順序不固定"><a href="#執行順序不固定" class="headerlink" title="執行順序不固定"></a>執行順序不固定</h2><p>ActionFilter的執行順序並非在上面的就優先執行，Filter有個FilterScope來表示他屬於何種層級的ActionFilter，執行順序依次是 Global , Controller , Action 。但如果是在同一層級的ActionFilter順序則未必按照固定。 </p>
<p><img src="https://2.bp.blogspot.com/-vZ-NniyEom4/VnIx1sGnvcI/AAAAAAAAHro/-ykVRvzvq3Y/s1600/1.png" alt="https://2.bp.blogspot.com/-vZ-NniyEom4/VnIx1sGnvcI/AAAAAAAAHro/-ykVRvzvq3Y/s1600/1.png">]</p>
<h2 id="測試"><a href="#測試" class="headerlink" title="測試"></a>測試</h2><p><img src="https://4.bp.blogspot.com/-LiCgWC_Ob3M/VnIyiMCn0nI/AAAAAAAAHr0/H58PiNpUUvA/s1600/1.png" alt="https://4.bp.blogspot.com/-LiCgWC_Ob3M/VnIyiMCn0nI/AAAAAAAAHr0/H58PiNpUUvA/s1600/1.png"></p>
<p>裡面全部都一樣繼承ActionFilterAttribute即可</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FourAttribute</span> :<span class="title">ActionFilterAttribute</span>&#123; &#125;</span><br></pre></td></tr></table></figure>
<p>註冊OneAttribute到Global<br><img src="https://2.bp.blogspot.com/-oCMhVi2M5_w/VnIzKgzvzrI/AAAAAAAAHsA/e9vuB3fiZE4/s1600/1.png" alt="https://2.bp.blogspot.com/-oCMhVi2M5_w/VnIzKgzvzrI/AAAAAAAAHsA/e9vuB3fiZE4/s1600/1.png"></p>
<p>將其它Attribute分別註冊到Controller與Action<br><img src="https://1.bp.blogspot.com/-VZm61VIoQZY/VnIzc88dwGI/AAAAAAAAHsM/piz8hD4vdXo/s1600/1.png" alt="https://1.bp.blogspot.com/-VZm61VIoQZY/VnIzc88dwGI/AAAAAAAAHsM/piz8hD4vdXo/s1600/1.png"></p>
<p>在Get中補上以下程式然後執行看看</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet</span>]</span><br><span class="line">[<span class="meta">Three</span>]</span><br><span class="line">[<span class="meta">Four</span>]</span><br><span class="line"><span class="keyword">public</span> IEnumerable&lt;Tuple&lt;<span class="built_in">string</span>,<span class="built_in">string</span>&gt;&gt; Get()</span><br><span class="line">&#123;</span><br><span class="line">    IHttpActionSelector actionSelector =</span><br><span class="line">        <span class="keyword">this</span>.Configuration.Services.GetActionSelector();</span><br><span class="line"> </span><br><span class="line">    HttpActionDescriptor actionDescriptor =</span><br><span class="line">        actionSelector.SelectAction(<span class="keyword">this</span>.ControllerContext);</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">foreach</span> (FilterInfo filterInfo <span class="keyword">in</span> actionDescriptor.GetFilterPipeline())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">Tuple</span>&lt;<span class="title">string</span>, <span class="title">string</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            filterInfo.Instance.GetType(</span>).Name,</span></span><br><span class="line"><span class="function">            filterInfo.Scope.<span class="title">ToString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">        )</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="測試結果"><a href="#測試結果" class="headerlink" title="測試結果"></a>測試結果</h2><p><img src="https://2.bp.blogspot.com/-ExqARkhthR8/VnI0IaZEwvI/AAAAAAAAHsY/iSNXKBQFZF0/s1600/1.png" alt="https://2.bp.blogspot.com/-ExqARkhthR8/VnI0IaZEwvI/AAAAAAAAHsY/iSNXKBQFZF0/s1600/1.png"></p>
<p>排序依據所對應的層級，雖然這邊排序與我們在程式上的排序相同。但實際上順序同層級的順序未必是由上而下，為了避免這樣的問題，最好的方法就是在ActionFilter加上排序的屬性來解決。</p>
<h2 id="實作Order屬性"><a href="#實作Order屬性" class="headerlink" title="實作Order屬性"></a>實作Order屬性</h2><h3 id="定義IOrderAttribute"><a href="#定義IOrderAttribute" class="headerlink" title="定義IOrderAttribute"></a>定義IOrderAttribute</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IOrderAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="built_in">int</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">FourAttribute</span> : <span class="title">ActionFilterAttribute</span>, <span class="title">IOrderAttribute</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="built_in">int</span> Order &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="實做IComparable介面"><a href="#實做IComparable介面" class="headerlink" title="實做IComparable介面"></a>實做IComparable介面</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomFilterInfo</span> : <span class="title">IComparable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">public</span> IFilter Instance &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="keyword">public</span> FilterScope Scope &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">//FilterInfo</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">CustomFilterInfo</span>(<span class="params">IFilter instance, FilterScope scope</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.Instance = instance;</span><br><span class="line">            <span class="keyword">this</span>.Scope = scope;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="built_in">int</span> <span class="title">CompareTo</span>(<span class="params"><span class="built_in">object</span> obj</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (obj <span class="keyword">is</span> CustomFilterInfo)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> item = obj <span class="keyword">as</span> CustomFilterInfo;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">if</span> (item.Instance <span class="keyword">is</span> IAttribute)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> attr = item.Instance <span class="keyword">as</span> IAttribute;</span><br><span class="line">                    <span class="keyword">return</span> (<span class="keyword">this</span>.Instance <span class="keyword">as</span> IAttribute).Order.CompareTo(attr.Order);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"> </span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="function"><span class="keyword">public</span> FilterInfo <span class="title">ConvertToFilterInfo</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> FilterInfo(<span class="keyword">this</span>.Instance, <span class="keyword">this</span>.Scope);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="實做IFilterProvider介面"><a href="#實做IFilterProvider介面" class="headerlink" title="實做IFilterProvider介面"></a>實做IFilterProvider介面</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CustomFilterProvider</span> : <span class="title">IFilterProvider</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> IEnumerable&lt;FilterInfo&gt; <span class="title">GetFilters</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">        HttpConfiguration configuration, </span></span></span><br><span class="line"><span class="function"><span class="params">        HttpActionDescriptor actionDescriptor</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        IEnumerable&lt;CustomFilterInfo&gt; customActionFilters =</span><br><span class="line">            actionDescriptor.GetFilters()</span><br><span class="line">                            .Select(i =&gt; <span class="keyword">new</span> CustomFilterInfo(i, FilterScope.Controller));</span><br><span class="line"> </span><br><span class="line">        IEnumerable&lt;CustomFilterInfo&gt; customControllerFilters =</span><br><span class="line">            actionDescriptor.ControllerDescriptor</span><br><span class="line">                            .GetFilters()</span><br><span class="line">                            .Select(i =&gt; <span class="keyword">new</span> CustomFilterInfo(i, FilterScope.Controller));</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> customControllerFilters.Concat(customActionFilters)</span><br><span class="line">                                      .OrderBy(i =&gt; i)</span><br><span class="line">                                      .Select(i =&gt; i.ConvertToFilterInfo());</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Global註冊"><a href="#Global註冊" class="headerlink" title="Global註冊"></a>Global註冊</h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">Application_Start</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    AreaRegistration.RegisterAllAreas();</span><br><span class="line">    GlobalConfiguration.Configure(WebApiConfig.Register);</span><br><span class="line">    FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters);</span><br><span class="line">    GlobalConfiguration.Configuration.Formatters.XmlFormatter.SupportedMediaTypes.Clear();</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//註冊Global Attribute</span></span><br><span class="line">    GlobalConfiguration.Configuration.Filters.Add(<span class="keyword">new</span> OneAttribute());</span><br><span class="line"> </span><br><span class="line">     </span><br><span class="line">    <span class="comment">//新增CustomFilterProvider</span></span><br><span class="line">    GlobalConfiguration.Configuration.Services.Add(</span><br><span class="line">        <span class="keyword">typeof</span>(System.Web.Http.Filters.IFilterProvider), <span class="keyword">new</span> CustomFilterProvider());</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> providers = GlobalConfiguration.Configuration.Services.GetFilterProviders();</span><br><span class="line">    <span class="keyword">var</span> defaultprovider = providers.First(i =&gt; i <span class="keyword">is</span> ActionDescriptorFilterProvider);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//移除DefaultProvider</span></span><br><span class="line">    GlobalConfiguration.Configuration.Services.Remove(</span><br><span class="line">        <span class="keyword">typeof</span>(System.Web.Http.Filters.IFilterProvider),</span><br><span class="line">        defaultprovider);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="測試-1"><a href="#測試-1" class="headerlink" title="測試"></a>測試</h3><p>將Attibute補上Order再執行看看得到的順序</p>
<p><img src="https://1.bp.blogspot.com/-UucLgmkDBeE/VnJTKlpyjVI/AAAAAAAAHso/5-37Ww458bE/s1600/1.png" alt="https://1.bp.blogspot.com/-UucLgmkDBeE/VnJTKlpyjVI/AAAAAAAAHso/5-37Ww458bE/s1600/1.png"></p>
<p>可以看到Four排在Three的前面了</p>
<p><img src="https://4.bp.blogspot.com/-YndO7jfF4M0/VnJTkNiXDzI/AAAAAAAAHs0/S6HXWfK1_ks/s1600/1.png" alt="https://4.bp.blogspot.com/-YndO7jfF4M0/VnJTkNiXDzI/AAAAAAAAHs0/S6HXWfK1_ks/s1600/1.png"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2015/12/08/AutoMapper%E8%88%87Json-NET-JObject%E5%B0%8D%E6%87%89%E5%95%8F%E9%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2015/12/08/AutoMapper%E8%88%87Json-NET-JObject%E5%B0%8D%E6%87%89%E5%95%8F%E9%A1%8C/" class="post-title-link" itemprop="url">AutoMapper與Json.NET JObject對應問題</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-12-08 16:42:00" itemprop="dateCreated datePublished" datetime="2015-12-08T16:42:00+08:00">2015-12-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2015/12/08/AutoMapper%E8%88%87Json-NET-JObject%E5%B0%8D%E6%87%89%E5%95%8F%E9%A1%8C/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/08/AutoMapper與Json-NET-JObject對應問題/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>使用套件:<br>Json.NET 7.0.1 :<a target="_blank" rel="noopener" href="https://www.nuget.org/packages/Newtonsoft.Json/7.0.1">&nbsp;https://www.nuget.org/packages/Newtonsoft.Json/7.0.1</a><br>AutoMapper 4.04 :&nbsp;<a target="_blank" rel="noopener" href="https://www.nuget.org/packages/AutoMapper/4.0.4">https://www.nuget.org/packages/AutoMapper/4.0.4</a></p>
<p>今天碰到一個問題，就是有個API回傳值的欄位是不固定無法掌握的，所以只好在轉型成強型別時以object當做該屬性的類別，但JsonConvert碰到類別為Object的東西就會轉成JObject ,而AutoMapper對應JObject會炸掉。以下是簡單時間的範例Code</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> Mapper.CreateMap&lt;source, destination&gt;()</span><br><span class="line"> .ForMember(d =&gt; d.d_name, o =&gt; o.MapFrom(s =&gt; s.name))</span><br><span class="line"> .ForMember(d =&gt; d.d_obj, o =&gt; o.MapFrom(s =&gt; s.obj));</span><br><span class="line"></span><br><span class="line"> source test = <span class="keyword">new</span> source </span><br><span class="line"> &#123;</span><br><span class="line">  name = <span class="string">&quot;test&quot;</span>,</span><br><span class="line">  obj = <span class="keyword">new</span> &#123;code = <span class="number">100</span>&#125;,</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">var</span> result = Mapper.Map&lt;destination&gt;(test);</span><br><span class="line"> result.Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">source</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">object</span> obj &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">destination</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> d_name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">object</span> d_obj &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Source與Destination都有個property為object的類別屬性，在Main()裡面也想好兩個類別的對應關係，並且先準備好Source 然後透過AutoMapper轉出Result,在以上的範例執行正確沒問題<br><a target="_blank" rel="noopener" href="http://3.bp.blogspot.com/-C1ypPTW6LWE/VmaV1B7yBfI/AAAAAAAAHqc/M-ACZeUD5IU/s1600/1.png"><img src="http://3.bp.blogspot.com/-C1ypPTW6LWE/VmaV1B7yBfI/AAAAAAAAHqc/M-ACZeUD5IU/s640/1.png"></a></p>
<p>換個寫法</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> Mapper.CreateMap&lt;source, destination&gt;()</span><br><span class="line"> .ForMember(d =&gt; d.d_name, o =&gt; o.MapFrom(s =&gt; s.name))</span><br><span class="line"> .ForMember(d =&gt; d.d_obj, o =&gt; o.MapFrom(s =&gt; s.obj));</span><br><span class="line"></span><br><span class="line"> source test = JsonConvert.DeserializeObject&lt;source&gt;(<span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;test\&quot;,\&quot;obj\&quot; : &#123;\&quot;code\&quot;:100&#125;&#125;&quot;</span>);</span><br><span class="line"> <span class="keyword">var</span> result = Mapper.Map&lt;destination&gt;(test);</span><br><span class="line"> result.Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">source</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">object</span> obj &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">destination</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> d_name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">object</span> d_obj &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>差別只在於原本Source改成透過Json.Net由字串轉回來而已，這時候只要執行到AutoMapper那一行就會爆炸，錯誤訊息如下</p>
<div class="note info">
            <p>AutoMapperMappingException: </p><p>Mapping types:<br>JObject -&gt; JObject<br>Newtonsoft.Json.Linq.JObject -&gt; Newtonsoft.Json.Linq.JObject</p><p>Destination path:<br>destination.d_obj.d_obj</p><p>Source value:<br>{<br>  “code”: 100<br>}</p>
          </div>


<p>JsonConvert碰到目標為Object型別的欄位，會轉成JObject塞進去，AutoMapper用它來對應，<br>所以如果要解決這個問題需要做一些處理</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//將Mapper改成如下</span></span><br><span class="line"> Mapper.CreateMap&lt;source, destination&gt;()</span><br><span class="line"> .ForMember(d =&gt; d.d_name, o =&gt; o.MapFrom(s =&gt; s.name))</span><br><span class="line"> .ForMember(d =&gt; d.d_obj, o =&gt; o.ResolveUsing(s =&gt;</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">if</span> (s.obj <span class="keyword">is</span> JObject)</span><br><span class="line">  &#123;</span><br><span class="line">   <span class="keyword">var</span> temp = s.obj <span class="keyword">as</span> JObject;</span><br><span class="line">   <span class="keyword">return</span> temp.ToObject&lt;Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">object</span>&gt;&gt;();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> s.obj;</span><br><span class="line"> &#125;));</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這樣就可以正確地取出了<br><a target="_blank" rel="noopener" href="http://2.bp.blogspot.com/-pT-gamin7D4/VmaX7zqy8ZI/AAAAAAAAHqo/shVBh49fMgQ/s1600/1.png"><img src="http://2.bp.blogspot.com/-pT-gamin7D4/VmaX7zqy8ZI/AAAAAAAAHqo/shVBh49fMgQ/s640/1.png"></a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2015/12/03/%E3%80%90MVC%E3%80%91EditorTemplate-%E4%BA%8C-%E5%8B%95%E6%85%8B%E6%96%B0%E5%A2%9E%E6%AC%84%E4%BD%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2015/12/03/%E3%80%90MVC%E3%80%91EditorTemplate-%E4%BA%8C-%E5%8B%95%E6%85%8B%E6%96%B0%E5%A2%9E%E6%AC%84%E4%BD%8D/" class="post-title-link" itemprop="url">【MVC】EditorTemplate (二) 動態新增欄位</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-12-03 17:08:00" itemprop="dateCreated datePublished" datetime="2015-12-03T17:08:00+08:00">2015-12-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2015/12/03/%E3%80%90MVC%E3%80%91EditorTemplate-%E4%BA%8C-%E5%8B%95%E6%85%8B%E6%96%B0%E5%A2%9E%E6%AC%84%E4%BD%8D/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/12/03/【MVC】EditorTemplate-二-動態新增欄位/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>此篇範例程式 :&nbsp;<a target="_blank" rel="noopener" href="https://github.com/toyo0103/Demo_EditTemplate_1">下載</a>&nbsp; (此範例在DynamicController之中)</p>
<p>呈上一篇，<a target="_blank" rel="noopener" href="http://toyo0103.blogspot.tw/2015/11/mvceditortemplate.html">EditorTemplate (一)</a>&nbsp;我們可以來看到產生的原始碼如下</p>
<p><a target="_blank" rel="noopener" href="http://4.bp.blogspot.com/-d6YKMUo8KHw/Vl_i8moc4SI/AAAAAAAAHpY/3TmepPGrLM0/s1600/1.png"><img src="http://4.bp.blogspot.com/-d6YKMUo8KHw/Vl_i8moc4SI/AAAAAAAAHpY/3TmepPGrLM0/s640/1.png"></a></p>
<p>Name的部分是由 <strong>productList[<span style="color: red;">index</span>].屬性名</strong>組成，換句話說，如果今天要由前端動態新增一筆書籍資料，則必須按照這個規則編排下去，後端才能透過ViewModel的方式取得書籍資料</p>
<p><a target="_blank" rel="noopener" href="http://2.bp.blogspot.com/-1JBalONSmnM/Vl_rHHO8ZtI/AAAAAAAAHpo/m25Vs9XyOQs/s1600/1.png"><img src="http://2.bp.blogspot.com/-1JBalONSmnM/Vl_rHHO8ZtI/AAAAAAAAHpo/m25Vs9XyOQs/s640/1.png"></a></p>
<p><a target="_blank" rel="noopener" href="http://3.bp.blogspot.com/-dHvZHH7TzU8/Vl_sLZzIAbI/AAAAAAAAHp0/zbw9eAreaLY/s1600/1.png"><img src="http://3.bp.blogspot.com/-dHvZHH7TzU8/Vl_sLZzIAbI/AAAAAAAAHp0/zbw9eAreaLY/s640/1.png"></a></p>
<p>看起來一切美好圓滿，但如果今天的列表是可以新增之外，還要能動態刪除呢?<br>是不是我的[<span style="color: red;">index</span>]就要一直重新計算，不然送到後端就會不見了</p>
<div class="note info">
            <p>*如果今天有4個textbox但是name分別是<br>productList[0].id<br>productList[1].id<br>productList[2].id<br>productList[5].id<br>這樣後端只會拿到0~2的ID,不按照順序編排的就會消失</p>
          </div>

<p>還好.NET其實提供另外一種方式來繫結ViewModel</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">name</span>=<span class="string">&quot;productList.Index&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0072b890-0e1a-4c93-a5a7-9cafe84b65f8&quot;</span> /&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">input</span>  <span class="attr">id</span>=<span class="string">&quot;productList_0072b890-0e1a-4c93-a5a7-9cafe84b65f8__id&quot;</span> <span class="attr">name</span>=<span class="string">&quot;productList[0072b890-0e1a-4c93-a5a7-9cafe84b65f8].id&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> &gt;</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣的話就可以不用管排序，自由的新增刪除List的項目，但EditorTemplate也需要改一改，不然EditTemplate產出的是[0]這種格是,但是前端產出的格是是[Guid],這樣會有問題。</p>
<p>所以EditTemplate改成用這個方法產出<br><strong><span style="color: #134f5c;">*</span></strong><span style="color: red;"><strong><span style="color: #134f5c;">以下程式碼轉載自:</span></strong><span style="color: red;"> &nbsp;</span></span><br>搞搞就懂 - 點部落 :<strong><span style="color: #38761d;"><a target="_blank" rel="noopener" href="https://www.dotblogs.com.tw/wasichris/2014/11/15/147320">[ASP Net MVC] 如何綁定可動態新增或移除之資料集合(EditorTemplate)</a></span></strong></p>
<ul>
<li><p>新增一組HtmlHelper ```csharp<br>public static MvcHtmlString EditorForMany&lt;TModel, TValue&gt;(</p>
<pre><code>      this HtmlHelper&lt;TModel&gt; html,
      Expression&lt;Func&lt;TModel, IEnumerable&lt;TValue&gt;&gt;&gt; expression,
      string htmlFieldName = null) where TModel : class
  &#123;
      var items = expression.Compile()(html.ViewData.Model);
      var sb = new StringBuilder();
      var hasPrefix = false;

          if (String.IsNullOrEmpty(htmlFieldName))
      &#123;
          var prefix = html.ViewContext.ViewData.TemplateInfo.HtmlFieldPrefix;
          hasPrefix = !String.IsNullOrEmpty(prefix);
          htmlFieldName = (prefix.Length &gt; 0 ? (prefix + &quot;.&quot;) : String.Empty) + ExpressionHelper.GetExpressionText(expression);
      &#125;

          if (items != null)
      &#123;
          foreach (var item in items)
          &#123;
              var dummy = new &#123; Item = item &#125;;
              var guid = Guid.NewGuid().ToString();

                  var memberExp = Expression.MakeMemberAccess(Expression.Constant(dummy), dummy.GetType().GetProperty(&quot;Item&quot;));
              var singleItemExp = Expression.Lambda&lt;Func&lt;TModel, TValue&gt;&gt;(memberExp, expression.Parameters);

                  sb.Append(String.Format(@&quot;&lt;input type=&quot;&quot;hidden&quot;&quot; name=&quot;&quot;&#123;0&#125;.Index&quot;&quot; value=&quot;&quot;&#123;1&#125;&quot;&quot; /&gt;&quot;, htmlFieldName, guid));
              sb.Append(html.EditorFor(singleItemExp, null, String.Format(&quot;&#123;0&#125;[&#123;1&#125;]&quot;, hasPrefix ? ExpressionHelper.GetExpressionText(expression) : htmlFieldName, guid)));
          &#125;
      &#125;
      return new MvcHtmlString(sb.ToString());
  &#125;
</code></pre>
<p>  }</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">*   原本EditorFor改成自訂的EditorForMany &#96;&#96;&#96;html</span><br><span class="line">@Html.EditorFor(x &#x3D;&gt; x.productList)</span><br><span class="line">@Html.EditorForMany(x &#x3D;&gt; x.productList)</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣產出來的格式就會是帶Guid的方式了，可以正常跟前端結合了<br><a target="_blank" rel="noopener" href="http://4.bp.blogspot.com/-MWd6XGNYWKk/VmAD0shPP6I/AAAAAAAAHqE/0sgP3d0uidU/s1600/1.png"><img src="http://4.bp.blogspot.com/-MWd6XGNYWKk/VmAD0shPP6I/AAAAAAAAHqE/0sgP3d0uidU/s640/1.png"></a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2015/11/25/%E3%80%90MVC%E3%80%91EditorTemplate-%E4%B8%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2015/11/25/%E3%80%90MVC%E3%80%91EditorTemplate-%E4%B8%80/" class="post-title-link" itemprop="url">【MVC】EditorTemplate (一)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-11-25 09:43:00" itemprop="dateCreated datePublished" datetime="2015-11-25T09:43:00+08:00">2015-11-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2015/11/25/%E3%80%90MVC%E3%80%91EditorTemplate-%E4%B8%80/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/11/25/【MVC】EditorTemplate-一/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Git範例檔下載位置 : <a target="_blank" rel="noopener" href="https://github.com/toyo0103/Demo_EditTemplate_1">https://github.com/toyo0103/Demo_EditTemplate_1</a></p>
<p>MVC在View的部分要呈現資料，通常是用ViewModel的方式來傳遞。當碰到List或是Array這種重複多筆的情況時，常常就會用迴圈的方式去跑</p>
<p>例如:</p>
<p>假設有個類別CategoryViewModel</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CategoryViewModel</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> Guid id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> List&lt;product&gt; productList &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">product</span> </span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> Guid id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> name &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>在View上要呈現CategoryViewModel.productList就可能用跑回圈的方式去組成</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@model CategoryViewModel</span><br><span class="line">@Html.TextBoxFor(x =&gt; x.id)</span><br><span class="line">@Html.TextBoxFor(x =&gt; x.name)</span><br><span class="line"><span class="comment">//ProductList</span></span><br><span class="line">@for(<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; Model.productList.Count; i++)</span><br><span class="line">&#123;</span><br><span class="line">    @Html.TextBoxFor(x =&gt; Model.productList[i].id)</span><br><span class="line">    @Html.TextBoxFor(x =&gt; Model.productList[i].name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣寫起View來有種又臭又長的感覺，所以可以使用MVC提供的EditorTemplate來解決，使用方法如下:</p>
<ul>
<li>  在Views &gt; Shared &gt; 新增一個EditorTemplates資料*<span style="color: red;">注意 </span>這邊資料夾名稱一定要對<div class="separator" style="clear: both; text-align: center;">[![](http://2.bp.blogspot.com/-rtO8iQJhVEE/VlUQCtIp2YI/AAAAAAAAHo8/kz86QML4Yn8/s1600/1.png)](http://2.bp.blogspot.com/-rtO8iQJhVEE/VlUQCtIp2YI/AAAAAAAAHo8/kz86QML4Yn8/s1600/1.png)</div></li>
<li>  接著在裡面新增一個<span style="color: red;">product</span>.cshtml，這邊一樣檔案名稱必須跟Class名稱相符才行</li>
<li>  然後開始編輯product.cshtml<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@model  product</span><br><span class="line">@Html.TextBoxFor(x =&gt; x.id)</span><br><span class="line">@Html.TextBoxFor(x =&gt; x.name)</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>  接著回到CategoryViewModel那邊迴圈的地方，把迴圈改成這一行即可 ```csharp<br>@Html.EditorFor(x=&gt;x.productList)</li>
</ul>
<pre><code>
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2015/10/23/AutoMapper%E9%81%8B%E7%94%A8-%E4%BA%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/23/AutoMapper%E9%81%8B%E7%94%A8-%E4%BA%8C/" class="post-title-link" itemprop="url">AutoMapper運用 (二)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-23 14:49:00" itemprop="dateCreated datePublished" datetime="2015-10-23T14:49:00+08:00">2015-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2015/10/23/AutoMapper%E9%81%8B%E7%94%A8-%E4%BA%8C/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/10/23/AutoMapper運用-二/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>如果是複雜Class要Mapper時 </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Category</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> List&lt;product&gt;  products &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Product</span> </span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">string</span> name &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">  <span class="keyword">public</span> <span class="built_in">int</span> qantity &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Category要Mapping到CategoryViewModel</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">CategoryViewModel</span> </span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">int</span> id &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> List&lt;Book&gt;  books &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Book</span> </span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> title &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">int</span> number&#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>有兩種做法,結果都會是一樣的</p>
<ol>
<li><p>```csharp<br>Category category = new Category()<br>{<br>id = 1,<br>products = new List<Product>()<br>{<br>new Product()<br>{<br> id = 1,<br> name = “西遊戲”,<br> qantity =10,<br>},<br>new Product()<br>{<br> id = 2,<br> name = “三國志”,<br> qantity =30,<br>},<br>new Product()<br>{<br> id = 3,<br> name = “鹿鼎記”,<br> qantity =50,<br>}<br>}<br>};</p>
<p>  Mapper.CreateMap&lt;Category, CategoryViewModel&gt;()<br>.ForMember(d =&gt; d.id, o =&gt; o.MapFrom(s =&gt; s.id))<br>.ForMember(d =&gt; d.books, o =&gt; o.MapFrom(s =&gt; s.products));</p>
<p>  Mapper.CreateMap&lt;Product, Book&gt;()<br>.ForMember(d =&gt; d.title, o =&gt; o.MapFrom(s =&gt; s.name))<br>.ForMember(d =&gt; d.number, o =&gt; o.MapFrom(s =&gt; s.qantity));</p>
</li>
</ol>
<p> var viewModel = Mapper.Map<CategoryViewModel>(category);<br> viewModel.Dump();</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2.  &#96;&#96;&#96;csharp</span><br><span class="line">void Main()</span><br><span class="line">&#123;</span><br><span class="line">   Category category &#x3D; new Category()</span><br><span class="line">   &#123;</span><br><span class="line">     id &#x3D; 1,</span><br><span class="line">     products &#x3D; new List&lt;Product&gt;()</span><br><span class="line">     &#123;</span><br><span class="line">       new Product()</span><br><span class="line">       &#123;</span><br><span class="line">         id &#x3D; 1,</span><br><span class="line">         name &#x3D; &quot;西遊戲&quot;,</span><br><span class="line">         qantity &#x3D;10,</span><br><span class="line">       &#125;,</span><br><span class="line">       new Product()</span><br><span class="line">       &#123;</span><br><span class="line">         id &#x3D; 2,</span><br><span class="line">         name &#x3D; &quot;三國志&quot;,</span><br><span class="line">         qantity &#x3D;30,</span><br><span class="line">       &#125;,</span><br><span class="line">       new Product()</span><br><span class="line">       &#123;</span><br><span class="line">         id &#x3D; 3,</span><br><span class="line">         name &#x3D; &quot;鹿鼎記&quot;,</span><br><span class="line">         qantity &#x3D;50,</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line">     Mapper.CreateMap&lt;Category, CategoryViewModel&gt;()</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.id, o &#x3D;&gt; o.MapFrom(s &#x3D;&gt; s.id))</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.books, o &#x3D;&gt; o.ResolveUsing&lt;BookResolve&gt;().FromMember(s &#x3D;&gt; s.products));</span><br><span class="line"></span><br><span class="line">     var viewModel &#x3D; Mapper.Map&lt;CategoryViewModel&gt;(category);</span><br><span class="line"> viewModel.Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public class BookResolve : ValueResolver&lt;IList&lt;Product&gt;, IList&lt;Book&gt;&gt;&#123;</span><br><span class="line"> protected override IList&lt;Book&gt; ResolveCore(IList&lt;Product&gt; source) &#123;</span><br><span class="line">    List&lt;Book&gt; books &#x3D; new List&lt;Book&gt;();</span><br><span class="line">    foreach (var item in source)</span><br><span class="line">    &#123;</span><br><span class="line">      var book &#x3D; new Book()      &#123;</span><br><span class="line">        number &#x3D; item.qantity,</span><br><span class="line">        title &#x3D; item.name</span><br><span class="line">      &#125;;</span><br><span class="line">      books.Add(book);</span><br><span class="line">    &#125;</span><br><span class="line">    return books;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2015/10/23/AutoMapper%E9%81%8B%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/23/AutoMapper%E9%81%8B%E7%94%A8/" class="post-title-link" itemprop="url">AutoMapper運用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-23 12:00:00" itemprop="dateCreated datePublished" datetime="2015-10-23T12:00:00+08:00">2015-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2015/10/23/AutoMapper%E9%81%8B%E7%94%A8/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/10/23/AutoMapper運用/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>寫網站常常會遇到從ViewModel對應到應用程式的DTO，或是DB的物件問題，以前自己的做法都是</p>
<div>
</div>```csharp
public bool Login(LoginViewModel model)
{
   Account account = new Account()
   {
      Account = model.Account,
      Password = model.Password
   }
   var Result = _AccountService.Loign(account );
   return Result;
}

<p>public class LoginViewModel<br>{<br>  public string Account{get;set;}<br>  public string Password{get;set;}<br>}</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">等到內部運作完畢的時候可能又要把對應的DTO處理成ViewModel在拋回頁面，這種反覆一直寫的動作其實真的很煩人，直到最近同事介紹了[AutoMapper](https:&#x2F;&#x2F;www.nuget.org&#x2F;packages&#x2F;AutoMapper&#x2F;)給我們之後，整個流程得到了大幅度的改善。</span><br><span class="line"></span><br><span class="line">*   AutoMapper的基本運用</span><br><span class="line"></span><br><span class="line">    當兩個物件的屬性都一樣時，AutoMapper會自動去對應並且轉出</span><br><span class="line">[![](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-j6G1kaI6BXw&#x2F;VimtMro_B9I&#x2F;AAAAAAAAHgY&#x2F;qZYVfNriOm0&#x2F;s1600&#x2F;1.png)](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-j6G1kaI6BXw&#x2F;VimtMro_B9I&#x2F;AAAAAAAAHgY&#x2F;qZYVfNriOm0&#x2F;s1600&#x2F;1.png)</span><br><span class="line"></span><br><span class="line">    如果兩個物件的屬性對應略有不同，也可以加上規則</span><br><span class="line"></span><br><span class="line">    [![](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-n04XweFHx5w&#x2F;VimuRLyJtGI&#x2F;AAAAAAAAHgg&#x2F;H0pNXYnW11w&#x2F;s1600&#x2F;1.png)](http:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-n04XweFHx5w&#x2F;VimuRLyJtGI&#x2F;AAAAAAAAHgg&#x2F;H0pNXYnW11w&#x2F;s1600&#x2F;1.png)</span><br><span class="line">*   如果兩的類別對應到同一個物件的情況</span><br><span class="line">    &#96;&#96;&#96;csharp</span><br><span class="line">void Main()</span><br><span class="line">&#123;</span><br><span class="line"> AccountViewModel model &#x3D; new AccountViewModel() &#123;</span><br><span class="line">  Account &#x3D; &quot;toyo&quot;,</span><br><span class="line">  Password &#x3D; &quot;pwd&quot;,</span><br><span class="line">  City &#x3D; &quot;Taipei&quot;,</span><br><span class="line">  District &#x3D; &quot;大安&quot;</span><br><span class="line"> &#125;;</span><br><span class="line"> var Group &#x3D; new Group() &#123;</span><br><span class="line">  ID &#x3D; 1,</span><br><span class="line">  Name &#x3D; &quot;客戶群組&quot;</span><br><span class="line"> &#125;;</span><br><span class="line"> Mapper.CreateMap&lt;AccountViewModel,AccountDTO&gt;()</span><br><span class="line">  .ForMember(d&#x3D;&gt; d.Address , o&#x3D;&gt;o.MapFrom(s&#x3D;&gt;string.Concat(s.City,s.District))); var account &#x3D; Mapper.Map&lt;AccountDTO&gt;(model);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F;這邊用上面已經轉好的account,來接續Mapper</span><br><span class="line"> Mapper.CreateMap&lt;Group, AccountDTO&gt;()</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.Account, o &#x3D;&gt; o.Ignore())</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.Password, o &#x3D;&gt; o.Ignore())</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.Address, o &#x3D;&gt; o.Ignore())</span><br><span class="line">  .ForMember(d &#x3D;&gt; d.GroupName, o &#x3D;&gt; o.MapFrom(s&#x3D;&gt;s.Name));</span><br><span class="line">    &#x2F;&#x2F;注意</span><br><span class="line"> account &#x3D; Mapper.Map&lt;Group,AccountDTO&gt;(Group,account);</span><br><span class="line"></span><br><span class="line">     account.Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public class AccountViewModel</span><br><span class="line">&#123;</span><br><span class="line"> public string Account &#123; get; set; &#125;</span><br><span class="line"> public string Password &#123; get; set; &#125;</span><br><span class="line"> public string City &#123; get; set; &#125;</span><br><span class="line"> public string District &#123;get;set;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public class AccountDTO</span><br><span class="line">&#123;</span><br><span class="line"> public string Account &#123; get; set; &#125;</span><br><span class="line"> public string Password &#123; get; set; &#125;</span><br><span class="line"> public string Address &#123; get; set; &#125;</span><br><span class="line"> public string GroupName &#123;get;set;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    public class Group&#123;</span><br><span class="line"> public int ID &#123; get; set; &#125;</span><br><span class="line"> public string Name &#123;get;set;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>結果<br><a target="_blank" rel="noopener" href="http://3.bp.blogspot.com/--ouuEtVfvJg/Vimw5twfysI/AAAAAAAAHgs/yC4URuCen0Y/s1600/1.png"><img src="http://3.bp.blogspot.com/--ouuEtVfvJg/Vimw5twfysI/AAAAAAAAHgs/yC4URuCen0Y/s1600/1.png"></a><div></p>
</div><div>
</div><div>最後,在MVC的網站裡面使用AutoMapper可以在把所有規則都先寫在ProFile裡面，然後在Global一次註冊，之後在程式裡面用到就不用每次再寫CreateMap的部分</div><div>
</div>**Profile : **
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ControllerMappingProfile</span> : <span class="title">Profile</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">override</span> <span class="built_in">string</span> ProfileName</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">get</span></span><br><span class="line">  &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="string">&quot;ControllerMappingProfile&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span> &#123;</span><br><span class="line">  Mapper.CreateMap&lt;AccountViewModel, AccountDTO&gt;()</span><br><span class="line">   .ForMember(d =&gt; d.Address, o =&gt; o.MapFrom(s =&gt; <span class="built_in">string</span>.Concat(s.City, s.District)));</span><br><span class="line"></span><br><span class="line">  Mapper.CreateMap&lt;Group, AccountDTO&gt;()</span><br><span class="line">      .ForMember(d =&gt; d.Account, o =&gt; o.Ignore())</span><br><span class="line">      .ForMember(d =&gt; d.Password, o =&gt; o.Ignore())</span><br><span class="line">      .ForMember(d =&gt; d.Address, o =&gt; o.Ignore())</span><br><span class="line">      .ForMember(d =&gt; d.GroupName, o =&gt; o.MapFrom(s =&gt; s.Name));</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>**AutoMapperConfig :  **</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">AutoMapperConfig</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Configure</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Mapper.Initialize(x =&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                x.AddProfile&lt;ControllerMappingProfile&gt;();</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>最後在Global Application_Start註冊即可 ```csharp<br>protected void Application_Start()<br>{<br>   AutoMapperConfig.Configure();<br>}</p>
<pre><code>
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2015/10/22/LinqToSql-ExcuteQuery%E5%9B%9E%E5%82%B3Binary%E7%9A%84%E5%95%8F%E9%A1%8C/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2015/10/22/LinqToSql-ExcuteQuery%E5%9B%9E%E5%82%B3Binary%E7%9A%84%E5%95%8F%E9%A1%8C/" class="post-title-link" itemprop="url">LinqToSql ExcuteQuery回傳Binary的問題</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2015-10-22 14:13:00" itemprop="dateCreated datePublished" datetime="2015-10-22T14:13:00+08:00">2015-10-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2015/10/22/LinqToSql-ExcuteQuery%E5%9B%9E%E5%82%B3Binary%E7%9A%84%E5%95%8F%E9%A1%8C/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2015/10/22/LinqToSql-ExcuteQuery回傳Binary的問題/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近發現用LinqToSQL的物件模型,使用ExecuteQuery&lt;Binary&gt;的方式執行SQL會回傳<br><span style="color: #666666;">型別’System.Data.Linq.Binary’ 必須宣告預設(無參數)建構涵式,才能在對應時加以建構,</span><br>的問題</p>
<p>實際案例如下:</p>
<ul>
<li><p>先在DB裡建立一個Function ```sql<br>create function [dbo].[fb_CreatePWD]<br>(<br>@Param1 varchar(150)<br>)<br>RETURNS varbinary (150)<br>AS<br>BEGIN<br>DECLARE @ResultVar varbinary(150)<br>select @ResultVar = pwdencrypt(@Param1)</p>
<pre><code>RETURN @ResultVar
</code></pre>
<p>END</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#96;&#96;&#96;sql</span><br><span class="line">&lt;&#x2F;pre&gt;</span><br><span class="line">*   接著在MSSMS上測試是可以正常的[![](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-9so5HU0Hkr0&#x2F;Vih51QjzYZI&#x2F;AAAAAAAAHe8&#x2F;mIYlcdaDToA&#x2F;s1600&#x2F;1.png)](http:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-9so5HU0Hkr0&#x2F;Vih51QjzYZI&#x2F;AAAAAAAAHe8&#x2F;mIYlcdaDToA&#x2F;s1600&#x2F;1.png)</span><br><span class="line"></span><br><span class="line">*   然後移到LinqToSql的DataContext試試看&#96;&#96;&#96;csharp</span><br><span class="line">var result &#x3D; this.ExecuteQuery&lt;binary&gt;(&quot;select dbo.fn_CreatePWD(&#123;0&#125;)&quot;,&quot;ok&quot;).FirstOrDefault();</span><br><span class="line">&lt;&#x2F;binary&gt;</span><br></pre></td></tr></table></figure>
<p>得到以下錯誤訊息<br>型別 ‘System.Data.Linq.Binary’ 必須宣告預設 (無參數) 建構函式，才能在對應時加以建構<div></p>
</div>

<ul>
<li>  網路上找到有人說用byte[]接可以,所以立馬做一下測試 ```csharp</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;pre class&#x3D;&quot;brush:csharp&quot;&gt;var result &#x3D; this.ExecuteQuery&lt;binary&gt;(&quot;select dbo.fn_CreatePWD(&#123;0&#125;)&quot;,&quot;ok&quot;).FirstOrDefault();</span><br><span class="line">&lt;&#x2F;binary&gt;</span><br></pre></td></tr></table></figure>
<p>結果一樣GG, 型別 ‘System.Byte[]’ 必須宣告預設 (無參數) 建構函式，才能在對應時加以建構。</p>
<p>接著改用Entity Framework 6.0來試試看*   一樣不行<a target="_blank" rel="noopener" href="http://3.bp.blogspot.com/-HheTlW-N0t8/Vih8Tpj_LNI/AAAAAAAAHfY/hTgin_0PdxM/s1600/1-1.png"><img src="http://3.bp.blogspot.com/-HheTlW-N0t8/Vih8Tpj_LNI/AAAAAAAAHfY/hTgin_0PdxM/s640/1-1.png"></a></p>
<ul>
<li>  換成Byte[]就可以了！！！<br><a target="_blank" rel="noopener" href="http://1.bp.blogspot.com/-0HTZnzzgbo4/Vih9H9jaa4I/AAAAAAAAHfg/UwPi5Fpb8ms/s1600/1.png"><img src="http://1.bp.blogspot.com/-0HTZnzzgbo4/Vih9H9jaa4I/AAAAAAAAHfg/UwPi5Fpb8ms/s1600/1.png"></a><br>所以還是趕快放棄LinqToSql這個被放棄掉的產品,投入Entity Framwork的懷抱吧XD</li>
</ul>
<p>*<br>這邊特別備註一下,如果今天是直接用物件模型將function拉進來,並且直接對xxxDataContext.fn_CreatePWD()操作是可以運作沒問題.</p>
<p>但因為我今天的狀況是在Repository Pattern的情況下,並不會真的對實體做操作,而是全部都對基底類別DataContext做執行,所以沒有這個Method可以使用</p>
<p>我想以上狀況應該是LinqToSql的Bug吧!!網路上也查了滿久的資料,好像沒有人對這塊有比較好的處理方式,如果有再補充上來～</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Toyo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">203</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">75</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Toyo</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://toyo0103.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
