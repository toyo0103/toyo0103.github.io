<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"toyo0103.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="程式隨筆">
<meta property="og:url" content="https://toyo0103.github.io/page/2/index.html">
<meta property="og:site_name" content="程式隨筆">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Toyo">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://toyo0103.github.io/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>程式隨筆</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程式隨筆" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程式隨筆</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2020/02/26/powershell_note/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/26/powershell_note/" class="post-title-link" itemprop="url">powershell筆記</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-26 00:03:00" itemprop="dateCreated datePublished" datetime="2020-02-26T00:03:00+00:00">2020-02-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 13:36:17" itemprop="dateModified" datetime="2022-08-09T13:36:17+00:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/02/26/powershell_note/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/26/powershell_note/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20200226/0.jpg" alt="/images/20200226/0.jpg"></p>
<p>(圖片出處: <a target="_blank" rel="noopener" href="https://sploot.tw/2018/06/powershell-suite-windows-attack-tookit/">https://sploot.tw/2018/06/powershell-suite-windows-attack-tookit/</a>)</p>
<p>powershell 苦手如我，最近有越來越多的需求要從頭到尾自建 CI/CD 與自動化佈署流程，每次寫都要查一次覺得很煩(越老越金魚腦)，決定把常常用到的筆記方便查找</p>
<h1 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#列出所有的環境變數</span></span><br><span class="line"><span class="variable">$gci</span> env:* | <span class="built_in">Sort-Object</span> name</span><br><span class="line"></span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">Name                           Value</span><br><span class="line">----                           -----</span><br><span class="line">ALLUSERSPROFILE                C:\ProgramData</span><br><span class="line">APPDATA                        C:\Users\Steven Tsai\AppData\Roaming</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#設定環境變數</span></span><br><span class="line"><span class="variable">$env:test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$env:test</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#result</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>



<h1 id="Variable"><a href="#Variable" class="headerlink" title="Variable"></a>Variable</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$test</span></span><br><span class="line"><span class="comment">#result</span></span><br><span class="line"><span class="number">123</span></span><br></pre></td></tr></table></figure>



<h1 id="If-…-Else"><a href="#If-…-Else" class="headerlink" title="If … Else"></a>If … Else</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$if</span>(<span class="variable">$test</span> <span class="operator">-eq</span> <span class="string">&quot;123&quot;</span>) &#123;<span class="built_in">echo</span> <span class="string">&quot;yes&quot;</span>&#125; <span class="keyword">else</span> &#123;<span class="built_in">echo</span> <span class="string">&quot;no&quot;</span>&#125;</span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">yes</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#把判斷的結果存到變數中</span></span><br><span class="line"><span class="variable">$test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$result</span>=<span class="keyword">if</span>(<span class="variable">$test</span> <span class="operator">-eq</span> <span class="string">&quot;123&quot;</span>) &#123;<span class="built_in">echo</span> <span class="string">&quot;yes&quot;</span>&#125; <span class="keyword">else</span> &#123;<span class="built_in">echo</span> <span class="string">&quot;no&quot;</span>&#125;</span><br><span class="line"><span class="variable">$result</span></span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">yes</span><br></pre></td></tr></table></figure>



<h1 id="Split"><a href="#Split" class="headerlink" title="Split"></a>Split</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$test</span>=<span class="string">&quot;a,b,c&quot;</span></span><br><span class="line"><span class="variable">$test</span>.Split(<span class="string">&quot;,&quot;</span>)</span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">a</span><br><span class="line">b</span><br><span class="line">c</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$test</span>=<span class="string">&quot;a,b,c&quot;</span></span><br><span class="line"><span class="variable">$test</span>.Split(<span class="string">&quot;,&quot;</span>)[<span class="number">0</span>]</span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">a</span><br></pre></td></tr></table></figure>



<h1 id="Invoke-WebRequest"><a href="#Invoke-WebRequest" class="headerlink" title="Invoke-WebRequest"></a>Invoke-WebRequest</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#需要帳密上傳檔案</span></span><br><span class="line"><span class="variable">$PASSWORD</span> = <span class="built_in">ConvertTo-SecureString</span> <span class="literal">-String</span> <span class="string">&quot;your_password&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"><span class="variable">$CREDENTIAL</span> = <span class="built_in">New-Object</span> <span class="literal">-TypeName</span> <span class="string">&quot;System.Management.Automation.PSCredential&quot;</span> <span class="literal">-ArgumentList</span> <span class="string">&quot;your_account&quot;</span>, <span class="variable">$PASSWORD</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Invoke</span><span class="literal">-WebRequest</span> <span class="literal">-Method</span> PUT <span class="literal">-Uri</span> https://server/file.zip <span class="literal">-UseBasicParsing</span> <span class="literal">-Credential</span> <span class="variable">$CREDENTIAL</span> <span class="literal">-Infile</span> <span class="string">&quot;.\file.zip&quot;</span></span><br></pre></td></tr></table></figure>



<h1 id="Remove-Item"><a href="#Remove-Item" class="headerlink" title="Remove-Item"></a>Remove-Item</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#force強制刪除</span></span><br><span class="line"><span class="variable">$Remove</span><span class="literal">-Item</span> .\file.zip <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>



<h1 id="New-Item"><a href="#New-Item" class="headerlink" title="New-Item"></a>New-Item</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#建立 logs 資料夾</span></span><br><span class="line"><span class="variable">$New</span><span class="literal">-Item</span> <span class="literal">-ItemType</span> directory <span class="literal">-Path</span> C:\logs</span><br><span class="line"></span><br><span class="line"><span class="comment">#result</span></span><br><span class="line">目錄: C:\</span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">d-----      <span class="number">2020</span>/<span class="number">2</span>/<span class="number">26</span>  上午 <span class="number">12</span>:<span class="number">28</span>                test</span><br></pre></td></tr></table></figure>



<h1 id="Copy-Item"><a href="#Copy-Item" class="headerlink" title="Copy-Item"></a>Copy-Item</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Copy</span><span class="literal">-Item</span> c:\source_folder C:\target_folder\ <span class="literal">-Recurse</span></span><br></pre></td></tr></table></figure>



<h1 id="Out-File"><a href="#Out-File" class="headerlink" title="Out-File"></a>Out-File</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#將文字寫成檔案</span></span><br><span class="line"><span class="variable">$test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$test</span> | <span class="built_in">Out-File</span> <span class="string">&quot;C:\log.txt&quot;</span> <span class="literal">-Encoding</span> utf8 <span class="literal">-Force</span></span><br></pre></td></tr></table></figure>



<h1 id="Write-file-without-BOM"><a href="#Write-file-without-BOM" class="headerlink" title="Write file without BOM"></a>Write file without BOM</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$test</span>=<span class="string">&quot;123&quot;</span></span><br><span class="line"><span class="variable">$</span>[<span class="type">System.IO.File</span>]::WriteAllLines(<span class="string">&quot;C:\log.txt&quot;</span>, <span class="variable">$test</span>) </span><br></pre></td></tr></table></figure>



<h1 id="Start-Transcript"><a href="#Start-Transcript" class="headerlink" title="Start-Transcript"></a>Start-Transcript</h1><p>通常腳本會在長機器的時候自動執行，這時候並不會有人工介入，如果發生錯誤就很需要事後追查 Log ，但一段腳本可能上百上千行，到底錯在哪很難找，這時候就可以透過以下方法把執行的過程跟 output 都儲存下來</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Start</span><span class="literal">-Transcript</span> <span class="literal">-Path</span> <span class="string">&quot;c:\logs.txt&quot;</span> <span class="literal">-Append</span></span><br><span class="line"><span class="variable">$New</span><span class="literal">-Item</span> <span class="literal">-Type</span> Directory C:\TestData2\ <span class="literal">-Force</span></span><br><span class="line"><span class="variable">$Stop</span><span class="literal">-Transcript</span></span><br></pre></td></tr></table></figure>

<p>執行結束後打開 logs.txt 就可以看到以下輸出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">**********************</span><br><span class="line">Windows PowerShell 轉譯開始</span><br><span class="line">**********************</span><br><span class="line">已啟動轉譯，輸出檔為 c:\logs.txt</span><br><span class="line">PS C:\Users\Steven Tsai&gt; New-Item -Type Directory C:\TestData2\ -Force</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    目錄: C:\</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mode                LastWriteTime         Length Name</span><br><span class="line">----                -------------         ------ ----</span><br><span class="line">d-----      2020&#x2F;2&#x2F;26  上午 12:40                TestData2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PS C:\Users\Steven Tsai&gt; Stop-Transcript</span><br><span class="line">**********************</span><br><span class="line">Windows PowerShell 轉譯結束</span><br><span class="line">結束時間: 20200226004058</span><br><span class="line">**********************</span><br></pre></td></tr></table></figure>



<h1 id="Set-Global-Enviroment"><a href="#Set-Global-Enviroment" class="headerlink" title="Set Global Enviroment"></a>Set Global Enviroment</h1><p>這是用在自動化安裝一些套件，例如 : Git , consul 後需要設定全域的環境變數，才能讓之後的指令能夠認得 consul –version 這類指令。</p>
<p>如果手動安裝，就是去把環境變數中 Path 加上 consul.exe 的位置，以下範例是抓出 Path 本來的設定值，並在尾段補上新的路徑設定</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$oldpath</span> = (<span class="built_in">Get-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;Registry::HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\Environment&#x27;</span> <span class="literal">-Name</span> PATH).path</span><br><span class="line"></span><br><span class="line"><span class="variable">$newpath</span> = <span class="string">&quot;<span class="variable">$</span>&#123;oldpath&#125;;C:\consul\&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$Set</span><span class="literal">-ItemProperty</span> <span class="literal">-Path</span> <span class="string">&#x27;Registry::HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\Environment&#x27;</span> <span class="literal">-Name</span> PATH <span class="literal">-Value</span> <span class="variable">$newPath</span></span><br></pre></td></tr></table></figure>



<h1 id="Start-Service"><a href="#Start-Service" class="headerlink" title="Start-Service"></a>Start-Service</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$Start</span><span class="literal">-Service</span> your_service_name</span><br></pre></td></tr></table></figure>



<h1 id="register-task-scheduler"><a href="#register-task-scheduler" class="headerlink" title="register task scheduler"></a>register task scheduler</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#要執行的動作</span></span><br><span class="line"><span class="variable">$action</span>= (<span class="built_in">New-ScheduledTaskAction</span> <span class="literal">-Execute</span> <span class="string">&quot;powershell.exe&quot;</span> <span class="literal">-Argument</span> <span class="string">&quot;-ExecutionPolicy bypass C:\start.ps1&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#執行權限</span></span><br><span class="line"><span class="variable">$ProvisionPrincipal</span> = <span class="built_in">New-ScheduledTaskPrincipal</span> <span class="literal">-UserId</span> <span class="string">&quot;NT AUTHORITY\SYSTEM&quot;</span> <span class="literal">-RunLevel</span> Highest <span class="literal">-LogonType</span> S4U</span><br><span class="line"></span><br><span class="line"><span class="comment">#觸發的時機</span></span><br><span class="line"><span class="variable">$ProvisionTrigger</span> = <span class="built_in">New-ScheduledTaskTrigger</span> <span class="literal">-AtStartup</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#註冊 task Schedule </span></span><br><span class="line"><span class="variable">$Register</span><span class="literal">-ScheduledTask</span> <span class="literal">-TaskName</span> <span class="string">&quot;StartConsul&quot;</span> <span class="literal">-TaskPath</span> <span class="string">&quot;\&quot;</span> <span class="literal">-Action</span> <span class="variable">$action</span> <span class="literal">-Trigger</span> <span class="variable">$ProvisionTrigger</span> <span class="literal">-Principal</span> <span class="variable">$ProvisionPrincipal</span> </span><br></pre></td></tr></table></figure>



<h1 id="Create-User"><a href="#Create-User" class="headerlink" title="Create User"></a>Create User</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#設定 User 密碼</span></span><br><span class="line"><span class="variable">$Secure_String_Pwd</span>=<span class="built_in">ConvertTo-SecureString</span> <span class="string">&quot;user_password&quot;</span> <span class="literal">-AsPlainText</span> <span class="literal">-Force</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#建立User</span></span><br><span class="line"><span class="variable">$New</span><span class="literal">-LocalUser</span> <span class="string">&quot;teamuser&quot;</span> <span class="literal">-Password</span> <span class="variable">$Secure_String_Pwd</span> <span class="literal">-FullName</span> <span class="string">&quot;Arch team user&quot;</span> <span class="literal">-Description</span> <span class="string">&quot;for arch team&quot;</span> <span class="literal">-PasswordNeverExpires</span>:<span class="variable">$true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#將此 User 加入 Administrators</span></span><br><span class="line"><span class="variable">$Add</span><span class="literal">-LocalGroupMember</span> <span class="literal">-Group</span> <span class="string">&quot;Administrators&quot;</span> <span class="literal">-Member</span> <span class="string">&quot;teamuser&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#建立一個全新的 Group</span></span><br><span class="line"><span class="variable">$New</span><span class="literal">-LocalGroup</span> <span class="literal">-Name</span> <span class="string">&quot;docker-users&quot;</span></span><br><span class="line"><span class="comment">#將此 User 加進去</span></span><br><span class="line"><span class="variable">$Add</span><span class="literal">-LocalGroupMember</span> <span class="literal">-Group</span> <span class="string">&quot;docker-users&quot;</span> <span class="literal">-Member</span> <span class="string">&quot;archteamuser&quot;</span></span><br></pre></td></tr></table></figure>



<h1 id="Expand-Archive"><a href="#Expand-Archive" class="headerlink" title="Expand-Archive"></a>Expand-Archive</h1><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$curl</span> https://source_file.zip <span class="literal">-o</span> c:\targe_file.zip</span><br><span class="line"></span><br><span class="line"><span class="variable">$Expand</span><span class="literal">-Archive</span> c:\targe_file.zip c:\file <span class="literal">-force</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2020/02/17/docker_ci_build/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/17/docker_ci_build/" class="post-title-link" itemprop="url">透過容器建置專案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-17 23:06:00" itemprop="dateCreated datePublished" datetime="2020-02-17T23:06:00+00:00">2020-02-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 13:36:17" itemprop="dateModified" datetime="2022-08-09T13:36:17+00:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/02/17/docker_ci_build/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/17/docker_ci_build/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20200217/0.jpg" alt="希望學會這個技巧後，以後大家弄CI/CD環境都能海闊天空"></p>
<p>(圖片出處 : <a target="_blank" rel="noopener" href="http://ezvivi2.com/article/200483.asp">http://ezvivi2.com/article/200483.asp</a>)</p>
<p>有在處理 CI/CD 的人應該都碰到過維護建置環境的問題，舉例來說，當今天開發 C# 專案可能有 dotnet framework、dotnet core、有些人開發前端會需要 npm …等等，CI 機器就需要裝一堆為了建置佈署的軟體，如果開發人員變多，建置排隊久候，可能就會將環境升級為 Master、Slave 架構，但又面臨了多台 Slave 如何快速增長(通常只有上班時間才會同時這麼多人在建置，所以動態增長 CI 機器有其必要)，如何維護多台 Slave 環境，有時候遇到需要的套件版本打架的時候，處理起來真的是會抓狂。</p>
<h1 id="透過容器來建置專案"><a href="#透過容器來建置專案" class="headerlink" title="透過容器來建置專案"></a>透過容器來建置專案</h1><p>其實綜觀上述的問題可以發現，每個專案建置所需要的東西可能不盡相同，為了讓 CI 機器能夠滿足所有建置的條件往往會把環境搞得過於複雜，這時候容器就是一個非常好的選擇，它滿足了每次建置環境都是<strong>獨立</strong>、<strong>隔離</strong>的條件且方便佈署。</p>
<p>一旦使用容器來做為建置的媒介，需要長一台新的 CI 機器時，只要將機器開起來並安裝完 docker 就搞定了(甚至 AWS 都有做好的現成 AMI 連自己安裝都省了)，不再需要寫一狗票的腳本來安裝機器。</p>
<h1 id="實例"><a href="#實例" class="headerlink" title="實例"></a>實例</h1><p>以下是我一個專案建置時的 dockerfile，沒幾行的 script 就快速講一下，因為我這個專案裡面同時有 dotnet framework 與 dotnet core ，所以找個微軟官方提供的  <code>mcr.microsoft.com/dotnet/framework/sdk:4.8</code>, 裡面已經安裝了下列套件。 <a target="_blank" rel="noopener" href="https://hub.docker.com/_/microsoft-dotnet-framework-sdk/">Docker Hub 連結</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.NET Framework Runtime</span><br><span class="line">Visual Studio Build Tools</span><br><span class="line">Visual Studio Test Agent</span><br><span class="line">NuGet CLI</span><br><span class="line">.NET Framework Targeting Packs</span><br><span class="line">ASP.NET Web Targets</span><br></pre></td></tr></table></figure>

<p>我用這個 base image 開了 workspace 資料夾並把 source code 複製進去後，接著就是大家熟悉的 nuget restore 、 dotnet build、 dotnet publish 在容器的環境內建置專案。</p>
<p>第二段是起另一個 base image <code>windows servercore 2019</code>，將剛剛建置好的 artifact 放到指定的資料夾，最後這一包會建置成 image 並推到公司的 Artifact management 上，其它人只要拉下這個 image 就可以執行了。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">mcr.microsoft.com/dotnet/framework/sdk:4.8</span> <span class="string">AS</span> <span class="string">build-env</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">c:/workspace</span></span><br><span class="line"></span><br><span class="line"><span class="string">COPY</span> <span class="string">.</span> <span class="string">./</span></span><br><span class="line"></span><br><span class="line"><span class="string">RUN</span> <span class="string">nuget</span> <span class="string">restore</span> <span class="string">src\nmqv3.sln</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">dotnet</span> <span class="string">restore</span> <span class="string">--configfile</span> <span class="string">src\.nuget\NuGet.Config</span> <span class="string">src\my_project.sln</span></span><br><span class="line"></span><br><span class="line"><span class="string">run</span> <span class="string">dotnet</span> <span class="string">build</span> <span class="string">-c</span> <span class="string">release</span> <span class="string">src\my_project.sln</span> </span><br><span class="line"><span class="string">run</span> <span class="string">dotnet</span> <span class="string">publish</span> <span class="string">-c</span> <span class="string">Release</span> <span class="string">-r</span> <span class="string">win-x64</span> <span class="string">--self-contained</span> <span class="literal">true</span> <span class="string">src\Router\Router.csproj</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">FROM</span> <span class="string">mcr.microsoft.com/windows/servercore:ltsc2019</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">c:/worker</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=build-env</span> <span class="string">c:/workspace/src/Worker/bin/release/</span> <span class="string">.</span></span><br><span class="line"></span><br><span class="line"><span class="string">WORKDIR</span> <span class="string">c:/router</span></span><br><span class="line"><span class="string">COPY</span> <span class="string">--from=build-env</span> <span class="string">c:/workspace/src/Router/bin/Release/netcoreapp3.0/win-x64/publish/</span> <span class="string">.</span></span><br></pre></td></tr></table></figure>

<p>從建置到最後要交付的 container image 一氣呵成，全部都濃縮在一份 dockerfile 裡面，這份 dockerfile 會跟著專案內，只要任何一台機器可以執行 docker container 就可以建置佈署這個專案，是不是方便許多 XD</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2020/01/22/aynclocal_threadlocal/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/01/22/aynclocal_threadlocal/" class="post-title-link" itemprop="url">AsyncLocal and ThreadLocal</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-01-22 14:00:00" itemprop="dateCreated datePublished" datetime="2020-01-22T14:00:00+00:00">2020-01-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 13:36:17" itemprop="dateModified" datetime="2022-08-09T13:36:17+00:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/01/22/aynclocal_threadlocal/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/01/22/aynclocal_threadlocal/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="ThreadLocal"><a href="#ThreadLocal" class="headerlink" title="ThreadLocal"></a>ThreadLocal</h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">ThreadLocal</span>&lt;<span class="title">string</span>&gt; LocalString</span> = <span class="keyword">new</span> ThreadLocal&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LocalString.Value = <span class="string">&quot;Value 1&quot;</span>;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【A】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> t1 = AsyncMethod();</span><br><span class="line"></span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【D】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">await</span> t1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">AsyncMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【B】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	LocalString.Value = <span class="string">&quot;Value 3&quot;</span>;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【C】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">await</span> Task.Delay(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【E】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//【A】 Thread: 14, ExcutionContext: 37151951 ,value: Value 1</span></span><br><span class="line"><span class="comment">//【B】 Thread: 14, ExcutionContext: 51676517 ,value: Value 1</span></span><br><span class="line"><span class="comment">//【C】 Thread: 14, ExcutionContext: 51676517 ,value: Value 3</span></span><br><span class="line"><span class="comment">//【D】 Thread: 14, ExcutionContext: 37151951 ,value: Value 3</span></span><br><span class="line"><span class="comment">//【E】 Thread: 16, ExcutionContext: 46128400 ,value: </span></span><br></pre></td></tr></table></figure>

<p>ThreadLocal 非常容易理解, 每個 Thread 之間彼此是隔離的, 即便 ExcutionContext 不同, 但只要是同一個 Thread 都會是共用的。</p>
<p>所以可以看到 await 之後, 因為不同 Thread 執行剩下的 Code , ThreadLocal 的值就變成預設的空值</p>
<br>

<h1 id="AsyncLocal"><a href="#AsyncLocal" class="headerlink" title="AsyncLocal"></a>AsyncLocal</h1><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="title">AsyncLocal</span>&lt;<span class="title">string</span>&gt; LocalString</span> = <span class="keyword">new</span> AsyncLocal&lt;<span class="built_in">string</span>&gt;();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	LocalString.Value = <span class="string">&quot;Value 1&quot;</span>;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【A】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> t1 = AsyncMethod();</span><br><span class="line"></span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【D】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">await</span> t1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">AsyncMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【B】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	LocalString.Value = <span class="string">&quot;Value 3&quot;</span>;</span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【C】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">await</span> Task.Delay(<span class="number">100</span>);</span><br><span class="line"></span><br><span class="line">	Console.WriteLine(<span class="string">$&quot;【E】 Thread: <span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>, ExcutionContext: <span class="subst">&#123;Thread.CurrentThread.ExecutionContext.GetHashCode()&#125;</span> ,value: <span class="subst">&#123;LocalString.Value&#125;</span>&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//【A】 Thread: 14, ExcutionContext: 5705933 ,value: Value 1</span></span><br><span class="line"><span class="comment">//【B】 Thread: 14, ExcutionContext: 12517624 ,value: Value 1</span></span><br><span class="line"><span class="comment">//【C】 Thread: 14, ExcutionContext: 12517624 ,value: Value 3</span></span><br><span class="line"><span class="comment">//【D】 Thread: 14, ExcutionContext: 5705933 ,value: Value 1</span></span><br><span class="line"><span class="comment">//【E】 Thread: 8, ExcutionContext: 35765882 ,value: Value 3</span></span><br></pre></td></tr></table></figure>

<p>AsyncLocal 會在每次需要切出 ExcutionContext 時複製一份給新的 ExcutionContext , 所以每個 ExcutionContext間的 AsyncLocal 都是獨立的，但同時可達跨 Thread , ExcutionContext 往下傳遞的特性。</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/zkweb/p/7747162.html">AsyncLocal的运作机制和陷阱</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tcjiaan/p/5007737.html">【.NET深呼吸】基於異步上下文的本地變量（AsyncLocal）</a></p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/dotnet/api/system.threading.executioncontext?view=netframework-4.8">ExecutionContext 類別</a></p>
          </div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/11/09/service_discovery/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/11/09/service_discovery/" class="post-title-link" itemprop="url">Service Discovery</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-11-09 12:32:00" itemprop="dateCreated datePublished" datetime="2019-11-09T12:32:00+00:00">2019-11-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 13:36:17" itemprop="dateModified" datetime="2022-08-09T13:36:17+00:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/11/09/service_discovery/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/09/service_discovery/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20191109/0.png" alt="/images/20191109/0.png"></p>
<p>( <a target="_blank" rel="noopener" href="https://www.codeprimers.com/service-discovery-in-microservice-architecture/">https://www.codeprimers.com/service-discovery-in-microservice-architecture/</a> )</p>
<br>

<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>傳統上一組服務通常都會搭配 DNS + Load balance + serivce cluster, 服務要呼叫時也都是直接打 Domain 讓 Load balance 去導流。</p>
<p>不過這也面臨了管理 Domain 與服務間的複雜度, 例如服務要加一台新的機器需要去設定 Load balance 才有辦法服務(當然也是可以搭配一些 cloud autoscaling 機制來簡化流程); Client 在呼叫 Service 時通常需要真的打打看才有辦法知道服務是否還正常, 無法事先知道服務狀態再決定是否要呼叫。</p>
<p>近年微服務與容器化運用的盛行, 上述方式就顯得有點卡卡的，如果你的服務在 k8s 內那可能還好, 大部分它都幫忙處理掉了, 但如果像我們公司一樣, 很多服務雖然容器化但還無法進到 k8s 內, container 可以在短時間內 scale 成數倍來因應大流量, 但卡在這些服務需要去 load balance 註冊才有辦法讓流量導進來,  那顯然就有點做半套的感覺， Service Discovery 的應用就成為了重要的課題</p>
<br>

<h1 id="什麼是-Service-Discovery"><a href="#什麼是-Service-Discovery" class="headerlink" title="什麼是 Service Discovery"></a>什麼是 Service Discovery</h1><p>翻譯成中文就是服務發現(廢話…)，顧名思義就是呼叫端在需要時先透過搜尋來找到對應的服務，而要達成這點需要一些配合才能達成。</p>
<p>首先第一步, 當某個服務起來時應該主動向提供 service discovery 註冊自己是什麼服務? 位置在哪? 是否已經可以開始服務了? </p>
<p><img src="/images/20191109/1.gif" alt="/images/20191109/1.gif"></p>
<p>註冊時會搭配著 Health check 的機制, 告訴 service discovery 如何檢核這個節點是否健康的</p>
<p><img src="/images/20191109/2.png" alt="/images/20191109/2.png"></p>
<p>Client 在要叫用 service 時, 先透過 service name 詢問有哪些節點可用, 而 service discovery 也能準確地回應有哪些目前還是健康的節點可供呼叫 </p>
<p><img src="/images/20191109/3.png" alt="/images/20191109/3.png"></p>
<p>當節點損壞時, 以 container 的案例, 會直接換掉不健康的 container 重長一組, 而這又會回到圖一註冊的流程。</p>
<p>更細緻一點的作法還有對 service discovery 回應的列表做快取，例如快取 1 秒，當服務自己要被收掉時, 做好 graceful shutdown 先把自己從服務列表中 deregister , 並且等待 3 秒後才關機，避免快取到的 Client 打來你剛好停止服務。</p>
<p>或是對服務加上 Tag ，當特定用戶或 VIP 連進來時可以透過搜尋特定機器去執行</p>
<p><img src="/images/20191109/4.png" alt="/images/20191109/4.png"></p>
<br>

<h1 id="面臨的問題"><a href="#面臨的問題" class="headerlink" title="面臨的問題"></a>面臨的問題</h1><p>但並不是所有事情都是如此美好, 公司目前導入這些機制雖然可以大幅簡化管理內部服務 domain 這類的問題, 但對於 load balance，即選取適合的節點這點上還有一些問題要克服，例如傳統 ELB 這類的服務都會依據每個節點的回應速度來判斷接下來導流的分配，但 service discovery 因為 request 並不會經過它，所以相關 latancy 也無從監控與觀察, 所以 load balance 這題必須額外拉出來做相對應的監控機制。</p>
<p>再來當服務橫跨 vm 跟 k8s 時情境就變得更複雜，不過這些題目等到之後有明確的方向再做整理好了，久違的文章雖然都沒寫到 code，但還是把一些觀念記錄下來。相關的實作等之後有空再補吧 (逃)</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/08/19/nats_streaming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/19/nats_streaming/" class="post-title-link" itemprop="url">NATS Streaming 調查報告書</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-19 23:00:00" itemprop="dateCreated datePublished" datetime="2019-08-19T23:00:00+00:00">2019-08-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 13:36:17" itemprop="dateModified" datetime="2022-08-09T13:36:17+00:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/08/19/nats_streaming/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/08/19/nats_streaming/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190819/0.jpg" alt="/images/20190819/0.jpg"></p>
<p>最近因為任務關係對 NATS Streaming 做了一些研究跟 POC，這邊把一些研究到的NATS Streaming 特性記錄下來</p>
<h1 id="什麼是-NATS"><a href="#什麼是-NATS" class="headerlink" title="什麼是 NATS"></a>什麼是 NATS</h1><p><a target="_blank" rel="noopener" href="https://nats.io/">NATS</a> 是一種 Queue , 它效能比一般的 Queue 好上許多，號稱 Sender / Reciever 每秒可高達 20 萬筆 Message，這是非常驚人的數字。</p>
<p><img src="/images/20190819/1.png" alt="/images/20190819/1.png"></p>
<p>（來源：<a target="_blank" rel="noopener" href="https://bravenewgeek.com/dissecting-message-queues/%EF%BC%89">https://bravenewgeek.com/dissecting-message-queues/）</a></p>
<p>可以看到 RabbitMQ 在它旁邊矮了一大截….</p>
<br>

<p>NATS 支援 Subscribe 模式，Subscriber 訂閱需要的 subject，當 NATS 收到 Message 時就會同時派發給所有訂閱者。</p>
<p><img src="/images/20190819/2.png" alt="/images/20190819/2.png"></p>
<p>（來源：<a target="_blank" rel="noopener" href="https://nats-io.github.io/docs/developer/concepts/pubsub.html%EF%BC%89">https://nats-io.github.io/docs/developer/concepts/pubsub.html）</a></p>
<br>

<p>NATS 也支援 Queu Group，NATS 會對同一個 Queue Group 的所有 Subscriber 分配訂閱的 Message，而不會重複</p>
<p><img src="/images/20190819/3.png" alt="/images/20190819/3.png"></p>
<p>（來源：<a target="_blank" rel="noopener" href="https://nats-io.github.io/docs/developer/concepts/queue.html%EF%BC%89">https://nats-io.github.io/docs/developer/concepts/queue.html）</a></p>
<p>不過這些都不算太特別，畢竟 RabbitMQ 一樣能做到相同的功能，最特別的是 NATS Streaming</p>
<br>

<h1 id="什麼是-NATS-Streaming"><a href="#什麼是-NATS-Streaming" class="headerlink" title="什麼是 NATS Streaming"></a>什麼是 NATS Streaming</h1><p>NATS Streaming 是附加在 NATS 之上的加值功能，他可以永久的保留所有的 Message，並且支援 Cursor（指標）功能，你可以任意的讓 Subscriber 回到特定的點 <strong>重播</strong> 所有的 Message。</p>
<p>這一點相當有用，試想一下，如果今天我們將所有交易的過程都透過 NATS Streaming 記錄下來，假設資料庫或記錄的地方損毀，我們只要重新 Replay 所有 Message，即能重建最後的結果。這也是 <a target="_blank" rel="noopener" href="https://microservices.io/patterns/data/event-sourcing.html">Event Sourcing</a> 中最重要的的一環。</p>
<p>為了達成 Event Sourcing 這個設計模式的目標，演練了一些特定的情境</p>
<ol>
<li>為了達成 HA 及加快處理速度的需求，需要多個 Subscriber 同時訂閱相同 Subject，並且彼此不會做到重複的 Message。</li>
<li>演練災難還原，Subscriber 必須能回朔到過去的的定時間點，重新 Replay 所有歷程</li>
</ol>
<br>

<h2 id="1-Queue-Group"><a href="#1-Queue-Group" class="headerlink" title="1. Queue Group"></a>1. Queue Group</h2><p>其實第一項相對於容易，只要用 Queue Group 即可輕鬆達成，只要每個 Subscriber 給定同一組 Queue Group Name 即可。</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> options = StanOptions.GetDefaultOptions();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> subOptions = StanSubscriptionOptions.GetDefaultOptions();</span><br><span class="line">subOptions.MaxInflight = <span class="number">1</span>; <span class="comment">// MaxInflight</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> cf = <span class="keyword">new</span> StanConnectionFactory();</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c = cf.CreateConnection(<span class="string">&quot;test-cluster&quot;</span>, clientId, options);</span><br><span class="line"><span class="keyword">var</span> s = c.Subscribe(<span class="string">&quot;foo&quot;</span>, queueGroup, subOptions, (obj, args) =&gt;</span><br><span class="line">        &#123;</span><br><span class="line">                ......</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//等待接收關機訊號</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//關閉連線</span></span><br><span class="line">s.Close(); </span><br><span class="line">c.Close();</span><br><span class="line">c.Dispose();</span><br></pre></td></tr></table></figure>

<p>這邊需要特別注意 <strong>MaxInflight</strong> 這個參數，為了效率 NATS  預設會一次派給 Subscriber 1000 則Message（預設值有點忘記），好讓 Subscriber 不需要每做完一筆才透過網路要下一筆 Message，但這也讓我測出一個問題，當預收的訊息太多並且 Subscriber 根本來不及消化掉，這時候 NATS 會判定該則訊息 timeout，轉而派給同群別的Subscriber 來處理，這時候可能會發生兩個 Subscriber 執行到同一筆 Message 的狀況，所以請估算好 MaxInflight 的值，避免抓一堆做不完重派的狀況發生。</p>
<p>當最後一個 <strong>Subscriber</strong> 離線後，Queue Group 即會被刪除</p>
<br>

<h2 id="2-Durable-Name"><a href="#2-Durable-Name" class="headerlink" title="2. Durable Name"></a>2. Durable Name</h2><p>前面有提到 NATS Streaming 支援 Cursor 的功能，當 Subscriber 都離線時，如果有給它 Durable Name，他會記得上次你執行到哪一筆，當下次 Subscriber 重新連上時會從那個點繼續往下派發</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> subOptions = StanSubscriptionOptions.GetDefaultOptions();</span><br><span class="line">subOptions.DurableName = _appSetting.DURABLENAME;</span><br></pre></td></tr></table></figure>

<br>

<h2 id="3-StartAt"><a href="#3-StartAt" class="headerlink" title="3. StartAt"></a>3. StartAt</h2><p>接著來實作災難還原的步驟，首先如何讓特定的 Queue Group 退到特定的點，呈上，同時多個 Subscriber 與 Durable Name 都還是要能符合。</p>
<p>SDK 其實有提供 <strong>StartAt()</strong> 的 API</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Receive messages starting at a specific sequence number</span></span><br><span class="line"><span class="keyword">var</span> subOptions = StanSubscriptionOptions.GetDefaultOptions();</span><br><span class="line">subOptions.StartAt(<span class="number">22</span>);</span><br></pre></td></tr></table></figure>

<p>不過這邊需特別注意，同一個 Queue Group 只有在第一個 Subscriber 進來時（也就建立這個 Queue Group 的時候）<strong>StartAt 才會生效</strong>，之後進來的 Subscriber 帶這個值都會被直接忽略掉。</p>
<p>這邊問題就來了，當我們帶了 Queue Group ＋ Durable Name，即便所有的 Subscriber 都離線了，NATS 還是會貼心的幫你記錄最後執行到的地方，所以之後進來的 Subscriber 也都不可能是第一個了，換言之這樣的狀況是無法重新設定指標的。</p>
<p>所以如果要刪除  Queue Group ＋ Durable Name 的 Queue Group 唯一的方法只有讓所有的 Subscriber 退訂閱</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 取消訂閱 刪除該Group</span></span><br><span class="line">s.Unsubscribe();</span><br></pre></td></tr></table></figure>

<p>這邊跟上面的範例程式不一樣，上面的是用 **Close()**，這樣並不會讓 Subscriber 退訂閱，只會是離線而已，唯有用 <strong>Unsubscribe()</strong> 將 Subscriber 全部退訂閱後，有 Durable Name 的 Queue Group 才會被刪除掉。</p>
<p>另外 NATS SDK 並沒有提供查詢 Queue Group 所有 Subscriber 的 Client ID，依據官方的說法，這份清單應該是使用者需要自己維護的，在上面這個案例上，就會需要將所有 <strong>Subscriber</strong> 用相同 Client ID 連上線後退訂閱。</p>
<br>

<h2 id="4-ManualAcks"><a href="#4-ManualAcks" class="headerlink" title="4. ManualAcks"></a>4. ManualAcks</h2><p>用上述的方法成功刪除 Queue Group 後，下一步就是重新讓第一個 <strong>Subscriber</strong> 去建立 Queue Group 並指定 <strong>StartAt</strong> ，不過這邊有點麻煩的地方是，<strong>Subscriber</strong> 一連線後馬上就會開始拋 Message 過來，這時後如果你是希望災難還原與重新執行 Replay 分開做時就會很困擾。</p>
<p>預設 StanSubscriptionOptions 是收到 Message 後自動就幫你 Ack 回報 NATS 你收到了在處理了，NATS 也就會繼續往下把下一筆分配給別人，但我只是想指定位子不想要處理 Message 呢？</p>
<p>這時候就要透過設定將 Ack 改成手動回報</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> subOptions = StanSubscriptionOptions.GetDefaultOptions();</span><br><span class="line">subOptions.ManualAcks = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">.......</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> s = c.Subscribe(<span class="string">&quot;foo&quot;</span>, queueGroup, subOptions, (obj, args) =&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                      args.Message.Ack();</span><br><span class="line">                    &#125;);</span><br></pre></td></tr></table></figure>

<p>這樣只要不呼叫 **Ack()**，就等於不處理這筆 Message 了，當 Subscriber 離線或是 Message timeout，NATS 就會重新分派給其他 Subscriber 處理了，這樣也間接達到重建 Queue Group 與指定 Cursor 的目標。</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://nats-io.github.io/docs/">NATS Document</a></p><p><a target="_blank" rel="noopener" href="https://github.com/nats-io/stan.net">The official NATS .NET C# Streaming Client</a></p>
          </div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/08/01/threadpool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/08/01/threadpool/" class="post-title-link" itemprop="url">ThreadPool</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-08-01 19:14:00" itemprop="dateCreated datePublished" datetime="2019-08-01T19:14:00+00:00">2019-08-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 13:36:17" itemprop="dateModified" datetime="2022-08-09T13:36:17+00:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/08/01/threadpool/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/08/01/threadpool/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <div class="note info">
            <p>GitHub SourceCode : <a target="_blank" rel="noopener" href="https://github.com/toyo0103/ThreadPoolDemo">連結</a></p>
          </div>

<p>自從加入精神時光屋團隊後，對於一些平行處理、多執行序等程式掌控力就越來越要求。為了不要當拖油瓶，這次練習的是 ThreadPoll，從這個練習可以更精準掌握 Thread 控制技巧。</p>
<br>

<h1 id="目標"><a href="#目標" class="headerlink" title="目標"></a>目標</h1><p>建立 Thread 其實是需要成本的，所以頻繁的建立 Thread 砍掉 Thread 相當耗效能，另一方面，如果等到有 Task 才開始建立 Thread 可能會導致第一個 Task 回應速度過慢。例如 : IIS 底層就有 ThreadPool ，為了因應 Request 進來時能更快速的回應，但又不能為了一昧追求速度不管資源的有效運用，所以ThreadPool 應該有增長跟最低維持幾條的上下限。</p>
<p>依據上面描述定義以下目標</p>
<ol>
<li>自製 ThreadPool</li>
<li>依據 Task 量決定 Thread 的數量，Task 過多會加開 Thread 處理，反之會減少</li>
<li>ThreadPool 可以設定 Thread 數量上下限 </li>
</ol>
<br>

<h1 id="實作"><a href="#實作" class="headerlink" title="實作"></a>實作</h1><p>希望呼叫的方式如下</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 建立自己的 ThreadPool ，設定 Thread 至少保持 3 條，上限不超過 10 條 </span></span><br><span class="line">        MyThreadPool myTreadPool = <span class="keyword">new</span> MyThreadPool(<span class="number">3</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一值塞任務進去,不管任務執行完了沒</span></span><br><span class="line">        <span class="comment">// 所以 ThreadPool 應該要能接住 Task 讓它們排隊消耗 </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            myTreadPool.Enqueue(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.ReadKey();</span><br><span class="line">        <span class="comment">// 等待執行結束</span></span><br><span class="line">        myTreadPool.WaitFinished();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p><strong>MyThreadPool</strong> </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyThreadPool</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingCollection&lt;<span class="built_in">int</span>&gt; _jobQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _minThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _maxThread;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThreadPool</span>(<span class="params"><span class="built_in">int</span> minThread,<span class="built_in">int</span> maxThread</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>._minThread = minThread;</span><br><span class="line">        <span class="keyword">this</span>._maxThread = maxThread;</span><br><span class="line">        <span class="comment">// 最多只能放 100 個 Task</span></span><br><span class="line">        <span class="keyword">this</span>._jobQueue = <span class="keyword">new</span> BlockingCollection&lt;<span class="built_in">int</span>&gt;(<span class="number">100</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WaitFinished</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotImplementedException();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enqueue</span>(<span class="params"><span class="built_in">int</span> i</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _jobQueue.TryAdd(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>實作 ThreadPool 保有最少的 Thread</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyThreadPool</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingCollection&lt;<span class="built_in">int</span>&gt; _jobQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _minThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _maxThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _currentThreadCount;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> List&lt;Thread&gt; _threads;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThreadPool</span>(<span class="params"><span class="built_in">int</span> minThread,<span class="built_in">int</span> maxThread</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>._minThread = minThread;</span><br><span class="line">        <span class="keyword">this</span>._maxThread = maxThread;</span><br><span class="line">        <span class="keyword">this</span>._jobQueue = <span class="keyword">new</span> BlockingCollection&lt;<span class="built_in">int</span>&gt;(<span class="number">100</span>);</span><br><span class="line">        <span class="keyword">this</span>._currentThreadCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>._threads = <span class="keyword">new</span> List&lt;Thread&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; minThread; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.CreateThread();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateThread</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">int</span> id = Interlocked.Increment(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">        <span class="keyword">if</span> (id &gt; _maxThread)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 可開的 Thread 到達極限, 無法加開</span></span><br><span class="line">            Interlocked.Decrement(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(ThreadBody);</span><br><span class="line">        thread.Name = <span class="string">$&quot;Thread-<span class="subst">&#123;id&#125;</span>&quot;</span>;</span><br><span class="line">        thread.Start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>._threads.Add(thread);</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Thread count : <span class="subst">&#123;<span class="keyword">this</span>._currentThreadCount&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ThreadBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>實作 TheadBody </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ThreadBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> name = Thread.CurrentThread.Name;</span><br><span class="line">    Console.WriteLine(name + <span class="string">&quot; starts&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有 Task 還沒有塞完就一直搶來處理</span></span><br><span class="line">    <span class="keyword">while</span> (!<span class="keyword">this</span>._jobQueue.IsCompleted)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> task = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(_jobQueue.TryTake(<span class="keyword">out</span> task, <span class="number">100</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 模擬 Task 要執行的時間, 0.1 ~ 0.5秒不等</span></span><br><span class="line">            Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">            <span class="built_in">int</span> excuteTime = <span class="number">0</span>;</span><br><span class="line">            excuteTime = rnd.Next(<span class="number">100</span>, <span class="number">500</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;name&#125;</span> do task_<span class="subst">&#123;task&#125;</span> spend <span class="subst">&#123;excuteTime&#125;</span> ms&quot;</span>);</span><br><span class="line">            </span><br><span class="line">            Thread.Sleep(excuteTime);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(name + <span class="string">&quot; are closed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這邊會有一個問題, 如果塞 Task 的速度不定, 可能時快時慢, 如果中間間隔過長會導致 Thread 一直拿不到 Task 來工作卻又停不下來, 持續空轉 , 所以必須加一個機制讓它等待, 並在必要時刻喚醒</p>
<br>

<p><strong>ManualResetEvent</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> ManualResetEvent _mre;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyThreadPool</span>(<span class="params"><span class="built_in">int</span> minThread,<span class="built_in">int</span> maxThread</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">this</span>._mre = <span class="keyword">new</span> ManualResetEvent(<span class="literal">false</span>);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ThreadBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">string</span> name = Thread.CurrentThread.Name;</span><br><span class="line">    Console.WriteLine(name + <span class="string">&quot; starts&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果有 Task 還沒有塞完就一直搶來處理</span></span><br><span class="line">    <span class="keyword">while</span> (!<span class="keyword">this</span>._jobQueue.IsCompleted)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> task = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(_jobQueue.TryTake(<span class="keyword">out</span> task, <span class="number">100</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">            <span class="built_in">int</span> excuteTime = <span class="number">0</span>;</span><br><span class="line">            excuteTime = rnd.Next(<span class="number">100</span>, <span class="number">500</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;name&#125;</span> do task_<span class="subst">&#123;task&#125;</span> spend <span class="subst">&#123;excuteTime&#125;</span> ms&quot;</span>);</span><br><span class="line">            Thread.Sleep(excuteTime);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		_mre.WaitOne();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>MSDN : <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/dotnet/api/system.threading.manualresetevent?view=netframework-4.8">ManualResetEvent Class</a> </p>
<p>ManualResetEvent 就像是個手動的紅綠燈, 可以將 Thread Block 在 WaitOne 這行, 直到呼叫 ManualResetEvent.Set()將燈號切成綠燈, 全部的 Thread 才會往下繼續執行。</p>
<p>與之相對的是 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/dotnet/api/system.threading.autoresetevent?view=netframework-4.8">AutoResetEvent Class</a> , 差別只在於 ManualResetEvent 呼叫 Set (綠燈), Reset (紅燈)。而 AutoResetEvent 呼叫 Set 每次只會隨機放一條 Thread , 不像 ManualRestEvent 是全部放</p>
<br>

<p><strong>Enqueue</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enqueue</span>(<span class="params"><span class="built_in">int</span> i</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 表示容量滿了</span></span><br><span class="line">    <span class="keyword">while</span> (_jobQueue.TryAdd(i) == <span class="literal">false</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Queue Length 過長, 需加開 Thread</span></span><br><span class="line">        <span class="keyword">this</span>.CreateThread();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 切成綠燈, 放掉所有 Thread 開始搶工作做</span></span><br><span class="line">	_mre.Set();</span><br><span class="line">    <span class="comment">// 切成紅燈, 如果有 Tread 搶不到事情來做又會被 Block 在 _mre.WaitOne(); 那行</span></span><br><span class="line">    _mre.Reset();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p><strong>實作動態伸縮 Thread 數量</strong></p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ThreadBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   ...</span><br><span class="line">       </span><br><span class="line"><span class="keyword">while</span> (!<span class="keyword">this</span>._jobQueue.IsCompleted)</span><br><span class="line">   &#123;</span><br><span class="line">        <span class="keyword">if</span> (_mre.WaitOne(<span class="number">5000</span>) == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 進到這邊表示 Thread 並不是因為_mre.Set()被喚醒, 而是5秒 timeout</span></span><br><span class="line">            <span class="comment">// 嘗試回收 Thread</span></span><br><span class="line">            <span class="keyword">if</span> (Interlocked.Decrement(<span class="keyword">ref</span> _currentThreadCount) &lt; _minThread)</span><br><span class="line">            &#123;</span><br><span class="line">                Interlocked.Increment(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;Thread count : <span class="subst">&#123;<span class="keyword">this</span>._currentThreadCount&#125;</span>&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   Console.WriteLine(name + <span class="string">&quot; are closed&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p><strong>WaitFinished</strong></p>
<p>這個方法如果被呼叫時, 應該將所有 Thread 都喚醒, 並且等待每個 Thread 都執行完畢</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WaitFinished</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">this</span>._jobQueue.CompleteAdding();</span><br><span class="line">    _mre.Set();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> t <span class="keyword">in</span> _threads)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            t.Join();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<p>**完整版的 Code **</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="comment">// 建立自己的 ThreadPool ，設定 Thread 至少保持 3 條，上限不超過 10 條 </span></span><br><span class="line">        MyThreadPool myTreadPool = <span class="keyword">new</span> MyThreadPool(<span class="number">3</span>,<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 一值塞任務進去,不管任務執行完了沒</span></span><br><span class="line">        <span class="comment">// 所以 ThreadPool 應該要能接住 Task 讓它們排隊消耗 </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">200</span>; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            myTreadPool.Enqueue(i);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.ReadKey();</span><br><span class="line">        <span class="comment">// 等待執行結束</span></span><br><span class="line">        myTreadPool.WaitFinished();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyThreadPool</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> BlockingCollection&lt;<span class="built_in">int</span>&gt; _jobQueue;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _minThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _maxThread;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> _currentThreadCount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ManualResetEvent _mre;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Thread&gt; _threads;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThreadPool</span>(<span class="params"><span class="built_in">int</span> minThread,<span class="built_in">int</span> maxThread</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>._minThread = minThread;</span><br><span class="line">        <span class="keyword">this</span>._maxThread = maxThread;</span><br><span class="line">        <span class="comment">// 最多只能放 100 個 Task</span></span><br><span class="line">        <span class="keyword">this</span>._jobQueue = <span class="keyword">new</span> BlockingCollection&lt;<span class="built_in">int</span>&gt;(<span class="number">100</span>);</span><br><span class="line">        <span class="keyword">this</span>._currentThreadCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">this</span>._mre = <span class="keyword">new</span> ManualResetEvent(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">this</span>._threads = <span class="keyword">new</span> List&lt;Thread&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; minThread; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.CreateThread();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">CreateThread</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">int</span> id = Interlocked.Increment(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">        <span class="keyword">if</span> (id &gt; _maxThread)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 可開的 Thread 到達極限, 無法加開</span></span><br><span class="line">            Interlocked.Decrement(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(ThreadBody);</span><br><span class="line">        thread.Name = <span class="string">$&quot;Thread-<span class="subst">&#123;id&#125;</span>&quot;</span>;</span><br><span class="line">        thread.Start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>._threads.Add(thread);</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">$&quot;Thread count : <span class="subst">&#123;<span class="keyword">this</span>._currentThreadCount&#125;</span>&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">WaitFinished</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>._jobQueue.CompleteAdding();</span><br><span class="line">        _mre.Set();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> t <span class="keyword">in</span> _threads)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (t != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                t.Join();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Enqueue</span>(<span class="params"><span class="built_in">int</span> i</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        _mre.Set();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 表示容量滿了</span></span><br><span class="line">        <span class="keyword">while</span> (_jobQueue.TryAdd(i) == <span class="literal">false</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Queue Length 過長, 需加開 Thread</span></span><br><span class="line">            <span class="keyword">this</span>.CreateThread();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        _mre.Reset();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">ThreadBody</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="built_in">string</span> name = Thread.CurrentThread.Name;</span><br><span class="line">        Console.WriteLine(name + <span class="string">&quot; starts&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果有 Task 還沒有塞完就一直搶來處理</span></span><br><span class="line">        <span class="keyword">while</span> (!<span class="keyword">this</span>._jobQueue.IsCompleted)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> task = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>(_jobQueue.TryTake(<span class="keyword">out</span> task, <span class="number">100</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">                <span class="built_in">int</span> excuteTime = <span class="number">0</span>;</span><br><span class="line">                excuteTime = rnd.Next(<span class="number">100</span>, <span class="number">500</span>);</span><br><span class="line">                Console.WriteLine(<span class="string">$&quot;<span class="subst">&#123;name&#125;</span> do task_<span class="subst">&#123;task&#125;</span> spend <span class="subst">&#123;excuteTime&#125;</span> ms&quot;</span>);</span><br><span class="line">                Thread.Sleep(excuteTime);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (_mre.WaitOne(<span class="number">5000</span>) == <span class="literal">false</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 此條 Thread 5秒都沒有工作, 嘗試收掉</span></span><br><span class="line">                <span class="keyword">if</span> (Interlocked.Decrement(<span class="keyword">ref</span> _currentThreadCount) &lt; _minThread)</span><br><span class="line">                &#123;</span><br><span class="line">                    Interlocked.Increment(<span class="keyword">ref</span> _currentThreadCount);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    Console.WriteLine(<span class="string">$&quot;Thread count : <span class="subst">&#123;<span class="keyword">this</span>._currentThreadCount&#125;</span>&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(name + <span class="string">&quot; are closed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="執行結果"><a href="#執行結果" class="headerlink" title="執行結果"></a>執行結果</h1><p>執行中應該可以看到 Task 消化不夠快而加開 Thread </p>
<p><img src="/images/20190801/1.png" alt="/images/20190801/1.png"></p>
<p>最後因為程式在等待 ReadKey(), 如果超過 5 秒不按會看到 Thread 收掉的訊息</p>
<p> <img src="/images/20190801/2.png" alt="/images/20190801/2.png"></p>
<p>按下任意鍵,就會全部收掉並關閉程式</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/05/30/dotnet_tool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/30/dotnet_tool/" class="post-title-link" itemprop="url">【.Net Core】dotnet tool</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-05-30 16:37:00" itemprop="dateCreated datePublished" datetime="2019-05-30T16:37:00+00:00">2019-05-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 13:36:17" itemprop="dateModified" datetime="2022-08-09T13:36:17+00:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/05/30/dotnet_tool/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/05/30/dotnet_tool/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p><img src="/images/20190530/0.png" alt="/images/20190530/0.png"></p>
<p>最近在公司開發一支稱為 Linter 的小程式，負責檢查 Bitbucket  PR 的異動內容，看看是否有符合公司規範 ，例如 : 加了 Config 後是否有確實在對應環境補上相關設定，盡量避免這種編譯檢查不出來但上線才壞掉的情況。</p>
<p>原本預想的架構圖如上圖，使用者發了 PR ，透過 Webhook 觸發 Jenkins Master ，由 Master 安排一台機器去執行檢查。</p>
<p>但面臨一個問題是，當 Linter 這支程式要更版時變得很麻煩，因為每台 Jenkins 都必須要更新這支程式，原本也有想說不如把 Linter 獨立一台機器寫成類似像 API 的服務好了，但未來勢必面臨太多 PR 導致瓶頸，之後在導入 ELB 加多台機器 …. 想著想著就覺得太麻煩了。</p>
<p>之後同事建議可以包成 dotnet tool 的工具，Linter 要更新時只是發佈新版 Nuget ，而不是去佈署每台 Jenkins Slave，而  Jenkins Slave 每次要執行檢查 PR 時，先檢查自己套件是否為最新版的再往下執行。</p>
<p><img src="/images/20190530/1.png" alt="/images/20190530/1.png"></p>
<p>整個流程瞬間變得簡單乾淨許多，所以就動手開始將這套程式包成 dotnet tool</p>
<br>

<h1 id="製作-dotnet-tool"><a href="#製作-dotnet-tool" class="headerlink" title="製作 dotnet tool"></a>製作 dotnet tool</h1><p>首先將要包成 dotnet tool 的專案檔 csproj 加上 PackAsTool 設定  </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Project</span> <span class="attr">Sdk</span>=<span class="string">&quot;Microsoft.NET.Sdk&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">PropertyGroup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">OutputType</span>&gt;</span>Exe<span class="tag">&lt;/<span class="name">OutputType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">TargetFramework</span>&gt;</span>netcoreapp2.1<span class="tag">&lt;/<span class="name">TargetFramework</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">AssemblyName</span>&gt;</span>Linter<span class="tag">&lt;/<span class="name">AssemblyName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">RootNamespace</span>&gt;</span>Linter<span class="tag">&lt;/<span class="name">RootNamespace</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">PackAsTool</span>&gt;</span>true<span class="tag">&lt;/<span class="name">PackAsTool</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">Version</span>&gt;</span>1.0.1<span class="tag">&lt;/<span class="name">Version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">PropertyGroup</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>將執行檔打包成 nupkg</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dotnet pack -c release -o nupkg -p:PackageVersion=1.0.0 src\Linter.csproj</span></span><br></pre></td></tr></table></figure>

<p>推上 Nuget Server</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> nuget.exe push src\nupkg\Linter.1.0.0.nupkg &lt;Nuget Key&gt; -<span class="built_in">source</span> &lt;Nuget Server&gt;</span></span><br></pre></td></tr></table></figure>



<br>

<h1 id="執行-dotnet-tool"><a href="#執行-dotnet-tool" class="headerlink" title="執行 dotnet tool"></a>執行 dotnet tool</h1><p>Install</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dotnet tool install --add-source &lt;Nuget Server&gt; -g Linter</span></span><br></pre></td></tr></table></figure>

<p>Update</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dotnet tool update -g --no-cache Linter</span></span><br></pre></td></tr></table></figure>

<p>接著就看你原本怎麼封裝 Cli ，直接執行即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> Linter check -n .......</span></span><br></pre></td></tr></table></figure>



<h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>第一次使用 dotnet tool 有驚豔到，以前都只會傻傻的用 console application ，每次都覺得部屬超麻煩，以後透過 dotnet tool 真的是方便多了 </p>
<div class="note info">
            <p><a target="_blank" rel="noopener" href="https://blog.miniasp.com/post/2018/04/19/DotNet-Core-2-1-Global-Tools">保哥 - 體驗 .NET Core 2.1 全新的全域工具安裝與使用 (.NET Core Global Tools)</a></p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/dotnet/core/tools/global-tools-how-to-create">使用 .NET Core CLI 建立 .NET Core 通用工具</a></p>
          </div>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/05/07/sql_output/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/05/07/sql_output/" class="post-title-link" itemprop="url">【SQL】Output</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-05-07 10:36:00" itemprop="dateCreated datePublished" datetime="2019-05-07T10:36:00+00:00">2019-05-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 13:36:17" itemprop="dateModified" datetime="2022-08-09T13:36:17+00:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/05/07/sql_output/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/05/07/sql_output/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190507/0.jpg" alt="/images/20190507/0.jpg"></p>
<h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>DBA 反應偵測到有個 Update Query 很頻繁，且通常緊接著 Update 後都會再進 Select 把剛剛 Update 的資料拉走，資料量太大時頻率太高導致 SQL 效能瓶頸，建議調整成 Update 後直接把剛剛異動的資料拉走，而不是拆兩段查詢。</p>
<h1 id="解決方案"><a href="#解決方案" class="headerlink" title="解決方案"></a>解決方案</h1><p>當 SQL Server 執行 Update 時會 Lock 相關要異動的資料，並把異動前後的資料放入 Log 中，如果希望能在一次 Query 中就把資料 Update 並把影響到的資料回傳，可以透過 <code>Ouput </code> 這個子句來達成</p>
<div class="note info">
            <p>Ouput 可用於以下情境</p><p>Delete</p><p>Insert</p><p>Update</p><p>Merge</p>
          </div>

<p>我們有一張表，紀載著每個人的名稱與學期分數</p>
<p><img src="/images/20190507/1.png" alt="/images/20190507/1.png"></p>
<p>老師大發慈悲想把低於 60 分的人都改成 60 分及格，這時候語法可以這樣下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DECLARE</span> <span class="variable">@UpdateLog</span> <span class="keyword">table</span>(</span><br><span class="line">	Id <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">	Name nvarchar(<span class="number">20</span>) <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">	OriScore <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>,</span><br><span class="line">	NewScore <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">UPDATE dbo.[<span class="keyword">User</span>]</span><br><span class="line"><span class="keyword">SET</span> Score <span class="operator">=</span> <span class="number">60</span></span><br><span class="line">OUTPUT INSERTED.Id,</span><br><span class="line">	   INSERTED.Name,</span><br><span class="line">	   DELETED.Score,</span><br><span class="line">	   INSERTED.Score</span><br><span class="line"><span class="keyword">INTO</span> <span class="variable">@UpdateLog</span></span><br><span class="line"><span class="keyword">WHERE</span> Score <span class="operator">&lt;</span> <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="variable">@UpdateLog</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/20190507/2.png" alt="/images/20190507/2.png"></p>
<div class="note info">
            <p>參考資料</p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/sql/t-sql/queries/output-clause-transact-sql?view=sql-server-2017">Microsoft - OUTPUT 子句 (Transact-SQL)</a></p><p><a target="_blank" rel="noopener" href="https://www.essentialsql.com/sql-update-statement/">Use SQL UPDATE to Query and Modify Data</a></p>
          </div>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/04/30/aws_windows_ec2_cant_access_metadata/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/30/aws_windows_ec2_cant_access_metadata/" class="post-title-link" itemprop="url">【AWS】EC2 can't access metadata service</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-30 15:52:00" itemprop="dateCreated datePublished" datetime="2019-04-30T15:52:00+00:00">2019-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 13:36:17" itemprop="dateModified" datetime="2022-08-09T13:36:17+00:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/04/30/aws_windows_ec2_cant_access_metadata/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/30/aws_windows_ec2_cant_access_metadata/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>EC2 上的 windows VM 突然無法存取相對應的 AWS 服務，而這些權限原本都是透過 IAM Role 賦予的，之前文章有提過 AWS 機器是如何透過 IAM Role 得知自己有哪些權限</p>
<div class="note info">
            <p><a href="/2019/02/19/windows_contianer_iamrole_/">Windows IAM Role 問題</a></p>
          </div>

<p>在該機器呼叫 metadata service 會回應錯誤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl 169.254.169.254</span></span><br></pre></td></tr></table></figure>

<p>詢問對 AWS 比較熟的一些同事，聽說在 windows server 2012 版本之後，更換 Instance Type 重新開機時會發生</p>
<br>

<h1 id="解決方法"><a href="#解決方法" class="headerlink" title="解決方法"></a>解決方法</h1><p>執行 C:\ProgramData\Amazon\EC2-Windows\Launch\Scripts\InitializeInstance.ps1 ，它會重新 Binding 一些相關設定，執行完後就好了</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/45095261/aws-ec2-windows-10-cant-access-metadata">[Stackoverflow] AWS EC2 Windows 10 can’t access metadata</a></p>
          </div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2019/04/30/jenkins_update_remote_docker_container/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2019/04/30/jenkins_update_remote_docker_container/" class="post-title-link" itemprop="url">【Docker】透過 Jenkins 重新部屬遠端機器 Container</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2019-04-30 10:00:00" itemprop="dateCreated datePublished" datetime="2019-04-30T10:00:00+00:00">2019-04-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 13:36:17" itemprop="dateModified" datetime="2022-08-09T13:36:17+00:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2019/04/30/jenkins_update_remote_docker_container/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/04/30/jenkins_update_remote_docker_container/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20190430/0.jpg" alt="/images/20190430/0.jpg"></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>公司慢慢在導入 Docker 等相關 Container 技術，但因為剛起步所以很多 CI/CD 流程都還在優化建構中，前幾天為了能讓 Jenkins 順利重新部屬新版 Container 搞得焦頭爛額，乾脆把這些過程記錄下來</p>
<br>

<h2 id="部屬流程"><a href="#部屬流程" class="headerlink" title="部屬流程"></a>部屬流程</h2><p><img src="/images/20190430/1.png" alt="/images/20190430/1.png"></p>
<p>這個服務是由三個 Component 來組成，分開維護開發，換句話說如果有任何一個組件更新，整個服務都需要更新並重新部屬，目前的流程是各個 Component 更新後都會觸發 CD 流程將完成品打包放到 S3。</p>
<p>而我這次做得線就是 Docker Image 那條，當有任何 Component 更新了都會觸發，我會將 S3 的各個 Component 最新版抓下來後整理，接著再打包一版 Build Docker Image 會需要的原料放到 S3。</p>
<p>接著 Jenkins 接手將 Docker Image Artifact 抓下來開始 build =&gt; push =&gt; 換掉遠端機器正在跑的 Container。</p>
<br>

<h1 id="設定權限"><a href="#設定權限" class="headerlink" title="設定權限"></a>設定權限</h1><p> 所以第一步是釐清 Jenkins 所使用的 user 是否有執行 docker 相關指令的權限，後面都簡稱這位使用者為 <code>ciuser</code>。</p>
<p>因為 docker 為 service 等級的服務，預設是 admin 才能使用相關指令，所以理所當然地馬上卡關</p>
<p><img src="/images/20190430/2.png" alt="/images/20190430/2.png"></p>
<p>要讓使用者有執行 docker 相關指令的權限有兩種方法</p>
<ol>
<li>賦予該 User Admin 的權限</li>
<li>開一個群組，並設定 docker daemon ，賦予該群組權限</li>
</ol>
<p>顯然 (1) 不太可能(雖然最簡單)，所以這邊採取 (2) 的方法</p>
<p>*** Windows 上右鍵 &gt; Computer Management**</p>
<p><img src="/images/20190430/3.png" alt="/images/20190430/3.png"></p>
<p>*** Local Users and Groups &gt;&gt; Groups **</p>
<p><img src="/images/20190430/4.png" alt="/images/20190430/4.png"></p>
<p>*** New Group &gt;&gt; 建立一個群組 &gt;&gt; 將 ciuser 加進去**</p>
<p><img src="/images/20190430/5.png" alt="/images/20190430/5.png"></p>
<p>*** 到 C:\ProgramData\docker\config 修改 daemon.json 檔案**(如果沒有這個檔案，請自己建一個)</p>
<p>將剛剛的群組加進去</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;group&quot;</span>: <span class="string">&quot;docker-users&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>*** 重新啟動 docker service ** (這邊需要 admin 權限)</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Powershell</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">Restart-Service</span> docker</span><br></pre></td></tr></table></figure>

<p>做到這邊你在用 <code>ciuser</code> 下 docker command 應該就可以動了</p>
<p><img src="/images/20190430/6.png" alt="/images/20190430/6.png"></p>
<p>PS. 如果還不行，請先登出 <code>ciuser</code> 再登入，因為將使用者加入一個群組或賦予權限，重登才會生效</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/virtualization/windowscontainers/manage-docker/configure-docker-daemon">Docker Engine on Windows</a></p>
          </div>



<p>到這邊應該已經打通 <code>ciuser</code> 可以執行 docker command 的權限了，接著在 Jenkins 設定 build 、 push Image的流程測試會發現依然錯誤</p>
<div class="note info">
            <p>error during connect: Get http://%2F%2F.%2Fpipe%2Fdocker_engine/v1.40/containers/json: open //./pipe/docker_engine: The system cannot find the file specified. In the default daemon configuration on Windows, the docker client must be run elevated to connect. This error may also indicate that the docker daemon is not running.</p>
          </div>

<p>但同樣的指令不透過 Jenkins 執行，而是用遠端登入直接執行會過，這個問題想了很久還是搞不懂為什麼，明明使用的 User 相同 …</p>
<p>但找到了一篇文章也提到相同的事情並提供了解決方案，主要是需要調整 docker_engine ACL 設定，但因為過程太麻煩，作者很貼心的還提供了小套件可以使用</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Powershell</span></span><br><span class="line"><span class="variable">$</span> <span class="built_in">Install-Module</span> <span class="literal">-Name</span> dockeraccesshelper</span><br><span class="line"><span class="variable">$</span> <span class="built_in">Import-Module</span> dockeraccesshelper</span><br><span class="line"><span class="variable">$</span> <span class="built_in">Add-AccountToDockerAccess</span> <span class="string">&quot;ciuser&quot;</span></span><br></pre></td></tr></table></figure>

<p>再次執行 Jenkins 就真的成功了</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://www.axians-infoma.com/techblog/allow-access-to-the-docker-engine-without-admin-rights-on-windows/">Allow access to the Docker Engine without admin rights on Windows</a></p>
          </div>

<br>

<h1 id="設定-Jenkins"><a href="#設定-Jenkins" class="headerlink" title="設定 Jenkins"></a>設定 Jenkins</h1><p>Build Image 、 Push Image 這些流程就直接省略了，重點是最後一步怎麼觸發遠端機器更新 Container 。</p>
<p>Docker Compose 提供 <code>--host</code> ，讓你可以操作遠端機器的 Container</p>
<p><img src="/images/20190430/7.png" alt="/images/20190430/7.png"></p>
<p>但前提是你必須先去該機器開啟 2376 port 的防火牆，還有設定 docker daemon config，跟上面那段一樣檔案，只是上次設定的是 jenkins 機器，這次是跑 Container 的機器</p>
<p>路徑 :  C:\ProgramData\docker\config\daemon.json</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;hosts&quot;</span>: [<span class="string">&quot;tcp://0.0.0.0:2376&quot;</span>, <span class="string">&quot;npipe://&quot;</span>]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>都開好後回頭在 Jenkins 的流程中埋下最後一段</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker-compose -H machineIp:2376 pull</span></span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> docker-compose -H machineIp:2376 up -d</span></span><br></pre></td></tr></table></figure>

<br>

<h1 id="結語"><a href="#結語" class="headerlink" title="結語"></a>結語</h1><p>雖然只是短短的一篇，但是整個設定的過程其實卡很久，尤其是 windows 的權限不是很熟常常會把自己搞得很亂，但為了團隊能接手維運，這些過程又勢必有人需要去踩過一次，以前都覺得 DevOps 的 Dev 才是主力(自己大部分經歷也都是待在開發團隊)，對於維運一直都沒有很深入去了解並感受他們的痛。</p>
<p>但當角色從 Developer 漸漸轉成 Infra ，不同的角度去看這些事情有了完全不同的感受，<code>維運</code>真的才是整個軟體生命週期佔最大的部分，一套系統你可能開發個 1 ~ 3 年，但產品的維運可能是數十年，怎麼讓一套機制落地，讓人為介入越少越好，要考慮的面向真的比過去單純開發差非常多，果然還有得學阿。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Toyo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">202</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">74</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Toyo</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://toyo0103.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
