<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"toyo0103.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="程式隨筆">
<meta property="og:url" content="https://toyo0103.github.io/page/10/index.html">
<meta property="og:site_name" content="程式隨筆">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Toyo">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://toyo0103.github.io/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>程式隨筆</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程式隨筆" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程式隨筆</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/10/17/%E3%80%90Unit-Test%E3%80%91Fake-DLL%E7%99%BC%E7%94%9Fdoes-not-exist-in-the-namespace-System-Diagnostics-Tracing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/17/%E3%80%90Unit-Test%E3%80%91Fake-DLL%E7%99%BC%E7%94%9Fdoes-not-exist-in-the-namespace-System-Diagnostics-Tracing/" class="post-title-link" itemprop="url">【Unit Test】Fake DLL發生does not exist in the namespace 'System.Diagnostics.Tracing'</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-10-17 14:49:00" itemprop="dateCreated datePublished" datetime="2016-10-17T14:49:00+08:00">2016-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/10/17/%E3%80%90Unit-Test%E3%80%91Fake-DLL%E7%99%BC%E7%94%9Fdoes-not-exist-in-the-namespace-System-Diagnostics-Tracing/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/10/17/【Unit-Test】Fake-DLL發生does-not-exist-in-the-namespace-System-Diagnostics-Tracing/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上一篇<a target="_blank" rel="noopener" href="http://toyo0103.blogspot.tw/2016/10/unittestfake-systemdatetime.html">【Unit Test】Fake System.DateTime</a>&nbsp;寫到如何Fake DLL，在本機建置與進行測試都沒問題，唯獨放到CICD機器去做自動化部屬時，一直鬼擋牆的跳建置方案錯誤，錯誤內容如下</p>
<p><span style="background-color: white; font-family: &quot;Segoe UI&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, Verdana;">The type or namespace name ‘EventSourceCreatedEventArgs’ does not exist in the namespace ‘System.Diagnostics.Tracing’ (are you missing an assembly reference?)&nbsp;</span><br><span style="background-color: white; font-family: &quot;Segoe UI&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, Verdana;"><br></span>上網查了一下找到以下解法</p>
<ul>
<li>打開mscorlib.fakes，改成以下內容```csharp<Fakes xmlns="http://schemas.microsoft.com/fakes/2011/">
<Assembly Name="mscorlib" Version="4.0.0.0"/>
<StubGeneration>
  <Remove FullName="System.Diagnostics.Tracing"/>
  <Remove FullName="System.Text.Encoding"/>
  <Remove FullName="System.Security.Cryptography" />
</StubGeneration>
</Fakes></li>
</ul>
<p>```</p>
<p>自動化佈署機器這樣去建置佈署就過關了!!!!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/10/17/%E3%80%90Unit-Test%E3%80%91Fake-System-DateTime/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/17/%E3%80%90Unit-Test%E3%80%91Fake-System-DateTime/" class="post-title-link" itemprop="url">【Unit Test】Fake System.DateTime</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-10-17 14:26:00" itemprop="dateCreated datePublished" datetime="2016-10-17T14:26:00+08:00">2016-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/10/17/%E3%80%90Unit-Test%E3%80%91Fake-System-DateTime/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/10/17/【Unit-Test】Fake-System-DateTime/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在寫程式的時後，常常會用到DateTime.Now來判斷目前時間，依照時間邏輯去撈取不同的資料，但碰到單元測試要驗證的時候就是個大麻煩，因為DateTime.Now每次執行的時候時間都會改變，所以以前的做法都是這樣</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">SystemTime</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">//Internal For UnitTest</span></span><br><span class="line"> <span class="keyword">internal</span> <span class="keyword">static</span> Func&lt;DateTime&gt; SetCurrentTime = () =&gt; DateTime.Now;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> DateTime Now</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="keyword">get</span></span><br><span class="line">  &#123;</span><br><span class="line">   <span class="keyword">return</span> SetCurrentTime();</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然後在在程式碼裡面使用的時候不直接使用DateTime.Now，改用SystemTime.Now</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">if</span> (SystemTime.Now == <span class="keyword">new</span> DateTime(<span class="number">2016</span>,<span class="number">10</span>,<span class="number">17</span>,<span class="number">12</span>,<span class="number">0</span>,<span class="number">0</span>))</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="string">&quot;時間到了&quot;</span>.Dump();</span><br><span class="line"> &#125; </span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> &#123;</span><br><span class="line">  <span class="string">&quot;時間不對&quot;</span>.Dump();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>之後單元測試驗證時，動態去改寫SetCurrentTime，就能確保拿到自己要的時間 </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SystemTime.SetCurrentTime = () =&gt; <span class="keyword">new</span> DateTime(<span class="number">2016</span>,<span class="number">10</span>,<span class="number">17</span>,<span class="number">12</span>,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>雖然這樣可以解決問題沒錯，但實在太麻煩，為了單元測試要多寫一堆Code之外，System底下很多東西有用到時，都要因為可以單元測試的關係而擴充出來。</p>
<p>還好之後有找到方法可以針對DLL做Fake，讓我們可以繼續安心使用DateTime.Now之餘，單元測試也能指定時間，接下來就來實作一下這個步驟</p>
<ul>
<li><p>  首先在單元測試的專案對參考的組件System按下右鍵，新增Fake物件</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-2CmHnA1rUMA/WARsswfjOPI/AAAAAAAAIBI/HGzYnnuIOzM6DuGEl8psJIIA4EtBmutgQCLcB/s1600/1.png)](https://4.bp.blogspot.com/-2CmHnA1rUMA/WARsswfjOPI/AAAAAAAAIBI/HGzYnnuIOzM6DuGEl8psJIIA4EtBmutgQCLcB/s1600/1.png)</div></li>
<li><p>  接著就會跑出Fake資料夾</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-QhvjMs19Dr4/WARtB33gWvI/AAAAAAAAIBM/ptqbpm0CKTgbi5C8CWZY3DjWbmykiJa4gCLcB/s1600/1.png)](https://3.bp.blogspot.com/-QhvjMs19Dr4/WARtB33gWvI/AAAAAAAAIBM/ptqbpm0CKTgbi5C8CWZY3DjWbmykiJa4gCLcB/s1600/1.png)</div></li>
<li><p>接著只要在單元測試的地方寫如此寫，就能設定DateTime.Now應該回傳的時間了```csharp<br>[TestMethod]</p>
<pre><code>  public void 取得現在時間()
  &#123;
      using (ShimsContext.Create())
      &#123;
          System.Fakes.ShimDateTime.NowGet= () =&gt;
          &#123;
              return new DateTime(2016, 9, 25);
          &#125;;

           //arrange
          var expected = new DateTime(2016, 9, 25);

          //act
          var actual = DateTime.Now;

          //assert
          Assert.AreEqual(expected, actual);
      &#125;
  &#125;
</code></pre>
</li>
</ul>
<p>```</p>
<h3 id="補充2017-01-24"><a href="#補充2017-01-24" class="headerlink" title="補充2017/01/24"></a><span style="color: red;">補充2017/01/24</span></h3><p>單元測試Fake的功能，以Visual Studio 2015來說只有Enterprise版本才有支援，所以使用的時候請特別小心，像今天公司因為授權費的關係，要求調降成Professional，之前有用到Fake的地方就都測不過了，還請特別注意</p>
<p>各版本比較 : <a target="_blank" rel="noopener" href="https://www.visualstudio.com/vs/compare/">Compare Visual Studio 2015 Offerings</a></p>
<h3 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a>參考文章</h3><div>[Huan-Lin - Microsoft Fakes 入門](http://huan-lin.blogspot.com/2012/10/microsoft-fakes.html)</div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/10/14/%E3%80%90Swagger%E3%80%91%E5%AE%A2%E8%A3%BD%E5%8C%96%E5%8F%AF%E4%BB%A5%E8%BC%B8%E5%85%A5Header%E7%9A%84%E6%AC%84%E4%BD%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/14/%E3%80%90Swagger%E3%80%91%E5%AE%A2%E8%A3%BD%E5%8C%96%E5%8F%AF%E4%BB%A5%E8%BC%B8%E5%85%A5Header%E7%9A%84%E6%AC%84%E4%BD%8D/" class="post-title-link" itemprop="url">【Swagger】客製化可以輸入Header的欄位</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-10-14 14:26:00" itemprop="dateCreated datePublished" datetime="2016-10-14T14:26:00+08:00">2016-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/10/14/%E3%80%90Swagger%E3%80%91%E5%AE%A2%E8%A3%BD%E5%8C%96%E5%8F%AF%E4%BB%A5%E8%BC%B8%E5%85%A5Header%E7%9A%84%E6%AC%84%E4%BD%8D/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/10/14/【Swagger】客製化可以輸入Header的欄位/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>上一篇<a target="_blank" rel="noopener" href="http://toyo0103.blogspot.tw/2016/10/swaggerapi.html">【Swagger】活著的API規格書</a>&nbsp;提到如何使用Swagger來產生規格與測試API，但遇到一個問題是，很多API會把驗證的Key放到Header傳遞，但Swagger產出來的頁面並沒有設定Header的地方，這時候就要來小調整一下已符合需求。</p>
<p>首先我們先把原本的API改成要吃Header的Key值才算驗證通過</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestSwaggerController</span> : <span class="title">ApiController</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 測試Swagger的API</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;parameter&quot;&gt;</span>The parameter.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        [<span class="meta">HttpGet</span>]</span><br><span class="line">        [<span class="meta">Route(<span class="meta-string">&quot;api/testSwagger&quot;</span>)</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> HttpResponseMessage <span class="title">Get</span>(<span class="params">[FromUri]testSwaggerGetParameter parameter</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//沒有帶Appkey在Header</span></span><br><span class="line">            <span class="keyword">if</span> (!Request.Headers.Contains(<span class="string">&quot;X-Key&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Request.CreateResponse(HttpStatusCode.NotAcceptable, <span class="string">&quot;必須輸入AppKey&quot;</span>);</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> AppKey =  Request.Headers.GetValues(<span class="string">&quot;X-Key&quot;</span>).FirstOrDefault();</span><br><span class="line">            <span class="keyword">if</span> (AppKey != <span class="string">&quot;MyKey&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Request.CreateResponse(HttpStatusCode.NotAcceptable, <span class="string">&quot;AppKey不正確!!!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (parameter != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                parameter.ID == <span class="string">&quot;toyo&quot;</span> &amp;&amp; </span><br><span class="line">                parameter.PassWord == <span class="string">&quot;123456&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> Request.CreateResponse(HttpStatusCode.OK, <span class="string">&quot;帳號密碼正確&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Request.CreateResponse(HttpStatusCode.OK, <span class="string">&quot;帳號密碼錯誤摟!!!!!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這時候測試一下原本的API，會發現因為吃不到Header裡面的X-Key，導致輸出驗證失敗的錯誤</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-hntf0ZIC-cQ/WAB1wx9JTOI/AAAAAAAAIAU/R5nql0g5UZwtIU6pdfk82zPO7EjDp4FggCLcB/s640/1.png)](https://1.bp.blogspot.com/-hntf0ZIC-cQ/WAB1wx9JTOI/AAAAAAAAIAU/R5nql0g5UZwtIU6pdfk82zPO7EjDp4FggCLcB/s1600/1.png)</div>

<p>Header中也再次確認沒有帶X-key在其中</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-pevW7o5r1eg/WAB2BE9-ayI/AAAAAAAAIAY/ErtqWFRqK7k0WBAKQXBZB32ghXOn3196gCLcB/s640/1.png)](https://1.bp.blogspot.com/-pevW7o5r1eg/WAB2BE9-ayI/AAAAAAAAIAY/ErtqWFRqK7k0WBAKQXBZB32ghXOn3196gCLcB/s1600/1.png)</div>

<h3 id="開始客製化吧"><a href="#開始客製化吧" class="headerlink" title="開始客製化吧"></a>開始客製化吧</h3><ul>
<li><p>  首先先建立一個JS檔，讓Swagger的View能引用這支JS，然後透過這支JS與Jquery去改View，我將這支JS就命名為AppKey.js</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-VdaLRHRtOlI/WAB3LAbaafI/AAAAAAAAIAc/tDB1aQ-EzzEutJ0RXZkrr4TRwvcWwFUnwCLcB/s1600/1.png)](https://1.bp.blogspot.com/-VdaLRHRtOlI/WAB3LAbaafI/AAAAAAAAIAc/tDB1aQ-EzzEutJ0RXZkrr4TRwvcWwFUnwCLcB/s1600/1.png)</div></li>
<li><p>  接著請在這支JS檔案寫下以下JS</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    $(<span class="string">&#x27;#input_apiKey&#x27;</span>).hide();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//加上Header區塊</span></span><br><span class="line">    <span class="keyword">var</span> HeaderBar = $(<span class="string">&#x27;&lt;div id=&quot;headerbar&quot;&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;h2 class=&quot;heading&quot;&gt;Header&lt;/h2&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;table style=&quot;background-color:#E8E8D0&quot;&gt;&lt;thead&gt;&lt;tr&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;th style=&quot;width: 100px; max-width: 100px&quot; data-sw-translate=&quot;&quot;&gt;Parameter&lt;/th&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;th style=&quot;width: 310px; max-width: 310px&quot; data-sw-translate=&quot;&quot;&gt;Value&lt;/th&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;th style=&quot;width: 200px; max-width: 200px&quot; data-sw-translate=&quot;&quot;&gt;Description&lt;/th&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/tr&gt;&lt;/thead&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;tbody class=&quot;operation-params&quot;&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;tr&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;td class=&quot;code required&quot;&gt;&lt;label for=&quot;custom_appkey&quot;&gt;appkey&lt;/label&gt;&lt;/td&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;td&gt;&lt;input class=&quot;parameter required&quot; minlength=&quot;1&quot; name=&quot;custom_appkey&quot; placeholder=&quot;(required)&quot; id=&quot;custom_appkey&quot; type=&quot;text&quot; value=&quot;&quot;&gt;&lt;/td&gt;&#x27;</span> +</span><br><span class="line">            <span class="string">&#x27;&lt;td class=&quot;markdown&quot;&gt;&lt;p&gt;AppKey&lt;/p&gt;&lt;/td&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/tr&gt;&#x27;</span> +</span><br><span class="line">        <span class="string">&#x27;&lt;/tbody&gt;&lt;/table&gt;&#x27;</span> +</span><br><span class="line">    <span class="string">&#x27;&lt;/div&gt;&#x27;</span>);</span><br><span class="line">    $(<span class="string">&#x27;#resources_container&#x27;</span>).before(HeaderBar);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把值加到Header</span></span><br><span class="line">    $(<span class="string">&#x27;#custom_appkey&#x27;</span>).on(<span class="string">&#x27;change&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> key = <span class="built_in">this</span>.value;</span><br><span class="line">        <span class="keyword">if</span> (key &amp;&amp; key.trim() !== <span class="string">&#x27;&#x27;</span>) &#123;</span><br><span class="line">            swaggerUi.api.clientAuthorizations.add(<span class="string">&quot;key&quot;</span>, <span class="keyword">new</span> SwaggerClient.ApiKeyAuthorization(<span class="string">&quot;X-Key&quot;</span>, key, <span class="string">&quot;header&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>主要內容就是抓到特定區塊，然後組Html用Jquery的方式放上去，然後透過Swagger開放的API塞到Header裡面送出</p>
<ul>
<li>  接著請將這支JS修改屬性 &gt; 建置動作 &gt; <strong>內嵌資源</strong></li>
</ul>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-BwLvO5AMcYw/WAB4kuDTvUI/AAAAAAAAIAg/QBIkgR01zCYDIxd2UjHmhHLanbuwCchqQCLcB/s320/1.png)](https://4.bp.blogspot.com/-BwLvO5AMcYw/WAB4kuDTvUI/AAAAAAAAIAg/QBIkgR01zCYDIxd2UjHmhHLanbuwCchqQCLcB/s1600/1.png)</div>

<ul>
<li>  打開SwaggerConfig找到188~189行的地方把註解拿掉改成如下<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-kG8umCQL1M0/WAB5FrxW2gI/AAAAAAAAIAo/RwoPyjGGq0YB1SE6f9jTvJ3h9mcveFFlQCLcB/s640/1.png)](https://2.bp.blogspot.com/-kG8umCQL1M0/WAB5FrxW2gI/AAAAAAAAIAo/RwoPyjGGq0YB1SE6f9jTvJ3h9mcveFFlQCLcB/s1600/1.png)</div>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">c.InjectJavaScript(thisAssembly, <span class="string">&quot;WebApplication1.CustomSwagger.AppKey.js&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li>  接著再次執行專案<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-jAdPbsrj5yI/WAB5_JNiKdI/AAAAAAAAIAs/7DMJc1iTBl4kAm6_7yTv2f4pmNCfqFEQQCLcB/s640/1.png)](https://2.bp.blogspot.com/-jAdPbsrj5yI/WAB5_JNiKdI/AAAAAAAAIAs/7DMJc1iTBl4kAm6_7yTv2f4pmNCfqFEQQCLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">Header欄位出現了</td></tr></tbody></table>
試試看欄位是否有效，因為剛剛程式是改成要帶**MyKey**，所以來測試看看</li>
</ul>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://1.bp.blogspot.com/-v7nxyvIuGfs/WAB6YhN2EEI/AAAAAAAAIAw/luDPe_40Fpc-xvazlnkwp6qEPRdUbKMvgCLcB/s640/1.png)](https://1.bp.blogspot.com/-v7nxyvIuGfs/WAB6YhN2EEI/AAAAAAAAIAw/luDPe_40Fpc-xvazlnkwp6qEPRdUbKMvgCLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">可以抓到X-Key了</td></tr></tbody></table>

<p>完成!!!! 因為是透過Jquery的方式去改變欄位，所以只要透過上述的方式去載入JS，要怎麼改View應該都不是問題了，以上。</p>
<h4 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a><strong>參考文章</strong></h4><p><a target="_blank" rel="noopener" href="http://stevemichelotti.com/customize-authentication-header-in-swaggerui-using-swashbuckle/">Customize Authentication Header in SwaggerUI using Swashbuckle</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/10/14/%E3%80%90Swagger%E3%80%91%E6%B4%BB%E8%91%97%E7%9A%84API%E8%A6%8F%E6%A0%BC%E6%9B%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/14/%E3%80%90Swagger%E3%80%91%E6%B4%BB%E8%91%97%E7%9A%84API%E8%A6%8F%E6%A0%BC%E6%9B%B8/" class="post-title-link" itemprop="url">【Swagger】活著的API規格書</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-10-14 11:01:00" itemprop="dateCreated datePublished" datetime="2016-10-14T11:01:00+08:00">2016-10-14</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/10/14/%E3%80%90Swagger%E3%80%91%E6%B4%BB%E8%91%97%E7%9A%84API%E8%A6%8F%E6%A0%BC%E6%9B%B8/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/10/14/【Swagger】活著的API規格書/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>所謂的工程師就是，【接手別人專案時，總是問怎麼沒有規格書? 自己開發專案時卻又不喜歡寫規格書】的一群人，本人也是一個極度不喜歡寫規格書的人，簡單說就是懶到極致，懶到深處無怨尤。而且常常改版時來匆匆忙忙，寫程式的時間都不夠了，誰還管你規格書有沒有更新，就這樣恍神個兩三次忘記回去更新規格，這本規格書就光榮列入公司十大(搞不好百大?)不可思議天書，可謂極度麻煩費時討厭…..</p>
<p>還好同事介紹了Swagger的用法，讓你邊開發程式時，規格就產生書產生出來了，而且還是本可以使用的規格書，讓你從今以後再也不用擔心規格書與實際規格脫鉤的問題，以下就筆記一下如何使用</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://4.bp.blogspot.com/-DHN0U1Vqe3U/WAA8GQA474I/AAAAAAAAH-o/idcyU1UFoPoM9sI2fs7Jga7vTRrA_Lz7gCLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://4.bp.blogspot.com/-DHN0U1Vqe3U/WAA8GQA474I/AAAAAAAAH-o/idcyU1UFoPoM9sI2fs7Jga7vTRrA_Lz7gCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">Swagger-當開發完API時，規格書也就完成了!!</td></tr></tbody></table><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://4.bp.blogspot.com/-Q_gy5BypWEQ/WAA8wzGS32I/AAAAAAAAH-s/dbAyDeDRpPgfEc-OjH9_s2GIaafUpCBjACLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://4.bp.blogspot.com/-Q_gy5BypWEQ/WAA8wzGS32I/AAAAAAAAH-s/dbAyDeDRpPgfEc-OjH9_s2GIaafUpCBjACLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">輸入的參數與說明也寫得清清楚楚</td></tr></tbody></table><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://1.bp.blogspot.com/-WbKmvP1AzgE/WAA-rbXKmUI/AAAAAAAAH-8/-tLhejDldqI_HmO2FNDS1gO6ImyOrrfngCLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)](https://1.bp.blogspot.com/-WbKmvP1AzgE/WAA-rbXKmUI/AAAAAAAAH-8/-tLhejDldqI_HmO2FNDS1gO6ImyOrrfngCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png)</td></tr><tr><td class="tr-caption" style="text-align: center;"><span style="font-size: 12.8px;">按下Try it Out後，可以馬上測試API跟觀看結果!!</span></td></tr></tbody></table>

<h3 id="使用步驟"><a href="#使用步驟" class="headerlink" title="使用步驟"></a>使用步驟</h3><div>

<ul>
<li>  首先我先開一個WebAPI專案，然後寫一支簡單的API讓他可以運作</div><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;"><a target="_blank" rel="noopener" href="https://1.bp.blogspot.com/-esv5JivSR4Y/WABBED8FfQI/AAAAAAAAH_E/YiqAJZ5gpAoLo97p4H6T6hp6ipz9r54mgCLcB/s1600/1.png"><img src="https://1.bp.blogspot.com/-esv5JivSR4Y/WABBED8FfQI/AAAAAAAAH_E/YiqAJZ5gpAoLo97p4H6T6hp6ipz9r54mgCLcB/s640/1.png"></a></td></tr><tr><td class="tr-caption" style="text-align: center;">開一個WebAPI專案</td></tr></tbody></table><table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-VmbQGY5UMMU/WABBEd25TPI/AAAAAAAAH_I/MGng_1nDDSEQ-zLiXyahRK5GTT9XMtSEwCLcB/s640/2.png)](https://3.bp.blogspot.com/-VmbQGY5UMMU/WABBEd25TPI/AAAAAAAAH_I/MGng_1nDDSEQ-zLiXyahRK5GTT9XMtSEwCLcB/s1600/2.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">新增一個新的TestSwaggerController</td></tr></tbody></table>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-AENbjbb3Ia4/WABBERDf0cI/AAAAAAAAH_M/Ea_va3RXz0kCcplepPRx-nBqaHHpLLsCwCLcB/s1600/3.png)](https://1.bp.blogspot.com/-AENbjbb3Ia4/WABBERDf0cI/AAAAAAAAH_M/Ea_va3RXz0kCcplepPRx-nBqaHHpLLsCwCLcB/s1600/3.png)</div><div>
</div><div>
</div><div>
</div><div></li>
</ul>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><ul>
<li><p><strong>開始撰寫幾個簡單的API跟輸入輸出參數</strong></p>
</div><div>
</div>```csharp
public class testSwaggerGetParameter
  {
      /// <summary>
      /// 帳號
      /// </summary>
      /// <value>
      /// The identifier.
      /// </value>
      public string ID { get; set; }

<pre><code>  /// &lt;summary&gt;
  /// 密碼
  /// &lt;/summary&gt;
  /// &lt;value&gt;
  /// The passWord.
  /// &lt;/value&gt;
  public string PassWord &#123; get; set; &#125;
</code></pre>
<p>  }</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;&#96;&#96;csharp</span><br><span class="line">public class TestSwaggerController : ApiController</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 測試Swagger的API</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;parameter&quot;&gt;The parameter.&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line">        [HttpGet]</span><br><span class="line">        [Route(&quot;api&#x2F;testSwagger&quot;)]</span><br><span class="line">        public HttpResponseMessage Get([FromUri]testSwaggerGetParameter parameter)</span><br><span class="line">        &#123;</span><br><span class="line">            if (parameter !&#x3D; null &amp;&amp;</span><br><span class="line">                parameter.ID &#x3D;&#x3D; &quot;toyo&quot; &amp;&amp; </span><br><span class="line">                parameter.PassWord &#x3D;&#x3D; &quot;123456&quot;)</span><br><span class="line">            &#123;</span><br><span class="line">                return Request.CreateResponse(HttpStatusCode.OK, &quot;帳號密碼正確&quot;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            return Request.CreateResponse(HttpStatusCode.OK, &quot;帳號密碼錯誤摟!!!!!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="-1"><a href="#-1" class="headerlink" title=""></a></h3><ul>
<li>  接著先來測試API的運作是否正常<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-NGEX0U-saSw/WABFAd9ksPI/AAAAAAAAH_c/AQuEDjoIGL4jbBYZs2PJ7B7lnAS7fB8xQCLcB/s640/2.png)](https://3.bp.blogspot.com/-NGEX0U-saSw/WABFAd9ksPI/AAAAAAAAH_c/AQuEDjoIGL4jbBYZs2PJ7B7lnAS7fB8xQCLcB/s1600/2.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">輸入正確的測試</td></tr></tbody></table>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://1.bp.blogspot.com/-i923xx2aY30/WABFABbQrdI/AAAAAAAAH_Y/cvhLOl1x6xw3aJ5Yvd-T7gBcePHTb8GCwCLcB/s640/1.png)](https://1.bp.blogspot.com/-i923xx2aY30/WABFABbQrdI/AAAAAAAAH_Y/cvhLOl1x6xw3aJ5Yvd-T7gBcePHTb8GCwCLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">輸入錯誤的測試</td></tr></tbody></table></li>
</ul>
<h3 id="-2"><a href="#-2" class="headerlink" title=""></a></h3><ul>
<li>  <strong>API都準備就緒後，來安裝Swagger吧</strong><br>首先打開Nuget搜尋<strong>Swashbuckle</strong>並安裝<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-I6T6On4UU0I/WABGKKbp_4I/AAAAAAAAH_g/thsWbtJB9d8M-wBG3oHoBHct0d6N-7ohwCLcB/s640/1.png)](https://1.bp.blogspot.com/-I6T6On4UU0I/WABGKKbp_4I/AAAAAAAAH_g/thsWbtJB9d8M-wBG3oHoBHct0d6N-7ohwCLcB/s1600/1.png)</div></li>
</ul>
<p>接著打開專案屬性，設定輸出XML說明格式</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-Q35LXg-ZAbc/WABHQqOA9II/AAAAAAAAH_o/IqpSnKPL7AIkGskPH8LPMKDBYKS-cJvNACLcB/s640/1.png)](https://3.bp.blogspot.com/-Q35LXg-ZAbc/WABHQqOA9II/AAAAAAAAH_o/IqpSnKPL7AIkGskPH8LPMKDBYKS-cJvNACLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-kTvzjXCAY7Q/WABHWnjk79I/AAAAAAAAH_s/WYApFDnj0RACcVPP3KQC9qGsgdxf3a3swCLcB/s640/2.png)](https://2.bp.blogspot.com/-kTvzjXCAY7Q/WABHWnjk79I/AAAAAAAAH_s/WYApFDnj0RACcVPP3KQC9qGsgdxf3a3swCLcB/s1600/2.png)</div>

<p>打開SwaggerConfig做些設定</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-3KPOfrFBs7A/WABHvcNMO4I/AAAAAAAAH_w/-tsOz_SqAGcvVxxSOOwok_Q1yTpZyDAiQCLcB/s1600/1.png)](https://1.bp.blogspot.com/-3KPOfrFBs7A/WABHvcNMO4I/AAAAAAAAH_w/-tsOz_SqAGcvVxxSOOwok_Q1yTpZyDAiQCLcB/s1600/1.png)</div>

<p>在第一百行的地方把註解拿掉</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-sNuzZJH1_Tk/WABH-ckCYAI/AAAAAAAAH_0/dY91muQCTvAggbaSNAxXFuf687P37-f4wCLcB/s640/1.png)](https://2.bp.blogspot.com/-sNuzZJH1_Tk/WABH-ckCYAI/AAAAAAAAH_0/dY91muQCTvAggbaSNAxXFuf687P37-f4wCLcB/s1600/1.png)</div>

<p>在最下面補上以下程式碼</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-LZWGCrO2m1E/WABIPqVRXuI/AAAAAAAAH_4/XDwqWQFF4zIfyBMKgjUfNqisGADqPMPvQCLcB/s640/1.png)](https://2.bp.blogspot.com/-LZWGCrO2m1E/WABIPqVRXuI/AAAAAAAAH_4/XDwqWQFF4zIfyBMKgjUfNqisGADqPMPvQCLcB/s1600/1.png)</div>

<h3 id="-3"><a href="#-3" class="headerlink" title=""></a></h3><ul>
<li>  重新執行WebAPI，並且在網址列輸入……./Swagger<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-VKr_8qKHN7Y/WABIxRpt8gI/AAAAAAAAH_8/XaVeA3uG-9whtv0DrZ7DQYIzKXjaHryYgCLcB/s640/1.png)](https://2.bp.blogspot.com/-VKr_8qKHN7Y/WABIxRpt8gI/AAAAAAAAH_8/XaVeA3uG-9whtv0DrZ7DQYIzKXjaHryYgCLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">看到API被輸出成規格了，參數的註解是跟著Summary的</td></tr></tbody></table><div>
</div><div>
</div><div>
</div><div>來測試看看!!!</div><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-651X7h-rIVw/WABJN-3Jf-I/AAAAAAAAIAA/iBthsKVDiscN_ItWjk4WUUSgemSLEfDLQCLcB/s640/1.png)](https://1.bp.blogspot.com/-651X7h-rIVw/WABJN-3Jf-I/AAAAAAAAIAA/iBthsKVDiscN_ItWjk4WUUSgemSLEfDLQCLcB/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-JPjRZMJusSE/WABJOPutBbI/AAAAAAAAIAE/aFON9GjhDe0HKHY_jjJ8M8JfstfCDLoLgCLcB/s640/2.png)](https://3.bp.blogspot.com/-JPjRZMJusSE/WABJOPutBbI/AAAAAAAAIAE/aFON9GjhDe0HKHY_jjJ8M8JfstfCDLoLgCLcB/s1600/2.png)</div><div>
</div><div>
</div><div>
</div><div>
</div><div>最後，Swagger雖然已經非常好用了，也能符合大部分的情境運用，但還是有些美中不足的地方，例如如果今天API部分資訊要帶在Header裡面傳給API，在預設產生的地方是沒有提供可以輸入的地方。</div><div>
</div><div>但慶幸的是Swagger可以很彈性的去改寫這張最後會產生的View，可以自己擴充需要的欄位，下一篇在來介紹如何客製化Swagger頁面!!!</div><div>
</div><div>
</div><div>
</div><div>
</div></li>
</ul>
<h4 id="參考文章"><a href="#參考文章" class="headerlink" title="參考文章"></a>參考文章</h4><div>

<ol>
<li> <a target="_blank" rel="noopener" href="http://kevintsengtw.blogspot.tw/2015/12/aspnet-web-api-swagger.html">mrkt&nbsp;- ASP.NET Web API 文件產生器 - 使用 Swagger</a></li>
<li> <a target="_blank" rel="noopener" href="http://kevintsengtw.blogspot.tw/2015/12/swashbuckle-swagger-for-web-api.html">mrkt-&nbsp;Swashbuckle - Swagger for Web Api 顯示內容的調整</a></div><div></div><div>
</div></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/10/12/%E7%94%A8-FluentValidation-%E9%A9%97%E8%AD%89%E5%8F%83%E6%95%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/10/12/%E7%94%A8-FluentValidation-%E9%A9%97%E8%AD%89%E5%8F%83%E6%95%B8/" class="post-title-link" itemprop="url">用 FluentValidation 驗證參數</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-10-12 15:12:00" itemprop="dateCreated datePublished" datetime="2016-10-12T15:12:00+08:00">2016-10-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/10/12/%E7%94%A8-FluentValidation-%E9%A9%97%E8%AD%89%E5%8F%83%E6%95%B8/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/10/12/用-FluentValidation-驗證參數/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>FluentValidation是個很不錯的套件，且擴充性也高，解決了一些以前常常要寫很多遍的驗證邏輯。 <a target="_blank" rel="noopener" href="https://2.bp.blogspot.com/-7V1LvfPGBlQ/V_3PMBxBPFI/AAAAAAAAH-Y/24jx-pArEUk_I3Gp2_SJwVOzy7CQ8asYgCLcB/s1600/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png"><img src="https://2.bp.blogspot.com/-7V1LvfPGBlQ/V_3PMBxBPFI/AAAAAAAAH-Y/24jx-pArEUk_I3Gp2_SJwVOzy7CQ8asYgCLcB/s640/%25E6%259C%25AA%25E5%2591%25BD%25E5%2590%258D.png"></a></p>
<p>以前常常驗證參數時都會有很多的If..Else，搞得程式碼很長很醜之外，閱讀性不佳。自從公司同事推薦了這個套件後，用了兩三個專案發現程式碼變得簡潔易懂之外，寫了一些擴充方法也可以重複使用，不像以前常常重複造輪子</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">var</span> Parameter = <span class="keyword">new</span> APIInputParameter </span><br><span class="line"> &#123;</span><br><span class="line">  ID = <span class="string">&quot;123&quot;</span>,</span><br><span class="line">  Name = <span class="string">&quot;Toyo&quot;</span></span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> Guid _ID;</span><br><span class="line"> <span class="comment">//驗證邏輯</span></span><br><span class="line"> <span class="keyword">if</span> (<span class="built_in">string</span>.IsNullOrWhiteSpace(Parameter.ID) ||</span><br><span class="line">           !Guid.TryParse(Parameter.ID,<span class="keyword">out</span> _ID) ||</span><br><span class="line">     <span class="built_in">string</span>.IsNullOrWhiteSpace(Parameter.Name) )</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="string">&quot;參數錯誤&quot;</span>.Dump();</span><br><span class="line"> &#125;</span><br><span class="line"> <span class="keyword">else</span></span><br><span class="line"> &#123;</span><br><span class="line">  <span class="string">&quot;參數正確&quot;</span>.Dump();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">APIInputParameter</span> </span><br><span class="line">&#123;</span><br><span class="line"> <span class="comment">//此參數應該為Guid，但為了能Log下來所以接的時候要先接成String</span></span><br><span class="line"> <span class="comment">//否則輸入端不是傳入GUID就記錄不到了</span></span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> ID &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"> <span class="keyword">public</span> <span class="built_in">string</span> Name &#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>上面的範例是以前的寫法，常常欄位多，各個欄位又有不同的要求時，總是把驗證的邏輯寫得又臭又長。</p>
<p>加上公司要求所有輸入輸出的欄位都要被Log下來，所以基本上參數都要是String型別，否則如果ID寫成GUID，因為傳入的時候不是GUID會接不到，自然無法被Log到，但也因此衍生了驗證的複雜度提高的問題。</p>
<p>想想如果各個參數錯誤要回傳的訊息會不同時，又該寫的多複雜才做得到呢……</p>
<p>那讓來看看如何透FluentValidation 驗證參數，</p>
<ol>
<li> 首先先把驗證邏輯寫成一個Class<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">APIInputParameterValidator</span> : <span class="title">AbstractValidator</span>&lt;<span class="title">APIInputParameter</span>&gt;&#123;</span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="title">APIInputParameterValidator</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span> &#123;</span><br><span class="line">  <span class="comment">//ID - 必填，應為GUID</span></span><br><span class="line">  <span class="keyword">this</span>.RuleFor(x =&gt; x.ID)</span><br><span class="line">     .NotEmpty()</span><br><span class="line">     .WithErrorCode(<span class="string">&quot;X400&quot;</span>)</span><br><span class="line">     .WithMessage(<span class="string">&quot;ID不得為空字串&quot;</span>)</span><br><span class="line">     .NotNull()</span><br><span class="line">     .WithErrorCode(<span class="string">&quot;X400&quot;</span>)</span><br><span class="line">     .WithMessage(<span class="string">&quot;ID不得為Null&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.RuleFor(x =&gt; x.Name)</span><br><span class="line">   .NotEmpty()</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;X401&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;Name不得為空字串&quot;</span>)</span><br><span class="line">   .NotNull()</span><br><span class="line">   .WithErrorCode(<span class="string">&quot;X401&quot;</span>)</span><br><span class="line">   .WithMessage(<span class="string">&quot;Name不得為Null&quot;</span>);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<ol start="2">
<li>自己寫一個HasError的Extension```csharp<br>/// <summary><br>/// FluentValidation 自訂驗證擴充方法.<br>/// </summary><br>public static class FluentValidationExtensions<br>{<br>/// <summary><br>/// 驗證結果是否有 Error.<br>/// </summary><br>/// <param name="validationFailure"></param><br>/// <returns></returns><br>public static bool HasError(this ValidationFailure validationFailure)<br>{<br>return validationFailure != null &amp;&amp;<br> !string.IsNullOrWhiteSpace(validationFailure.ErrorMessage);<br>}<br>}</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">3.  驗證的地方改成如下 &#96;&#96;&#96;csharp</span><br><span class="line">var Parameter &#x3D; new APIInputParameter &#123;</span><br><span class="line">  ID &#x3D; &quot;123&quot;,</span><br><span class="line">  Name &#x3D; &quot;Toyo&quot;</span><br><span class="line"> &#125;;</span><br><span class="line"> &#x2F;&#x2F; 檢查輸入參數</span><br><span class="line"> var validator &#x3D; new APIInputParameterValidator();</span><br><span class="line"></span><br><span class="line">     var error &#x3D; validator.Validate(Parameter).Errors.FirstOrDefault();</span><br><span class="line"> if (error.HasError())</span><br><span class="line"> &#123;</span><br><span class="line">   string.Format(&quot;&#123;0&#125;-&#123;1&#125;&quot;,error.ErrorCode,error.ErrorMessage).Dump();</span><br><span class="line"> &#125;</span><br><span class="line"> else</span><br><span class="line"> &#123;</span><br><span class="line">   &quot;驗證成功&quot;.Dump();</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這樣只要有參數帶入錯誤，他就會依照你要求的帶回ErrorCode跟ErrorMessage，那可能各位會發現，阿驗證是否為GUID的地方怎麼不見了?? 因為套件並沒有提供，所以這邊要自己擴充</p>
<ol>
<li><p>先寫一個驗證String是否為Guid的方法 ```csharp<br>/// <summary><br> /// 驗證是否為GUID<br> /// </summary><br> /// <seealso cref="FluentValidation.Validators.PropertyValidator" /><br> public class GUIDValidator : PropertyValidator<br> {</p>
<pre><code> /// &lt;summary&gt;
 /// 是否允許字串參數為空白.
 /// &lt;/summary&gt;
 /// &lt;value&gt;&lt;c&gt;true&lt;/c&gt; if [allow empty]; otherwise, &lt;c&gt;false&lt;/c&gt;.&lt;/value&gt;
 private bool AllowEmpty &#123; get; set; &#125;

     /// &lt;summary&gt;
 /// Initializes a new instance of the &lt;see cref=&quot;GUIDValidator&quot;/&gt; class.
 /// &lt;/summary&gt;
 /// &lt;param name=&quot;allowEmpty&quot;&gt;if set to &lt;c&gt;true&lt;/c&gt; [allow empty].&lt;/param&gt;
 public GUIDValidator(
     bool allowEmpty = false) : base(&quot;傳入參數錯誤。&quot;)
 &#123;
     this.AllowEmpty = allowEmpty;
 &#125;

     /// &lt;summary&gt;
 /// Returns true if ... is valid.
 /// &lt;/summary&gt;
 /// &lt;param name=&quot;context&quot;&gt;The context.&lt;/param&gt;
 /// &lt;returns&gt;
 ///   &lt;c&gt;true&lt;/c&gt; if the specified context is valid; otherwise, &lt;c&gt;false&lt;/c&gt;.
 /// &lt;/returns&gt;
 protected override bool IsValid(PropertyValidatorContext context)
 &#123;
     var propertyValue = context.PropertyValue as string;

         if (AllowEmpty &amp;&amp;
         string.IsNullOrWhiteSpace(propertyValue))
     &#123;
         return true;
     &#125;

         Guid guid;
     return Guid.TryParse(propertyValue, out guid);
 &#125;
</code></pre>
<p> }</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">2.  接著在Extension的地方補上兩個擴充方法，分別是【應該是GUID】、【應該是GUID但允許其為空字串或Null】 &#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">&#x2F;&#x2F;&#x2F; FluentValidation 自訂驗證擴充方法.</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">public static class FluentValidationExtensions</span><br><span class="line">&#123;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; 驗證結果是否有 Error.</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;validationFailure&quot;&gt;&lt;&#x2F;param&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;returns&gt;&lt;&#x2F;returns&gt;</span><br><span class="line"> public static bool HasError(this ValidationFailure validationFailure)</span><br><span class="line"> &#123;</span><br><span class="line">  return validationFailure !&#x3D; null &amp;&amp;</span><br><span class="line">    !string.IsNullOrWhiteSpace(validationFailure.ErrorMessage);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">     &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; 應該是 GUID 型別.</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;typeparam name&#x3D;&quot;T&quot;&gt;&lt;&#x2F;typeparam&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;typeparam name&#x3D;&quot;TProperty&quot;&gt;The type of the t property.&lt;&#x2F;typeparam&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;ruleBuilder&quot;&gt;The rule builder.&lt;&#x2F;param&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;returns&gt;IRuleBuilderOptions&lt;T, TProperty&gt;.&lt;&#x2F;returns&gt;</span><br><span class="line"> public static IRuleBuilderOptions&lt;T, TProperty&gt; IsGUID&lt;T, TProperty&gt;(</span><br><span class="line">  this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)</span><br><span class="line"> &#123;</span><br><span class="line">  return ruleBuilder.SetValidator(new GUIDValidator(allowEmpty: false));</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">     &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; 應該是 GUID 型別, 但允許 String.Empty.</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;typeparam name&#x3D;&quot;T&quot;&gt;&lt;&#x2F;typeparam&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;typeparam name&#x3D;&quot;TProperty&quot;&gt;The type of the t property.&lt;&#x2F;typeparam&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;ruleBuilder&quot;&gt;The rule builder.&lt;&#x2F;param&gt;</span><br><span class="line"> &#x2F;&#x2F;&#x2F; &lt;returns&gt;IRuleBuilderOptions&lt;T, TProperty&gt;.&lt;&#x2F;returns&gt;</span><br><span class="line"> public static IRuleBuilderOptions&lt;T, TProperty&gt; IsGUIDAllowEmpty&lt;T, TProperty&gt;(</span><br><span class="line">  this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)</span><br><span class="line"> &#123;</span><br><span class="line">  return ruleBuilder.SetValidator(new GUIDValidator(allowEmpty: true));</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li> 接著在原本驗證的地方補上<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ID - 必填，應為GUID</span></span><br><span class="line"><span class="keyword">this</span>.RuleFor(x =&gt; x.ID)</span><br><span class="line">  .NotEmpty()</span><br><span class="line">  .WithErrorCode(<span class="string">&quot;X400&quot;</span>)</span><br><span class="line">  .WithMessage(<span class="string">&quot;ID不得為空字串&quot;</span>)</span><br><span class="line">  .NotNull()</span><br><span class="line">  .WithErrorCode(<span class="string">&quot;X400&quot;</span>)</span><br><span class="line">  .WithMessage(<span class="string">&quot;ID不得為Null&quot;</span>)</span><br><span class="line">  .IsGUID()</span><br><span class="line">  .WithErrorCode(<span class="string">&quot;X400&quot;</span>)</span><br><span class="line">  .WithMessage(<span class="string">&quot;ID應為GUID&quot;</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<p>再執行原本的驗證就會得到錯誤訊息 <strong>X400-ID應為GUID</strong><br>對我來說不止讓程式可讀性增加之外，也讓驗證的地方被分離出來，做到所謂的關注點分離</p>
<p>以下補上幾個我常常用到的驗證擴充出來的方法供各位參考，再強調一次，因為公司要求輸入輸出都要被Log下來，所以所有參數都是從String出發去驗證</p>
<ul>
<li><p><strong><span style="color: #0c343d;">驗證是否為DateTime or TimeStamp</span></strong></p>
  <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 驗證是否為DateTime</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;seealso cref=&quot;FluentValidation.Validators.PropertyValidator&quot; /&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">DateTimeValidator</span> : <span class="title">PropertyValidator</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否允許參數為空白.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span><span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> if [allow empty]; otherwise, <span class="doctag">&lt;c&gt;</span>false<span class="doctag">&lt;/c&gt;</span>.<span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> AllowEmpty &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Initializes a new instance of the <span class="doctag">&lt;see cref=&quot;DateTimeValidator&quot;/&gt;</span> class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;allowEmpty&quot;&gt;</span>if set to <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> [allow empty].<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">DateTimeValidator</span>(<span class="params"><span class="built_in">bool</span> allowEmpty</span>) : <span class="title">base</span>(<span class="params"><span class="string">&quot;型別錯誤&quot;</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.AllowEmpty = allowEmpty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Returns true if ... is valid.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span>The context.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> if the specified context is valid; otherwise, <span class="doctag">&lt;c&gt;</span>false<span class="doctag">&lt;/c&gt;</span>.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsValid</span>(<span class="params">PropertyValidatorContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> propertyValue = context.PropertyValue <span class="keyword">as</span> <span class="built_in">string</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.AllowEmpty &amp;&amp;</span><br><span class="line">                <span class="built_in">string</span>.IsNullOrWhiteSpace(propertyValue))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                <span class="built_in">int</span> <span class="keyword">value</span>;</span><br><span class="line">            <span class="built_in">bool</span> result = <span class="built_in">int</span>.TryParse(propertyValue, <span class="keyword">out</span> <span class="keyword">value</span>);</span><br><span class="line">            <span class="comment">//TimeStamp</span></span><br><span class="line">            <span class="keyword">if</span> (result &amp;&amp; <span class="keyword">value</span> &gt; <span class="number">0</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                DateTime dateTimeValue;</span><br><span class="line">            <span class="keyword">return</span> DateTime.TryParse(propertyValue, <span class="keyword">out</span> dateTimeValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>擴充方法</strong>```csharp<br>/// <summary><br>        /// 是 DateTime 型別 or TimeStamp .<br>        /// </summary><br>        /// <typeparam name="T"></typeparam><br>        /// <typeparam name="TProperty">The type of the t property.</typeparam><br>        /// <param name="ruleBuilder">The rule builder.</param><br>        /// <returns>IRuleBuilderOptions&lt;T, TProperty&gt;.</returns><br>        public static IRuleBuilderOptions&lt;T, TProperty&gt; IsDateTimeOrTimeStamp&lt;T, TProperty&gt;(<br>            this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)<br>        {<br>            return ruleBuilder.SetValidator(new DateTimeValidator(allowEmpty: false));<br>        }</p>
<pre><code>        /// &lt;summary&gt;
    /// 是 DateTime 型別 or TimeStamp, 但允許 String.Empty.
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the t property.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;returns&gt;IRuleBuilderOptions&amp;lt;T, TProperty&amp;gt;.&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsDateTimeOrTimeStampAllowEmpty&lt;T, TProperty&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)
    &#123;
        return ruleBuilder.SetValidator(new DateTimeValidator(allowEmpty: true));
    &#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">*   **&lt;span style&#x3D;&quot;color: #073763;&quot;&gt;驗證是否為GUID Array &lt;&#x2F;span&gt;**</span><br><span class="line"></span><br><span class="line">    &#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 驗證是否為GUID Array</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public class GUIDArrayValidator : PropertyValidator</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 是否允許字串參數為空白.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;value&gt;&lt;c&gt;true&lt;&#x2F;c&gt; if [allow empty]; otherwise, &lt;c&gt;false&lt;&#x2F;c&gt;.&lt;&#x2F;value&gt;</span><br><span class="line">        private bool AllowEmpty &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Initializes a new instance of the &lt;see cref&#x3D;&quot;GUIDArrayValidator&quot;&#x2F;&gt; class.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;allowEmpty&quot;&gt;if set to &lt;c&gt;true&lt;&#x2F;c&gt; [allow empty].&lt;&#x2F;param&gt;</span><br><span class="line">        public GUIDArrayValidator(</span><br><span class="line">            bool allowEmpty &#x3D; false) :base(&quot;傳入參數錯誤。&quot;)</span><br><span class="line">        &#123;</span><br><span class="line">            this.AllowEmpty &#x3D; allowEmpty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Returns true if ... is valid.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;context&quot;&gt;The context.&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;returns&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F;   &lt;c&gt;true&lt;&#x2F;c&gt; if the specified context is valid; otherwise, &lt;c&gt;false&lt;&#x2F;c&gt;.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;returns&gt;</span><br><span class="line">        protected override bool IsValid(PropertyValidatorContext context)</span><br><span class="line">        &#123;</span><br><span class="line">            var propertyValue &#x3D; context.PropertyValue as List&lt;string&gt;;</span><br><span class="line">            if (AllowEmpty &amp;&amp;</span><br><span class="line">                (propertyValue &#x3D;&#x3D; null || propertyValue.Count &#x3D;&#x3D; 0))</span><br><span class="line">            &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                if (!AllowEmpty &amp;&amp;</span><br><span class="line">                (propertyValue &#x3D;&#x3D; null || propertyValue.Count &#x3D;&#x3D; 0))</span><br><span class="line">            &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                Guid guid;</span><br><span class="line">            foreach (var item in propertyValue)</span><br><span class="line">            &#123;</span><br><span class="line">                if (!Guid.TryParse(item, out guid))</span><br><span class="line">                &#123;</span><br><span class="line">                    return false;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                return true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>擴充方法</strong>```csharp<br>/// <summary><br>        /// 是 Guid Array, 但允許空集合.<br>        /// </summary><br>        /// <typeparam name="T"></typeparam><br>        /// <typeparam name="TProperty">The type of the t property.</typeparam><br>        /// <param name="ruleBuilder">The rule builder.</param><br>        /// <returns>IRuleBuilderOptions&lt;T, TProperty&gt;.</returns><br>        public static IRuleBuilderOptions&lt;T, TProperty&gt; IsGUIDArrayAllowEmpty&lt;T, TProperty&gt;(<br>            this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)<br>        {<br>            return ruleBuilder.SetValidator(new GUIDArrayValidator(allowEmpty: true));<br>        }</p>
<pre><code>        /// &lt;summary&gt;
    /// 是 Guid Array.
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the t property.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;returns&gt;IRuleBuilderOptions&amp;lt;T, TProperty&amp;gt;.&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsGUIDArray&lt;T, TProperty&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)
    &#123;
        return ruleBuilder.SetValidator(new GUIDArrayValidator(allowEmpty: false));
    &#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">*   **&lt;span style&#x3D;&quot;color: #073763;&quot;&gt;驗證是否為數字 &lt;&#x2F;span&gt;**</span><br><span class="line"></span><br><span class="line">    &#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 驗證是否為Integer</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;seealso cref&#x3D;&quot;FluentValidation.Validators.PropertyValidator&quot; &#x2F;&gt;</span><br><span class="line">    public class IntegerValidator : PropertyValidator</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 是否允許字串參數為空白.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;value&gt;&lt;c&gt;true&lt;&#x2F;c&gt; if [allow empty]; otherwise, &lt;c&gt;false&lt;&#x2F;c&gt;.&lt;&#x2F;value&gt;</span><br><span class="line">        private bool AllowEmpty &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Initializes a new instance of the &lt;see cref&#x3D;&quot;IntegerValidator&quot;&#x2F;&gt; class.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;allowEmpty&quot;&gt;if set to &lt;c&gt;true&lt;&#x2F;c&gt; [allow empty].&lt;&#x2F;param&gt;</span><br><span class="line">        public IntegerValidator(bool allowEmpty &#x3D; false)</span><br><span class="line">            : base(&quot;型別錯誤&quot;)</span><br><span class="line">        &#123;</span><br><span class="line">            this.AllowEmpty &#x3D; allowEmpty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; Returns true if ... is valid.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;param name&#x3D;&quot;context&quot;&gt;The context.&lt;&#x2F;param&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;returns&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F;   &lt;c&gt;true&lt;&#x2F;c&gt; if the specified context is valid; otherwise, &lt;c&gt;false&lt;&#x2F;c&gt;.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;returns&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;exception cref&#x3D;&quot;NotImplementedException&quot;&gt;&lt;&#x2F;exception&gt;</span><br><span class="line">        protected override bool IsValid(PropertyValidatorContext context)</span><br><span class="line">        &#123;</span><br><span class="line">            var propertyValue &#x3D; context.PropertyValue as string;</span><br><span class="line"></span><br><span class="line">                if (this.AllowEmpty &amp;&amp;</span><br><span class="line">                string.IsNullOrWhiteSpace(propertyValue))</span><br><span class="line">            &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                int value;</span><br><span class="line">            bool result &#x3D; int.TryParse(propertyValue, out value);</span><br><span class="line">            return result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>擴充方法</strong>```csharp<br>/// <summary><br>        /// 是 Integer 型別.<br>        /// </summary><br>        /// <typeparam name="T"></typeparam><br>        /// <typeparam name="TProperty">The type of the t property.</typeparam><br>        /// <param name="ruleBuilder">The rule builder.</param><br>        /// <returns>IRuleBuilderOptions&lt;T, TProperty&gt;.</returns><br>        public static IRuleBuilderOptions&lt;T, TProperty&gt; IsInteger&lt;T, TProperty&gt;(<br>            this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)<br>        {<br>            return ruleBuilder.SetValidator(new IntegerValidator(allowEmpty: false));<br>        }</p>
<pre><code>        /// &lt;summary&gt;
    /// 是 Integer 型別, 但允許 String.Empty.
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the t property.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;returns&gt;IRuleBuilderOptions&amp;lt;T, TProperty&amp;gt;.&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsIntegerAllowEmpty&lt;T, TProperty&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)
    &#123;
        return ruleBuilder.SetValidator(new IntegerValidator(allowEmpty: true));
    &#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">*   **&lt;span style&#x3D;&quot;color: #073763;&quot;&gt;檢查數字是否在要求範圍內 &lt;&#x2F;span&gt;**</span><br><span class="line"></span><br><span class="line">    &#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; 驗證數字是否在範圍內</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;typeparam name&#x3D;&quot;TNumeric&quot;&gt;The type of the numeric.&lt;&#x2F;typeparam&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;seealso cref&#x3D;&quot;FluentValidation.Validators.PropertyValidator&quot; &#x2F;&gt;</span><br><span class="line">    public class NumericBetweenInValidator&lt;TNumeric&gt; : PropertyValidator</span><br><span class="line">        where TNumeric : IComparable</span><br><span class="line">    &#123;</span><br><span class="line">        private TNumeric compareValueUp;</span><br><span class="line"></span><br><span class="line">            private TNumeric compareValueDown;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 是否允許字串參數為空白.</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;value&gt;&lt;c&gt;true&lt;&#x2F;c&gt; if [allow empty]; otherwise, &lt;c&gt;false&lt;&#x2F;c&gt;.&lt;&#x2F;value&gt;</span><br><span class="line">        private bool AllowEmpty &#123; get; set; &#125;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 轉型是否成功</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        private bool IsConvertable;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">        &#x2F;&#x2F;&#x2F; 是否允許等於輸入的上下閥值值</span><br><span class="line">        &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">        private bool AllowEquals;</span><br><span class="line"></span><br><span class="line">            public NumericBetweenInValidator(</span><br><span class="line">            string valueUp,</span><br><span class="line">            string valueDown,</span><br><span class="line">            bool allowEquals &#x3D; false,</span><br><span class="line">            bool allowEmpty &#x3D; false) : base(&quot;傳入參數錯誤。&quot;)</span><br><span class="line">        &#123;</span><br><span class="line">            this.compareValueUp &#x3D; ConvertHelper.ToT&lt;TNumeric&gt;(valueUp, out IsConvertable);</span><br><span class="line"></span><br><span class="line">                this.compareValueDown &#x3D; ConvertHelper.ToT&lt;TNumeric&gt;(valueDown, out IsConvertable);</span><br><span class="line"></span><br><span class="line">                this.AllowEquals &#x3D; allowEquals;</span><br><span class="line">            this.AllowEmpty &#x3D; allowEmpty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            protected override bool IsValid(PropertyValidatorContext context)</span><br><span class="line">        &#123;</span><br><span class="line">            var propertyValue &#x3D; context.PropertyValue as string;</span><br><span class="line"></span><br><span class="line">                if (this.AllowEmpty &amp;&amp;</span><br><span class="line">                string.IsNullOrWhiteSpace(propertyValue))</span><br><span class="line">            &#123;</span><br><span class="line">                return true;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            var value &#x3D; ConvertHelper.ToT&lt;TNumeric&gt;(propertyValue, out IsConvertable);</span><br><span class="line"></span><br><span class="line">                if (!IsConvertable)</span><br><span class="line">            &#123;</span><br><span class="line">                return false;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                &#x2F;&#x2F; -1 value &lt; compareValue</span><br><span class="line">            &#x2F;&#x2F; 0  value &#x3D; compareValue</span><br><span class="line">            &#x2F;&#x2F; 1  value &gt; compareValue</span><br><span class="line">            if (AllowEquals)</span><br><span class="line">            &#123;</span><br><span class="line">                return value.CompareTo(compareValueDown) &gt;&#x3D; 0</span><br><span class="line">                       &amp;&amp; value.CompareTo(compareValueUp) &lt;&#x3D; 0;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                return value.CompareTo(compareValueDown) &gt; 0</span><br><span class="line">                   &amp;&amp; value.CompareTo(compareValueUp) &lt; 0;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Class ConvertHelper</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">ConvertHelper</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 轉型成 T.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;typeparam name=&quot;T&quot;&gt;</span><span class="doctag">&lt;/typeparam&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;value&quot;&gt;</span>The value.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;exception cref=&quot;System.ArgumentException&quot;&gt;</span>Convert fail.;Convert<span class="doctag">&lt;/exception&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> T <span class="title">ToT</span>&lt;<span class="title">T</span>&gt;(<span class="params"><span class="built_in">string</span> <span class="keyword">value</span>, <span class="keyword">out</span> <span class="built_in">bool</span> result</span>) <span class="keyword">where</span> T : IComparable</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            result = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">switch</span> (Type.GetTypeCode(<span class="keyword">typeof</span>(T)))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">case</span> TypeCode.Double:</span><br><span class="line"></span><br><span class="line">                            <span class="built_in">double</span> doubleValue;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">double</span>.TryParse(<span class="keyword">value</span>, <span class="keyword">out</span> doubleValue))</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> (T)(<span class="built_in">object</span>)Convert.ToDouble(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> TypeCode.Int16:</span><br><span class="line"></span><br><span class="line">                            Int16 int16Value;</span><br><span class="line">                        <span class="keyword">if</span> (Int16.TryParse(<span class="keyword">value</span>, <span class="keyword">out</span> int16Value))</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> (T)(<span class="built_in">object</span>)Convert.ToInt16(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> TypeCode.Int32:</span><br><span class="line"></span><br><span class="line">                            Int32 int32Value;</span><br><span class="line">                        <span class="keyword">if</span> (Int32.TryParse(<span class="keyword">value</span>, <span class="keyword">out</span> int32Value))</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> (T)(<span class="built_in">object</span>)Convert.ToInt32(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> TypeCode.Int64:</span><br><span class="line"></span><br><span class="line">                            Int64 int64Value;</span><br><span class="line">                        <span class="keyword">if</span> (Int64.TryParse(<span class="keyword">value</span>, <span class="keyword">out</span> int64Value))</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> (T)(<span class="built_in">object</span>)Convert.ToInt64(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">case</span> TypeCode.Decimal:</span><br><span class="line"></span><br><span class="line">                            <span class="built_in">decimal</span> decimalValue;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">decimal</span>.TryParse(<span class="keyword">value</span>, <span class="keyword">out</span> decimalValue))</span><br><span class="line">                        &#123;</span><br><span class="line">                            result = <span class="literal">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">return</span> (T)(<span class="built_in">object</span>)Convert.ToDecimal(<span class="keyword">value</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="literal">default</span>:</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">default</span>(T);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            catch (Exception ex)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">default</span>(T);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>擴充方法</strong>```csharp<br>/// <summary><br>        /// 符合數字區間,但允許空值.<br>        /// <para>EX : (1 &lt; x &lt; 3) </para><br>        /// </summary><br>        /// <typeparam name="T"></typeparam><br>        /// <typeparam name="TProperty">The type of the property.</typeparam><br>        /// <typeparam name="TNumeric">The type of the numeric.</typeparam><br>        /// <param name="ruleBuilder">The rule builder.</param><br>        /// <param name="upThreshold">Up threshold.</param><br>        /// <param name="downThreshold">Down threshold.</param><br>        /// <returns></returns><br>        public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericAllowEmptyOrBetweenOf&lt;T, TProperty, TNumeric&gt;(<br>            this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder,<br>            string upThreshold,<br>            string downThreshold)<br>            where TNumeric : IComparable<br>        {<br>            return ruleBuilder.SetValidator(<br>                new NumericBetweenInValidator<TNumeric>(<br>                    upThreshold,<br>                    downThreshold,<br>                    allowEquals: false,<br>                    allowEmpty: true));<br>        }</p>
<pre><code>        /// &lt;summary&gt;
    /// 符合數字區間且允許等於閥值,但允許空值.
    /// &lt;para&gt;EX : (1 &amp;lt;= x &amp;lt;= 3) &lt;/para&gt;
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the property.&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TNumeric&quot;&gt;The type of the numeric.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;param name=&quot;upThreshold&quot;&gt;Up threshold.&lt;/param&gt;
    /// &lt;param name=&quot;downThreshold&quot;&gt;Down threshold.&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericAllowEmptyOrBetweenOfAllowEquals&lt;T, TProperty, TNumeric&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder,
        string upThreshold,
        string downThreshold)
        where TNumeric : IComparable
    &#123;
        return ruleBuilder.SetValidator(
            new NumericBetweenInValidator&lt;TNumeric&gt;(
                upThreshold,
                downThreshold,
                allowEquals: true,
                allowEmpty: true));
    &#125;

        /// &lt;summary&gt;
    /// 符合數字區間.
    /// &lt;para&gt;EX : (1 &amp;lt; x &amp;lt; 3) &lt;/para&gt;
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the property.&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TNumeric&quot;&gt;The type of the numeric.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;param name=&quot;upThreshold&quot;&gt;Up threshold.&lt;/param&gt;
    /// &lt;param name=&quot;downThreshold&quot;&gt;Down threshold.&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericBetweenOf&lt;T, TProperty, TNumeric&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder,
        string upThreshold,
        string downThreshold)
        where TNumeric : IComparable
    &#123;
        return ruleBuilder.SetValidator(
            new NumericBetweenInValidator&lt;TNumeric&gt;(
                upThreshold,
                downThreshold,
                allowEquals: false,
                allowEmpty: false));
    &#125;

        /// &lt;summary&gt;
    /// 符合數字區間且允許等於閥值
    /// &lt;para&gt;EX : (1 &amp;lt;= x &amp;lt;= 3) &lt;/para&gt;
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the property.&lt;/typeparam&gt;
    /// &lt;typeparam name=&quot;TNumeric&quot;&gt;The type of the numeric.&lt;/typeparam&gt;
    /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
    /// &lt;param name=&quot;upThreshold&quot;&gt;Up threshold.&lt;/param&gt;
    /// &lt;param name=&quot;downThreshold&quot;&gt;Down threshold.&lt;/param&gt;
    /// &lt;returns&gt;&lt;/returns&gt;
    public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericBetweenOfAllowEquals&lt;T, TProperty, TNumeric&gt;(
        this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder,
        string upThreshold,
        string downThreshold)
        where TNumeric : IComparable
    &#123;
        return ruleBuilder.SetValidator(
            new NumericBetweenInValidator&lt;TNumeric&gt;(
                upThreshold,
                downThreshold,
                allowEquals: true,
                allowEmpty: false));
    &#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">使用方法 &#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;OrderBy - 允許空值或(0、1)</span><br><span class="line">this.RuleFor(x &#x3D;&gt; x.OrderBy)</span><br><span class="line">  .NotNumericAllowEmptyOrBetweenOfAllowEquals&lt;GetBuildingDealCaseParameter, string, int&gt;(</span><br><span class="line">  &quot;2&quot;,</span><br><span class="line">  &quot;1&quot;)</span><br><span class="line">  .WithErrorCode(&quot;X400&quot;)</span><br><span class="line">  .WithMessage(&quot;OrderBy應該在1~2之間&quot;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<ul>
<li><p><strong><span style="color: #073763;">驗證是否為數字Array </span></strong></p>
  <figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> 驗證是否為數字 Array</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;seealso cref=&quot;FluentValidation.Validators.PropertyValidator&quot; /&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">NumericArrayValidator</span>&lt;<span class="title">TNumeric</span>&gt; : <span class="title">PropertyValidator</span></span><br><span class="line">        <span class="keyword">where</span> <span class="title">TNumeric</span> : <span class="title">IComparable</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 是否允許Array為Null或空集合.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> if [allow empty]; otherwise, <span class="doctag">&lt;c&gt;</span>false<span class="doctag">&lt;/c&gt;</span>.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">private</span> <span class="built_in">bool</span> AllowEmpty &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Initializes a new instance of the <span class="doctag">&lt;see cref=&quot;NumericArrayValidator&#123;TNumeric&#125;&quot;/&gt;</span> class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;allowEmpty&quot;&gt;</span>if set to <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> [allow empty].<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">NumericArrayValidator</span>(<span class="params"><span class="built_in">bool</span> allowEmpty</span>) : <span class="title">base</span>(<span class="params"><span class="string">&quot;型別錯誤&quot;</span></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">this</span>.AllowEmpty = allowEmpty;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Returns true if ... is valid.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;context&quot;&gt;</span>The context.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span>   <span class="doctag">&lt;c&gt;</span>true<span class="doctag">&lt;/c&gt;</span> if the specified context is valid; otherwise, <span class="doctag">&lt;c&gt;</span>false<span class="doctag">&lt;/c&gt;</span>.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="built_in">bool</span> <span class="title">IsValid</span>(<span class="params">PropertyValidatorContext context</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> propertyValue = context.PropertyValue <span class="keyword">as</span> List&lt;<span class="built_in">string</span>&gt;;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.AllowEmpty &amp;&amp;</span><br><span class="line">                (propertyValue == <span class="literal">null</span> || propertyValue.Count == <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//不允許空集合或Null</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.AllowEmpty &amp;&amp;</span><br><span class="line">                (propertyValue == <span class="literal">null</span> || propertyValue.Count == <span class="number">0</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="built_in">bool</span> IsConvertable;</span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> x <span class="keyword">in</span> propertyValue)</span><br><span class="line">            &#123;</span><br><span class="line">                ConvertHelper.ToT&lt;TNumeric&gt;(x, <span class="keyword">out</span> IsConvertable);</span><br><span class="line">                <span class="keyword">if</span> (!IsConvertable)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p><em>擴充方法</em>*```csharp<br>/// <summary></p>
<pre><code>   /// 是數字 Array,但允許空陣列或Null.
   /// &lt;/summary&gt;
   /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
   /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the property.&lt;/typeparam&gt;
   /// &lt;typeparam name=&quot;TNumeric&quot;&gt;The type of the numeric.&lt;/typeparam&gt;
   /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
   /// &lt;returns&gt;&lt;/returns&gt;
   public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericArrayAllowEmpty&lt;T, TProperty, TNumeric&gt;(
       this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)
       where TNumeric : IComparable
   &#123;
       return ruleBuilder.SetValidator(
           new NumericArrayValidator&lt;TNumeric&gt;(allowEmpty: true));
   &#125;

   /// &lt;summary&gt;
   /// 是數字 Array.
   /// &lt;/summary&gt;
   /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
   /// &lt;typeparam name=&quot;TProperty&quot;&gt;The type of the property.&lt;/typeparam&gt;
   /// &lt;typeparam name=&quot;TNumeric&quot;&gt;The type of the numeric.&lt;/typeparam&gt;
   /// &lt;param name=&quot;ruleBuilder&quot;&gt;The rule builder.&lt;/param&gt;
   /// &lt;returns&gt;&lt;/returns&gt;
   public static IRuleBuilderOptions&lt;T, TProperty&gt; IsNumericArray&lt;T, TProperty, TNumeric&gt;(
       this IRuleBuilder&lt;T, TProperty&gt; ruleBuilder)
       where TNumeric : IComparable
   &#123;
       return ruleBuilder.SetValidator(
           new NumericArrayValidator&lt;TNumeric&gt;(allowEmpty: false));
   &#125;
</code></pre>
</li>
</ul>
<pre><code>
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/09/26/%E3%80%90%E5%9B%9B%E5%85%83%E6%A8%B9%E3%80%91%E9%80%8F%E9%81%8E%E5%9B%9B%E5%85%83%E6%A8%B9%E6%90%9C%E5%B0%8B%E7%AF%84%E5%9C%8D%E5%85%A7%E7%9A%84%E5%BA%A7%E6%A8%99/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/09/26/%E3%80%90%E5%9B%9B%E5%85%83%E6%A8%B9%E3%80%91%E9%80%8F%E9%81%8E%E5%9B%9B%E5%85%83%E6%A8%B9%E6%90%9C%E5%B0%8B%E7%AF%84%E5%9C%8D%E5%85%A7%E7%9A%84%E5%BA%A7%E6%A8%99/" class="post-title-link" itemprop="url">【四元樹】透過四元樹搜尋範圍內的座標</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-09-26 14:52:00" itemprop="dateCreated datePublished" datetime="2016-09-26T14:52:00+08:00">2016-09-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/09/26/%E3%80%90%E5%9B%9B%E5%85%83%E6%A8%B9%E3%80%91%E9%80%8F%E9%81%8E%E5%9B%9B%E5%85%83%E6%A8%B9%E6%90%9C%E5%B0%8B%E7%AF%84%E5%9C%8D%E5%85%A7%E7%9A%84%E5%BA%A7%E6%A8%99/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/09/26/【四元樹】透過四元樹搜尋範圍內的座標/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>將之前四元樹的程式改良後寫成筆記，之後用到才不會忘記 </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Class QuadTreeNode.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">QuadTreeNode</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">        <span class="keyword">where</span> <span class="title">T</span> : <span class="title">IQuadTreeNodeData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 西北象限.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The north west.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode&lt;T&gt; NorthWest &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 東北象限.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The north east.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode&lt;T&gt; NorthEast &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 西南象限.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The south west.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode&lt;T&gt; SouthWest &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 東南象限.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;value&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The south east.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/value&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> QuadTreeNode&lt;T&gt; SouthEast &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 邊界</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> BoundingBox BoundingBox &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 節點數量</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">int</span> BucketCapacity &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 節點</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> List&lt;T&gt; Points &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Initializes a new instance of the <span class="doctag">&lt;see cref=&quot;QuadTreeNode&#123;T&#125;&quot;/&gt;</span> class.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;boundingBox&quot;&gt;</span>The bounding box.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;capacity&quot;&gt;</span>The capacity.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">QuadTreeNode</span>(<span class="params">BoundingBox boundingBox, <span class="built_in">int</span> capacity</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            BoundingBox = boundingBox;</span><br><span class="line">            BucketCapacity = capacity;</span><br><span class="line">            Points = <span class="keyword">new</span> List&lt;T&gt;();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>要使用四元樹，就要將資料結點實作這個介面 </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> &amp;lt;summary&amp;gt;</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface IQuadTreeNodeData.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> &amp;lt;/summary&amp;gt;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IQuadTreeNodeData</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &amp;lt;summary&amp;gt;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Gets or sets the position.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &amp;lt;/summary&amp;gt;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &amp;lt;value&amp;gt;</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> The position.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> &amp;lt;/value&amp;gt;</span></span><br><span class="line">        Coordinate Position &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>要搜尋範圍的DTO </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Class BoundingBox.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">BoundingBox</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 左上角節點</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> Coordinate LeftTop &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 右下角節點</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> Coordinate RightBottom &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Class Coordinate.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Coordinate</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 緯度</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Latitude &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 經度</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">double</span> Longitude &#123; <span class="keyword">get</span>; <span class="keyword">set</span>; &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>四元樹搜尋邏輯 </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Class QuadTreeService.</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">QuadTreeService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> Inserts the specified node.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span>The node.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span>The data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">Insert</span>&lt;<span class="title">T</span>&gt;(<span class="params">QuadTreeNode&lt;T&gt; node, T data</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> T : IQuadTreeNodeData</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">// Bail if our coordinate is not in the boundingBox</span></span><br><span class="line">            <span class="keyword">if</span> (!CheckBoundingBoxContainData(node.BoundingBox, data))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Add the coordinate to the points array</span></span><br><span class="line">            <span class="keyword">if</span> ((node.Points.Count + <span class="number">1</span>) &lt;= node.BucketCapacity)</span><br><span class="line">            &#123;</span><br><span class="line">                node.Points.Add(data);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check to see if the current node is a leaf, if it is, split</span></span><br><span class="line">            <span class="keyword">if</span> (node.NorthWest == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Subdivide(node);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Traverse the tree</span></span><br><span class="line">            <span class="keyword">if</span> (Insert(node.NorthWest, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (Insert(node.NorthEast, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (Insert(node.SouthWest, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (Insert(node.SouthEast, data)) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 搜尋在範圍內的所有節點</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span>四元樹節點<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;range&quot;&gt;</span>範圍<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datas&quot;&gt;</span><span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SearchDataInRange</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">            QuadTreeNode&lt;T&gt; node, </span></span></span><br><span class="line"><span class="function"><span class="params">            BoundingBox range, </span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">ref</span> List&lt;T&gt; datas</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> T : IQuadTreeNodeData</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//如果QuadTree完全在要搜尋的Range之內，</span></span><br><span class="line">            <span class="comment">//那包含在它底下的分裂節點都不用判斷,一定全部都在範圍內</span></span><br><span class="line">            <span class="keyword">if</span> (CheckBoundingBoxIncludeInRange(node.BoundingBox, range))</span><br><span class="line">            &#123;</span><br><span class="line">                GetNodeAllPointData(node, <span class="keyword">ref</span> datas);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If range is not contained in the node&#x27;s boundingBox then bail</span></span><br><span class="line">            <span class="keyword">if</span> (!CheckIntersectionBoundingBox(node.BoundingBox, range))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> item <span class="keyword">in</span> node.Points)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// Gather points contained in range</span></span><br><span class="line">                <span class="keyword">if</span> (CheckBoundingBoxContainData(range, item))</span><br><span class="line">                &#123;</span><br><span class="line">                    datas.Add(item);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Bail if node is leaf</span></span><br><span class="line">            <span class="keyword">if</span> (node.NorthWest == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Otherwise traverse down the tree</span></span><br><span class="line">            SearchDataInRange(node.NorthWest, range, <span class="keyword">ref</span> datas);</span><br><span class="line">            SearchDataInRange(node.NorthEast, range, <span class="keyword">ref</span> datas);</span><br><span class="line">            SearchDataInRange(node.SouthWest, range, <span class="keyword">ref</span> datas);</span><br><span class="line">            SearchDataInRange(node.SouthEast, range, <span class="keyword">ref</span> datas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 建立四元樹.</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;data&quot;&gt;</span>The data.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;boundingBox&quot;&gt;</span>QuadTree Bounding<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">QuadTreeNode</span>&lt;<span class="title">T</span>&gt; <span class="title">CreateQuadTree</span>&lt;<span class="title">T</span>&gt;(<span class="params">List&lt;T&gt; data, BoundingBox boundingBox</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> T : IQuadTreeNodeData</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> TreeNode = <span class="keyword">new</span> QuadTreeNode&lt;T&gt;(</span><br><span class="line">                boundingBox: boundingBox,</span><br><span class="line">                capacity: <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> d <span class="keyword">in</span> data)</span><br><span class="line">            &#123;</span><br><span class="line">                Insert(TreeNode, d);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> TreeNode;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 取得節點以及所有子節點的Point Data</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span>The node.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;datas&quot;&gt;</span>The datas.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">GetNodeAllPointData</span>&lt;<span class="title">T</span>&gt;(<span class="params">QuadTreeNode&lt;T&gt; node, <span class="keyword">ref</span> List&lt;T&gt; datas</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> T : IQuadTreeNodeData</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            datas.AddRange(node.Points);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (node.NorthWest == <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            GetNodeAllPointData(node.NorthWest, <span class="keyword">ref</span> datas);</span><br><span class="line">            GetNodeAllPointData(node.NorthEast, <span class="keyword">ref</span> datas);</span><br><span class="line">            GetNodeAllPointData(node.SouthWest, <span class="keyword">ref</span> datas);</span><br><span class="line">            GetNodeAllPointData(node.SouthEast, <span class="keyword">ref</span> datas);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 確認兩個區域是否有交集</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;BoundingBox&quot;&gt;</span>The bounding box.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;range&quot;&gt;</span>The range.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CheckIntersectionBoundingBox</span>(<span class="params">BoundingBox BoundingBox, BoundingBox range</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (BoundingBox.LeftTop.Latitude.ToString() == BoundingBox.RightBottom.Latitude.ToString() &amp;&amp;</span><br><span class="line">                BoundingBox.LeftTop.Longitude.ToString() == BoundingBox.RightBottom.Longitude.ToString())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//Point</span></span><br><span class="line">                <span class="keyword">var</span> Lng =  range.LeftTop.Longitude &lt;= BoundingBox.LeftTop.Longitude &amp;&amp;</span><br><span class="line">                           BoundingBox.LeftTop.Longitude &lt;= range.RightBottom.Longitude;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> Lat =  range.RightBottom.Latitude &lt;= BoundingBox.LeftTop.Latitude &amp;&amp;</span><br><span class="line">                           BoundingBox.LeftTop.Latitude &lt;= range.LeftTop.Latitude;</span><br><span class="line">                <span class="keyword">return</span> Lng &amp;&amp; Lat;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> MinCx = Math.Max(range.LeftTop.Longitude, BoundingBox.LeftTop.Longitude);</span><br><span class="line">                <span class="keyword">var</span> MaxCy = Math.Min(range.LeftTop.Latitude, BoundingBox.LeftTop.Latitude);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">var</span> MaxCx = Math.Min(range.RightBottom.Longitude, BoundingBox.RightBottom.Longitude);</span><br><span class="line">                <span class="keyword">var</span> MinCy = Math.Max(range.RightBottom.Latitude, BoundingBox.RightBottom.Latitude);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> (MinCx &lt; MaxCx) &amp;&amp; (MinCy &lt; MaxCy);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 確認BoundingBox是否完全包含在要搜尋的區域範圍內(小於等於).</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;BoundingBox&quot;&gt;</span>The bounding box.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;range&quot;&gt;</span>The range.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span><span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CheckBoundingBoxIncludeInRange</span>(<span class="params">BoundingBox BoundingBox, BoundingBox range</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> LTLng = (range.LeftTop.Longitude &lt;= BoundingBox.LeftTop.Longitude &amp;&amp;</span><br><span class="line">                        BoundingBox.LeftTop.Longitude &lt;= range.RightBottom.Longitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> LTLat = (range.RightBottom.Latitude &lt;= BoundingBox.LeftTop.Latitude &amp;&amp;</span><br><span class="line">                        BoundingBox.LeftTop.Latitude &lt;= range.LeftTop.Latitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> RBLng = (range.LeftTop.Longitude &lt;= BoundingBox.RightBottom.Longitude &amp;&amp;</span><br><span class="line">                        BoundingBox.RightBottom.Longitude &lt;= range.RightBottom.Longitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> RBLat = (range.RightBottom.Latitude &lt;= BoundingBox.RightBottom.Latitude &amp;&amp;</span><br><span class="line">                        BoundingBox.RightBottom.Latitude &lt;= range.LeftTop.Latitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> LTLng &amp;&amp; LTLat &amp;&amp; RBLng &amp;&amp; RBLat;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="built_in">bool</span> <span class="title">CheckBoundingBoxContainData</span>(<span class="params">BoundingBox boundingBox, IQuadTreeNodeData data</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> CheckLng = (boundingBox.LeftTop.Longitude &lt;= data.Position.Longitude &amp;&amp;</span><br><span class="line">                            data.Position.Longitude &lt;= boundingBox.RightBottom.Longitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> CheckLat = (boundingBox.RightBottom.Latitude &lt;= data.Position.Latitude &amp;&amp;</span><br><span class="line">                            data.Position.Latitude &lt;= boundingBox.LeftTop.Latitude);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> CheckLng &amp;&amp; CheckLat;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 四元樹分裂</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;node&quot;&gt;</span>四元樹節點<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Subdivide</span>&lt;<span class="title">T</span>&gt;(<span class="params">QuadTreeNode&lt;T&gt; node</span>)</span></span><br><span class="line"><span class="function">            <span class="keyword">where</span> T:IQuadTreeNodeData</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> box = node.BoundingBox;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//中心點</span></span><br><span class="line">            <span class="built_in">double</span> LatMid = (box.LeftTop.Latitude + box.RightBottom.Latitude) / <span class="number">2.0</span>;</span><br><span class="line">            <span class="built_in">double</span> LngMid = (box.LeftTop.Longitude + box.RightBottom.Longitude) / <span class="number">2.0</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//左上</span></span><br><span class="line">            <span class="keyword">var</span> NorthWest = <span class="keyword">new</span> BoundingBox</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.LeftTop.Latitude,</span><br><span class="line">                    Longitude = box.LeftTop.Longitude</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.NorthWest = <span class="keyword">new</span> QuadTreeNode&lt;T&gt;(NorthWest, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//右上</span></span><br><span class="line">            <span class="keyword">var</span> NorthEast = <span class="keyword">new</span> BoundingBox</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.LeftTop.Latitude,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = box.RightBottom.Longitude</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.NorthEast = <span class="keyword">new</span> QuadTreeNode&lt;T&gt;(NorthEast, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//左下</span></span><br><span class="line">            <span class="keyword">var</span> SouthWest = <span class="keyword">new</span> BoundingBox</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = box.LeftTop.Longitude</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.RightBottom.Latitude,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.SouthWest = <span class="keyword">new</span> QuadTreeNode&lt;T&gt;(SouthWest, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//右下</span></span><br><span class="line">            <span class="keyword">var</span> SouthEast = <span class="keyword">new</span> BoundingBox</span><br><span class="line">            &#123;</span><br><span class="line">                LeftTop = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = LatMid,</span><br><span class="line">                    Longitude = LngMid</span><br><span class="line">                &#125;,</span><br><span class="line">                RightBottom = <span class="keyword">new</span> Coordinate</span><br><span class="line">                &#123;</span><br><span class="line">                    Latitude = box.RightBottom.Latitude,</span><br><span class="line">                    Longitude = box.RightBottom.Longitude</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            node.SouthEast = <span class="keyword">new</span> QuadTreeNode&lt;T&gt;(SouthEast, node.BucketCapacity);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>————使用方法—————–</strong><br>**<br>**</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Main</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> Stopwatch timer = <span class="keyword">new</span> Stopwatch();</span><br><span class="line"> timer.Reset();</span><br><span class="line"> timer.Start();</span><br><span class="line"> <span class="keyword">var</span> YouWantToSearchData = <span class="keyword">new</span> List&lt;UserQuery.YourCoordinateData&gt;();</span><br><span class="line"> <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5000000</span>; i++)</span><br><span class="line"> &#123;</span><br><span class="line">  YouWantToSearchData.Add(</span><br><span class="line">   <span class="keyword">new</span> YourCoordinateData</span><br><span class="line">   &#123;</span><br><span class="line">    Position = <span class="keyword">new</span> Coordinate </span><br><span class="line">    &#123;</span><br><span class="line">      Latitude = GetRandomNumber(<span class="number">22</span>,<span class="number">26</span>),</span><br><span class="line">      Longitude = GetRandomNumber(<span class="number">120</span>,<span class="number">122</span>)</span><br><span class="line">    &#125; </span><br><span class="line">   &#125;);</span><br><span class="line"> &#125; </span><br><span class="line"> <span class="keyword">var</span> QuadTree = QuadTreeService.CreateQuadTree(YouWantToSearchData,GetBoundingBox()); <span class="comment">//建立四元樹</span></span><br><span class="line"> <span class="built_in">string</span>.Format(<span class="string">&quot;建資料花了: &#123;0&#125; ticks (&#123;1&#125; msec)&quot;</span>, timer.ElapsedTicks, timer.ElapsedMilliseconds).Dump();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//要搜尋的範圍</span></span><br><span class="line"> BoundingBox range = <span class="keyword">new</span> BoundingBox</span><br><span class="line"> &#123;</span><br><span class="line">  LeftTop = <span class="keyword">new</span> Coordinate &#123; Latitude = <span class="number">24.997123</span>, Longitude = <span class="number">121.21940612793</span> &#125;,</span><br><span class="line">  RightBottom = <span class="keyword">new</span> Coordinate &#123;Latitude =<span class="number">24.958553314209</span>,Longitude = <span class="number">121.485925</span>&#125;</span><br><span class="line"> &#125;;</span><br><span class="line"></span><br><span class="line"> <span class="comment">//一般搜尋</span></span><br><span class="line"> timer.Reset();</span><br><span class="line"> timer.Start();</span><br><span class="line"> <span class="keyword">var</span> Result1 = Search(range,YouWantToSearchData);</span><br><span class="line"> <span class="built_in">string</span>.Format(<span class="string">&quot;搜尋資料花了: &#123;0&#125; ticks (&#123;1&#125; msec)&quot;</span>, timer.ElapsedTicks, timer.ElapsedMilliseconds).Dump();</span><br><span class="line"></span><br><span class="line"> <span class="comment">//四元樹搜尋</span></span><br><span class="line"> timer.Reset();</span><br><span class="line"> timer.Start();</span><br><span class="line"> <span class="keyword">var</span> Result2 = <span class="keyword">new</span> List&lt;YourCoordinateData&gt;();</span><br><span class="line"> QuadTreeService.SearchDataInRange(QuadTree,range,<span class="keyword">ref</span> Result2);</span><br><span class="line"> <span class="built_in">string</span>.Format(<span class="string">&quot;四元樹搜尋資料花了: &#123;0&#125; ticks (&#123;1&#125; msec)&quot;</span>, timer.ElapsedTicks, timer.ElapsedMilliseconds).Dump();</span><br><span class="line"></span><br><span class="line"> <span class="built_in">string</span>.Format(<span class="string">&quot;一般搜尋資料筆數: &#123;0&#125;&quot;</span>,Result1.Count()).Dump();</span><br><span class="line"> <span class="built_in">string</span>.Format(<span class="string">&quot;四元樹搜尋資料筆數: &#123;0&#125;&quot;</span>,Result2.Count()).Dump();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;YourCoordinateData&gt; <span class="title">Search</span>(<span class="params">BoundingBox range,  List&lt;YourCoordinateData&gt; Datas</span>) </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">return</span> Datas.Where(x =&gt; range.RightBottom.Latitude  &lt;= x.Position.Latitude  &amp;&amp; x.Position.Latitude &lt;= range.LeftTop.Latitude &amp;&amp;</span><br><span class="line">                            range.LeftTop.Longitude  &lt;= x.Position.Longitude  &amp;&amp; x.Position.Longitude &lt;= range.RightBottom.Longitude).ToList();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">YourCoordinateData</span> : <span class="title">IQuadTreeNodeData</span> </span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">public</span> Coordinate Position&#123;<span class="keyword">get</span>;<span class="keyword">set</span>;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//台灣的範圍</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BoundingBox <span class="title">GetBoundingBox</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">return</span> <span class="keyword">new</span> BoundingBox</span><br><span class="line"> &#123;</span><br><span class="line">  <span class="comment">//台灣範圍</span></span><br><span class="line">  LeftTop = <span class="keyword">new</span> Coordinate</span><br><span class="line">  &#123;</span><br><span class="line">   Latitude = <span class="number">26</span>,</span><br><span class="line">   Longitude = <span class="number">120</span></span><br><span class="line">  &#125;,</span><br><span class="line">  RightBottom = <span class="keyword">new</span> Coordinate</span><br><span class="line">  &#123;</span><br><span class="line">   Latitude = <span class="number">22</span>,</span><br><span class="line">   Longitude = <span class="number">122</span></span><br><span class="line">  &#125;</span><br><span class="line"> &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//隨機取得經緯度亂數</span></span><br><span class="line"><span class="keyword">static</span> Random random = <span class="keyword">new</span> Random();</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">double</span> <span class="title">GetRandomNumber</span>(<span class="params"><span class="built_in">double</span> minimum, <span class="built_in">double</span> maximum</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"> <span class="keyword">return</span> random.NextDouble() * (maximum - minimum) + minimum;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>分別實驗了10萬筆與500萬筆的搜尋數據，當然筆數擴張的越大，這個數據差距會越大</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-ZxXLvUMEaU8/V-jEmww86II/AAAAAAAAH98/12-o58aYKrcsVPIi6iPjGxEbt8ngHFFvwCLcB/s1600/1.png)](https://3.bp.blogspot.com/-ZxXLvUMEaU8/V-jEmww86II/AAAAAAAAH98/12-o58aYKrcsVPIi6iPjGxEbt8ngHFFvwCLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">10萬筆</td></tr></tbody></table>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-Kba3y7eAdFo/V-jFYZ5hXoI/AAAAAAAAH-I/_Mk3UU4NCII26OC6RqXubc5SdEkAMawogCLcB/s1600/2.png)](https://2.bp.blogspot.com/-Kba3y7eAdFo/V-jFYZ5hXoI/AAAAAAAAH-I/_Mk3UU4NCII26OC6RqXubc5SdEkAMawogCLcB/s1600/2.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">500萬筆</td></tr></tbody></table>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/08/18/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%B8%89-%E5%96%AE%E4%B8%80%E8%81%B7%E8%B2%AC%E5%8E%9F%E5%89%87-Single-Responsibility-Principle-SRP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/18/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%B8%89-%E5%96%AE%E4%B8%80%E8%81%B7%E8%B2%AC%E5%8E%9F%E5%89%87-Single-Responsibility-Principle-SRP/" class="post-title-link" itemprop="url">【重構系列】(三) 單一職責原則(Single Responsibility Principle , SRP)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-18 11:16:00" itemprop="dateCreated datePublished" datetime="2016-08-18T11:16:00+08:00">2016-08-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/08/18/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%B8%89-%E5%96%AE%E4%B8%80%E8%81%B7%E8%B2%AC%E5%8E%9F%E5%89%87-Single-Responsibility-Principle-SRP/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/18/【重構系列】-三-單一職責原則-Single-Responsibility-Principle-SRP/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>SourceCode :&nbsp;<a target="_blank" rel="noopener" href="https://github.com/toyo0103/Demo_EditTemplate_1">https://github.com/toyo0103/Demo_EditTemplate_1</a></p>
<p>這邊提供幾篇覺得很棒的文章，看完其實也可以略過這篇了XD</p>
<p>&nbsp;1.&nbsp;<a target="_blank" rel="noopener" href="https://msdn.microsoft.com/zh-tw/library/dn155886.aspx">30天快速上手 TDD Day 12 - Refactoring - 職責分離 &nbsp;By 91</a></p>
<p>&nbsp;2. <a target="_blank" rel="noopener" href="https://dotblogs.com.tw/hatelove/archive/2010/10/16/single-responsibility-principle.aspx">[ASP.NET]91之ASP.NET由淺入深 不負責講座 Day17 – 單一職責原則</a></p>
<p>&nbsp;3.&nbsp;<a target="_blank" rel="noopener" href="https://vinta.ws/booch/?p=101">Clean code: 無瑕的程式碼 – 書摘心得（二）</a></p>
<p>好的!!誠如上面幾篇文章提到的，我對於SRP的理解是「<strong>每個類別應該都只有一個理由被修改</strong>」。 其實看起來很簡單但卻又抽象到頭痛，之前寫程式時常常為了分離程式碼而頭痛不已，不可否認的是，全部寫成一起在開發上又快又方便，但這其實無形中堆高了技術債，為了在改動需求或修改程式時，要嘛就從頭看到尾找出其中的一兩行改，要嘛就是乾脆重寫，因為互相綁得太死了，牽一髮動全身阿(遠目)</p>
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://2.bp.blogspot.com/-cYpekfGnPkg/V7UdvdmnldI/AAAAAAAAH84/MR0-YMqszPUeIoiFGPID_Tmx_ERoWnO0wCLcB/s320/srp.jpg)](https://2.bp.blogspot.com/-cYpekfGnPkg/V7UdvdmnldI/AAAAAAAAH84/MR0-YMqszPUeIoiFGPID_Tmx_ERoWnO0wCLcB/s1600/srp.jpg)</td></tr><tr><td class="tr-caption" style="text-align: center;">如果想在這萬能的瑞士刀加上一個新型刀片，除了重做一個更長的基座，似乎無解阿....</td></tr></tbody></table>

<p><span style="font-size: large;">一、分析</span></p>
<p>讓我們來看看原本的程式中哪邊明顯的沒有單一職責?</p>
<p>**<br>**<strong>Application層</strong><br>**<br>**傳入Channel ID,透過IPOISerice取得對應的POI資料並且回傳資料，看起來職責非常明確</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        IPOIService _POIService;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HomeController</span>(<span class="params">IPOIService poiService</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//POIService改成依賴介面IPOIService</span></span><br><span class="line">            <span class="comment">//並且實體是由外部來決定，也就是所謂的依賴注入DI</span></span><br><span class="line">            _POIService = poiService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>(<span class="params"><span class="built_in">string</span> id</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//依賴外部注入的IPOIService介面</span></span><br><span class="line">            <span class="keyword">var</span> POIs = _POIService.Get(id);</span><br><span class="line">            <span class="keyword">return</span> Json(POIs,JsonRequestBehavior.AllowGet);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p><strong>Repository層</strong></p>
<p>看起來兩個供應商的Repository也都恰如其分的只撈自己所屬的資料，職責明確，要改哪個供應商撈資料的方式，打開對應的Repository檔案即可，腎好腎好 (難道肝不好嗎?)<br>**<br>**</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> POI A供應商</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">ASupplierRepository</span> : <span class="title">ISupplierRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//隨機建立十筆Supplier為A的資料回傳</span></span><br><span class="line">            <span class="keyword">var</span> fixture = <span class="keyword">new</span> Fixture();</span><br><span class="line">            <span class="keyword">var</span> Result = fixture.Build&lt;POI&gt;()</span><br><span class="line">                            .With(x =&gt; x.Name, <span class="built_in">string</span>.Concat(<span class="string">&quot;捷運&quot;</span>, rnd.Next(<span class="number">1</span>, <span class="number">100</span>)))</span><br><span class="line">                            .With(x =&gt; x.Supplier, SupplierEnum.A)</span><br><span class="line">                            .CreateMany().ToList();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> POI B供應商</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">internal</span> <span class="keyword">class</span> <span class="title">BSupplierRepository</span> : <span class="title">ISupplierRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//隨機建立十筆Supplier為B的資料回傳</span></span><br><span class="line">            <span class="keyword">var</span> fixture = <span class="keyword">new</span> Fixture();</span><br><span class="line">            <span class="keyword">var</span> Result = fixture.Build&lt;POI&gt;()</span><br><span class="line">                            .With(x =&gt; x.Name, <span class="built_in">string</span>.Concat(<span class="string">&quot;捷運&quot;</span>, rnd.Next(<span class="number">1</span>, <span class="number">100</span>)))</span><br><span class="line">                            .With(x =&gt; x.Supplier, SupplierEnum.B)</span><br><span class="line">                            .CreateMany().ToList();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>**</p>
<hr>
<p>**<strong>Service層</strong><br>**</p>
<hr>
<p>**</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">POIService</span> :<span class="title">IPOIService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;POI&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> channel = GetChannel(channelID);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//逐一搜尋頻道底下的各類別</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> category <span class="keyword">in</span> channel.Categorys)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//依據該類別所指定的供應商向Repository要資料</span></span><br><span class="line">                category.Supplier.ForEach(x =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> Repository = SupplierFactory.Generate(x);</span><br><span class="line">                    <span class="keyword">var</span> POIs = Repository.Get();</span><br><span class="line">                    Result.AddRange(POIs);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//並接總合的結果回傳</span></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 模擬頻道類別對應表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;channelID&quot;&gt;</span>The channel identifier.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Channel.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">Channel <span class="title">GetChannel</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (channelID == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">                &#123;</span><br><span class="line">                    ID = <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                    Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">new</span> Channel.Category</span><br><span class="line">                        &#123;</span><br><span class="line">                            Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                            Supplier =<span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">            &#123;</span><br><span class="line">                ID = channelID,</span><br><span class="line">                Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">new</span> Channel.Category</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                        Supplier = <span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A , SupplierEnum.B &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>讓我們用人話的方式說說它目前都做了啥(驚世劇場口氣)!!</p>
<ul>
<li>  Get() : 傳入Channel ID,先呼叫私有方法GetChannel，取得該頻道該有的類別跟對應POI廠商表，然後依據POI廠商去跟源頭Repository要資料</li>
<li>  GetChannel() : 傳入Channel ID，取回該頻道該有的類別與對應的POI廠商表</li>
</ul>
<p>如果今天我要修改<strong>取POI源頭資料的邏輯</strong>，我要打開POIService修改。</p>
<p>如果今天我要修改<strong>取頻道與廠商的對應表邏輯，或是接上真實的DB資料</strong>，我也要打開POIService修改</p>
<p>對於POIService來說，它的職責已經包含兩個不同面向的事情了，所以在這邊我們要抽離<strong>取頻道與廠商的對應表邏輯</strong>到專屬負責的類別去，來符合SRP</p>
<span style="font-size: large;">
</span><span style="font-size: large;">二、重構開始</span>
<span style="font-size: large;">
</span>首先在**Service層**建立專屬的類別來取頻道與廠商的對應表，所以這邊建立一個**ChannelService**，然後將原本屬於POIService的邏輯搬到這邊來

<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ChannelService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 模擬頻道類別對應表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;channelID&quot;&gt;</span>The channel identifier.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Channel.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Channel <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (channelID == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">                &#123;</span><br><span class="line">                    ID = <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                    Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">new</span> Channel.Category</span><br><span class="line">                        &#123;</span><br><span class="line">                            Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                            Supplier =<span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">            &#123;</span><br><span class="line">                ID = channelID,</span><br><span class="line">                Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">new</span> Channel.Category</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                        Supplier = <span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A , SupplierEnum.B &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>把原本不該屬於POIService的程式碼刪除，改成如下 </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">POIService</span> :<span class="title">IPOIService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;POI&gt;();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//取得ChannelService實體，取得Channel對應供應商資料</span></span><br><span class="line">            <span class="keyword">var</span> channelService = <span class="keyword">new</span> ChannelService();</span><br><span class="line">            <span class="keyword">var</span> channel = channelService.Get(channelID);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//逐一搜尋頻道底下的各類別</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> category <span class="keyword">in</span> channel.Categorys)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//依據該類別所指定的供應商向Repository要資料</span></span><br><span class="line">                category.Supplier.ForEach(x =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">var</span> Repository = SupplierFactory.Generate(x);</span><br><span class="line">                    <span class="keyword">var</span> POIs = Repository.Get();</span><br><span class="line">                    Result.AddRange(POIs);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//並接總合的結果回傳</span></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下來是不是因為達成職責分離了，所以大家可以手拉手一起去吃冰快樂的下午茶了阿。<br>如果是的話請到旁邊面壁思過(拍掉已經牽起來的手)，**說好的高內聚低耦合呢? 說好的IOC與DI呢 ? 說好的面對抽象呢? **(左手心拍右手背)</p>
<ul>
<li><p>隔離ChannelService，建立Interface</p>
  <div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-CbLQzZGAVWA/V7Uk_BjnrQI/AAAAAAAAH9I/2X3Wh9Igf34lYISJFe19Tu2pANOaX6tUgCLcB/s1600/1.png)](https://2.bp.blogspot.com/-CbLQzZGAVWA/V7Uk_BjnrQI/AAAAAAAAH9I/2X3Wh9Igf34lYISJFe19Tu2pANOaX6tUgCLcB/s1600/1.png)</div>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IChannelService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function">Channel <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ul>
<ul>
<li><p>POIService透過DI與IOC的概念，面對IChannelService而非實體 ```csharp<br>public class POIService :IPOIService<br>  {</p>
<pre><code>  IChannelService _ChannelService;
  public POIService(IChannelService channelService)
  &#123;
      //DI
      _ChannelService = channelService;
  &#125;

      public List&lt;POI&gt; Get(string channelID)
  &#123;
      var Result = new List&lt;POI&gt;();

          //面對抽象
      var channel = _ChannelService.Get(channelID);

          //逐一搜尋頻道底下的各類別
      foreach (var category in channel.Categorys)
      &#123;
          //依據該類別所指定的供應商向Repository要資料
          category.Supplier.ForEach(x =&gt;
          &#123;
              var Repository = SupplierFactory.Generate(x);
              var POIs = Repository.Get();
              Result.AddRange(POIs);
          &#125;);
      &#125;

          //並接總合的結果回傳
      return Result;
  &#125;
</code></pre>
<p>  }</p>
</li>
</ul>
<p>```</p>
<ul>
<li>  別忘記到Unity把Interface與實體的關係註冊起來<div class="separator" style="clear: both; text-align: center;"><a target="_blank" rel="noopener" href="https://3.bp.blogspot.com/-vp--aOOPX5s/V7UmVz9p1sI/AAAAAAAAH9M/bZNYIW4-xJ4ckr5k11B_jWgSrr55nn5oQCLcB/s1600/1.png"><img src="https://3.bp.blogspot.com/-vp--aOOPX5s/V7UmVz9p1sI/AAAAAAAAH9M/bZNYIW4-xJ4ckr5k11B_jWgSrr55nn5oQCLcB/s640/1.png"></a></div><span style="font-size: large;"><br></span><span style="font-size: large;"><br></span><span style="font-size: large;"><br></span><span style="font-size: large;"><br></span><span style="font-size: large;">三、小結</span><span style="font-size: large;">
</span>看看執行的結果是否正常
<table align="center" cellpadding="0" cellspacing="0" class="tr-caption-container" style="margin-left: auto; margin-right: auto; text-align: center;"><tbody><tr><td style="text-align: center;">[![](https://3.bp.blogspot.com/-rn9m0xATZ2A/V7Umyyoz9_I/AAAAAAAAH9U/rAETSPwprloEh1HSjPDpP3v0Cq0iAp_gACLcB/s640/1.png)](https://3.bp.blogspot.com/-rn9m0xATZ2A/V7Umyyoz9_I/AAAAAAAAH9U/rAETSPwprloEh1HSjPDpP3v0Cq0iAp_gACLcB/s1600/1.png)</td></tr><tr><td class="tr-caption" style="text-align: center;">妥妥的阿!!!</td></tr></tbody></table>
所以這邊我們重構了Service的部分，讓它職責更為明確，而且也用了前幾篇提到的物件導向觀念，讓彼此是互相合作但是又具有高獨立性的。</li>
</ul>
<p>如果現在真的想把取Channel的對應資料改去接DB，我們只要打開<strong>ChannelService</strong>去接對應的Repository即可，其他地方都不會動到。</p>
<p>如果現在是主管說Demo的時候要用假資料，正式機要接DB取真實的Channel資料，那我們只要保留原本<strong>ChannelService，</strong>另外寫一個<strong>ChannelFromDBService</strong>，然後都實做<span style="color: #bf9000;">IChannelService</span>，並且在Unity那邊做個開關動態改變註冊的實體即可</p>
<p>應該有漸漸感受到，物件導向對於變動這件事情的高擴展性與可維護性了，相信天下沒有不改需求的PM，所以也就不可能有不改版的軟體了阿(再次遠目)</p>
<p>最後記住一件事情，<strong>「別讓你的Code又臭又長」</strong>，那麼下回見啦~</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-NHl1LCbQLR0/V7UoU2H1ijI/AAAAAAAAH9g/1CJwhDpona4tNKcNlesR5HCDoruhHCvVgCLcB/s320/687474703a2f2f692e696d6775722e636f6d2f63464a6b6638692e6a7067.jpg)](https://2.bp.blogspot.com/-NHl1LCbQLR0/V7UoU2H1ijI/AAAAAAAAH9g/1CJwhDpona4tNKcNlesR5HCDoruhHCvVgCLcB/s1600/687474703a2f2f692e696d6775722e636f6d2f63464a6b6638692e6a7067.jpg)</div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/08/17/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%BA%8C-DI%E8%88%87IOC/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/17/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%BA%8C-DI%E8%88%87IOC/" class="post-title-link" itemprop="url">【重構系列】(二) DI與IOC</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-17 16:36:00" itemprop="dateCreated datePublished" datetime="2016-08-17T16:36:00+08:00">2016-08-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/08/17/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%BA%8C-DI%E8%88%87IOC/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/17/【重構系列】-二-DI與IOC/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>SourceCode :&nbsp;<a target="_blank" rel="noopener" href="https://github.com/toyo0103/Demo_EditTemplate_1">https://github.com/toyo0103/Demo_EditTemplate_1</a></p>
<p>依據前一篇延續，接著我們把焦點放在Application與Service之間的狀況</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-urWNSzGdlp8/V7O6-tD1woI/AAAAAAAAH6w/z2GwsqBn9hANkslSqNpALNAuRiBIuuI4ACLcB/s400/1.png)](https://3.bp.blogspot.com/-urWNSzGdlp8/V7O6-tD1woI/AAAAAAAAH6w/z2GwsqBn9hANkslSqNpALNAuRiBIuuI4ACLcB/s1600/1.png)</div>
前一篇有提到程式應該要面對**抽象**避免高耦合的情況發生，改一髮進而動全身，所以有用**介面**的方式去處理

<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-O7kXIwvgtDk/V7O7kOH1D0I/AAAAAAAAH60/M49OysRZ7R4LxOLv4UNE9WJVLBBpsICJwCLcB/s400/1.png)](https://3.bp.blogspot.com/-O7kXIwvgtDk/V7O7kOH1D0I/AAAAAAAAH60/M49OysRZ7R4LxOLv4UNE9WJVLBBpsICJwCLcB/s1600/1.png)</div>

<p>然而來看看目前實際的程式狀況 : <strong>直接耦合</strong></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-csgLbuLY5Dw/V7O9BEEADYI/AAAAAAAAH7A/n6mzb9hYUiksdAHYuQmBXuH6aPO0Sk8-wCLcB/s400/1.png)](https://4.bp.blogspot.com/-csgLbuLY5Dw/V7O9BEEADYI/AAAAAAAAH7A/n6mzb9hYUiksdAHYuQmBXuH6aPO0Sk8-wCLcB/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-LkVwTAXMQHc/V7O9TcpERgI/AAAAAAAAH7I/18cwMlw6YtQxVKhppexI25lzS--gxIIagCLcB/s400/1.png)](https://2.bp.blogspot.com/-LkVwTAXMQHc/V7O9TcpERgI/AAAAAAAAH7I/18cwMlw6YtQxVKhppexI25lzS--gxIIagCLcB/s1600/1.png)</div>

<p>這邊會談到兩個用來解開這種狀況的觀念</p>
<ul>
<li>  <strong><span style="color: red;">依賴注入</span></strong>(Dependency Injection)簡稱DI</li>
<li>  **<span style="color: red;">控制反轉(</span>**Inversion Of Control)簡稱IOC</li>
</ul>
<p>先看看Google怎麼解釋<br><span style="color: #222222; font-family: &quot;arial&quot; , sans-serif;"><span style="background-color: #cccccc; line-height: 19.2px;"><strong>控制反轉（Inversion of Control，縮寫為IoC），是面向對象編程中的一種設計原則，可以用來減低計算機代碼之間的耦合度。其中最常見的方式叫做依賴注入（Dependency Injection，簡稱DI）</strong></span></span></p>
<p>不知道看完有沒有懂的感覺XD，明明都是中文看完卻很想說「先生(小姐)可以講中文嗎?」。<br>撇開這些專業的術語不看，我們直接開始重構來體會這兩個概念</p>
<span style="color: #444444;">
</span><span style="color: #444444; font-size: x-large;">一、重構開始</span>

<p><span style="font-size: large;"><strong>抽取介面</strong></span><br>避免直接耦合的第一步，抽取介面來隔離實體，既然這邊實際耦合了<strong>POIService</strong>，那我們就為它抽取出Interface <span style="color: #bf9000;">IPOIService</span></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-LrWsJfLH2vU/V7PAEPoqZKI/AAAAAAAAH7Y/VCUD_9YVxnEPfAzFCKpQvHY3jQRkMBD9ACLcB/s1600/1.png)](https://3.bp.blogspot.com/-LrWsJfLH2vU/V7PAEPoqZKI/AAAAAAAAH7Y/VCUD_9YVxnEPfAzFCKpQvHY3jQRkMBD9ACLcB/s1600/1.png)</div>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">IPOIService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 取得屬於頻道的POI資料</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;channelID&quot;&gt;</span>The channel identifier.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>List&amp;lt;POI&amp;gt;.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">List&lt;POI&gt; <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>將<strong>POIService</strong>掛上<span style="color: #bf9000;">IPOIService</span><br><span style="color: #bf9000;"><br></span></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-YS5Dd3-SnX4/V7PA1QAh0ZI/AAAAAAAAH7g/Av6PbiG5yYgct0SYM1kP_n8mTQTLy0N2ACLcB/s400/1.png)](https://2.bp.blogspot.com/-YS5Dd3-SnX4/V7PA1QAh0ZI/AAAAAAAAH7g/Av6PbiG5yYgct0SYM1kP_n8mTQTLy0N2ACLcB/s1600/1.png)</div><span style="color: #bf9000;">
</span><span style="color: #bf9000;">
</span>**讓Application依賴介面**

<p>上一篇遇到這種狀況時，我們會做一個Factory來產生實體，並且封裝在Service層。這次我們不這麼做，改成用依賴注入(DI)的方式來實作，將<span style="color: #bf9000;">IPOIService</span>改成用建構子帶入</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">HomeController</span> : <span class="title">Controller</span></span><br><span class="line">    &#123;</span><br><span class="line">        IPOIService _POIService;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">HomeController</span>(<span class="params">IPOIService poiService</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//POIService改成依賴介面IPOIService</span></span><br><span class="line">            <span class="comment">//並且實體是由外部來決定，也就是所謂的依賴注入DI</span></span><br><span class="line">            _POIService = poiService;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> ActionResult <span class="title">Index</span>(<span class="params"><span class="built_in">string</span> id</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//依賴外部注入的IPOIService介面</span></span><br><span class="line">            <span class="keyword">var</span> POIs = _POIService.Get(id);</span><br><span class="line">            <span class="keyword">return</span> Json(POIs,JsonRequestBehavior.AllowGet);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>這邊用的<span style="color: #bf9000;">IPOIService</span>是由外部注入的，實體已經不由<strong>HomeController <strong>內部來決定了(不New實體了)，也就是上面所提到的</strong>DI 依賴注入</strong>(<em>要用的實體由建構子注入</em>)，<strong>IOC控制反轉</strong>(<em>實體已經由內部控制改由外部控制了</em>)</p>
<p>接下來面臨的問題是，雖然我們讓實體改成用外部注入的方式，但HomeController在建立的時候是由系統去產生的，它怎麼知道<span style="color: #bf9000;">IPOIService</span>的實體是要注入誰，所以現在執行程式會看到以下結果</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-0ijdWklCbSk/V7QYVfZnz_I/AAAAAAAAH7w/Bj3Sa8cECEcTJNOsObhzWMd6vMjwUJIggCLcB/s1600/1.png)](https://4.bp.blogspot.com/-0ijdWklCbSk/V7QYVfZnz_I/AAAAAAAAH7w/Bj3Sa8cECEcTJNOsObhzWMd6vMjwUJIggCLcB/s1600/1.png)</div>

<p>這時候就要介紹<strong>Unity</strong>這個套件來幫我們解決這個問題了</p>
<p>**</p>
<hr>
<p>**<strong>何謂Unity</strong></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-PEXphTQycyE/V7QY_Y7zGoI/AAAAAAAAH70/n8FT2stz8PQnOEXWrUSl95ilLNBrmTz1gCLcB/s400/MSUNITY.jpg)](https://1.bp.blogspot.com/-PEXphTQycyE/V7QY_Y7zGoI/AAAAAAAAH70/n8FT2stz8PQnOEXWrUSl95ilLNBrmTz1gCLcB/s1600/MSUNITY.jpg)</div>MSDN上的Unity套件介紹 : [https://msdn.microsoft.com/en-us/library/ff647202.aspx](https://msdn.microsoft.com/en-us/library/ff647202.aspx)
**
**<span style="font-size: large;">其實這個套件說穿了就是在Application啟動時，註冊每個Interface對應的實體是誰，當碰到要注入這個Interface時，Unity就會去找找看你有沒有跟它說對應的實體，如果有，它就把實體產生出來幫你帶入。</span>那就一步一步做做看邊體會它的意思
<span style="font-size: large;">
</span>
<span style="font-size: large;">
</span><span style="font-size: large;">**1.安裝Unity套件&nbsp;**</span>
<span style="font-size: large;">
</span>請在Application專案透過Nuget搜尋Unity安裝**Unity.Mvc**
<div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-HhIfl_RkSKA/V7QbZyR_3SI/AAAAAAAAH8M/C4VxtKVrLdUkdbq6eGIXxg0bH9m_A6DpACLcB/s640/1.png)](https://2.bp.blogspot.com/-HhIfl_RkSKA/V7QbZyR_3SI/AAAAAAAAH8M/C4VxtKVrLdUkdbq6eGIXxg0bH9m_A6DpACLcB/s1600/1.png)</div>
**
****<b style="font-size: medium;">2.註冊Interface應該對應的實體**</b>
**<b style="font-size: medium;">
**</b>這時候打開App_Start資料夾應該會看到多了一個檔案**UnityConfig.cs**

<div class="separator" style="clear: both; font-weight: bold; text-align: center;">[![](https://2.bp.blogspot.com/-MCmsg-5dEEY/V7Qb_xiRLFI/AAAAAAAAH8U/3JMMEHww4joUlfQI3HjpW0abcn343O9KwCLcB/s320/1.png)](https://2.bp.blogspot.com/-MCmsg-5dEEY/V7Qb_xiRLFI/AAAAAAAAH8U/3JMMEHww4joUlfQI3HjpW0abcn343O9KwCLcB/s1600/1.png)</div><div class="separator" style="clear: both; font-weight: bold; text-align: center;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">打開它會看到以下Code跟註解，教你怎麼使用它</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-B5FxVSeEW9Q/V7QcPsxDVeI/AAAAAAAAH8Y/lsWGO864ftoAVFsUH3nmO9mB4LL0lOAZwCLcB/s640/1.png)](https://2.bp.blogspot.com/-B5FxVSeEW9Q/V7QcPsxDVeI/AAAAAAAAH8Y/lsWGO864ftoAVFsUH3nmO9mB4LL0lOAZwCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">請將**RegisterTypes**&nbsp;改成以下</div><div class="separator" style="clear: both; text-align: left;">
</div><div class="separator" style="clear: both; text-align: left;">
</div>```csharp
/// <summary>Registers the type mappings with the Unity container.</summary>
        /// <param name="container">The unity container to configure.</param>
        /// <remarks>There is no need to register concrete types such as controllers or API controllers (unless you want to 
        /// change the defaults), as Unity allows resolving a concrete type even if it was not previously registered.</remarks>
        public static void RegisterTypes(IUnityContainer container)
        {

<pre><code>        //TransientLifetimeManager為這個實體的創建生命週期
        //表示執行程式時，每次碰到IPOIService都會去new 一個新的POIService
        //Unity有許多生命週期可以使用，可以參考官方的文件
        //例如PerResolveLifetimeManager就是本次Request只有New一次實體，如果同個Request碰到多次
        //都還是會返回第一次New的實體，直到Reqeust結束才會被消滅掉,Singleton的概念
        container.RegisterType&lt;IPOIService, POIService&gt;(new TransientLifetimeManager());
    &#125;
</code></pre>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">關於Unity創建實體的生命週期請參考官方文件 :&amp;nbsp;[https:&#x2F;&#x2F;msdn.microsoft.com&#x2F;en-us&#x2F;library&#x2F;ff660872(v&#x3D;pandp.20).aspx](https:&#x2F;&#x2F;msdn.microsoft.com&#x2F;en-us&#x2F;library&#x2F;ff660872(v&#x3D;pandp.20).aspx)</span><br><span class="line"></span><br><span class="line">註冊好後接著執行看看，會發現程式又活過來了，不會再出現剛剛的錯誤頁面，因為程式已經知道該Interface對應的實體是誰，當由外部注入時，Unity會自己去幫你控制實體的產生並且注入</span><br><span class="line"></span><br><span class="line">&lt;div class&#x3D;&quot;separator&quot; style&#x3D;&quot;clear: both; text-align: center;&quot;&gt;[![](https:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-QgBTpClZA_g&#x2F;V7QgW_P_VNI&#x2F;AAAAAAAAH8o&#x2F;EBBv1BKh0pIIbOKaZoPRQB4Gt-dmnLcmgCLcB&#x2F;s640&#x2F;1.png)](https:&#x2F;&#x2F;4.bp.blogspot.com&#x2F;-QgBTpClZA_g&#x2F;V7QgW_P_VNI&#x2F;AAAAAAAAH8o&#x2F;EBBv1BKh0pIIbOKaZoPRQB4Gt-dmnLcmgCLcB&#x2F;s1600&#x2F;1.png)&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">透過這個重構的實例，我們可以從裡面瞭解到何謂**DI**與**IOC**的概念，但可能會想說，那這樣的好處是什麼? 直接New錯了嗎?</span><br><span class="line"></span><br><span class="line">回到前一篇提到的，如果直接New的話也就是高耦合的狀況，如果今天面對的實體改動時，很難避免耦合的地方不會跟著變動，所以我們**依賴抽象**(Interface)，用了Unity後其實又牽扯到一個大重點&quot;**職責分離**&quot;。</span><br><span class="line"></span><br><span class="line">以後如果有Interface與實體的對應關係，直接就會想到要去**UnityConfig.cs**來改，所有的註冊表在這邊統一管理而且一目了然，如果哪天主管跟你說**POIService**它不喜歡，要重新寫個**NewPOIService**，那我們是不是直接把**NewPOIService實作**&lt;span style&#x3D;&quot;color: #bf9000;&quot;&gt;IPOIService&lt;&#x2F;span&gt;後，然後打開**UnityConfig.cs**改成這樣即可</span><br><span class="line"></span><br><span class="line">&#96;&#96;&#96;csharp</span><br><span class="line">container.RegisterType&lt;IPOIService, NewPOIService&gt;(new TransientLifetimeManager());</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>其他地方連動都不用動，就已經直接將對應的實體給換掉了!!! 統一管理之外，也能達到最小更動原則。</p>
<p>這次的重構就先到這邊~</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/08/16/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%B8%80-%E5%A4%9A%E5%9E%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/16/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%B8%80-%E5%A4%9A%E5%9E%8B/" class="post-title-link" itemprop="url">【重構系列】(一) 多型</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-16 15:33:00" itemprop="dateCreated datePublished" datetime="2016-08-16T15:33:00+08:00">2016-08-16</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/08/16/%E3%80%90%E9%87%8D%E6%A7%8B%E7%B3%BB%E5%88%97%E3%80%91-%E4%B8%80-%E5%A4%9A%E5%9E%8B/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/16/【重構系列】-一-多型/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>以下實做的SourceCode已經放到GitHub :<br><a target="_blank" rel="noopener" href="https://github.com/toyo0103/Demo_EditTemplate_1">https://github.com/toyo0103/Demo_EditTemplate_1</a></p>
<p>最近在幫專案成員導入開發分層以及物件導向的觀念，也想把這Demo的過程記錄下來。畢竟想法可能隨著專案的經歷而不斷的在修正，也可藉此不斷回頭檢視自己的基本功是否足夠</p>
<h4 id="一、首先來看一下專案分層的關聯圖"><a href="#一、首先來看一下專案分層的關聯圖" class="headerlink" title="        一、首先來看一下專案分層的關聯圖     "></a><span style="font-size: x-large;">        一、首先來看一下專案分層的關聯圖     </span></h4><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-2uYHHE-iq7c/V7JxJbl6gCI/AAAAAAAAH3w/I-gYOBfJq8U_fLoVSQTuySsCtNMSb9J6ACLcB/s1600/1.png)](https://2.bp.blogspot.com/-2uYHHE-iq7c/V7JxJbl6gCI/AAAAAAAAH3w/I-gYOBfJq8U_fLoVSQTuySsCtNMSb9J6ACLcB/s1600/1.png)</div>

<p>Application : 應用層，參考了邏輯層</p>
<p>Service : &nbsp;邏輯層，參考了資料存取層</p>
<p>Repository : 資料存取層</p>
<p>Lib : 共用層 ，被Application、Service、Repository參考</p>
<h3 id="二、目前各層尚未重構的程式"><a href="#二、目前各層尚未重構的程式" class="headerlink" title="        二、目前各層尚未重構的程式     "></a><span style="font-size: x-large;">        二、目前各層尚未重構的程式     </span></h3><div>

<h3 id="Repository層"><a href="#Repository層" class="headerlink" title="Repository層"></a><strong><span style="color: #444444; font-size: large;"><u>Repository層</u></span></strong></h3></div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-tg5bIS8XXLo/V7Kv7donQqI/AAAAAAAAH4A/LMM962SvdT8znywny9YxnzQbnxKS0H-oQCLcB/s1600/1.png)](https://2.bp.blogspot.com/-tg5bIS8XXLo/V7Kv7donQqI/AAAAAAAAH4A/LMM962SvdT8znywny9YxnzQbnxKS0H-oQCLcB/s1600/1.png)</div>

<p>模擬A廠商提供的POI(地圖座標點)資料</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> POI A供應商</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title">ASupplierRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            Random rnd = <span class="keyword">new</span> Random();</span><br><span class="line">            <span class="comment">//隨機建立十筆Supplier為A的資料回傳</span></span><br><span class="line">            <span class="keyword">var</span> fixture = <span class="keyword">new</span> Fixture();</span><br><span class="line">            <span class="keyword">var</span> Result = fixture.Build&lt;POI&gt;()</span><br><span class="line">                            .With(x =&gt; x.Name, <span class="built_in">string</span>.Concat(<span class="string">&quot;捷運&quot;</span>, rnd.Next(<span class="number">1</span>, <span class="number">100</span>)))</span><br><span class="line">                            .With(x =&gt; x.Supplier, SupplierEnum.A)</span><br><span class="line">                            .CreateMany().ToList();</span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong><span style="color: #444444; font-size: large;"><u><br></u></span>****<span style="color: #444444; font-size: large;"><u>Service層</u></span></strong></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-Bcv7-vwubuU/V7KxJwqZf9I/AAAAAAAAH4I/9vgY1F6fzbI28ZdK-OCZZmF9bzaM9_FJQCLcB/s1600/1.png)](https://4.bp.blogspot.com/-Bcv7-vwubuU/V7KxJwqZf9I/AAAAAAAAH4I/9vgY1F6fzbI28ZdK-OCZZmF9bzaM9_FJQCLcB/s1600/1.png)</div>**<span style="color: #666666;">
</span>****<span style="color: #666666;">
</span>**傳入頻道代碼，依據頻道底下的類別，去各供應商取得POI資料，目前模擬頻道資料如下
<div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-e-CVa7nJHGo/V7KxhdAVBQI/AAAAAAAAH4M/4xbGZY9o5JE9Dg6fnyvtWQOmm0wMKcDXgCLcB/s320/1.png)](https://4.bp.blogspot.com/-e-CVa7nJHGo/V7KxhdAVBQI/AAAAAAAAH4M/4xbGZY9o5JE9Dg6fnyvtWQOmm0wMKcDXgCLcB/s1600/1.png)</div>

<p><strong>頻道1</strong>底下有一個<strong>交通</strong>的類別，該類別的POI資料來源為<span style="color: red;">A廠商</span>提供<br><strong>頻道2</strong>底下有一個<strong>交通</strong>的類別，該類別的POI資料來源為<span style="color: red;">A廠商</span>與<span style="color: red;">B廠商</span>提供的總和</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">POIService</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> List&lt;POI&gt; <span class="title">Get</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">var</span> Result = <span class="keyword">new</span> List&lt;POI&gt;();</span><br><span class="line">            <span class="keyword">var</span> channel = GetChannel(channelID);</span><br><span class="line">            <span class="comment">//逐一搜尋頻道底下的各類別</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> category <span class="keyword">in</span> channel.Categorys)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//依據該類別所指定的供應商向Repository要資料</span></span><br><span class="line">                category.Supplier.ForEach(x =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (x)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">case</span> SupplierEnum.A:</span><br><span class="line">                            <span class="keyword">var</span> ASupplier = <span class="keyword">new</span> ASupplierRepository();</span><br><span class="line">                            <span class="keyword">var</span> APOIs = ASupplier.Get();</span><br><span class="line">                            Result.AddRange(APOIs);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> SupplierEnum.B:</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//並接總合的結果回傳</span></span><br><span class="line">            <span class="keyword">return</span> Result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 模擬頻道類別對應表</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;param name=&quot;channelID&quot;&gt;</span>The channel identifier.<span class="doctag">&lt;/param&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>Channel.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">Channel <span class="title">GetChannel</span>(<span class="params"><span class="built_in">string</span> channelID</span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="keyword">if</span> (channelID == <span class="string">&quot;1&quot;</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">                &#123;</span><br><span class="line">                    ID = <span class="string">&quot;1&quot;</span>,</span><br><span class="line">                    Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">new</span> Channel.Category</span><br><span class="line">                        &#123;</span><br><span class="line">                            Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                            Supplier =<span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Channel</span><br><span class="line">            &#123;</span><br><span class="line">                ID = channelID,</span><br><span class="line">                Categorys = <span class="keyword">new</span> List&lt;Channel.Category&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">new</span> Channel.Category</span><br><span class="line">                    &#123;</span><br><span class="line">                        Name = <span class="string">&quot;交通&quot;</span>,</span><br><span class="line">                        Supplier = <span class="keyword">new</span> List&lt;SupplierEnum&gt; &#123; SupplierEnum.A , SupplierEnum.B &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="Application層"><a href="#Application層" class="headerlink" title="Application層"></a><strong><span style="color: #444444; font-size: large;"><u>Application層</u></span></strong></h3><div>將傳入的ID透過Service去取得POI資料，並解用Json回傳     **<span style="color: #990000;">
</span>**</div>```csharp
public ActionResult Index(string id)
        {
            var Service = new POIService();
            var POIs = Service.Get(id);
            return Json(POIs,JsonRequestBehavior.AllowGet);
        }

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">目前執行結果</span><br><span class="line">&lt;div class&#x3D;&quot;separator&quot; style&#x3D;&quot;clear: both; text-align: center;&quot;&gt;[![](https:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-COJi7ExMLgY&#x2F;V7KzgT1tBuI&#x2F;AAAAAAAAH4c&#x2F;59FwAwpv1U4UniOKgZUJGJMy-jM4AxskgCLcB&#x2F;s320&#x2F;1.png)](https:&#x2F;&#x2F;3.bp.blogspot.com&#x2F;-COJi7ExMLgY&#x2F;V7KzgT1tBuI&#x2F;AAAAAAAAH4c&#x2F;59FwAwpv1U4UniOKgZUJGJMy-jM4AxskgCLcB&#x2F;s1600&#x2F;1.png)&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">###     &lt;span style&#x3D;&quot;font-size: x-large;&quot;&gt;三、加入B廠商Repository&lt;&#x2F;span&gt;</span><br><span class="line">&lt;div&gt;&lt;span style&#x3D;&quot;font-size: x-large;&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line"></span><br><span class="line">###         &lt;span style&#x3D;&quot;font-size: x-large;&quot;&gt;            **&lt;span style&#x3D;&quot;color: #444444; font-size: large;&quot;&gt;&lt;u&gt;Repository層加入BSupplierRepositoy&lt;&#x2F;u&gt;&lt;&#x2F;span&gt;**        &lt;&#x2F;span&gt;    </span><br><span class="line">&lt;span style&#x3D;&quot;font-size: x-large;&quot;&gt;    &lt;&#x2F;span&gt;&lt;&#x2F;div&gt;&lt;div class&#x3D;&quot;separator&quot; style&#x3D;&quot;clear: both; text-align: center;&quot;&gt;[![](https:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-qhpGz7u6oVg&#x2F;V7K0fW7yuaI&#x2F;AAAAAAAAH4k&#x2F;nGTc-zqfiE4MS4uEtO_gG_mdHZbJkkNsACLcB&#x2F;s1600&#x2F;1.png)](https:&#x2F;&#x2F;1.bp.blogspot.com&#x2F;-qhpGz7u6oVg&#x2F;V7K0fW7yuaI&#x2F;AAAAAAAAH4k&#x2F;nGTc-zqfiE4MS4uEtO_gG_mdHZbJkkNsACLcB&#x2F;s1600&#x2F;1.png)&lt;&#x2F;div&gt;&lt;div&gt;**&lt;span style&#x3D;&quot;color: #990000;&quot;&gt;</span><br><span class="line">&lt;&#x2F;span&gt;**    **&lt;span style&#x3D;&quot;color: #990000;&quot;&gt;</span><br><span class="line">&lt;&#x2F;span&gt;**&lt;&#x2F;div&gt;&#96;&#96;&#96;csharp</span><br><span class="line">&#x2F;&#x2F;&#x2F; &lt;summary&gt;</span><br><span class="line">    &#x2F;&#x2F;&#x2F; POI B供應商</span><br><span class="line">    &#x2F;&#x2F;&#x2F; &lt;&#x2F;summary&gt;</span><br><span class="line">    public class BSupplierRepository</span><br><span class="line">    &#123;</span><br><span class="line">        public List&lt;POI&gt; Get()</span><br><span class="line">        &#123;</span><br><span class="line">            Random rnd &#x3D; new Random();</span><br><span class="line">            &#x2F;&#x2F;隨機建立十筆Supplier為B的資料回傳</span><br><span class="line">            var fixture &#x3D; new Fixture();</span><br><span class="line">            var Result &#x3D; fixture.Build&lt;POI&gt;()</span><br><span class="line">                            .With(x &#x3D;&gt; x.Name, string.Concat(&quot;捷運&quot;, rnd.Next(1, 100)))</span><br><span class="line">                            .With(x &#x3D;&gt; x.Supplier, SupplierEnum.B)</span><br><span class="line">                            .CreateMany().ToList();</span><br><span class="line">            return Result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id=""><a href="#" class="headerlink" title=""></a><span style="color: #444444; font-size: large;"></span></h3><h3 id="Service層"><a href="#Service層" class="headerlink" title="Service層"></a><span style="font-size: x-large;"><strong><span style="color: #444444; font-size: large;"><u>Service層</u></span></strong></span></h3><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//逐一搜尋頻道底下的各類別</span></span><br><span class="line">            <span class="keyword">foreach</span> (<span class="keyword">var</span> category <span class="keyword">in</span> channel.Categorys)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//依據該類別所指定的供應商向Repository要資料</span></span><br><span class="line">                category.Supplier.ForEach(x =&gt;</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">switch</span> (x)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">case</span> SupplierEnum.A:</span><br><span class="line">                            <span class="keyword">var</span> ASupplier = <span class="keyword">new</span> ASupplierRepository();</span><br><span class="line">                            <span class="keyword">var</span> APOIs = ASupplier.Get();</span><br><span class="line">                            Result.AddRange(APOIs);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">case</span> SupplierEnum.B: <span class="comment">//補上B廠商</span></span><br><span class="line">                            <span class="keyword">var</span> BSupplier = <span class="keyword">new</span> BSupplierRepository();</span><br><span class="line">                            <span class="keyword">var</span> BPOIs = BSupplier.Get();</span><br><span class="line">                            Result.AddRange(BPOIs);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="執行結果"><a href="#執行結果" class="headerlink" title="執行結果"></a><span style="font-size: x-large;"><strong><span style="color: #444444; font-size: large;"><u>執行結果</u></span></strong></span></h3><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-oLBfowU5dPE/V7K3te4Ug8I/AAAAAAAAH4w/HWxKp39vbfwkUb4zpQkvoB_umOlCnBk2gCLcB/s1600/1.png)](https://3.bp.blogspot.com/-oLBfowU5dPE/V7K3te4Ug8I/AAAAAAAAH4w/HWxKp39vbfwkUb4zpQkvoB_umOlCnBk2gCLcB/s1600/1.png)</div><div class="separator" style="clear: both; text-align: center;">
</div><div class="separator" style="clear: both; text-align: center;">
</div><div><span style="font-size: x-large;">
</span>    

</div><span style="font-size: x-large;">四、重構開始</span>
<span style="font-size: medium;"><span style="font-size: medium;">
</span></span><span style="font-size: medium;">    <span style="font-size: medium;">        首先需要思考一個問題，雖然這樣已經可以達成需求，但很明顯的是如果今天提供POI的廠商一直增加的話，我們要一直替**Repository層**新增廠商之外，**Service層**也會一直在Switch那邊做修改。&nbsp;</span></span>
<span style="font-size: medium;">
</span><div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-At8pfSKZU1A/V7O464uATbI/AAAAAAAAH6Y/_ZteovVvDKgiWIP4C7VOW0d_ID0T3Yn0gCLcB/s640/1.png)](https://3.bp.blogspot.com/-At8pfSKZU1A/V7O464uATbI/AAAAAAAAH6Y/_ZteovVvDKgiWIP4C7VOW0d_ID0T3Yn0gCLcB/s1600/1.png)</div><span style="font-size: medium;">
</span><div class="separator" style="clear: both; text-align: center;">[![](https://4.bp.blogspot.com/-_mL7zcPN80s/V7O5MABxbiI/AAAAAAAAH6c/iwdP7xw3pVkJlb08t52ggMFcpuNRywTZQCLcB/s640/1.png)](https://4.bp.blogspot.com/-_mL7zcPN80s/V7O5MABxbiI/AAAAAAAAH6c/iwdP7xw3pVkJlb08t52ggMFcpuNRywTZQCLcB/s1600/1.png)</div>
 <span style="font-size: medium;"><span style="font-size: medium;"></span></span><span style="font-size: medium;">那該怎麼改可以避免每次改Repository又要一直改Service層呢?</span>

<span style="font-size: medium;">
</span><span style="font-size: medium;">這時就會運用到OO原則中的**依賴抽象**概念，當我們面對的是實體(例如:**ASupplierRepository** , **BSupplierRepository**)時也就是所謂的高耦合，如果面對的實體有所變動時，所有耦合的地方都會有高機率要一起改動的風險。</span>
<span style="font-size: medium;">
</span><span style="font-size: medium;">因為要面對抽象，第一步我們就要來觀察這兩個實體共通處是什麼?     其實說穿了都是提供一個叫做Get()的方法，當呼叫他時，回傳對應的POI List，這就是它們共通的地方，接下來透過抽取介面的方式來實行隔離&nbsp;</span>
<span style="font-size: medium;">**<span style="color: #bf9000;">
</span>**</span><span style="font-size: medium;">**<span style="color: #bf9000;">
</span>**</span><div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-8ZNSvrUREs8/V7O5d9RkdPI/AAAAAAAAH6g/l9zIPDnhW2MYl-bCWyutTDSp9UeRtpDigCLcB/s640/1.png)](https://1.bp.blogspot.com/-8ZNSvrUREs8/V7O5d9RkdPI/AAAAAAAAH6g/l9zIPDnhW2MYl-bCWyutTDSp9UeRtpDigCLcB/s1600/1.png)</div>
 <span style="font-size: medium;">**<span style="color: #bf9000;">
</span>**</span><span style="font-size: medium;"></span><span style="font-size: medium;">**<span style="color: #bf9000;">ISupplierRepository</span>**</span>

<p><span style="font-size: medium;"><a target="_blank" rel="noopener" href="https://2.bp.blogspot.com/--6JFyTbCJPw/V7K6stloRhI/AAAAAAAAH48/_u2UnWJmUL8lQhC91Ts5ieBO4iAfdYsCgCLcB/s1600/1.png"><img src="https://2.bp.blogspot.com/--6JFyTbCJPw/V7K6stloRhI/AAAAAAAAH48/_u2UnWJmUL8lQhC91Ts5ieBO4iAfdYsCgCLcB/s1600/1.png"></a></span> </p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> Interface ISupplierRepository</span></span><br><span class="line">    <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title">ISupplierRepository</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> 取得POI資料</span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;/summary&gt;</span></span></span><br><span class="line">        <span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;returns&gt;</span>List&amp;lt;POI&amp;gt;.<span class="doctag">&lt;/returns&gt;</span></span></span><br><span class="line">        <span class="function">List&lt;POI&gt; <span class="title">Get</span>(<span class="params"></span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>將<strong>ASupplierRepository</strong><span style="font-size: medium;">&nbsp;, <strong>B</strong></span><strong>SupplierRepository</strong><span style="font-size: medium;">都套上介面</span><br><span style="font-size: medium;"><br></span></p>
<div class="separator" style="clear: both; text-align: center;">[![](https://3.bp.blogspot.com/-Jcpo5G8HHb0/V7K7uHZpu4I/AAAAAAAAH5I/uBTimpbb1_YxzjwVDH3ApMka-KNPy-fBwCLcB/s640/1.png)](https://3.bp.blogspot.com/-Jcpo5G8HHb0/V7K7uHZpu4I/AAAAAAAAH5I/uBTimpbb1_YxzjwVDH3ApMka-KNPy-fBwCLcB/s1600/1.png)</div><span style="font-size: medium;">
</span><span style="font-size: medium;">
</span>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-e3WLuMtpxh4/V7K7kaOISdI/AAAAAAAAH5E/ZLhqJrVmBcMxApVZcO82qEAbAGXsNTcaACLcB/s640/1.png)](https://2.bp.blogspot.com/-e3WLuMtpxh4/V7K7kaOISdI/AAAAAAAAH5E/ZLhqJrVmBcMxApVZcO82qEAbAGXsNTcaACLcB/s1600/1.png)</div><span style="font-size: medium;">
</span><span style="font-size: medium;">
</span><span style="font-size: medium;">將兩個類別都實作了</span><span style="color: #bf9000;"><span style="color: #bf9000;">ISupplierRepository</span><span style="font-size: medium;">介面後，來修改**Service層**，讓它能面對抽象而非直接面對實體</span></span>
<span style="color: #bf9000;"><span style="font-size: medium;">
</span></span><span style="color: #bf9000;"></span>

<h3 id="Service層-1"><a href="#Service層-1" class="headerlink" title="Service層"></a><span style="font-size: x-large;"><strong><span style="color: #444444; font-size: large;"><u>Service層</u></span></strong></span></h3><div><span style="color: #444444;">首先先運用簡單工廠模式，請它來幫我們建造SupplierRepository的實體</span></div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-sUw1JL2z37U/V7K9OulK-EI/AAAAAAAAH5Y/VeGijYdLK7ElsbQb0Cie22U4PnGOex-BwCLcB/s1600/1.png)](https://2.bp.blogspot.com/-sUw1JL2z37U/V7K9OulK-EI/AAAAAAAAH5Y/VeGijYdLK7ElsbQb0Cie22U4PnGOex-BwCLcB/s1600/1.png)</div><div><span style="color: #444444;"><u>
</u></span></div>```csharp
public class SupplierFactory
    {
        public static ISupplierRepository Generate(SupplierEnum supplierType)
        {
            //因為A跟B的SupplierRepository都有實做ISupplierRepository
            //所以這邊可以直接回傳介面，也間接地規範以後新增SupplierRepository都要實作ISupplierRepository介面
            switch (supplierType)
            {
                case SupplierEnum.A:
                    return new ASupplierRepository();
                case SupplierEnum.B:
                    return new BSupplierRepository();
            }
            return null;
        }
    }

<p>```</p>
<p>修改原本的POIService，讓它透過工廠來取得Repository，而不是直接去New實體</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-yqxvmh12FqM/V7K97eMgJOI/AAAAAAAAH5c/jeYldicOfYYSTvZJeGJRKOkPtJ7OETKXwCLcB/s640/1.png)](https://1.bp.blogspot.com/-yqxvmh12FqM/V7K97eMgJOI/AAAAAAAAH5c/jeYldicOfYYSTvZJeGJRKOkPtJ7OETKXwCLcB/s1600/1.png)</div>

<p>瞬間乾淨很多，而且<strong>POIService</strong>不再直接對<strong>ASupplierRepository</strong><span style="font-size: small;">&nbsp;,&nbsp;<strong>B</strong></span><strong>SupplierRepository</strong><span style="font-size: medium;">，而是面對</span><span style="color: #bf9000;">ISupplierRepository</span>，達成了所謂的面對抽象。</p>
<p>這時候思考一下，以後新增供應商的Repository時POIService都不用改動了，只要Repository層新增好後，將Factory改一下即可，但是否又跳出另一個問題了。<strong>這樣Repository層更動時還不是要打開Service層去做修改。 因此在這我會將Factory搬Repository層去封裝起來</strong></p>
<h3 id="將SupplierFactory搬到Repository層，並將實體Repository改成Internal封裝起來"><a href="#將SupplierFactory搬到Repository層，並將實體Repository改成Internal封裝起來" class="headerlink" title="將SupplierFactory搬到Repository層，並將實體Repository改成Internal封裝起來"></a><span style="font-family: &quot;times new roman&quot;; font-size: x-large;"><strong><span style="color: #444444; font-size: large;"><u>將</u></span></strong></span><span style="color: #444444; font-family: &quot;times new roman&quot;; font-size: large;"><u>SupplierFactory搬到Repository</u></span><strong><span style="color: #444444; font-size: large;"><u>層，並將實體Repository改成Internal封裝起來</u></span></strong></h3><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-WrLZP8-uAWU/V7LAj2T_ieI/AAAAAAAAH5s/uZ2PH9JQGX4X1aOwYavGDKaCHKfXC95MQCLcB/s1600/1.png)](https://2.bp.blogspot.com/-WrLZP8-uAWU/V7LAj2T_ieI/AAAAAAAAH5s/uZ2PH9JQGX4X1aOwYavGDKaCHKfXC95MQCLcB/s1600/1.png)</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-6shnp4lJN7Q/V7LA6VF0OmI/AAAAAAAAH5w/7eVfEwIFG38IGqtWYLxr-QDBdIAHtw1_wCLcB/s400/1.png)](https://2.bp.blogspot.com/-6shnp4lJN7Q/V7LA6VF0OmI/AAAAAAAAH5w/7eVfEwIFG38IGqtWYLxr-QDBdIAHtw1_wCLcB/s1600/1.png)</div><div>
</div><div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-OMNNg00W0qE/V7LBG6V83fI/AAAAAAAAH50/1stqCDyKtRMLmxt-QBvl3vXZ9khxZOFpACLcB/s400/1.png)](https://2.bp.blogspot.com/-OMNNg00W0qE/V7LBG6V83fI/AAAAAAAAH50/1stqCDyKtRMLmxt-QBvl3vXZ9khxZOFpACLcB/s1600/1.png)</div>
<div>換句話說，因為改成Internal的關係，現在Service層也碰不到**ASupplierRepository**<span style="font-size: small;">&nbsp;,&nbsp;**B**</span>**SupplierRepository**<span style="font-size: medium;">這兩個實體了，完全只能依賴Factory來取得介面的對應實體，未來不管怎麼新增Repository都不會再改**Service層**，到這邊就是重構並且實踐多型了</span></div><div><span style="font-size: medium;">
</span>    <span style="font-size: medium;">
</span>    <span style="font-size: medium;">目前UML結構圖如下</span>
<div class="separator" style="clear: both; text-align: center;">[![](https://1.bp.blogspot.com/-fUMrd2aOxZs/V7LGMRcCTpI/AAAAAAAAH6I/lgwJmCO6LYse8DXoFEJKw3NqwtL7Z7f7QCLcB/s1600/1.png)](https://1.bp.blogspot.com/-fUMrd2aOxZs/V7LGMRcCTpI/AAAAAAAAH6I/lgwJmCO6LYse8DXoFEJKw3NqwtL7Z7f7QCLcB/s1600/1.png)    </div><span style="font-size: medium;">
</span></div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2016/08/05/%E3%80%90FluentAssertions%E3%80%91%E5%A6%82%E4%BD%95%E9%A9%97%E8%AD%89%E5%B7%A2%E7%8B%80%E7%B5%90%E6%A7%8B%E4%B8%AD%EF%BC%8CDouble%E5%80%8D%E7%B2%BE%E6%BA%96%E6%95%B8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/08/05/%E3%80%90FluentAssertions%E3%80%91%E5%A6%82%E4%BD%95%E9%A9%97%E8%AD%89%E5%B7%A2%E7%8B%80%E7%B5%90%E6%A7%8B%E4%B8%AD%EF%BC%8CDouble%E5%80%8D%E7%B2%BE%E6%BA%96%E6%95%B8/" class="post-title-link" itemprop="url">【FluentAssertions】如何驗證巢狀結構中，Double倍精準數</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-08-05 10:39:00" itemprop="dateCreated datePublished" datetime="2016-08-05T10:39:00+08:00">2016-08-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2016/08/05/%E3%80%90FluentAssertions%E3%80%91%E5%A6%82%E4%BD%95%E9%A9%97%E8%AD%89%E5%B7%A2%E7%8B%80%E7%B5%90%E6%A7%8B%E4%B8%AD%EF%BC%8CDouble%E5%80%8D%E7%B2%BE%E6%BA%96%E6%95%B8/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2016/08/05/【FluentAssertions】如何驗證巢狀結構中，Double倍精準數/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>寫單元測試的時候常常會使用<a target="_blank" rel="noopener" href="http://www.fluentassertions.com/">FluentAssertions</a>這個套件來做驗證，即便兩個巢狀結構的類別透過這個套件也能輕鬆解決比對問題。</p>
<p>但最近碰到當重狀結構裡面有Double這類的趨近值數值時，驗證會失敗，查了一下後找到解法，所以紀錄一下</p>
<p>原本UnitTest程式長這樣</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">TestMethod</span>]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Test_DoubleAssert</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>        &#123;</span><br><span class="line">            <span class="comment">//arrange</span></span><br><span class="line">            <span class="keyword">var</span> stops = <span class="keyword">new</span> List&lt;BusStopAPIResult&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> BusStopAPIResult</span><br><span class="line">                &#123;</span><br><span class="line">                    StopName = <span class="keyword">new</span> NameAPIResult</span><br><span class="line">                    &#123;</span><br><span class="line">                        Zh_tw = <span class="string">&quot;吊橋頭&quot;</span>,</span><br><span class="line">                        En = <span class="string">&quot;deocioutao&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    StopUID = <span class="string">&quot;StopUID1&quot;</span>,</span><br><span class="line">                    StopPosition = <span class="keyword">new</span> BusStopAPIResult.Coordinate</span><br><span class="line">                    &#123;</span><br><span class="line">                        PositionLat = <span class="number">24.853690</span>,</span><br><span class="line">                        PositionLon = <span class="number">121.354917</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="keyword">new</span> BusStopAPIResult</span><br><span class="line">                &#123;</span><br><span class="line">                    StopName = <span class="keyword">new</span> NameAPIResult</span><br><span class="line">                    &#123;</span><br><span class="line">                        Zh_tw = <span class="string">&quot;吊橋頭&quot;</span>,</span><br><span class="line">                        En = <span class="string">&quot;deocioutao&quot;</span></span><br><span class="line">                    &#125;,</span><br><span class="line">                    StopUID = <span class="string">&quot;StopUID2&quot;</span>,</span><br><span class="line">                    StopPosition = <span class="keyword">new</span> BusStopAPIResult.Coordinate</span><br><span class="line">                    &#123;</span><br><span class="line">                        PositionLat = <span class="number">24.853632</span>,</span><br><span class="line">                        PositionLon = <span class="number">121.354874</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> expected = <span class="keyword">new</span> List&lt;BusStopClusterDTO&gt;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">new</span> BusStopClusterDTO</span><br><span class="line">                &#123;</span><br><span class="line">                    Name = <span class="string">&quot;吊橋頭&quot;</span>,</span><br><span class="line">                    SourceID = <span class="string">&quot;StopUID1&quot;</span>,</span><br><span class="line">                    IDs = <span class="keyword">new</span> List&lt;<span class="built_in">string</span>&gt; &#123; <span class="string">&quot;StopUID1&quot;</span> , <span class="string">&quot;StopUID2&quot;</span> &#125;,</span><br><span class="line">                    Lat = <span class="number">24.853661</span>,</span><br><span class="line">                    Lng = <span class="number">121.3548955</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//act</span></span><br><span class="line">            <span class="keyword">var</span> actual = Program.ClusterSourceData(stops);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//assert</span></span><br><span class="line">            actual.ShouldBeEquivalentTo(expected);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<p>執行結果如圖</p>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-LvpAUuEAqzk/V6P6OrTaInI/AAAAAAAAH3U/37TPKUzXfAI0KKdMpNDAJCpcvBrZXZH2gCLcB/s640/1.png)](https://2.bp.blogspot.com/-LvpAUuEAqzk/V6P6OrTaInI/AAAAAAAAH3U/37TPKUzXfAI0KKdMpNDAJCpcvBrZXZH2gCLcB/s1600/1.png)</div>
<div class="separator" style="clear: both; text-align: center;">[![](https://2.bp.blogspot.com/-xi043e38HW0/V6P6m4ED9_I/AAAAAAAAH3Y/T29FHNHT7h4Y51M1RTmwb1dnZJm-wMLMQCLcB/s320/1.png)](https://2.bp.blogspot.com/-xi043e38HW0/V6P6m4ED9_I/AAAAAAAAH3Y/T29FHNHT7h4Y51M1RTmwb1dnZJm-wMLMQCLcB/s1600/1.png)</div>

<p>因為數值是經緯度，經過計算後不需要驗證精確到小數點這麼多位數，所以可以改用以下方法去驗證</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">actual.ShouldBeEquivalentTo(</span><br><span class="line">               expected,</span><br><span class="line">               <span class="comment">//當欄位型別為Double時，相差到0.000001之內都是OK的</span></span><br><span class="line">               option =&gt; option.Using&lt;<span class="built_in">double</span>&gt;(</span><br><span class="line">                           ctx =&gt; ctx.Subject.Should().BeApproximately(ctx.Expectation, <span class="number">0.000001</span>))</span><br><span class="line">                       .WhenTypeIs&lt;<span class="built_in">double</span>&gt;());</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>這樣驗證就會過關了!!</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Toyo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">203</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">75</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Toyo</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://toyo0103.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
