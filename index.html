<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"toyo0103.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="程式隨筆">
<meta property="og:url" content="https://toyo0103.github.io/index.html">
<meta property="og:site_name" content="程式隨筆">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Toyo">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://toyo0103.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>程式隨筆</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="程式隨筆" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">程式隨筆</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2022/12/03/cache_control_directives/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/03/cache_control_directives/" class="post-title-link" itemprop="url">How cache-control directives affect caching?</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2022-12-03 15:00:00 / Modified: 15:56:59" itemprop="dateCreated datePublished" datetime="2022-12-03T15:00:00+08:00">2022-12-03</time>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2022/12/03/cache_control_directives/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/12/03/cache_control_directives/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>I’m curios how <code>cache-control</code> directives affect caching, so I make a small experiment to see the interaction between browser, reverse proxy and server.</p>
<p>I introduce 6 APIs with different cache-control value in response header and respond current time directly.</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left">Reponse Cache-Control</th>
</tr>
</thead>
<tbody><tr>
<td align="left">[GET]/cache/get-public</td>
<td align="left">public,max-age=120</td>
</tr>
<tr>
<td align="left">[GET]/cache/get-private</td>
<td align="left">private,max-age=120</td>
</tr>
<tr>
<td align="left">[GET]/cache/get-unset</td>
<td align="left">max-age=120</td>
</tr>
<tr>
<td align="left">[DELETE]/cache/delete-public</td>
<td align="left">public,max-age=120</td>
</tr>
<tr>
<td align="left">[DELETE]/cache/delete-private</td>
<td align="left">private,max-age=120</td>
</tr>
<tr>
<td align="left">[DELETE]/cache/delete-unset</td>
<td align="left">max-age=120</td>
</tr>
</tbody></table>
<p>Create a simple web page for test<br><img src="/images/20221103/0.png" alt="/images/20221103/0.png"></p>
<p>Clicking the buttons will call the APIs and show the response data on page. At the same time I monitor the developer tool to record the results.</p>
<p>Whether the browsers cache the response? (tested on safari, chrome and edge)</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">Public</th>
<th align="center">Private</th>
<th align="center">Unset</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GET</td>
<td align="center">V</td>
<td align="center">V</td>
<td align="center">V</td>
</tr>
<tr>
<td align="center">DELETE</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
</tr>
</tbody></table>
<p>Whether the reverse proxy(I use nginx) caches the response?</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">Public</th>
<th align="center">Private</th>
<th align="center">Unset</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GET</td>
<td align="center">V</td>
<td align="center">X</td>
<td align="center">X</td>
</tr>
<tr>
<td align="center">DELETE</td>
<td align="center">X</td>
<td align="center">X</td>
<td align="center">X</td>
</tr>
</tbody></table>
<p>According the result, we know the modern browsers will not break the rule of <code>cacheable</code>. Reverse proxy may not store the response when you don’t set public/private directives.</p>
<div class="note info">
            <p>References</p><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control">Cache-Control - HTTP | MDN (mozilla.org)</a></p><p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Glossary/cacheable">Cacheable - MDN Web Docs Glossary: Definitions of Web-related terms | MDN (mozilla.org)</a></p>
          </div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2022/08/08/http_client_does_not_change_cookie_value_per_request/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/08/08/http_client_does_not_change_cookie_value_per_request/" class="post-title-link" itemprop="url">HttpClient doesn't change cookie value per request</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-08-08 11:00:00" itemprop="dateCreated datePublished" datetime="2022-08-08T11:00:00+08:00">2022-08-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 22:30:13" itemprop="dateModified" datetime="2022-08-09T22:30:13+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2022/08/08/http_client_does_not_change_cookie_value_per_request/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/08/08/http_client_does_not_change_cookie_value_per_request/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Recently I found that the HttpClient doesn’t change cookie value per request, and it will cache the value for 2 minutes after the first request which have set the cookie value sent.</p>
<h1 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a>Environment</h1><ul>
<li>dotnet 5</li>
<li>runtime image: mcr.microsoft.com/dotnet/aspnet:5.0</li>
</ul>
<h1 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h1><p>I use typed client in our project and use HttpRequestMessage to set the cookie “user.token” in every request.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MyHttpClient</span> : <span class="title">IMyHttpClient</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">readonly</span> HttpClient _httpClient;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyHttpClient</span>(<span class="params">HttpClient httpClient</span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        <span class="keyword">this</span>._httpClient = httpClient;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">async</span> Task <span class="title">CallAPI</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>    &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> request = <span class="keyword">new</span> HttpRequestMessage(HttpMethod.Post, <span class="string">&quot;/the/api&quot;</span>);</span><br><span class="line">        <span class="comment">// set request content</span></span><br><span class="line">        request.Content = <span class="keyword">new</span> StringContent(<span class="string">&quot;mydata&quot;</span>, Encoding.UTF8, <span class="string">&quot;application/json&quot;</span>);</span><br><span class="line">        <span class="comment">// set cookie here</span></span><br><span class="line">        request.Headers.Add(<span class="string">&quot;Cookie&quot;</span>, <span class="string">$&quot;user.token=<span class="subst">&#123;token&#125;</span>&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> response = <span class="keyword">await</span> _httpClient.SendAsync(request);</span><br><span class="line">        response.EnsureSuccessStatusCode();</span><br><span class="line">        <span class="keyword">var</span> res = <span class="keyword">await</span> response.Content.ReadAsStringAsync();</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Register MyHttpClient to the Denpency Injection provider.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">services.AddHttpClient&lt;IMyHttpClient, MyHttpClient&gt;(config =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    config.BaseAddress = <span class="keyword">new</span> Uri(<span class="string">&quot;https://my.server.com&quot;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>When I use <code>CallAPI()</code> of MyHttpClient, I found the cookie doesn’t change value per request, and it will cache value for 2 minutes.</p>
<h1 id="Why"><a href="#Why" class="headerlink" title="Why"></a>Why</h1><p>HttpClient is just a container of <code>HttpClientHandler</code>. If you trace the source code on <a target="_blank" rel="noopener" href="https://github.com/dotnet/extensions/blob/v3.1.8/src/HttpClientFactory/Http/src/DefaultHttpClientFactory.cs">Github</a> you will see the code</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> HttpClient <span class="title">CreateClient</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(name));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> handler = CreateHandler(name);</span><br><span class="line">    <span class="keyword">var</span> client = <span class="keyword">new</span> HttpClient(handler, disposeHandler: <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> options = _optionsMonitor.Get(name);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; options.HttpClientActions.Count; i++)</span><br><span class="line">    &#123;</span><br><span class="line">        options.HttpClientActions[i](client);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> client;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpMessageHandler <span class="title">CreateHandler</span>(<span class="params"><span class="built_in">string</span> name</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (name == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(name));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> entry = _activeHandlers.GetOrAdd(name, _entryFactory).Value;</span><br><span class="line"></span><br><span class="line">    StartHandlerEntryTimer(entry);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> entry.Handler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When you are asking for HttpClient, HttpClientFactory will generate a HttpClient instance everytime and try to get HttpMessageHandler from the pool. Why HttpClientFactory maintains HttpMessageHandler pool for us? Because creating TCP connections are extremely expensive, so we should reuse it as we can as possible.</p>
<p>So multiple HttpClients will possibly use same HttpMessageHandler. HttpMessageHandler has Property named CookieContainer. It will store cookie value when you first time to set the value. So it will cause different requests using same cookie value until HttpMessageHandler expired.</p>
<h1 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h1><p>There is a way to stop HttpMessageHandler using CookieContainer.</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">services.AddHttpClient&lt;IPortalShellClient, PortalShellHttpClient&gt;(config =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    config.BaseAddress = <span class="keyword">new</span> Uri(clientConfig.PortalSiteEndpoint);</span><br><span class="line">&#125;)</span><br><span class="line">.ConfigurePrimaryHttpMessageHandler(() =&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//Tell HttpMessageHandler to stop using CookieContainer</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HttpClientHandler &#123; UseCookies = <span class="literal">false</span> &#125;;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Then you can set cookie value per request now.</p>
<h1 id="References"><a href="#References" class="headerlink" title="References"></a>References</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/65227400/do-pooled-httpclient-instances-keep-the-cookiecontainer">Do pooled HttpClient instances keep the CookieContainer?</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/microsoft/referencesource/blob/master/System/net/System/Net/Http/HttpClientHandler.cs">HttpClientHandler.cs</a></p>
</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2022/05/25/book_hands_on_ddd_with_dotnet_ch2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/25/book_hands_on_ddd_with_dotnet_ch2/" class="post-title-link" itemprop="url">[讀書心得][領域驅動設計與 .Net Core] Chapter2: 語言與情境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-25 22:00:00" itemprop="dateCreated datePublished" datetime="2022-05-25T22:00:00+08:00">2022-05-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A0%98%E5%9F%9F%E9%A9%85%E5%8B%95%E8%A8%AD%E8%A8%88%E8%88%87-Net-Core/" itemprop="url" rel="index"><span itemprop="name">領域驅動設計與.Net Core</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2022/05/25/book_hands_on_ddd_with_dotnet_ch2/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/05/25/book_hands_on_ddd_with_dotnet_ch2/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="建立共同語言"><a href="#建立共同語言" class="headerlink" title="建立共同語言"></a>建立共同語言</h2><p>這章主是在講述語言的重要性，而語言又如何直接間接的影響到系統的成敗。這邊的語言並非指程式語言，而是指在相同情境下大家所共同理解的語言，就用 <code>User</code> 這個詞來舉例，在不同情境下就可能代表著不同意義</p>
<ul>
<li>對購物網站而言 : User 可能代表的是逛商城的<em>消費者</em></li>
<li>對商城平台而言 : User 可能代表是<em>進駐的廠商</em></li>
<li>對商城後台而言 : User 可能代表的是<em>進駐廠商的員工</em></li>
</ul>
<p>一個 User 在各個情境下代表著不同意義，想關注的事情也不盡相同，當我們沒有情境為背景下，單單用 User 做為溝通可能會陷入雞同鴨講的狀況，這就是情境之於語言為何重要的地方。</p>
<div class="note info">
            <p>過去開會時發現一個現象，時常開發單位與需求單位在溝通時，彼此對於同一個東西用的詞是完全不同的，當需求單位在描述事情時，較新進或對 Domain 不熟的開發人員可能會弄不清楚對方在說什麼，這時候就需要熟的人在旁邊補充「他指的是系統裡的 xxx」，而會產生這樣的差距，常常是因為開發人員將他們的工作視為”將需求翻譯成程式語言”，所以程式內的語言可能自成一格，並與現實用語脫鉤，而這類的情況一多，當不同背景的人共同溝通時就會需要彼此一直翻譯，翻譯的狀況越多，中間遺失掉的”知識”可能就越多，大家應該都有看過翻譯很爛的書的經驗吧…</p>
          </div>

<p>所以書中建議為不同背景的人找尋共同用語相當重要，這可以減少溝通時因為翻譯而導致的落差，書中舉了一個很真實的案例：當使用者在廣告系統中發佈 (publish) 廣告時，為了避免帶有惡意或不適當的內容，會讓該廣告進入審核的流程 ….，而當這個需求轉化為程式語言後可能會變成</p>
<ul>
<li>當使用者按下 publish 按鈕時，將廣告狀態更新為 Published，並且發出<code>廣告狀態已變更(AdStatusUpdated)</code>的事件</li>
<li>審核系統收到 <code>廣告狀態已變更(AdStatusUpdated)</code> 事件時將廣告撈出來排入審核流程</li>
</ul>
<p>看出這中間有多大的落差了嗎？我們在系統中不用 <code>廣告已被發佈(AdPublished)</code>，取而代之的是<code>廣告狀態已變更（AdStatusUpdated）</code>，發佈的動作轉化成狀態的變更，需求在這大量轉化為系統程式碼的過程中，很有可能原始的意圖早已消失，而這可能正是關鍵知識遺失的過程。</p>
<h2 id="精準需求的迷失"><a href="#精準需求的迷失" class="headerlink" title="精準需求的迷失"></a>精準需求的迷失</h2><p>每當我們交付功能給客戶，面對客戶的不滿意時，常常歸因於<code>需求描述的失準</code>，開發團隊內會互相抱怨、指責，開發者埋怨開需求的人規格亂寫，開需求的人埋怨開發者搞不清楚也不問，導致開發出來的系統與最終想解決的問題有一大段落差，所以團隊可能會開始找更厲害的 PO 或 PM，開始要求規格書的格式，試圖用鉅細彌遺厚厚一本的規格書來彌補與真實之間的落差。</p>
<p>而事實真的是這樣嗎？很多時候開發人員是沒有機會直接面對需求單位或業務人員的，所以當這些需求單位透過與系統分析師描述後，再透過<code>系統分析師的理解</code>轉化成規格書，這中間可能就已經遺失了一部分真實。</p>
<div class="note info">
            <p>很多時候會議內所謂的共識，是你以為你的共識，我以為我的共識，實際上彼此認知的事情根本不是一回事，等雙方都告一段落後回來一對才發現跟當時說的不一樣，但彼此都覺得自己是照當時的決議實作的啊，所以問題可能不是雙方背信，而是彼此認知根本不在同一個點上。</p>
          </div>

<p>書中提到可以嘗試在溝通中，用視覺化的方式彌平彼此認知的落差，而我自己的經驗也發現，大量的文字描述常常聽者很難聚焦，當開始把各個會議中談到的東西視覺化，輔助上依賴關係與線性流程，有助於幫助與會人員更能聚焦在同一個點上。<br><img src="/images/20220525/1.jpg" alt="/images/20220525/1.jpg"><br>圖片來源: 領域驅動設計與 .Net Core 書中 p.26</p>
<h2 id="透過新的術語發現新的情境"><a href="#透過新的術語發現新的情境" class="headerlink" title="透過新的術語發現新的情境"></a>透過新的術語發現新的情境</h2><p>最前面提到在不同情境下，User 可能代表的意義完全不同，當我們在討論過程中可能會脫口而出<code>前台的消費者</code>、<code>平台的廠商</code>、<code>後台的管理者</code>…等等，而當這些用語的不同時，其實也幫助了我們發現了<code>新的情境</code>，針對這些新出現的情境建立對應的模型是需要的，對比於前面只用 <code>使用者(User)</code>來描述，後者更精準也更貼近真實，這也可以避免開發者寫出近乎於上帝類別的 User 來。 </p>
<p>雖然短短一小篇，但發現要把讀完的東西用自己的話再說一次真的還有一段差距啊</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2022/05/23/book_hands_on_ddd_with_dotnet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/23/book_hands_on_ddd_with_dotnet/" class="post-title-link" itemprop="url">[讀書心得][領域驅動設計與 .Net Core] Chapter1: 為什麼需要領域驅動設計</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-23 22:52:00" itemprop="dateCreated datePublished" datetime="2022-05-23T22:52:00+08:00">2022-05-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A0%98%E5%9F%9F%E9%A9%85%E5%8B%95%E8%A8%AD%E8%A8%88%E8%88%87-Net-Core/" itemprop="url" rel="index"><span itemprop="name">領域驅動設計與.Net Core</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2022/05/23/book_hands_on_ddd_with_dotnet/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/05/23/book_hands_on_ddd_with_dotnet/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><img src="/images/20220523/cover.jpg" alt="/images/20220523/cover.jpg"><br>圖片來源: <a target="_blank" rel="noopener" href="https://www.tenlong.com.tw/products/9789864348602">https://www.tenlong.com.tw/products/9789864348602</a></p>
<p>第一章講述了軟體發展史中，為了解決軟體開發上的困境許多方法被發明了出來，而雖然每個方法都宣稱能有效解決（或部分解決）專案上的問題，但經過統計，成功的專案始終不超過 22%。而 DDD 也是為了解決軟體開發時所碰到的困境所被提出來的一種方法。</p>
<p>軟體通常是為了解決某些問題而被研發的，所以當<code>錯誤的理解問題</code>就很容易導致失敗，人類在解決問題上有著豐富的經驗，所以當人類看到問題時，通常會有一些<code>直覺的解決方案</code>浮出腦中（快思慢想也有提到這點），這可能源自於你的經驗或是過往學經歷，而這<code>直覺的好點子</code>很高的可能是錯誤的方向，而人往往又會傾向於找盡各種方法試圖說服自己<code>剛剛的好點子</code>是正確的，即便在實作的過程中隱約察覺到不對勁了…</p>
<div class="note info">
            <p>個人經驗中有察覺到這個現象，常常誤以為自己一開始的想法是正確的，所以即便過程中發現問題也會用各種變形方法試圖將問題套入其中，而這往往會將問題變得更複雜。</p><p>我曾經跟專案成員討論目前框架使用上的困境，而我發現大部分人會傾向在框架中設計各種 Config 、環境變數切換來滿足所謂的特殊情境，而沒有去思考框架設計是否瞄準錯了問題。又或是為了解決部署環境問題，直接聯想到 Container 解決方案，結果為了管理 Container 所以引入更複雜的 k8s 做為編排的工具，也許本質想解決的問題沒這麼複雜，卻在解決的過程中意外的把問題變得更複雜。</p>
          </div>

<h2 id="避免無知"><a href="#避免無知" class="headerlink" title="避免無知"></a>避免無知</h2><p>書本中將無知分類成五個層級</p>
<ul>
<li>缺少無知(lack of ignorance) : 表示你擁有大部分的知識，知道「該做什麼」、「怎麼做」</li>
<li>缺乏知識(lack of knowledge) : 你意識到自己的無知，所以你獲取更多知識來填補知識的落差</li>
<li>缺乏意識(lack of awareness) : 「不知道自己不知道」，連意識到無知都沒有，例如拿到規格就覺得自己知道要解決的問題是什麼了，而忽略了其實自己根本不知道本質問題是什麼狀況，人往往會做出錯誤決策都屬這層</li>
<li>缺乏流程(lack of process) : 你不知道你自己不知道是什麼，也無管道能弄清楚</li>
<li>元無知(meta igonorance) : 連無知的五個層次都不知道 </li>
</ul>
<p>DDD 之父 Eric Evans 對於「提前設計」提出了見解 : 我們在專案的初期會進行提前設計的動作，而此時恰好也是我們擁有「最少知識」並且是最無知的時期。在專案開始時幾乎沒有知識的情況下，就對軟體的設計和架構做出大多數的「重要決策」，這不會是個好的做法。</p>
<div class="note info">
            <p>個人覺得這跟敏捷中提到的小增量多迭代道理是一樣的，我們很難在專案初期就了解問題的全貌，所以小步前進，並且因應碰到的問題即時快速的調整，才能讓我們越來越貼近真實情況的樣貌，也可以降低在專案初期的過度設計，導致架構一直調整的窘境。</p>
          </div>

<p>隨著現代專案要處理的問題越來越複雜（可能是質或是量的複雜度），有效的處理<code>領域知識</code>、<code>減少無知</code>，準確將問題分類，避免實現目標路途中的認知偏誤，DDD 就是想要解決這些問題所被提出的。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2022/05/20/become_a_tech_lead/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/05/20/become_a_tech_lead/" class="post-title-link" itemprop="url">弱雞 Tech Lead 初體驗</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-05-20 23:39:00" itemprop="dateCreated datePublished" datetime="2022-05-20T23:39:00+08:00">2022-05-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B7%A5%E7%A8%8B%E5%B8%AB%E7%9A%84%E9%82%A3%E4%BA%9B%E4%BA%8B/" itemprop="url" rel="index"><span itemprop="name">工程師的那些事</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2022/05/20/become_a_tech_lead/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2022/05/20/become_a_tech_lead/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>近期很後悔自己中斷了寫部落格的習慣，為了重新養成這個習慣，所以有了這開春第一篇文章（都快夏天了老闆～），而既然是開春第一篇，想說就來寫些較軟性的題目好了（絕對不是我技術都沒長進的關係啦…），所以今天就來聊聊近期與團隊共患難的事情好了。</p>
<p>可能老闆知道我今年犯太歲的關係，不能讓我太好過，所以年初就派我去擔任一個 5 人小團隊的 tech lead，一開始本來懷抱著 “大家都很優秀，我應該只要去幫大家打打雜就好”的心態加入，殊不知考驗才剛剛開始。</p>
<p>這個團隊負責的是一個架構與開發框架性質的專案，亦即它的設計未來可能會直接影響 N 個團隊的開發習慣與 N 個服務掛在上面的行為，所以它的難度不低，加上初期時程壓力、人力吃緊的情況下，體質並不是很好，例如：</p>
<ul>
<li>專案幾乎沒有測試，上線常常發生改 A 壞 B 的情況</li>
<li>文件非常多，但跟實際系統運作邏輯有不小的落差</li>
<li>系統在還不穩固的情況下已經釋出 SDK 給團隊使用，加大改版向下相容的挑戰</li>
<li>Release 純手工，過程中需要人工介入調整許多地方，不熟的人看文件還要花半天以上才能搞定</li>
<li>框架本身的目標與使用該框架的服務需求間的拉扯，導致初期就有高度客製化的狀況，增加了後續入住這個框架得複雜度</li>
<li>資料庫版控管理不佳，每次更版幾乎都要倒資料，間接也讓服務開不出 API，因為實時的資料異動會導致資料遺失</li>
</ul>
<p>基於上述原因，團隊士氣其實並不高，因為即便是看似簡單的功能上線都如履薄冰，加上該專案是受到重視的專案（被定位為乘載公司未來性的框架），人員陸續補進來，團隊的壓力也隨之增加，因為人力往往與產值掛鉤，給予對應的人力沒有對應的產值是無法被接受的。</p>
<p>所以初期我花最多時間思考的不是怎麼滿足需求，反而是該如何穩住系統跟增加開發成員的信心，在軟體業也快 10 年了，新需求與改需求是不會有停止的一天，每個跟你談的需求都會很急很趕，不急不趕才是新聞，所以與其追著需求跑，我更在思考的是</p>
<ol>
<li>該如何穩住這個系統 ? 讓開發人員有信心，讓新進人員能在最短時間成為戰力</li>
<li>這個框架到底想解決的本質問題是什麼？ 如果它沒有守住那條線，這個框架基本上也沒有存在的價值</li>
</ol>
<p>所以我跟主管談了一個方案，農曆年前約三週時間需求我一律不收也不處理，一切請他幫我緩到農曆年後再說，對內開始跟團隊成員著手處理以下問題</p>
<ol>
<li>重建系統核心<br>我開始與團隊成員梳理目前系統運作的脈絡，對我來說系統要在不斷變動的環境下發展，不外乎讓你的程式碼能好好說明系統在做什麼，如果連幾個類別物件間的互動關係都說不清楚寫不好，又該如何期待這成千上萬行的程式碼堆疊出來系統會有一套清晰的邏輯在運作。又如何期待新進工程師能在眾多的文件中自己理出系統邏輯，縱然文件全然正確，理解文件後對應到程式碼的運作，這中間還有一段很長的路要走。所以我很喜歡 Uncle Bob 說的『世界上最好的文件應該是你的程式碼。』<br>這個觀念剛好也契合 DDD 中所強調的，把你的專注力先放在解決核心問題上，把問題之外的資料庫、 Schema、 軟體分層、作業系統先切開，先用最簡單的類別與物件來展示你要解決的業務邏輯，當這些都說得通、運作得當，剩下的都是支撐這個核心的基礎建設而已。</li>
</ol>
<ol start="2">
<li>建立單元測試<br>我與團隊成員立下的第一個約定就是 “MR 只要沒有單元測試一律退回”，我認為確保寫出來的程式運作邏輯的正確性是身為工程師的基本素養，Code Review 應該是讓大家討論與互相學習的場域，並試著透過多人 Review 從不同角度尋找盲點，防止重大舞弊、效能、資安…等問題，不要期待 Reviewer 能用肉眼幫你找出所有漏洞，如果寫單元測試都無法保證系統百分之百正確了，更何況不寫。<br>寫單元測試好處真的很多，除了能用最低成本快速驗證你的想法與程式碼之外，它也在保護你的團隊成員，當專案龐大到一個程度，團隊內成員對於 Code 與各個需求掌握度也都會有落差，所以當未來需求變動時，它能幫忙把關是否哪邊因為變動而出錯了。</li>
</ol>
<ol start="3">
<li>重新梳理開發流程與 CI/CD<br>與團隊成員討論了之前的分支策略後利弊後，我們開始改成 trunk-based 的跑法，試著降低大家解衝突的時間，並逼大家思考持續整合回 Master 的相容性問題，同時也開始投入資源建立 CI/CD ，讓一些明確與重複的流程自動化，降低部署的時間與負擔。穩固快速的部署流程不單單只是減少時間的浪費，往往也能增加團隊成員的信心，你會有信心即便真的最後出錯了，我們都有機會在很短的時間內迭代修復或退版，就像打籃球時有個超強中鋒幫你搶籃板一樣，各個投三分都跟 Curry 一樣有信心 (最近都在看 NBA 季後賽啦)。</li>
</ol>
<p>經過一番奮戰後，我們終於在總共花了 4 週多的時間，將原本幾乎開不出 API 的系統，陸續釋出 20多支的 API 上線，並且交付批次工具幫助協作單位整合資料，解決了之前常常需要手動進資料庫塞資料與髒資料橫行的問題，也終於終於得到了團隊成員的第一次肯定（淚）。 </p>
<p>但人生往往不會這麼簡單，你懂的 …</p>
<p>待續 … </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2021/08/15/intro_cqrs/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/15/intro_cqrs/" class="post-title-link" itemprop="url">淺談 CQRS</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-08-15 23:37:00" itemprop="dateCreated datePublished" datetime="2021-08-15T23:37:00+08:00">2021-08-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2021/08/15/intro_cqrs/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/08/15/intro_cqrs/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前專案就使用過 CQRS 做為系統的架構來開發，但一直覺得自己『知其然，而不知其所以然』，剛好最近出了一本<a target="_blank" rel="noopener" href="https://www.tenlong.com.tw/products/9789864347926">CQRS 命令查詢職責分離模式</a> 所以就買回來把他讀完了，趁記憶還很清晰時趕快做一下筆記，以下的內容參雜了許多自己的見解，歡迎大家一起討論</p>
<h1 id="什麼是-CQRS"><a href="#什麼是-CQRS" class="headerlink" title="什麼是 CQRS"></a>什麼是 CQRS</h1><p>CQRS 全名為 Command Query Responsibility Segregation ，意即<strong>命令</strong>與<strong>查詢</strong>分離的設計模式，而</p>
<ul>
<li>Command : 會對系統狀態或資料做出異動的行為</li>
<li>Query : 單純取得資料不會對系統狀態造成異動的行為</li>
</ul>
<p>以傳統 CRUD 類比的話，CUD = Command，R = Query</p>
<h1 id="為什麼需要-CQRS"><a href="#為什麼需要-CQRS" class="headerlink" title="為什麼需要 CQRS"></a>為什麼需要 CQRS</h1><h2 id="降低複雜度"><a href="#降低複雜度" class="headerlink" title="降低複雜度"></a>降低複雜度</h2><p>我自己接觸過的大部分系統，大多都是以維護資料做為出發點來設計的系統，例如專案內一定會有所謂的 Repository Layer ： 一個提供各種 API 並能對資料做 CRUD 的封裝層。<br>系統本來就是一系列對資料維護的過程，這樣做有錯嗎？ 只要商業情境不要太複雜的話，大部分都沒什麼問題，但如果系統規模越做越大，商業情境越來越複雜，如果只是用 CRUD 的思維來設計系統，往往會讓複雜度越疊越高，甚至到不可收拾的地步。<br>舉個例子，你應該看過這樣的 API</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Update</span>(<span class="params">MemberDto member</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> memberEntity = MemberRepository.Get(member.Id);</span><br><span class="line">    <span class="keyword">if</span>(memberEntity == <span class="literal">null</span>) </span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullReferenceException(<span class="string">&quot;Member not found.&quot;</span>); </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(member.Name)) </span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(member.Name));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(DateTime.TryParse(member.Birthday, <span class="keyword">out</span> <span class="keyword">var</span> birthday) == <span class="literal">false</span>)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentException(<span class="keyword">nameof</span>(member.Birthday));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//bla bla bla ....</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">string</span>.IsNullOrEmpty(member.Password)) </span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentNullException(<span class="keyword">nameof</span>(member.Password));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Set Entity ...</span></span><br><span class="line"></span><br><span class="line">    memberEntity.Password = member.Password;</span><br><span class="line"></span><br><span class="line">    MemberRepository.Update(memberEntity);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>這個 API 可能包含了對 Member 資料的各種邏輯驗證，而呼叫這個 API 的你可能只是為了完成密碼變更而已，這份 Code 硬要說沒什麼大問題，但也體現了從 CRUD 角度設計出的 API 可能隨著商業邏輯的日益複雜，複雜度可能會成長到非常可怕的地步，而這也是 CQRS 中想避免的事情。</p>
<h2 id="Command-會這樣做"><a href="#Command-會這樣做" class="headerlink" title="Command 會這樣做"></a>Command 會這樣做</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Handle</span>(<span class="params">ResetPasswordCommand command</span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> member = MemberRepository.Get(command.Id);</span><br><span class="line">    <span class="keyword">if</span>(memberEntity == <span class="literal">null</span>) </span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NullReferenceException(<span class="string">&quot;Member not found.&quot;</span>); </span><br><span class="line"></span><br><span class="line">    <span class="comment">//領域模型知道 ResetPassowrd 的相關驗證與知識</span></span><br><span class="line">    member.ResetPassword(command.Password);</span><br><span class="line"></span><br><span class="line">    MemberRepository.Update(member);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="1-貼近現實世界的用語"><a href="#1-貼近現實世界的用語" class="headerlink" title="1. 貼近現實世界的用語"></a>1. 貼近現實世界的用語</h3><p>PO 會對我們說需要<code>會員註冊</code>的功能，而不會說需要<code>新增會員</code>的功能，而通常<code>更換密碼</code>與<code>忘記密碼</code>會是完全不一樣的流程，用 <code>UpdatePassword</code> 很難精準說明這裡面做了什麼，你可能需要翻程式碼看流程，才能說出這個方法內包含了哪些商業情境，而這正是 Command 想避免的。</p>
<h3 id="2-貼近商業邏輯"><a href="#2-貼近商業邏輯" class="headerlink" title="2. 貼近商業邏輯"></a>2. 貼近商業邏輯</h3><p>一個 Command 只做一件事情，而 Command 所執行的流程跟邏輯應符合真實流程與情境</p>
<h3 id="3-Command-內盡量不要再串其他-Command"><a href="#3-Command-內盡量不要再串其他-Command" class="headerlink" title="3. Command 內盡量不要再串其他 Command"></a>3. Command 內盡量不要再串其他 Command</h3><p>Command 通常會對應觸發系統 Event，當 Command 串 Command 時，後續的連鎖反應容易失控，盡量讓 Command 就是獨立完成一個商業邏輯。</p>
<p>也許看到這邊會覺得這好像有點 DDD 的影子，定義領域模型並封裝領域知識，外部透過 Command 觸發領域模型做事，就我目前的認識，的確 DDD 通常會採用 CQRS 的設計模式來實作，但 CQRS 卻不一定要實作 DDD，不過 DDD 我還是初學者就不獻醜了。</p>
<h2 id="提升效能"><a href="#提升效能" class="headerlink" title="提升效能"></a>提升效能</h2><p>系統都希望提供各種角度的搜尋來滿足分析與功能需求，而這會加重資料庫的運算資源短缺問題，通常下一步就會開始將資料庫做<code>讀寫分離</code>的拆解，但最終逃離不了 Table Schema 需要同一套的束縛，而這個束縛在運算或是資料到達某個量級時就很難再往上提升了。</p>
<p>搜尋、寫入最佳化是個兩難的問題，搜尋要快通常要對 Index 設計下一些功夫，而偏偏 Index 越多寫入越慢，又或是 Table Schema 適度的反正規化對搜尋較為友善，但偏偏這會讓寫入資料維護時變得異常麻煩；反過來看，寫入要快需要盡量只寫入該寫入或該更新的資料，而正規化反而是有利於寫入的情境。當讀寫都對同一個 DB 或是同一張 Table 時這兩邊的平衡往往會讓 RD 抓狂，而 CQRS 正是能解決的問題的很好解決方案。<br><img src="/images/20210815/cqrs.png" alt="/images/20210815/cqrs.png"><br>CQRS 允許 Command 與 Query 可以是 Table 等級的隔離也可以是資料庫的實體隔離，更提供針對 Command 與 Query 各自選用最佳方案的資料庫，例如：Command 選用 RDB 而 Query 選擇 NoSQL 甚至是 Elasticsearch 這種重量級搜尋服務來滿足，兩邊資料則透過 Event Sync 的方式來同步。<br>通常系統寫入與查詢的量也是不成比例的，一般系統大部分都在應付各種查詢，而寫入可能只有讀取不到 10 分之 1 的量，CQRS 是有辦法單獨對 Query DB 做橫向擴充，而這在傳統系統架構上是很難做到的一點。</p>
<h1 id="既然這麼好，我是否該每個系統都這樣設計"><a href="#既然這麼好，我是否該每個系統都這樣設計" class="headerlink" title="既然這麼好，我是否該每個系統都這樣設計"></a>既然這麼好，我是否該每個系統都這樣設計</h1><p>有優點就有缺點，而 CQRS 的缺點是對於開發的難度提升了不止一個檔次，等等！上面不是說為了簡化才選擇 CQRS，這邊又說開發變困難，筆者態度前後不一啦（怒噴兩萬字）</p>
<p>先冷靜聽我說，CQRS 是想讓你的程式碼符合商業情境，並盡量符合 Single responsibility principle，這是 Code Level 的簡化，但架構卻變得更為複雜，第一你得面對兩邊資料庫的選擇問題，就算退一步說，我系統量不大，選擇同一座資料庫切 Table 可以吧，但 Command 與 Query 就是會有同步時間差，資料只能做到<strong>最終一致性</strong>，而你準備好面對這樣的改變了嗎？你應該不會想要採用 CQRS ，但抄寫兩張 Table 卻用同步的作法，這樣用單張 Table 採用 CRUD 的方式還更快一些。</p>
<p>當你的開始對 Command / Query 各自選用最佳的資料庫解決方案時，Event Sync 抄寫資料的實作想好解決方案了嗎？中間是透過 Queue 實作 Pub / Sub 同步嗎？ 資料同步延遲的 SLO 定好了嗎？ Consumer 同步速度跟不上寫入發過來的 Event 時，橫向擴充的機制是否想好了？</p>
<p>當開始要面對最終一致性時，不單單只是系統層面的調整，有時甚至從需求到 RD 觀念都是需要做些改變，現實世界最終一致性例子比比皆是，但在過去的大單體時代強一致性才是顯學，如今系統需要乘載的量體已經不可同日而語，除非有革命性的物理突破，不然我們都要開始習慣這個改變</p>
<div class="note info">
            <p>延伸閱讀<br><a target="_blank" rel="noopener" href="https://www.enterpriseintegrationpatterns.com/ramblings/18_starbucks.html">Starbucks Does Not Use Two-Phase Commit</a></p>
          </div>

<p>講這麼多，那到底怎樣才需要用到 CQRS 實作系統？ 我的建議是如果這個系統<strong>流量</strong>或<strong>資料量</strong>預期成長不大，或需求不太會隨著商業情境一直改變的，例如後台系統，這種真的套個 Template 用 CRUD 簡單搞定就好，引入 CQRS 只會增加複雜度且不會有多大效益的，反之如果這個系統預期未來會持續成長，商業需求也會一直調整，那我會建議可以考慮引入 CQRS，但在前期可以選擇單一資料庫切 Table 的方式就好，等到真的量開始起來時再開始 Migration 都還來得及。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2021/04/29/packet_capture/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/04/29/packet_capture/" class="post-title-link" itemprop="url">擷取封包練習</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-04-29 13:45:00" itemprop="dateCreated datePublished" datetime="2021-04-29T13:45:00+08:00">2021-04-29</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2021/04/29/packet_capture/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2021/04/29/packet_capture/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近接到一個任務，需要協助團隊重現幾個 DB 連線時的錯誤，例如: connection pool 超過上限爆掉、connection timeout 等等，而其中一個錯誤 Pre-Login handshack 最難重現</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">System.Data.SqlClient.SqlException (0x80131904): Connection Timeout Expired.  The timeout period elapsed while attempting to consume the pre-login handshake acknowledgement.  This could be because the </span><br><span class="line">pre-login handshake failed or the server was unable to respond back in time.  The duration spent while attempting to connect to this server was - [Pre-Login] initialization=2846; handshake=6765; </span><br></pre></td></tr></table></figure>
<p>這個錯誤推測是在與 SQL Server 連線時 three-way handshake 沒有收到回應導致的失敗，可能屬於網路不穩掉封包問題導致，但問題怎麼證明?</p>
<h1 id="Wireshark"><a href="#Wireshark" class="headerlink" title="Wireshark"></a>Wireshark</h1><p>首先得先確認與 SQL Server 連線時到底傳了哪些封包出去，可以透過 <a target="_blank" rel="noopener" href="https://www.wireshark.org/">wireshark</a> 側錄封包的功能來達成</p>
<h2 id="1-設定-Capture"><a href="#1-設定-Capture" class="headerlink" title="1. 設定 Capture"></a>1. 設定 Capture</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dst host xxx.xxx.xxx.xxx &amp;&amp; port 1433</span><br></pre></td></tr></table></figure>
<p><img src="/images/20210429/1.png" alt="/images/20210429/1.png"></p>
<h2 id="2-嘗試對-SQL-做一次連線並觀察封包"><a href="#2-嘗試對-SQL-做一次連線並觀察封包" class="headerlink" title="2. 嘗試對 SQL 做一次連線並觀察封包"></a>2. 嘗試對 SQL 做一次連線並觀察封包</h2><p><img src="/images/20210429/2.png" alt="/images/20210429/2.png"><br>可以發現 Pre-login handshake 應該會有三次封包傳輸</p>
<h1 id="Packet-Loss"><a href="#Packet-Loss" class="headerlink" title="Packet Loss"></a>Packet Loss</h1><p>接著得想辦法重現封包丟失的狀況下，是否會引發相同的 Exception，因為不知道怎麼精準的特定封包攔下來 (如果有人會的話也歡迎留言教學一下)，所以這邊透過 <a target="_blank" rel="noopener" href="https://github.com/jagt/clumsy">Clumsy</a> 這個套件來輔助達成</p>
<h2 id="1-指定目的地的封包多少比例被攔截下來"><a href="#1-指定目的地的封包多少比例被攔截下來" class="headerlink" title="1. 指定目的地的封包多少比例被攔截下來"></a>1. 指定目的地的封包多少比例被攔截下來</h2><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">outbound and ip.DstAddr = xxx.xxx.xxx.xxx</span><br></pre></td></tr></table></figure>
<p><img src="/images/20210429/3.png" alt="/images/20210429/3.png"></p>
<h2 id="2-增加連線-handshake-的機率"><a href="#2-增加連線-handshake-的機率" class="headerlink" title="2. 增加連線 handshake 的機率"></a>2. 增加連線 handshake 的機率</h2><p>因為無法精準攔截封包，所以採取短時間快速重複連線來增加封包被攔截的碰撞機率，所以我將 Connection Pool 關閉，並且開多執行序只做最簡單的連線與關閉連線，果然很快就碰到 handshake 的封包被攔掉的狀況</p>
<p><img src="/images/20210429/4.png" alt="/images/20210429/4.png"></p>
<p>而最後也證實了只要連線時網路不穩定導致掉封包等狀況時，底層是會引發上述錯誤的狀況</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2020/12/01/dotnet_core_3_container_ms_sql_2016/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/01/dotnet_core_3_container_ms_sql_2016/" class="post-title-link" itemprop="url">dotnet core 3 container 無法連線 MSSQL 2016</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-01 22:22:00" itemprop="dateCreated datePublished" datetime="2020-12-01T22:22:00+08:00">2020-12-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/12/01/dotnet_core_3_container_ms_sql_2016/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/12/01/dotnet_core_3_container_ms_sql_2016/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="情境"><a href="#情境" class="headerlink" title="情境"></a>情境</h1><p>最近踩到 dotnet core 3 contaienr  + ms sql 2016 的問題，問題的現象是，程式只要跑到建 sql connection 那行就會 hang 在那邊，沒有 timeout 也沒有 Exception … 追查之下後發現，原來 MS SQL 2016 如果沒有調整更新，預設 TLS 好像只支援 1.0、1.1 (待確認)，而我用的 base image : <code>mcr.microsoft.com/dotnet/core/runtime:3.1</code> 的 TLS 設定要求最低版本是 1.2，這也就引發了上述的狀況</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> cat /etc/ssl/openssl.cnf</span> </span><br><span class="line">[system_default_sect]</span><br><span class="line">MinProtocol = TLSv1.2</span><br><span class="line">CipherString = DEFAULT@SECLEVEL=2</span><br></pre></td></tr></table></figure>



<h1 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h1><p>一般來說，基於安全性會建議至少停用 TLS 1.0 並支援 1.2 才是比較好的做法，但如果你跟我一樣只是在測試，那可以採用以下比較 workaround 的做法，在 dockerfile 加上以下幾行來調整 container tls 最低支援版本</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">RUN</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&#x27;s/DEFAULT@SECLEVEL=2/DEFAULT@SECLEVEL=1/g&#x27;</span> <span class="string">/etc/ssl/openssl.cnf</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&#x27;s/MinProtocol = TLSv1.2/MinProtocol = TLSv1/g&#x27;</span> <span class="string">/etc/ssl/openssl.cnf</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&#x27;s/DEFAULT@SECLEVEL=2/DEFAULT@SECLEVEL=1/g&#x27;</span> <span class="string">/usr/lib/ssl/openssl.cnf</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&#x27;s/MinProtocol = TLSv1.2/MinProtocol = TLSv1/g&#x27;</span> <span class="string">/usr/lib/ssl/openssl.cnf</span></span><br></pre></td></tr></table></figure>

<p>這樣重新啟動也就會正常了</p>
 <div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://github.com/dotnet/SqlClient/issues/222">.NET Core 3.0 Docker Container Won’t Connect to SQL Server</a></p>
          </div>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2020/09/19/about_async/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/09/19/about_async/" class="post-title-link" itemprop="url">【C#】 關於 Async 的三兩事</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-09-19 17:07:00" itemprop="dateCreated datePublished" datetime="2020-09-19T17:07:00+08:00">2020-09-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/09/19/about_async/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/09/19/about_async/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>說來真的好久沒有寫文章了，除了工作很忙之外，目前碰到的問題也通常不是一兩篇文章可以交代的清，所以也就更新部落格的時間也就間隔越來越長了。</p>
<p>這次主要是想把最近針對 Async 的一些測試研究記錄下來，那我們就開始吧 ！</p>
<h1 id="Async-是什麼？"><a href="#Async-是什麼？" class="headerlink" title="# Async 是什麼？"></a># Async 是什麼？</h1><p>Async 在 C# 語言中用來支援非同步處理的一種語法，而它的使用往往搭配 Await 一起使用，先來看看一段簡單的程式碼</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;1. Hi I&#x27;m Async Demo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//拿到非同步的任務</span></span><br><span class="line">    <span class="keyword">var</span> task = DoAsync();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//繼續執行</span></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;2. Hello World!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//等待非同步任務執行完成</span></span><br><span class="line">    <span class="keyword">await</span> task;</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;4. End!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">DoAsync</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="comment">//碰到 await 時，會將控制項回傳給呼叫端，並且等待非同步的方法執行完成</span></span><br><span class="line">    <span class="keyword">await</span> Task.Run(()=&gt; </span><br><span class="line">                   &#123;</span><br><span class="line">                     Thread.Sleep(TimeSpan.FromSeconds(<span class="number">5</span>));</span><br><span class="line">                     Console.WriteLine(<span class="string">$&quot;3. Async method Done&quot;</span>);</span><br><span class="line">                   &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>這段程式碼執行後可以看到以下結果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. Hi I&#39;m Async Demo</span><br><span class="line">2. Hello World!</span><br><span class="line">3. Async method Done</span><br><span class="line">4. End!</span><br></pre></td></tr></table></figure>



<h2 id="觀察執行緒的切換"><a href="#觀察執行緒的切換" class="headerlink" title="觀察執行緒的切換"></a>觀察執行緒的切換</h2><p>接著加上執行緒 Id 看看，讓我們更清楚執行緒之間是如何切換的</p>
<p><img src="/images/20200919/1.png" alt="/images/20200919/1.png"></p>
<p>執行結果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[1] 1. Hi I&#39;m Async Demo</span><br><span class="line">[1] 2. Hello World!</span><br><span class="line">[4] 3. Async method Done</span><br><span class="line">[4] 4. End!</span><br></pre></td></tr></table></figure>



<p><strong>執行流程</strong></p>
<ul>
<li><p><strong>執行緒_1</strong> 在 11 行印出了 <code>[1] 1. Hi I&#39;m Async Demo</code></p>
</li>
<li><p><strong>執行緒_1</strong> 在 14 行進入了 DoAsync 的方法中</p>
</li>
<li><p><strong>執行緒_1</strong> 在 27 行碰到 Task.Run 開啟了非同步執行的方法，並因為 await 跳出了這個 DoAsync() </p>
</li>
<li><p><strong>執行緒_1</strong> 在 16 行碰到印出了 <code>[1] 2. Hello World!</code></p>
</li>
<li><p><strong>執行緒_1</strong> 在 19 行碰到 await task ，開始等待 task 執行完成，<strong>執行緒_1</strong> 釋放回到 Thread Pool</p>
</li>
<li><p><strong>執行緒_4</strong> 在非同步方法的第 30 行 印出了 <code>[4] 3. Async method Done</code> ，並通知 await task 執行完成</p>
</li>
<li><p>TaskScheduler（通常，這會是以執行緒集區為目標的預設工作排程器）依據最有效率的判斷，讓 <strong>執行緒_4</strong> 往下執行未完的部分</p>
</li>
<li><p><strong>執行緒_4</strong> 接手繼續將 await 之後還沒做完的工作執行完成，意即 21 行，印出 <code>[4] 4. End!</code></p>
</li>
</ul>
<h2 id="稍微修改一下程式…"><a href="#稍微修改一下程式…" class="headerlink" title="稍微修改一下程式…"></a>稍微修改一下程式…</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;[<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>] 1. Hi I&#x27;m Async Demo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//強制將非同步方法改成同步</span></span><br><span class="line">    DoAsync().Wait();</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;[<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>] 2. Hello World!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Console.WriteLine(<span class="string">$&quot;[<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>] 4. End!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">async</span> Task <span class="title">DoAsync</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>  &#123;</span><br><span class="line">    <span class="comment">//碰到 await 時，會將控制項回傳給呼叫端，並且等待非同步的方法執行完成</span></span><br><span class="line">    <span class="keyword">await</span> Task.Run(()=&gt; </span><br><span class="line">                   &#123;</span><br><span class="line">                     Thread.Sleep(TimeSpan.FromSeconds(<span class="number">5</span>));</span><br><span class="line">                     Console.WriteLine(<span class="string">$&quot;[<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>] 3. Async method Done&quot;</span>);</span><br><span class="line">                   &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>執行結果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[1] 1. Hi I&#39;m Async Demo</span><br><span class="line">[4] 3. Async method Done</span><br><span class="line">[1] 2. Hello World!</span><br><span class="line">[1] 4. End!</span><br></pre></td></tr></table></figure>

<p>這邊可以看到 <strong>執行緒_1</strong> 在執行到 await Task.Run(()=&gt; …) 時跳出，但因為我們下了 Wait()，所以強迫 <strong>執行緒_1</strong> 進行同步的等待。</p>
<p><strong>執行緒_4</strong> 印完 <code>[4] 3. Async method Done</code> 後，通知 <strong>執行緒_1</strong> 繼續往下進行，所以看到 <strong>執行緒_1</strong>  接著將剩下的程式跑完</p>
<h2 id="差別在哪？"><a href="#差別在哪？" class="headerlink" title="差別在哪？"></a>差別在哪？</h2><p>當呼叫非同步執行方法時，如果一路都是用 await 並不會造成任何執行緒被封鎖，換言之該執行緒還可以在別的地方繼續服務，一旦呼叫了 <strong>Result</strong> 或 <strong>Wait()</strong> 這類的強制同步方法，則該執行緒會被封鎖，並等待到非同步方法執行完成後才繼續完成尚未完成的後續工作，這會嚴重消耗執行緒的使用效率。</p>
<p>我曾經對一個 Web API 專案進行壓測，在資源給得非常有限的情境下 (約 0.5 core cpu)，<code>await 搭配 Task.Run()</code> 跟 <code>Result 搭配 Task.Run</code> ，兩個 RPS 測起來差了快一倍之多，在資源極度有限下，執行緒的使用效率將大大影響整體服務的效率。</p>
<h1 id="SynchronizationContext"><a href="#SynchronizationContext" class="headerlink" title="# SynchronizationContext"></a># SynchronizationContext</h1><p>SynchronizationContext 是用來記錄當前執行緒環境的類別，在 ASP.NET、WPF、WinForm 都有類似的類別只是名字可能有些差異，其最主要的目的都是在非同步方法中要能調用 UI 執行緒來更新介面之類的操作，而 SynchronizationContext 就紀錄著 UI 執行緒。</p>
<h2 id="Deadlock"><a href="#Deadlock" class="headerlink" title="Deadlock"></a>Deadlock</h2><p>過去寫 ASP.NET 的時候曾經踩過一次  SynchronizationContext 的雷，在 ASP.NET 中如果如果呼叫 <code>SynchronizationContext.Currnt</code> 會發現並不為 Null，且型別是 <code>AspNetSynchronizationContext</code> ，當我們用上述的 <code>Result / Wait() 搭配 await</code> 將會導致 Deadlock。</p>
<p>原因是程式碰到 await 時會先判斷 SynchronizationContext.Currnt 是否為 Null，如果是則會在 Task 結束時呼叫 TaskScheduler （通常為 Thread Pool）來安排後續工作。反之，如果 SynchronizationContext.Currnt 不為 Null 時，就會透過 SynchronizationContext.Currnt 來繼續後續的動作。</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//碰到 await 時，記住了 SynchronizationContext.Currnt</span></span><br><span class="line"><span class="keyword">await</span> Task.Run(()=&gt; </span><br><span class="line">               &#123;</span><br><span class="line">                 Thread.Sleep(TimeSpan.FromSeconds(<span class="number">5</span>));</span><br><span class="line">                 Console.WriteLine(<span class="string">$&quot;[<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>] 3. Async method Done&quot;</span>);</span><br><span class="line">               &#125;);</span><br></pre></td></tr></table></figure>

<p>而 .Result / Wait() 的方法會封鎖住 SynchronizationContext.Currnt，造成兩邊互等的情況發生，產生了 Deadlock</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DoAsync().Wait(); <span class="comment">//封鎖 SynchronizationContext.Currnt 的物件等待 Task 完成</span></span><br></pre></td></tr></table></figure>

<p>而這只會發生在 SynchronizationContext.Currnt 不為 Null 的系統中，像是前述提到的 ASP.NET、WPF、WinForm，在 Console Application 並不會發生。</p>
<h2 id="解決方法-ConfigureAwait-false"><a href="#解決方法-ConfigureAwait-false" class="headerlink" title="解決方法 ConfigureAwait(false)"></a>解決方法 ConfigureAwait(false)</h2><p>如果要避免上述所提到的 Deadlock ，可以在呼叫非同步方法時加上 ConfigureAwait(false)，這樣非同工作完成時就會透過另一條執行緒繼續完成後續工作</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> Task.Run(()=&gt; </span><br><span class="line">          &#123;</span><br><span class="line">              ....</span><br><span class="line">          &#125;).ConfigureAwait(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>



<h2 id="在-ASP-Net-Core-的時代…"><a href="#在-ASP-Net-Core-的時代…" class="headerlink" title="在 ASP.Net Core 的時代…"></a>在 ASP.Net Core 的時代…</h2><p>在 ASP.Net core 呼叫 SynchronizationContext.Current 現在只會得到 Null ，換言之剛剛發生 deadlock 的情境已經不會發生，所以過往在非同步的地方常常要用 ConfigureAwait(false) 可以不用寫了，不過如果你是寫元件或 SDK 類的，並無法預測會被使用在怎樣的環境的話，建議還是都加上會比較保險。</p>
<h1 id="Best-Practice"><a href="#Best-Practice" class="headerlink" title="# Best Practice"></a># Best Practice</h1><p>在使用 Async / await 等非同步技巧時，最好的方式還是都盡量使用非阻斷式的寫法 await ，避免使用 Result / Wait() ，即使你已經是寫 ASP.Net core 不會發生 Deadlock 的情況，阻斷式的寫法對於執行緒的使用效率來說還是會有影響的。</p>
<div class="note info">
            <p>參考文章</p><p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-tw/dotnet/standard/asynchronous-programming-patterns/consuming-the-task-based-asynchronous-pattern">使用以工作為基礎的非同步模式</a></p><p><a target="_blank" rel="noopener" href="https://blog.stephencleary.com/2017/03/aspnetcore-synchronization-context.html">ASP.NET Core SynchronizationContext</a></p><p><a target="_blank" rel="noopener" href="https://devblogs.microsoft.com/dotnet/configureawait-faq/">ConfigureAwait FAQ</a></p><p><a target="_blank" rel="noopener" href="https://www.huanlintalk.com/2016/01/asyc-deadlock-in-aspbet.html">.NET 程式鎖死與 SynchronizationContext</a></p><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/lzxianren/p/SynchronizationContext.html">搞懂 SynchronizationContext（第一部分)</a></p>
          </div>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://toyo0103.github.io/2020/06/06/rabbitmq_container_initial_queue/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Toyo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="程式隨筆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/06/06/rabbitmq_container_initial_queue/" class="post-title-link" itemprop="url">initialize RabbitMQ container's Queue and Exchange</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-06-06 23:48:00" itemprop="dateCreated datePublished" datetime="2020-06-06T23:48:00+08:00">2020-06-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2022-08-09 21:36:17" itemprop="dateModified" datetime="2022-08-09T21:36:17+08:00">2022-08-09</time>
              </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/2020/06/06/rabbitmq_container_initial_queue/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/06/06/rabbitmq_container_initial_queue/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>為了測試方便常常會在本機起 RabbitMQ Container，但隨著系統的演進初始化 RabbitMQ 變得越來越複雜，例如：每次都要先設定 8 組 Queue，Exchange binding …等等</p>
<p>工程師的美德就是懶，所以開始找辦法是不是可以讓 RabbitMQ Container 起來時就自己設定好呢？</p>
<h2 id="解法"><a href="#解法" class="headerlink" title="解法"></a>解法</h2><p>RabbitMQ 有提供設定檔來初始化，分別為放在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;rabbitmq&#x2F;rabbitmq.config</span><br><span class="line">&#x2F;etc&#x2F;rabbitmq&#x2F;definitions.json </span><br></pre></td></tr></table></figure>

<p>而這兩個檔案裡面可以設定 VirtualHost、Authorization、Exchange、Queue</p>
<p><strong>rabbitmq.config</strong><br>這邊特別提醒一下，內容最後面那個小點不是打錯喔，是規定就是要有的!</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    rabbit,</span><br><span class="line">    [</span><br><span class="line">      &#123; loopback_users, [] &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    rabbitmq_management,</span><br><span class="line">    [</span><br><span class="line">      &#123; load_definitions, &quot;&#x2F;etc&#x2F;rabbitmq&#x2F;definitions.json&quot; &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">].</span><br></pre></td></tr></table></figure>



<p><strong>definitions.json</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;rabbit_version&quot;: &quot;3.8&quot;,</span><br><span class="line">  &quot;users&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;guest&quot;,</span><br><span class="line">      &quot;password&quot;: &quot;guest&quot;,</span><br><span class="line">      &quot;tags&quot;: &quot;administrator&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;vhosts&quot;: [</span><br><span class="line">    &#123; &quot;name&quot;: &quot;&#x2F;&quot; &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;permissions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;user&quot;: &quot;guest&quot;,</span><br><span class="line">      &quot;vhost&quot;: &quot;&#x2F;&quot;,</span><br><span class="line">      &quot;configure&quot;: &quot;.*&quot;,</span><br><span class="line">      &quot;write&quot;: &quot;.*&quot;,</span><br><span class="line">      &quot;read&quot;: &quot;.*&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;parameters&quot;: [],</span><br><span class="line">  &quot;policies&quot;: [],</span><br><span class="line">  &quot;exchanges&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;nmq&quot;,</span><br><span class="line">      &quot;vhost&quot;: &quot;&#x2F;&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;direct&quot;,</span><br><span class="line">      &quot;durable&quot;: true,</span><br><span class="line">      &quot;auto_delete&quot;: false,</span><br><span class="line">      &quot;internal&quot;: false,</span><br><span class="line">      &quot;arguments&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;queues&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;name&quot;: &quot;command&quot;,</span><br><span class="line">      &quot;vhost&quot;: &quot;&#x2F;&quot;,</span><br><span class="line">      &quot;durable&quot;: true,</span><br><span class="line">      &quot;auto_delete&quot;: false,</span><br><span class="line">      &quot;arguments&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;bindings&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;source&quot;: &quot;nmq&quot;,</span><br><span class="line">      &quot;vhost&quot;: &quot;&#x2F;&quot;,</span><br><span class="line">      &quot;destination&quot;: &quot;command&quot;,</span><br><span class="line">      &quot;destination_type&quot;: &quot;queue&quot;,</span><br><span class="line">      &quot;routing_key&quot;: &quot;command&quot;,</span><br><span class="line">      &quot;arguments&quot;: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="方案一"><a href="#方案一" class="headerlink" title="方案一"></a>方案一</h2><p>在啟動 rabbitmq container 的時候將這兩個檔案透過 volume 的方式丟進去，這樣就可以達成目的了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> docker run -it \</span></span><br><span class="line"><span class="bash">	-v /etc/so/rabbitmq.config:/etc/rabbitmq/rabbitmq.config:ro \ </span></span><br><span class="line">	-v /etc/so/definitions.json:/etc/rabbitmq/definitions.json:ro rabbitmq:3.8-management</span><br></pre></td></tr></table></figure>



<h2 id="方案二"><a href="#方案二" class="headerlink" title="方案二"></a>方案二</h2><p>如過你不幸 (?) 的跟我一樣是使用 windows container，volume 這個選擇不屬於你，因為 windows container 只能將整個資料夾 volume 進去，並不能指定單一檔案，所以如果將整個資料夾放進去，需要額外將一些本該在 <code>/etc/rabbitmq</code> 底下的檔案也都 copy 出來，才不會跑起來的時候少東少西的，但這個方法總覺得有點麻煩，所以我採用自己 build image 的方案</p>
<p><strong>dockerfile</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">FROM</span> <span class="string">rabbitmq:3.8-management</span></span><br><span class="line"></span><br><span class="line"><span class="string">ADD</span> <span class="string">rabbitmq.config</span> <span class="string">/etc/rabbitmq/</span></span><br><span class="line"><span class="string">ADD</span> <span class="string">definitions.json</span> <span class="string">/etc/rabbitmq/</span></span><br></pre></td></tr></table></figure>

<p>透過 build image 的過程中將檔案放進去，之後起起來也都不用在下 volume 指令，也算是簡單不少</p>
<div class="note info">
            <p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/30747469/how-to-add-initial-users-when-starting-a-rabbitmq-docker-container"><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/30747469/how-to-add-initial-users-when-starting-a-rabbitmq-docker-container">How to add initial users when starting a RabbitMQ Docker container?</a></a></p><p><a target="_blank" rel="noopener" href="https://devops.datenkollektiv.de/creating-a-custom-rabbitmq-container-with-preconfigured-queues.html">Creating a custom RabbitMQ container with preconfigured queues</a></p>
          </div>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Toyo</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">203</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">75</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Toyo</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://toyo0103.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>

</body>
</html>
